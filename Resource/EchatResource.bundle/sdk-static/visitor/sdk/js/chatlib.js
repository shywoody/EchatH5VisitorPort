function InputHandle(){var e=this;this.filterPasteData=function(e,t,i){var a=i?"\r\n":"<br/>";if(e&&t)return e.replace(/(^[\s\r\n]+)|[\r]|([\s\r\n]+$)/g,"").replace(/[\r\n]+([\r\n\s]+)*/g,a);return e&&e.replace(/<(br|hr)\/?>/gi,"\n").replace(/<\/(br|p|div|table|section|footer|article|li|ul|ol)>/gi,"\n").replace(/(<[a-z]+(\s+[^>]*)?>)|(<\/?[a-z]+\/?>)/gi,"").replace(/([\r\n]+)|([\r\n]+[\s]+[\r\n]*)|([\r\n]*[\s]+[\r\n]+)/g,"\n").replace(/[\n]+/g,a)},this.getInput=function(t){if(e.plainText){var i=$("#textInput").val();if(i){if(t){$("#textInput").val("");_$("textInput")}return e.filterPasteData(i,!0,!0)}return i}e.getInputDoc();var a,n=e.getInputDocBody();null!=n.lastElementChild&&"SL_balloon_obj"==n.lastChild.id&&n.removeChild(n.lastChild);var s=a=n.innerHTML;if(s.length>500&&(s=a.replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[#$1#]")),t?(n.innerHTML="",$("#inputPlaceholder").removeClass("hide")):a.length,a.length>500)o=s;else{var o=s.replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[#$1#]");o=e.filterPasteData(o,!1,!0)}return o.length>5e3&&(o=o.substring(0,5e3)),o},this.setInput=function(t){if(!t)return this.getInput(!0);if(t=t.replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[#$1#]").replace(/<(?!br|\/br)(?:.|\s)*?>/gi,"").replace(/&nbsp;/gi," ").replace(/^((<\/?br\/?>)|[\r\n\s]+)+|((<\/?br\/?>)|[\r\n\s]+)+$/gi,""),e.plainText)$("#textInput").val(t);else{e.getInputDoc();e.getInputDocBody().innerHTML=t}},this.inputScrollToView=function(e){function t(){a>15||setTimeout(function(){var e=window.innerHeight+(i.isIOS?80:20);window.scrollTo(0,e),a++,t()},100)}var i=this,a=1;$(e).on("focus",function(e){window.top==window?(t(),a=1):i.postMessage("inputScroll")}),$(e).on("blur",function(e){a=1,setTimeout(function(){i.postMessage("inputScrollStop")},550)})},this.changeToIframe=function(e,t){function i(e){$("#inputPlaceholder").addClass("hide");var t=o.getInputDoc(),i=null;return t.selection?i=t.selection.createRange():o.win.getSelection&&o.win.getSelection().rangeCount&&(i=o.win.getSelection().getRangeAt(0)),i&&(o.win.pos=i)}function a(){i(),view.hideMenus(0)}function n(){i(),o.getInput(!1)||$("#inputPlaceholder").removeClass("hide")}function s(e,t,i){e.addEventListener?e.addEventListener(t,i):e.attachEvent("on"+t,i)}if(this.plainText){this.plainText=!1,this.editorType=2;var o=this;$("#textInput").hide();var r=_$("html_input");if(r.style.display="block",!this.hasInitIframeInput){this.hasInitIframeInput=!0;var l=o.getInputDoc();try{l.designMode="on"}catch(e){console.log(e)}l.contentEditable=!0;try{window.isIE6?l.write('<html><head><meta http-equiv="Content-type" content="text/html;charset=utf-8"><style type=\'text/css\'>html,body{width:100%;height:100%;max-height: 100%;overflow: auto;margin:0;padding:0;background-color:transparent;font-family: "Microsoft YaHei", "Helvetica Neue", Helvetica,"微软雅黑", Arial, sans-serif, STHeiti, FangSong;}</style></head><body contenteditable="true"></body></html>'):(l.open(),l.write('<html><head><meta http-equiv="Content-type" content="text/html;charset=utf-8"><style type=\'text/css\'>html,body{width:100%;height:100%;max-height: 100%;overflow: auto;margin:0;padding:0;background-color:transparent;font-family: "Microsoft YaHei", "Helvetica Neue", Helvetica,"微软雅黑", Arial, sans-serif, STHeiti, FangSong;}'+(1==view.windowType?"":" .img-emo{width:20px;height:20px;")+'}</style></head><body contenteditable="true"></body></html>'),l.close())}catch(e){}var d=l.getElementsByTagName("body")[0];d.style.cssText="margin:0;padding:0;word-break:break-all;white-space: pre-wrap;word-wrap: break-word;width:100%;line-height:1.2;overflow:auto;",o.win=r.contentWindow||document.frames.html_input,o.getPos=i,s(o.win,"focus",a),s(o.win,"blur",n),s(d,"focus",a),s(d,"blur",n),s(d,"select",i),s(d,"click",function(e){i(),view.hideMenus()}),s(d,"keydown",function(e){$("#inputPlaceholder").addClass("hide");var t=e||o.win.event;return view.enter(t)}),s(d,"drop",function(e){setTimeout(function(){o.getInput(!1)&&$("#inputPlaceholder").addClass("hide")},100),o.Browser.browser}),s(l,"paste",function(e){setTimeout(function(){o.getInput(!1)?$("#inputPlaceholder").addClass("hide"):$("#inputPlaceholder").removeClass("hide")},100)}),o.isMobile&&o.inputScrollToView(d),view.initHtmlEdit&&view.initHtmlEdit(o.win,l),o.isMobile||o.addPaste(o.win,l),setTimeout(function(){o.getInput(!1)?$("#inputPlaceholder").addClass("hide"):$("#inputPlaceholder").removeClass("hide")},100)}}},this.preRange=null,this.changeToPreInput=function(){function e(e){var a,n=i.results[0];if(window.getSelection){var s=window.getSelection();try{a=s.getRangeAt(0)}catch(e){(a=document.createRange()).selectNodeContents(n),a.collapse(!1),a.select()}}else a=document.selection.createRange();return t.preRange=a,a}if(this.plainText){this.editorType=3,this.plainText=!1;var t=this;$("#textInput").hide();var i=$("#html_pre_input"),a=i.results[0];i.css("display","block"),t.isMobile&&t.inputScrollToView(t.getInputDocBody());var n;a.onkeyup=function(){clearTimeout(n),n=setTimeout(function(){e()},300)},a.onkeydown=function(e){$("#inputPlaceholder").addClass("hide");e||window.event;return view.enter(e)},a.ontouchend=function(t){setTimeout(function(){e()},50)},a.ontouchstart=function(e){$("#inputPlaceholder").addClass("hide")},a.onfocus=function(){$("#inputPlaceholder").addClass("hide"),e(),view.hideMenus(0)},a.onblur=function(){t.getInput(!1)||$("#inputPlaceholder").removeClass("hide")},a.onclick=function(){e(),view.hideMenus(0),a.focus()},t.getPos=e}},this.bindPlainTextEvent=function(){function e(e){var t,a=_$("textInput");if(window.getSelection){var n=window.getSelection();try{t=n.getRangeAt(0)}catch(e){(t=document.createRange()).selectNodeContents(a),t.collapse(!0)}}else t=document.selection.createRange();return i.textRange=t,t}this.plainText=!0,this.editorType=1,$("#textInput").show();var t=_$("html_input");$(t).hide();var i=this;$("#inputPlaceholder").addClass("hide"),i.isMobile,this.hasBindPlainTextEvent||(this.hasBindPlainTextEvent=!0,view.bindPlainTextEvent(),$("#textInput").off("keydown").on("keydown",function(t){t=t||window.event;if(i.handleInputLength&&setTimeout(i.handleInputLength,50),!1!==view.enter(t)){if(8==(t.keyCode||t.which||t.charCode||0)){var a=_$("textInput"),n=a.value;if(a.createTextRange)console.log("手机端IE?");else{var s=a.selectionStart,o=-1,r=0;s>0&&n.replace(/\[#([^#]+)#\]/g,function(e,t,i,a){return i<s&&i+e.length>=s&&(o=i,r=i+e.length),e}),-1!=o&&a.setSelectionRange(o,r)}}e()}}).on("change input",function(){i.handleInputLength&&i.handleInputLength(),e()}).on("paste",function(e){return i.filterPasteText(e,void 0,window,document)}).on("drop",function(e){i.handleInputLength&&setTimeout(function(){i.handleInputLength()})}).on("focus",e),setTimeout(function(){_$("textInput")&&_$("textInput").scrollIntoView()},400),i.textRange=null,i.getPos=e)},this.filterPasteText=function(t,i,a,n){var s=n.getElementById("textInput");if(void 0===i&&(i=a.clipboardData&&clipboardData.setData?a.clipboardData.getData("text"):(t.originalEvent||t).clipboardData.getData("text/plain")||prompt("在这里输入文本")),i){if(i=e.filterPasteData(i,void 0,!0),t.returnValue=!1,t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation(),i&&e.plainText)if(n.selection){var o=n.selection.createRange();o.text=i}else if("number"==typeof s.selectionStart&&"number"==typeof s.selectionEnd){var r=s.selectionStart,l=s.selectionEnd,d=r,c=s.value;s.value=c.substring(0,r)+i+c.substring(l,c.length),d+=i.length,s.selectionStart=s.selectionEnd=d}else s.value+=i;else if(i&&n.body.createTextRange){if(n.selection)textRange=n.selection.createRange();else if(a.getSelection){var u=(o=a.getSelection()).getRangeAt(0),f=n.createElement("span");f.innerHTML="&#FEFF;",u.deleteContents(),u.insertNode(f),textRange=n.body.createTextRange(),textRange.moveToElementText(f),f.parentNode.removeChild(f)}textRange.text=i,textRange.collapse(!1),textRange.select()}else i&&n.execCommand("insertText",!1,i);return!1}return!0},this.getInputDoc=function(){var e;return 2==this.editorType?(e=_$("html_input").contentDocument)||(e=document.frames.html_input.document):e=document,e},this.getInputDocBody=function(){var e,t,i=this.editorType;return 3==i?(t=_$("html_pre_input")).blur||(t.blur=function(){window.focus()}):2==i?((e=_$("html_input").contentDocument)||(e=document.frames.html_input.document),t=e.body||e.getElementsByTagName("body")[0]):t=_$("textInput"),t},this.focusInput=function(e){var t,i,a,n=this.editorType;return 3==n?t=_$("html_pre_input"):2==n?(t=_$("html_input").contentWindow||document.frames.html_input,(i=_$("html_input").contentDocument)||(i=document.frames.html_input.document),a=i.body||i.getElementsByTagName("body")[0],!e&&a.focus()):t=_$("textInput"),!e&&t.focus(),!e&&a&&a.focus(),t},this.insertImg=function(e){var t=this;if(t.plainText)return view.insertImg?view.insertImg(_$("textInput"),"[#"+t.emoLan[e]+"#]"):(_$("textInput").value+="[#"+t.emoLan[e]+"#]",_$("textInput").scrollTop=_$("textInput").scrollHeight),void(view.textInputChange&&view.textInputChange());var i="/res/emoji/24/"+e+".png",a=this.getInputDoc(),n=this.getInputDocBody(),s=t.win,o=this.editorType,r=s?s.pos:null;if(3==o&&(s=window,r=t.preRange),a.selection&&!/opera/gi.test(view.chat.Browser.browser)){d='<img class="img-emo" src="'+i+'" border="0" code="'+e+'" unselectable="on"/>';if(r)s.focus(),setTimeout(function(){(r=s.pos||r).move("textedit"),r.pasteHTML(d),r.collapse(!0),r.select(),t.focusInput()},100);else{(d=a.createElement("img")).className="img-emo",d.src=i,d.border="0",d.setAttribute("code",e),d.setAttribute("unselectable","on"),a.getElementsByTagName("body")[0].appendChild(d),n.appendChild(d)}}else if(window.getSelection){var l,d;(d=a.createElement("img")).className="img-emo",d.src=i,d.border="0",d.setAttribute("code",e),d.setAttribute("unselectable","on"),r?((l=s.getSelection()).removeAllRanges(),r.deleteContents(),r.insertNode(d),r.setStartAfter(d),r.setEndAfter(d),this.isMobile||(l.removeAllRanges(),l.addRange(r))):n.appendChild(d),setTimeout(function(){n.scrollTop=d.offsetTop,t.focusInput()},100)}$("#inputPlaceholder").addClass("hide")},this.addPaste=function(e,t){function i(){setTimeout(function(){for(var e=r.getInputDocBody().getElementsByTagName("img"),t=0;t<e.length;t++)e[t].getAttribute("code")||(e[t].parentNode?e[t].parentNode.removeChild(e[t]):e[t].removeNode&&e[t].removeNode(!0))},2)}function a(e){if(i(),!0===r.companyOff||r.busyCanSend&&"0"!=r.queryParams.autoChat||!0===r.chatting)if(e.clipboardData&&e.clipboardData.items){var t=e.clipboardData.items;if(t)for(var a=t.length-1;a>-1;a--)if(-1!==t[a].type.indexOf("image")){var o=t[a].getAsFile(),l=(new Date).getTime()+"."+t[a].type.split("/")[1];!function(e,t){if(t&&e&&e.type.indexOf("image/")>-1){var i=new FileReader;i.onload=function(i){t({file:e,base64:i.target.result})},i.readAsDataURL(e)}else t&&t(null)}(o,function(e){e&&(e.fileName=l,n(e))});break}}else setTimeout(s,1)}function n(e){$("#pasteImg").attr("src",e.base64),$("#pastePreview").removeClass("hide"),$("#maskVerify").removeClass("hide")}function s(){function t(){for(var e=r.getInputDocBody().getElementsByTagName("img"),t=0;t<e.length;t++)e[t].src.match(/webkit-fake-url:/i)&&e[t].parentNode.removeChild(e[t])}for(var i,a=r.getInputDocBody().getElementsByTagName("img"),s=0;s<a.length;s++)if(!a[s].getAttribute("code")){i=a[s];break}if(i){var o=i.currentSrc||i.src;o.match(/data:image\/[\w]+;base64/i)?n({base64:o}):o.match(/blob/i)?console.log("blob******************src"):o.match(/webkit-fake-url:/)?(console.log("safari等浏览器 粘贴图片无法发送"),e.removeEventListener("paste",t),e.addEventListener("paste",t)):o.match(/^(http[s]?:\/\/[^\/]+|)\/.+/gi)&&(r.getInputDocBody().innerHTML+=lanRes.picture+":"+o),i.parentNode?i.parentNode.removeChild(i):i.removeNode&&i.removeNode(!0)}}var o,r=this;r.filterPaste(e,t),this.hasPasteCapture=o=r.hasFormData,!window.ltIE10&&o&&"safari"!=view.chat.Browser.browser||setTimeout(function(){$("#inputPlaceholder").attr("placeholder",lanRes.inputPlaceholder2).html(lanRes.inputPlaceholder2)},500),o?(e.addEventListener?e.addEventListener("paste",a):e.attachEvent("onpaste",a),$("#pasteOK").on("click",function(){view.chat.publish("sendVisitorEvent",{et:123,uploadServiceType:r.uploadUtil.getUploadServiceType(),ssl:r.needHttps?1:void 0,ft:5},function(e){e.successful||(r.showTip(lanRes.networkFileError),$("#pasteError").removeClass("hide"),$("#pastePreview").removeClass("hide"),$("#maskVerify").removeClass("hide"))},{resend:!1}),r.captureFileSource=$("#pasteImg").attr("src").split("64,")[1],$("#pasteError").addClass("hide"),$("#pastePreview").addClass("hide"),$("#maskVerify").addClass("hide")}),$("#pasteCancel").on("click",function(){$("#pastePreview").addClass("hide"),$("#maskVerify").addClass("hide")})):t.addEventListener?t.addEventListener("paste",i):t.attachEvent("onpaste",i)},this.filterPaste=function(e,t){function i(e){return e.getSelection?e.getSelection():e.document.selection}function a(e,t){e.removeAllRanges(),e.addRange(t)}function n(e){e.preventDefault()}function s(s){if(!c.plainText){var f=void 0;try{if(f=e.clipboardData&&e.clipboardData.getData?e.clipboardData.getData("Text"):s.clipboardData.getData("Text")||s.clipboardData.getData("text/plain"))return console.log("获取到了文本，就去按获取到的文本处理",f),c.filterPasteText(s,f,e,t)}catch(e){f=f&&c.filterPasteData(f)||""}return function(e,t){var s=t,f=_$("html_input"),m=f.contentWindow.document;{if(u){var h=m.selection.createRange();if(s)d=s;else{var p=document.getElementById("ifmTemp");p?p.contentWindow.document.body.innerHTML="":((p=document.createElement("IFRAME")).id="ifmTemp",p.style.width="1px",p.style.height="1px",p.style.position="absolute",p.style.border="none",p.style.left="-10000px",p.src="iframeblankpage.html",document.body.appendChild(p),p.contentWindow.document.designMode="On",p.contentWindow.document.open(),p.contentWindow.document.write("<body></body>"),p.contentWindow.document.close()),l=f.contentWindow.document.body.innerText,p.contentWindow.focus(),p.contentWindow.document.execCommand("Paste",!1,null),f.contentWindow.focus(),d="string"==typeof p.contentWindow.document.body.textContent?p.contentWindow.document.body.textContent:p.contentWindow.document.body.innerText,d=c.filterPasteData(d)}return h.pasteHTML(d),e&&(e.returnValue=!1,e.preventDefault&&e.preventDefault()),!1}if(s)return f.contentWindow.document.execCommand("inserthtml",!1,s),e&&(e.returnValue=!1,e.preventDefault&&e.preventDefault()),!1;var g=m.createElement("DIV");g.id="htmleditor_tempdiv",g.innerHTML="\ufeff",g.style.left="-10000px",g.style.height="1px",g.style.width="1px",g.style.position="absolute",g.style.overflow="hidden",m.body.appendChild(g),f.contentWindow.document.addEventListener("mousedown",n,!1),f.contentWindow.document.addEventListener("keydown",n,!1),enableKeyDown=!1,o=f.contentWindow,r=i(o).getRangeAt(0);var v=g.firstChild,b=m.createRange();return b.setStart(v,0),b.setEnd(v,1),a(i(o),b),"\ufeff"===(l="string"==typeof f.contentWindow.document.body.textContent?f.contentWindow.document.body.textContent:f.contentWindow.document.body.innerText)&&(l=""),window.setTimeout(function(){if("\ufeff"===g.innerHTML)return d="",void m.body.removeChild(g);d="string"==typeof g.textContent?g.textContent:g.innerText,r&&a(i(o),r),d=c.filterPasteData(d),g.innerHTML=d,f.contentWindow.document.execCommand("inserthtml",!1,d),m.body.removeChild(g)},1),enableKeyDown=!0,f.contentWindow.document.removeEventListener("mousedown",n,!1),f.contentWindow.document.removeEventListener("keydown",n,!1),!0}}(s,f)}}var o,r,l,d,c=this,u=-1!=navigator.appName.indexOf("Microsoft"),f=document.getElementById("html_input");f&&(u?(f.contentWindow.document.documentElement.attachEvent("onpaste",s),f.contentWindow.document.documentElement.attachEvent("ondrop",c.filterDrop)):(f.contentWindow.document.addEventListener("paste",s,!1),f.contentWindow.document.body.addEventListener("drop",c.filterDrop,!1)))},this.filterDrop=function(t){var i=(t=t||window.event).dataTransfer&&t.dataTransfer.getData("text");if(!i)return t.returnValue=!1,t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation(),!1;i=e.filterPasteData(i,void 0,e.plainText),e.isInrobot&&(i=i.substring(0,e.maxRobotLength));var a=e.getInputDoc(),n=e.getInputDocBody(),s=e.win,o=e.editorType,r=s?s.pos:null;if(3==o)s=window,r=e.preRange;else if(1==o)return void(r=e.textRange);if(a.selection&&!/opera/gi.test(view.chat.Browser.browser)){if(e.plainText?this.focus():s.focus(),!r)return t.dataTransfer.setData("text"),!0;setTimeout(function(){(r=(3==o?e.preRange:1==o?e.textRange:s.pos)||r).pasteHTML(i),r.collapse(!0),r.select()},1)}else if(window.getSelection){var l;if(r)if(1==o)_$("textInput").focus(),document.execCommand("insertText",!1,i);else{var d=a.createElement("div");d.innerHTML=i,(l=s.getSelection()).removeAllRanges(),r.deleteContents(),r.insertNode(d),r.setStartAfter(d),r.setEndAfter(d),e.isMobile||(l.removeAllRanges(),l.addRange(r))}else n.innerHTML+=i;d&&setTimeout(function(){n.scrollTop=d.offsetTop},100)}return t&&(t.returnValue=!1,t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault()),!1}}!function(){var e=function(){function e(e){return e._zid||(e._zid=Z++)}function t(e){C.createElement;var t=C.createElement("div");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function i(e,t,a){var n=t&&t.ownerDocument,a=a||[];return e?e.nodeType||e==window.document||e==window?(this.context=e,this.results=[e],this.length=1,this):q(e)?void 0!==X?this.readyList.push(e):e():e instanceof i?e:((t?t.ownerDocument||t:S)!==C&&v(t),t=t||C,this.selector=e,this.context=t,this.results=function(e,t,i,a){if(!e)return i;var n,s,o,r,l,d=t?t.nodeType:9;if(r=b.exec(e),11!==d&&(r=b.exec(e)))if(n=r[1]){if(9===d){if(!(o=t.getElementById(n)))return i;if(o.id===n)return i.push(o),i}else if(t.ownerDocument&&(o=t.ownerDocument.getElementById(n))&&g(t,o)&&o.id===n)return i.push(o),i}else{if(n=r[2])return(u=T.find.TAG(n,t))&&N.apply(i,u),i;if((n=r[3])&&_.getElementsByClassName&&t.getElementsByClassName)return N.apply(i,t.getElementsByClassName(n)),i}1!==d&&(a=t,l=e);if(l)try{return N.apply(i,a.querySelectorAll(l)),i}catch(e){}var c,u=T.find.TAG("*",t),f=u.length;{if(s=0,c=r[2]){var m=[];if(i=t.getElementsByTagName(c),o=G,"*"===c){for(;o=i[s++];)1===o.nodeType&&m.push(o);return m}return i}for(var h=(0,H.CLASS)(r[3]);s!==f&&null!=(o=u[s]);s++)o&&1===o.nodeType&&h(o)&&i.push(o)}return i}(e,t,a,n),void(this.length=this.results.length)):(this.length=0,this.results=this.results||a,this)}function a(e){return"object"==function(e){return null==e?String(e):W[K.call(e)]||"object"}(e)}function n(e,t,i){for(var a in t)i&&(z(t[a])||V(t[a]))?(z(t[a])&&!z(e[a])&&(e[a]={}),V(t[a])&&!V(e[a])&&(e[a]=[]),n(e[a],t[a],i)):t[a]!==G&&(e[a]=t[a])}function e(e){return e._zid||(e._zid=Z++)}function s(t,i,a,n){function s(t){return t&&(!i.e||t.e==i.e)&&(!i.ns||r.test(t.ns))&&(!a||e(t.fn)===e(a))&&(!n||t.sel==n)}if((i=o(i)).ns)var r=function(e){return new RegExp("(?:^| )"+e.replace(" "," .* ?")+"(?: |$)")}(i.ns);for(var l=ee[e(t)]||[],d=[],c=0;c<l.length;c++)s(l[c])&&d.push(l[c]);return d}function o(e){var t=(""+e).split(".");return{e:t[0],ns:t.slice(1).sort().join(" ")}}function r(e,t){return e.del&&!ie&&e.e in ae||!!t}function l(e){return ne[e]||ie&&ae[e]||e}function d(t,i,a,n,s,d,c){var f=e(t),m=ee[f]||(ee[f]=[]);h.fn.each(i.split(/\s/),function(e,i){if("ready"==i)return h(C).ready(a);var f=o(i);f.fn=a,f.sel=s,f.e in ne&&(a=function(e){var t=e.relatedTarget;if(!t||t!==this&&!h.contains(this,t))return f.fn.apply(this,arguments)}),f.del=d;var p=d||a;f.proxy=function(e){if(!(e=u(e)).isImmediatePropagationStopped()){e.data=n;var i=p.apply(t,e._args==G?[e]:[e].concat(e._args));return!1===i&&(e.preventDefault(),e.stopPropagation()),i}},f.i=m.length,m.push(f),"addEventListener"in t?t.addEventListener(l(f.e),f.proxy,r(f,c)):t.attachEvent("on"+l(f.e),f.proxy)})}function c(t,i,a,n,o){var d=e(t);h.fn.each((i||"").split(/\s/),function(e,i){h.fn.each(s(t,i,a,n),function(e,i){delete ee[d][i.i],"removeEventListener"in t?t.removeEventListener(l(i.e),i.proxy,r(i,o)):t.detachEvent("on"+l(i.e),i.proxy)})})}function u(e,t){return!t&&e.isDefaultPrevented||(t||(t=e),h.each(le,function(i,a){var n=t[i];e[i]=function(){return this[a]=se,n&&n.apply(t,arguments)},e[a]=oe}),(t.defaultPrevented!==G?t.defaultPrevented:"returnValue"in t?!1===t.returnValue:t.getPreventDefault&&t.getPreventDefault())&&(e.isDefaultPrevented=se)),e}function f(e){var t,i={originalEvent:e};for(t in e)re.test(t)||e[t]===G||(i[t]=e[t]);return u(i,e)}function m(){}var h,p,g,v,b=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,y=/^[^{]+\{\s*\[native \w/,w=/[\t\r\n\f]/g,I=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,k=/\S+/g,T={find:{},filter:{}},S=window.document,C=window.document,x="echatQuery"+1*new Date,_={},E=[],M=E.slice,N=E.push,R=new RegExp("\\\\([\\da-f]{1,6}"+L+"?|("+L+")|.)","ig"),D=function(e,t,i){var a="0x"+t-65536;return a!=a||i?t:a<0?String.fromCharCode(a+65536):String.fromCharCode(a>>10|55296,1023&a|56320)},L="[\\x20\\t\\r\\n\\f]",P=function(){v()},H={TAG:function(e){var t=e.replace(R,D).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=new RegExp("(^|"+L+")"+e+"("+L+"|$)");return function(e){return t.test("string"==typeof e.className&&e.className||void 0!==e.getAttribute&&e.getAttribute("class")||"")}}};_.getElementsByTagName=t(function(e){return e.appendChild(C.createComment("")),!e.getElementsByTagName("*").length}),(v=function(e){var i,a,n=e?e.ownerDocument||e:S;return n===C||9!==n.nodeType||n.documentElement,C=n,p=C.documentElement,(a=C.defaultView)&&a.top!==a&&(a.addEventListener?a.addEventListener("unload",P,!1):a.attachEvent&&a.attachEvent("onunload",P)),_.attributes=t(function(e){return e.className="i",!e.getAttribute("className")}),_.getElementsByTagName=t(function(e){return e.appendChild(C.createComment("")),!e.getElementsByTagName("*").length}),_.getElementsByClassName=y.test(n.getElementsByClassName),_.getById=t(function(e){return p.appendChild(e).id=x,!C.getElementsByName||!C.getElementsByName(x).length}),_.getById?(T.find.ID=function(e,t){if(void 0!==t.getElementById){var i=t.getElementById(e);return i?[i]:[]}},T.filter.ID=function(e){var t=e.replace(R,D);return function(e){return e.getAttribute("id")===t}}):(delete T.find.ID,T.filter.ID=function(e){var t=e.replace(R,D);return function(e){var i=void 0!==e.getAttributeNode&&e.getAttributeNode("id");return i&&i.value===t}}),_.qsa=y.test(n.querySelectorAll),T.find.TAG=_.getElementsByTagName?function(e,t){return void 0!==t.getElementsByTagName?t.getElementsByTagName(e):_.qsa?t.querySelectorAll(e):void 0}:function(e,t){for(var i,a=[],n=0,s=S.getElementsByTagName(e);i=s[n++];)1===i.nodeType&&g(t,i)&&a.push(i);return a},T.find.CLASS=_.getElementsByClassName&&function(e,t){if(void 0!==t.getElementsByClassName&&documentIsHTML)return t.getElementsByClassName(e)},i=y.test(p.compareDocumentPosition),g=i||y.test(p.contains)?function(e,t){if(!e||!t)return!1;var i=9===e.nodeType?e.documentElement:e,a=t&&t.parentNode;return e===a||!(!a||1!==a.nodeType||!(i.contains?i.contains(a):e.compareDocumentPosition&&16&e.compareDocumentPosition(a)))}:function(e,t){if(!e)return!1;if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},n})();var A=0,B=/(\=)\?(&|$)|\?\?/i;(h=function(e,t,a){return new i(e,t)}).ajaxJSONP=function(e,t){function i(i,n){h(r).remove(),i&&"error"==i.type||!a?e.error&&e.error(null,n||"error",d,e,t):e.success&&e.success(a[0],d,e,t),window[o]=l,a&&q(l)&&l(a[0]),l=a=G}if(!("type"in e))return h.ajax(e);var a,n=window.document,s=e.jsonpCallback,o=(q(s)?s():s)||"jsonp"+ ++A,r=n.createElement("script"),l=window[o],d={abort:function(e){h(script).triggerHandler("error",e||"abort")}};t&&t.promise(d);n.getElementsByTagName("head")[0];window[o]=function(){a=arguments};var c="$1"+o+"$2";e.url=e.url.replace(B,c);var u="";if(e.data){for(var f in e.data){var m="string"==typeof e.data[f]?e.data[f]:JSON.stringify(e.data[f]);u="&"+f+"="+encodeURIComponent(m)}u&&(u=u.substring(1),u+="&")}e.url+=(/\?/.test(e.url)?"&":"?")+u+(e.jsonpCB||"jsonp")+"="+o;return"onload"in r?(r.onload=i,r.onerror=function(){i({type:"error"})}):r.onreadystatechange=function(){/loaded|complete/.test(r.readyState)&&i()},e.beforeSend&&!1===e.beforeSend(d)?(console.log("abort",e),d):(r.src=e.url,n.getElementsByTagName("head")[0].appendChild(r),d)},h.ajax=function(e){if("jsonp"==e.jsonp||"JSONP"==e.jsonp||"jsonp"==e.type||"JSONP"==e.type)return h.ajaxJSONP(e,e.deferred);var t=function(){var e;try{e=new XMLHttpRequest}catch(n){for(var t=["Msxml3.XMLHTTP","Msxml2.XMLHTTP","Microsoft.XMLHTTP"],i=0,a=t.length;i<a;i++)try{e=new ActiveXObject(t[i]);break}catch(e){continue}}return e}();if(t.onreadystatechange=function(){4==t.readyState&&(200==t.status?e.success&&e.success(t.responseText):e.error(t,t.responseText))},t.open(e.type,e.url,!0),e.header)for(var i in e.header)t.setRequestHeader(i,e.header[i]);e.header&&(e.header["Content-Type"]||e.header["Content-type"]||e.header["content-type"])&&!1===e.contentType||t.setRequestHeader("Content-type",e.contentType||"application/json;charset=UTF-8;"),e.beforeSend&&e.beforeSend(t);var a=e.data,n="";if(a&&"[object object]"==Object.prototype.toString.apply(a).toLowerCase())for(var s in a)n+="&"+s+"="+encodeURIComponent(a[s]);window.XMLHttpRequest?a||(a=null):a||(a=G),t.send(n?n.substring(1):a)};var F,O=/^-ms-/,$=/-([\da-z])/gi,U=function(e){return e.replace(O,"ms-").replace($,function(e,t){return t.toUpperCase()})};!function(){var e,t,i;(e=C.createElement("div")).innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",t=(t=(i=e.getElementsByTagName("a")[0])&&i.style).cssText="float:left;opacity:.5",F={float:t.cssFloat?"cssFloat":"styleFloat"},e=null,i=null}();var q=function(e){return null!=e&&("function"==typeof e||"[object Function]"===Object.prototype.toString.call(e))},V=function(e){return"[object Array]"===Object.prototype.toString.apply(e)},j=function(e){return"string"==typeof e},W={},K=W.toString,z=function(e){return a(e)&&!function(e){return null!=e&&e==e.window}(e)&&Object.getPrototypeOf(e)==Object.prototype},J=function(e){return null==e?"":(e+"").replace(I,"")};h.extend=function(e,t,i){for(var a in t)i&&(z(t[a])||V(t[a]))?(z(t[a])&&!z(e[a])&&(e[a]={}),V(t[a])&&!V(e[a])&&(e[a]=[]),n(e[a],t[a],i)):t[a]!==G&&(e[a]=t[a]);return e},h.cookie=function(e,t,i){if(arguments.length>1&&(!/Object/.test(Object.prototype.toString.call(t))||null===t||t===G)){if(i=h.extend({},i),null!==t&&t!==G||(i.expires=-1),"number"==typeof i.expires){var a=i.expires,n=i.expires=new Date;n.setDate(n.getDate()+a)}return t=String(t),C.cookie=[encodeURIComponent(e),"=",i.raw?t:encodeURIComponent(t),i.expires?"; expires="+i.expires.toUTCString():"","; path="+(i.path||"/"),i.domain?"; domain="+i.domain:"",i.secure?"; secure":""].join("")}for(var s,o=(i=t||{}).raw?function(e){return e}:decodeURIComponent,r=C.cookie.split("; "),l=0;s=r[l]&&r[l].split("=");l++)if(o(s[0])===e)return o(s[1]||"");return null},h.toJSON=JSON.stringify;var Q={src:!0,href:!0},Y={isFunction:q,isArray:V,isString:j,isObject:a,isPlainObject:z,trim:J,contains:g,readyList:[],find:function(e){var t={};return this.each(function(a,n){i.call(t,e,n,t.results)}),t},match:function(e,t){var a=null;return new i(t).each(function(t,i){if(i==e||g(i,e))return a=i,!0}),a},parents:function(e){var t,a,n,s,o;if(e&&this.results&&this.results.length>0&&(t=b.exec(e))&&((o=t[1])?a=function(e){return e.id==o}:(o=t[2])?(o=o.toUpperCase(),a=function(e){return e.tagName==o}):(o=t[3])&&(a=function(e){if(e.className){for(var t=e.className.split(" "),i=0;i<t.length;i++)if(t[i]==o)return!0;return!1}}),a))for(n=this.results[0];s=n.parentNode;){if(a(s))return new i(s,this.context,[]);n=s}return new i(null,this.context,[])},html:function(e){return e||""===e?this.each(function(t,i){i.innerHTML=e}):this.results&&this.results[0]?this.results[0].innerHTML:null},text:function(e){return"string"==typeof e?this.each(function(t,i){"string"==typeof i.textContent?i.textContent=e:i.innerText=e}):this.results&&this.results[0]?this.results[0].textContent||this.results[0].innerText:null},append:function(e){if(e){if(j(e)){var t=C.createElement("div");t.innerHTML=e;var i=t.childNodes;this.each(function(e,t){for(var a,e=0;a=i[e++];)1==a.nodeType&&(a=a.cloneNode(!0),t.appendChild(a))})}else this.each(function(t,i){i.appendChild(e)});return this}},insertBefore:function(e,t){if(e){var i;if(j(e)){var a=C.createElement("div");a.innerHTML=e;var n=a.childNodes;this.each(function(e,a){for(var s,e=0;s=n[e++];)1==s.nodeType&&(s=s.cloneNode(!0),(i=t||a.childNodes[0])?a.insertBefore(s,i):a.appendChild(s))})}else this.each(function(a,n){(i=t||n.childNodes[0])?n.insertBefore(e,i):n.appendChild(e)});return this}},show:function(){return this.each(function(e,t){t.style.display="block"}),this},hide:function(){return this.each(function(e,t){t.style.display="none"}),this},removeClass:function(e){for(var t,i,a,n,s=this.results.length,o=0,r=0,l=(e||"").match(k)||[];r<s;r++)if(t=this.results[r],i=1===t.nodeType&&(t.className?(" "+t.className+" ").replace(w," "):"")){for(o=0;a=l[o++];)for(;i.indexOf(" "+a+" ")>=0;)i=i.replace(" "+a+" "," ");n=e?J(i):"",t.className!==n&&(t.className=n)}else t.className="";return this},addClass:function(e){for(var t,i,a,n,s=this.results.length,o=0,r=0,l=(e||"").match(k)||[];r<s;r++)if(t=this.results[r],i=1===t.nodeType&&(t.className?(" "+t.className+" ").replace(w," "):"")){for(o=0;a=l[o++];)for(;i.indexOf(" "+a+" ")<0;)i+=a+" ";n=e?J(i):"",t.className!==n&&(t.className=n)}else t.className=e;return this},attr:function(e,t){if(!e)return this;if(void 0===t){if("string"==typeof e)return this.results&&this.results.length>0?this.getAttr(this.results[0],e):"";a=this.results?this.results.length:0;for(var i in e)for(n=0;n<a;n++){s=this.results[n];Q[i]?s[i]=e[i]:s.setAttribute(i+"",e[i])}}else for(var a=this.results?this.results.length:0,n=0;n<a;n++){var s;(s=this.results[n]).setAttribute(e,t),Q[e]?s[e]=t:s.setAttribute(e,t)}return this},css:function(e,t){if(!e)return this;if(void 0===t)if("string"==typeof e)this.css(e,0===t?"0":"inherit");else for(var i=this.results?this.results.length:0,a=0;a<i;a++)for(var n in e){s=U(n);s=F[s]||s;o=this.results[a];try{o.style[s]=e[n]}catch(e){console.log(e.message),console.log("css:"+s+":"+n)}}else try{for(var i=this.results?this.results.length:0,a=0;a<i;a++){var s=U(e);s=F[s]||s;var o;(o=this.results[a]).style[s]=t}}catch(e){return this}return this},remove:function(){for(var e=this.results?this.results.length:0,t=0;t<e;t++){var i=this.results[t];i.parentNode.removeChild(i)}return this.length=0,this.results=[],this},removeAttr:function(e){return this.each(function(t,i){i.setAttribute(e,""),i.removeAttribute(e)})},ready:function(e){for(var t,i=0;this.readyList&&(t=this.readyList[i]);)t.call(window),i++;return this},hasClass:function(e){for(var t=this.results?this.results.length:0,i=[],a=H.CLASS(e),n=0;n<t;n++){var s=this.results[n];a(s)&&i.push(s)}return i.length},max:function(e,t){return e>t?e:t},width:function(){return this.results&&this.results[0]?Y.max(this.results[0].offsetWidth,this.results[0].clientWidth):null},height:function(){return this.results&&this.results[0]?Y.max(this.results[0].offsetHeight,this.results[0].clientHeight):null},val:function(e){return void 0===e?this.results&&this.results[0]?this.results[0].value:null:(this.results&&this.results[0]&&(this.results[0].value=e+""),this)},getAttr:function(e,t){return e.getAttribute(t)},each:function(e,t){if(V(e))for(i=0;i<e.length&&!t.call(e[i],i,e[i]);i++);else if(q(e)){t=e,e=this.results||[];for(i=0;i<e.length&&!t.call(e[i],i,e[i]);i++);}else for(var i in e)if(t.call(e[i],i,e[i]))break;return this}},X=function(){function e(){n.removeEventListener("DOMContentLoaded",e,!1),n.removeEventListener("load",e,!1),a()}function t(){"complete"==n.readyState&&(n.detachEvent("onreadystatechange",t),n.detachEvent("onload",i),a())}function i(){n.detachEvent("onreadystatechange",t),n.detachEvent("onload",i),a()}var a=function(){X&&(Y.ready(),X=G)},n=window.document;if(n.addEventListener)n.addEventListener("DOMContentLoaded",e,!1),window.addEventListener("load",e,!1);else if(n.attachEvent)n.attachEvent("onreadystatechange",t),window.attachEvent("onload",i);else if(n.lastChild==n.body)return a();(n.getElementsByTagName("body")||[]).length>0&&a()};X(),h.fn=Y,h.each=Y.each;var G,Z=1,M=Array.prototype.slice,ee={},te={},ie="onfocusin"in window,ae={focus:"focusin",blur:"focusout"},ne={mouseenter:"mouseover",mouseleave:"mouseout"};te.click=te.mousedown=te.mouseup=te.mousemove="MouseEvents",h.event={add:d,remove:c},h.proxy=function(t,i){var a=2 in arguments&&M.call(arguments,2);if(q(t)){var n=function(){return t.apply(i,a?a.concat(M.call(arguments)):arguments)};return n._zid=e(t),n}if(j(i))return a?(a.unshift(t[i],t),h.proxy.apply(null,a)):h.proxy(t[i],t);throw new TypeError("expected function")},h.fn.bind=function(e,t,i){return this.on(e,t,i)},h.fn.unbind=function(e,t){return this.off(e,t)},h.fn.one=function(e,t,i,a){return this.on(e,t,i,a,1)};var se=function(){return!0},oe=function(){return!1},re=/^([A-Z]|returnValue$|layer[XY]$)/,le={preventDefault:"isDefaultPrevented",stopImmediatePropagation:"isImmediatePropagationStopped",stopPropagation:"isPropagationStopped"};h.fn.delegate=function(e,t,i){return this.on(t,e,i)},h.fn.undelegate=function(e,t,i){return this.off(t,e,i)},h.fn.live=function(e,t){return h(C.getElementsByTagName("body")[0]).delegate(this.selector,e,t),this},h.fn.die=function(e,t){return h(C.getElementsByTagName("body")[0]).undelegate(this.selector,e,t),this},h.fn.on=function(e,t,i,a,n){var s,o,r=this;return e&&!j(e)?(h.each(e,function(e,a){r.on(e,t,i,a,n)}),r):(j(t)||q(a)||!1===a||(a=i,i=t,t=G),a!==G&&!1!==i||(a=i,i=G),!1===a&&(a=oe),r.each(function(r,l){n&&(s=function(e){return c(l,e.type,a),a.apply(this,arguments)}),t&&(o=function(e){var i,n=(e=e||window.event).target||e.srcElement,o=Y.match(n,t);if(o&&o!==l)return i=h.extend(f(e),{currentTarget:o,liveFired:l}),(s||a).apply(o,[i].concat(M.call(arguments,1)))}),d(l,e,a,i,t,o||s)}))},h.fn.off=function(e,t,i){var a=this;return e&&!j(e)?(h.each(e,function(e,i){a.off(e,t,i)}),a):(j(t)||q(i)||!1===i||(i=t,t=G),!1===i&&(i=oe),a.each(function(){c(this,e,i,t)}))},h.fn.trigger=function(e,t){return e=j(e)||z(e)?h.Event(e):u(e),e._args=t,this.each(function(){e.type in ae&&"function"==typeof this[e.type]?this[e.type]():"dispatchEvent"in this?this.dispatchEvent(e):h(this).triggerHandler(e,t)})},h.fn.triggerHandler=function(e,t){var i,a;return this.each(function(n,o){(i=f(j(e)?h.Event(e):e))._args=t,i.target=o,h.each(s(o,e.type||e),function(e,t){if(a=t.proxy(i),i.isImmediatePropagationStopped())return!1})}),a},h.fn.each("focusin focusout focus blur load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select keydown keypress keyup error".split(" "),function(e,t){h.fn[t]=function(e){return 0 in arguments?this.bind(t,e):this.trigger(t)}}),h.Event=function(e,t){j(e)||(t=e,e=t.type);var i=C.createEvent(te[e]||"Events"),a=!0;if(t)for(var n in t)"bubbles"==n?a=!!t[n]:i[n]=t[n];return i.initEvent(e,a,!0),u(i)},h.fn.autoHeight=function(){this.each(function(){h(this).on("keyup",function(){!function(e){e.style.height="auto",e.style.height=e.scrollHeight+"px"}(this)})})},h.isBoolean=m,h.isDate=m,h.isFunction=m,h.isNaN=m,h.isNumber=m,h.isObject=m,h.isRegExp=m,h.isString=m,h.isUndefined=m;for(var de=h,ce="Array Boolean Date NaN Number Function Object RegExp Undefined".split(" "),ue=0;ue<ce.length;ue++){var fe=ce[ue];de["is"+fe]=function(e){return function(t){return t!=t?"NaN"===e:RegExp(e).test(Object.prototype.toString.call(t))}}(fe)}return i.prototype=h.fn,h}();window.EChatQuery=e}(),function($){void 0===window.ECHATObjKeyMap&&(window.ECHATObjKeyMap={});var UTIL=function(justBase){function _isPointerEventType(e,t){return e.type=="pointer"+t||e.type.toLowerCase()=="mspointer"+t||e.type=="mouse"+t}function _isPrimaryTouch(e){return e.type.indexOf("mouse")>-1||("touch"==e.pointerType||e.pointerType==e.MSPOINTER_TYPE_TOUCH)&&e.isPrimary}this.ECHATConfig={contextPath:"/mychat/visitor"};var _self=this;if(this.bot=/spider|bot/i.test(navigator.userAgent),this.subMap={},this.eventMap={},this.setSub=function(e){this.subMap[e]=e},this.removeSub=function(e){delete this.subMap["string"==typeof e?e:e.KEY]},this.publish=function(e){var t=this.subMap;for(var i in t){var a=ECHATObjKeyMap[i];if(a&&a.eventMap&&a.eventMap[e]){var n=a.eventMap[e];if(this.isArray(n))for(var s=0;s<n.length;s++)n[s].apply(a,arguments)}}},this.subscribe=function(e,t){this.eventMap[e]?this.eventMap[e].push(t):this.eventMap[e]=[t]},this.unSubscribeAll=function(){this.eventMap={}},this.unSubscribe=function(e){if(this.isArray(e))for(var t=0;t<e.length;t++)delete this.eventMap[e[t]];else delete this.eventMap[e]},this.isArray=function(e){return"[object Array]"===Object.prototype.toString.apply(e)},this.getQueryString=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),i=location.search.substr(1).match(t);if(null!=i)return decodeURIComponent(i[2])},this.escapeRegExp=function(e){var t=/[\\^$.*+?()[\]{}|]/g,i=new RegExp(t.source);return function(e){return e&&i.test(e)?e.replace(t,"\\$&"):e}}(),this.addMapParams=function(e){var t="";for(var i in e)t+="&"+i+"="+encodeURIComponent(e[i]||"");return t},this.getQueryParams=function(e){var t={};"string"!=typeof e&&(e=location.search),-1!=e.indexOf("#")&&(e=e.substring(0,e.indexOf("#"))),-1!=e.indexOf("?")&&(e=e.substring(e.indexOf("?")+1));for(var i,a=e.split("&"),n=a.length,s=0;s<n;s++)a[s]&&(i=a[s].split("="))[0]&&i[1]&&(t[i[0]]=decodeURIComponent(i[1]),t[i[0].toLowerCase()]=t[i[0]]);if(t.visEvt)try{var o=JSON.parse(t.visEvt);o&&o.eventId&&(t.eventId=o.eventId,t.eventid=o.eventId)}catch(e){t.visEvt=void 0,delete t.visEvt}return t},this.queryParams=this.getQueryParams(),this.companyId=this.getQueryString("companyid"),this.getBackground=function(e,t){var i=[],a=parseInt(t||100)/100,n=(e||"rgb(255,255,255)").toLocaleLowerCase().trim();if(0==n.indexOf("rgb"))n=n.replace("rgb","rgba").replace(")",","+a+")");else if(0==n.indexOf("#")){n=n.replace("#","").split("");for(var s=0;s<n.length;s++)3==n.length?i.push(parseInt("0x"+n[s]+n[s])):s%2==0&&i.push(parseInt("0x"+n[s]+n[s+1]));i.push(a),n="rgba("+i.join()+")"}return n},this.hasStorage=function(){var e;try{if(!window.localStorage)return!1;if(window.localStorage.setItem("echt_test_storage","ok"),!(e=window.localStorage.getItem("echt_test_storage")))return!1}catch(e){return!1}return e&&window.localStorage.removeItem("echt_test_storage"),!0}(),this.hasCookie=function(){$.cookie("echt_test_cookie","ok");return!!$.cookie("echt_test_cookie")&&($.cookie("echt_test_cookie",null),!0)}(),$.store=function(e){return e?function(e,t,i){return e?arguments.length>1&&(!/Object/.test(Object.prototype.toString.call(t))||null===t||void 0===t)?(i=$.extend({},i),null!==t&&void 0!==t||(i.expires=-1),t=String(t),i.session?window.sessionStorage.setItem(e,t):window.localStorage.setItem(e,t),t):(i=t||{}).local?window.localStorage.getItem(e):i.session?window.sessionStorage.getItem(e):window.localStorage.getItem(e)||window.sessionStorage.getItem(e)||$.cookie(e):null}:$.cookie}(this.hasStorage),!justBase){this.getDeviceInfo=function(){function G(){var e=C||D||window.opera;return/mobile|kgbrowser|(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))}function L(){return window.document.documentElement.clientWidth>window.document.documentElement.clientHeight}function R(){return E&&/(iemobile|windows phone)/i.test(C)}function T(){return E&&y.test(D)&&(!z.test(C)||/samsung/i.test(C))}function Y(){var e=window.document.documentElement.clientWidth,t=e/window.document.documentElement.clientHeight>1.2,i=window.screen.width,a=window.screen.height;t&&i<a&&(!0,i=window.screen.height,a=window.screen.width);var n=window.innerWidth,s=e/i;window.devicePixelRatio&&T()&&i>640?s*=window.devicePixelRatio:R()&&(s*=1.5);var o=e/n/s;return o=(o/1.2).toFixed(2),(i/n).toFixed(2)}function Z(){var e=window,t=e.document.documentElement,i=e.document.body,a=null,n={top:0,left:0};if(h(t.getBoundingClientRect)&&(h(e.getComputedStyle)?"relative"==e.getComputedStyle(i).position?a=i:"relative"==e.getComputedStyle(t).position&&(a=t):i.currentStyle?"relative"==i.currentStyle.position?a=i:"relative"==t.currentStyle.position&&(a=t):"relative"==i.style.position?a=i:"relative"==t.style.position&&(a=t)),a){var s=a.getBoundingClientRect();n.top=s.top+e.pageYOffset-t.clientTop,n.left=s.left+e.pageXOffset-t.clientLeft}return n}_self.deviceInfo=F;var b=_self,f=b.indexOf=function(){var e=Array.prototype.indexOf;return"function"==typeof e&&/\[native code\]/.test(e.toString())||(e=function(e){if(null==this)throw new TypeError;var t=Object(this),i=t.length>>>0;if(0===i)return-1;var a=0;if(arguments.length>0&&((a=Number(arguments[1]))!=a?a=0:0!=a&&a!=1/0&&a!=-1/0&&(a=(a>0||-1)*Math.floor(Math.abs(a)))),a>=i)return-1;for(var n=a>=0?a:Math.max(i-Math.abs(a),0);n<i;n++)if(n in t&&t[n]===e)return n;return-1}),function(t,i,a){return e.call(i,t,a)}}(),h=b.isFunction=function(){return function(e){return"function"==typeof e}}(),i=b.isString=function(){return function(e){return"string"==typeof e}}(),q=b.Browser=function(){function $f(e){return e.replace(/^http:/,$a?"https:":"http:")}function $g(){return window.innerHeight!==a?window.innerHeight:document.documentElement?document.documentElement.offsetHeight:document.getElementsByTagName("body").length?document.getElementsByTagName("body")[0].clientHeight:0}function $h(){return window.innerWidth!==a?window.innerWidth:document.documentElement?document.documentElement.offsetWidth:document.getElementsByTagName("body").length?document.getElementsByTagName("body")[0].clientWidth:0}function $o(){var e,t=x.plugins&&x.plugins[$k];if(t)return(e=x.mimeTypes&&x.mimeTypes[$m])&&!e.enabledPlugin?null:t.description;if(window.ActiveXObject)try{return t=new window.ActiveXObject($l),t.AllowScriptAccess="always",t.GetVariable("$version")}catch(e){}}function $p(){var e=x.mimeTypes;return A?!Q&&("javaEnabled"in x&&x.javaEnabled()):e&&(e=e[$n])&&(e=e.enabledPlugin)?e.name:void 0}function $q(){if(!k(S))return S;var e=document.createElement("div"),t=document.createElement("div"),i=e.style,a=t.style;return i.overflow="auto",i.width=i.height="100px",i.position="absolute",i.top="-1000px",a.width="100%",a.height="200px",e.appendChild(t),document.body.appendChild(e),S=e.offsetWidth-e.clientWidth,document.body.removeChild(e),S}function $r(){try{return eval("false")}catch(e){return!0}}function $s(){for(var e=3,t=document.createElement("div"),i=t.getElementsByTagName("i");t.innerHTML="\x3c!--[if gt IE "+ ++e+"]><i></i><![endif]--\x3e",i[0];);return e>4?e:document.documentMode}var x=navigator,y=x.userAgent.toLowerCase(),osVersion=0,z=+(/trident.*rv:? *([0-9]+)/.exec(y)||[])[1]||!1,A=$s(),zz=/edge/.exec(y)||!A&&!!window.StyleMedia||!1,B=8==A,C=7==A,D=6==A,E=window.opera&&"[object Opera]"==Object.prototype.toString.call(window.opera)||/webkit/.test(y)&&(/opr/.test(y)||/opera/.test(y)),F="Google Inc."==navigator.vendor,G="Apple Computer, Inc."==navigator.vendor,H=!A&&(F||G||/webkit|khtml/.test(y)),I=+/\d+/.exec(/firefox\/\d+/i.exec(navigator.userAgent)||""),J=y.indexOf("firefox/2")>-1,K=y.indexOf("firefox/3")>-1,L=-1!=y.indexOf("iphone"),M=-1!=y.indexOf("ipod"),N=-1!=y.indexOf("ipad"),O=L||N||M,Q=-1!=y.indexOf("wp7"),kgBrowser=-1!=y.indexOf("kgbrowser"),meizu=-1!=y.indexOf("mzbrowser"),P=meizu||-1!=y.indexOf("android"),R=O||P||Q||kgBrowser||meizu,S,uc=-1!=y.indexOf("ucbrowser"),liebao=-1!=y.indexOf("lbbroser")||y.indexOf("liebao")>-1,qq=-1!=y.indexOf("qqbrowser"),sogou=-1!=y.indexOf("metasr")||-1!=y.indexOf("sogou"),f360=y.match(/360|qhbrowser|qihoobrowser/i),maxth=-1!=y.indexOf("maxthon"),baidu=-1!=y.indexOf("bidubrowser")||-1!=y.indexOf("baidubrowser")||-1!=y.indexOf("baidu"),weixin=-1!=y.indexOf("micromessenger"),chromeIphone=L&&-1!=y.indexOf("crios"),T=A&&"msie"||I&&"firefox"||E&&"opera"||uc&&"uc"||liebao&&"liebao"||qq&&"qq"||zz&&"edge"||sogou&&"sogou"||f360&&"360"||maxth&&"maxth"||baidu&&"baidu"||weixin&&"weixin"||chromeIphone&&"chrome"||G&&"safari"||F&&"chrome"||H&&"chrome",U,V=A&&!W,W="CSS1Compat"==document.compatMode,X=!W,Y=A&&X&&document.documentElement&&!!document.documentElement.style.setExpression,Z=document.documentMode||A,$$=-1!=y.indexOf("windows")||-1!=y.indexOf("win32"),$_=-1!=y.indexOf("macintosh")||-1!=y.indexOf("mac os x")||-1!=window.navigator.platform.indexOf("Mac"),$a="https:"==document.location.protocol,$b=x.language||x.browserLanguage||x.userLanguage||x.systemLanguage,$c={noBoxSizing:Z<=7,ie:{cssBottomRight:D,cssFixed:D||Y,buggyCSS:D||Y}},$d="textContent"in document.createElement("div"),$e=!1;try{window.CustomEvent&&/\[native code\]/.test(window.CustomEvent.toString())&&(new window.CustomEvent("testevent",{bubbles:!1,cancelable:!0,detail:!0}),$e=!0)}catch(e){}switch(T){case"opera":U=+/\d+/.exec(new RegExp("opr[ /]\\d+").exec(y)||"");break;case"msie":case"firefox":case"chrome":U=U||+/\d+/.exec(new RegExp(T+"[ /]\\d+").exec(y)||"");break;case"baidu":U=+/\d+/.exec(new RegExp("bidubrowser[ /]\\d+").exec(y)||"");break;case"maxth":U=+/\d+/.exec(new RegExp("maxthon[ /]\\d+").exec(y)||"");break;case"qq":U=+/\d+/.exec(new RegExp("qqbrowser[ /]\\d+").exec(y)||"");break;case"liebao":U=+/\d+/.exec(new RegExp("lbbroser[ /]\\d+").exec(y)||"");break;case"uc":U=+/\d+/.exec(new RegExp("ucbrowser[ /]\\d+").exec(y)||"");break;case"sogou":U=+/\d+/.exec(new RegExp("metasr[ /]\\d+").exec(y)||"");break;default:U=+/\d+/.exec(/version[ \/]\d+/.exec(y)||"")}if(O&&(osVersion=+/\d+/.exec(new RegExp("iphone os \\d+").exec(y)||"")),D){var $i=[];$c.leaksMemory=function(e){p.isFunction(e),$i.push(e)};var $j=function(){for(var e=0;e<$i.length;e++)$i[e]()};$c.leaksMemory.remove=function(e){for(var t=$i.length-1;t>=0;t--)e==$i[t]&&$i.splice(t,1)},window.attachEvent("onunload",$j)}var $k="Shockwave Flash",$l="ShockwaveFlash.ShockwaveFlash",$m="application/x-shockwave-flash",$n="application/x-java-vm",$t={browser:T,version:U,osVersion:osVersion,isStrict:W,isQuirks:X,isOpera:E,isSafari:G,isWebKit:H,isChrome:!E&&F,isAndroid:P,isIPhone:L,isIPod:M,isIPad:N,isIOS:O,isWP7:Q,isMobile:R,isEdge:zz,isNewIE:z,isIE:A,isIE6:D,isIE7:C,isIE8:B,isFF:I,isFF2:J,isFF3:K,isBorderBox:V,isCustomEvents:$e,engineIE:Z,bugs:$c,isWindows:$$,isXP:/windows nt 5.1/.test(y),isMac:$_,isLinux:/Linux/.test(navigator.platform),isSecure:$a,secureURL:$f,hasFlash:$o(),hasJava:$p(),language:$b,getScrollbarSize:$q,getWindowClientHeight:$g,getWindowClientWidth:$h,isTextContent:$d,hasCSP:$r()};return $t.isPC=!$t.isMobile&&($t.isWindows||$t.isMac||$t.isEdge||$t.isLinux),$t}(),x=b.__$$__jx_ui_HTMLElement,y=/google inc\./i,z=/chrome/i,A=/apple computer, inc\./i,B=/crios/i,C=window.navigator.userAgent||"",D=window.navigator.vendor||"",F={checkLandscape:L,getZoomLevel:Y,getOffset:Z},E=G();_self.Device=F}();var isMobilePage=window.mobilePage||-1!=location.href.split("?")[0].indexOf("/visitor/mobile/")&&!ECHATObjKeyMap.outerId;_self.Browser.isMobile||isMobilePage||!_self.Browser.isPC?_self.Device.media=2:_self.Device.media=1,_self.Device.OS=this.Browser.isWindows&&"Windows"||this.Browser.isIPhone&&"iPhone"||this.Browser.isIPad&&"IPAD"||this.Browser.isIPod&&"IPOD"||this.Browser.isMac&&"OSX"||this.Browser.isAndroid&&"Android"||this.Device.isWP&&"Windows Phone"||this.Browser.isLinux&&"Linux"||"others",this.hasTranslate=this.Browser.isMobile,this.setTransform=function(e,t){var i="translate("+e+"px,"+t+"px)";_self.hasTranslate?$(this).css({"-webkit-transform":i,"-o-transfrom":i,"-ms-transform":i,"-moz-transform":i,transform:i}):$(this).css({left:e+"px",top:t+"px"})},this.setScale=function(e){var t=this;!function(){var e=_self.deviceInfo.getZoomLevel();(1/e).toFixed(2),window.pageXOffset,window.pageYOffset,window.innerWidth,window.innerHeight,t[0].clientWidth,t[0].clientHeight}()};var _clearSlct="getSelection"in window?function(){window.getSelection().removeAllRanges()}:function(){document.selection.empty()};this.pageSlide=function(e,t){$(e).attr("x","0"),$(document).on("mousedown touchstart",e,function(e){e=e||window.event;var i=!1;if(!(i=_isPointerEventType(e,"down"))||_isPrimaryTouch(e)){e=i?e:e.touches&&e.touches[0]||e;var a={};a.x2=void 0,a.y2=void 0;var n=0,s=0,o=$(this),r=this.parentNode.clientWidth,l=r/8,d=parseInt(o.attr("x")||this.offsetLeft)||0,c=this.clientWidth,u=-c+r-20;a.x1=e.clientX,a.y1=e.clientY,o.removeClass("transition");var f=function(e){e.cancelable=!0,e.preventDefault()};r=parseInt(c/parseInt(c/r)),console.log(r),document.body.addEventListener("touchmove",f,{passive:!1});var m=function(e){e=i?e:e.touches&&e.touches[0]||e,a.x2=e.clientX,a.y2=e.clientY,n=a.x2-a.x1,s=a.y2-a.y1;var t=n+d;t=t>20?20:t<u?u:t,_self.setTransform.call(o,t,0),o.attr("x2",t),_clearSlct(),e.originalEvent&&(e=e.originalEvent),e.cancelable=!0,e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()},h=function(e){if(_clearSlct(),o){o.addClass("transition");var i=0;if(l<Math.abs(n)){parseInt(o.attr("x2"));n>=l&&d+r<=0?(_self.setTransform.call(o,d+r,0),o.attr("x",d+r),i=-1):n<=-l&&d-r+c>r/10?(_self.setTransform.call(o,d-r,0),o.attr("x",d-r),i=1):_self.setTransform.call(o,d,0)}else _self.setTransform.call(o,d,0);var a=t&&t(i);if($(document).off("mousemover mousemove touchmove",m).off("mouseup touchend",h),o=null,_clearSlct(),!1===a)return e.stopPropagation&&e.stopPropagation,e.preventDefault&&e.preventDefault(),!1;document.body.removeEventListener("touchmove",f)}};$(document).on("mousemover mousemove touchmove",m).on("mouseup touchend",h)}})},this.getCSSRule=function(e,t,i){if(i=i||window.document,e=e.toLowerCase(),i.styleSheets)for(var a=0;a<i.styleSheets.length;a++){var n=i.styleSheets[a],s=0,o=!1;do{if((o=n.cssRules?n.cssRules[s]:n.rules[s])&&o.selectorText&&o.selectorText.toLowerCase()==e)return"delete"==t?(n.cssRules?n.deleteRule(s):n.removeRule(s),!0):o;s++}while(o)}return!1},this.killCSSRule=function(e){return this.getCSSRule(e,"delete")},this.addCSSRule=function(e){return document.styleSheets&&(this.getCSSRule(e)||(document.styleSheets[0].addRule?document.styleSheets[0].addRule(e,null,0):document.styleSheets[0].insertRule(e+" { }",0))),this.getCSSRule(e)},this.addJS=function(e,t){function i(e){a.onload=a.onerror=a.onreadystatechange=null,n.removeChild(a),t&&t(e,a.innerHTML),a=null}var a=document.createElement("script");a.setAttribute("type","text/javascript");var n=document.getElementsByTagName("head")[0];"onload"in a?(a.onload=i,a.onerror=function(){i(!0)}):a.onreadystatechange=function(){/loaded|complete/.test(a.readyState)&&i()},a.src=e,n.appendChild(a)},this.addCSS=function(e){var t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e,t.media="screen";document.getElementsByTagName("head")[0].appendChild(t)},this.base64encode=function(e){var t,i,a,n,s,o,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(a=e.length,i=0,t="";i<a;){if(n=255&e.charCodeAt(i++),i==a){t+=r.charAt(n>>2),t+=r.charAt((3&n)<<4),t+="==";break}if(s=e.charCodeAt(i++),i==a){t+=r.charAt(n>>2),t+=r.charAt((3&n)<<4|(240&s)>>4),t+=r.charAt((15&s)<<2),t+="=";break}o=e.charCodeAt(i++),t+=r.charAt(n>>2),t+=r.charAt((3&n)<<4|(240&s)>>4),t+=r.charAt((15&s)<<2|(192&o)>>6),t+=r.charAt(63&o)}return t},this.iScrollParam={preventDefault:!1,preventDefaultException:/^(A|PRE|INPUT|TEXTAREA|BUTTON|SELECT|LABEL)$/,tap:!1,click:!1,mouseWheel:!1,fadeScrollbars:!1},this.parseMsgByRule=function(e,t,i){if(t&&e){var a=this.regFace,n=this.regEmo||new RegExp("\\[#[a-z0-9A-Z]+(_[a-z0-9A-Z]+)?#\\]","g"),s=1,o=t[e.mt||0];return o?o=o.replace(/\$\{([^,]+),?([^,]+)?,?([^,]+)?,?([^,]+)?\}/g,function(t,i,a,n,o){if(s="1"==o?1:0,!a&&!n)return e[i];n=parseInt(n);var r=e[i];return n>0&&r.replace(/\[#([^#]+)#\]/g,function(e,t,i,a){return i<n&&i+e.length>=n?n+=e.length-1:i<n&&(n+=e.length-1),e}),e[i].substring(a,n)}):(o=e.content)||(o=t[0]),(s||i&&i.notPlainText)&&(o=function(e,t){return e&&e.replace(/<(?:.|\s)*?>/gi,"").substring(0,t||100)}(o)),a?o&&(o=function(e,t){if(!e)return e;var i=this.emo;return i&&(e=e.replace(a,function(e){arguments[0];var t=e.charCodeAt(0),a=e.charCodeAt(1),n=(a-56320+(t-55296<<10)+65536).toString(16);return i[n]?'<img class="img-emo" src="/res/emoji/32/'+n+'.png" />':i[t+"_"+a]?'<img class="img-emo" src="/res/emoji/32/'+t+"_"+a+'.png" />':e})),e=e.replace(n,function(e){var t=e.replace(/^\[#([\d\w_]+)#\]/g,"$1");return i&&i[t]||!i?'<img class="img-emo" src="/res/emoji/32/'+t+'.png" />':e})}(o)):o&&(o=o.replace(n,"[face]")),o}},this.lastMsgRule={0:"您有新的消息",604:"您的对话已接通",605:"您的对话已结束",621:"给您发送了一个信息填写邀请",622:"给您发送了一个信息填写邀请",640:"${content,0,30,1}",641:"[图片]",642:"[文件]",647:"${content,0,30,1}",648:"等待接入会话，排队位置:${position}",653:"[图片]",657:"[图文消息]",673:"请您对本次服务进行评价",674:"您有新的消息",675:"您有新的消息",676:"您有新的消息",10011:"[图文消息]",864:"${content,0,30,1}",865:"[图片]",866:"[文件]",680:"[链接]"},this.formatUnreadMsg=function(e){var t=this;if(!e.lastMsgContent)return{unreadMsgCount:e.unreadMsgNumber||e.unreadMsgCount||0};var i=this.lastMsgRule;return function(e){this.needHttps&&e.companyLogo&&(e.companyLogo=e.companyLogo.replace(/^http:/,this.needHttps)),void 0!==e.unreadMsgNumber&&(e.unreadMsgCount=e.unreadMsgNumber),e.lastMsg=JSON.parse(e.lastMsgContent),e.msgContent=t.parseMsgByRule(e.lastMsg,i)}(e),{chatUrl:(this.loaderHost||location.origin)+"/visitor/mobile/chat.html?companyId="+e.companyId+"&platformSign="+encodeURIComponent(e.signature)+"&metaData="+encodeURIComponent(this.queryParams.metaData)+"&myData="+encodeURIComponent(this.queryParams.myData),msgId:e.mid,platformId:e.platformId||void 0,companyId:e.companyId,companyLogo:e.companyLogo,companyName:e.companyName,msgContent:e.msgContent,unreadMsgCount:e.unreadMsgCount}},this.sendMsgboxUnread=function(){function e(){n.readySend=$.store(n.readySendName),n.readySend=n.readySend?JSON.parse(n.readySend):{order:[]}}function t(t,i){e();var a=n.readySend.order;if(0===i){if(t.mid&&(n.readySend.lastMid=t.mid),a.length>0){n.readySend[t.mid]=void 0,delete n.readySend[t.mid];for(s=0;s<a.length;s++)a[s]==t.mid&&a.splice(s,1)}}else if(!n.readySend[t.mid]&&(n.readySend[t.mid]=t,n.readySend.order.unshift(t.mid),n.readySend.order.length>10)){for(var s=10;s<a.length;s++)n.readySend[a[s]]=void 0,delete n.readySend[a[s]];n.readySend.order.length=10}$.store(n.readySendName,JSON.stringify(n.readySend))}function i(e){if(e&&(n.queue.push(e),t(e,1)),0!=n.queue.length){var s=$.cookie(n.cookieName);s&&(n.checkTimer||n.timeoutTimer)?n.checkTimer||n.timeoutTimer||(n.timeoutTimer=setTimeout(function(){n.timeoutTimer=null,i()},300)):(!s&&n.checkTimer&&clearTimeout(n.checkTimer),!s&&n.timeoutTimer&&clearTimeout(n.timeoutTimer),a(n.queue.shift()))}}function a(a){if(a){if(e(),n.readySend.lastMid&&n.readySend.lastMid>=a.mid)return i();n.cookieValue=a.mid+"_"+n.pageTag,$.cookie(n.cookieName,n.cookieValue),n.checkTimer=setTimeout(function(){n.checkTimer=null;$.cookie(n.cookieName)==n.cookieValue&&(s(a),$.cookie(n.cookieName,""),t(a,0)),$.cookie(n.cookieName)?n.timeoutTimer=setTimeout(function(){n.timeoutTimer=null,i()},300):i()},200)}}var n={cookieName:"",cookieValue:"",readySendName:"",readySend:{lastMid:"",order:[123],123:{}},queue:[],pageTag:(new Date).getTime(),checkTimer:null,timeoutTimer:null},s=null;return{send:i,queue:n.queue,init:function(e){if(!s&&_self.visitorId){var t;n.cookieName="unreadNewMsg_"+_self.visitorId,n.readySendName="unreadNewMsgMap_"+_self.visitorId,$.cookie(n.readySendName,""),n.cookieValue=$.cookie(n.cookieName),n.readySend=$.store(n.readySendName),n.readySend?n.readySend=JSON.parse(n.readySend):(n.readySend={order:[]},$.store(n.readySendName,'{ "order": [] }')),n.cookieValue&&(t=n.cookieValue.split("_")[0],n.readySend[t]&&a(n.readySend[t])),s=e}}}}(),$(document).on("drag",function(e){return(e=e||window.event).preventDefault&&e.preventDefault(),!1})}};UTIL.prototype.serverAdaptor={fuzzyBrandI18nRes:function(){}},window.SDK||__inline("serverTypeAdaptor.js"),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.toString().replace(/(^\s+)|(\s+$)/g,"")}),Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var i in t)new RegExp("("+i+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[i]:("00"+t[i]).substr((""+t[i]).length)));return e},window.UTIL=UTIL,"undefined"==typeof console&&(window.console={log:function(e){}})}(EChatQuery),function(e){function t(){d=null,u.last&&(u.el.trigger("longTap"),u={})}function i(){d&&clearTimeout(d),d=null}function a(){o&&clearTimeout(o),r&&clearTimeout(r),l&&clearTimeout(l),d&&clearTimeout(d),o=r=l=d=null,u={}}function n(e){return("touch"==e.pointerType||e.pointerType==e.MSPOINTER_TYPE_TOUCH)&&e.isPrimary}function s(e,t){return e.type=="pointer"+t||e.type.toLowerCase()=="mspointer"+t}var o,r,l,d,c,u={};e(function(){var f,m,h,p,g=0,v=0;"MSGesture"in window&&((c=new MSGesture).target=document.body),e(document).bind("MSGestureEnd",function(e){var t=e.velocityX>1?"Right":e.velocityX<-1?"Left":e.velocityY>1?"Down":e.velocityY<-1?"Up":null;u.el&&t&&(u.el.trigger("swipe"),u.el.trigger("swipe"+t))}).on("touchstart",function(i){(p=s(i,"down"))&&!n(i)||(h=p?i:i.touches[0],i.touches&&1===i.touches.length&&u.x2&&(u.x2=void 0,u.y2=void 0),f=Date.now(),m=f-(u.last||f),u.el=e("tagName"in h.target?h.target:h.target.parentNode),o&&clearTimeout(o),u.x1=h.pageX,u.y1=h.pageY,m>0&&m<=250&&(u.isDoubleTap=!0),u.last=f,d=setTimeout(t,750),c&&p&&c.addPointer(i.pointerId))}).on("touchmove",function(e){(p=s(e,"move"))&&!n(e)||(h=p?e:e.touches[0],i(),u.x2=h.pageX,u.y2=h.pageY,g+=Math.abs(u.x1-u.x2),v+=Math.abs(u.y1-u.y2))}).on("touchend",function(t){(p=s(t,"up"))&&!n(t)||(i(),u.x2&&Math.abs(u.x1-u.x2)>30||u.y2&&Math.abs(u.y1-u.y2)>30?u.el&&(l=setTimeout(function(){u.el&&(u.el.trigger("swipe"),u.el.trigger("swipe"+function(e,t,i,a){return Math.abs(e-t)>=Math.abs(i-a)?e-t>0?"Left":"Right":i-a>0?"Up":"Down"}(u.x1,u.x2,u.y1,u.y2)),u={})},0)):"last"in u&&(g<30&&v<30?r=setTimeout(function(){var t=e.Event("tap");u.el&&(t.cancelTouch=a,u.el&&u.el.trigger(t),u.isDoubleTap?(u.el&&u.el.trigger("doubleTap"),u={}):o=setTimeout(function(){o=null,u.el&&u.el.trigger("singleTap"),u={}},250))},0):u={}),g=v=0)}).on("touchcancel MSPointerCancel pointercancel",a),e(window).on("scroll",a)}),["swipe","swipeLeft","swipeRight","swipeUp","swipeDown","doubleTap","tap","singleTap","longTap"].forEach(function(t){e.fn[t]=function(e){return this.on(t,e)}})}(window.EChatQuery),function(e){var t=new function(i){function a(e){m=!1,e&&(c.publish("chatEnded",e),h=!1),c.unSubscribe(["sendVisitorEvent","visitorCommonEvent"]),c.unSubscribe("restartChat"),c.subscribe("restartChat",function(){view.chat.publish("__callNative",{functionName:"restartChat"})})}function n(e,t,i,a){var n=a?f:u,o=i?i.item:(new Date).getTime(),r=i||{data:e,cb:t,time:o,sending:!0};return!(i&&104!=e.et)&&n.push(r),c.publish("__sendMessage",e,function(i){if(t&&(i.bridgeMsgId=e.bridgeMsgId,t.apply(this,arguments)),i.successful){for(var a=n.length-1;a>-1;a--)if(n[a]&&n[a].time==o){n.splice(a,1);break}s(!1)}else r.sending=!1}),!0}function s(e){var t=e?f:u;if(t.length>0)for(var i,a=0;a<t.length&&((i=t[a]).sending||(i.sending=!0,n(i.data,i.cb,i)));a++);}function o(e){c.unSubscribe(["sendVisitorEvent","visitorCommonEvent"]),c.subscribe("sendVisitorEvent",function(e,t,i){n(t,i,null,!0)}),c.subscribe("visitorCommonEvent",function(e,t,i){n(t,i,null,!1)})}function r(e,t,i){if(console.log(e,t,i),e)try{var a={functionName:e,value:t||""};i&&"function"==typeof i&&(a.callback="callback_"+b,window[a.callback]=function(){console.log("callback***"+a.callback,arguments),i.apply(i,arguments),window[a.callback]=null},b++),window.wkWebkit?window.webkit&&window.webkit.messageHandlers.callEchatNativeConnect.postMessage(JSON.stringify(a)):window.EchatJsBridge&&EchatJsBridge.callEchatNativeConnect(JSON.stringify(a))}catch(e){console.log(e)}}function l(e){return"string"==typeof e?JSON.parse(e+""):e}function d(e,t,i){var a=l(e);if(105==a.et||130==a.et||864==a.mt)a.mt=864,a.tm=a.tm||a.bridgeMsgId,a.f="c",130==a.et&&(a.ff="r"),a.m=0;else if(640==a.mt||641==a.mt||642==a.mt)a.f="s",640==a.mt&&(a.m=0),641==a.mt&&(a.m=2),642==a.mt&&(a.m=1);else if(127==a.et)a.f="c",a.mt=127;else if(12001==a.mt)a.f="r";else{if(104==a.et||644==a.mt||106==a.et||109==a.et)return;10011==a.mt&&(a.f=1==a.mst?"c":2==a.mst?"s":"x")}var n=a.tm||(new Date).getTime();673==a.mt&&"unread"!=i||(t[n]=a,t.order?t.order.push(n):t.order=[n]),649!=a.mt&&604!=a.mt&&600!=a.mt||(t.config?t.config.push(a):t.config=[a])}e.cometd={getStatus:function(){return"sdk"}},UTIL.call(this,!0);var c=this,u=[],f=[],m=!1;this.selfMsg=function(e,t){var i=e;switch("0"==i.id&&(i.id=i.mid),i.mt+""){case"10009":return!1!==i.isForward||c.lastTalkId||(c.lastTalkId=view.chat.talkId,c.lastTalkType=view.chat.isInRobot?3:!0===view.chat.chatting?1:2),!1===i.isForward&&4!=i.type&&10!=i.type&&9!=i.type&&11!=i.type&&view.chat.publish("__chatStatus","exceptionEnd"),i.justConnect=4!=i.type&&10!=i.type,void a(i);case"600":window.chatVisitorId="chatVisitorId"+i.visitorId,window.encryptVID=c.encryptVID=i.encryptVID,c.visitorId=i.visitorId,window.encryptVID=c.companyId=i.companyId,view.chat.initVisitor(),c.publish("setVisitorInfo",i),(i.routeEntranceInfo||i.routeEntranceInfoString)&&(i.routeEntranceInfo=i.routeEntranceInfo||JSON.parse(i.routeEntranceInfoString),c.waitForRouterSelect=!0,c.publish("displayRouterInfo",i)),o(),c.publish("handshakeOk",e),m=!0,c.publish("updateVisitorInfo",i);break;case"671":c.publish("setChatParam",i);break;case"672":c.publish("setRestartTag",i);break;case"649":o(),c.publish("setconfig",i),(!0!==view.chat.chatting||view.chat.isInRobot)&&c.publish("waitingChat",i);break;case"651":case"682":break;case"652":this.publish("getErr",i);break;case"646":this.publish("getChatToken",i);break;default:!t&&c.receiveChat(e,!0)}};var h=!1;this.receiveChat=function(t,i){var n=t;switch("0"==n.id&&(n.id=n.mid),n.mt+""){case"127":case"902":this.publish("sendLocationInfo",n);break;case"658":n.current=!0,this.publish("orderReply",n);break;case"677":case"678":this.publish("startLeave",n);break;case"687":case"691":c.publish("startRobot",n);break;case"686":case"604":c.waitForRouterSelect=!1,function(e){c.publish("startChat",e)}(n),s(!0);break;case"605":return!1!==n.isForward||c.lastTalkId||(c.lastTalkId=view.chat.talkId,c.lastTalkType=view.chat.isInRobot?3:!0===view.chat.chatting?1:2),void((!n.fromHistory||n.fromDB)&&a(n));case"620":return void this.publish("staffState",n);case"640":this.publish("getMsg",n);break;case"641":n.identityKey&&(n.fileIdentity=n.identityKey),!n.clientFileId&&(n.clientFileId=n.identityKey),this.publish("getMsgImg",n);break;case"642":n.identityKey&&(n.fileIdentity=n.identityKey),!n.clientFileId&&(n.clientFileId=n.identityKey),this.publish("getMsgFile",n);break;case"644":this.publish("getMsgTyping",n);break;case"647":this.publish("getSysMsg",n);break;case"648":this.publish("getPosMsg",n);break;case"650":return void this.publish("refreshVerify",n);case"655":n.current=!0,c.publish("getLeaveMsg",n);break;case"864":this.publish("getMsgMine",n);break;case"865":n.identityKey&&(n.fileIdentity=n.identityKey),view.fileMsgs[n.clientFileId]&&(view.fileMsgs[n.clientFileId].sendStatus=4),this.publish("getMsgImg",n);break;case"866":n.identityKey&&(n.fileIdentity=n.identityKey),view.fileMsgs[n.clientFileId]&&(view.fileMsgs[n.clientFileId].sendStatus=4),this.publish("getMsgFile",n);break;case"local":case"local_upload":n.identityKey&&(n.fileIdentity=n.identityKey),n.fileIdentity||(n.fileIdentity=n.clientFileId),2==n.sendStatus||4==n.sendStatus?1==n.fileType?this.publish("getMsgImg",n):this.publish("getMsgFile",n):S.prepareUpload(n);break;case"874":this.publish("getHistory",n);break;case"876":return void this.publish("overLength",n);case"890":this.publish("inviteBook",n);break;case"892":this.publish("inviteBookOK",n);break;case"670":return void c.publish("entryCallback",n);case"673":c.publish("inviteSatisfy",n),e.store("ECHAT_inviteSatisfyId",n.mid);break;case"675":return n.staffName=n.staffName||n.staffNickName,c.publish("getLeaveReply",n),void(h=!1);case"680":c.publish("receiveURL",n);break;case"923":return void c.publish("updateVisitorInfo",{visitorId:n.newVisitorId,photo:n.metaDataInfo.photo});case"928":return;case"12001":this.publish("getMsgRobot",n);break;case"10011":c.publish("receiveVisEvt",n);break;default:return void(!i&&c.selfMsg(t,!0))}h||(this.publish("removeLoading",n),h=!0),892!=n.mt&&890!=n.mt&&866!=n.mt&&874!=n.mt&&865!=n.mt&&864!=n.mt&&642!=n.mt&&641!=n.mt&&640!=n.mt||n.tm&&(view.chat.lastMsgTM=n.tm)},this.receive=function(){},c.subscribe("restartChat",function(){view.chat.publish("__callNative",{functionName:"restartChat"})}),c.subscribe("_endConnect",function(){a({justConnect:!0})}),c.subscribe("__callNative",function(e,t,i){r(t.functionName,t.value,i)}),c.unSubscribe("__registChatAction"),c.subscribe("__registChatAction",function(e,t){r("registChatAction",t)});var p={},g=0,v=(new Date).getTime()+"";c.subscribe("__sendMessage",function(e,t,i){t.publishAck&&(t.bridgeMsgId=t.publishAck.bridgeMsgId,delete t.publishAck),t.bridgeMsgId?t.isResend=1:t.bridgeMsgId=v+ ++g,r("sendMessage",t),p[t.bridgeMsgId]=i}),c.subscribe("__loadPreHistory",function(e,t,i){r("loadPreHistory",{baseTalkId:c.lastTalkId||"",talkType:c.lastTalkType||""})}),c.subscribe("removeLoading",function(e,t,i){r("removeLoading")});var b=1;window.callEchatJsConnect=function(e){var t=l(e);"isCometdConnect"!=t.functionName&&"msgFromDB"!=t.functionName&&"msgFromUnRead"!=t.functionName&&console.log(">>>callEchatJsConnect:"+JSON.stringify(e)),t.functionName&&S[t.functionName]&&S[t.functionName](t.value)};var y,w,I={600:0,103:0,649:0,109:0,encryptVId:0},k=[],T=!1,S={preparedConnect:function(t){var i=l(t);if(window.initVisitorInfo,"0"==i.isConnect){if(T)return;T=!0,i.dataHost;var a="https://"+(i.dataHost||view.chat.json.dataHost).replace(/([^\.]+)\./,"$1api.")+"/getVisitorUnReadMsgCount?sdkAppId="+encodeURIComponent(t.appId)+"&sdkAppSecret="+encodeURIComponent(t.appSecret)+"&encryptVId="+encodeURIComponent(i.encryptVId)+"&visitorId="+encodeURIComponent(i.visitorId||""|c.visitorId)+"&metaData="+(i.metaData?encodeURIComponent(i.metaData):"");e.ajax({url:a,type:"jsonp",jsonpCB:"jsonpCallback",success:function(t){console.log(t),t&&t.unreadMsgCount>0&&(e("#restartChat").parents(".msg-info").remove(),view.chat.publish("restartChat"))},error:function(e){}})}},msgFromServer:function(e){if(e){console.log("msgFromServer",e),void 0===c.lastTalkIdFromNative&&(t.publish("__callNative",{functionName:"queryTalkIDs"}),c.lastTalkIdFromNative="");var i=l(e);i.bridgeMsgId&&p[i.bridgeMsgId]?(p[i.bridgeMsgId]&&p[i.bridgeMsgId](i),p[i.bridgeMsgId]=void 0):i.mt||i.encryptVId?(i.encryptVId&&(window.encryptVID=c.encryptVID=view.chat.encryptVID=i.encryptVId,i.companyId&&(c.companyId=view.chat.companyId=i.companyId)),i.mt&&"local"==i.mt&&i.fileType&&(1==i.fileType?i.mt="865":i.mt="866"),i.isForward=!1,c.receiveChat(i)):i.et||i.mt}},msgFromDB:function(i){console.log(i);var a=this;void 0===c.lastTalkIdFromNative&&(t.publish("__callNative",{functionName:"queryTalkIDs"}),c.lastTalkIdFromNative="");var n,s,o,r=l(i),d=[],u=("null"==r.chatDetailList?[]:r.chatDetailList)||[],f=u[u.length-1],m=f&&f.talkId||u[u.length-2]&&u[u.length-2].talkId;if("[object Array]"==Object.prototype.toString.call(u)&&0!=u.length){if(console.log("***msgFromDB***",e.extend([],u)),!c.lastTalkIdFromNative&&10009==f.mt){for(v=u.length-2;v>1;v--){if(605==u[v].mt&&u[v].talkId!=m){n={talkId:u[v].talkId,chatDetailList:u.splice(0,v+1)};break}if(10009==u[v].mt&&u[v].talkId!=m){for(var h=v-1;h>1;h--)if(655!=u[h].mt&&658!=u[h].mt&&u[h].talkId){n={talkId:u[h].talkId,chatDetailList:u.splice(0,v+1)};break}if(1!=h)break}}n&&(n.talkType=c.getTalkType(n.chatDetailList).talkType,setTimeout(function(){a.msgFromHistory(n)},1))}c.lastTalkIdFromNative||605!=f.mt&&10009!=f.mt||(f.isForward=!1,n||c.lastTalkId||(s=c.getTalkType(u),c.lastTalkId=s.talkId,c.lastTalkType=s.talkType));for(var p,g,v=0;v<u.length;v++){if(r=u[v],!o&&(o=r.talkId)&&c.hasPageHandleMsg==o)return;r.isForward="0"!=r.isForward&&r.isForward,r.mt&&644!=r.mt&&10005!=r.mt?(void 0!==I[r.mt]?(649==r.mt&&1==I[r.mt]?r.sdkChatBoxInfo&&d.push(r):(d.push(r),I[r.mt]=1),g=649==r.mt&&r.unreadMsgNumber>0):d.push(r),655!=r.mt&&658!=r.mt||(p=g),I.encryptVId=r.encryptVId||r.encryptVID||I.encryptVId):r.et&&104!=r.et&&1!=I[r.et]&&123!=r.et?void 0!==I[r.et]?(0==I[r.et]&&d.push(r),I[r.et]=1):d.push(r):"local"==r.mt&&(r.identityKey&&(r.fileIdentity=r.fileIdentity||r.identityKey),d.push(r)),r.id&&(r.id=r.mid||r.tm)}d.length&&(c.handleHistoryMsg(d),p&&10009==d[d.length-1].mt&&4==d[d.length-1].type&&setTimeout(function(){view.toggleLeaveToChat(1),e("#restartChat").parents("li").remove()},100)),c.hasPageHandleMsg=o}else c.hasPageHandleMsg=!0},allTalkIdFromHistory:function(e){if(console.log("******allTalkIdFromHistory****",e),c.lastTalkIdFromNative="",e){var t=l(e);if(t&&"null"==t[0]&&t.shift(),!t||!t[0]||1==t.length&&t[0].talkId==view.chat.talkId||t[0].talkId==c.lastTalkId)view.chat.hidePreHistory();else{for(var i=0;i<t.length;i++)t[i].talkIdType;c.lastTalkIdFromNative=t[0]&&t[0].talkId||"",view.chat.showPreHistory()}}else view.chat.hidePreHistory()},msgFromUnRead:function(e){if("null"!=e&&e){var t=l(e);if("[object Array]"==Object.prototype.toString.call(t)){console.log("*****************msgFromUnRead*handle*****************",t),k={};var i,a,n,s,o,r=t.length,u=!0;console.log(t);for(var f=0;f<r;f++)if(i=t[f].chatDetailList||[],a=i.length,o=t[f].talkId,c.lastTalkId||(c.lastTalkId=y=o,c.lastTalkType=w=t[f].lastTalkType,c.lastTalkIdLocked=!0),a){if(f==r-1){"605"!=i[a-1].mt&&"10009"!=i[a-1].mt||(c.hasPageHandleMsg?c.hasPageHandleMsg!=t[r-1].talkId&&S.msgFromDB(t[r-1]):S.msgFromDB(t[r-1]));break}k[o]={talkId:o,talkType:t[f].talkType};for(var m=0;m<i.length;m++)n=i[m],k[o],600!=n.mt&&n.mt,m>3&&600==n.mt&&(u=!1),!(u||671!=n.mt&&109!=n.et&&103!=n.et)||m>3&&600==n.mt||(u&&(12001!=n.mt||3!=n.type||204!=n.result&&205!=n.result||(u=!0)),"649"==n.mt?s=n:"600"==n.mt?(n.routeEntranceInfo=void 0,n.routeEntranceInfoString=void 0,s=null):"670"!=n.mt&&679!=n.mt&&604!=n.mt&&648!=n.mt||(s&&(s.sdkEntranceInfo=void 0),s&&(s.captChaToken=void 0)),d(n,k[o],"unread"));view.chat.showHis(k[o],o)}}else console.log("msgFromUnRead value 为Array json 格式，兼容多个会话的未读消息",t)}else console.log("msgFromUnRead length:null")},msgFromHistory:function(e){if("null"!=e&&e){var t=l(e);c.lastTalkId=y=t.talkId,c.lastTalkType=w=t.talkIdType||t.talkType,c.lastTalkIdLocked=!0,y==c.lastTalkIdFromNative&&view.chat.hidePreHistory();for(var i={},a=t.chatDetailList||[],n=0;n<a.length;n++)d(a[n],i);console.log("%cmsgFromHistory showHis%c%o","color:green","color:green",i),view.chat.showHis(i,y)}else view.chat.hidePreHistory()},prepareUpload:function(t){var i=l(t);if(view.chat.isInWorkOrder)return view.prepareAddOrderFile(i);_$(i.clientFileId)&&e("#"+i.clientFileId).remove(),content=view.getMsgSendingFile(i),view.chat.showMsg({id:i.clientFileId,f:"c",media:1,m:3==i.fileType||4==i.fileType?i.fileType:1},content)},uploadKey:function(e){S.prepareUpload({clientFileId:e})},uploadStart:function(e){var t=l(e);if(view.chat.isInWorkOrder)return view.updateOrderFile(t);var i=view.getMsgSendingFile(t),a={1:lanRes.image,2:lanRes.fileHtml,4:lanRes.video,3:lanRes.voice};view.chat.publish("__visitorStartSendMsg","["+a[t.fileType]+"]"),i&&view.chat.updateMsg(t.clientFileId,i)},uploadProgress:function(e){var t=l(e);if(view.chat.isInWorkOrder)return 2==t.sendStatus?view.successOrderFile(t):view.updateOrderFile(t);if(!view.fileMsgs[t.clientFileId]||4!=view.fileMsgs[t.clientFileId].sendStatus){var i=view.getMsgSendingFile(t);i&&view.chat.updateMsg(t.clientFileId,i)}},uploadSuccess:function(e){view.chat.isInWorkOrder&&view.successOrderFile(l(e))},updateLocalMessage:function(e){var t=l(e);view.fileMsgs[t.clientFileId]&&(view.fileMsgs[t.clientFileId]=t)},downloadProgress:function(t){var i=l(t),a=view.fileMsgs[i.clientFileId],n=_$(i.identityKey||i.fileIdentity);a&&(a.loadStatus=i.loadStatus),n&&(barInfo=e(".file-load-bar-info",n).results[0],n=e(".msg-file",n).results[0],barInfo&&(1==i.loadStatus?(barInfo.innerHTML="点击打开",view.fileMsgs[i.clientFileId]=e.extend(view.fileMsgs[i.clientFileId],t)):2==i.loadStatus?(barInfo.innerHTML=i.progress+"%",e(".file-load-progress0",n).css("width",i.progress+"%")):3==i.loadStatus?barInfo.innerHTML="点击下载":4==i.loadStatus&&(barInfo.innerHTML='<span class="red">下载失败</span>点击重新下载')),n.className="msg-file file-load-status"+i.loadStatus)},callbackOpenFile:function(e){0==l(e).status&&alert("文件不存在")}};window.echatPageService=S,c.handleHistoryMsg=function(t){console.log("handleHistoryMsg",t);var i,a,n,s=t.length,o=t[s-1],r=!1,l=!0;if(s){if(600!=o.mt&&649!=o.mt||1!=s)if(605==o.mt)r=!0;else if(10009==o.mt)r=!0;else for(a=null,i=0;i<s;i++)o=t[i],i>3&&600==o.mt&&(l=!1),600==o.mt&&(c.companyId=o.companyId,void 0===n?n=i:t[n]=o),i>3&&600==o.mt||!(l||671!=o.mt&&109!=o.et&&103!=o.et)?(t.splice(i,1),i--,s--):(l&&(12001!=o.mt||3!=o.type||204!=o.result&&205!=o.result||(l=!0)),"649"==o.mt?a=o:"600"==o.mt?(o.routeEntranceInfo=void 0,o.routeEntranceInfoString=void 0,a=null):"670"!=o.mt&&"677"!=o.mt&&"678"!=o.mt&&679!=o.mt&&604!=o.mt||(a&&(a.sdkEntranceInfo=void 0),a&&(a.captChaToken=void 0)));else{if(!o.routeEntranceInfoString)return;if(1==s)return S.msgFromServer(o)}var d,u=e.store("ECHAT_inviteSatisfyId"),f=!0;for(u==e.store("ECHAT_inviteSatisfyHandle")&&(f=!1),i=s-1;i>-1;i--)600==(o=t[i]).mt?(o.routeEntranceInfo||o.routeEntranceInfoString)&&i<s-1&&(o.routeEntranceInfo=null,o.routeEntranceInfoString=null):649==o.mt?r&&(o.sdkEntranceInfo=null,o.captChaToken=null):673==o.mt&&(f?u<o.mid?o.del=!0:d?o.del=!0:d=o:o.del=!0);var m=[];for(i=0;i<s;i++)(o=t[i]).del||(o.fromDB=!0,o.fromHistory=!0,670!=o.mt&&(12001==o.mt&&3==o.type&&i<s-2||(105==o.et||130==o.et?o.mt=864:127==o.et&&(o.mt=127),!1===o.isForward&&605!=o.mt&&10009!=o.mt&&m.push[o],"local"==o.mt||"local_upload"==o.mt?view.chat.showMsg({id:o.clientFileId,f:"c",media:1,m:3==o.fileType||4==o.fileType?o.fileType:1},view.getMsgSendingFile(o)):c.selfMsg(o))));if(r&&m.length>1){var h={data:{chatDetailList:m}};c.publish("receiveUnread",h)}}},this.getTalkType=function(e){for(var t,i=e.length-1;i>0;i--){if(t=e[i].talkId||t,604==e[i].mt||648==e[i].mt||647==e[i].mt&&5==e[i].type)return{talkType:1,talkId:t};if(12001==e[i].mt||647==e[i].mt&&10==e[i].type)return{talkType:3,talkId:t};if(647==e[i].mt&&7==e[i].type)return{talkType:2,talkId:t}}for(i=e.length-1;i>0;i--)if(649==e[i].mt&&2==e[i].status)return{talkType:2,talkId:t};return{talkType:2,talkId:t}}};ECHATObjKeyMap.cometdId=t,t.setSub("chatId"),t.setSub("cometdId"),window.initChat=function(){e.store("ECHAT_chatStatus");setTimeout(function(){t.publish("__callNative",{functionName:"pageReady",value:{history:{data:[{mt:"649"},{mt:"604"},{mt:"10001"},{mt:"10011"},{mt:"865"},{mt:"641"},{mt:"10010"},{mt:"647"},{mt:"605"},{mt:"866"},{mt:"642"},{mt:"680"},{mt:"640"},{mt:"864"},{mt:"655"},{mt:"658"},{mt:"12001"},{mt:"673"},{mt:"648"},{mt:"local"},{et:"127"},{et:"105"},{et:"130"}]}}}),window.setVisitorInfo&&t.publish("__callNative",{functionName:"getVisitorId",callback:"setVisitorInfo"}),t.publish("__callNative",{functionName:"getUnReadMessage"})})},window.retryTime=0}(EChatQuery),function(e,t){function i(t,i){if(t.isMini){var a=e("#content").height();e("#content").css("height",("close"==i?a+40:a-40)+"px")}else t.isMobile&&(e("#container").css(view.SDK?"paddingBottom":"bottom",e("#footer").height()+"px"),view.scrollToBottom&&view.scrollToBottom());view.scrollToBottom&&view.scrollToBottom()}function a(t,i,a){var n="",t=t||_$("entryForm"),s="",o="";if(a?i=t[a]:i&&(a=i.name),1!=i.nodeType){n=[],o=[];for(var r=0;r<i.length;r++)i[r].checked&&(n.push(i[r].value),o.push(e(i[r]).attr("lb")));s=e(i[0]).parents(".entry2-typeline").attr("lb"),n=n.join(","),o=o.join(",")}else if(s=e(i).attr("lb"),n=i.value.replace(/^[\s]+|[\s]+$/gi,""),"SELECT"==i.tagName)for(var l=0;l<i.length;l++)if(i[l].value==n){o=e(i[l]).text();break}return{val:n,ipt:i,label:s,labelVal:o||n}}function n(t,i,a,n){var r,l=!0,c=!1;if(1==t.nodeType?r=d[a]||d[t.type]:t.length>1&&t[0]&&(c=!0,t=t[0]),!i&&(t.className.indexOf("req")>-1||e(t).parents(".req").length)){l=!1;u="";u="text"==t.type?lanRes.inputPlease.replace("${inputName}",t.getAttribute("lb")):lanRes.inputPleaseJa2.replace("${inputName}",c?e(t).parents(".entry2-typeline").attr("lb"):t.getAttribute("lb")),_$("leave_tip_con").innerHTML=u}else if(i&&r)if(r.length&&i.length>r.length){l=!1;var u="";u="age"==a?lanRes.ageOverLengthJa.replace("${age}",t.getAttribute("lb")):t.getAttribute("lb")+lanRes.overLength,_$("leave_tip_con").innerHTML=u}else r.p&&!i.match(r.p)&&(l=!1,_$("leave_tip_con").innerHTML=r.msg||lanRes.visitor170+t.getAttribute("lb"));return view.chat.tipTimer&&clearTimeout(view.chat.tipTimer),n?(n&&n(l),l&&t.style?o():s()):l&&t.style?(t.style.borderColor="#FFFFFF",o()):(t.style.borderColor="#FF0000",s()),l}function s(t,i){view.chat.tipTimer&&clearTimeout(view.chat.tipTimer),t&&(_$("leave_tip_con").innerHTML=t),_$("leave_tip").className="leave-tip leave-tip-"+(i||"warn"),view.chat.tipTimer=setTimeout(function(){e("#leave_tip").addClass("tiphide")},3e3)}function o(){view.chat.tipTimer&&clearTimeout(view.chat.tipTimer),e("#leave_tip").addClass("tiphide")}function r(e){for(var t=!0,i=0;i<e.length&&(t=t&&"1"==e[i].configInline);i++);return t?"1":"0"}window._$=function(e){return e&&t.getElementById(e)},window._$s=function(e){return t.getElementsByTagName(e)},window.$=e,window.locationBase=window.locationBase||"",window.onerror=function(e){};var l,d={};String.prototype.analyDomain=function(e){var t=this.toString(),i=[],a=t.indexOf(e);return a>=0?(i[0]=t.substring(0,a),t.substring(a+1)&&(i[1]=t.substring(a+1))):i[0]=t,i};var c=function(){UTIL.call(this),InputHandle.call(this),this.talkId="",this.KEY="chatId",ECHATObjKeyMap[this.KEY]=this,this.setSub(this.KEY),this.setSub("cometdId"),this.setSub("viewId"),this.errorList={},this.regFace=new RegExp("\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]|[#-®]|[‼-㊙]","g"),this.regEmo=new RegExp("\\[#[a-z0-9A-Z]+(_[a-z0-9A-Z]+)?#\\]","g"),this.unescapeSend=new RegExp("<d>","g");this.isMobile=2==this.Device.media||view.SDK,this.isIOS=this.Browser.isIOS,this.isMini=!this.isMobile&&2==view.windowType,this.disableSoundTip=1==this.queryParams.disableSoundTip||view.SDKNative,this.plainText=!0,this.editorType=1,this.hasStorage=function(){try{if(!window.localStorage)return!1;window.localStorage.setItem("echt_test_storage","ok");if(!window.localStorage.getItem("echt_test_storage"))return!1}catch(e){return!1}return!0}(),this.hasStorage&&(this.tempReferrer=this.hasStorage?window.localStorage.getItem("echat_temp_referrer"):"",window.localStorage.setItem("echat_temp_referrer","")),"https:"==location.protocol||window.SDK?this.needHttps="https:":this.needHttps="",this.initVisitor(),this.init(),this.initBridge(),this.postMessage("miniReady"),this.setChatbox=function(t,i){if(i){var a="ECHAT_"+view.chat.companyId+"_"+t,n=JSON.stringify({chatStaffBackColor:i.chatStaffBackColor,chatStaffTxtColor:i.chatStaffTxtColor,chatVisitorBackColor:i.chatVisitorBackColor,chatVisitorTxtColor:i.chatVisitorTxtColor,sysMsgBackground:i.sysMsgBackground,sysMsgFontColor:i.sysMsgFontColor});i&&e.store(a,n,{path:"/",expires:365}),this.isIOS&&2==view.windowType&&this.postMessage({type:"updateLocalChatbox",key:a,value:n})}},this.getChatbox=function(t){var i=e.store("ECHAT_"+view.chat.companyId+"_"+t);return i&&JSON.parse(i)},this.addEchatInnerFrameParam=function(e){if(e){if(-1!=e.indexOf("&echatInnerFrame=1")||-1!=e.indexOf("?echatInnerFrame=1"))return e;var t=e.split("#"),i=t[1]||"",a=t[0];return a+((-1==a.indexOf("?")?0:1)?"&":"?")+"echatInnerFrame=1"+(i?"#":"")+i}},this.addFixedParam=function(e){if(!e||!view.echatSourceTagEnable||e.match(/^(mailto|tel|javascript):/i))return e||"";var t,i=new RegExp("(^|&)echatSourceTag=([^&]*)(&|$)","i"),a=e.analyDomain("?"),n="echatSourceTag="+(this.echatSourceTag||"");return t=(a[1]||a[0]).analyDomain("#"),t[0].match(i)?e:e=a.length>1?a[0]+"?"+t[0]+"&"+n+(t.length>1?"#"+t[1]:""):t[0]+"?"+n+(t.length>1?"#"+t[1]:"")}};c.prototype={replaceHtml:function(e){return e&&(e=e.replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[face]")),e},initBridge:function(){var i=this,a=i.replaceHtml,n=new function(e,t,i){if(e&&i&&"function"==typeof i){var a=window,n=e;return a.addEventListener?(a.addEventListener("message",function(e){i(e,e.data)}),this.send=function(e){if(e&&t&&2==view.windowType&&window.top!=self)try{n.postMessage(e,t||"*")}catch(e){console.log(e)}}):this.send=function(){console.log("不支持 postMessage")},this}}(parent,i.queryParams.fromhost||(i.tempReferrer||t.referrer||"").split("/").slice(0,3).join("/"),function(e,t){i.publish("getCrossMessage",e)});this.subscribe("__chatStatus",function(a,s){i.outerChatStatus=s,n.send({act:100,eventAction:"chatStatus",eventLabel:s||""}),e.store("ECHAT_chatStatus",s);var o=t.getElementsByTagName("body")[0],r=o.className;r=r.replace(/chatstatus-[^\s]+/gi,""),s&&(r+=" chatstatus-"+s),o.className=r}),this.subscribe("__staffStatus",function(e,t){n.send({act:100,eventAction:"staffStatus",eventLabel:t||""})}),this.subscribe("__chatStart",function(e,t){n.send({act:200,eventAction:"Served by Agent",eventLabel:t||""})}),this.subscribe("__chatQueue",function(e,t){n.send({act:100,eventAction:"queuePostion",eventLabel:t||""})}),this.subscribe("__chatStaffInfo",function(e,t){n.send({act:100,eventAction:"chatStaffInfo",eventLabel:JSON.stringify(t)})}),this.subscribe("__newMsg",function(e,t){var i=t.m;"s"==t.f&&t.c&&n.send({act:100,eventAction:"newMsg",eventLabel:0==i?a(t.c):1==i?"[file]":2==i?"[image]":""}),"r"==t.f&&(t.answer||t.c)&&n.send({act:100,eventAction:"newMsg",eventLabel:a(t.answer||t.c)})}),this.subscribe("__newSysMsg",function(e,t){var i=t.m;t.c&&n.send({act:100,eventAction:"newSysMsg",eventLabel:0==i?a(t.c):1==i?"[file]":2==i?"[image]":""})});var s=["","angry","unsatisfied","ok","satisfied","perfect"];this.subscribe("__evaluate",function(e,t){n.send({act:100,eventAction:"visitorEvaluate",eventLabel:t||""});var a=t.split("-");0==a[0]?n.send({act:200,eventAction:"Chat_Evaluate_Cancel",eventLabel:1==a[1]?"chatting":"end"}):n.send({act:200,eventAction:"Chat_Evaluate_"+s[i.evaluateScore-0],eventLabel:1==a[1]?"chatting":"end"})}),this.subscribe("__evaluateComment",function(e,t){n.send({act:200,eventAction:"Chat_Comment_submit",eventLabel:t.chatting?"chatting":"end"})}),this.subscribe("__visitorHide",function(e,t){n.send({act:100,eventAction:"visitorHide",eventLabel:t||""})})},initVisitor:function(){d={email:{p:/^[\w\d_\-\.]+@.+[\.].+/gi,msg:lanRes.invildEmail,length:50},phone:{p:/^[0-9\-]{0,20}$/,msg:lanRes.invildPhone,length:20},age:{p:/^[1-9][\d]{0,2}$/gi,msg:lanRes.invildAge,length:3},qq:{p:/^[1-9][\d]+$/gi,msg:lanRes.invildQQ,length:50},date:{p:/^[\d]{4}[-\/][\d]{2}[-\/][\d]{1,2}/gi,msg:lanRes.invildDate,length:50},address:{length:255},name:{length:50},wechat:{length:50},nickName:{length:50},birthday:{length:20},content:{length:1e3},memo:{length:255},textarea:{length:500},text:{length:100},number:{p:/^\-?\d*$/,length:50}},this.dataHost=window.dataHost,e("#inputLengthTip").html(lanRes.inputLengthTip1+" 30 "+lanRes.inputLengthTip2),view.SDK||(window.chatVisitorId&&e.store("ECHAT_"+window.companyId+"_chatVisitorId",chatVisitorId),window.encryptVID&&(e.store("ECHAT_"+window.companyId+"_encryptVID",encryptVID),this.encryptVID=encryptVID))},init:function(){function a(t,i){o.oldBodyEnterText;var a=o.getInput(!1),n=t.currentTarget||t.target||{},s=n.innerHTML||"";if(t.clipboardData){t.clipboardData.getData("text");t.clipboardData.items[0].getAsString(function(t){var r=i-a.length;(a=o.getInput(!1)).length>=i&&(n.innerHTML=s+t.substr(0,r),e("#inputLengthTip").html(lanRes.inputLengthTip1+" 0 "+lanRes.inputLengthTip2))})}else setTimeout(function(){(a=o.getInput(!1)).length>i?n.innerHTML=s:o.oldBodyEnterText=a,e("#inputLengthTip").html(lanRes.inputLengthTip1+"&nbsp;"+(i-o.oldBodyEnterText.length)+"&nbsp;"+lanRes.inputLengthTip2)})}view.initViewEvent(this);var o=this;if(o.showTip=s,o.checkIpt=n,o.defaultVisitorImg=locationBase+"/res/imgs/visitor.png",o.defaultStaffImg=locationBase+"/res/imgs/staff.png",this.paramChat={companyId:o.companyId,visitorId:o.visitorId,firstTitle:o.queryParams.firstTitle||"",firstUrl:o.queryParams.firstUrl||"",referrer:o.queryParams.referrer||"",chatPage:o.queryParams.enterUrl||o.tempReferrer||t.referrer||"",chatPageTitle:o.queryParams.enterTitle||"",metaData:o.queryParams.metadata||"",myData:o.queryParams.myData||"",info:o.queryParams.info||"",echatTag:o.queryParams.echattag||"",lan:window.lanName,visEvt:o.queryParams.visEvt||"",eventId:o.queryParams.eventId||"",media:view.windowType||"",staffId:this.staffId||"",staffName:this.staffName||"",talkId:this.talkId||"",multipleFile:o.queryParams.multipleFile||0},window.initVisitorInfo){for(var l in window.initVisitorInfo)this.paramChat[l]=window.initVisitorInfo[l];try{var d="string"==typeof window.initVisitorInfo.visEvt?window.initVisitorInfo.visEvt:JSON.parse(window.initVisitorInfo.visEvt);d&&d.eventId&&(this.paramChat.eventId=d.eventId)}catch(e){}}this.subscribe("setConfig",function(t,i){var a;o.isInRobot?a=view.SDK?i.robotSdkChatBox:o.isMobile?i.robotPhoneChatBox:2==view.windowType?i.robotSmallChatBox:i.robotPCChatBox:(i.chatBoxInfo||i.chatSmallBoxInfo||i.mobileChatBoxInfo||i.sdkChatBoxInfo,a=view.SDK?i.sdkChatBoxInfo:o.isMobile?i.mobileChatBoxInfo:2==view.windowType?i.chatSmallBoxInfo:i.chatBoxInfo),view.echatSourceTagEnable=i.echatSourceTagEnable?parseInt(i.echatSourceTagEnable||0):0,view.hasSetAD&&(view.hasSetAD=!1,view.canSetAD=1),a&&(a.chatBoxTitle&&(view.pageTitle=a.chatBoxTitle,view.titles&&(view.titles[1]=a.chatBoxTitle),o.changeDocTitle(a.chatBoxTitle),view.setDocumentTitle&&view.setDocumentTitle("c")),o.defaultStaffImg=a.defaultStaffImg||o.defaultStaffImg,o.defaultVisitorImg=a.defaultVisitorImg||o.defaultVisitorImg,o.needHttps&&(o.defaultStaffImg=o.defaultStaffImg.replace(/^http:/,o.needHttps),o.defaultVisitorImg=o.defaultVisitorImg.replace(/^http:/,o.needHttps)),o.busyCanSend="1"!=a.busyNotAllowSendStatus,e("#busyTip").html((a.busyNotAllowTips||"").replace(/(<p>|<\/p>)/gi,"")),e("#busyTipLine").addClass("hide").hide(),view.setConfig(o,i,a),Number(a.toolEmoji)?e(".menu-emo").removeClass("style-tool-hide"):e(".menu-emo").addClass("style-tool-hide"),Number(a.toolFile)?e(".menu-file").removeClass("style-tool-hide"):e(".menu-file").addClass("style-tool-hide"),Number(a.toolSatisfaction)?e(".menu-satisfy").removeClass("style-tool-hide"):e(".menu-satisfy").addClass("style-tool-hide"),Number(a.toolScreenshot)?e(".menu-capture").removeClass("style-tool-hide"):e(".menu-capture").addClass("style-tool-hide"),Number(a.toolTelephone)?e(".menu-phone").removeClass("style-tool-hide"):e(".menu-phone").addClass("style-tool-hide")),o.toolScreenshot=Number(a?a.toolScreenshot:0)||0,o.leaveWordInfo=i.leaveWordInfo||i.mobileLeaveWordInfo||o.leaveWordInfo}),o.subscribe("sendLocationInfo",function(e,t){o.showLocation(t)}),o.leaveMsgMap={},o.subscribe("getLeaveMsg",function(i,a,n){a.realTalkId||(a.realTalkId=a.newsMsgId,a.fromHistory&&!a.current||(a.talkId=o.talkId||a.newsMsgId+"leave"));var s='<li class="clearfix '+(1==a.read?"":a.current?"fold":"")+'" talkid="'+a.talkId+'" id="msg'+a.tm+'"><div class="msg-leave" k="'+a.signature+'"><div class="msg-leave-title"><i class="msg-leave-i"></i><span class="msg-leave-t">'+((a.staffNickName?'<span class="color0">'+a.staffNickName+"&nbsp;</span>":lanRes.serviceStaff)+(4==a.chatInfoType?lanRes.staffLeave:lanRes.leaveStaffReply))+'</span></div><div class="msg-leave-con" ><div class="msg-leave-content">'+o.HTMLDecode(o.filterEmo(a.brief))+'</div><div class="msg-leave-dot">...</div><div class="msg-leave-link color0">'+lanRes.viewAll+"</div></div></div></li>",r=t.createElement("ul");r.innerHTML='<li class="clearfix" ><div class="color1 tc">'+o.getTimeStr(a.tm)+"</div></li>"+s;for(var l,d=this.getListMsgEl(a.talkId,a.tm,!!a.current),c=r.childNodes,u=0;l=c[u++];)1==l.nodeType&&(l=l.cloneNode(!0),d.appendChild(l));c=null,r=null,view.scrollToBottom(null,{transitionDuration:100,timeout:100}),a.current&&(a.f=n?"r":"s",a.c=a.brief,delete a.content,delete a.current,o.pushHistory(a),3==a.chatInfoType&&e(d).addClass("new-leave"),d=null),o.leaveMsgMap[a.signature]=a}),o.subscribe("overLength",function(){s(lanRes.overLength)});view.chat.Browser.isAndroid&&navigator.userAgent.indexOf("baiduboxapp");e("#enter_btn").on(o.isMobile?"touchend":"click",function(e){o.publish("_sendMsg");try{3==o.editorType?window.getSelection().empty():2==o.editorType&&o.win.getSelection().empty()}catch(e){}o.isMobile&&"qq"!=o.Browser.browser&&"weixin"!=o.Browser.browser&&"uc"!=o.Browser.browser&&(view.hideMenus(),o.getInputDocBody().blur(),view.inputBlur&&view.inputBlur(e))}),o.loadConsole=function(e){o.loadConsole=void 0,o.addJS(__uri("/visitor/common/lib/vconsole.js"),function(e){var t=window.console;new VConsole;t.log("location.href",location.href),t.log("msg600::",o.msg600),t.log("msg649::",o.msg649),o.subscribe("echatLog",function(e,t,i){window.console.log(t,i)})})},o.visitorCloseFunc=function(t){function i(){o.visitorClose=!0,o.publish("_endChat"),o.leaveAndClose?(o.publish("_endConnect"),o.publish("_closeWin")):o.isInWorkOrder?(o.publish("_endConnect"),o.publish("_closeWin"),e("#loading").show()):o.hasEntryOrCode||"0"==o.queryParams.autoChat?(o.publish("entryCallback",{success:!0}),o.publish("_endConnect"),o.publish("chatEnded",{closeReason:1}),o.publish("__visitorCloseCallback",{type:"close",memo:"信息收集/验证码,访客确认关闭"}),o.publish("__chatStatus","end-1-0"),o.publish("_closeWin")):ECHATObjKeyMap.cometdId.waitForRouterSelect?(o.publish("_endConnect"),o.publish("__visitorCloseCallback",{type:"close",memo:"咨询入口选择时,访客确认关闭"}),o.publish("__chatStatus","end-1-0"),o.publish("_closeWin")):o.outerChatStatus&&o.outerChatStatus.match(/waiting|chatting|leaveToService/)?o.publish("__visitorCloseCallback",{type:"wait",memo:"等待H5发送结束指令,Native将根据结束状态决定关闭view"}):(o.publish("__visitorCloseCallback",{type:"close",memo:"根据状态发现对话没有建立,访客确认关闭"}),o.publish("__chatStatus","end-1-0"))}if(o.visitorClose=!0,!1!==o.chatting&&"disconnected"!=EChatQuery.cometd.getStatus()||o.isInWorkOrder&&!(o.isInWorkOrder&&o.msg649.unreadMsgNumber&&parseInt(o.msg649.unreadMsgNumber))){if(1===t)return i();o.showDialog({tip:o.isInWorkOrder?lanRes.visitor188:lanRes.closeTip,ok:i,cancel:function(){o.visitorClose=!1,o.publish("__visitorCloseCallback",{type:"cancel",memo:"访客取消关闭"})}})}else o.publish("__visitorCloseCallback",{type:"close",memo:"对话已经结束/连接已经断开,可直接销毁"}),o.publish("_closeWin")},e(".action-close").on("click",o.visitorCloseFunc),e("#pre_his").on("click",function(){o.loadHistory()}),e("#inputPlaceholder").on("mouseover touchstart",function(){e(this).addClass("hide")}),this.subscribe("_endChat",function(e,t){o.publish("sendVisitorEvent",{et:107},function(){}),o.postMessage(3)}),e("#changelang").on("change",function(e){switch(parseInt(this.value)){case 0:lanResName="zhcn";break;case 1:lanResName="enus";break;case 2:lanResName="jp";break;default:lanResName="zhcn"}var i=t.createElement("script"),a=_$("langScript"),n=a.parentNode;i.id="langScript",i.src=supportLang[lanResName],n.replaceChild(i,a)}),e(t).on("click",".resend",function(){if(!view.handleNetwok||!view.handleNetwok()){var t=e(this).attr("dataid"),i=o.errorList[t];if(i.id=t,i.m=i.m||0,i.f=i.f||"c",i.c=i.c||i.content,!1!==o.chatting&&void 0!==o.chatting)if(o.isInRobot&&7==i.m)o.showTip(lanRes.visitor171);else{var a=_$(t);(a=a.previousElementSibling)&&a.childNodes[0]&&-1!=(a.childNodes[0].className+"").indexOf("color1")&&e(a).remove(),e("#"+t).remove(),o.sendToServer(i)}else 7==i.m?o.showTip(lanRes.visitor171):o.showTip(lanRes.visitor172)}}).on("click",".btn-restart",function(){view.handleNetwok&&view.handleNetwok()||("restartChat"==e(this).attr("id")&&setTimeout(function(){o.publish("restartChat")},10),e(".btn-restart").removeAttr("id").removeClass("btn-restart"),e(this).removeAttr("id").removeClass("btn-restart").text(lanRes.chatContinued))}),this.subscribe("displayRouterInfo",function(t,i){var a,n=i.routeEntranceInfo;a="string"==typeof n.entranceDetails?JSON.parse(n.entranceDetails):n.entranceDetails,n.chatBoxTitle?(view.pageTitle=n.chatBoxTitle,o.changeDocTitle(n.chatBoxTitle),o.publish("__setTitle",n.chatBoxTitle)):o.publish("__setTitle",lanRes.onlineService);var s=n.routeStatusList,r={};if(s&&s.length)for(var l=0;l<s.length;l++)r[s[l].routeId]=2!=s[l].routeStatus;for(var d='<div id="routerTitle" class="router-title '+(n.title?"":"router-hide")+'">'+n.title+'</div><div id="routerList" class="router-list"><ul class="clearfix">',c=0,u=n.lines,f=n.chosenColor||"#0da7db",m=0;m<a.length;m++){var h=a[m].routeId;if(h){c++,r[h]||(a[m].icon=a[m].offlineIcon||a[m].icon,a[m].content=a[m].offlineContent||a[m].content);var p=c%u==0;o.needHttps&&a[m].icon&&(a[m].icon=a[m].icon.replace(/^http:/,o.needHttps));d+='<li class="router-item router-item-content'+(a[m].icon&&!a[m].content?1:a[m].icon&&a[m].content?2:!a[m].icon&&a[m].content?3:a[m].icon||a[m].content?"":3)+'" data="'+h+'" dataindex="'+m+'" '+(p?'style="border-right:none;"':"")+'><div class="router-item-content"><div class="router-item-icon '+(a[m].icon?"":"router-hide")+'">'+(a[m].icon?'<img onload="view.checkImg&&view.checkImg(this)" src="'+a[m].icon+'"/>':"")+"</div>"+(1==view.windowType?'<div class="router-item-text '+(a[m].content?"":"router-hide")+'">'+(a[m].content?'<div class="router-item-text-bg" style="background:'+f+';"></div><div class="router-item-text-tx">'+a[m].content+"</div>":"")+"</div>":"")+'</div><div class="router-item-theme">'+a[m].theme+"</div></li>"}}if(d+="</ul></div>",o.publish("removeLoading"),0==c)ECHATObjKeyMap.cometdId.waitForRouterSelect=!1,e("#router").hide();else{e("#loading").hide(),e("#mask").show();var g,v=150*u;e("#router").addClass("router-line"+u).html(d).css({width:view.px2rem?view.px2rem(v):v+"px",marginLeft:view.px2rem?view.px2rem(-v/2):-v/2+"px"}).show().removeClass("slideUp"),o.isMobile||e(".router-item").on("mouseover touchstart",function(t){e(this).addClass("hover"),e(".router-item-theme",this).css({background:f,color:"#FFF"})}).on("mouseout touchend",function(t){e(this).removeClass("hover"),e(".router-item-theme",this).css({background:"#fff",color:"#323232"})}),e(".router-item").off("click").on("click",function(t){var i=e(this).attr("dataindex"),s=e(this).attr("data");s&&a[i]&&a[i].routeId==s&&(o.routeId=s,o.routeEntranceTheme=a[i].theme,o.paramChat.echatTag=a[i].routeEntranceEchatTag||o.routeEntranceTheme,e("#loading").show(),o.publish("routerSelect"),o.publish("toSetID"),e("#router").hide(),e("#mask").hide(),ECHATObjKeyMap.cometdId.waitForRouterSelect=!1,a=null,n=null)});view.handleRouterSelect&&view.handleRouterSelect(c,u)||(g=e("#router").height()||200,e("#router").css({marginTop:-g/2+"px"}))}}),this.subscribe("getLeaveReply",function(e,t){t.content&&o._getMsg(t,0,t.content),928!=t.from&&o.publish("toSetID")}),this.subscribe("getNewUnreadMsgCount",function(e,t){(500002==t.platformId||500003==t.platformId||20==t.platformId)&&o.showTip("收到685"+t.lastMsgContent),view.handleNewUnreadMsgCount&&view.handleNewUnreadMsgCount(t),o.sendMsgboxUnread.send(t)});var c;this.subscribe("updateVisitorInfo",function(t,i){var a,n;o.visitorId!=i.visitorId&&(a="CHAT_HIS_"+window.companyId+"_"+i.visitorId,o.historyKey&&a!=o.historyKey&&(o.historyKey=a,o.hasStorage&&(n=window.localStorage.getItem(a))&&(window.localStorage.removeItem(o.historyKey),window.localStorage.setItem(a,n))),o.visitorId=i.visitorId),i.photo&&o.visitorImg!=i.photo&&(e(".avatar-icon-img").each(function(e){-1!=this.parentNode.className.indexOf("fr")&&(this.src=i.photo)}),o.visitorImg=i.photo)}),this.uploadUtil=function(){var e={},t=1,i=[];return e.setUploadService=function(e){t=(i=e)[0].uploadServiceType||1},e.getUploadServiceType=function(e){return t=i[0].uploadServiceType},e.getNextUploadType=function(e){var a,n=i.length,s=i[n-1].uploadServiceType;if((e=e||t)==s)return!1;for(var o=0;o<n;o++){if(a)return i[o].uploadServiceType;i[o].uploadServiceType==e&&(a=o+1)}return!1},e.getLastUploadType=function(){return i[i.length-1].uploadServiceType},e}(),this.subscribe("setVisitorInfo",function(t,i){if(e("#leaveDisabled").hide(),o.msg600=i,o.visitorImg=i.photo,o.visitorId=i.visitorId,o.companyId=i.companyId,o.appId=i.appId,o.appSecrect=i.appSecrect,window.encryptVID=i.encryptVID,o.isVip=1==i.visitorType,o.visitorType=i.visitorType,i.uploadFileSize&&(o.uploadFileSize=i.uploadFileSize||5242880,o.uploadFileType=i.uploadFileType),o.qiniuDomain=i.qiniuBucketDomain,o.qiniuHttpsDomain=i.qiniuBucketHttpsDomain,o.platformName=i.platformName,o.platformLogo=i.platformLogo,o.companyName=i.companyName,o.companyLogo=i.companyLogo,o.companyMobileSite=i.companyMobileSite,o.companyWebSite=i.companyWebSite,o.sendMsgboxUnread.init(function(e){view.__nativeAPI&&view.__nativeAPI("platformNewMsg",o.formatUnreadMsg.call(o,e)),(500002==e.platformId||500003==e.platformId)&&o.showTip("platformNewMsg"+JSON.stringify(e))}),o.publish("initPageStatus",{companyId:o.companyId,companyName:o.companyName}),first600=1,o.apiServerDomain=i.apiServerDomain,i.fileUploadInfos&&(o.uploadUtil.setUploadService(i.fileUploadInfos),o.fileUploadInfos=function(){i.fileUploadInfos=i.fileUploadInfos;for(var e={},t=0;t<i.fileUploadInfos.length;t++)e["uploadServiceType"+i.fileUploadInfos[t].uploadServiceType]=i.fileUploadInfos[t];return e}()),o.historyKey||(o.historyKey="CHAT_HIS_"+window.companyId+"_"+i.visitorId,o.hasPreHis=o.checkHistory(),o.isIOS&&2==view.windowType&&o.postMessage({type:"initLocalHistory",key:o.historyKey})),1==i.limitVisitorInputContentLengthEnable&&!c){var n=o.inputMaxLength=i.visitorInputContentMaxLength;c=!c,e("#inputLengthTip").html(lanRes.inputLengthTip1+n+lanRes.inputLengthTip2),e("#inputLengthTip").show(),setTimeout(function(){var e=o.getInputDoc().getElementsByTagName("body")[0];e.addEventListener?(e.addEventListener("keydown",function(e){a(e,n)}),e.addEventListener("paste",function(e){a(e,n)})):(e.attachEvent("onkeydown",function(e){a(e,n)}),e.attachEvent("onpaste",function(e){a(e,n)}))},200)}}),o.oldBodyEnterText="",this.subscribe("setChatParam",function(e,t){o.paramChat.country=t.country||"",o.paramChat.province=t.province||"",o.paramChat.city=t.city||"",o.paramChat.searcher=t.searcher||"",o.paramChat.keyword=t.keyword||"",o.paramChat.firstUrl=o.paramChat.firstUrl||t.firstUrl,o.paramChat.referrer=o.paramChat.referrer||t.referrer,o.paramChat.companyId=o.companyId,o.paramChat.visitorId=o.visitorId,o.paramChat.osName=o.queryParams.osName,view.canSetAD++,view.setAD&&view.setAD()}),this.subscribe("setRestartTag",function(t,i){o.restartParam={nonce:i.nonce,reChatTag:i.reChatTag},i.talkId&&!o.talkId&&i.notStore&&(o.talkId=i.talkId),e.store("ECHAT_talkId",i.talkId),o.hasPreHis=o.checkHistory(),view.noScrollBottom=!1}),o.isAutoPop="1"==o.queryParams.autoPop,this.subscribe("handshakeOk",function(t,i){o.robotToHumanKey=null,e("#restartChat").text(lanRes.chatContinued),e(".btn-restart").removeAttr("id").removeClass("btn-restart")}),this.subscribe("changeToPlatform",function(e,t){o.platformData=t,o.paramChat.echatTag=t.echatTag}),this.subscribe("toSetID",function(t,i){function a(e){return e?e.replace(/<(?:.|\s)*?>/gi,""):e}o.talkId="",o.no103=!1;var n=n;if(o.companyOff=n,o.publish("__chatStatus","registerChat"),view.SDKNative){s={et:109},o.routeId&&(s.routeId=o.routeId,s.routeEntranceTheme=o.routeEntranceTheme,s.echatTag=o.paramChat.echatTag),o.robotToHumanKey&&(s.robotToHumanKey=o.robotToHumanKey);return(r=o.data109)?(r.visEvt&&(s.visEvt=r.visEvt),r.routeId&&(s.routeId=r.routeId),r.routeEntranceTheme&&(s.routeEntranceTheme=r.routeEntranceTheme)):o.data109=s,void o.publish("__registChatAction",s)}var s;s={et:109,windowType:view.windowType,companyId:o.companyId,page:o.paramChat.chatPage||n,title:o.paramChat.chatPageTitle||n,firstEnterUrl:o.paramChat.firstUrl||n,firstEnterTitle:o.paramChat.firstTitle||n,referrer:o.paramChat.referrer||n,media:o.Device.media,browserName:o.Browser.browser,browserVersion:o.Browser.version,osName:o.queryParams.osName||o.Device.OS.toLowerCase(),screenResolution:window.screen.width+"x"+window.screen.height,echatTag:o.paramChat.echatTag||n,routerId:o.queryParams.routerid||n,departmentId:o.queryParams.departmentid||n,routeEntranceId:o.queryParams.routeentranceid||n,styleId:o.queryParams.styleid||n,multipleFile:o.queryParams.multiplefile||0},view.SDK&&(s.webSdk=1),o.robotToHumanKey&&(s.robotToHumanKey=o.robotToHumanKey),"1"==o.queryParams.autoPop&&o.isAutoPop&&(s.isAutoPop=1),"1"==o.queryParams.acceptInvite&&(s.acceptInvite=1);var r=o.data109;o.data109=s,r&&(r.visEvt&&(s.visEvt=r.visEvt),r.routeId&&(s.routeId=r.routeId),r.routeEntranceTheme&&(s.routeEntranceTheme=r.routeEntranceTheme)),o.routeId&&(s.routeId=o.routeId,s.routeEntranceTheme=o.routeEntranceTheme);var l=o.queryParams.visitorid;if(l&&(s.visitorId=l,s.chatToken=o.queryParams.chattoken,s.tm=o.queryParams.tm,o.chatToken=s.chatToken),o.restartParam&&e.extend(s,o.restartParam),1==o.toLeaveWord&&(s.toLeaveWord=1,o.toLeaveWord=n),o.staffChatNeedConnect=!1,window.isInPlatform&&o.platformData&&(s.companyId=o.platformData.platfromId,s.routeId=o.platformData.routeId,s.echatTag=o.platformData.echatTag,s.toPlatformToken=o.platformData.toPlatformToken),o.paramChat.visEvt){var d=JSON.parse(o.paramChat.visEvt);s.visEvt={customizeMsgType:2,dedup:1,eventId:d.eventId,title:a(d.title),content:d.content,imageUrl:d.imageUrl,url:d.url,urlForVisitor:d.urlForVisitor,urlForStaff:d.urlForStaff,memo:a(d.memo),visibility:d.visibility,urlEnableForVisitor:d.urlEnableForVisitor,closeURLPage:d.closeURLPage},o.initVisEvt=o.paramChat.visEvt,o.paramChat.visEvt=null,delete o.paramChat.visEvt}o.publish("visitorCommonEvent",s),o.postMessage(2)}),"1"!=o.queryParams.autoPop&&"1"!=o.queryParams.acceptInvite||this.subscribe("_firstSendMsg",function(e,t){"0"==o.queryParams.autoChat&&(delete o.queryParams.autoChat,o.publish("toRegisterChat",t),delete o.queryParams.autoPop,o.isAutoPop=!1),"1"==o.queryParams.acceptInvite&&(o.queryParams.acceptInvite=void 0,delete o.queryParams.acceptInvite),this.unSubscribe("_firstSendMsg")}),this.subscribe("toRegisterChat",function(e,t){if("0"!=o.queryParams.autoChat&&(o.talkId="",!o.no103)){if(o.no103=!0,view.SDKNative)return a={et:103},o.eventId&&(a.eventId=o.eventId),console.log("__registChatAction",new Date),void o.publish("__registChatAction",a);var i=i,a={et:103,windowType:view.windowType,page:o.paramChat.chatPage||i,title:o.paramChat.chatPageTitle||i,firstEnterUrl:o.paramChat.firstUrl||i,firstEnterTitle:o.paramChat.firstTitle||i,referrer:o.paramChat.referrer||i,media:o.Device.media,browserName:o.Browser.browser,browserVersion:o.Browser.version,osName:o.queryParams.osName||o.Device.OS,screenResolution:window.screen.width+"x"+window.screen.height,echatTag:o.paramChat.echatTag||i};t&&t.code&&(a.captcha=t.code),"1"==o.queryParams.acceptInvite&&(a.acceptInvite=1),o.routeId&&(a.routeId=o.routeId,a.routeEntranceTheme=o.routeEntranceTheme),o.eventId&&(a.eventId=o.eventId),"1"==o.queryParams.autoPop&&(a.isAutoPop=1,t&&t.c&&(a.visitorWords=t.c)),o.publish("visitorCommonEvent",a,function(e){!0===e.successful&&o.publish("_pushVisitorEvent")})}}),this.subscribe("removeLoading",function(t,i){o.wait874List||(e("#loading").hide(),window.resizeFunc&&window.resizeFunc(),o.hasEntryOrCode||(e("#mask").hide(),e("#verify").hide()),e(".btn-close").removeClass("hide"),i&&o.initQcode())}),this.initQcode=function(){(!0!==o.companyOff&&!o.hasLeaveMsg||o.isInRobot)&&(o.isMobile||(o.showQcode?(e(".btn-qcode").removeClass("hide"),_$("qcode_img").setAttribute("loaded",""),_$("qcode_img").removeAttribute("loaded")):o.showQcode=o.toShowQcode()))},this.getLeaveConfig=function(e,t){var i=e.offlineBoxInfo||e.offlineSmallBoxInfo||e.mobileOfflineBoxInfo||e.sdkOfflineBoxInfo;return!i&&o.msg649&&(i=o.msg649.offlineBoxInfo||o.msg649.offlineSmallBoxInfo||o.msg649.mobileOfflineBoxInfo||o.msg649.sdkOfflineBoxInfo),i},this.subscribe("toLeavePage",function(i,a,n){function r(){l&&1==c.enableThirdPartyParams&&c.thirdPartyParams&&(l=function(e,t,i){for(var a="",n=e.split("#"),s=n[1]||"",o=n[0],r=-1==o.indexOf("?")?0:1,l=0,d=t.length;l<d;l++){var c=t[l].paramName;"metaData"!=c&&"metadata"!=c||(c="metaData"),i[c]&&(a+=(0!=r?"&":"?")+c+"="+encodeURIComponent(i[c]||""),r++)}return o+a+(s?"#"+s:"")}(l,c.thirdPartyParams,o.paramChat)),e("body").html(""),view.SDK?view.__nativeAPI("jumpToUrl",l):location.href=l}o.companyOff=!0;var l,d=!1,c=o.getLeaveConfig(a),u=!1;if(o.leaveAndClose){d=!1;var f="msg"+(p=(new Date).getTime()),m={t:(g=o.checkHistoryTime(p))?(new Date).format("hh:mm"):void 0,tm:p,mt:864,f:"c",m:0,hide:!0,c:o.entryVisitorMsg,id:f};o.entryVisitorMsg&&o.sendToServer(m),o.publish("__chatStatus","leaveToService");var h=e.extend({},m);h.c=o.entryLeaveContent,o.sendToServer(h,void 0,function(){o.visitorClose=!0,h.c.trim()&&s(lanRes.leavelSuc.alt,"ok"),o.publish("sendVisitorEvent",{et:107}),setTimeout(function(){o.leaveAndClose=!1,o.entryLeaveContent=void 0},2e3)}),o.entryVisitorMsg=null}else if(c&&1==c.enable){if(n||(d=o.showEntryAndCode(a,!1)),d||o.publish("__chatStatus","leaveToService"),o.leaveAndClose&&e("#staffName").html("<span>"+lanRes.leaveWord+"</span>"),view.hideStaffInfo&&view.hideStaffInfo(),o.entryVisitorMsg){var p=(new Date).getTime(),f="msg"+p,g=o.checkHistoryTime(p),m={t:g?(new Date).format("hh:mm"):void 0,tm:p,mt:864,f:"c",m:0,hide:!0,c:o.entryVisitorMsg,id:f};o.sendToServer(m),o.entryVisitorMsg=null}view.showURLList&&!view.SDK&&(e(".menu-more").hide(),view.hideMenus()),view.handleLeave&&view.handleLeave("leaveToService",a)}else{if(c&&2==c.enable&&c.thirdPartyUrl)return o.publish("__chatStatus","leaveToUrl"),o.publish("__leaveToUrl",c.thirdPartyUrl),l=c.thirdPartyUrl,void(view.SDKNative&&window.setVisitorInfo?setTimeout(function(){r()},200):r());if(!c||0==c.enable||c&&2==c.enable&&!c.thirdPartyUrl){u=!0,o.publish("__chatStatus","leaveDisabled"),e("#inputPlaceholder").html(lanRes.disablePlaceholder),e("#footer").addClass("leave-disabled");var v=t.createElement("div");v.className="mask-disabled",e("#footer").append(v),e(t).off(),c&&view.handleLeave&&view.handleLeave("leaveDisabled",a),setTimeout(function(){o.publish("_endConnect"),o.companyOff=!0},200),view.hideStaffInfo&&view.hideStaffInfo(),view.showURLList&&(e(".menu-more").hide(),view.hideMenus())}}e(".btn-qcode").addClass("hide"),o.publish("removeLoading"),(d||u)&&e("#mask").show(),view.hideServiceIcon&&view.hideServiceIcon(),o.postMessage("toLeaveMessage")}),this.subscribe("refreshVerify",function(t,i){e("#verify_change").removeClass("loadin"),0==i.status||1==i.status&&e("#verify_input").addClass("error"),o.no103=!1,e("#verify_img").attr("src",o.dataHost+"/chatCaptCha.jpg?captChatToken="+i.captChaToken)}),this.bookformi=0,this.getBookComfirm=function(e){if(!e||!e[0])return e||"";var t;if(!(t=1==view.windowType&&1==e[0].type||1!=view.windowType&&3==e[0].type?e[0]:e[1])||!t.configuration)return"";var i=this.bookformi++,a=t.configuration,n=a.length,s=r(a);o.needHttps&&t.backImg&&(t.backImg=t.backImg.replace(/^http:/,o.needHttps));for(var l=' <div id="inviteBook'+i+'" class="book-table '+(3==t.type?"book-table-sm":"book-table-bg")+("1"==s?" book-all-line":"")+'" >'+(t.backImg?'<div><img onerror="view.imgError&&view.imgError(this)" id="inviteBookImg'+i+'" class="book-table-img hide" src="'+t.backImg+'" onload="imgLoadResize(this,'+i+')" /></div>':"")+'<form id="inviteBookForm'+i+'" class="book-items" onsubmit="return false;"> <div class="clearfix book-items-list" style="'+t.formPos+';">',d=0;d<n;d++){var c=a[d],u=1==c.configRequired?"req":"";l+='<div class="book-half book-item '+("1"==c.configInline?"book-one-line":"")+'"><label class="book-label" style="color:'+t.labelColor+'">'+c.configDesc+"</label>"+("gender"==c.configName?'<input type="text" lb="'+c.configDesc+'" class="book-ipt '+u+'" name="'+c.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"  value="'+(2==c.configValue?lanRes.female:1==c.configValue?lanRes.male:"")+'" readonly="readonly" />':"maritalStatus"==c.configName?'<input type="text" lb="'+c.configDesc+'" class="book-ipt '+u+'" name="'+c.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"  value="'+(2==c.configValue?lanRes.married:1==c.configValue?lanRes.unmarried:"")+'" readonly="readonly" />':'<input type="text" lb="'+c.configDesc+'" class="book-ipt '+u+'" name="'+c.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"  value="'+(c.configValue||"")+'" readonly="readonly" />')+"</div>"}return l+="</div></form></div>",setTimeout(function(){var e=_$("inviteBookForm"+i);if(e){var t=e.offsetHeight+(view.px2px?view.px2px(20):20)+e.offsetTop;_$("inviteBookLi"+i).style.minHeight=t+"px"}},1e3),'<li id="inviteBookLi'+i+'" class="clearfix book-confirm-wrap">'+l+"</li>"},this.showOrderSubmit=function(e){o.isInWorkOrder=!0,e.jobWindowInfo&&this.toShowOrderSubmit(e),o.publish("__chatStatus","workorder")},this.showEntryAndCode=function(t,i){var a=!1,n=t.entranceInfo||t.smallEntranceInfo||t.mobileEntranceInfo||t.sdkEntranceInfo,s=n&&1==n.visitorInfoEnable&&(i?1==n.enableOnline:1==n.enableOffline);return o.leaveAndCloseConfig&&!0===o.companyOff&&(n=o.leaveAndCloseConfig,s=!0),s&&o.toShowEntry(n,t)?(e("#verify").hide(),a=!0):t.captChaToken?(e("#entry").html("").hide(),e(".verify-change").attr("id","verify_change"),e(".verify-img").attr("id","verify_img"),e(".verify-ok").attr("id","verify_ok"),e(".verify-input").attr("id","verify_input"),o.publish("removeLoading"),o.toShowCode(),e("#verify_img").attr("src",o.dataHost+"/chatCaptCha.jpg?captChatToken="+t.captChaToken),e("#verify").show(),e("#mask").show(),a=!0):s&&(o.publish("entryCallback",{success:!0,mt:670}),a=!1),a&&(!0!==o.companyOff?o.publish("__setTitle",lanRes.onlineService):o.publish("__setTitle",lanRes.leaveWord)),o.hasEntryOrCode=a,a},this.subscribe("initRobot",function(t,a){function n(){var t=o.getInput(!1);t||e("#input_suggest").addClass("hide").html(" "),!t||o.lastText==t&&d==t||(o.lastText=t,o.publish("sendVisitorEvent",{et:132,content:o.lastText})),o.typingTimer=setTimeout(n,c),d=t}o.needHttps&&a.robotConfigInfo.robotImg&&(a.robotConfigInfo.robotImg=a.robotConfigInfo.robotImg.replace(/^http:/,o.needHttps)),o.staffImg=a.robotConfigInfo.robotImg,o.staffName=a.robotExtInfo&&a.robotExtInfo.nickName||lanRes.robot,o.robotExtInfo=a.robotExtInfo||{},o.paramChat.staffId="-1",o.paramChat.staffName=o.staffName,o.paramChat.staffPhoto=o.staffImg,view.initRobotInfo&&view.initRobotInfo(a),o.bindPlainTextEvent(),view.setInnerAD(a),o.robotWordsInfo=a.robotWordsInfo,e("#toHumanWords").html(a.robotWordsInfo.toHumanWords||""),e("#textInput").attr("placeholder",a.robotWordsInfo.inputBoxWords||lanRes.inputPlaceholder2);var s=o.isVip?view.SDK?a.sdkVipVisitorRobotConfig:a.webVipVisitorRobotConfig:view.SDK?a.sdkVisitorRobotConfig:a.webVisitorRobotConfig;if(e("#robotToStaff").hide(),"1"==s.enableManualSwitch?(!0===o.companyOff?(e("#robotToStaffWord").html(lanRes.leaveWord),"1"==s.enableLeaveBtnWhenStaffOffline&&(e("#robotToStaff").show(),i(o))):(e("#robotToStaffWord").html(lanRes.robotToStaff),"1"==s.enableSwitchBtnWhenStaffOnline&&(e("#robotToStaff").show(),i(o))),view.handleShowRobotToStaff&&view.handleShowRobotToStaff()):e("#robotToStaff").remove(),"1"==a.robotWordsInfo.enableFedBack){var r=a.robotWordsInfo;"string"==typeof r.solvedSubitem&&(r.solvedSubitem=JSON.parse(r.solvedSubitem)),"string"==typeof r.unsolvedSubitem&&(r.unsolvedSubitem=JSON.parse(r.unsolvedSubitem)),o.needHttps&&(r.solvedButton&&(r.solvedButton=r.solvedButton.replace(/^http:/,o.needHttps)),r.unsolvedButton&&(r.unsolvedButton=r.unsolvedButton.replace(/^http:/,o.needHttps))),r.solvedSubitem||r.unsolvedSubitem?!view.dji||r.unsolvedWords||r.solvedWords?o.robotFeedback=function(e){var t=(e=e||{}).answerItem,i="",a='<div class="feedback-tip">'+(r.fedBackWords||"")+'</div><div class="feedback-tag"><i class="feed-icon-sel"></i><span>'+lanRes.hasSelected+'</span></div><div class="feedback-btns clearfix"><div class="feedback-btn-solve '+(1==e.feedback?"feedback-btn-solve-sel":"")+(view.dji&&!r.solvedWords?" hide":"")+'" type="1">'+(r.solvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+r.solvedButton+'"/>':"")+"<span>"+(r.solvedWords||"")+'</span></div><div class="feedback-btn-unsolve '+(2==e.feedback?"feedback-btn-unsolve-sel":"")+(view.dji&&!r.unsolvedWords?" hide":"")+'" type="2">'+(r.unsolvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+r.unsolvedButton+'"/>':"")+"<span>"+(r.unsolvedWords||"")+"</span></div></div>";if(t){if(2!=e.feedback&&r.solvedSubitem&&r.solvedSubitem.length>0){i+='<div class="feedback-sub-solved"><div class="robot-tip">'+lanRes.solvedReason+'</div><ul class="feedback-sub-list '+(e.feedbackSubitem?"robot-feedback-sub-had":"")+'" did="'+t.docId+'" qid="'+t.queryId+'" rid="'+t.robotDetailId+'" searchId="'+t.searchId+'" originQuestion="'+escape(t.originQuestion)+'">';for(n=0;n<r.solvedSubitem.length;n++)i+='<li class="feedback-sub-li sub-solved-li '+(e.feedbackSubitem==r.solvedSubitem[n].content?"feedback-sub-sel1":"")+'"><span class="list-style-dot">'+(n+1)+'.</span><span class="feedback-sub-content" type="1">'+r.solvedSubitem[n].content+"</span></li>";i+="</ul></div>"}if(1!=e.feedback&&r.unsolvedSubitem&&r.unsolvedSubitem.length>0){i+='<div class="feedback-sub-unsolved"><div class="robot-tip">'+lanRes.unsolvedReason+'</div><ul class="feedback-sub-list '+(e.feedbackSubitem?"robot-feedback-sub-had":"")+'" did="'+t.docId+'" qid="'+t.queryId+'" rid="'+t.robotDetailId+'" searchId="'+t.searchId+'" originQuestion="'+escape(t.originQuestion)+'">';for(var n=0;n<r.unsolvedSubitem.length;n++)i+='<li class="feedback-sub-li sub-unsolved-li '+(e.feedbackSubitem==r.unsolvedSubitem[n].content?"feedback-sub-sel2":"")+'"><span class="list-style-dot">'+(n+1)+'.</span><span class="feedback-sub-content" type="2">'+r.unsolvedSubitem[n].content+"</span></li>";i+="</ul>"}}return a+i+"</div></div>"}:o.robotFeedback=!1:o.robotFeedback=function(e){e=e||{};return'<div class="feedback-tip">'+(r.fedBackWords||"")+'</div><div class="feedback-tag"><i class="feed-icon-sel"></i><span>'+lanRes.hasSelected+'</span></div><div class="feedback-btns clearfix"><div class="feedback-btn-solve '+(1==e.feedback?"feedback-btn-solve-sel":"")+'" type="1">'+(r.solvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+r.solvedButton+'"/>':"")+"<span>"+(r.solvedWords||"")+'</psan></div><div class="feedback-btn-unsolve '+(2==e.feedback?"feedback-btn-unsolve-sel":"")+'" type="2">'+(r.unsolvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+r.unsolvedButton+'"/>':"")+"<span>"+(r.unsolvedWords||"")+"</span></div></div></div></div>"};var l=o.getCSSRule(".feedback-btn-solve");l&&r.solvedBackColor&&(l.style.backgroundColor=r.solvedBackColor),(l=o.getCSSRule(".sub-solved-li"))&&r.solvedBackColor&&(l.style.backgroundColor=r.solvedBackColor),(l=o.getCSSRule(".feedback-btn-solve-sel"))&&r.solvedSelectColor&&(l.style.backgroundColor=r.solvedSelectColor),(l=o.getCSSRule(".feedback-sub-sel1"))&&r.solvedSelectColor&&(l.style.backgroundColor=r.solvedSelectColor),(l=o.getCSSRule(".feedback-btn-unsolve"))&&r.unsolvedBackColor&&(l.style.backgroundColor=r.unsolvedBackColor),(l=o.getCSSRule(".sub-unsolved-li"))&&r.unsolvedBackColor&&(l.style.backgroundColor=r.unsolvedBackColor),(l=o.getCSSRule(".feedback-btn-unsolve-sel"))&&r.unsolvedSelectColor&&(l.style.backgroundColor=r.unsolvedSelectColor),(l=o.getCSSRule(".feedback-sub-sel2"))&&r.unsolvedSelectColor&&(l.style.backgroundColor=r.unsolvedSelectColor)}else o.robotFeedback=!1;o.unSubscribe("_sendQuestion"),o.subscribe("_sendQuestion",function(t,i){o.publish("sendVisitorEvent",{et:130,docId:i.docId,originDocId:i.originDocId,content:i.content}),o._getMsg({mt:130,ff:"r",tm:(new Date).getTime()},0,i.content,"c"),e("#input_suggest").addClass("hide").html(" ")}),o.lastText=null,o.typingTimer&&clearTimeout(o.typingTimer);var d,c=12059==o.companyId?500:1500;o.hasInputAssociation&&(o.typingTimer=setTimeout(n,c)),o.openVisitorSend(),e("#toolbar").addClass("robot"),e("body").addClass("robot"),o.publish("onceStartRobot")}),o.subscribe("_showCommonQue",function(t,i){var a=i.content,n=i.commonQuestions&&JSON.parse(i.commonQuestions);if(n&&n.length){i.commonQuesWords?a+='<div class="common-ques-tip">'+i.commonQuesWords+'</div><ul class="common-ques-list">':a+='<ul class="common-ques-list">';for(var s=0;s<n.length;s++)a+='<li class="common-ques-li" did="'+n[s].id+'" ques="'+escape(n[s].question||n[s].content)+'"><span class="list-style-dot">'+(s+1)+'.</span><span class="link-robot-ques">'+(n[s].question||n[s].content)+"</span></li>";a+="</ul>"}i.notStore||(o.talkId=i.talkId,o.paramChat.talkId=o.talkId,o.paramChat.staffPhone="",o.paramChat.staffInfo="",o.robotTalkId=i.talkId,view.startChatRefreshAD&&view.startChatRefreshAD(),o.publish("__chatStaffInfo",{staffId:o.paramChat.staffId,staffNickName:o.staffName||"",staffHead:o.staffImg,staffInfo:o.robotExtInfo.autograph||"",recordId:(o.isInRobot?"5_":"1_")+o.talkId})),o._getMsg.call(this,e.extend(i,{tm:i.tm,mt:12001,ff:"r",answer:i.content,staffImg:o.staffImg,staffName:o.staffName,content:a}),0,a,"r")}),o.maxRobotLength=100,e("#inputLengthTip").html(lanRes.inputLengthTip1+" "+o.maxRobotLength+" "+lanRes.inputLengthTip2),o.handleInputLength=function(){var t;view.chat.isInRobot&&function(t,i){for(var a=0,i=2*i,n=0,s=0;s<t.length;s++){if(null!=t.charAt(s).match(/[^\x00-\xff]/gi)?(a+=2,n+=1):a+=1,a>=i)return o.setInput(t.substr(0,a-n)),void e("#inputLengthTip").html(lanRes.inputLengthTip1+" 0 "+lanRes.inputLengthTip2);var r=i/2-(parseInt(a/2)+a%2);e("#inputLengthTip").html(lanRes.inputLengthTip1+" "+r+" "+lanRes.inputLengthTip2)}}(t=o.getInput(),o.maxRobotLength),(view.chat.isInRobot||view.SDK)&&view.urlList&&(t||o.getInput()?(e(".menu-more").hide(),e("#enter_btn").removeClass("hide")):(e(".menu-more").show(),e("#enter_btn").addClass("hide")))},this.subscribe("onceStartRobot",function(t,i){o.unSubscribe("onceStartRobot"),view.urlList&&(e("#menu_more_robot").show(),e("#enter_btn").addClass("hide")),e("#list_msg").on("click",".common-ques-li",function(t){o.publish("_sendQuestion",{docId:e(this).attr("did"),content:unescape(e(this).attr("ques"))})}),e("#robotToStaffWord").on("click",function(){e("#inputLengthTip").html(lanRes.inputLengthTip1+o.inputMaxLength+lanRes.inputLengthTip2),"disconnected"==EChatQuery.cometd.getStatus()||o.isInRobot&&o.publish("sendVisitorEvent",{et:131}),o.getInputDocBody().blur()}),e("#input_suggest").on("click",".ipt-list-li",function(t){if((!view.handleNetwok||!view.handleNetwok())&&(o.setInput(unescape(e(this).attr("ques"))),o.isInRobot)){o.publish("_sendQuestion",{docId:e(this).attr("did"),content:unescape(e(this).attr("ques"))});o.getInput(!0)&&view.afterSend()}}),e("#list_msg").on("click",".question-list-li",function(t){o.publish("_sendQuestion",{docId:e(this).attr("did"),originDocId:e(this).attr("oid"),content:unescape(e(this).attr("ques"))})}),e("#list_his").on("click",".feedback-btn-unsolve",function(t){var i=this.parentNode.parentNode,a=e(i).attr("did");if(a){view.chat.lastFeedBack=i,o.publish("sendVisitorEvent",{et:133,docId:a,queryId:e(i).attr("qid"),robotDetailId:e(i).attr("rid"),searchId:e(i).attr("searchId"),originQuestion:unescape(e(i).attr("originQuestion")),feedBack:e(this).attr("type")}),e(i).attr("did","").addClass("robot-feedback-had robot-feedback-had2"),e(this).addClass("feedback-btn-unsolve-sel");var n=e(this).parents(".msg-robot").attr("id");n&&view.scrollToBottom(n)}}).on("click",".feedback-btn-solve",function(t){var i=this.parentNode.parentNode,a=e(i).attr("did");if(a){view.chat.lastFeedBack=i,o.publish("sendVisitorEvent",{et:133,docId:a,queryId:e(i).attr("qid"),robotDetailId:e(i).attr("rid"),searchId:e(i).attr("searchId"),originQuestion:unescape(e(i).attr("originQuestion")),feedBack:e(this).attr("type")}),e(i).attr("did","").addClass("robot-feedback-had robot-feedback-had1"),e(this).addClass("feedback-btn-solve-sel");var n=e(this).parents(".msg-robot").attr("id");n&&view.scrollToBottom(n)}}).on("click",".feedback-sub-content",function(t){var i=this.parentNode.parentNode,a=e(i).attr("did");if(a){var n=e(this).attr("type");o.publish("sendVisitorEvent",{et:133,docId:a,queryId:e(i).attr("qid"),robotDetailId:e(i).attr("rid"),searchId:e(i).attr("searchId"),originQuestion:unescape(e(i).attr("originQuestion")),feedBackSubitem:this.innerText||this.textContent||this.innerHTML}),e(i).attr("did","").addClass("robot-feedback-sub-had"),e(this.parentNode).addClass("feedback-sub-sel"+n)}})}),this.subscribe("endRobot",function(t,i){o.data109=null,o.typingTimer&&clearTimeout(o.typingTimer),o.isInRobot=0,e("#toolbar").removeClass("robot"),e("body").removeClass("robot"),e("#robotToStaff").hide(),o.isMobile&&view.hideMenus(),e(".robot-staff").removeClass("robot-staff"),o.unSubscribe("_sendQuestion"),o.robotTalkId&&o.handleSessionMsg({talkId:o.robotTalkId}),o.robotTalkId=null,o.staffName="",o.staffImg=void 0,o.staffId=void 0,delete o.paramChat.staffId,delete o.paramChat.staffName,delete o.paramChat.staffPhoto,delete o.paramChat.talkId,!o.isMobile&&o.changeToIframe(),e("#textInput").attr("placeholder",lanRes.mbTextareaInput.placeholder)}),e(".leave-bar-btn").on("click",function(){o.publish("restartChat")}),e(".robot-staff-close").on("click",function(){var t=this.parentNode;e(t).addClass("hide").hide(),view.handleShowRobotToStaff&&view.handleShowRobotToStaff(),i(o,"close")}),o.unSubscribe("getCrossMessage"),o.subscribe("getCrossMessage",function(e,t){var i=t.data,a=t.source;if(i)if(o.hasSearchInSameScreen&&"robot"==i.evt)"question"==i.type&&i.content&&o.publish("_sendMsg",i.content);else if("echatjs"==i.evt)if("echatInnerFrame"==i.type&&a)try{a.postMessage({type:"echatInnerFrameCallback",companyId:o.companyId,visitorId:o.visitorId,chatVisitorId:window.chatVisitorId,encryptVID:window.encryptVID,metaData:o.queryParams.metadata||"",inChatPage:!0},i.origin)}catch(e){}else"openChat"==i.type?((o.isMobile||2==view.windowType)&&view.hideURLSite&&view.hideURLSite(),o.publish("_triggerChat",i)):"closeFramePage"==i.type?(view.hideURLSite?view.hideURLSite():view.hideRightUrl&&view.hideRightUrl(i),view.__nativeAPI&&view.__nativeAPI("closeUrlView")):"sendTextMsg"==i.type&&o.publish("_sendMsg",i.content)});var u=o.isMobile?"touchend":"click";e("#chat").on(u,".robot-staff",function(){o.isInRobot&&o.publish("sendVisitorEvent",{et:131})}).on(u,".end-chat",function(){o.visitorCloseFunc()}).on(u,".to-leave-word",function(){o.outerChatStatus&&o.outerChatStatus.match(/waiting|chatting|robot/)&&(o.toLeaveWord=1,o.publish("sendVisitorEvent",{et:107,toLeaveWord:1},function(){}))}),o.subscribe("_triggerChat",function(t,i){if("disconnected"==e.cometd.getStatus()||"sdk"==e.cometd.getStatus()){if("block"==_$("satisfy").style.display){if(i&&"showMiniChat"==i.action)return;e("#satisfy").hide(),e("#mask").hide()}setTimeout(function(){console.log(i&&"showMiniChat"==i.action?{needRouter:2==view.windowType&&o.visitorClose}:1),view.chat.publish("restartChat",i&&"showMiniChat"==i.action?{needRouter:2==view.windowType&&o.visitorClose}:void 0)},15),e("#restartChat").text(lanRes.chatContinued),e(".btn-restart").removeAttr("id").removeClass("btn-restart")}else o.isMobile||"firefox"!=o.Browser.browser&&o.focusInput()}),e("#content").on("click",".msg-leave",function(){var t,i=e(this).attr("k"),a=e(this).hasClass("msg-workorder"),n=o.leaveMsgMap[i]||o.orderMsgMap[i],s=(view.SDK||o.needHttps?"https:":"http:")+"//"+o.apiServerDomain+"/chatapi/paodm/qd?companyId="+o.companyId+"&visitorId="+n.visitorId+"&chatInfoType="+(n.chatInfoType||9)+"&talkId="+(n.newsMsgId||n.jobId)+"&tm="+n.tm+"&token="+n.signature,i=n.token||"",r=n.nonce||"",l=(n.companyId,o.msg600.photo||""),d=view.SDKNative?window.locationBase:(o.needHttps||"http:")+"//"+location.host;if(t=a?d+"/visitor/common/order.html?lan="+window.lanResName+"&url="+encodeURIComponent(s)+"&token="+i+"&nonce="+r+"&uploadFileSize="+o.uploadFileSize+"&photo="+encodeURIComponent(l):d+"/visitor/common/record.html?lan="+window.lanResName+"&url="+encodeURIComponent(s),view.handlePushURL?-1==view.handlePushURL(t)&&window.open(t,"_blank"):a?view.showURLLink&&view.showURLLink(lanRes.visitor173,t,{from:5,workorder:1}):view.showURLLink&&view.showURLLink(lanRes.leaveMsgTitle,t,{from:5}),e("#msg"+n.tm).hasClass("fold"))if(!0,o.handleNewMsgMid(n.mid,n,!1,n),e("#msg"+n.tm).removeClass("fold"),view.SDKNative)view.__nativeAPI("updateLocalMsg",{mid:n.mid,read:1});else if(o.hasStorage){var c=window.localStorage.getItem(o.historyKey);if(c){var u=(c=JSON.parse(c))[n.talkId];u&&u[n.tm+"s"]&&(u[n.tm+"s"].read=1),o.updateHistory(c)}}}),this.subscribe("startRobot",function(e,t){o.hasSearchInSameScreen=1==o.msg649.enableSearchInTheSameScreen,o.hasInputAssociation=1==o.msg649.enableInputAssociate,o.isInRobot=!0,o.publish("__chatStatus","robot"),o.publish("clearSendingMsg","robot"),o.publish("setConfig",o.msg649),o.publish("initRobot",o.msg649),view.toggleLeaveToChat&&view.toggleLeaveToChat(2),o.queryParams.autoPop&&delete o.queryParams.autoPop,o.queryParams.autoChat&&delete o.queryParams.autoChat,o.isAutoPop=!1}),this.subscribe("startLeave",function(e,t){o.companyOff=!0,o.talkId=t.talkId,o.publish("setConfig",o.msg649),o.publish("toLeavePage",o.msg649,t),o.queryParams.autoPop&&delete o.queryParams.autoPop,o.queryParams.autoChat&&delete o.queryParams.autoChat,o.isAutoPop=!1}),this.subscribe("startChat",function(e,t){o.publish("setConfig",o.msg649),setTimeout(function(){o.toInitEvaluate(o.msg649)},10),this.startChat.apply(o,arguments)}),o.orderMsgMap={},this.subscribe("orderReply",function(e,i){i.current&&(i.jobId=i.talkId,i.talkId=o.talkId||i.tm);var a='<li class="clearfix '+(1==i.read?"":i.current?"fold":"")+'" talkid="'+i.talkId+'" id="msg'+i.tm+'"><div class="msg-leave msg-workorder" k="'+i.signature+'"><div class="msg-leave-title"><i class="msg-leave-i"></i><span class="msg-leave-t">'+((i.staffNickName?'<span class="color0">'+i.staffNickName+"&nbsp;</span>":lanRes.serviceStaff)+lanRes.visitor174)+'</span></div><div class="msg-leave-con" ><div class="msg-leave-content">'+o.filterEmo(i.content||"")+'</div><div class="msg-leave-dot">...</div><div class="msg-leave-link color0">'+lanRes.viewAll+"</div></div></div></li>",n=t.createElement("ul");n.innerHTML='<li class="clearfix" ><div class="color1 tc">'+o.getTimeStr(i.tm)+"</div></li>"+a;for(var s,r=this.getListMsgEl(i.talkId,i.tm,!!i.current),l=n.childNodes,d=0;s=l[d++];)1==s.nodeType&&(s=s.cloneNode(!0),r.appendChild(s));l=null,n=null,view.scrollToBottom(null,{transitionDuration:100,timeout:100}),i.current&&(i.f="s",i.c=i.content,delete i.current,o.pushHistory(i),r=null),o.orderMsgMap[i.signature]=i}),this.subscribe("continueChat",function(e,t){setTimeout(function(){o.toInitEvaluate(o.msg649)},10),this.startChat.apply(o,arguments)}),this.subscribe("goingEntry",function(e,t){var i;1==t.status?o.showEntryAndCode(t,!0):((i=t.entranceInfo||t.smallEntranceInfo||t.mobileEntranceInfo||t.sdkEntranceInfo)&&1==i.visitorInfoEnable&&1==i.enableOffline||t.captChaToken)&&o.publish("toLeavePage",o.msg649)}),this.hasBoxConfig=function(e){return e.robotConfigInfo||e.robotPCChatBox||e.offlineBoxInfo||e.mobileOfflineBoxInfo||e.sdkOfflineBoxInfo||e.sdkChatBoxInfo||e.mobileChatBoxInfo||e.chatBoxInfo||e.chatSmallBoxInfo||e.offlineSmallBoxInfo||e.jobWindowInfo},this.resetDom=function(){e("#chat").removeClass("hide"),e("#orderSubmit").hide(),e("#footer").removeClass("hide").removeClass("leave-disabled"),e("#busyTipLine").addClass("hide").hide(),e("#input_suggest").addClass("hide").html(" "),o.isMobile&&e(".menu-phone").addClass("limit-hide"),o.isMobile||e("#portrait").hide(),e("#textInput").attr("placeholder",lanRes.mbTextareaInput.placeholder),e("#leaveDisabled").hide(),view.resetContentHeight&&view.resetContentHeight(),e("#container").removeClass("hide"),e("html").removeClass("page-leave"),e("html").removeClass("entry2"),o.hasEntryOrCode&&o.publish("entryCallback",{success:!0}),e("#inputPlaceholder").html(e("#inputPlaceholder").attr("placeholder")||lanRes[e("#inputPlaceholder").attr("langs")]),e("#inputLengthTip").hide(),o.getInput(!1)?e("#inputPlaceholder").addClass("hide"):e("#inputPlaceholder").removeClass("hide"),e("#router").hide()},this.subscribe("waitingChat",function(t,i){o.eventId=i.eventId,o.isInRobot&&o.publish("endRobot"),1!=i.canChatNow&&o.publish("setConfig",i);var a=o.getLeaveConfig(i);if(2!=i.status||2==i.chatStatus||!a||!(2==a.enable&&a.thirdPartyUrl||"0"==a.enable)||(o.publish("toLeavePage",i),"0"!=a.enable&&"2"!=a.enable)){if(!1!==o.chatting&&o.talkId&&(o.lastTalkIdForTemp=o.talkId),o.chatting=-1,o.isInWorkOrder=!1,o.leaveAndClose=!1,o.sendMsgNum=0,view.toggleEnded&&view.toggleEnded("init"),o.resetDom(),o.sendMsgNum=0,o.hasBoxConfig(i)&&(o.msg649=e.extend(o.msg649||{},i),view.SDK&&e.store("ECHAT_"+o.companyId+"_649",JSON.stringify(e.extend(JSON.parse(e.store("ECHAT_"+o.companyId+"_649")||"{}"),i)))),4===Number(i.status)?o.isInWorkOrder=!0:o.isInWorkOrder=!1,i.unreadMsgNumber&&parseInt(i.unreadMsgNumber))return o.companyOff=2==i.status,o.hasLeaveMsg=!0,o.publish("removeLoading"),void(view.toggleLeaveToChat&&view.toggleLeaveToChat(1));if(o.hasLeaveMsg=!1,view.toggleLeaveToChat&&view.toggleLeaveToChat(0),o.companyOff=2==i.status,o.hasChatInOtherPage=!1,e.cookie("ECHAT_"+o.companyId+"_"+window.chatVisitorId+"_chatStatus",i.chatStatus,{path:"/"}),2==i.chatStatus?(o.wait874List=!0,o.hasChatInOtherPage=!0):1!=i.canChatNow&&o.publish("goingEntry",i),4===Number(i.status)&&o.showOrderSubmit(i),o.publish("__staffStatus",i.status),ECHATObjKeyMap.cometdId.waitForRouterSelect&&o.publish("routerSelect"),ECHATObjKeyMap.cometdId.waitForRouterSelect=!1,o.isInRobot&&(i.robotPCChatBox||i.robotSmallChatBox||i.robotPhoneChatBox||i.robotSdkChatBox)||!o.isInRobot&&(i.chatBoxInfo||i.chatSmallBoxInfo||i.mobileChatBoxInfo||i.sdkChatBoxInfo)){var n=i.entranceInfo||i.smallEntranceInfo||i.mobileEntranceInfo||i.sdkEntranceInfo;n&&2==i.status&&1==n.visitorInfoEnable&&1==n.enableOffline&&"0"==n.offlineStartType||view.setInnerAD(i)}!0!==o.companyOff&&"0"==o.queryParams.autoChat&&!0!==o.chatting?(e(".menu-capture").addClass("hide"),e(".menu-file").addClass("hide")):!0===o.companyOff&&(e(".menu-capture").removeClass("hide"),e(".menu-file").removeClass("hide")),o.openVisitorSend(),o.publish("firstInitSound"),1==i.notThroughStatus&&o.publish("removeLoading")}}),this.subscribe("firstInitSound",function(){o.unSubscribe("firstInitSound"),o.isMobile?window.audioInstance||(window.audioInstance=_$s("audio")[0]):window.ltIE10||window.audioInstance&&view.SDKNative||o.addJS("/visitor/common/audiojs/audiojs/audio.min.js",function(){audiojs.events.ready(function(){window.audioInstance=audiojs.create(_$("msgAudio"))})}),o.unSubscribe("_newMsg"),o.subscribe("_newMsg",function(){if(!o.disableSoundTip&&window.audioInstance){var e=window.audioInstance;try{e.play.apply(e)}catch(e){}}})}),this.subscribe("_addSendMsgNum",function(e,t){o.sendMsgNum++,o.allowEvaluateBaseWords<=o.sendMsgNum&&o.toggleEvaluateMenu(4)});var f={};o.handleNewMsgMid=function(t,i,a,n){if(t&&!f[t])return f[t]=1,o.lasMid=o.lasMid||e.store("ECHAT_"+o.companyId+"_"+o.visitorId+"_mid")||0,o.lasMid<t?(i&&a&&(i.mid=t,!1!==n.isForward&&view.SDKNative||(o.publish("_newMsg",i),"sys"==i.f?o.publish("__newSysMsg",i,n||{}):o.publish("__newMsg",i,n||{}))),e.store("ECHAT_"+o.companyId+"_"+o.visitorId+"_mid",t),(!1===view.showChangeTitle||view.miniShow||window.ltIE10)&&(e.cookie("ECHAT_"+o.companyId+"_"+window.chatVisitorId+"_mid_read",t,{path:"/"}),1!=view.windowType&&3!=view.windowType||!1!==view.showChangeTitle||e.cookie("ECHAT_"+o.companyId+"_"+window.chatVisitorId+"_mid_read_click",t,{path:"/"})),a):void 0},o._getMsg=function(t,i,a,n){t.tm||(t.tm=(new Date).getTime());var s=new Date(t.tm?t.tm-0:void 0),r=t.id||t.bridgeMsgId||t.fileIdentity||"msg"+t.tm,l=o.checkHistoryTime(t.tm),d={t:t.t||(l?s.format("hh:mm"):void 0),tm:t.tm,mt:a&&a.mt||t.mt,f:n||"s",m:i,c:a,hasResend:t.bridgeMsgId&&2==t.sendStatus,notEnd:t.notEnd,id:r};d.hasResend&&(o.errorList[r]=t),d.talkId=t.talkId||o.talkId,t.staffImg&&(d.staffImg=t.staffImg),t.staffName&&(d.staffName=t.staffName||t.staffNickName),t.staffId&&!t.staffName&&o.staffMap[t.staffId]&&(d=e.extend(d,o.staffMap[t.staffId])),"f"!=n&&"r"!=t.ff||(d.ff="r"),d.c&&o.showMsg(d),delete d.id,delete d.hasResend,t.notStore||(1==i?d.tmf=r:2==i&&(d.fileIdentity=t.fileIdentity,d.fileName=t.fileName,d.bigImg=t.bigImg,d.smallImg=t.smallImg,d.sourceImg=t.sourceImg,d.c="img-temp"+r,d.sourceWidth=t.sourceWidth,d.sourceHeight=t.sourceHeight,d.tmf=r),"x"==n&&5!=d.m?d.c=t.content:"r"==n&&(d.c=t.content),(a||t)&&!o.isMobile&&view.setDocumentTitle&&view.setDocumentTitle(n),"c"!=n&&(d.answer=t.answer||void 0,o.handleNewMsgMid(t.mid,d,!0,a)),d.c&&o.pushHistory(d))},this.escapeHtml=function(e){return e&&e.replace(/"/g,"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};this.getVisEvtHtml=function(e){if(e.urlForVisitor){e.urlForVisitor=e.urlForVisitor.replace(/\s/g,"");var t=e.urlForVisitor.match(/^http\(['"]?([^'",]+)['"]?(\,['"]?(blank|inner)['"]?)?\)/i)||e.urlForVisitor.match(/^xcx\(['"]?([^'",]+)['"]?(\,['"]?(navigateTo|redirectTo|switchTab)['"]?)?\)/i);t?(e.url=t[1],e.openType=t[3]):e.url=""}else if(0==e.urlEnableForVisitor&&(e.url=void 0,delete e.url),e.url){var i=e.url.replace(/\s/g,"").match(/^apiUrl\(['"]?(\d+)['"]?(\,['"]?(reload|hash)['"]?)?\)/);i?e.toCrmUrlId=i[1]:(e.url.match(/(^http[s]?:)|(^file:)/i)||(e.url=""),e.toCrmUrlId=!1)}var a="";if(e.imageUrl&&(e.imageUrl=e.imageUrl.replace(/["']/,""),a=e.imageUrl?'<img onerror="view.imgError&&view.imgError(this)" class="custom-event-img" src="'+e.imageUrl+'"/>':"",!e.url||e.toCrmUrlId)){a=a.replace(/<img\b.*?(?:\>|\/>)/gi,function(){var t={smallImg:e.imageUrl,bigImg:e.imageUrl,sourceImg:e.imageUrl,fileName:"预览"};return view.showMsgImg&&view.showMsgImg(t,"custom-event-img")||'<img  onerror="view.imgError&&view.imgError(this)"'+(t.notEnd?"":'onload="javascript:view.scrollToBottom()"')+' id="img'+(t.tm||(new Date).getTime())+'" attname="'+t.fileName+'" bigimg="'+t.bigImg+'" src="'+t.smallImg+'" source="'+(t.sourceImg||"")+'" sw="'+(t.sourceWidth||"")+'" sh="'+(t.sourceHeight||"")+'" class="msg-img custom-event-img"/>'})}return function(e){return e?'<div class="custom-event '+(o.isInRobot?"bg30":"bg3")+'"><div class="custom-event-wrap">{{imageUrl}}<div class="custom-event-content"><div class="custom-event-title" style="height:auto;margin-bottom:0;" title="{{title1}}">{{title}}</div><div class="custom-event-detail">{{content}}</div></div></div>{{memo}}</div>':'<a class="custom-event '+(o.isInRobot?"bg30":"bg3")+'" {{linkset}}><div class="custom-event-wrap">{{imageUrl}}<div class="custom-event-content"><div class="custom-event-title" style="height:auto;margin-bottom:0;" title="{{title1}}">{{title}}</div><div class="custom-event-detail">{{content}}</div></div></div>{{memo}}</a>'}(!e.url||e.toCrmUrlId).replace(/\{\{linkset\}\}/,!e.url||e.toCrmUrlId?"":' href="'+e.url+("inner"==e.openType?'" target="inner" title="'+(e.title||lanRes.interactWnd)+'" ':"navigateTo"==e.openType||"redirectTo"==e.openType||"switchTab"==e.openType?'" target="'+e.openType+'" ':'" target="_blank" ')).replace(/\{\{title1\}\}/,o.escapeHtml(e.title)||"").replace(/\{\{title\}\}/,e.title||"").replace(/\{\{imageUrl\}\}/,a).replace(/\{\{content\}\}/,e.content||"").replace(/\{\{memo\}\}/,e.memo?'<div class="custom-event-memo">'+e.memo+"</div>":"")},this.subscribe("receiveVisEvt",function(e,t,i){if(!t.notStore&&t.talkId&&(o.talkId=t.talkId),2!=t.visibility){if(t.notStore&&t.c)return o._getMsg(t,5,t.c,t.f);var a=o.getVisEvtHtml(t);2==t.customizeMsgType||3==t.mst?o._getMsg(t,5,'<li class="clearfix custom-event-li" id="msg'+t.tm+'">'+a+"</li>","x"):t.mst&&1!=t.mst?2==t.mst&&o._getMsg(t,5,a,i?"r":"s"):(o._getMsg(t,5,a,"c"),!t.notEnd&&o.publish("__visitorSendMsg","["+lanRes.imageAndHtml+"]"+(t.title||"")),!t.notEnd&&o.publish("__visitorStartSendMsg","["+lanRes.imageAndHtml+"]"+(t.title||"")),t.notStore||t.notEnd||"1"!=t.closeURLPage||(view.hideURLSite&&view.hideURLSite(),view.hideMenus&&view.hideMenus()))}}),this.subscribe("receiveURL",function(e,t){var i=t.pushUrlDetail.url,a="";if(view.chat.needHttps&&i.match(/^http:/i)&&(a=" push-blank"),view.pushURLParam){var n=i.split("#");i=n[0]+(-1==n[0].indexOf("?")?"?":"&")+view.pushURLParam+(n[1]?"#"+n[1]:"")}var s='<a class="push-url clearfix'+a+'" target="info_frame3" href="'+i+'"><div class="push-icon echat bg1"></div><div class="push-content"><div class="push-name">'+t.pushUrlDetail.urlName+' </div><div class="push-url-link">'+t.pushUrlDetail.url+"</div></div></a>";o._getMsg.call(this,t,6,s,"s"),1!=o.queryParams.echatIframeDisable&&-1==i.indexOf("echatIframeDisable=1")&&view.handlePushURL&&view.handlePushURL(i,void 0,t.pushUrlDetail.urlName)}),this.subscribe("getMsgImg",function(e,t,i){o.needHttps&&(o.qiniuDomain&&o.qiniuHttpsDomain&&(t.bigImg&&(t.bigImg=t.bigImg.replace(o.qiniuDomain,o.qiniuHttpsDomain)),t.smallImg&&(t.smallImg=t.smallImg.replace(o.qiniuDomain,o.qiniuHttpsDomain)),t.sourceImg&&(t.sourceImg=t.sourceImg.replace(o.qiniuDomain,o.qiniuHttpsDomain))),t.bigImg&&(t.bigImg=t.bigImg.replace(/^http:/,o.needHttps)),t.smallImg&&(t.smallImg=t.smallImg.replace(/^http:/,o.needHttps)),t.sourceImg&&(t.sourceImg=t.sourceImg.replace(/^http:/,o.needHttps))),t.fileName&&"temp.png"!=t.fileName||(t.fileName="Echat"+(new Date).format("yyyyMMddhhmmss")+".png"),t.sourceImg=t.sourceImg||t.bigImg;var a=view.showMsgImg&&view.showMsgImg(t)||"<img "+(t.notEnd?"":'onload="javascript:view.scrollToBottom()"')+' id="img'+(t.fileIdentity||t.tm||(new Date).getTime())+'" attname="'+t.fileName+'" bigimg="'+(t.bigImg||t.sourceImg)+'" src="'+t.smallImg+'" source="'+(t.sourceImg||"")+'" sw="'+(t.sourceWidth||"")+'" sh="'+(t.sourceHeight||"")+'" class="msg-img"/>';t.fileIdentity&&_$(t.clientFileId||t.fileIdentity)&&(o.addSendFile(),o.publish("__visitorSendMsg","["+lanRes.image+"]")),o.sendingFileToken&&o.sendingFileToken.end&&o.sendingFileToken.token==t.fileIdentity&&(o.sendingFileToken="",o.publish("_toggleEnableFile",!0)),t.id=t.clientFileId||t.identityKey||t.fileIdentity,o._getMsg.call(this,t,2,a,865==t.mt?"c":i?"r":"s"),view.initImgPlay&&view.initImgPlay(),o.isInRobot||865!=t.mt&&"local"!=t.mt||o.publish("_addSendMsgNum")}),this.subscribe("getMsgFile",function(e,t,i){o.needHttps&&t.fileUrl&&(o.qiniuDomain&&o.qiniuHttpsDomain&&(t.fileUrl=t.fileUrl.replace(o.qiniuDomain,o.qiniuHttpsDomain)),t.fileUrl=t.fileUrl.replace(/^http:/,o.needHttps)),!_$("downFrame")&&_$("downFileFrame")&&(_$("downFileFrame").innerHTML='<iframe id="downFile" name="downFile" style="display:none;"></iframe>');var a,n,s,r="downFile",l=t.fileUrl;o.isIOS&&(r="_blank"),(a=view.SDKNative?view.getMsgFile(t):t.c?t.c:"")||(n=t.fileUrl&&t.fileUrl.indexOf("?")>0?"&":"?",s=t.fileUrl+n+"attname="+encodeURIComponent(t.fileName),a=view.SDK||2!=t.fileType||window.ltIE10?'<div class="file-info"><div class="file-name">'+t.fileName+'</div><div class="file-size">'+(parseInt(t.fileSize/1024)+1)+'KB</div></div><div class="file-icon">&nbsp;</div><a class="file-link file-link-a color0" href="'+s+'" target="'+r+'">'+lanRes.download+"</a>":o.isMobile?'<div class="file-video" identity="'+t.fileIdentity+'" onclick="__playVideo(\''+l+"','"+(t.videoThumbUrl||"")+"','"+s+"','"+(t.fileName||"")+'\')" style="'+(t.videoThumbUrl?"background:url("+t.videoThumbUrl+") no-repeat;background-size:100%;":"")+'"><div class="icon_video"></div><div class="video_logo">VIDEO</div></di>':'<a class="file-video" target="_blank" href="/visitor/pc/video.html?videoUrl='+encodeURIComponent(s)+'" style="'+(t.videoThumbUrl?"background:url("+t.videoThumbUrl+") no-repeat;background-size:100%;":"")+'"><div class="icon_video"></div><div class="video_logo">VIDEO</div></a>');866==t.mt&&(t.fileIdentity||t.identityKey)&&(_$(t.clientFileId)||_$(t.fileIdentity||t.identityKey))&&(o.addSendFile(),o.publish("__visitorSendMsg","["+(2==t.fileType?lanRes.video:lanRes.fileHtml)+"]")),o.sendingFileToken&&o.sendingFileToken.end&&o.sendingFileToken==t.fileIdentity&&(o.sendingFileToken="",o.publish("_toggleEnableFile",!0)),t.id=t.clientFileId||t.identityKey||t.fileIdentity,o._getMsg.call(this,t,3==t.fileType||4==t.fileType?t.fileType:1,a,866==t.mt||"local"==t.mt?"c":i?"r":"s"),o.isInRobot||866!=t.mt&&"local"!=t.mt||o.publish("_addSendMsgNum")}),o.subscribe("_toggleEnableFile",function(i,a){if(!o.hasFormData){var n;(n=_$("file_up").contentDocument)||(n=t.frames.file_up.document);var s=n.getElementById("uploadInput");a?(e(".menu-file").removeClass("menu-file-sending").attr("title",lanRes.selectFile),s.setAttribute("disabled",""),s.disabled=!1,s.removeAttribute("disabled"),s.title=lanRes.selectFile,s.setAttribute("title",lanRes.selectFile)):(e(".menu-file").addClass("menu-file-sending").attr("title",o.sendingTitle),s.disabled="disabled",s.setAttribute("disabled","disabled"),s.title=o.sendingTitle,s.setAttribute("title",o.sendingTitle))}}),this.subscribe("getMsg",function(t,i){var a=(i.translation||i.content)+"";if(i.relateId){this.changeStorgeBackMsg(i.relateId);if(_$(i.relateId+"")){e("#"+i.relateId).html("");var n='<div style="padding: 10px 0 20px;text-align: center;"><span style="display: inline-block;padding: 8px 10px;background-color: #bfbfbf;border-radius: 5px;color: #FFF;">'+lanRes.backMsgTip+"</span></div>";e("#"+i.relateId).html(n)}}if(a&&"undefined"!==a){a=(a=a.replace(/<img\b.*?(?:\>|\/>)/gi,function(e){var t=/\bsrc\b\s*=\s*[\'\"]?([^\'\"]*)[\'\"]?/i.exec(e);if(!t)return e;var i={smallImg:t=t[1],bigImg:t,sourceImg:t,fileName:lanRes.visitor175};return view.showMsgImg&&view.showMsgImg(i)||'<img onerror="view.imgError&&view.imgError(this)" '+(i.notEnd?"":'onload="javascript:view.scrollToBottom()"')+' id="img'+(i.tm||(new Date).getTime())+'" attname="'+i.fileName+'" bigimg="'+(i.bigImg||i.sourceImg||"")+'" src="'+i.smallImg+'" source="'+(i.sourceImg||"")+'" sw="'+(i.sourceWidth||"")+'" sh="'+(i.sourceHeight||"")+'" class="msg-img"/>'})).replace(/&nbsp;([^&\s])/g," $1"),i.staffImg||i.notStore||(i.staffId=o.staffId),o._getMsg.call(this,i,0,a)}}),o.robotUnknowTime=0,this.subscribe("getMsgRobot",function(t,a){if("r"==a.f&&a.c)return o._getMsg.call(this,{talkId:a.talkId,tm:a.tm,mt:12001,ff:"r",staffImg:a.staffImg,staffName:a.staffName,content:a.c,notEnd:!0,notStore:!0},0,a.c,"r");var n,s,r,l,d,c=a.knowledgeAnswerList||[],u="",f='<ul class="question-list">',m='<div class="ipt-list">';if(a.nonTextMsg)10011==(u=a.nonTextMsg).mt?o.publish("receiveVisEvt",u,!0):641==u.mt?o.publish("getMsgImg",u,!0):642==u.mt&&o.publish("getMsgFile",u,!0);else if(4==a.type){if(a.notStore||a.fromDB||a.history)return;r=a.segWords;for(var h,p=!1,g=0,v=0;v<c.length;v++){if(n=c[v],s=n.question,p=!1,s==o.lastText){v++,g=1,m='<div class="ipt-list"><a class="ipt-list-li" did="'+n.docId+'" ques="'+escape(n.question)+'"><b class="words-seg">'+s+"</b></a>";break}if(r){0;for(w=0;w<r.length;w++)h=r[w],h=o.escapeRegExp(h),s=s.replace(new RegExp(h,"igm"),function(e,t){p=!0;var i=arguments.length,a=arguments[i-2];if(!(a>0))return l='<b class="words-seg">'+e+"</b>";var n=arguments[i-1].substring(0,a),s=arguments[i-1].substring(a);if(h.match(/^s|sp|spa|span$/)&&n.match(/<$/))return e;if(h.match(/^n|an|pan|span$/)){var o="</span>".replace(h,",").split(",");if(n.match(new RegExp(o[0])&&s.match(o[1])))return e}return/(\<span[^>]*>([^<]+(?!\<\/span\>))?$)|(\<[a-zA-Z]+[^>]*$)/gi.test(n)?e:l='<b class="words-seg">'+e+"</b>"})}p&&(g++,m+='<a class="ipt-list-li" did="'+n.docId+'" ques="'+escape(n.question)+'">'+s+"</a>")}g>0?e("#input_suggest").html(m+"</ul>").removeClass("hide"):e("#input_suggest").addClass("hide").html(" ")}else if(3==a.type)a.f,a.tip=a.tips,204==a.result||205==a.result?(o.showInfoTip(a,void 0,void 0,void 0,a.talkId),a.notStore||(o.robotToHumanKey=a.robotToHumanKey,o.publish("toSetID"),e("#input_suggest").addClass("hide").html(" "),o.handleNewMsgMid(a.mid,{c:a.tips,f:"sys",m:0},!0,a)),delete o.paramChat.staffId,delete o.paramChat.staffName,delete o.paramChat.staffPhoto,delete o.paramChat.talkId):206==a.result||202==a.result?console.log(206==a.result?"禁用留言":"禁用转人工"):207==a.result&&(o.showInfoTip(a,void 0,void 0,void 0,a.talkId),a.notStore||(e("#robotToStaff").show(),i(o),view.showRobotToStaff&&view.showRobotToStaff(a),view.handleShowRobotToStaff&&view.handleShowRobotToStaff(),o.handleNewMsgMid(a.mid,{c:a.tips,f:"sys",m:0},!0,a)));else if(5==a.type){(u=(u=a.tips||"").replace(/&nbsp;([^&\s])/g," $1"))&&o._getMsg.call(this,e.extend(a,{ff:"r",staffImg:a.staffImg||o.staffImg,staffName:a.staffName||o.staffName,content:'<div class="msg-item-robot"> '+u+"</div>",notEnd:"r"==a.f,notStore:"r"==a.f,talkId:a.talkId}),0,'<div class="msg-item-robot"> '+u+"</div>","r");var b,y=e("#q"+a.robotDetailId);a.feedback&&e(y).attr("did","").attr("qid","").addClass("robot-feedback-had").addClass("robot-feedback-had"+a.feedback).attr("feedback",a.feedback),2==a.feedback&&e(".feedback-btn-unsolve",y.results[0]).addClass("feedback-btn-unsolve-sel"),1==a.feedback&&e(".feedback-btn-solve",y.results[0]).addClass("feedback-btn-solve-sel"),a.feedbackSubitem&&(2==(b=e(y).attr("feedback"))?(e(".feedback-sub-solved",y.results[0]).remove(),console.log(e(".feedback-sub-li",y.results[0])),e(".feedback-sub-li",y.results[0]).each(function(){e(".feedback-sub-content",this).text()==a.feedbackSubitem&&(e(this).addClass("feedback-sub-sel2"),e(".feedback-sub-list",y.results[0]).addClass("robot-feedback-sub-had"))})):1==b&&(e(".feedback-sub-unsolved",y.results[0]).remove(),e(".feedback-sub-li",y.results[0]).each(function(){e(".feedback-sub-content",this).text()==a.feedbackSubitem&&(e(this).addClass("feedback-sub-sel1"),e(".feedback-sub-list",y.results[0]).addClass("robot-feedback-sub-had"))})),setTimeout(function(){view.scrollUpdate()},100))}else if(6==a.type)(u=(u=a.tips||"").replace(/&nbsp;([^&\s])/g," $1"))&&o._getMsg.call(this,e.extend(a,{ff:"r",staffImg:a.staffImg||o.staffImg,staffName:a.staffName||o.staffName,content:'<div class="msg-item-robot"> '+u+"</div>"}),0,'<div class="msg-item-robot"> '+u+"</div>","r");else if(7==a.type)u=a.tips||a.content||"",o.showInfoTip(u),a.notStore&&o.handleNewMsgMid(a.mid,{c:u,f:"sys",m:0},!0,a);else if(1==a.type||2==a.type){if((n=c[0])?1==n.answerType?u+=a.tips||"":2==n.answerType?(u+='<div class="robot-tip">'+(a.tips||"")+"</div>",u+=n.answer||"",d=n.relateKnowledges,f+='<div class="robot-tip margin-top10">'+(a.tipsExt||"")+"</div>"):3==n.answerType?(d=n.suggestions,f+='<div class="robot-tip">'+(a.tips||"")+"</div>"):4==n.answerType?u+=n.answer||"":5==n.answerType?(u+=n.answer||"",d=n.relateKnowledges,f+='<div class="robot-tip">'+(a.tips||"")+"</div>"):6==n.answerType&&(u+=n.answer||"",d=n.relateKnowledges,f+='<div class="robot-tip margin-top10">'+(a.tips||"")+"</div>"):u+=a.tips||"",d&&d.length){for(var w=0;w<d.length;w++)f+='<li class="question-list-li" oid="'+n.docId+'" did="'+d[w].docId+'" ques="'+escape(d[w].question)+'"><span class="list-style-dot">'+(w+1)+'. </span><span class="color-link">'+d[w].question+"</span></li>";f+="</ul>"}else f="";var I,k="";1==n.feedback&&o.robotFeedback&&(!n.searchId&&(n.searchId=""),!n.originQuestion&&(n.originQuestion=""),I=a.relateId&&o.robotFeedbackTemp&&o.robotFeedbackTemp[a.relateId]||{},a.feedback=a.feedback||I.feedbackResult,k='<div id="q'+n.robotDetailId+'" class="robot-feedback'+(a.feedback?" robot-feedback-had robot-feedback-had"+a.feedback+'"':'" did="'+n.docId+'" qid="'+n.queryId+'" rid="'+n.robotDetailId+'" searchId="'+n.searchId+'" originQuestion="'+escape(n.originQuestion)+'"')+">"+o.robotFeedback({feedback:a.feedback,feedbackSubitem:I.feedbackSubitem,answerItem:n})),((u=u.replace(/&nbsp;([^&\s])/g," $1"))||f)&&o._getMsg.call(this,e.extend(a,{ff:"r",staffImg:a.staffImg||o.staffImg,staffName:a.staffName||o.staffName,answer:u,content:'<div class="msg-item-robot"> '+u+f+"</div>"}),0,'<div class="msg-item-robot"> '+u+f+"</div>"+k,"r")}}),this.subscribe("getMsgMine",function(e,t){var i=t.content;o.isInRobot&&(t.ff="r"),o.isInRobot||o.publish("_addSendMsgNum"),o._getMsg.call(this,t,0,i,"c")}),this.resendFile=function(t,i){var a=this,n=t.uploadServiceType,s=a.uploadUtil.getNextUploadType(n);return!1!==s?(a.publish("sendVisitorEvent",{et:123,ssl:a.needHttps?1:void 0,uploadServiceType:s,ft:t.fileType},function(t){!t.successful||t.failure?!1===t.autoResend&&a.handleFileSelect.error():e("#"+i).remove()}),!1):(a.publish("getErr",{reqInfo:i,code:-2}),!0)},this.subscribe("getFileToken",function(i,a){2==a.fileType&&o.handleFileSelect.back();for(var n,s,r=o.fileUploadInfos["uploadServiceType"+a.uploadServiceType]||a,l={},d=o.needHttps?r.fileUploadHttpsUrl:r.fileUploadUrl,c=a.qiniuKey||a.token||a.aliyunKey&&a.aliyunKey.match(/\/([^\/]+$)/)[1],u=null,f=r.fileUploadParam.split(","),m=0;m<f.length;m++)l[f[m].split("=")[0]]=(u=f[m].match(/\$\{([^\}]+)\}/))?a[u[1]]:f[m].split("=")[1];if(a.fileType=a.fileType||2,1==a.fileType){if(!o.pasteFileSource)return;(x=new FormData).append("file",o.pasteFileSource)}if(a.uploadServiceType==o.uploadUtil.getLastUploadType()&&(d+="?token="+a.token),2!=a.fileType&&3!=a.fileType&&4!=a.fileType)1==a.fileType||(5==a.fileType?(o.fileToken=a,o.publish("_captureImg",null)):6==a.fileType&&(o.fileToken=a,o.publish("_captureImgIE",null)));else{C=t;o.hasFormData||(C=_$("file_up").contentDocument)||(C=t.frames.file_up.document);var h=C.getElementById("uploadInput"),v=h.value||h.getAttribute("value");if(!v)return void console.log("no file to send",v);for(var b,y=(h.files||[{}]).length,w=0;w<y;w++)if(0===g[w+""]||3===g[w+""]){b=w;break}var I=b+1===y;if(h.files){if(!h.files[b]||!h.files[b].size)return void console.log("no file to send",v);(h.files[b]||h.files[b].name)&&(v=h.files[b].name)}if(n=v.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1"),o.hasFormData){try{s=new FormData;for(var k in l)"Content-Disposition"!=k&&"x:filename"!=k||(l[k]=n),s.append(k,l[k]);s.append("file",h.files[b],n);var T=new XMLHttpRequest;T.open("POST",d,!0);var S=!1;T.onerror=T.ontimeout=T.onabort=function(){g[b]=3,!S&&o.resendFile(a,c),S=!0},T.addEventListener("load",function(e){200==T.status&&T.responseText&&(1==T.responseText||T.responseText.match(/\{\s*"errorCode"\s*:\s*1\s*}/))?(g[b]=2,I&&setTimeout(function(){t.forms.namedItem("uploadForm").reset()})):403==T.status||T.responseText&&T.responseText.match(/\{\s*"errorCode"\s*:\s*146\s*}/)||T.responseText&&T.responseText.match(/\{\s*"errorCode"\s*:\s*117\s*}/)?(g[b]=4,o.publish("getErr",{reqInfo:c,code:-2}),setTimeout(function(){t.forms.namedItem("uploadForm").reset()})):(g[b]=3,!S&&o.resendFile(a,c),S=!0)}),g[b]=1,T.send(s),_$(c)||o.showMsg({id:c,f:"c"},'<div class="file-sending">'+lanRes.fileSending+"</div>"),o.sendingFileToken={token:c,end:!0}}catch(e){if(!I)return;o.hasFormData=!1,o.hasInitFile=!1,o.addSendFile(),p=null,console.log("变为iframe上传")}I&&(h=s=null)}else{var C;(C=_$("file_up").contentDocument)||(C=t.frames.file_up.document);var x=C.getElementById("uploadForm");for(var k in l)if("Content-Disposition"!=k&&"x:filename"!=k||(l[k]=n),x[k])x[k].value=l[k];else{var _=C.createElement("input");_.name=k,_.type="hidden",_.value=l[k],x.insertBefore(_,h)}e(x).attr("action",d),x.submit(),o.showMsg({id:c,f:"c"},'<div class="file-sending">'+lanRes.fileSending+"</div>"),setTimeout(function(){o.sendingFileToken={token:c,end:!0},o.publish("_toggleEnableFile",!1)},10)}}}),this.subscribe("niuniuKey",function(e,t){if(t){var i=t.split(","),a=new Date,n=a.getFullYear()+""+(a.getMonth()+1)+a.getDate();a.setDate(a.getDate()+1);var s=a.getFullYear()+""+(a.getMonth()+1)+a.getDate();o["niuniu"+n]=i[0],o["niuniu"+s]=i[1]}});var m=navigator.userAgent.toLowerCase(),h=(m.indexOf("baidubrowser"),m.indexOf("mqqbrowser")>-1&&this.Device.OS,"uc"==this.Browser.browser);o.isMobile||o.isInRobot?this.bindPlainTextEvent():o.changeToIframe(),h&&e("#footer").addClass("footer-absolute");var p;o.resetForm=function(e){var i;if(o.hasFormData)i=t.forms.namedItem("uploadForm").reset();else{var a=_$("file_up").contentDocument||t.frames.file_up.document;i=a.getElementById("uploadForm")}setTimeout(function(){i&&i.reset()},e||10)},o.handleFileSelect=function(){var e,t,i="tempInitSendFile";return{back:function(){--e<1&&o.publish("enableSelectFile",i)},error:function(){--e<1&&o.publish("enableSelectFile",i)},change:function(a){t=e=a,o.publish("disableSelectFile",i)},isSending:function(){return e>0},reset:function(){t=e=0,o.publish("enableSelectFile",i)}}}(),o.subscribe("enableSelectFile",function(t,i){e(".menu-file").removeClass("menu-file-disabled"),e("#"+i).remove()}),o.subscribe("disableSelectFile",function(t,i){o.showMsg({id:i,f:"c"},'<div class="file-sending">'+lanRes.fileSending+"</div>"),e(".menu-file").addClass("menu-file-disabled")}),e("body").on("click",".menu-file-disabled",function(){o.handleFileSelect.isSending?o.showTip(lanRes.fileDisable):o.handleFileSelect.reset()});var g={};window.fLoad=function(i){i||(i=_$("file_up").contentDocument)||(i=t.frames.file_up.document);var a=i.getElementById("uploadInput");view.dji&&(a.style.height="62px"),"1"===view.chat.queryParams.multipleFile&&(e(a).attr("multiple","multiple"),e(a).attr("title",lanRes.visitor176)),a.onchange=function(){if(g={},!0===o.companyOff||o.busyCanSend&&"0"!=o.queryParams.autoChat||!0===o.chatting){var t=a.value||a.getAttribute("value");if(!function(t){return!(t>9&&(o.isMobile?(_$("leave_tip_con").innerHTML=lanRes.visitor176,o.tipTimer&&clearTimeout(o.tipTimer),e("#leave_tip").removeClass("tiphide"),o.tipTimer=setTimeout(function(){e("#leave_tip").addClass("tiphide")},3e3)):o.showDialog({tip:lanRes.visitor177,cancel:!1}),1))}((a.files||[{}]).length))return!1;if(t){var i,n=t,s=(a.files||[{}]).length;o.handleFileSelect.change(s);for(var r=0;r<s;r++){if(a.files){if(!a.files[r]||!a.files[r].size){console.log("no file to send",t),o.handleFileSelect.error();continue}(a.files[r]||a.files[r].name)&&(t=a.files[r].name)}i=-1!=t.indexOf(".")?t.replace(/.*\./,""):"";var l=t.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1");if(o.sendingTitle=l+"."+i+lanRes.fileSendWait,i&&-1==(","+o.uploadFileType+",").indexOf(","+i.toLowerCase()+","))o.showDialog({tip:"ERROR: "+lanRes.unsupportFileType+"。</br>"+lanRes.supportFileType+": "+o.uploadFileType,cancel:!1}),o.handleFileSelect.error();else{o.getFileSize(a,r)>o.uploadFileSize?(o.showDialog({tip:lanRes.fileSizeOut.replace("${maxSize}",o.uploadFileSize/1024/1024+"M"),cancel:!1}),o.handleFileSelect.error()):(g[r+""]=0,a.files&&(n=a.files[r]),p=n,o.publish("sendVisitorEvent",{et:123,ssl:o.needHttps?1:void 0,uploadServiceType:o.uploadUtil.getUploadServiceType(),ft:2},function(e){e.successful&&!e.failure||!1===e.autoResend&&o.handleFileSelect.error()}),view.hideMenus&&view.hideMenus(0,!1))}}}else console.log("no file to send",t)}else e("#busyTipLine").removeClass("hide").show()},a.onclick=function(){view.hideMenus(),o.sendingFileToken}},o.addSendFile(),o.emojitimer=setTimeout(function(){try{o.loadEmoji()}catch(e){}},100),this.subscribe("getErr",function(t,i){var a=i.reqInfo,n=a&&_$(a);switch(i.code){case 16:e(".file-sending",n).html(lanRes.tooLargeUploadFail);break;case 17:e(".file-sending",n).html(lanRes.unsupportFileType);break;case 18:default:e(".file-sending",n).html(lanRes.unkownErrorUpload)}16!=i.code&&17!=i.code&&18!=i.code||o.addSendFile()});var v=!1;this.subscribe("getHistory",function(t,i){function a(e){return(!c||e-c>6e4)&&(c=e,!0)}if(o.talkId=i.talkId,o.hasGetHistory=!0,!v){v=!0,setTimeout(function(){v=!1},1e3);var n,s,r,l,d=i.chatDetailList,c=0;if(o.robotFeedbackTemp={},o.isArray(d)){o.lastMsgTM||!0,l=_$("list_msg"),r=function(t){var i,a=t.length,n=[];if(!a)return n;for(var s=0;s<a;s++)(i=e(t[s]).parents("li").results).length&&n.push(i[0]);return n}(e(".msg-error",l).results);for(var u,f=l.childNodes,m=f.length,h=0;h<m;h++)if(1==(u=f[h]).nodeType&&e(f[h]).hasClass("innerAD")){u=u.cloneNode(!0);break}l.innerHTML="",h<m&&l.appendChild(u),o.clearHistoryByTalkId(o.talkId),o.sendMsgNum=0,orderedStaffInfo={};for(g=0;g<d.length;g++)if(n=d[g],s=n,315==n.dataType&&n.data&&(864==(n=JSON.parse(n.data)).mt&&o.isInRobot&&s.feedbackResult?o.robotFeedbackTemp[s.id]={feedbackResult:s.feedbackResult,feedbackSubitem:s.feedbackSubitem}:n.relateId=s.relateId||n.relateId),!(n.mt>1e3&&"10001"!=n.mt&&"10010"!=n.mt&&"10011"!=n.mt&&"12001"!=n.mt)){if(e("#msg"+n.tm).results.length>0&&e("#msg"+n.tm).remove(),o.lastMsgTM=n.tm,n.notEnd=!0,864==n.mt)o.publish("_addSendMsgNum");else if("10001"==n.mt||"686"==n.mt){if(orderedStaffInfo=o.updateStaffInfo(void 0,{staffId:n.toStaffId||n.staffId,staffNickName:n.staffNickName||n.toStaffNickName,staffDetailInfo:n.staffDetailInfo||n.toStaffDetailInfo}),"686"==n.mt)continue}else orderedStaffInfo.staffName&&(n=e.extend(n,orderedStaffInfo));if("10001"!=n.mt)if("10011"!=n.mt)if(865!=n.mt&&641!=n.mt)if(647!=n.mt&&"10010"!=n.mt&&605!=n.mt)if(866!=n.mt&&642!=n.mt)if(680!=n.mt)if(640!=n.mt)if(655!=n.mt)if(658!=n.mt){if(890==n.mt)1==n.templateInfoList[0].type||3==n.templateInfoList[0].type?(n.content=o.getBookComfirm(n.templateInfoList),n.m=3):(n.content=o.showInfoTip({f:"sys",tip:lanRes.receiveBookForm},void 0,void 0,!0,n.talkId,n.tm,!0),n.m=4);else if("12001"==n.mt){o.publish("getMsgRobot",n);continue}var p={t:a(n.tm)?new Date(n.tm).format("hh:mm"):void 0,tm:n.tm,mt:n.mt,c:n.content,ff:o.isInRobot?"r":void 0,f:864==n.mt?"c":890==n.mt?"x":"s",m:n.m||0,id:"msg"+n.tm,talkId:i.talkId,notEnd:!0};o.showMsg(p),delete p.id,3==p.m&&(p.c=n.templateInfoList),delete p.notEnd,o.pushHistory(p)}else o.publish("orderReply",n);else o.publish("getLeaveMsg",n);else o.publish("getMsg",n);else o.publish("receiveURL",n);else o.publish("getMsgFile",n);else{if(8==n.type)continue;o.publish("getSysMsg",n)}else o.publish("getMsgImg",n);else o.publish("receiveVisEvt",n);else o.staffMap[n.toStaffId]&&o.publish("getSysMsg",{talkId:i.talkId,tm:n.tm,mt:"10001",mid:n.mid,notStore:n.notStore,notEnd:n.notEnd,staffId:n.toStaffId,staffName:o.staffMap[n.toStaffId].staffName},n)}for(var g=0;g<r.length;g++)l.appendChild(r[g]),e("img",r[g]).each(function(){e(this).attr("src",e(this).attr("src"))});if(setTimeout(function(){view.scrollToBottom(),o.isMobile&&e("#footer").removeClass("hide"),view.hideMenus(),o.wait874List=!1,o.publish("removeLoading")},10),o.isMobile&&"none"!=_$("loading").style.display&&e("#footer").addClass("hide"),view.miniShow){var b=e.store("ECHAT_"+view.chat.companyId+"_"+view.chat.visitorId+"_mid");b&&e.cookie("ECHAT_"+view.chat.companyId+"_"+window.chatVisitorId+"_mid_read",b)}}else o.wait874List=!1,o.publish("removeLoading")}}),this.subscribe("getSysMsg",function(t,i){if((o.chatting||2!=i.type)&&11!=i.type){var a;if("10001"==i.mt)return a=(i.staffName||lanRes.serviceStaff)+" "+lanRes.transferStaff,o.showInfoTip(a,"msg"+i.tm,void 0,void 0,i.talkId,i.tm,i.notEnd),i.c="10001",i.f="x",void(i.notStore&&(o.pushHistory(i),o.handleNewMsgMid(i.mid,{m:0,f:"sys",c:a},!0,i)));if("647"!=i.mt||601!=i.exType||i.exType!=(this.preMsg||{}).exType){if(this.preMsg=i,i.notStore||!i.talkId||o.talkId&&1!=i.type&&10!=i.type&&7!=i.type||(o.talkId=i.talkId,!o.hasGetHistory&&o.companyOff),10==i.type)return i.notStore||(o.talkId=i.talkId,o.robotTalkId=i.talkId),void this.publish("_showCommonQue",i);if(a=i.content||i.c){var n=(a=a.replace(/<img\b.*?(?:\>|\/>)/gi,function(e){var t=/\bsrc\b\s*=\s*[\'\"]?([^\'\"]*)[\'\"]?/i.exec(e);if(!t)return e;var i={smallImg:t=t[1],bigImg:t,sourceImg:t,fileName:lanRes.visitor175};return view.showMsgImg&&view.showMsgImg(i)||"<img "+(i.notEnd?"":'onload="javascript:view.scrollToBottom()"')+' id="img'+(i.tm||(new Date).getTime())+'" attname="'+i.fileName+'" bigimg="'+(i.bigImg||i.sourceImg||"")+'" src="'+i.smallImg+'" source="'+(i.sourceImg||"")+'" sw="'+(i.sourceWidth||"")+'" sh="'+(i.sourceHeight||"")+'" class="msg-img"/>'})).replace(/&nbsp;([^&\s])/g," $1");if(5==i.type||"s"==i.f)return i.staffId&&o.staffMap[i.staffId+""]&&(i=e.extend(i,o.staffMap[i.staffId+""])),void o._getMsg.call(this,i,0,n);if(o.showInfoTip({f:"sys",tip:a},"msg"+i.tm,void 0,void 0,i.talkId,i.tm,i.notEnd),!i.notStore){var s={tm:i.tm,f:"sys",mt:i.mt,m:0,c:a};s.talkId=i.talkId||o.talkId,o.pushHistory(s),s.c&&o.handleNewMsgMid(i.mid,s,!0,i),i&&!o.isMobile&&view.setDocumentTitle&&view.setDocumentTitle("s")}}}}}),o.hasWaitingStatus=!1,this.subscribe("getPosMsg",function(t,i){o.companyOff=!1,e("#positionInfo").remove(),o.hasWaitingStatus||(o.publish("__chatStatus","waiting"),e.cookie("ECHAT_"+o.companyId+"_"+window.chatVisitorId+"_chatStatus",1,{path:"/"}),o.hasWaitingStatus=!0,o.publish("setConfig",o.msg649),o.busyCanSend?(e(".menu-capture").removeClass("hide"),e(".menu-file").removeClass("hide")):(e(".menu-capture").addClass("hide"),e(".menu-file").addClass("hide"))),o.queueTxt=o.msg649.queueTxt||o.msg649.mobileQueueTxt||o.queueTxt,o.queueTxt&&o.showInfoTip({f:"sys",tip:o.queueTxt.replace("${waitcount}",i.position)},"positionInfo","warn",void 0,i.talkId,i.tm),o.publish("__chatQueue",i.position),o.initQcode()}),this.subscribe("inviteSatisfy",function(){o.showSatisfy(2)}),this.subscribe("staffInfo",function(t,i){o.staffName=i.staffNickName||lanRes.serviceStaff;var a=i.staffDetailInfo;a&&"string"==typeof a&&(a=JSON.parse(a)),a&&a.staffHead&&(o.needHttps&&(a.staffHead=a.staffHead.replace(/^http:/,o.needHttps)),o.paramChat.staffPhoto=a.staffHead),o.paramChat.staffPhone=a.staffPhone||"",o.paramChat.staffInfo=a.staffInfo||"",o.staffImg=a.staffHead||o.defaultStaffImg,view.initServiceInfo&&view.initServiceInfo(o,a),e(".sa-avatar").html('<img src="'+view.chat.staffImg+'"/>'),a&&o.saveHistoryStaff(o.staffImg,o.staffName),view.startChatRefreshAD&&view.startChatRefreshAD(),view.showStaffInfo&&o.staffInfoEnable&&o.staffInfoEnable.staffInfoChattingEnable&&view.showStaffInfo(),i.staffDetailInfoMsgList&&o.handleStaffMap(i.staffDetailInfoMsgList,i.notStore),o.publish("showChatStaffInfo"),o.publish("__chatStaffInfo",{staffId:o.paramChat.staffId,staffNickName:o.paramChat.staffName||"",staffPhone:o.paramChat.staffPhone,staffHead:o.staffImg,staffInfo:a.staffInfo||"",recordId:(o.isInRobot?"5_":"1_")+o.talkId})}),o.staffInfoRefreshMap={innerAD:{notEnableParam:!1,params:"[]",element:"#inner_frame",hash:!0,srcUrl:void 0,attr:"src",url:""},innerImgUrl:{attr:"href"},rightAD:null,leftAD:null,innerURL:{},merchantLink:null,staffInfo:null,urlList:null},o.subscribe("__chatStaffInfo",function(t,i){function a(t){if(t.srcUrl){var i=o.getADURL(!t.notEnableParam,t.params,t.srcUrl,view.chat.paramChat,t.hash);e(t.element).each(function(a,n){var s=i;"IFRAME"==n.tagName&&(s=view.chat.addEchatInnerFrameParam(i)),"src"==t.attr?n.src=s:"href"==t.attr?n.href=s:e(n).attr(t.attr,s)}),t.url=r}}var n,s,r;for(n in o.staffInfoRefreshMap)if(s=o.staffInfoRefreshMap[n])if(o.isArray(s))for(var l=0;l<s.length;l++)a(s[l]);else a(s);var d="media="+(view.windowType||"")+"&staffId="+(o.staffId||"")+"&staffName="+(o.staffName||"")+"&companyId="+(o.companyId||"")+"&talkId="+(o.talkId||"")+"&echatTag="+(o.queryParams.echattag||"");o.echatSourceTag=encodeURIComponent(d)}),this.subscribe("updateStaffInfo",this.updateStaffInfo),this.subscribe("chatEnded",function(t,i){var a,n=o.chatting,s=o.isInRobot,r="2"!=view.windowType&&o.queryParams.redirectUrl,l=1==i.changeRoute||1==i.closeTag;if(o.chatting=!1,o.isInRobot=0,o.hasGetHistory=!1,o.companyOff=void 0,o.staffImg=void 0,o.hasWaitingStatus=!1,o.endChatEvent(),o.publish("clearSendingMsg","endchat"),this.unSubscribe("_sendMsg"),view.toggleEnded&&view.toggleEnded("end"),e(".btn-qcode").addClass("hide"),e(".menu-capture").addClass("hide"),e(".menu-file").addClass("hide"),e("#robotToStaff").addClass("hide").hide(),o.hasEntryOrCode&&o.publish("entryCallback",{success:!0}),11!=i.type&&e(".btn-close").addClass("hide"),o.leaveAndClose&&("2"!=view.windowType&&o.queryParams.redirectUrl&&(location.href=o.queryParams.redirectUrl),e("#container").removeClass("hide"),e("#chat").removeClass("hide"),e("#footer").removeClass("hide"),e("html").removeClass("page-leave"),o.leaveAndClose=!1,o.showInfoTip('<div class="btn-restart" id="restartChat">'+lanRes.toContinueChat+"</div>",void 0,void 0,void 0,i.talkId,i.tm)),"10009"!=i.mt||4!=i.type&&10!=i.type||(o.paramChat.visEvt=o.initVisEvt,delete o.queryParams.autoPop,delete o.queryParams.autoChat),1!=i.changeRoute&&this.publish("_hideCloseBtn",i),e.cookie("ECHAT_"+o.companyId+"_"+window.chatVisitorId+"_chatStatus",0,{path:"/"}),i.justConnect)!0===n&&o.talkId&&(o.lastTalkIdForTemp=o.talkId);else{o.lastTalkIdForTemp=void 0,i.content&&o.publish("getSysMsg",i),o.hasLeaveMsg||1==i.changeRoute||i.fromHistory&&(!i.fromHistory||!1!==i.isForward||"605"!=i.mt&&"10009"!=i.mt)||(e("#restartChat").parents("li").remove(),o.showInfoTip({f:"sys",tip:'<div class="btn-restart" id="restartChat">'+lanRes.toContinueChat+"</div>"},void 0,void 0,void 0,i.talkId,i.tm)),o.visitorClose=!i.fromHistory&&(1==i.closeReason||o.visitorClose&&"0"==i.closeReason),o.toggleEvaluateMenu(1);var d=!l&&!0===n&&o.showSatisfy(1);o.postMessage(3),l||i.fromHistory||d||1==o.toLeaveWord&&o.staffChatNeedConnect||r&&"2"!=view.windowType&&o.queryParams.redirectUrl||this.publish("_closeWin",i),i.talkId?o.talkId||(o.talkId=i.talkId):i.talkId=o.talkId,a=o.talkId,i.fromHistory&&!1!==i.isForward||("10009"!=i.mt||4!=i.type&&10!=i.type||(o.talkId="",e("#list_msg").show()),i.talkId&&o.handleSessionMsg(i),view.scrollToBottom()),o.talkId=a,i.fromHistory||11==i.type||(!view.SDK&&o.publish("__chatStatus","end-"+(i.closeReason||"0")+"-"+(d&&!s?"1":"0")),(o.staffChatNeedConnect||!view.SDK&&1==o.toLeaveWord||1==i.toChat)&&setTimeout(function(){o.publish("_triggerChat")},100))}}),this.subscribe("_closeWin",function(){if(!view.SDK&&o.visitorClose&&1!=o.toLeaveWord)if(o.leaveAndClose=!1,window.EchatJsBridge&&view.hasNative&&!view.SDK)EchatJsBridge.callEchatNative(JSON.stringify({functionName:"visitorHide"}));else if(!(window.top==self&&window.EchatJsBridge||view.SDK))if(2==view.windowType)!(view.isMsgBoxChat&&view.hasNative)&&o.postMessage("hideMBmini");else if(1==view.windowType)try{window.opener=null,window.open("","_self").close(),window.close()}catch(e){try{window.close()}catch(e){}}}),this.subscribe("entryCallback",function(t,i){if(1==i.success){if(e("#entry").html("").hide(),e("#verify").hide(),e("#mask").hide(),e("body").removeClass("entry"),e("html").removeClass("entry2"),i.mid&&(delete o.queryParams.autoPop,delete o.queryParams.autoChat),o.hasEntryOrCode=!1,i.mt){o.no103=!1,o.publish("toRegisterChat");var a=o.entryParam;if(a){delete a.et,delete a.captcha;var n=e.store("ECHAT_"+o.companyId+"_ENTRY_HIS");n=n?JSON.parse(n):{},a=e.extend(n,a),e.store("ECHAT_"+o.companyId+"_ENTRY_HIS",JSON.stringify(a)),o.calcInnerADHeight&&o.calcInnerADHeight(),delete o.calcInnerADHeight}}}else o.publish("refreshVerify",{status:1})}),this.subscribe("receiveUnread",function(t,i){!view.SDKNative&&i.data.talkId&&(_$("list_msg").childNodes.length>1&&e("#list_msg").html(""),o.loadHistory(i.data.talkId)),o.talkId=i.data.talkId,o.unreadMsg?o.unreadMsg.push(i):o.unreadMsg=[i];var a,n,s,r,l=i.data.chatDetailList,d=l.length,c="",u="",f=0,m=i.data.staffDetailInfoList;if(m&&m.length&&(o.handleStaffMap(m,!1),r=o.staffMap[m[m.length-1].staffId]),d){s="downFile",o.isIOS&&(s="_blank");for(var h=0;h<d;h++)if(a=l[h],n="","686"!=l[h].mt)if("10001"!=l[h].mt){if("640"==l[h].mt||"675"==l[h].mt||"647"==l[h].mt)u=l[h].content;else if("10011"==l[h].mt){if(2==l[h].visibility)continue;2!=l[h].mst&&(l[h].staffId=void 0,l[h].staffNickName=void 0),u='<div class="clearfix custom-event-li" id="msg'+i.tm+'">'+o.getVisEvtHtml(l[h])+"</div>"}else if("641"==l[h].mt)o.needHttps&&(o.qiniuDomain&&o.qiniuHttpsDomain&&(a.bigImg=a.bigImg.replace(o.qiniuDomain,o.qiniuHttpsDomain),a.smallImg=a.smallImg.replace(o.qiniuDomain,o.qiniuHttpsDomain)),a.bigImg=a.bigImg.replace(/^http:/,o.needHttps),a.smallImg=a.smallImg.replace(/^http:/,o.needHttps)),u=view.showMsgImg&&view.showMsgImg(a)||'<img attname="'+a.fileName+'" bigimg="'+(a.bigImg||a.sourceImg||"")+'" src="'+a.smallImg+'" class="msg-img"/>';else if("642"==l[h].mt)n="unread-file",o.needHttps&&(o.qiniuDomain&&o.qiniuHttpsDomain&&(a.fileUrl=a.fileUrl.replace(o.qiniuDomain,o.qiniuHttpsDomain)),a.fileUrl=a.fileUrl.replace(/^http:/,o.needHttps)),u='<div class="file-info"><div class="file-name">'+a.fileName+'</div><a class="file-size file-link" href="'+a.fileUrl+(!a.fileUrl||!a.fileUrl.match(/http[s]?:\/\/[^\/]*(qn|qiniu)[^\/]*\//i)&&a.fileUrl.match(/http[s]?:\/\/[^\/]*(oss)[^\/]*\//i)?"":(-1==a.fileUrl.indexOf("?")?"?":"&")+"attname="+a.fileName)+'" target="'+s+'"><span class="unread-size">'+(parseInt(a.fileSize/1024)+1)+'KB</span><span class="unread-download color0">'+lanRes.download+'</span></a></div><div class="file-icon">&nbsp;</div>';else if("10012"==l[h].mt);else if(680==l[h].mt){var p=l[h].pushUrlDetail.url,g="";if(view.chat.needHttps&&p.match(/^http:/i)&&(g=" push-blank"),view.pushURLParam){var v=p.split("#");p=v[0]+(-1==v[0].indexOf("?")?"?":"&")+view.pushURLParam+(v[1]?"#"+v[1]:"")}u='<a class="push-url clearfix'+g+'" target="info_frame3" href="'+p+'"><div class="push-icon echat bg1"></div><div class="push-content"><div class="push-name">'+l[h].pushUrlDetail.urlName+' </div><div class="push-url-link">'+l[h].pushUrlDetail.url+"</div></div></a>"}f++,u=680==l[h].mt?u:o.filterEmailPhoneLink(u),(u=(o.filterEmo(u)||"").replace(/\n/g,"</br>"))&&(r&&a.staffId&&a.staffId!=r.staffId&&(a.staffId=r.staffId),a.staffId&&o.staffMap[a.staffId]?(a.staffImg=o.staffMap[a.staffId].staffImg||o.defaultStaffImg,a.staffName=o.staffMap[a.staffId].staffName||a.staffNickName,o.needHttps&&a.staffImg&&(a.staffImg=a.staffImg.replace(/^http:/,o.needHttps)),c+='<li class="clearfix list-unread-li '+n+'"><div class="avatar-icon fl staff-icons"><img class="avatar-icon-img" src="'+a.staffImg+'"></div><div class="fl unread-staff-name">'+(a.staffName||lanRes.serviceStaff)+'：</div><div class="fl unread-msg">'+u+"</div></li>"):c+='<li class="clearfix list-unread-li '+(n="list-unread-sys")+'"><div class="avatar-icon fl staff-icons"><img class="avatar-icon-img" src="'+o.defaultStaffImg+'"></div><div class="fl unread-staff-name">'+lanRes.serviceSys+'：</div><div class="fl unread-msg">'+u+"</div></li>")}else r=o.updateStaffInfo(void 0,{staffId:a.toStaffId||a.staffId,staffNickName:a.staffNickName||a.toStaffNickName,staffDetailInfo:a.staffDetailInfo||a.toStaffDetailInfo});else a.staffDetailInfoList&&o.handleStaffMap(a.staffDetailInfoList,!1),a.staffDetailInfo&&(r=o.updateStaffInfo(void 0,a));e("#list_unread").append(c),view.showUnread&&view.showUnread(f)}}),e("#unread_close").on("click",function(){view.removeUnreadMsg&&view.removeUnreadMsg()}),e("#leave_tip").on("click",function(){o.tipTimer&&clearTimeout(o.tipTimer),e(this).addClass("tiphide")}),this.changeDocTitle=function(){if("title"in t)return function(e){t.title=e};var e,i=_$s("title");return i&&i[0]?e=i[0]:(e=t.createElement("title"),_$s("head")[0].appendChild(e)),"textContent"in e?function(e){_$s("title")[0].textContent=e}:"innerText"in e?function(e){_$s("title")[0].innerText=e}:function(){}}()},configToolMenus:function(t){t||(t={});var i=4;"1"!=t.toolEmoji?(e(".menu-emo").addClass("hide-important"),i--):e(".menu-emo").removeClass("hide-important"),"1"!=t.toolFile?(e(".menu-file").addClass("hide-important"),i--):e(".menu-file").removeClass("hide-important"),"1"!=t.toolSatisfaction?(e(".menu-satisfy").addClass("hide-important"),i--):e(".menu-satisfy").removeClass("hide-important"),e(".menu-capture").length>0&&("1"!=t.toolScreenshot?(e(".menu-capture").addClass("hide-important"),i--):e(".menu-capture").removeClass("hide-important")),e(".menu-phone").length>0&&("1"!=t.toolTelephone?(e(".menu-phone").addClass("hide-important"),i--):e(".menu-phone").removeClass("hide-important")),0==i?(e("#menu-tools").addClass("hide-important"),e("#container").addClass("menu-no-tools")):(e("#menu-tools").removeClass("hide-important"),e("#container").removeClass("menu-no-tools"))},plainTextToSendMsg:function(e){var t=this;return charMap={"<":"&lt;",">":"&gt;",'"':"&quot;"},e=e.replace(/\[#([^#]+)#\]/g,function(e,i){return"[#"+(t.lanEmo[i]||i)+"#]"}).replace(/[<">]/g,function(e){return charMap[e]})},openVisitorSend:function(){var t=this;this.unSubscribe("_sendMsg"),this.subscribe("_sendMsg",function(i,a){if(!view.handleNetwok||!view.handleNetwok())if(t.isInRobot||!0===t.companyOff||t.busyCanSend||"0"==t.queryParams.autoChat||!0===t.chatting){var n=a||t.getInput(!0);if(n.trim())if(n.match(/^\[#echat::lihong#\]$/))t.loadConsole(7304);else{t.plainText&&(n=t.plainTextToSendMsg(n));var s=(new Date).getTime(),o="msg"+s,r={t:t.checkHistoryTime(s)?(new Date).format("hh:mm"):void 0,tm:s,mt:864,f:"c",m:0,c:n,id:o};t.sendToServer(r),a||(t.lastText=null,view.afterSend()),t.publish("_firstSendMsg",{c:n}),t.publish("_addSendMsgNum")}}else e("#busyTipLine").removeClass("hide").show()})},postMessage:function(e){if(!this.doNotHasPostMessage&&2==view.windowType&&window.top!=self)try{return window.parent.postMessage(e,this.queryParams.fromhost||"*"),!0}catch(e){this.doNotHasPostMessage=!0,console.log(e)}return!1},getVisitorMessage:function(){},initDialog:function(){var t=this;t.hasInitDialog||(t.hasInitDialog=!0,e("body").on("click",".dialog-close",function(){e(".dialog").remove(),t.publish("_dialogCanel")}).on("click",".img-close",function(){e(".dialog").remove(),t.publish("_dialogCanel")}).on("click",".dialog-cancel",function(){e(".dialog").remove(),t.publish("_dialogCanel")}).on("click",".dialog-ok",function(){e(".dialog").remove(),t.publish("_dialogOk")}))},showDialog:function(t){function i(t){var s=e(".dialog").results,o=e(".dialog-ok").results[0],r=e(".dialog-cancel").results[0],l=e(".dialog-close").results[0];if(0==s.length)e("body").off(n,i);else{var d=t.srcElement||t.target;setTimeout(function(){o==d||e.fn.contains(o,d)?(a.publish("_dialogOk"),e(".dialog").remove()):(r==d||e.fn.contains(r,d)||l==d||e.fn.contains(l,d))&&(a.publish("_dialogCanel"),e(".dialog").remove())},50)}}var a=this,n=a.isMobile?"tap":"click";e(".dialog").remove(),this.publish("_dialogCanel"),a.initDialog();var s=t.tip,o='<div class="dialog dialog-hide"><div class="dialog-close"><i class="img-close"></i></div><div class="dialog-title">'+lanRes.tip+'</div><div class="dialog-content">'+s+'</div><div class="dialog-btns"><a class="dialog-btn dialog-ok bg0"><div class="bg0 fade-div"></div><span>'+(t.okTip||lanRes.okay)+"</span></a>"+(!1!==t.cancel?'<a class="dialog-btn dialog-cancel bg0 has-fade"><div class="bg0 fade-div"></div><span>'+lanRes.cancel+"</span></a>":"")+"</div></div>";e(_$("index")||"body").append(o),a.unSubscribe(["_dialogOk","_dialogCanel"]),a.subscribe("_dialogOk",function(){e("body").off(n,i),t.ok&&t.ok(),a.unSubscribe(["_dialogOk","_dialogCanel"])}),a.subscribe("_dialogCanel",function(){e("body").off(n,i),t.cancel&&t.cancel(),a.unSubscribe(["_dialogOk","_dialogCanel"])}),setTimeout(function(){e("body").on(n,i),e(".dialog").removeClass("dialog-hide")},10),view.inputBlur&&view.inputBlur(void 0,1)},showAlertDialog:function(t){function i(t){var n=e(".dialog").results,s=e(".dialog-ok").results[0];0==n.length?e("body").off(a.isMobile?"tap":"click",i):setTimeout(function(){(s==t.target||e.fn.contains(s,t.target))&&(a.publish("_dialogOk"),e(".dialog").remove())},50)}e(".dialog").remove();var a=this;a.initDialog();var n=t.tip,s='<div class="dialog dialog-hide"><div class="dialog-title">'+lanRes.tip+'</div><div class="dialog-content">'+n+'</div><div class="dialog-btns"><a class="dialog-btn dialog-ok bg0"><div class="bg0 fade-div"></div><span>'+(t.okTip||lanRes.okay)+"</span></a></div></div>";e("body").append(s),e("#mask").show(),setTimeout(function(){e("#mask").show()},100),a.unSubscribe(["_dialogOk"]),a.subscribe("_dialogOk",function(){e("body").off(a.isMobile?"tap":"click",i),t.ok&&t.ok(),a.unSubscribe(["_dialogOk"]),e("#mask").hide()}),setTimeout(function(){e("body").on(a.isMobile?"tap":"click",i),e(".dialog").removeClass("dialog-hide")},10)},getOrderSettingsByFields:function(e,t,i,a){for(var n,s,o,r={},i=i||"default",l=0;l<t.length;l++){if(n=r[t[l].field]=t[l],s=null,n.settings&&n.settings.length>0)if(1==n.settings.length)n.configs=n.settings[0].configs;else{for(var d=0;d<n.settings.length;d++){if(n.settings[d].lan==i){n.configs=n.settings[d].configs;break}"default"==n.settings[d].lan&&(s=n.settings[d].configs)}!n.configs&&(n.configs=s||n.settings[0].configs)}t[l].field===e&&(o=t[l])}a&&a(r,o,s)},toShowOrderSubmit:function(i){e(window).on("resize",function(){var e=t.activeElement;"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||setTimeout(function(){e.scrollIntoViewIfNeeded()},100)});var a=this,n="",s="",o=[],r=i.jobWindowInfo,l=r.configuration;o.push(1!=view.windowType||view.dji?"entry2-mb":"entry2-pc"),!a.isMobile&&a.mini&&o.push("entry2-pc-mini"),o.push("entry2-form"),e("#orderSubmit")&&e("#orderSubmit").remove(),!view.SDKNative&&a.addCSS(a.isMobile&&!view.dji?__uri("/visitor/common/css/entry2.css"):__uri("/visitor/common/css/entry2pc.css"));for(var d='<div id="orderSubmit" class="{{entryClass}} order-form"><header class="ordertitle"><div class="margin-b5" style="font-size: 14px;">{{title}}</div><div class="order-tip">{{description}}</div></header><div class="entry2-wrap entry2-items order-content"><form id="orderForm">{{element}}</form><span class="order-button magr0 bg-c order-upload-button"><form class="order-upload" name="orderUploadForm" id="orderUploadForm" enctype="multipart/form-data" method="post"><input type="file" title="'+lanRes.visitor189+'" name="file" id="orderUpload">'+lanRes.visitor189+'</form></span><div id="orderFileslist" class="order-fileslist"></div><div class="order-tip">'+lanRes.visitor178+'</div></div><footer class="order-footer"><span class="order-submit order-button bg0">{{submit}}</span></footer></div>',c='<div class="entry2-item"><div class="entry2-label {{req}}"><span class="req-span">*</span><span class="entry2-name">{{configDesc}}:</span></div><div class="entry2-typeline {{req}}" lb="{{configDesc}}">{{typeline}}</div></div>',u=0;u<l.length;u++)var f=l[u],m=a.getOrderSettingsByFields(f.configName,r.fieldSettings,f.lan,function(e,t,i){var o=(m=t).type;n=a.getElementByFieldType(e,o,f,""),s+=c.replace("{{typeline}}",n).replace(/\{\{configName\}\}/g,f.configName).replace(/\{\{configDesc\}\}/g,f.configDesc).replace(/\{\{wordDesc\}\}/g,f.wordDesc).replace(/\{\{value\}\}/g,"").replace(/\{\{req\}\}/g,1==f.configRequired?"req":"")});var h=view.SDKNative?"jpg，png，gif，bmp，avi，mov，rmvb，rm，flv，mp4，3gp":"jpg，png，gif，txt，rar，zip，doc，docx，xls，xlsx，bmp，avi，mov，rmvb，rm，flv，mp4，3gp";if(s=d.replace("{{entryClass}}",o.join(" ")).replace("{{element}}",s).replace(/\{\{title\}\}/g,r.title).replace(/\{\{description\}\}/g,r.description).replace(/\{\{cancel\}\}/g,lanRes.cancel).replace(/\{\{uploadFileSize\}\}/g,a.uploadFileSize/1024/1024).replace(/\{\{filesTip\}\}/g,h).replace(/\{\{submit\}\}/g,lanRes.submit),1==view.windowType?e("#leave").html(s).removeClass("hide"):e("body").append(s),a.publish("removeLoading"),this.isMobile&&e("#orderSubmit").off("click").bind("click","img",function(e){setTimeout(function(){view.showImg.call(this,"orderFileslist",e)},500)}),a.isMobile||1!=view.windowType||view.dji)self===window.top&&(e(".btn-close").addClass("hide"),setTimeout(function(){e(".btn-close").addClass("hide")},100)),e("#container").addClass("hide");else{e("#chat").addClass("hide"),e("#orderSubmit footer").remove(),window.opener||(e(".btn-close").addClass("hide"),setTimeout(function(){e(".btn-close").addClass("hide")},100));var p='<div class="order-submit order-button bg0">'+lanRes.submit+"</div>";e(".leave-entry-foot").html(p)}e("html").addClass("page-leave entry2"),e("#footer").addClass("hide"),setTimeout(function(){e("#mask").hide()},100),e("#orderUpload").off("click").bind("click",function(e){e.stopPropagation()}),view.SDKNative?view.bindOrderUpload(".order-upload-button","#orderUpload"):a.orderUploadFile(),a.addOrderSubmitEvent(l,".order-submit")},orderUploadFile:function(){var i=this,a=t.getElementById("orderUpload"),n=["jpg","png","gif","bmp"],o=["txt","rar","zip","doc","docx","xls","xlsx"],r=["avi","mov","rmvb","rm","flv","mp4","3gp"];a.onchange=function(){function t(t,a,n){var s,o={smallImg:t||"",bigImg:t||"",sourceImg:t||"",fileName:lanRes.visitor175},r=0;switch(p){case"0":r="orderfile-icon",s='<a class="order-img" target="_blank"></a>';break;case"2":r="ordervideo-icon",s=i.isMobile?'<div class="order-img">':'<a class="order-img" target="_blank"></a>';break;case"4":r="orderimg-icon",s=view.showMsgImg&&view.showMsgImg(o)||'<img id="img'+(new Date).getTime()+'" src="'+o.smallImg+'" class="msg-img"/>'}var d=('<div dataindex="{{dataindex}}" class="{{classType}} load">{{fimg}}'+(2==p?"<i class='ordervideo-text'>VIDEO</i>":"")+'<span class="orderfile-name" title="{{fname}}">{{fname}}</span><i class="orderfile-del"></i><i class="orderfile-progress-num"></i><i class="orderfile-progress"></i></div>').replace(/\{\{classType\}\}/g,r).replace(/\{\{dataindex\}\}/g,n).replace(/\{\{fname\}\}/g,a).replace(/\{\{fimg\}\}/g,s);e(".order-fileslist").append(d),function(e){lastUploadFile=u;var t=i.msg649&&i.msg649.jobWindowInfo||{};g={token:t.token||"",nonce:t.nonce||"",fileType:p,tokenNum:1},l(1,e,e)}(n)}function l(t,n,o){2==t&&g&&delete g.fileType;var r=1==t?"/chatapi/jobh/gqt":"/chatapi/jobh/gat";e.ajax({url:i.dataHost+r+"?companyId="+i.companyId+"&requesterVisitorId="+i.visitorId+i.addMapParams(g),type:"jsonp",jsonpCB:"jsonpCallback",success:function(r){if(r.successful){var d=r.result.data[0],c=d.token||d.signature;e(".order-fileslist > div[dataindex='"+n+"']").attr("dataindex",c),i.orderFileIndexObj[c]=o,function(t,n){var o=new FormData;1==n?(o.append("key",t.qiniuKey),o.append("token",t.token)):2==n&&(o.append("key",t.aliyunKey),o.append("policy",t.policy),o.append("callback",t.callback),o.append("success_action_status",200),o.append("signature",t.signature),o.append("OSSAccessKeyId",t.ossAccessKeyId),o.append("x:filename",u.name),o.append("x:companyid",i.companyId),o.append("x:visitorId",i.visitorId),o.append("x:filetype",p));o.append("file",a.files[0]);var r=new XMLHttpRequest;r.open("POST",t.uploadUrl,!0),r.onerror=r.ontimeout=function(){if(1==n){var a=i.orderFileIndexObj[t.token||t.signature];l(2,t.token,a)}else 2==n&&(_$("leave_tip_con").innerHTML=lanRes.visitor181,e(".order-fileslist > div[dataindex='"+t.signature+"']").remove(),s())},r.upload.onprogress=function(i){if(i.lengthComputable){var a=parseInt(i.loaded/i.total*100)+"%";e(".order-fileslist > div[dataindex='"+(t.token||t.signature)+"'] .orderfile-progress-num").html(a),e(".order-fileslist > div[dataindex='"+(t.token||t.signature)+"'] .orderfile-progress").css("width",a)}};var d=i.orderFileIndexObj[t.token||t.signature];i.orderSubAttachments[d].xhr=r,r.addEventListener("load",function(n){var o=t.token||t.signature,l=i.orderFileIndexObj[o];if(200==r.status&&r.responseText){var d=JSON.parse(r.responseText);i.orderSubAttachments[l].type=1,i.orderSubAttachments[l].fileValue={name:d.fname,url:d.sourceUrl,fileType:d.fileType,key:d.key,bucket:d.bucket},delete i.orderSubAttachments[l].xhr,function(t,a){var n=a.sourceUrl&&a.sourceUrl.indexOf("?")>0?"&":"?";downloadUrl=a.sourceUrl+n+"attname="+encodeURIComponent(a.fname),e(".order-fileslist > div[dataindex='"+t+"']").removeClass("load"),e(".order-fileslist > div[dataindex='"+t+"'] .orderfile-progress-num").html(""),0==a.fileType?e(".order-fileslist > div[dataindex='"+t+"'] .order-img").attr("href",a.sourceUrl):2==a.fileType?i.isMobile?e(".order-fileslist > div[dataindex='"+t+"'] .order-img").attr("onclick","view.__playVideo('"+a.sourceUrl+"','','"+downloadUrl+"','"+(a.fname||"")+"','"+(a.key||"")+"')"):e(".order-fileslist > div[dataindex='"+t+"'] .order-img").attr("href","/visitor/pc/video.html?videoUrl="+encodeURIComponent(a.sourceUrl)):4==a.fileType&&(e(".order-fileslist > div[dataindex='"+t+"'] img").attr("attname",a.fname).attr("src",a.sourceUrl).attr("source",a.sourceUrl),view.handleMessage&&e(".order-fileslist > div[dataindex='"+t+"'] img").attr("onclick","javascript:view.handleMessage('"+a.sourceUrl+'\',"orderFileslist")'))}(o,d),a.value=null,e(".order-fileslist > div .orderfile-del").off("click").bind("click",function(t){var a=this,n=e(this).context.parentElement.getAttribute("dataindex"),o=i.orderFileIndexObj[n],r=i.msg649&&i.msg649.jobWindowInfo||{},l={token:r.token||"",nonce:r.nonce||"",key:d.key,bucket:d.bucket};i.showDialog({tip:lanRes.visitor191,ok:function(){e.ajax({url:i.dataHost+"/chatapi/jobh/df?companyId="+i.companyId+"&requesterVisitorId="+i.visitorId+i.addMapParams(l),type:"jsonp",jsonpCB:"jsonpCallback",success:function(t){e(a).context.parentElement.remove(),s(lanRes.visitor182,"ok"),e(".order-upload-button").css("display","inline-block"),i.orderSubAttachments.splice(o,1),function(){i.orderFileIndexObj={};for(var t=e(".order-fileslist > div").results||[],a=0;a<t.length;a++)t[a].getAttribute("dataindex").length>1&&(i.orderFileIndexObj[t[a].getAttribute("dataindex")]=a)}()}})},cancel:function(){}})})}}),r.send(o)}(d,t)}},error:function(){i.showTip(lanRes.visitor181),setTimeout(function(){i.orderSubAttachments.splice(o,1),e(".order-fileslist > div[dataindex='"+n+"']").remove()},500)}})}var d=a.value||a.getAttribute("value");if(i.orderSubAttachments.length>=5)return i.isMobile?s(lanRes.visitor179):i.showDialog({tip:lanRes.visitor180,cancel:!1}),a.value=null,!1;if(!d)return console.log("no file to send",d),!1;for(var c,u=d,f=(a.files||[{}]).length,m=0;m<f;m++){if(function(e){for(var t=!1,a=0;a<i.orderSubAttachments.length;a++){var n=i.orderSubAttachments[a];e.size==n.fileInfo.size&&e.name==n.fileInfo.name&&e.type==n.fileInfo.type&&(s(lanRes.visitor185),t=!0)}return t}(a.files[m]))return f-1===m&&(a.value=null),!1;if(a.files){if(!a.files[m]||!a.files[m].size){console.log("no file to send",d);continue}(a.files[m]||a.files[m].name)&&(d=a.files[m].name)}c=-1!=d.indexOf(".")?d.replace(/.*\./,""):"";var h=d.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1");if(i.sendingTitle=h+"."+c+lanRes.fileSendWait,c&&-1===n.indexOf(c)&&-1===o.indexOf(c)&&-1===r.indexOf(c))i.showDialog({tip:"ERROR: "+lanRes.unsupportFileType+"。</br>"+lanRes.supportFileType+": jpg、png、gif、bmp、txt、rar、zip、doc、docx、xls、xlsx、avi、mov、rmvb、rm、flv、mp4、3gp",cancel:!1});else{if(i.getFileSize(a,m)>i.uploadFileSize)i.showDialog({tip:lanRes.fileSizeOut.replace("${maxSize}",i.uploadFileSize/1024/1024+"M"),cancel:!1}),i.handleFileSelect.error();else{a.files&&(u=a.files[m]);var p=-1!==n.indexOf(c)?"4":-1!==r.indexOf(c)?"2":"0",g={};!function(a){4==p?function(e,t){if(t&&e&&e.type.indexOf("image/")>-1){var i=new FileReader;i.onload=function(i){t({file:e,base64:i.target.result})},i.readAsDataURL(e)}else t&&t(null)}(u,function(e){e&&t(e.base64,e.file.name,a)}):t("",u.name,a),i.orderSubAttachments.push({fileInfo:u}),5===i.orderSubAttachments.length&&e(".order-upload-button").hide()}(i.orderSubAttachments.length),view.hideMenus&&view.hideMenus(0,!1)}}}},a.onclick=function(){view.hideMenus(),i.sendingFileToken}},getElementByFieldType:function(e,t,i,a){var n="",s={type1:'<input type="text" class="entry2-input {{req}}" maxlength="{{length}}" placeholder="{{wordDesc}}" lb="{{configDesc}}" name="{{configName}}" value="{{value}}"/>',type6b:'<input type="date" class="entry2-input {{req}}" placeholder="{{wordDesc}}" lb="{{configDesc}}" name="{{configName}}" value="{{value}}"/>',type6:'<div class="date-input-box"><input type="text" lb="{{configDesc}}" placeholder="{{wordDesc}}" class="entry2-input date-show"/><input type="date" lb="{{configDesc}}" placeholder="{{wordDesc}}" name="{{configName}}" value="{{value}}" class="entry2-input date-input"/><span class="date-select-icon echat-vs color0">&#xe638;</span></div>',type2:'<textarea class="entry2-textarea {{req}}" maxlength="{{length}}" rows="4" placeholder="{{wordDesc}}" lb="{{configDesc}}" name="{{configName}}" autoHeight="true">{{value}}</textarea>',type4:'<div class="entry2-checkbox"><label><input name="{{configName}}" value="{{configs.value}}" lb="{{configDesc}}" type="radio" {{check}} /><span class="entry2-checkicon color0"></span><span>{{configs.item}}</span></label></div>',type5:'<div class="entry2-checkbox"><label><input name="{{configName}}" value="{{configs.value}}" lb="{{configDesc}}" type="checkbox" {{check}} /><span class="entry2-checkicon color0"></span><span>{{configs.item}}</span></label></div>',type3:'<option value="" selected disabled style="display: none;">{{wordDesc}}</option><option value="{{configs.value}}" {{check}} >{{configs.item}}</option>',type7:'<option value="" selected disabled style="display: none;">{{wordDesc}}</option><option value="{{configs.value}}" {{check}} >{{configs.item}}</option>'};if(n=s["type"+t],6==t&&(window.ltIE10||this.isMobile))n=s.type6b;else if(4==t||5==t||3==t||7==t){if(configs=e[i.configName].configs,n=[],a=a?a.split(","):a,3==t||7==t){if(7==t){for(var o=[],r=configs.start;r<=configs.end&&(o.push({item:r,value:r}),150!=o.length);r+=configs.stepSize);configs=o}n.push('<select class="entry2-select {{req}}" name="{{configName}}" lb="{{configDesc}}"><option value=""></option>')}for(var l=0;l<configs.length;l++)n.push(s["type"+t].replace(/\{\{configs.item\}\}/g,configs[l].item).replace("{{configs.value}}",configs[l].value).replace("{{check}}",a&&indexOfArr(a,configs[l].value)?3==t||7==t?"selected":"checked":""));3!=t&&7!=t||n.push("</select>"),n=n.join("")}else 1!=t&&2!=t||(n=n.replace("{{length}}",(d[i.configName]||d[1==t?"text":"textarea"]).length));return n},toShowEntry:function(i,a){e(window).on("resize",function(){var e=t.activeElement;"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||setTimeout(function(){e.scrollIntoViewIfNeeded()},100)});var n,s,o,l,d,c=this,u="",f="",m=[],h={},p=!1,g=i.fieldSettings||[],v=c.msg600.lan||i.lan||"default",b=decodeURIComponent(e.store("ECHAT_"+c.companyId+"_ENTRY_HIS")||"{}");if(!view.SDKNative&&c.addCSS(c.isMobile&&!view.dji?__uri("/visitor/common/css/entry2.css"):__uri("/visitor/common/css/entry2pc.css")),e("#entry").remove(),view.dji&&1==i.entranceLevel)return!1;if(b=JSON.parse(b),1!=i.entranceLevel&&!0===c.companyOff&&0==i.offlineStartType&&(i.entranceLevel=1,p=!0,g=[{enable:1,field:"gender",fieldId:7106,isSystem:1,label:"性别",lan:"default",settings:[{configs:[{item:lanRes.male,sort:1,value:"1"},{item:lanRes.female,sort:2,value:"2"}],lan:"default"}],type:4,configs:[{item:lanRes.male,sort:1,value:"1"},{item:lanRes.female,sort:2,value:"2"}]},{enable:1,field:"maritalStatus",fieldId:7107,isSystem:1,label:"婚否",lan:"default",settings:[{configs:[{item:lanRes.married,sort:1,value:"2"},{item:lanRes.unmarried,sort:2,value:"1"}],lan:"default"}],type:4,configs:[{item:lanRes.married,sort:1,value:"2"},{item:lanRes.unmarried,sort:2,value:"1"}]},{enable:1,field:"age",fieldId:7109,isSystem:1,label:"年龄",lan:"default",settings:[{configs:{end:127,start:1,stepSize:1},lan:"default"}],type:7,configs:{end:127,start:1,stepSize:1}},{enable:1,field:"birthday",fieldId:7108,isSystem:1,label:"生日",settings:[],type:6}],i.upgradeOfflineVisitorInfoConfiguration=i.offlineVisitorInfoConfiguration,i.upgradeOfflineWelcomeWord=i.offlineWelcomeWord),1==i.entranceLevel){var y='<div class="entry2-item"><div class="entry2-label {{req}}"><span class="req-span">*</span><span class="entry2-name">{{configDesc}}:</span></div><div class="entry2-typeline {{req}}" lb="{{configDesc}}">{{typeline}}</div></div>';l=(o=!0===c.companyOff?i.upgradeOfflineVisitorInfoConfiguration:i.upgradeVisitorInfoConfiguration)&&o.length||0,!0===c.companyOff&&(i.upgradeVisitorInfoSubmitTxt=i.upgradeOfflineVisitorInfoSubmitTxt,i.upgradeWelcomeWord=i.upgradeOfflineWelcomeWord),m.push(1!=view.windowType||view.dji?"entry2-mb":"entry2-pc"),!c.isMobile&&c.mini&&m.push("entry2-pc-mini"),m.push(!0===c.companyOff&&0==i.offlineStartType?"entry2-form":"entry2-half");for(var w=h,I=0;I<g.length;I++)if(N=w[g[I].field]=g[I],N=g[I],s=null,N.settings&&N.settings.length>0)if(1==N.settings.length)N.configs=N.settings[0].configs;else{for(var k=0;k<N.settings.length;k++){if(N.settings[k].lan==v){N.configs=N.settings[k].configs;break}"default"==N.settings[k].lan&&(s=N.settings[k].configs)}!N.configs&&(N.configs=s||N.settings[0].configs)}for(var T=0;T<l;T++)if(0==(n=o[T]).configWebVipVisitor&&c.isVip||0==n.configWebVisitor&&!c.isVip)n.disabled=!0;else{if(!h[n.configName]){if(!p){n.disabled=!0;continue}h[n.configName]={type:1}}var S=h[n.configName].type,C=b[n.configName];u=c.getElementByFieldType(h,S,n,C),f+=y.replace("{{typeline}}",u).replace(/\{\{configName\}\}/g,n.configName).replace(/\{\{configDesc\}\}/g,n.configDesc).replace(/\{\{wordDesc\}\}/g,"").replace(/\{\{value\}\}/g,C||"").replace(/\{\{req\}\}/g,1==n.configRequired?"req":"")}return!0===c.companyOff&&0==i.offlineStartType&&(f+=y.replace(/\{\{req\}\}/g,"req").replace(/\{\{configDesc\}\}/g,lanRes.leaveWordContent).replace("{{typeline}}",'<textarea rows="4" lb="'+lanRes.leaveWordContent+'" autoHeight="true"  class="entry2-textarea leave-entry-text req"></textarea>')),1==i.captChaEnable&&(f+=y.replace(/\{\{req\}\}/g,"req").replace(/\{\{configDesc\}\}/g,lanRes.validateCode).replace("{{typeline}}",'<input type="text" id="verify_input" lb="'+lanRes.validateCode+'" class="entry2-input entry2-input-code req" /><img alt="'+lanRes.validateCode+'" id="verify_img" src="'+c.dataHost+"/chatCaptCha.jpg?captChatToken="+a.captChaToken+'"/><span class="color0 cursor-p" id="verify_change">'+lanRes.nextPic+"</span>"),e(".verify-change").attr("id",""),e(".verify-img").attr("id",""),e(".verify-ok").attr("id",""),e(".verify-input").attr("id","")),f='<div id="entry" class="{{entryClass}}"><form id="entryForm" class="entry2-wrap"><div class="entry2-title bg0">{{upgradeWelcomeWord}}</div><div class="entry2-content"><div class="entry2-items">{{list}}</div>{{btns}}</form></div>'.replace("{{entryClass}}",m.join(" ")).replace("{{list}}",f).replace("{{upgradeWelcomeWord}}",i.upgradeWelcomeWord).replace("{{btns}}",1!=view.windowType||view.dji||!0!==c.companyOff||0!=i.offlineStartType?'<div class="entry2-submit"><div class="entry2-btn-submit bg0">{{upgradeVisitorInfoSubmitTxt}}</div></div></div>':"").replace("{{upgradeVisitorInfoSubmitTxt}}",!0===c.companyOff&&0==i.offlineStartType?lanRes.submit:i.upgradeVisitorInfoSubmitTxt).replace("{{close}}",lanRes.close).replace("{{submit}}",lanRes.submit),!0===c.companyOff&&0==i.offlineStartType?(c.leaveAndClose=!0,view.showLeavePage?view.showLeavePage(i):function(t,a){e(".verify-change").attr("id",""),e(".verify-img").attr("id",""),e(".verify-ok").attr("id",""),e(".verify-input").attr("id",""),1!=view.windowType||view.dji?e("body").append(t):e("#leave").html(t).removeClass("hide"),c.publish("removeLoading"),c.isMobile||1!=view.windowType||view.dji?e("#container").addClass("hide"):(e("#chat").addClass("hide"),e(".btn-close").addClass("hide"),setTimeout(function(){e(".btn-close").addClass("hide")},100)),e("html").addClass("page-leave entry2"),e("#footer").addClass("hide"),setTimeout(function(){e("#mask").hide()},100),view.toLeaveMessage&&view.toLeaveMessage(),c.addEntryEvent({list:o,configData:i,submitSelector:a,crm20:h})}(f,1!=view.windowType||view.dji||!0!==c.companyOff||0!=i.offlineStartType?".entry2-btn-submit":".leave-enter-btn"),e("textarea[autoHeight]").autoHeight(),!0):(e("body").append(f),e("html").addClass("entry2"),c.addEntryEvent({list:o,configData:i,submitSelector:".entry2-btn-submit",crm20:h}),e(".entry2-btn-close").on("click",function(e){c.visitorClose=!1,c.publish("_endChat"),c.publish("chatEnded",{}),(c.hasEntryOrCode||"0"==c.queryParams.autoChat)&&(c.publish("entryCallback",{success:!0}),c.publish("_endConnect")),delete c.queryParams.autoPop,delete c.queryParams.autoChat}),c.publish("removeLoading"),e("#mask").show(),e("textarea[autoHeight]").autoHeight(),!0)}l=(o=(!0===c.companyOff?i.offlineVisitorInfoConfiguration:i.visitorInfoConfiguration)||[])&&o.length||0,d=1!=i.captChaEnable&&r(o),c.needHttps&&i.visitorInfoBackImg&&(i.visitorInfoBackImg=i.visitorInfoBackImg.replace(/^http:/,c.needHttps)),i=e.extend({},i),!0===c.companyOff&&(i.welcomeWord=i.offlineWelcomeWord,i.welcomeWordPos=i.offlineWelcomeWordPos,i.entryCanClose=i.offlineEntryCanClose,i.visitorInfoCloseImg=i.offlineVisitorInfoCloseImg,i.visitorInfoClosePos=i.offlineVisitorInfoClosePos,i.visitorInfoFormPos=i.offlineVisitorInfoFormPos,i.visitorInfoBackImg=i.offlineVisitorInfoBackImg,i.visitorInfoLabelColor=i.offlineVisitorInfoLabelColor,i.visitorInfoInputColor=i.offlineVisitorInfoInputColor,i.visitorInfoSubmitPos=i.offlineVisitorInfoSubmitPos,i.visitorInfoSubmitTxt=i.offlineVisitorInfoSubmitTxt,i.buttonBackgroundColor=i.offlineButtonBackgroundColor,i.visitorInfoBackgroundColor=i.offlineVisitorInfoBackgroundColor,i.visitorInfoSubmitImg=i.offlineVisitorInfoSubmitImg),c.needHttps&&(i.visitorInfoCloseImg&&(i.visitorInfoCloseImg=i.visitorInfoCloseImg.replace(/^http:/,c.needHttps)),i.visitorInfoBackImg&&(i.visitorInfoBackImg=i.visitorInfoBackImg.replace(/^http:/,c.needHttps)),i.visitorInfoSubmitImg&&(i.visitorInfoSubmitImg=i.visitorInfoSubmitImg.replace(/^http:/,c.needHttps))),view.staticPx2rem&&(i.welcomeWordPos=i.welcomeWordPos&&view.staticPx2rem(i.welcomeWordPos),i.visitorInfoClosePos=i.visitorInfoClosePos&&view.staticPx2rem(i.visitorInfoClosePos),i.visitorInfoFormPos=i.visitorInfoFormPos&&view.staticPx2rem(i.visitorInfoFormPos),i.visitorInfoSubmitPos=i.visitorInfoSubmitPos&&view.staticPx2rem(i.visitorInfoSubmitPos));for(var x=' <div id="entryWrap" class="'+("1"==d?"book-all-line ":"")+'" >'+(1==i.entryCanClose&&i.visitorInfoCloseImg?'<div id="cancelEntryBtn" style="'+i.visitorInfoClosePos+'"><img src="'+i.visitorInfoCloseImg+'" onload="imgLoadResizeSelf(this)" /></div>':"")+(i.visitorInfoBackImg?'<div><img id="entryWrapImg" class="book-table-img hide" src="'+i.visitorInfoBackImg+'" onload="imgLoadResize(this,-1)" /></div>':"")+'<form id="entryForm" name="entryForm" class="book-items" ><div class="book-form-title" style="'+i.welcomeWordPos+'">'+(i.welcomeWord||"")+'</div> <div class="clearfix book-items-list" style="'+i.visitorInfoFormPos+';">',_=0,E=0,M=0,I=0;I<l;I++){var N,R=1==(N=o[I]).configRequired?" req ":"";if("1"==N.configInline?_=parseInt(_+1.5):_+=.5,"1"==N.configWebVipVisitor&&c.isVip||"1"==N.configWebVisitor&&!c.isVip){"1"==N.configInline?E=parseInt(E+1.5):E+=.5,0;var D=N.configName,C=b[D],S=window.ltIE10?"text":"birthday"==D?"date":"age"==D?"number":"text";x+='<div class="book-half book-item'+R+("1"==N.configInline?" book-one-line":"")+("gender"==D||"maritalStatus"==D?" book-item-opts":"")+'"><label class="book-label" style="color:'+i.visitorInfoLabelColor+'"><span class="req-span color0">*</span><span class="name-span">'+N.configDesc+"</span></label>"+("gender"==D?'<label class="input-radio-lb" style="color:'+i.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+R+'" name="gender" value="1" '+(1==C?'checked="checked"':"")+' lb="'+N.configDesc+'"/><span class="radio-span">'+lanRes.male+'</span></label><label class="input-radio-lb" style="color:'+i.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+R+'" name="gender" value="2" '+(2==C?'checked="checked"':"")+' lb="'+N.configDesc+'" /><span class="radio-span">'+lanRes.female+"</span></label>":"maritalStatus"==D?'<label class="input-radio-lb" style="color:'+i.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+R+'" name="maritalStatus" value="1" '+(1==C?'checked="checked"':"")+' lb="'+N.configDesc+'"/><span class="radio-span">'+lanRes.unmarried+'</span></label><label class="input-radio-lb" style="color:'+i.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+R+'" name="maritalStatus" value="2" '+(2==C?'checked="checked"':"")+' lb="'+N.configDesc+'"/><span class="radio-span">'+lanRes.married+"</span></label>":'<input type="'+S+'" lb="'+N.configDesc+'" class="book-ipt '+R+'" name="'+D+'" value="'+(C||"")+'" style="border-bottom-color:'+i.visitorInfoInputColor+";color:"+i.visitorInfoInputColor+';"/>')+"</div>"}else o[I].disabled=!0,M++}if(1==i.captChaEnable&&(x+='<div class="clearfix"><div class="book-half book-item req" id="verifyInner"><label class="book-label" style="color:'+i.visitorInfoLabelColor+'"><span class="req-span color0">*</span><span class="name-span">'+lanRes.validateCode+'</span></label><input type="text" id="verify_input" class="book-ipt req" lb="'+lanRes.validateCode+'" style="border-color:'+i.visitorInfoInputColor+'"/></div><div class="book-half book-item verify-line"><img alt="'+lanRes.validateCode+'" id="verify_img" src="'+c.dataHost+"/chatCaptCha.jpg?captChatToken="+a.captChaToken+'"/><span class="color0 cursor-p" id="verify_change">'+lanRes.nextPic+"</span></div></div>",e(".verify-change").attr("id",""),e(".verify-img").attr("id",""),e(".verify-ok").attr("id",""),e(".verify-input").attr("id","")),x+="</div>",x+='<div id="submitBtnentry" style="'+i.visitorInfoSubmitPos+'" class="book-btn"> <span class="book-btn-text">'+(i.visitorInfoSubmitTxt||"")+"</span></div>",x+="</form></div>",e("body").append('<div id="entry" class="entry-wrap">'+x+"</div>").show(),1==view.windowType&&(_=parseInt(_+.5),E=parseInt(E+.5),M=_-E),M>0&&setTimeout(function(){e(".book-items-list").css("paddingBottom",view.px2rem?view.px2rem(30*M):30*M+"px")},10),c.publish("removeLoading"),e("#mask").show(),e("body").addClass("entry"),i.visitorInfoSubmitImg&&!view.SDK){c.needHttps&&(i.visitorInfoSubmitImg=i.visitorInfoSubmitImg.replace(/^http:/,c.needHttps));var L=new Image;L.onload=function(){var e=_$("submitBtnentry").style;e.backgroundImage="url('"+i.visitorInfoSubmitImg+"')",e.backgroundSize=(view.px2rem?view.px2rem(this.width):this.width+"px")+" "+(view.px2rem?view.px2rem(this.height):this.height+"px"),e.lineHeight=view.px2rem?view.px2rem(this.height):this.height+"px",e.height=view.px2rem?view.px2rem(this.height):this.height+"px",e.width=view.px2rem?view.px2rem(this.width):this.width+"px",e=null,L=null},L.src=i.visitorInfoSubmitImg}return e("#cancelEntryBtn").on("click",function(e){var t=c.hasEntryOrCode;c.visitorClose=!1,c.publish("_endChat"),c.publish("chatEnded",{}),(t||"0"==c.queryParams.autoChat)&&(c.publish("entryCallback",{success:!0}),c.publish("_endConnect")),delete c.queryParams.autoPop,delete c.queryParams.autoChat}),c.addEntryEvent({list:o,configData:i,submitSelector:"#submitBtnentry"}),setTimeout(function(){var e=_$("entryForm").offsetHeight+(view.px2px?view.px2px(20):20)+_$("entryForm").offsetTop;_$("entry").style.minHeight=e+"px"},100),!0},orderSubAttachments:[],orderFileIndexObj:{},addOrderSubmitEvent:function(t,i){function s(i){if(i.stopPropagation(),d)return!1;for(var s,c,u,f,m=l,h={},p=!0,g=0,v=t.length;g<v;g++)if(s=null,label="",I=t[g],u=I.configName,c=m[u],!t[g].disabled){if(f=a(m,c,u),s=f.val,!(p=n(c,s,u,function(t){c.nodeType?t?e(c).removeClass("error"):e(c).addClass("error"):c[0]&&c[0].nodeType&&e(c[0].parentNode.parentNode).addClass("error")})&&p))return!1;s&&p&&f.label+" "+f.labelVal+"\r\n ",h[u]=s}if(view.handleNetwok&&view.handleNetwok())return!1;var b=r.msg649&&r.msg649.jobWindowInfo||{};h.routeId=r.msg649.routeId,h.token=b.token,h.nonce=b.nonce,h.styleId=r.msg649.styleId,h.jobTemplateId=r.msg649.jobWindowInfo.jobTemplateId;var y=!0;if(view.SDKNative&&view.orderUploadData.length>0){h.attachments=[],r.orderSubAttachments=[];var w;for(k in view.orderUploadData)(I=view.orderUploadData[k])&&I.index&&I.data?(w={type:1,fileValue:{url:I.data.sourceUrl,name:I.data.fname||"",size:I.data.fsize,fileType:4==I.data.fileType?2:4,key:I.data.key,bucket:I.data.bucket}},h.attachments.push(w)):!I.data&&I.index&&(y=!1);h.attachments=JSON.stringify(h.attachments)}else if(r.orderSubAttachments.length>0){h.attachments=[];for(var I,k=0;k<r.orderSubAttachments.length;k++)(I=r.orderSubAttachments[k]).name=encodeURIComponent(I.name),I.fileValue?h.attachments.push({type:I.type,fileValue:I.fileValue}):y=!1;h.attachments=JSON.stringify(h.attachments)}if(y)return o(h,function(e){d=!!e}),!1;r.showDialog({tip:lanRes.visitor190,ok:function(){for(var e=0;e<r.orderSubAttachments.length;e++)r.orderSubAttachments[e].xhr&&r.orderSubAttachments[e].xhr.abort();o(h,function(e){d=!!e})},cancel:function(){}})}function o(t,i){e.ajax({url:r.dataHost+"/chatapi/jobh/cmj?companyId="+r.companyId+"&requesterVisitorId="+r.visitorId+r.addMapParams(t),type:"jsonp",jsonpCB:"jsonpCallback",success:function(e){e.successful?(i&&i(!0),r.overOrderForm(e.result.data)):(i&&i(!1),r.showDialog({tip:e.errorMsg,cancel:!1}))}})}var r=this,l=_$("orderForm");1!=view.windowType?view.handleShowOrderSubmit&&setTimeout(function(){view.handleShowOrderSubmit()},15):view.toLeaveMessage&&setTimeout(function(){view.toLeaveMessage()},15),e(".entry2-input",l).bind("blur",function(){var e=this.name;n(this,a(l,this,e).val,e,function(e){})}),e("textarea",l).bind("blur",function(){n(this,this.value.replace(/^[\s]+|[\s]+$/gi,""),"textarea",function(e){})}),e("input",l).bind("change",function(){var e=this.name;n(this,a(l,this,e).val,e,function(e){})}),e("select",l).bind("change",function(){n(this,this.value,"select",function(e){})}),e(".date-input",l).bind("change",function(t){var i=e(".date-show",this.parentNode);i&&i.val(this.value)});var d=!1;_$("orderForm").onsubmit=s,e(i).off("click").bind("click",s)},overOrderForm:function(t){if(t.codeUrl){e("#orderSubmit")&&e("#orderSubmit").remove();var i='<div id="orderSubmit"><div class="order-complete"><img src='+(t.codeUrl||"")+' /><div class="tip1">'+lanRes.visitor183+'</div><div class="tip2">'+lanRes.visitor184+"</div></div></div>";1==view.windowType?e("#leave").html(i).removeClass("hide"):e("body").append(i),e(".leave-entry-foot")&&e(".leave-entry-foot").remove()}},addEntryEvent:function(t,i){function s(t){if(c)return!1;for(var s,l,u,f,m=_$("entryForm"),h={windowType:view.windowType},p="",g=!0,v=0,b=o.length;v<b;v++)if(w=null,"",s=o[v],u=s.configName,l=m[u],!o[v].disabled){if(f=a(null,l,u),w=f.val,!(g=n(l,w,u,function(t){l.nodeType?t?e(l).removeClass("error"):e(l).addClass("error"):l[0]&&l[0].nodeType&&e(l[0].parentNode.parentNode).addClass("error")})&&g))return!1;w&&g&&(p+=f.label+" "+f.labelVal+"\r\n "),h[u]=w}if(console.log(p),view.handleNetwok&&view.handleNetwok())return!1;if(h.leaveContent=void 0,d.leaveAndClose){var y=e(".leave-entry-text").results[0];if(n(y,y.value,"content",function(t){y.nodeType&&(t?e(y).removeClass("error"):e(y).addClass("error"))}),!y.value)return!1}if(1==r.captChaEnable){if(e("#verify_change").hasClass("loadin"))return!1;var w;if(!(w=e("#verify_input").val()))return e("#verify_input").addClass("error"),!1;e("#verify_change").addClass("loadin"),h.captcha=w}return h.et=106,"1"==d.queryParams.autoPop&&(h.isAutoPop=1),c=!0,d.entryParam=h,d.entryVisitorMsg=p,d.entryLeaveContent=y&&y.value,d.publish("visitorCommonEvent",h,function(t){t&&t.successful&&i&&i(),1==r.captChaEnable&&e("#verify_change").removeClass("loadin"),c=!1}),!1}var o=t.list,r=t.configData,l=t.submitSelector,d=(t.crm20,this);1==r.captChaEnable&&d.toShowCode(),view.handleShowEntry&&setTimeout(function(){view.handleShowEntry()},15),e("input",_$("entryForm")).bind("blur",function(){var e=this.name;n(this,a(null,this,e).val,e,function(e){})}),e("textarea",_$("entryForm")).bind("blur",function(){n(this,this.value.replace(/^[\s]+|[\s]+$/gi,""),"textarea",function(e){})}),e("select",_$("entryForm")).bind("change",function(){n(this,this.value,"select",function(e){})}),e(".date-input",_$("entryForm")).bind("change",function(t){var i=e(".date-show",this.parentNode);i&&i.val(this.value)});var c=!1;_$("entryForm").onsubmit=s,e(l).off("click").on("click",s)},toShowCode:function(){function t(){if(!e("#verify_change").hasClass("loadin")){e("#verify_change").addClass("loadin");var t={et:122,windowType:view.windowType,content:"refresh code"};"1"==i.queryParams.autoPop&&(t.isAutoPop=1),i.publish("visitorCommonEvent",t)}}var i=this;this.codeShowed&&(e("#verify_change").removeClass("loadin"),e("#verify_input").removeClass("error").val("")),this.codeShowed=!0,e("#verify_img").off("click").bind("click",t),e("#verify_change").off("click").bind("click",t),e("#verify_input").off("click").bind("keydown",function(){e("#verify_input").removeClass("error")}),e("#verify_ok").off("click").bind("click",function(){if(!e("#verify_change").hasClass("loadin")){var t=e("#verify_input").val();if(t){e("#verify_change").addClass("loadin");var a={et:106,captcha:t,windowType:view.windowType};"1"==i.queryParams.autoPop&&(a.isAutoPop=1),i.publish("visitorCommonEvent",a,function(){})}else e("#verify_input").addClass("error")}})},toShowQcode:function(){function t(t){if(e("#qcode_loading").show(),e("#qcode_img").attr("loaded","loaded").hide(),t){var a=(i.dataHost||"")+"/cqr?"+(i.needHttps?"ssl=1&":"")+"chatToken="+t,n=new Image;n.onload=function(){e("#qcode_loading").hide(),e("#qcode_img").attr({loaded:"loaded",src:a}).show(),setTimeout(function(){e("#qcode_img").removeAttr("loaded"),i.publish("_toGetChatToken")},54e4)},n.onerror=function(t){e("#qcode_img").removeAttr("loaded")},n.src=a}else i.publish("_toGetChatToken")}var i=this;return view.qcodeWechat||(i.subscribe("getChatToken",function(e,i){t(i.chatToken)}),i.subscribe("_toGetChatToken",function(){i.publish("visitorCommonEvent",{et:120,companyId:i.companyId})})),view.toggleQcode&&view.toggleQcode(t),!0},toInitEvaluate:function(t){var i,a,n=this,o=!1,r=t.evaluateInfo||t.smallEvaluateInfo||t.mobileEvaluateInfo||t.sdkEvaluateInfo||n.msg649&&(n.msg649.evaluateInfo||t.smallEvaluateInfo||n.msg649.mobileEvaluateInfo||n.msg649.sdkEvaluateInfo);if(!r)return n.satisfyEnable=!1,void this.toggleEvaluateMenu(1);if(0==r.enable?(n.satisfyEnable=!1,this.toggleEvaluateMenu(6)):(this.toggleEvaluateMenu(5),n.satisfyEnable=!0,1==r.enableVisitorEvaluateLimit&&parseInt(r.allowEvaluateBaseWords)>0&&(n.allowEvaluateBaseWords=parseInt(r.allowEvaluateBaseWords),n.sendMsgNum<n.allowEvaluateBaseWords?this.toggleEvaluateMenu(3):this.toggleEvaluateMenu(4))),!this.hasInitEvaluate){n.hasInitEvaluate=!0,(a=(i=l=1==r.evaluateType)?1==r.bestEnable?5:1==r.betterEnable?4:1==r.commonEnable?3:1==r.worseEnable?2:1==r.worstEnable&&1:5)||(a=5,o=!0),e("#satisfy_ipt").val(a);var d='<div class="sa-title tc"><div class="sa-title-left"></div><div class="sa-title-content"><span langs="evaluateTip">'+lanRes.evaluateTip+'</span><span class="sa-name sa-name5 emcolor">'+r.bestDesc+'</span><span class="sa-name sa-name4 emcolor">'+r.betterDesc+'</span><span class="sa-name sa-name3 emcolor">'+r.commonDesc+'</span><span class="sa-name sa-name2 emcolor">'+r.worseDesc+'</span><span class="sa-name sa-name1 emcolor">'+r.worstDesc+'</span></div><div class="sa-title-right"></div></div>';if(i&&!o?(d+='<ul class="sa-imgs clearfix">',1==r.worstEnable&&(d+='<li class="sa-img sa-img1" v="1"><img class="sa-s-img" v="1" src="'+r.worstSelected.replace(/^http:/,n.needHttps||"http:")+'"/><img class="sa-un-img" v="1" src="'+r.worstUnSelected.replace(/^http:/,n.needHttps||"http:")+'"/></li>'),1==r.worseEnable&&(d+='<li class="sa-img sa-img2" v="2"><img class="sa-s-img" v="2" src="'+r.worseSelected.replace(/^http:/,n.needHttps||"http:")+'"/><img class="sa-un-img" v="2" src="'+r.worseUnSelected.replace(/^http:/,n.needHttps||"http:")+'"/></li>'),1==r.commonEnable&&(d+='<li class="sa-img sa-img3" v="3"><img class="sa-s-img" v="3" src="'+r.commonSelected.replace(/^http:/,n.needHttps||"http:")+'"/><img class="sa-un-img" v="3" src="'+r.commonUnSelected.replace(/^http:/,n.needHttps||"http:")+'"/></li>'),1==r.betterEnable&&(d+='<li class="sa-img sa-img4" v="4"><img class="sa-s-img" v="4" src="'+r.betterSelected.replace(/^http:/,n.needHttps||"http:")+'"/><img class="sa-un-img" v="4" src="'+r.betterUnSelected.replace(/^http:/,n.needHttps||"http:")+'"/></li>'),1==r.bestEnable&&(d+='<li class="sa-img sa-img5 sa-sli5" v="5"><img class="sa-s-img" v="5" src="'+r.bestSelected.replace(/^http:/,n.needHttps||"http:")+'"/><img class="sa-un-img" v="5" src="'+r.bestUnSelected.replace(/^http:/,n.needHttps||"http:")+'"/></li>'),d+="</ul>"):d+='<ul class="sa-stars clearfix"><li class="sa-sli sa-star emcolor" v="1">&#xe64d;</li><li class="sa-sli sa-star emcolor" v="2">&#xe64d;</li><li class="sa-sli sa-star emcolor" v="3">&#xe64d;</li><li class="sa-sli sa-star emcolor" v="4">&#xe64d;</li><li class="sa-sli sa-star emcolor sa-sli5" v="5">&#xe64d;</li></ul>',!i||!o){d+='<div class="sub-tabs clearfix " >',view.SDK&&(d+="<div>");for(var c=["worstConfiguration","worseConfiguration","commonConfiguration","betterConfiguration","bestConfiguration"],u=5;u>0;u--){var f=r[c[u-1]]||[],m=f.length;d+='<ul class="sub-tab sub-tab'+u+'" '+(m>0?"":'style="display:none"')+' id="subEvaluate'+u+'"> ';for(var h=0;h<m;h++){var p=f[h];d+='<li class="sa-cli" dataname="'+p.configName+'">'+p.configDesc+"</li>"}d+="</ul>"}view.SDK&&(d+="</div>"),d+="</div>"}e("#satisfyConfig").html(d).addClass("sa-sel-"+a).attr("default",a),view.handleSatisfy&&view.handleSatisfy(o,i,a),e("#sa_ok").on(n.isMobile?"touchend":"click",function(t){if(view.handleNetwok&&view.handleNetwok())return!1;e.store("ECHAT_inviteSatisfyHandle",e.store("ECHAT_inviteSatisfyId")),n.isMobile&&t.preventDefault();var i=n.stringEncode(e("#sa_advise").val()),a=e("#satisfy_ipt").val(),r="";if("0"!=a&&a){if(!o){var l=e(".sa-cli",_$("subEvaluate"+a)).results||[],d=l.length;if(d>0)for(var c=0;c<d;c++)r+="&"+[e(l[c]).attr("dataname")]+"="+(e(l[c]).hasClass("sub-selected")?1:0)}var u=n.dataHost+"/ces?companyId="+n.companyId+"&talkId="+n.talkId+"&visitorId="+encodeURIComponent(n.visitorId||"")+(view.SDK?"&appId="+encodeURIComponent(n.appId||""):"")+"&nonce="+encodeURIComponent(n.restartParam.nonce||"")+"&reChatTag="+encodeURIComponent(n.restartParam.reChatTag||"")+"&mainItem="+a+"&evaluateType="+n.satisfyType+"&media="+n.Device.media+"&windowType="+view.windowType+"&lan="+(window.lanName||"")+"&comment="+encodeURIComponent(i||"")+r;console.log("url***",u),e.ajax({url:u,type:"jsonp",jsonpCB:"jsonpCallback",success:function(e){if(console.log(e),n.satisfyShowed=n.talkId,1==e)n.evaluateScore=a,s(lanRes.successSubmitEval,"ok"),view.resetSatisfy&&view.resetSatisfy(),!1===n.chatting?(n.publish("_closeWin"),n.publish("__evaluate","1-2")):n.publish("__evaluate","1-1"),i&&n.publish("__evaluateComment",{comment:i,chatting:n.chatting});else{var t=lanRes.unkownErrorSubmitEval;129==e?t=lanRes.evaluateTimeout:130==e?t=lanRes.evaluateRepeat:133==e&&(t=lanRes.evaluateRepeatTime),s(t)}},error:function(){s(lanRes.unkownErrorSubmitEval)}}),e("#satisfy").removeClass("satisfy-show").hide(),e("#mask").off("click",n.hideSatisfy),e("#mask").hide(),_$("sa_advise").blur(),view.hideSatisfy&&view.hideSatisfy()}}),e("#sa_cancel").on(n.isMobile?"touchend":"click",function(e){n.hideSatisfy(),n.isMobile&&e.preventDefault()})}},toggleEvaluateMenu:function(t){if(view.decideEvalMenu)return view.decideEvalMenu(t%2);var i=e(".menu-satisfy"),a="hide",n="limit-hide";1==t?i.addClass(a).removeClass("show"):2==t?i.removeClass(a):3==t?i.addClass(n):4==t?i.removeClass(n).removeClass(a):5==t?i.addClass("show").removeClass(a):6==t&&i.hide(),this.hasWaitingStatus&&i.addClass(a).removeClass("show"),view.calcUrlList&&view.calcUrlList()},stringEncode:function(e){var i=t.createElement("div");return i.innerText?i.innerText=e:i.textContent=e,i.innerHTML},staffMap:{},handleStaffMap:function(t,i){var a,n={};if(t&&t.length>0)for(var s=0;s<t.length;s++)t[s].staffHead&&this.needHttps&&(t[s].staffHead=t[s].staffHead.replace(/^http:/,this.needHttps)),n[t[s].staffId+""]={staffId:t[s].staffId,staffName:t[s].staffNickName||lanRes.serviceStaff,staffImg:t[s].staffHead||this.defaultStaffImg},!a&&(a=n[t[s].staffId+""]);this.staffMap=i?e.extend(n,this.staffMap):e.extend(this.staffMap,n)},updateStaffInfo:function(t,i){if(i&&i.staffId){var a={};return a[i.staffId]={staffId:i.staffId,staffName:i.staffNickName||lanRes.serviceStaff,staffImg:i.staffHead||i.staffDetailInfo&&i.staffDetailInfo.staffHead||this.defaultStaffImg},e.extend(this.staffMap,a),a[i.staffId]}},startChat:function(t,i){function a(){var e=s.getInput(!1),t=e;(e=e.replace(/^[\n\r\s]+$/,""))&&s.lastText!=e&&(s.lastText=e,s.plainText&&(t=s.plainTextToSendMsg(e)),s.publish("sendVisitorEvent",{et:104,content:t})),s.typingTimer=setTimeout(a,2e3)}var s=this;s.hasWaitingStatus=!1,s.companyOff=!1,"679"!=i.mt&&"686"!=i.mt&&i.talkId&&!0===this.chatting&&this.staffId!=i.staffId&&this.talkId==i.talkId&&this.publish("getSysMsg",{talkId:i.talkId,tm:i.tm,mt:"10001",staffId:i.staffId,staffName:i.staffNickName},i),i.staffDetailInfo&&e.cookie("ECHAT_"+window.companyId+"_"+window.chatVisitorId+"_staffHead",i.staffDetailInfo.staffHead||"",{path:"/"}),e.cookie("ECHAT_"+s.companyId+"_"+window.chatVisitorId+"_chatStatus",2,{path:"/"}),this.satisfyShowed!=i.talkId&&(this.satisfyShowed=0),s.talkId&&s.talkId!=i.talkId&&(s.lastTalkIdForTemp=s.talkId),this.chatting=!0,i.talkId&&(this.talkId=i.talkId),"679"!=i.mt&&(this.staffId=i.staffId,this.staffName=i.staffNickName),this.paramChat.talkId=this.talkId,this.paramChat.staffId=this.staffId,this.paramChat.staffName=this.staffName,s.publish("__chatStatus","chatting"),s.initQcode(),delete s.queryParams.autoPop,delete s.queryParams.autoChat,e("#busyTipLine").addClass("hide").hide(),1==i.startType&&s.publish("__chatStart",i.staffNickName),s.lastTalkIdForTemp&&(s.lastTalkIdForTemp!=s.talkId&&s.handleSessionMsg({talkId:s.lastTalkIdForTemp}),s.lastTalkIdForTemp=void 0),i.staffDetailInfo&&s.publish("staffInfo",i),e(".menu-capture").removeClass("hide"),e(".menu-file").removeClass("hide"),this.publish("entryCallback",{success:!0}),this.endChatEvent(),s.lastText=null,s.typingTimer=setTimeout(a,2e3),this.subscribe("getMsgTyping",function(e,t){s.showTyping()}),this.subscribe("staffStatus",function(e,t){if(1!=t.status){s.publish("_staffEndChat",t);var i=new Date;this.showMsg({f:"s",t:s.checkHistoryTime(i.getTime())?i.format("hh:mm"):void 0},lanRes.staffLeaveEnd)}}),this.subscribe("inviteBook",function(t,i){var a,o=i.templateInfoList;0==(a=1==view.windowType&&(0==o[0].type||1==o[0].type)||1!=view.windowType&&(2==o[0].type||3==o[0].type)?o[0]:o[1]).type||2==a.type?s._getMsg({mt:i.mt,tm:i.tm,notEnd:i.notEnd,content:s.showInfoTip({f:"sys",tip:"客服给您发送了一个预约表。"},void 0,void 0,!0,i.talkId,i.tm,i.notEnd)},4,function(t,i,a){function o(t){if(y)return!1;for(var i,a=_$("inviteBookForm"+d),o="companyId="+s.companyId+"&visitorId="+s.visitorId+"&groupId="+l+"&p="+encodeURIComponent(s.encryptVID),r=!0,f=0;f<u;f++){i=null;var m=c[f].configName,h=a[m];if(!h.value&&h.length>1&&h[0])for(var p=0;p<h.length;p++)h[p].checked&&(i=h[p].value);if(i=i||h.value,i=i.replace(/^[\s]+|[\s]+$/gi,""),!(r=n(h,i,m,function(e){})&&r))return!1;o+="&"+m+"="+i}return r&&(y=1,e.ajax({url:s.dataHost+"/cvi?"+o,type:"jsonp",jsonpCB:"jsonpCallback",success:function(t){y=0,1==t?e(".book-wrap").remove():s.showInfoTip(lanRes.unkownErrorSubmit,void 0,"warn")},error:function(){y=0,s.showInfoTip(lanRes.unkownErrorSubmit,void 0,"warn")}})),!1}var l=t.groupId,d=s.bookformi++,c=t.configuration,u=c.length,f=1!=t.captChaEnable&&r(c);s.needHttps&&t.backImg&&(t.backImg=t.backImg.replace(/^http:/,s.needHttps));for(var m=' <div id="inviteBook'+d+'" class="book-table '+("1"==f?"book-all-line":"")+'" >'+(t.backImg?'<div><img id="inviteBookImg'+d+'" class="book-table-img hide" src="'+t.backImg+'" onload="imgLoadResize(this,'+d+')"/></div>':"")+'<form id="inviteBookForm'+d+'" class="book-items"> <div class="clearfix book-items-list" style="'+t.formPos+';">',h=0;h<u;h++){var p=c[h],g=1==p.configRequired?"req":"",v=window.ltIE10?"text":"birthday"==p.configName?"date":"age"==p.configName?"number":"text";m+='<div class="book-half book-item '+("1"==p.configInline?"book-one-line":"")+'"><label class="book-label" style="color:'+t.labelColor+'">'+p.configDesc+"</label>"+("gender"==p.configName?'&nbsp;&nbsp;<input type="radio" class="book-radio '+g+'" name="gender" value="1" lb="'+p.configDesc+'"/><span style="color:'+t.inputColor+';">'+lanRes.male+'</span> <input type="radio" class="book-radio '+g+'" name="gender" value="2" /><span style="color:'+t.inputColor+';">'+lanRes.female+"</span>":"maritalStatus"==p.configName?'&nbsp;&nbsp;<input type="radio" class="book-radio '+g+'" name="maritalStatus" value="1" lb="'+p.configDesc+'"/><span  style="color:'+t.inputColor+';">'+lanRes.unmarried+'</span><input type="radio" class="book-radio '+g+'" name="maritalStatus" value="2" /><span  style="color:'+t.inputColor+';">'+lanRes.married+"</span>":'<input type="'+v+'" lb="'+p.configDesc+'" class="book-ipt '+g+'" name="'+p.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"/>')+"</div>"}if(m+="</div>",m+='<div id="submitBtn'+d+'" style="'+t.submitPos+'" class="book-btn"> <span class="book-btn-text">'+(t.submitTxt||"")+"</span></div>",m+="</form></div>",e(s.getListMsgEl(i,a)).append('<li id="inviteBookLi'+d+'" class="clearfix book-wrap">'+m+"</li>"),t.submitImg){var b=new Image;s.needHttps&&(t.submitImg=t.submitImg.replace(/^http:/,s.needHttps)),b.onload=function(){var e=_$("submitBtn"+d).style;e.backgroundImage="url('"+t.submitImg+"')",e.lineHeight=view.px2rem?view.px2rem(this.height):this.height+"px",e.height=view.px2rem?view.px2rem(this.height):this.height+"px",e.width=view.px2rem?view.px2rem(this.width):this.width+"px",e=null,b=null,t=null},t.submitImg&&(b.src=t.submitImg)}e("input",_$("inviteBook"+d)).bind("blur",function(){var e=this.name;n(this,this.value.replace(/^[\s]+|[\s]+$/gi,""),e,function(e){})});var y=0;e("#submitBtn"+d).bind(s.isMobile?"tap":"click",o),_$("inviteBookForm"+d).onsubmit=o,s.isMobile,setTimeout(function(){var e=_$("inviteBookForm"+d).offsetHeight+(view.px2px?view.px2px(20):20)+_$("inviteBookForm"+d).offsetTop;_$("inviteBookLi"+d).style.minHeight=e+"px",view.scrollToBottom()},100)}(a,i.talkId,i.tm),"x"):s._getMsg({mt:i.mt,tm:i.tm,content:o},3,s.getBookComfirm(o),"x")}),this.subscribe("inviteBookOK",function(t,i){if(console.log("不应发送892 inviteBookOK "),1==i.success){if(e("#entry").hide(),e("#verify").hide(),e("#mask").hide(),s.hasEntryOrCode=!1,i.mt){var a=s.entryParam;if(a){delete a.et,delete a.captcha;var n=e.store("ECHAT_"+s.companyId+"_ENTRY_HIS");n=n?JSON.parse(n):{},a=e.extend(n,a),e.store("ECHAT_"+s.companyId+"_ENTRY_HIS",JSON.stringify(a))}}}else s.publish("refreshVerify",{status:1});e(".book-wrap").remove(),s.showInfoTip({f:"sys",tip:lanRes.submitInfoSucc})})},getADURL:function(e,t,i,a,n,s){if(!i)return"";if(!e||"0"==e||!t)return i;a=a||this.paramChat;var o="",r="",l="",d=i.split("#"),c=d[1]||"",u=d[0],f=-1==u.indexOf("?")?0:1,m="?";"string"==typeof t&&(t=JSON.parse(t));var h,p,g,v,b,y=["companyId","visitorId","echatTag","lan","country","province","city","searcher","keyword","metaData","referrer","firstUrl","chatPage","chatPageTitle","eventId","osName","staffId","staffName","staffPhoto","talkId","staffPhone","staffInfo"];if(view.chat.isArray(t)&&t.length){for(h=t.length,g=0;g<y.length&&("staffId"==(v=y[g])&&(r=o,o="",n&&(m="",f=c?1:0)),"staffId"!=v||a.staffId);g++)for(p=0;p<h;p++)if("metaData"!=(b=t[p].paramName)&&"metadata"!=b||(b="metaData"),b==v){"metaData"==b?(o+=(0!=f?"&":m)+b+"="+encodeURIComponent(a[b]||""),b="myData",o+=(0!=++f?"&":m)+b+"="+encodeURIComponent(a[b]||""),f++,a[b="info"]&&(o+=(0!=f?"&":m)+b+"="+encodeURIComponent(a[b]||""),f++)):"staffId"==b?(o+=(0!=f?"&":m)+b+"="+("-1"==encodeURIComponent(a[b]||"")?"":encodeURIComponent(a[b]||"")),f++):(o+=(0!=f?"&":m)+b+"="+encodeURIComponent(a[b]||""),f++);break}y.length==g&&(l=o,o="")}return n?u+r+(c?"#"+c+l:"#"+l):u+r+l+(c?"#"+c:"")},setInnerAD:function(t){function i(){var i=e("#portrait").height();1==r.chatBoxAdImgLinkFixed&&(i+=3==r.chatBoxInnerAdType?0:e(".innerAD").height()),t.height(i)}if(t.data){var a,n,s,o,r=t.data,l=r.chatBoxAdHeight;l=l?parseInt(l):0,e(".innerAD").each(function(){e("#list_msg").contains(this)||e(this).remove()}),e("#innerADWrap").addClass("hide"),2==r.chatBoxInnerAdType?(a=r.chatBoxInnerAdContent)&&(n='<li class="clearfix innerAD innerAD-text"><div>'+a+"</div></li>"):3==r.chatBoxInnerAdType&&l?((a=r.chatBoxInnerAdImg)&&view.chat.needHttps&&(a=a.replace(/^http:/,view.chat.needHttps)),this.lastLoadInnerImgName=o=(new Date).getTime(),window["resetInnerAdHeight"+o]=function(i,a,n){if(n==view.chat.lastLoadInnerImgName){var s=(a>i?i:a)+20;1==r.chatBoxAdImgLinkFixed?(e("#innerADWrap").css("height",s+"px"),t.height(e("#portrait").height()+s)):t.height(e("#portrait").height())}},a&&r.chatBoxInnerAdImgLinkUrl?(s=this.getADURL(r.chatBoxAdPostEnable,r.chatBoxInnerAdPostParamList||"{}",r.chatBoxInnerAdImgLinkUrl,view.chat.paramChat,1!=r.chatBoxInnerAdParamAppendType),n='<li class="clearfix innerAD innerAD-img"><a id="innerADLink" target="'+(1==r.chatBoxInnerAdImgLinkOpenType?view.SDK?"cover":"_blank":"inner")+'" href="'+s+'"><img onload="resetInnerAdHeight'+o+"(this.height,"+l+","+o+')" onerror="resetInnerAdHeight'+o+"(this.height,"+l+","+o+')" style="max-height:'+l+'px" src="'+a+'"/></a></li>',e.extend(this.staffInfoRefreshMap.innerImgUrl,{notEnableParam:1!=r.chatBoxAdPostEnable,srcUrl:r.chatBoxInnerAdImgLinkUrl,url:a,params:r.chatBoxInnerAdPostParamList||"{}",hash:1!=r.chatBoxInnerAdParamAppendType,element:"#innerADLink"})):a&&(n='<li class="clearfix innerAD innerAD-img"><img onload="resetInnerAdHeight'+o+"(this.height,"+l+","+o+')" style="max-height:'+l+'px" src="'+a+'"/></li>')):1==r.chatBoxInnerAdType&&l&&((a=r.chatBoxInnerAdUrl)&&view.chat.needHttps&&(a=a.replace(/^http:/,view.chat.needHttps)),(a=this.getADURL(r.chatBoxAdPostEnable,r.chatBoxInnerAdPostParamList||"{}",r.chatBoxInnerAdUrl,view.chat.paramChat,1!=r.chatBoxInnerAdParamAppendType))&&"0"!=r.chatBoxAdHeight&&(n='<li class="clearfix innerAD innerAD-url"><iframe id="inner_frame" class="ps-child" height="'+r.chatBoxAdHeight+'px" border="0" allowtransparency="true" scrolling="no" frameborder="0" style="width:100%;height:'+r.chatBoxAdHeight+'px" src="'+view.chat.addEchatInnerFrameParam(a)+'" ></iframe></li>'),e.extend(this.staffInfoRefreshMap.innerAD,{notEnableParam:1!=r.chatBoxAdPostEnable,srcUrl:r.chatBoxInnerAdUrl,url:a,params:r.chatBoxInnerAdPostParamList||"{}",hash:1!=r.chatBoxInnerAdParamAppendType,element:"#inner_frame"})),n&&(1==r.chatBoxAdImgLinkFixed?e("#innerADWrap").html(n).removeClass("hide"):e("#list_msg").append(n),2==r.chatBoxInnerAdType&&(setTimeout(i,1e3),setTimeout(i,5e3))),i(),this.calcInnerADHeight=i}},sendMsgNum:0,sendToServer:function(t,i,a){var n=this,s=i||(t.c||t.content);t.visitorImg=n.visitorImg||n.defaultVisitorImg,n.isInRobot?t.ff="r":t.f=t.f||"c",t.hide||(delete t.hasResend,n.showMsg(t));var o=t.id;delete t.id,"0"!=n.queryParams.autoChat&&(t.hide||e(".msg-con",_$(o)).append('<div class="msg-error">&nbsp;</div>'),this.publish("sendVisitorEvent",t.data&&t.data.et?e.extend(t.data,{bridgeMsgId:t.bridgeMsgId,img:i?1:void 0,publishAck:t.publishAck||void 0}):{et:n.isInRobot?130:105,content:s,bridgeMsgId:t.bridgeMsgId,img:i?1:void 0,publishAck:t.publishAck||void 0},function(i,r){if(i.successful){t.talkId=n.talkId,t.hide||(e(".msg-error",_$(o)).remove(),e("img",_$(o)).each(function(){e(this).attr("src",e(this).attr("src"))}),n.pushHistory(t)),delete n.errorList[o],a&&a(),t=null}else t.c=s,n.errorList[o]=t,t.hide||(t.publishAck=i,e(".msg-error",_$(o)).addClass("resend").attr("dataid",o)),r&&r()})),s&&n.publish("__visitorSendMsg",s.replace(n.regEmo,"[face]")),s&&n.publish("__visitorStartSendMsg",s.replace(n.regEmo,"[face]")),n.isInRobot&&e("#input_suggest").addClass("hide").html(" "),n.lastMsgTM=t.tm||(new Date).getTime()},checkHistoryTime:function(e){return(!this.lastHistoryTime||e-this.lastHistoryTime>6e4)&&(this.lastHistoryTime=e,!0)},endChatEvent:function(){this.typingTimer&&clearInterval(this.typingTimer);this.unSubscribe(["staffStatus","getMsgTyping","inviteBook","inviteBookOK"])},showTyping:function(){function t(){i.serviceTypingTime>5&&(clearInterval(i.serviceTypingTimer),e("#serviceTypingLine").remove());var t;switch(i.serviceTypingTime%3){case 0:t=a+"&nbsp;.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";break;case 1:t=a+"&nbsp;.&nbsp;.&nbsp;&nbsp;&nbsp;";break;case 2:t=a+"&nbsp;.&nbsp;.&nbsp;.&nbsp;"}i.serviceTypingTime++;var n=_$("serviceTypingLine");n&&e(".msg-item",n).html(t)}var i=this,a=lanRes.staffInput;this.serviceTypingTimer&&clearInterval(this.serviceTypingTimer),e("#serviceTypingLine").remove(),this.serviceTypingTime=0,t(),this.serviceTypingTimer=setInterval(t,500),this.showMsg({f:"s",m:0,notEnd:!1,id:"serviceTypingLine"},a+"&nbsp;.&nbsp;.&nbsp;.&nbsp;")},regMail:/\b\w{1,30}([\.-]\w{1,30}){0,10}@\w{1,30}([\.-]\w{1,20}){0,10}(\.\w{1,20}){0,10}\b/g,regPhone:/([^\d]|\b)((\d{11})|((\d{7,8})|(\d{4}|\d{3})[\-\s](\d{7,8})|(\d{4}|\d{3})[\-\s](\d{7,8})[\-\s](\d{4}|\d{3}|\d{2}|\d{1})|(\d{7,8})[\-\s](\d{4}|\d{3}|\d{2}|\d{1})))(?=[^\d]|\b)/gi,regLink:/((http|ftp|https):\/\/)(([\w\._\-]+\.[a-zA-Z]{2,6})|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,4})?(\/[\w,\&%_\!\*\(\)\'\;\:\@\=\+\.\/\[-~\-#\?]*)?/gi,filterEmailPhoneLink:function(e){var t=this.isMobile;return"string"!=typeof e||e.match(/(msg\-tel)|(msg\-link)|(msg\-mail)/)?e:(this.regPhone.lastIndex=0,this.regMail.lastIndex=0,this.regLink.lastIndex=0,(e=e.replace(this.regLink,function(e){var i=arguments.length,a=arguments[i-2];if(a>0){var n=arguments[i-1].substring(0,a);if(/(\<(a|img|link|iframe|script)[^>]*>([^<]+(?!\<\/a\>))?$)|(\<[a-zA-Z]+[^>]*$)/gi.test(n))return e}return t?'<a class="msg-link" href="'+e+'" target="visitorSiteIframe">'+e+"</a>":'<a class="msg-link" target="_blank" href="'+e+'">'+e+"</a>"})).indexOf("@")>1&&(e=e.replace(this.regMail,function(e){var t=arguments.length,i=arguments[t-2];if(i>0){var a=arguments[t-1].substring(0,i);if(/(\<(a|img|link|iframe|script)[^>]*>[^<]+(?!\<\/a\>)$)|(\<[a-zA-Z]+[^>]*$)/gi.test(a))return e}return'<a class="msg-mail" target="_blank" href="mailto:'+e+'">'+e+"</a>"})),e=e.replace(this.regPhone,function(e,i){var a=arguments.length,n=arguments[a-2];if(n>0){var s=arguments[a-1].substring(0,n);if(/(\<(a|img|link|iframe|script)[^>]*>[^<]+(?!\<\/a\>)$)|(\<[a-zA-Z]+[^>]*$)/gi.test(s))return e}var o=i,r=e.replace(/^[^\d]|\b/,"");return(o||"")+(t?'<a class="msg-tel" href="tel:'+r+'">'+r+"</a>":'<span class="msg-tel">'+r+"</span>")}))},updateMsg:function(t,i,a){var n=_$(t);n&&(e(".msg-item",n).html(i),a&&a.newId&&e(n).attr("id",a.newId))},showLocation:function(e){var t="https://restapi.amap.com/v3/staticmap?location="+(e.locationY||e.y)+","+(e.locationX||e.x)+"&zoom="+(e.scale||15)+"&size=400*200&key=5349312538cf80d1f6c008eb059b732c&markers=mid,,A:"+(e.locationY||e.y)+","+(e.locationX||e.x),i='<div class="msg-map"><a target="'+(view.SDK?"cover":"_blank")+'" href="http://uri.amap.com/marker?position='+(e.locationY||e.y)+","+(e.locationX||e.x)+"&name="+encodeURIComponent(e.label)+'&coordinate=gaode"><div class="msg-map-title"><div>'+e.label+'</div><div class="msg-map-addr">'+(e.address||"")+'</div></div><img onerror="view.imgError&&view.imgError(this)" onload="view.scrollToBottom()" class="view_img" src="'+t+'" draggable="false"/></a></div>',a={data:e,et:127};a.c=i,a.m=7,a.f="c",a.id=e.id,a.talkId=e.talkId,e.fromHistory||902==e.mt?this.showMsg(a):this.sendToServer(a)},showMsg:function(i,a){if(i){var n=i.talkId||this.talkId,s=i.id||"msg"+(i.tm||(new Date).getTime());!i.id&&"s"==i.f&&_$(s)&&e("#"+s).remove();var o,r=i.t?'<li class="clearfix" ><div class="color1 tc">'+i.t+"</div></li> ":"";if(0==i.m?(i.c&&(i.c=this.filterEmailPhoneLink(i.c)),o=i.c?(this.filterEmo(i.c)+"").replace(/((\r\n)|\n)/g,"</br>"):a):(o=i.c||a,i.m),i.c=o,o){var l=i.visitorImg||this.visitorImg||this.defaultVisitorImg;this.needHttps&&(this.staffImg&&(this.staffImg=this.staffImg.replace(/^http:/,this.needHttps)),l=this.visitorImg||l.replace(/^http:/,this.needHttps)),view.staticPx2rem&&(o=view.staticPx2rem(o));var d={toChat:"robot-staff ",endChat:"end-chat ",toLeaveWord:"to-leave-word "};o=o.replace(/\[\[#(toChat|endChat|toLeaveWord):([^\]]+)\]\]/g,function(e,t,i){return'<span class="link-in-msg '+(d[t]||"")+'">'+i+"</span>"}),1==i.withdraw?r+='<div style="padding: 10px 0 20px;text-align: center;"><span style="display: inline-block;padding: 8px 10px;background-color: #bfbfbf;border-radius: 5px;color: #FFF;">'+o+"</span></div>":"s"==i.f||"r"==i.f?r+='<li class="clearfix '+("r"==i.f?"msg-robot":"")+" mode"+i.m+(i.media?" msg-medias":"")+'" id="'+s+'" >'+(this.showAvatar?'<div class="avatar-icon fl staff-icons"><img onerror="view.imgError&&view.imgError(this)" class="avatar-icon-img" src="'+(i.staffImg||this.staffImg||this.defaultStaffImg)+'"/></div>':"")+'<div class="msg msg-lf fl"><div class="msg-staff-name">'+(i.staffName||this.staffName||lanRes.serviceStaff)+'</div><div class="msg-con radius4 fl '+("r"==i.f?"bg10":"bg1")+(0!=i.m&&6!=i.m&&3!=i.m?" bgwhite":"")+'">'+(i.media?"":'<i class="msg-angle '+("r"==i.f?view.SDK?"color10":"border-color-angle10":view.SDK?"color11":"border-color-angle1")+'"></i>'+(view.SDK?"":0!=i.m&&6!=i.m&&3!=i.m?'<i class="msg-angle2 bc-angle1-white"></i>':""))+'<div class="msg-item">'+o+"</div></div></div></li>":"c"==i.f?r+='<li class="clearfix mode'+i.m+(i.media?" msg-medias":"")+'" id="'+s+'" >'+(this.showAvatar?'<div class="avatar-icon fr"><img onerror="view.imgError&&view.imgError(this)" class="avatar-icon-img" src="'+l+'"/></div>':"")+'<div class="msg msg-rt fr"><div class="msg-con radius4 fr '+("r"==i.ff?"bg30":"bg3")+(0!=i.m&&5!=i.m&&3!=i.m?" bgwhite":"")+'">'+(i.media?"":'<i class="msg-angle '+("r"==i.ff?view.SDK?"color30":"border-color-angle20":view.SDK?"color3":"border-color-angle2")+'"></i>'+(view.SDK?"":0!=i.m&&5!=i.m&&3!=i.m?'<i class="msg-angle2 bc-angle2-white"></i>':""))+(i.hasResend?'<div class="msg-error resend" dataid="'+i.id+'">&nbsp;</div>':"")+'<div class="msg-item">'+o.replace(/\n/g,"<br/>")+"</div></div></div></li>":r+=o;var c=t.createElement("ul");c.innerHTML=r;for(var u,f=this.getListMsgEl(n,i.tm),m=c.childNodes,h=0;u=m[h++];)if(1==u.nodeType){u=u.cloneNode(!0);var p=((i.id||"msg0")+"").replace("msg",""),g=t.getElementById(p);g&&g.innerHTML?g.innerHTML=u.innerHTML:f.appendChild(u)}if(m=null,c=null,i.notAppend)return r;"c"==i.f&&this.serviceTypingTimer?e("#list_msg").append(_$("serviceTypingLine")):"serviceTypingLine"!=i.id&&"s"==i.f&&this.serviceTypingTimer&&(clearInterval(this.serviceTypingTimer),e("#serviceTypingLine").remove()),i.notEnd||(0!=i.m&&1!=i.m&&5!=i.m&&view.scrollToBottom(null,{transitionDuration:100,timeout:"x"==i.f?1e3:1!=view.windowType?510:100}),!view.noScrollBottom&&setTimeout(function(e){view.scrollToBottom(void 0,{notVisitor:"c"!=i.f})},5))}}},changeStorgeBackMsg:function(e){var t=window.localStorage.getItem(this.historyKey)?JSON.parse(window.localStorage.getItem(this.historyKey)):"",i=t?t.order[t.order.length-1]:"",a=t?t[i]:"";if(!a)return!1;delete t[i];var n;for(var s in a)if(a[s].mid==e){a[s].withdraw=1,a[s].c=lanRes.backMsgTip,a[s].m=0,a[s].mt="640",n=s;break}return t[i]=a,this.updateHistory(t),!!n&&parseInt(n)},updateHistory:function(e){var t=JSON.stringify(e);return window.localStorage.setItem(this.historyKey,t),this.isIOS&&2==view.windowType&&this.postMessage({type:"updateLocalHistory",key:this.historyKey,value:t}),t},initHistory:function(e){if(this.hasStorage){var t=window.localStorage.getItem(this.historyKey);return(t=t&&JSON.parse(t))||(t={order:[]}),t[e]||(t.order||(t.order=[]),t.order.push(e),t[e]={order:[]}),t[e].order||(t[e].order=[]),t}},pushHistory:function(e){if(this.hasStorage&&!view.SDKNative&&e.c){var t=e.talkId||this.talkId;if(t){e.talkId=t;var i=this.initHistory(t);if(i&&"c"==e.f){var a=i[t].order;if(a.length>0){var n=a[a.length-1];if(i[t][n].c==e.c&&n.indexOf("c")>-1){var s=i[t][n].tm-e.tm;if(s<200&&s>-200)return}}}"s"!=e.f||e.staffImg||(e.staffImg=this.staffImg,e.staffName=this.staffName),1!==e.m&&2!==e.m||i[t][e.tmf]?i[t][e.tm+e.f]||(i[t][e.tm+e.f]=e,i[t].order.push(e.tm+e.f)):(i[t][e.tmf]=e,i[t].order.push(e.tmf)),this.updateHistory(i)}}},saveHistoryStaff:function(e,t){if(this.hasStorage&&this.talkId){var i=this.initHistory(this.talkId);e&&!i[this.talkId].staffImg&&(i[this.talkId].staffImg=e||this.defaultStaffImg),e&&!i[this.talkId].staffName&&(i[this.talkId].staffName=t||lanRes.serviceStaff),this.updateHistory(i)}},checkHistory:function(){if(!this.hasStorage)return e("#pre_his").hide(),!1;if(view.SDKNative)return!0;if(this.hasCheckHistory)return this.hasPreHis;this.talkId&&(this.hasCheckHistory=!0);var t=window.localStorage.getItem(this.historyKey);if(!t||'""'==t)return e("#pre_his").hide(),!1;var i=(t=JSON.parse(t)).order,a=i.length;return a?1!=a||!i||!i[0]||i[0]!=this.talkId||(e("#pre_his").hide(),!1):(e("#pre_his").hide(),!1)},loadHistory:function(t){if(!this.hasStorage||!this.hasPreHis&&!t)return!1;if(!this.loadingPreHis){var i;if(view.SDKNative)this.publish("__loadPreHistory");else if(this.loadingPreHis=!0,(i=window.localStorage.getItem(this.historyKey))&&(i=JSON.parse(i)),i){if(t&&(!i[t]||!i[t].order||0==i[t].order.length))return;var a=new Date,n=((new Date).getTime(),i.order),s=n.length;if(a.setHours(0,0,0,0),a=a.getTime(),s<2&&!t)return this.hasPreHis=!1,this.loadingPreHis=!1,!1;for(var o=s-1;o>-1&&(!t||n[o]==t);o--)if(n[o]&&n[o]!=this.talkId){0==o&&(this.hasPreHis=!1,e("#pre_his").hide());var r=i[n[o]],l=_$("list_msg_"+n[o]);if(r&&!l){t&&(l=view.chat.getListMsgEl(t,r.order&&r[r.order[0]]&&r[r.order[0]].tm||(new Date).getTime(),!0)),console.log(r),this.showHis(r,n[o]);break}if(e(l).hasClass("new-leave"))continue}}}},hidePreHistory:function(){this.loadingPreHis=!1,this.hasPreHis=!1,e("#pre_his").hide()},showPreHistory:function(){this.loadingPreHis=!1,this.hasPreHis=!0,e("#pre_his").show()},showHis:function(t,i){var a,n=this.staffImg,s=this.staffName,o={};view.handleHis&&view.handleHis(t,i),view.preHisLoadingId="list_msg_"+i;for(var r in t)"order"!=r&&"staffImg"!=r&&"staffName"!=r&&"config"!=r&&((a=e.extend({},t[r])).talkId=i,a.fromHistory=!0,a.notStore=!0,a.notEnd=!0,a.t&&-1==(a.t+"").indexOf(" ")&&(a.t=this.getTimeStr(a.tm)),"649"==a.mt?a.robotConfigInfo&&t.robotStaffName?(this.staffImg=t.robotStaffImg,this.staffName=t.robotStaffName):(this.staffImg=t.staffImg,this.staffName=t.staffName):"604"==a.mt?o=!o.staffId&&a.staffDetailInfoMsgList&&a.staffDetailInfoMsgList.length?{staffId:a.staffDetailInfoMsgList[0].staffId,staffName:a.staffDetailInfoMsgList[0].staffNickName||lanRes.serviceStaff,staffImg:a.staffDetailInfoMsgList[0].staffHead||t.staffImg}:{staffId:a.staffId,staffName:a.staffNickName||lanRes.serviceStaff,staffImg:a.staffDetailInfo&&a.staffDetailInfo.staffHead||t.staffImg}:"10001"==a.mt&&this.staffMap?o=this.updateStaffInfo(void 0,{staffId:a.toStaffId,staffNickName:a.toStaffNickName,staffDetailInfo:a.toStaffDetailInfo}):a.staffId&&this.staffMap[a.staffId]?(a.staffName=this.staffMap[a.staffId].staffName||t.staffName,a.staffImg=this.staffMap[a.staffId].staffImg||t.staffImg):!a.staffImg&&o.staffName&&(a=e.extend(a,o)),"10001"!=a.mt?"10011"!=a.mt?"10010"!=a.mt?a.mt>1e3&&"r"!=a.f||(865!=a.mt&&641!=a.mt?647!=a.mt?866!=a.mt&&642!=a.mt?"12001"!=a.mt?655!=a.mt?658!=a.mt?127!=a.mt&&902!=a.mt?680!=a.mt?605!=a.mt&&10009!=a.mt?(a.notAppend=!0,3==a.m&&a.c&&(a.c=this.getBookComfirm(a.c)),!a.c&&a.content&&(a.c=a.content),a.c&&this.showMsg(a),delete a.talkId):605==a.mt&&this.publish("getSysMsg",a):this.publish("receiveURL",a):this.publish("sendLocationInfo",a):this.publish("orderReply",a):this.publish("getLeaveMsg",a):this.publish("getMsgRobot",a):this.publish("getMsgFile",a):this.publish("getSysMsg",a):this.publish("getMsgImg",a)):this.publish("getSysMsg",a):this.publish("receiveVisEvt",a):this.publish("getSysMsg",a));this.staffImg=n,this.staffName=s,view.scrollToLastPre(view.preHisLoadingId),setTimeout(function(){view.scrollToLastPre(view.preHisLoadingId),view.preHisLoadingId=null},500),this.loadingPreHis=!1},clearHistoryByTalkId:function(e){var t=window.localStorage.getItem(this.historyKey);if((t=t?JSON.parse(t):"")&&t[e]){delete t[e];for(var i=t.order.length-1;i>=0;i--)t.order[i]==e&&t.order.splice(i,1)}this.updateHistory(t)},getListMsgEl:function(i,a,n){var s=_$("list_msg_"+i);return s||(i!=this.talkId&&i?(this.hasLeaveMsg||e(".list-his-hr").removeClass("hide"),s=t.createElement("ul"),s.id="list_msg_"+i,s.className="list-msg list-msg-his",a&&(s.innerHTML='<li class="clearfix list-his-hr color1 hide"><i class="hr-left"></i><span>'+this.getTimeStr(a)+'</span><i class="hr-right"></i></li>'),_$("list_his").insertBefore(s,n?_$("list_msg"):_$("pre_his").nextSibling),s):_$("list_msg"))},handleSessionMsg:function(i){i.talkId||(i.talkId=Math.random());var a=i.talkId,n=_$("list_msg_"+a);if(n)return n;(n=t.createElement("ul")).id="list_msg_"+a,n.className="list-msg list-msg-his";for(var s,o=_$("list_msg").childNodes,r=0;s=o[r++];)1==s.nodeType&&(r--,-1!=s.className.indexOf("innerAD")&&s.childNodes&&"IFRAME"==s.childNodes[0].tagName?e(s).remove():n.appendChild(s));return _$("list_his").insertBefore(n,_$("list_msg")),n},getTimeStr:function(e){e=e&&e-0||void 0;var t=new Date,i=new Date(e).format("hh:mm");return e=e||t.getTime(),t.setHours(0,0,0,0),t=t.getTime(),(e>=t?lanRes.today:t-e<=864e5?lanRes.yesterday:t-e<=1728e5?lanRes.beforeYesterday:new Date(e).format("yyyy-MM-dd"))+" "+i},showSysTip:function(e,i,a,n,s){a=a||"msg"+i,view.staticPx2rem&&e&&(e=view.staticPx2rem(e));var o='<li class="clearfix" id="'+a+'" ><div class="color1 tc">'+new Date(i).format("hh:mm")+'</div></li><li class="clearfix tc" id="'+a+'" ><div class="msg-sys radius4 tc">'+e+"</div></li>",r=t.createElement("ul");r.innerHTML=o;for(var l,d=this.getListMsgEl(s,i),c=r.childNodes,u=0;l=c[u++];)1==l.nodeType&&(l=l.cloneNode(!0),d.appendChild(l));c=null,r=null,!n&&view.scrollToBottom(null,{transitionDuration:100,timeout:100})},showInfoTip:function(i,a,n,s,o,r,l){var d;if("string"!=typeof i&&(i=(d=i)&&d.tip),i){view.staticPx2rem&&i&&(i=view.staticPx2rem(i));var c={toChat:"robot-staff ",endChat:"end-chat ",toLeaveWord:"to-leave-word "};i=(i=i.replace(/&nbsp;([^&\s])/g," $1")).replace(/\[\[#(toChat|endChat|toLeaveWord):([^\]]+)\]\]/g,function(e,t,i){return'<span class="link-in-msg '+(c[t]||"")+'">'+i+"</span>"}),a=a||"msg"+(new Date).getTime(),n=n||"icon";var u='<li class="clearfix '+(this.showAvatar?"msg-info-hasAvatar":"msg-info-noAvatar")+'" id="'+a+'" ><div class="'+(!d&&this.isInRobot||d&&"r"==d.f?"msg-info0":"msg-info")+' radius4"><div class="info-con">'+i+"</div></div></li>";if(s)return u;a&&_$(a)&&e("#"+a).remove();var f=t.createElement("ul");f.innerHTML=u;for(var m,h=this.getListMsgEl(o,r),p=f.childNodes,g=0;m=p[g++];)1==m.nodeType&&(m=m.cloneNode(!0),h.appendChild(m));p=null,f=null,!l&&view.scrollToBottom(null,{transitionDuration:100,timeout:100})}},resetStatisfy:function(){if(e("#sa_advise").val(""),!l)for(var t=e(".sa-sli").results,i=0;i<t.length;i++)e(t[i]).addClass("sa-star").html("&#xe64d;");var a=e("#satisfyConfig").attr("default");e("#satisfyConfig").attr("class","sa-sel-"+a),e(".sub-tab-sel").removeClass("sub-tab-sel"),e(".sub-tab"+a).addClass("sub-tab-sel"),e("#satisfy_ipt").val(a)},showSatisfy:function(t){if(this.allowEvaluateBaseWords>this.sendMsgNum&&1==t)return!1;if(this.satisfyType=t,2==t||3==t||this.satisfyEnable&&!this.satisfyShowed){view.inputBlur&&view.inputBlur(),this.resetStatisfy();var i=this.hideSatisfy,a=setTimeout(function(){clearTimeout(a),e("#mask").off("click",i).on("click",i).show(),e("#satisfy").show()},0);return view.handleShowSatisfy&&view.handleShowSatisfy(),!0}return!1},hideSatisfy:function(){var t=view.chat;e("#satisfy").removeClass("satisfy-show").hide(),e("#mask").hide().off("click",t.hideSatisfy),!1===t.chatting?(t.publish("_closeWin"),t.publish("__evaluate","0-2")):t.publish("__evaluate","0-1"),e.store("ECHAT_inviteSatisfyHandle",e.store("ECHAT_inviteSatisfyId")),view.SDK&&_$("sa_advise").blur(),view.hideSatisfy&&view.hideSatisfy()},addJS:function(e,i){function a(e){n.onload=n.onerror=n.onreadystatechange=null,s.removeChild(n),n=null,i(e)}var n=t.createElement("script");n.setAttribute("type","text/javascript");var s=_$s("head")[0];"onload"in n?(n.onload=a,n.onerror=function(){a(!0)}):n.onreadystatechange=function(){/loaded|complete/.test(n.readyState)&&a()},n.src=e,s.appendChild(n)},addCSS:function(e){var i=t.createElement("link");i.rel="stylesheet",i.type="text/css",i.href=e,i.media="screen";_$s("head")[0].appendChild(i)},loadEmoji:function(){var t=this;if(!t.emo){if(view.loadEmoji)return view.loadEmoji();this.addCSS(t.isMobile&&view.px2px?__uri("/visitor/mobile/css/emoji.css"):t.isMobile?locationBase+"/res/emoji/emoji_x2.css":locationBase+"/res/emoji/emoji.css"),e.ajax({url:locationBase+"/res/emoji/emoji.json",async:!0,type:"get",contentType:"application/json;charset=UTF-8",data:void 0,beforeSend:function(e){},success:function(e){t.emo=JSON.parse(e)},error:function(e,t,i){console.log("ajax emoji error")}}),e.ajax({url:locationBase+"/res/emoji/emoji_"+(window.lanName.match(/^zh/i)?"zh":"en")+".json",async:!0,type:"get",contentType:"application/json;charset=UTF-8",data:void 0,beforeSend:function(e){},success:function(e){t.emoLan=JSON.parse(e);var i={};for(var a in t.emoLan)i[t.emoLan[a]]=a;t.lanEmo=i},error:function(e,t,i){console.log("ajax emoji error")}}),e.ajax({url:locationBase+"/res/emoji/emojiFace.json",async:!0,type:"get",contentType:"application/json;charset=UTF-8",data:void 0,beforeSend:function(e){},success:function(i){var a=JSON.parse(i);view.initEmotion.call(t,a),e("#emotion").on(t.isMobile?"tap":"click",".emoji",function(i){var a=e(this).attr("code"),n=t.getInput().length+a.length+4,s=t.inputMaxLength;n>s||(e("#inputLengthTip").html(lanRes.inputLengthTip1+(s-n)+lanRes.inputLengthTip2),!t.isMobile&&t.focusInput(),t.insertImg(a),t.oldBodyEnterText=t.getInput())})},error:function(e,t,i){console.log("ajax emoji error")}})}},filterEmo:function(e){if(!e||"string"!=typeof e)return e;var t=this.emo;return t&&(e=e.replace(this.regFace,function(e){arguments[0];var i=e.charCodeAt(0),a=e.charCodeAt(1),n=(a-56320+(i-55296<<10)+65536).toString(16);return t[n]?'<img class="img-emo" src="'+locationBase+"/res/emoji/32/"+n+'.png" />':t[i+"_"+a]?'<img class="img-emo" src="'+locationBase+"/res/emoji/32/"+i+"_"+a+'.png" />':e})),e=e.replace(this.regEmo,function(e){var i=e.replace(/^\[#([\d\w_]+)#\]/g,"$1");return t&&t[i]||!t?'<img class="img-emo" src="'+locationBase+"/res/emoji/32/"+i+'.png" />':e})},HTMLDecode:function(e){var i=t.createElement("div");null!=i.textContent?i.textContent=e:i.innerText=e;var a=i.innerHTML;return i=null,a},getFileSize:function(e,i){if(""!=e.value){var a=-1;if(e.files&&e.files[i])a=parseInt(e.files[i].size);else try{e.select();var n=t.selection.createRange().text;a=new ActiveXObject("Scripting.FileSystemObject").GetFile(n).size}catch(e){console.log("如果你用的是ie8以下 请将安全级别调低！")}return a}},hasFormData:function(){var e=!0;try{1==view.windowType&&new FileReader,new FormData}catch(t){e=!1}return e}(),hasInitFile:!1,addSendFile:function(){if(!view.SDKNative){if(this.hasInitFile)if(this.hasFormData);else{(i=_$("file_up"))&&(i.src="/visitor/common/upload.html?t="+(new Date).getTime())}else if(this.hasFormData)window.fLoad(t);else{var i=_$("file_up");if(i)return;e("#uploadForm").remove(),e(".menu-file").append('<iframe src="/visitor/common/upload.html" style="filter:alpha(opacity=0.1);opacity: 0.1;position: absolute;top:0;left:0;z-index: 999999999;" allowtransparency="true" id="file_up" frameborder="0" framespacing="0" marginheight="0" marginwidth="0" width="100%" height="100%" scrolling="no"></iframe>')}}},isImgHasPreview:function(t){var i=e(t);if(i.hasClass("msg-img"))return!0;if(i.hasClass("img-emo")||i.hasClass("custom-event-img")||!t.src)return!1;if(i.parents(".msg-info").length||i.parents(".msg-info0").length||i.parents(".msg-item").length){if(i.parents("a").attr("href"))return!1;if(!i.hasClass("info-icon-img")&&!i.parents(".portrait-title").length&&!i.parents(".feedback-btns").length)return!0}},setMerchantLogo:function(t){var i=[],a="",n="",s=t.chatLogoImgEnable,o="",r="";this.staffInfoRefreshMap.merchantLink=null,"1"==s&&(a="1"==t.chatLogoImgType?this.platformLogo:this.companyLogo)&&i.push('<img class="header-logo" src="'+a+'"/>'),"1"==t.companyNameEnable&&(n="1"==t.companyNameType?this.platformName:this.companyName)&&i.push('<span class="header-logo-txt">'+n+"</span>"),"1"==t.subcompanyUrlEnable&&((o=t.subcompanyUrl)&&(r=this.getADURL(!0,t.subcompanyAdPostParamList,o,this.paramChat)),t.subcompanyButtonUrl&&i.push('<a class="merchant-link" href="'+(r||"")+'" target="_blank"><img class="merchant-icon" src="'+t.subcompanyButtonUrl+'"/></a>'),r&&(this.staffInfoRefreshMap.merchantLink={notEnableParam:!1,params:t.subcompanyAdPostParamList,element:".merchant-link",hash:!1,srcUrl:o,attr:"href",url:""})),e("#logobox").html(i.join(""))}},window.imgLoadResizeSelf=function(e){view.px2rem&&(e.style.width=view.px2rem(e.naturalWidth||e.width))},window.imgLoadResize=function(t,i){function a(){var t=1==view.windowType?600:260,a=this.naturalWidth||this.width,o=_$(n);o&&(a>t&&(a=t),o.style.width=view.px2rem?view.px2rem(a):a+"px",-1==i&&(o.style.marginLeft=view.px2rem?view.px2rem(-a/2):-a/2+"px"),e("#"+s).removeClass("hide").css("width",view.px2rem?view.px2rem(a):a+"px"),view.scrollToBottom())}Math.random();var n=-1==i?"entry":"inviteBook"+i,s=-1==i?"entryWrapImg":"inviteBookImg"+i;if(t.naturalWidth)a.call(t);else{var o=new Image;o.onload=a,o.src=t.src}};var u=!1;e(function(t){u=!0;var i=new c;setTimeout(window.initChat,0),"firefox"==i.Browser.browser&&e("body").on("drop",function(e){e.stopPropagation()}),"xcx"==i.queryParams.launchfrom&&i.addJS("https://res.wx.qq.com/open/js/jweixin-1.3.2.js"),522116==i.companyId&&(lanRes.chatWith=" ","enus"==window.lanResName?lanRes.tip="Message":"zhcn"==window.lanResName?lanRes.tip="讯息":"zhtw"==window.lanResName&&(lanRes.tip="訊息"))})}(EChatQuery,document);