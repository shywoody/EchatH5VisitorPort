function InputHandle(){var e=this;this.filterPasteData=function(e,t,i){var a=e&&e.replace(/^(<div>)(<br(\/)?>)+(<\/div>)/gi,"").replace(/(<div>)(<br(\/)?>)+(<\/div>)/gi,"\n").replace(/<([br|hr|div])+(\/)?>/gi,"\n").replace(/<\/(br|p|table|section|footer|article|li|ul|ol)>/gi,"\n").replace(/(<[a-z]+(\s+[^>]*)?\/?>)|(<\/[a-z]+>)/gi,"").replace(/&nbsp;/g," ");return"function"==typeof String.prototype.trimEnd?(t&&(e=e.trimEnd()),a=a.trimEnd()):(t&&(e=e.replace(/(\n|\r|[<br>]|\s)+$\w{0}/g,"")),a=a.replace(/(\n|\r|[<br>]|\s)+$\w{0}/g,"")),e&&t?e:a},this.getInput=function(t){var i=e.inputMaxLength||15e3;if(e.plainText){var a=$("#textInput").val();if(a){if(t){$("#textInput").val("");_$("textInput")}return a.length>i&&(a=a.substring(0,i),e.setInput(a)),e.filterPasteData(a,!0,!0)}return a}var n,o,s,r=e.getInputDocBody();return null!=r.lastElementChild&&"SL_balloon_obj"==r.lastChild.id&&r.removeChild(r.lastChild),n=r.innerHTML,o=n.replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[#$1#]"),t&&(r.innerHTML="",$("#inputPlaceholder").removeClass("hide")),(s=n.length>15e3?o:e.filterPasteData(o,!1,!0)).length>i&&(s=s.length>15e3?e.filterPasteData(s.substring(0,i),!1,!0):s.substring(0,i),e.setInput(s)),s},this.setInput=function(t){if(!t)return this.getInput(!0);if(e.plainText)t=t.replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[#$1#]").replace(/<(?!br|\/br)(?:.|\s)*?>/gi,"").replace(/&nbsp;/gi," ").replace(/^((<\/?br\/?>)|[\r\n\s]+)+|((<\/?br\/?>)|[\r\n\s]+)+$/gi,""),$("#textInput").val(t);else{t=t.replace(/\[#([^#]+)#\]/g,function(e,t){return'<img class="img-emo" src="'+("/res/emoji/24/"+t+".png")+'" border="0" code="'+t+'" unselectable="on"/>'});e.getInputDoc();e.getInputDocBody().innerHTML=t}},this.inputScrollToView=function(e){function t(){a>15||setTimeout(function(){var e=window.innerHeight+(i.isIOS?80:20);window.scrollTo(0,e),a++,t()},100)}var i=this,a=1;$(e).on("focus",function(e){window.top==window?(t(),a=1):i.postMessage("inputScroll")}),$(e).on("blur",function(e){a=1,setTimeout(function(){i.postMessage("inputScrollStop")},550)})},this.changeToIframe=function(e,t){function i(e){$("#inputPlaceholder").addClass("hide");var t=s.getInputDoc(),i=null;return t.selection?i=t.selection.createRange():s.win.getSelection&&s.win.getSelection().rangeCount&&(i=s.win.getSelection().getRangeAt(0)),i&&(s.win.pos=i)}function a(){i(),view.hideMenus(0)}function n(){i(),s.getInput(!1)||$("#inputPlaceholder").removeClass("hide")}function o(e,t,i){e.addEventListener?e.addEventListener(t,i):e.attachEvent("on"+t,i)}if(this.plainText){this.plainText=!1,this.editorType=2;var s=this;$("#textInput").hide();var r=_$("html_input");if(r.style.display="block",!this.hasInitIframeInput){this.hasInitIframeInput=!0;var l=s.getInputDoc();try{l.designMode="on"}catch(e){console.log(e)}l.contentEditable=!0;try{window.isIE6?l.write('<html><head><meta http-equiv="Content-type" content="text/html;charset=utf-8"><style type=\'text/css\'>html,body{width:100%;height:100%;max-height: 100%;overflow-y: auto;overflow-x:hidden;margin:0;padding:0;background-color:transparent;font-family: "Microsoft YaHei", "Helvetica Neue", Helvetica,"微软雅黑", Arial, sans-serif, STHeiti, FangSong;}</style></head><body contenteditable="true"></body></html>'):(l.open(),l.write('<html><head><meta http-equiv="Content-type" content="text/html;charset=utf-8"><style type=\'text/css\'>html,body{width:100%;height:100%;max-height: 100%;overflow-y: auto;overflow-x:hidden;margin:0;padding:0;background-color:transparent;font-family: "Microsoft YaHei", "Helvetica Neue", Helvetica,"微软雅黑", Arial, sans-serif, STHeiti, FangSong;}'+(1==view.windowType?"":" .img-emo{width:20px;height:20px;")+'}</style></head><body contenteditable="true"></body></html>'),l.close())}catch(e){}var d=l.getElementsByTagName("body")[0],c="margin:0;padding:0;word-break:break-all;word-wrap: break-word;width:100%;line-height:1.2;overflow-y: auto;overflow-x:hidden;";window.rtl&&(c+="direction: rtl;text-align: right;"),d.style.cssText=c,s.win=r.contentWindow||document.frames.html_input,s.getPos=i,o(s.win,"focus",a),o(s.win,"blur",n),o(d,"focus",a),o(d,"blur",n),o(d,"select",i),o(d,"click",function(e){i(),view.hideMenus()}),o(d,"keydown",function(e){$("#inputPlaceholder").addClass("hide");var t=e||s.win.event;return view.enter(t)}),o(d,"drop",function(e){setTimeout(function(){s.getInput(!1)&&$("#inputPlaceholder").addClass("hide")},100),s.Browser.browser}),o(l,"paste",function(e){setTimeout(function(){s.getInput(!1)?$("#inputPlaceholder").addClass("hide"):$("#inputPlaceholder").removeClass("hide")},100)}),s.isMobile&&s.inputScrollToView(d),view.initHtmlEdit&&view.initHtmlEdit(s.win,l),s.isMobile||s.addPaste(s.win,l),setTimeout(function(){s.getInput(!1)?$("#inputPlaceholder").addClass("hide"):$("#inputPlaceholder").removeClass("hide")},100)}}},this.preRange=null,this.changeToPreInput=function(){function e(e){var a,n=i.results[0];if(window.getSelection){var o=window.getSelection();try{a=o.getRangeAt(0)}catch(e){(a=document.createRange()).selectNodeContents(n),a.collapse(!1),a.select()}}else a=document.selection.createRange();return t.preRange=a,a}if(this.plainText){this.editorType=3,this.plainText=!1;var t=this;$("#textInput").hide();var i=$("#html_pre_input"),a=i.results[0];i.css("display","block"),t.isMobile&&t.inputScrollToView(t.getInputDocBody());var n;a.onkeyup=function(){clearTimeout(n),n=setTimeout(function(){e()},300)},a.onkeydown=function(e){$("#inputPlaceholder").addClass("hide");e||window.event;return view.enter(e)},a.ontouchend=function(t){setTimeout(function(){e()},50)},a.ontouchstart=function(e){$("#inputPlaceholder").addClass("hide")},a.onfocus=function(){$("#inputPlaceholder").addClass("hide"),e(),view.hideMenus(0)},a.onblur=function(){t.getInput(!1)||$("#inputPlaceholder").removeClass("hide")},a.onclick=function(){e(),view.hideMenus(0),a.focus()},t.getPos=e}},this.bindPlainTextEvent=function(){function e(e){var t,a=_$("textInput");if(window.getSelection){var n=window.getSelection();try{t=n.getRangeAt(0)}catch(e){(t=document.createRange()).selectNodeContents(a),t.collapse(!0)}}else t=document.selection.createRange();return i.textRange=t,t}this.plainText=!0,this.editorType=1,$("#textInput").show();var t=_$("html_input");$(t).hide();var i=this;$("#inputPlaceholder").addClass("hide"),i.isMobile,this.hasBindPlainTextEvent||(this.hasBindPlainTextEvent=!0,view.bindPlainTextEvent(),$("#textInput").off("keydown").on("keydown",function(t){t=t||window.event;if(i.handleInputLength&&setTimeout(i.handleInputLength,50),!1!==view.enter(t)){if(8==(t.keyCode||t.which||t.charCode||0)){var a=_$("textInput"),n=a.value;if(a.createTextRange)console.log("手机端IE?");else{var o=a.selectionStart,s=-1,r=0;o>0&&n.replace(/\[#([^#]+)#\]/g,function(e,t,i,a){return i<o&&i+e.length>=o&&(s=i,r=i+e.length),e}),-1!=s&&a.setSelectionRange(s,r)}}e()}}).on("change input",function(){e()}).on("paste",function(e){return i.filterPasteText(e,void 0,window,document)}).on("drop",function(e){i.handleInputLength&&setTimeout(function(){i.handleInputLength()})}).on("focus",e),setTimeout(function(){_$("textInput")&&_$("textInput").scrollIntoView(!1)},400),i.textRange=null,i.getPos=e)},this.filterPasteText=function(t,i,a,n){var o=n.getElementById("textInput");if(void 0===i&&(i=a.clipboardData&&clipboardData.setData?a.clipboardData.getData("text"):t.clipboardData&&t.clipboardData.setData?t.clipboardData.getData("text"):(t.originalEvent||t).clipboardData.getData("text/plain")||prompt("在这里输入文本")),i){if(i=e.filterPasteData(i,void 0,!0),t.returnValue=!1,t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation(),i&&e.plainText)if(n.selection){var s=n.selection.createRange();s.text=i}else if("number"==typeof o.selectionStart&&"number"==typeof o.selectionEnd){var r=o.selectionStart,l=o.selectionEnd,d=r,c=o.value;o.value=c.substring(0,r)+i+c.substring(l,c.length),d+=i.length,o.selectionStart=o.selectionEnd=d}else o.value+=i;else if(i&&n.body.createTextRange){if(n.selection)textRange=n.selection.createRange();else if(a.getSelection){var u=(s=a.getSelection()).getRangeAt(0),f=n.createElement("span");f.innerHTML="&#FEFF;",u.deleteContents(),u.insertNode(f),textRange=n.body.createTextRange(),textRange.moveToElementText(f),f.parentNode.removeChild(f)}textRange.text=i,textRange.collapse(!1),textRange.select()}else i&&n.execCommand("insertText",!1,i);return!1}return!0},this.getInputDoc=function(){var e;return 2==this.editorType?(e=_$("html_input").contentDocument)||(e=document.frames.html_input.document):e=document,e},this.getInputDocBody=function(){var e,t,i=this.editorType;return 3==i?(t=_$("html_pre_input")).blur||(t.blur=function(){window.focus()}):2==i?((e=_$("html_input").contentDocument)||(e=document.frames.html_input.document),t=e.body||e.getElementsByTagName("body")[0]):t=_$("textInput"),t},this.focusInput=function(e){var t,i,a,n=this.editorType;return 3==n?t=_$("html_pre_input"):2==n?(t=_$("html_input").contentWindow||document.frames.html_input,(i=_$("html_input").contentDocument)||(i=document.frames.html_input.document),a=i.body||i.getElementsByTagName("body")[0],!e&&a.focus()):t=_$("textInput"),!e&&t.focus(),!e&&a&&a.focus(),t},this.insertBr=function(){var t,i,a,n=e.win,o=this.getInputDoc().createElement("div"),s=this.getInputDoc().createElement("br");n.getSelection?t=n.getSelection():i=n.document.selection,(i=t.getRangeAt(0)).endContainer.data&&i.endContainer.data.length!==i.endOffset?a=s:(o.appendChild(s),a=o),t.removeAllRanges(),i.deleteContents(),i.insertNode(a),i.setStartAfter(a),i.setEndAfter(a),e.isMobile||(t.removeAllRanges(),t.addRange(i)),e.focusInput()},this.insertImg=function(e){var t=this;if(t.plainText)return view.insertImg?view.insertImg(_$("textInput"),"[#"+t.emoLan[e]+"#]"):(_$("textInput").value+="[#"+t.emoLan[e]+"#]",_$("textInput").scrollTop=_$("textInput").scrollHeight),void(view.textInputChange&&view.textInputChange());var i="/res/emoji/24/"+e+".png",a=this.getInputDoc(),n=this.getInputDocBody(),o=t.win,s=this.editorType,r=o?o.pos:null;if(3==s&&(o=window,r=t.preRange),a.selection&&!/opera/gi.test(view.chat.Browser.browser)){d='<img class="img-emo" src="'+i+'" border="0" code="'+e+'" unselectable="on"/>';if(r)o.focus(),setTimeout(function(){(r=o.pos||r).move("textedit"),r.pasteHTML(d),r.collapse(!0),r.select(),t.focusInput()},100);else{(d=a.createElement("img")).className="img-emo",d.src=i,d.border="0",d.setAttribute("code",e),d.setAttribute("unselectable","on"),a.getElementsByTagName("body")[0].appendChild(d),n.appendChild(d)}}else if(window.getSelection){var l,d;(d=a.createElement("img")).className="img-emo",d.src=i,d.border="0",d.setAttribute("code",e),d.setAttribute("unselectable","on"),r?((l=o.getSelection()).removeAllRanges(),r.deleteContents(),r.insertNode(d),r.setStartAfter(d),r.setEndAfter(d),this.isMobile||(l.removeAllRanges(),l.addRange(r))):n.appendChild(d),setTimeout(function(){n.scrollTop=d.offsetTop,t.focusInput()},100)}$("#inputPlaceholder").addClass("hide")},this.previewPasteImage=function(e){$("#pasteImg").attr("src",e.base64),$("#pastePreview").removeClass("hide"),$("#maskVerify").removeClass("hide")},this.addPaste=function(e,t){function i(){setTimeout(function(){for(var e=s.getInputDocBody().getElementsByTagName("img"),t=0;t<e.length;t++)e[t].getAttribute("code")||(e[t].parentNode?e[t].parentNode.removeChild(e[t]):e[t].removeNode&&e[t].removeNode(!0))},2)}function a(e){if(view.chat.isInRobot)s.showAlertDialog({tip:lanRes.pasteTip1});else if(i(),!0===s.companyOff||s.busyCanSend&&"0"!=s.queryParams.autoChat||!0===s.chatting)if(e.clipboardData&&e.clipboardData.items){var t=e.clipboardData.items;if(t)for(var a=t.length-1;a>-1;a--)if(-1!==t[a].type.indexOf("image")){var o=t[a].getAsFile(),r=(new Date).getTime()+"."+t[a].type.split("/")[1];!function(e,t){if(t&&e&&e.type.indexOf("image/")>-1){var i=new FileReader;i.onload=function(i){t({file:e,base64:i.target.result})},i.readAsDataURL(e)}else t&&t(null)}(o,function(e){e&&(e.fileName=r,s.previewPasteImage(e))});break}}else setTimeout(n,1)}function n(){function t(){for(var e=s.getInputDocBody().getElementsByTagName("img"),t=0;t<e.length;t++)e[t].src.match(/webkit-fake-url:/i)&&e[t].parentNode.removeChild(e[t])}for(var i,a=s.getInputDocBody().getElementsByTagName("img"),n=0;n<a.length;n++)if(!a[n].getAttribute("code")){i=a[n];break}if(i){var o=i.currentSrc||i.src;o.match(/data:image\/[\w]+;base64/i)?previewPasteImage({base64:o}):o.match(/blob/i)?console.log("blob******************src"):o.match(/webkit-fake-url:/)?(console.log("safari等浏览器 粘贴图片无法发送"),e.removeEventListener("paste",t),e.addEventListener("paste",t)):o.match(/^(http[s]?:\/\/[^\/]+|)\/.+/gi)&&(s.getInputDocBody().innerHTML+=lanRes.picture+":"+o),i.parentNode?i.parentNode.removeChild(i):i.removeNode&&i.removeNode(!0)}}var o,s=this;s.filterPaste(e,t),this.hasPasteCapture=o=s.hasFormData,!window.ltIE10&&o&&"safari"!=view.chat.Browser.browser||setTimeout(function(){$("#inputPlaceholder").attr("placeholder",lanRes.inputPlaceholder2).html(lanRes.inputPlaceholder2)},500),o?(e.addEventListener?(e.addEventListener("paste",a),window.addEventListener("paste",a)):e.attachEvent("onpaste",a),$("#pasteOK").on("click",function(){view.chat.publish("sendVisitorEvent",{et:123,uploadServiceType:s.uploadUtil.getUploadServiceType(),ssl:s.needHttps?1:void 0,ft:5},function(e){e.successful||(s.showTip(lanRes.networkFileError),$("#pasteError").removeClass("hide"),$("#pastePreview").removeClass("hide"),$("#maskVerify").removeClass("hide"))},{resend:!1}),s.captureFileSource=$("#pasteImg").attr("src").split("64,")[1]||s.captureFileSource,$("#pasteError").addClass("hide"),$("#pastePreview").addClass("hide"),$("#maskVerify").addClass("hide")}),$("#pasteCancel").on("click",function(){$("#pastePreview").addClass("hide"),$("#maskVerify").addClass("hide")})):t.addEventListener?t.addEventListener("paste",i):t.attachEvent("onpaste",i)},this.filterPaste=function(e,t){function i(e){return e.getSelection?e.getSelection():e.document.selection}function a(e,t){e.removeAllRanges(),e.addRange(t)}function n(e){e.preventDefault()}function o(o){if(!c.plainText){var f=void 0;try{if(f=e.clipboardData&&e.clipboardData.getData?e.clipboardData.getData("Text"):o.clipboardData.getData("Text")||o.clipboardData.getData("text/plain"))return console.log("获取到了文本，就去按获取到的文本处理",f),c.filterPasteText(o,f,e,t)}catch(e){f=f&&c.filterPasteData(f)||""}return function(e,t){var o=t,f=_$("html_input"),m=f.contentWindow.document;{if(u){var h=m.selection.createRange();if(o)d=o;else{var p=document.getElementById("ifmTemp");p?p.contentWindow.document.body.innerHTML="":((p=document.createElement("IFRAME")).id="ifmTemp",p.style.width="1px",p.style.height="1px",p.style.position="absolute",p.style.border="none",p.style.left="-10000px",p.src="iframeblankpage.html",document.body.appendChild(p),p.contentWindow.document.designMode="On",p.contentWindow.document.open(),p.contentWindow.document.write("<body></body>"),p.contentWindow.document.close()),l=f.contentWindow.document.body.innerText,p.contentWindow.focus(),p.contentWindow.document.execCommand("Paste",!1,null),f.contentWindow.focus(),d="string"==typeof p.contentWindow.document.body.textContent?p.contentWindow.document.body.textContent:p.contentWindow.document.body.innerText,d=c.filterPasteData(d)}return h.pasteHTML(d),e&&(e.returnValue=!1,e.preventDefault&&e.preventDefault()),!1}if(o)return f.contentWindow.document.execCommand("inserthtml",!1,o),e&&(e.returnValue=!1,e.preventDefault&&e.preventDefault()),!1;var g=m.createElement("DIV");g.id="htmleditor_tempdiv",g.innerHTML="\ufeff",g.style.left="-10000px",g.style.height="1px",g.style.width="1px",g.style.position="absolute",g.style.overflow="hidden",m.body.appendChild(g),f.contentWindow.document.addEventListener("mousedown",n,!1),f.contentWindow.document.addEventListener("keydown",n,!1),enableKeyDown=!1,s=f.contentWindow,r=i(s).getRangeAt(0);var v=g.firstChild,b=m.createRange();return b.setStart(v,0),b.setEnd(v,1),a(i(s),b),"\ufeff"===(l="string"==typeof f.contentWindow.document.body.textContent?f.contentWindow.document.body.textContent:f.contentWindow.document.body.innerText)&&(l=""),window.setTimeout(function(){if("\ufeff"===g.innerHTML)return d="",void m.body.removeChild(g);d="string"==typeof g.textContent?g.textContent:g.innerText,r&&a(i(s),r),d=c.filterPasteData(d),g.innerHTML=d,f.contentWindow.document.execCommand("inserthtml",!1,d),m.body.removeChild(g)},1),enableKeyDown=!0,f.contentWindow.document.removeEventListener("mousedown",n,!1),f.contentWindow.document.removeEventListener("keydown",n,!1),!0}}(o,f)}}var s,r,l,d,c=this,u=-1!=navigator.appName.indexOf("Microsoft"),f=document.getElementById("html_input");f&&(u?(f.contentWindow.document.documentElement.attachEvent("onpaste",o),f.contentWindow.document.documentElement.attachEvent("ondrop",c.filterDrop)):(f.contentWindow.document.addEventListener("paste",o,!1),f.contentWindow.document.body.addEventListener("drop",c.filterDrop,!1)))},this.filterDrop=function(t){var i=(t=t||window.event).dataTransfer&&t.dataTransfer.getData("text");if(!i)return t.returnValue=!1,t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation(),!1;i=e.filterPasteData(i,void 0,e.plainText),e.isInrobot&&(i=i.substring(0,e.maxRobotLength));var a=e.getInputDoc(),n=e.getInputDocBody(),o=e.win,s=e.editorType,r=o?o.pos:null;if(3==s)o=window,r=e.preRange;else if(1==s)return void(r=e.textRange);if(a.selection&&!/opera/gi.test(view.chat.Browser.browser)){if(e.plainText?this.focus():o.focus(),!r)return t.dataTransfer.setData("text"),!0;setTimeout(function(){(r=(3==s?e.preRange:1==s?e.textRange:o.pos)||r).pasteHTML(i),r.collapse(!0),r.select()},1)}else if(window.getSelection){var l;if(r)if(1==s)_$("textInput").focus(),document.execCommand("insertText",!1,i);else{var d=a.createElement("div");d.innerHTML=i,(l=o.getSelection()).removeAllRanges(),r.deleteContents(),r.insertNode(d),r.setStartAfter(d),r.setEndAfter(d),e.isMobile||(l.removeAllRanges(),l.addRange(r))}else n.innerHTML+=i;d&&setTimeout(function(){n.scrollTop=d.offsetTop},100)}return t&&(t.returnValue=!1,t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault()),!1}}!function(){var e=function(){function e(e){return e._zid||(e._zid=ee++)}function t(e){C.createElement;var t=C.createElement("div");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function i(e,t,a){var n=t&&t.ownerDocument,a=a||[];return e?e.nodeType||e==window.document||e==window?(this.context=e,this.results=[e],this.length=1,this):V(e)?void 0!==G?this.readyList.push(e):e():e instanceof i?e:((t?t.ownerDocument||t:S)!==C&&v(t),t=t||C,this.selector=e,this.context=t,this.results=function(e,t,i,a){if(!e)return i;var n,o,s,r,l,d=t?t.nodeType:9;if(r=b.exec(e),11!==d&&r)if(n=r[1]){if(9===d){if(!(s=t.getElementById(n)))return i;if(s.id===n)return i.push(s),i}else if(t.ownerDocument&&(s=t.ownerDocument.getElementById(n))&&g(t,s)&&s.id===n)return i.push(s),i}else{if(n=r[2])return(u=k.find.TAG(n,t))&&D.apply(i,u),i;if((n=r[3])&&_.getElementsByClassName&&t.getElementsByClassName)return D.apply(i,t.getElementsByClassName(n)),i}1!==d&&(a=t,l=e);if(l)try{return D.apply(i,a.querySelectorAll(l)),i}catch(e){}if(!r)return i;var c,u=k.find.TAG("*",t),f=u.length;{if(o=0,c=r[2]){var m=[];if(i=t.getElementsByTagName(c),s=Z,"*"===c){for(;s=i[o++];)1===s.nodeType&&m.push(s);return m}return i}for(var h=(0,H.CLASS)(r[3]);o!==f&&null!=(s=u[o]);o++)s&&1===s.nodeType&&h(s)&&i.push(s)}return i}(e,t,a,n),void(this.length=this.results.length)):(this.length=0,this.results=this.results||a,this)}function a(e){return"object"==function(e){return null==e?String(e):K[z.call(e)]||"object"}(e)}function n(e,t,i){for(var a in t)i&&(J(t[a])||j(t[a]))?(J(t[a])&&!J(e[a])&&(e[a]={}),j(t[a])&&!j(e[a])&&(e[a]=[]),n(e[a],t[a],i)):t[a]!==Z&&(e[a]=t[a])}function e(e){return e._zid||(e._zid=ee++)}function o(t,i,a,n){function o(t){return t&&(!i.e||t.e==i.e)&&(!i.ns||r.test(t.ns))&&(!a||e(t.fn)===e(a))&&(!n||t.sel==n)}if((i=s(i)).ns)var r=function(e){return new RegExp("(?:^| )"+e.replace(" "," .* ?")+"(?: |$)")}(i.ns);for(var l=te[e(t)]||[],d=[],c=0;c<l.length;c++)o(l[c])&&d.push(l[c]);return d}function s(e){var t=(""+e).split(".");return{e:t[0],ns:t.slice(1).sort().join(" ")}}function r(e,t){return e.del&&!ae&&e.e in ne||!!t}function l(e){return oe[e]||ae&&ne[e]||e}function d(t,i,a,n,o,d,c){var f=e(t),m=te[f]||(te[f]=[]);h.fn.each(i.split(/\s/),function(e,i){if("ready"==i)return h(C).ready(a);var f=s(i);f.fn=a,f.sel=o,f.e in oe&&(a=function(e){var t=e.relatedTarget;if(!t||t!==this&&!h.contains(this,t))return f.fn.apply(this,arguments)}),f.del=d;var p=d||a;f.proxy=function(e){if(!(e=u(e)).isImmediatePropagationStopped()){e.data=n;var i=p.apply(t,e._args==Z?[e]:[e].concat(e._args));return!1===i&&(e.preventDefault(),e.stopPropagation()),i}},f.i=m.length,m.push(f),"addEventListener"in t?t.addEventListener(l(f.e),f.proxy,r(f,c)):t.attachEvent("on"+l(f.e),f.proxy)})}function c(t,i,a,n,s){var d=e(t);h.fn.each((i||"").split(/\s/),function(e,i){h.fn.each(o(t,i,a,n),function(e,i){delete te[d][i.i],"removeEventListener"in t?t.removeEventListener(l(i.e),i.proxy,r(i,s)):t.detachEvent("on"+l(i.e),i.proxy)})})}function u(e,t){return!t&&e.isDefaultPrevented||(t||(t=e),h.each(de,function(i,a){var n=t[i];e[i]=function(){return this[a]=se,n&&n.apply(t,arguments)},e[a]=re}),(t.defaultPrevented!==Z?t.defaultPrevented:"returnValue"in t?!1===t.returnValue:t.getPreventDefault&&t.getPreventDefault())&&(e.isDefaultPrevented=se)),e}function f(e){var t,i={originalEvent:e};for(t in e)le.test(t)||e[t]===Z||(i[t]=e[t]);return u(i,e)}function m(){}var h,p,g,v,b=/^(?:#([\w-/_]+)|(\w+)|\.([\w-]+))$/,y=/^[^{]+\{\s*\[native \w/,w=/[\t\r\n\f]/g,I=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,T=/\S+/g,k={find:{},filter:{}},S=window.document,C=window.document,x="echatQuery"+1*new Date,_={},E=[],M=E.slice,D=E.push,N=new RegExp("\\\\([\\da-f]{1,6}"+P+"?|("+P+")|.)","ig"),R=function(e,t,i){var a="0x"+t-65536;return a!=a||i?t:a<0?String.fromCharCode(a+65536):String.fromCharCode(a>>10|55296,1023&a|56320)},P="[\\x20\\t\\r\\n\\f]",L=function(){v()},H={TAG:function(e){var t=e.replace(N,R).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=new RegExp("(^|"+P+")"+e+"("+P+"|$)");return function(e){return t.test("string"==typeof e.className&&e.className||void 0!==e.getAttribute&&e.getAttribute("class")||"")}}};_.getElementsByTagName=t(function(e){return e.appendChild(C.createComment("")),!e.getElementsByTagName("*").length}),(v=function(e){var i,a,n=e?e.ownerDocument||e:S;return n===C||9!==n.nodeType||n.documentElement,C=n,p=C.documentElement,(a=C.defaultView)&&a.top!==a&&(a.addEventListener?a.addEventListener("unload",L,!1):a.attachEvent&&a.attachEvent("onunload",L)),_.attributes=t(function(e){return e.className="i",!e.getAttribute("className")}),_.getElementsByTagName=t(function(e){return e.appendChild(C.createComment("")),!e.getElementsByTagName("*").length}),_.getElementsByClassName=y.test(n.getElementsByClassName),_.getById=t(function(e){return p.appendChild(e).id=x,!C.getElementsByName||!C.getElementsByName(x).length}),_.getById?(k.find.ID=function(e,t){if(void 0!==t.getElementById){var i=t.getElementById(e);return i?[i]:[]}},k.filter.ID=function(e){var t=e.replace(N,R);return function(e){return e.getAttribute("id")===t}}):(delete k.find.ID,k.filter.ID=function(e){var t=e.replace(N,R);return function(e){var i=void 0!==e.getAttributeNode&&e.getAttributeNode("id");return i&&i.value===t}}),_.qsa=y.test(n.querySelectorAll),k.find.TAG=_.getElementsByTagName?function(e,t){return void 0!==t.getElementsByTagName?t.getElementsByTagName(e):_.qsa?t.querySelectorAll(e):void 0}:function(e,t){for(var i,a=[],n=0,o=S.getElementsByTagName(e);i=o[n++];)1===i.nodeType&&g(t,i)&&a.push(i);return a},k.find.CLASS=_.getElementsByClassName&&function(e,t){if(void 0!==t.getElementsByClassName&&documentIsHTML)return t.getElementsByClassName(e)},i=y.test(p.compareDocumentPosition),g=i||y.test(p.contains)?function(e,t){if(!e||!t)return!1;var i=9===e.nodeType?e.documentElement:e,a=t&&t.parentNode;return e===a||!(!a||1!==a.nodeType||!(i.contains?i.contains(a):e.compareDocumentPosition&&16&e.compareDocumentPosition(a)))}:function(e,t){if(!e)return!1;if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},n})();var F=0,B=/(\=)\?(&|$)|\?\?/i;(h=function(e,t,a){return new i(e,t)}).ajaxJSONP=function(e,t){function i(i,n){h(r).remove(),i&&"error"==i.type||!a?e.error&&e.error(null,n||"error",c,e,t):e.success&&e.success(a[0],c,e,t),window[s]=l,a&&V(l)&&l(a[0]),l=a=Z}if(!("type"in e))return h.ajax(e);var a,n=window.document,o=e.jsonpCallback,s=(V(o)?o():o)||"jsonp"+ ++F,r=n.createElement("script"),l=window[s],d=function(t){e.errorSwitch?e.errorSwitch():i({type:"error",timeout:1}),h(script).triggerHandler("error",t||"abort")},c={abort:d};t&&t.promise(c);n.getElementsByTagName("head")[0];window[s]=function(){a=arguments};var u="$1"+s+"$2";e.url=e.url.replace(B,u);var f="";if(e.data){for(var m in e.data){var p="string"==typeof e.data[m]?e.data[m]:JSON.stringify(e.data[m]);f="&"+m+"="+encodeURIComponent(p)}f&&(f=f.substring(1),f+="&")}e.url+=(/\?/.test(e.url)?"&":"?")+f+(e.jsonpCB||"jsonp")+"="+s;return"onload"in r?(r.onload=i,r.onerror=function(){i({type:"error"})}):r.onreadystatechange=function(){/loaded|complete/.test(r.readyState)&&i()},e.beforeSend&&!1===e.beforeSend(c)?(console.log("abort",e),c):(r.src=e.url,n.getElementsByTagName("head")[0].appendChild(r),e.timeout>0&&(abortTimeout=setTimeout(function(){d("timeout"),c.isTimeout=1},e.timeout)),c)};var A=function(){var e=navigator.userAgent.match(/rv:([\d.]+)/i),t=!1;return e&&e[1]&&e[1]>=11&&(t=!0),function(e){return t&&!e.url.match(/\.(json|js|png|jpeg)$/i)}}();h.ajax=h._ajax=function(e){if("jsonp"==e.jsonp||"JSONP"==e.jsonp||"jsonp"==e.type||"JSONP"==e.type)return h.ajaxJSONP(e,e.deferred);var t=function(){var e;try{e=new XMLHttpRequest}catch(n){for(var t=["Msxml3.XMLHTTP","Msxml2.XMLHTTP","Microsoft.XMLHTTP"],i=0,a=t.length;i<a;i++)try{e=new ActiveXObject(t[i]);break}catch(e){continue}}return e}();t.onreadystatechange=function(){4==t.readyState&&(200==t.status?e.success&&e.success(t.responseText):0==t.status&&e.errorSwitch?e.errorSwitch():e.error&&e.error(t,t.responseText))};var i=e.data,a="";if(i&&"[object object]"==Object.prototype.toString.apply(i).toLowerCase())for(var n in i)a+="&"+n+"="+encodeURIComponent(i[n]);a&&e.type.match(/get/i)&&(-1!=e.url.indexOf("?")?e.url+=a:e.url+="?"+a.substring(1),a="",i=null),window.XMLHttpRequest?i||(i=null):i||(i=Z),t.open(e.type.toUpperCase(),e.url,!0),e.timeout&&(t.timeout=e.timeout);try{var o=e.xhrFields||(A(e)?{withCredentials:!0}:Z);for(fe in o)t[fe]=e.xhrFields[fe]}catch(e){}if(e.header)for(var s in e.header)t.setRequestHeader(s,e.header[s]);return e.header&&(e.header["Content-Type"]||e.header["Content-type"]||e.header["content-type"])&&!1===e.contentType||t.setRequestHeader("Content-type",e.contentType||"application/json;charset=UTF-8;"),e.beforeSend&&e.beforeSend(t),t.onAbort=function(){},t.send(a?a.substring(1):i),t};var O,U=/^-ms-/,$=/-([\da-z])/gi,q=function(e){return e.replace(U,"ms-").replace($,function(e,t){return t.toUpperCase()})};!function(){var e,t,i;(e=C.createElement("div")).innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",t=(t=(i=e.getElementsByTagName("a")[0])&&i.style).cssText="float:left;opacity:.5",O={float:t.cssFloat?"cssFloat":"styleFloat"},e=null,i=null}();var V=function(e){return null!=e&&("function"==typeof e||"[object Function]"===Object.prototype.toString.call(e))},j=function(e){return"[object Array]"===Object.prototype.toString.apply(e)},W=function(e){return"string"==typeof e},K={},z=K.toString,J=function(e){return a(e)&&!function(e){return null!=e&&e==e.window}(e)&&Object.getPrototypeOf(e)==Object.prototype},Q=function(e){return null==e?"":(e+"").replace(I,"")};h.extend=function(e,t,i){for(var a in t)i&&(J(t[a])||j(t[a]))?(J(t[a])&&!J(e[a])&&(e[a]={}),j(t[a])&&!j(e[a])&&(e[a]=[]),n(e[a],t[a],i)):t[a]!==Z&&(e[a]=t[a]);return e},h.cookie=function(e,t,i){if(arguments.length>1&&(!/Object/.test(Object.prototype.toString.call(t))||null===t||t===Z)){if(i=h.extend({},i),null!==t&&t!==Z||(i.expires=-1),"number"==typeof i.expires){var a=i.expires,n=i.expires=new Date;n.setDate(n.getDate()+a)}return t=String(t),C.cookie=[encodeURIComponent(e),"=",i.raw?t:encodeURIComponent(t),i.expires?"; expires="+i.expires.toUTCString():"","; path="+(i.path||"/"),i.domain?"; domain="+i.domain:"",i.secure?"; secure":""].join("")}for(var o,s=(i=t||{}).raw?function(e){return e}:decodeURIComponent,r=C.cookie.split("; "),l=0;o=r[l]&&r[l].split("=");l++)if(s(o[0])===e)return s(o[1]||"");return null},h.toJSON=JSON.stringify;var X={src:!0,href:!0},Y={isFunction:V,isArray:j,isString:W,isObject:a,isPlainObject:J,trim:Q,contains:g,readyList:[],find:function(e){var t={};return this.each(function(a,n){i.call(t,e,n,t.results)}),t},match:function(e,t){var a=null;return new i(t).each(function(t,i){if(i==e||g(i,e))return a=i,!0}),a},parents:function(e){var t,a,n,o,s;if(e&&this.results&&this.results.length>0&&(t=b.exec(e))&&((s=t[1])?a=function(e){return e.id==s}:(s=t[2])?(s=s.toUpperCase(),a=function(e){return e.tagName==s}):(s=t[3])&&(a=function(e){if(e.className){for(var t=e.className.split(" "),i=0;i<t.length;i++)if(t[i]==s)return!0;return!1}}),a))for(n=this.results[0];o=n.parentNode;){if(a(o))return new i(o,this.context,[]);n=o}return new i(null,this.context,[])},html:function(e){return e||""===e?this.each(function(t,i){i.innerHTML=e}):this.results&&this.results[0]?this.results[0].innerHTML:null},text:function(e){return"string"==typeof e?this.each(function(t,i){"string"==typeof i.textContent?i.textContent=e:i.innerText=e}):this.results&&this.results[0]?this.results[0].textContent||this.results[0].innerText:null},append:function(e){if(e){if(W(e)){var t=C.createElement("div");t.innerHTML=e;var i=t.childNodes;this.each(function(e,t){for(var a,e=0;a=i[e++];)1==a.nodeType&&(a=a.cloneNode(!0),t.appendChild(a))})}else this.each(function(t,i){i.appendChild(e)});return this}},insertBefore:function(e,t){if(e){var i;if(W(e)){var a=C.createElement("div");a.innerHTML=e;var n=a.childNodes;this.each(function(e,a){for(var o,e=0;o=n[e++];)1==o.nodeType&&(o=o.cloneNode(!0),(i=t||a.childNodes[0])?a.insertBefore(o,i):a.appendChild(o))})}else this.each(function(a,n){(i=t||n.childNodes[0])?n.insertBefore(e,i):n.appendChild(e)});return this}},show:function(){return this.each(function(e,t){t.style.display="block"}),this},hide:function(){return this.each(function(e,t){t.style.display="none"}),this},removeClass:function(e){for(var t,i,a,n,o=this.results.length,s=0,r=0,l=(e||"").match(T)||[];r<o;r++)if(t=this.results[r],i=1===t.nodeType&&(t.className?(" "+t.className+" ").replace(w," "):"")){for(s=0;a=l[s++];)for(;i.indexOf(" "+a+" ")>=0;)i=i.replace(" "+a+" "," ");n=e?Q(i):"",t.className!==n&&(t.className=n)}else t.className="";return this},addClass:function(e){for(var t,i,a,n,o=this.results.length,s=0,r=0,l=(e||"").match(T)||[];r<o;r++)if(t=this.results[r],i=1===t.nodeType&&(t.className?(" "+t.className+" ").replace(w," "):"")){for(s=0;a=l[s++];)for(;i.indexOf(" "+a+" ")<0;)i+=a+" ";n=e?Q(i):"",t.className!==n&&(t.className=n)}else t.className=e;return this},attr:function(e,t){if(!e)return this;if(void 0===t){if("string"==typeof e)return this.results&&this.results.length>0?this.getAttr(this.results[0],e):"";a=this.results?this.results.length:0;for(var i in e)for(n=0;n<a;n++){o=this.results[n];X[i]?o[i]=e[i]:o.setAttribute(i+"",e[i])}}else for(var a=this.results?this.results.length:0,n=0;n<a;n++){var o;(o=this.results[n]).setAttribute(e,t),X[e]?o[e]=t:o.setAttribute(e,t)}return this},css:function(e,t){if(!e)return this;if(void 0===t)if("string"==typeof e)this.css(e,0===t?"0":"inherit");else for(var i=this.results?this.results.length:0,a=0;a<i;a++)for(var n in e){o=q(n);o=O[o]||o;s=this.results[a];try{s.style[o]=e[n]}catch(e){console.log(e.message),console.log("css:"+o+":"+n)}}else try{for(var i=this.results?this.results.length:0,a=0;a<i;a++){var o=q(e);o=O[o]||o;var s;(s=this.results[a]).style[o]=t}}catch(e){return this}return this},remove:function(){for(var e=this.results?this.results.length:0,t=0;t<e;t++){var i=this.results[t];i.parentNode.removeChild(i)}return this.length=0,this.results=[],this},removeAttr:function(e){return this.each(function(t,i){i.setAttribute(e,""),i.removeAttribute(e)})},ready:function(e){for(var t,i=0;this.readyList&&(t=this.readyList[i]);)t.call(window),i++;return this},hasClass:function(e){for(var t=this.results?this.results.length:0,i=[],a=H.CLASS(e),n=0;n<t;n++){var o=this.results[n];a(o)&&i.push(o)}return i.length},max:function(e,t){return e>t?e:t},width:function(){return this.results&&this.results[0]?Y.max(this.results[0].offsetWidth,this.results[0].clientWidth):null},height:function(){return this.results&&this.results[0]?Y.max(this.results[0].offsetHeight,this.results[0].clientHeight):null},val:function(e){return void 0===e?this.results&&this.results[0]?this.results[0].value:null:(this.results&&this.results[0]&&(this.results[0].value=e+""),this)},getAttr:function(e,t){return e.getAttribute(t)},each:function(e,t){if(j(e))for(i=0;i<e.length&&!t.call(e[i],i,e[i]);i++);else if(V(e)){t=e,e=this.results||[];for(i=0;i<e.length&&!t.call(e[i],i,e[i]);i++);}else for(var i in e)if(t.call(e[i],i,e[i]))break;return this}},G=function(){function e(){n.removeEventListener("DOMContentLoaded",e,!1),n.removeEventListener("load",e,!1),a()}function t(){"complete"==n.readyState&&(n.detachEvent("onreadystatechange",t),n.detachEvent("onload",i),a())}function i(){n.detachEvent("onreadystatechange",t),n.detachEvent("onload",i),a()}var a=function(){G&&(Y.ready(),G=Z)},n=window.document;if(n.addEventListener)n.addEventListener("DOMContentLoaded",e,!1),window.addEventListener("load",e,!1);else if(n.attachEvent)n.attachEvent("onreadystatechange",t),window.attachEvent("onload",i);else if(n.lastChild==n.body)return a();(n.getElementsByTagName("body")||[]).length>0&&a()};G(),h.fn=Y,h.each=Y.each;var Z,ee=1,M=Array.prototype.slice,te={},ie={},ae="onfocusin"in window,ne={focus:"focusin",blur:"focusout"},oe={mouseenter:"mouseover",mouseleave:"mouseout"};ie.click=ie.mousedown=ie.mouseup=ie.mousemove="MouseEvents",h.event={add:d,remove:c},h.proxy=function(t,i){var a=2 in arguments&&M.call(arguments,2);if(V(t)){var n=function(){return t.apply(i,a?a.concat(M.call(arguments)):arguments)};return n._zid=e(t),n}if(W(i))return a?(a.unshift(t[i],t),h.proxy.apply(null,a)):h.proxy(t[i],t);throw new TypeError("expected function")},h.fn.bind=function(e,t,i){return this.on(e,t,i)},h.fn.unbind=function(e,t){return this.off(e,t)},h.fn.one=function(e,t,i,a){return this.on(e,t,i,a,1)};var se=function(){return!0},re=function(){return!1},le=/^([A-Z]|returnValue$|layer[XY]$)/,de={preventDefault:"isDefaultPrevented",stopImmediatePropagation:"isImmediatePropagationStopped",stopPropagation:"isPropagationStopped"};h.fn.delegate=function(e,t,i){return this.on(t,e,i)},h.fn.undelegate=function(e,t,i){return this.off(t,e,i)},h.fn.live=function(e,t){return h(C.getElementsByTagName("body")[0]).delegate(this.selector,e,t),this},h.fn.die=function(e,t){return h(C.getElementsByTagName("body")[0]).undelegate(this.selector,e,t),this},h.fn.on=function(e,t,i,a,n){var o,s,r=this;return e&&!W(e)?(h.each(e,function(e,a){r.on(e,t,i,a,n)}),r):(W(t)||V(a)||!1===a||(a=i,i=t,t=Z),a!==Z&&!1!==i||(a=i,i=Z),!1===a&&(a=re),r.each(function(r,l){n&&(o=function(e){return c(l,e.type,a),a.apply(this,arguments)}),t&&(s=function(e){var i,n=(e=e||window.event).target||e.srcElement,s=Y.match(n,t);if(s&&s!==l)return i=h.extend(f(e),{currentTarget:s,liveFired:l}),(o||a).apply(s,[i].concat(M.call(arguments,1)))}),d(l,e,a,i,t,s||o)}))},h.fn.off=function(e,t,i){var a=this;return e&&!W(e)?(h.each(e,function(e,i){a.off(e,t,i)}),a):(W(t)||V(i)||!1===i||(i=t,t=Z),!1===i&&(i=re),a.each(function(){c(this,e,i,t)}))},h.fn.trigger=function(e,t){return e=W(e)||J(e)?h.Event(e):u(e),e._args=t,this.each(function(){e.type in ne&&"function"==typeof this[e.type]?this[e.type]():"dispatchEvent"in this?this.dispatchEvent(e):h(this).triggerHandler(e,t)})},h.fn.triggerHandler=function(e,t){var i,a;return this.each(function(n,s){(i=f(W(e)?h.Event(e):e))._args=t,i.target=s,h.each(o(s,e.type||e),function(e,t){if(a=t.proxy(i),i.isImmediatePropagationStopped())return!1})}),a},h.fn.each("focusin focusout focus blur load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select keydown keypress keyup error".split(" "),function(e,t){h.fn[t]=function(e){return 0 in arguments?this.bind(t,e):this.trigger(t)}}),h.Event=function(e,t){W(e)||(t=e,e=t.type);var i=C.createEvent(ie[e]||"Events"),a=!0;if(t)for(var n in t)"bubbles"==n?a=!!t[n]:i[n]=t[n];return i.initEvent(e,a,!0),u(i)},h.fn.autoHeight=function(){this.each(function(){h(this).on("keyup",function(){!function(e){e.style.height="auto",e.style.height=e.scrollHeight+"px"}(this)})})},h.isBoolean=m,h.isDate=m,h.isFunction=m,h.isNaN=m,h.isNumber=m,h.isObject=m,h.isRegExp=m,h.isString=m,h.isUndefined=m;for(var ce=h,ue="Array Boolean Date NaN Number Function Object RegExp Undefined".split(" "),fe=0;fe<ue.length;fe++){var me=ue[fe];ce["is"+me]=function(e){return function(t){return t!=t?"NaN"===e:RegExp(e).test(Object.prototype.toString.call(t))}}(me)}return i.prototype=h.fn,h}();window.EChatQuery=e}(),function($){void 0===window.ECHATObjKeyMap&&(window.ECHATObjKeyMap={});var UTIL=function(justBase){function _isPointerEventType(e,t){return e.type=="pointer"+t||e.type.toLowerCase()=="mspointer"+t||e.type=="mouse"+t}function _isPrimaryTouch(e){return e.type.indexOf("mouse")>-1||("touch"==e.pointerType||e.pointerType==e.MSPOINTER_TYPE_TOUCH)&&e.isPrimary}this.ECHATConfig={contextPath:"/mychat/visitor"};var _self=this;if(this.bot=/spider|bot/i.test(navigator.userAgent),this.subMap={},this.eventMap={},this.setSub=function(e){this.subMap[e]=e},this.removeSub=function(e){delete this.subMap["string"==typeof e?e:e.KEY]},this.publish=function(e){var t=this.subMap;for(var i in t){var a=ECHATObjKeyMap[i];if(a&&a.eventMap&&a.eventMap[e]){var n=a.eventMap[e];if(this.isArray(n))for(var o=0;o<n.length;o++)n[o],n[o].apply(a,arguments)}}},this.subscribe=function(e,t){this.eventMap[e]?this.eventMap[e].push(t):this.eventMap[e]=[t]},this.unSubscribeAll=function(){this.eventMap={}},this.unSubscribe=function(e){if(this.isArray(e))for(var t=0;t<e.length;t++)delete this.eventMap[e[t]];else delete this.eventMap[e]},this.isArray=function(e){return"[object Array]"===Object.prototype.toString.apply(e)},this.throttle=function(e,t,i){var a,n=Date.now();return function o(s){var r=arguments,l=Date.now();a&&clearTimeout(a),l-n>=t?(e.apply(this,r),n=Date.now()):i&&(a=setTimeout(o,t),s&&s(a))}},this.getQueryString=function(e){var t,i=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),a=location.search.substr(1).match(i);if(null!=a){try{t=decodeURIComponent(a[2])}catch(e){console.log(e.stack)}return t}},this.escapeRegExp=function(e){var t=/[\\^$.*+?()[\]{}|]/g,i=new RegExp(t.source);return function(e){return e&&i.test(e)?e.replace(t,"\\$&"):e}}(),this.addMapParams=function(e){var t=[];for(var i in e)t.push(i+"="+encodeURIComponent(e[i]||""));return t.join("&")},this.packParam=function(e){var t,i="";for(var a in e)(t=0===e[a]||!1===e[a]?e[a]+"":e[a]||"")&&(i+=(i?"&":"")+a+"="+encodeURIComponent(t));return i},this.getQueryParams=function(e){var t={};"string"!=typeof e&&(e=location.search),-1!=e.indexOf("#")&&(e=e.substring(0,e.indexOf("#"))),-1!=e.indexOf("?")&&(e=e.substring(e.indexOf("?")+1));for(var i,a=e.split("&"),n=a.length,o=0;o<n;o++)if(a[o]&&(i=a[o].split("="))[0]&&i[1]){try{t[i[0]]=decodeURIComponent(i[1])}catch(e){console.log(e.stack)}t[i[0].toLowerCase()]=t[i[0]]}if(t.visEvt)try{var s=JSON.parse(t.visEvt);s&&s.eventId&&(t.eventId=s.eventId,t.eventid=s.eventId)}catch(e){}return t},this.findMsgLiByMsg=function(e){return e.mid&&document.getElementById(e.mid)||e.id&&document.getElementById(e.id)||e.identityKey&&document.getElementById(e.identityKey)||e.fileIdentity&&document.getElementById(e.fileIdentity)||e.clientFileId&&document.getElementById(e.clientFileId)},this.queryParams=this.getQueryParams(),this.companyId=this.getQueryString("companyid"),this.getBackground=function(e,t){var i=[],a=parseInt(t||100)/100,n=(e||"rgb(255,255,255)").toLocaleLowerCase().trim();if(0==n.indexOf("rgb"))n=n.replace("rgb","rgba").replace(")",","+a+")");else if(0==n.indexOf("#")){n=n.replace("#","").split("");for(var o=0;o<n.length;o++)3==n.length?i.push(parseInt("0x"+n[o]+n[o])):o%2==0&&i.push(parseInt("0x"+n[o]+n[o+1]));i.push(a),n="rgba("+i.join()+")"}return n},this.hasStorage=function(){var e;try{if(!window.localStorage)return!1;if(window.localStorage.setItem("echt_test_storage","ok"),!(e=window.localStorage.getItem("echt_test_storage")))return!1;e&&window.localStorage.removeItem("echt_test_storage")}catch(e){return!1}return!0}(),this.hasCookie=function(){$.cookie("echt_test_cookie","ok");return!!$.cookie("echt_test_cookie")&&($.cookie("echt_test_cookie",null),!0)}(),$.store=function(e){return e?function(e,t,i){if(!e)return null;try{return arguments.length>1&&(!/Object/.test(Object.prototype.toString.call(t))||null===t||void 0===t)?(i=$.extend({},i),null!==t&&void 0!==t||(i.expires=-1),t=String(t),i.session?window.sessionStorage.setItem(e,t):window.localStorage.setItem(e,t),t):(i=t||{}).local?window.localStorage.getItem(e):i.session?window.sessionStorage.getItem(e):window.localStorage.getItem(e)||window.sessionStorage.getItem(e)||$.cookie(e)}catch(a){try{window.localStorage.removeItem(e),$.store(e,t,i)}catch(e){_self.hasStorage=!1}}}:$.cookie}(this.hasStorage),this.changeTitleFun=function(){if("title"in document)return function(e){document.title=e};var e,t=_$s("title");return t&&t[0]?e=t[0]:(e=document.createElement("title"),_$s("head")[0].appendChild(e)),"textContent"in e?function(e){_$s("title")[0].textContent=e}:"innerText"in e?function(e){_$s("title")[0].innerText=e}:function(){}}(document),!justBase){this.checkDomain=function(e,t){function i(e){return e.replace(/^http[s]?:\/\//i,"")}function a(e){var t=e.match(/[.]?([^.]+[.][^.]+)$/);return t?t[1]:i(e)}if(!e||!t||!t.length)return!1;e=a(e);for(var n=0;n<t.length;n++)if(t[n]&&(e==i(t[n])||e==a(t[n])))return!0;return!1},this.getDeviceInfo=function(){function G(){var e=C||D||window.opera;return/mobile|kgbrowser|(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))}function L(){return window.document.documentElement.clientWidth>window.document.documentElement.clientHeight}function R(){return E&&/(iemobile|windows phone)/i.test(C)}function T(){return E&&y.test(D)&&(!z.test(C)||/samsung/i.test(C))}function Y(){var e=window.document.documentElement.clientWidth,t=e/window.document.documentElement.clientHeight>1.2,i=window.screen.width,a=window.screen.height;t&&i<a&&(!0,i=window.screen.height,a=window.screen.width);var n=window.innerWidth,o=e/i;window.devicePixelRatio&&T()&&i>640?o*=window.devicePixelRatio:R()&&(o*=1.5);var s=e/n/o;return s=(s/1.2).toFixed(2),(i/n).toFixed(2)}function Z(){var e=window,t=e.document.documentElement,i=e.document.body,a=null,n={top:0,left:0};if(h(t.getBoundingClientRect)&&(h(e.getComputedStyle)?"relative"==e.getComputedStyle(i).position?a=i:"relative"==e.getComputedStyle(t).position&&(a=t):i.currentStyle?"relative"==i.currentStyle.position?a=i:"relative"==t.currentStyle.position&&(a=t):"relative"==i.style.position?a=i:"relative"==t.style.position&&(a=t)),a){var o=a.getBoundingClientRect();n.top=o.top+e.pageYOffset-t.clientTop,n.left=o.left+e.pageXOffset-t.clientLeft}return n}_self.deviceInfo=F;var b=_self,f=b.indexOf=function(){var e=Array.prototype.indexOf;return"function"==typeof e&&/\[native code\]/.test(e.toString())||(e=function(e){if(null==this)throw new TypeError;var t=Object(this),i=t.length>>>0;if(0===i)return-1;var a=0;if(arguments.length>0&&((a=Number(arguments[1]))!=a?a=0:0!=a&&a!=1/0&&a!=-1/0&&(a=(a>0||-1)*Math.floor(Math.abs(a)))),a>=i)return-1;for(var n=a>=0?a:Math.max(i-Math.abs(a),0);n<i;n++)if(n in t&&t[n]===e)return n;return-1}),function(t,i,a){return e.call(i,t,a)}}(),h=b.isFunction=function(){return function(e){return"function"==typeof e}}(),i=b.isString=function(){return function(e){return"string"==typeof e}}(),q=b.Browser=function(){function $f(e){return e.replace(/^http:/,$a?"https:":"http:")}function $g(){return window.innerHeight!==a?window.innerHeight:document.documentElement?document.documentElement.offsetHeight:document.getElementsByTagName("body").length?document.getElementsByTagName("body")[0].clientHeight:0}function $h(){return window.innerWidth!==a?window.innerWidth:document.documentElement?document.documentElement.offsetWidth:document.getElementsByTagName("body").length?document.getElementsByTagName("body")[0].clientWidth:0}function $o(){var e,t=x.plugins&&x.plugins[$k];if(t)return(e=x.mimeTypes&&x.mimeTypes[$m])&&!e.enabledPlugin?null:t.description;if(window.ActiveXObject)try{return t=new window.ActiveXObject($l),t.AllowScriptAccess="always",t.GetVariable("$version")}catch(e){}}function $p(){var e=x.mimeTypes;return A?!Q&&("javaEnabled"in x&&x.javaEnabled()):e&&(e=e[$n])&&(e=e.enabledPlugin)?e.name:void 0}function $q(){if(!k(S))return S;var e=document.createElement("div"),t=document.createElement("div"),i=e.style,a=t.style;return i.overflow="auto",i.width=i.height="100px",i.position="absolute",i.top="-1000px",a.width="100%",a.height="200px",e.appendChild(t),document.body.appendChild(e),S=e.offsetWidth-e.clientWidth,document.body.removeChild(e),S}function $r(){try{return eval("false")}catch(e){return!0}}function $s(){for(var e=3,t=document.createElement("div"),i=t.getElementsByTagName("i");t.innerHTML="\x3c!--[if gt IE "+ ++e+"]><i></i><![endif]--\x3e",i[0];);return e>4?e:document.documentMode}var x=navigator,y=x.userAgent.toLowerCase(),osVersion=0,z=+(/trident.*rv:? *([0-9]+)/.exec(y)||[])[1]||!1,A=$s(),zz=/edge/.exec(y)||!A&&!!window.StyleMedia||!1,B=8==A,C=7==A,D=6==A,E=window.opera&&"[object Opera]"==Object.prototype.toString.call(window.opera)||/webkit/.test(y)&&(/opr/.test(y)||/opera/.test(y)),F="Google Inc."==navigator.vendor,G="Apple Computer, Inc."==navigator.vendor,H=!A&&(F||G||/webkit|khtml/.test(y)),I=+/\d+/.exec(/firefox\/\d+/i.exec(navigator.userAgent)||""),J=y.indexOf("firefox/2")>-1,K=y.indexOf("firefox/3")>-1,L=-1!=y.indexOf("iphone"),M=-1!=y.indexOf("ipod"),N=-1!=y.indexOf("ipad"),O=L||N||M,Q=-1!=y.indexOf("wp7"),kgBrowser=-1!=y.indexOf("kgbrowser"),meizu=-1!=y.indexOf("mzbrowser"),P=meizu||-1!=y.indexOf("android"),R=O||P||Q||kgBrowser||meizu,S,uc=-1!=y.indexOf("ucbrowser"),liebao=-1!=y.indexOf("lbbroser")||y.indexOf("liebao")>-1,qq=-1!=y.indexOf("qqbrowser"),sogou=-1!=y.indexOf("metasr")||-1!=y.indexOf("sogou"),f360=y.match(/360|qhbrowser|qihoobrowser/i),maxth=-1!=y.indexOf("maxthon"),baidu=-1!=y.indexOf("bidubrowser")||-1!=y.indexOf("baidubrowser")||-1!=y.indexOf("baidu"),weixin=-1!=y.indexOf("micromessenger"),chromeIphone=L&&-1!=y.indexOf("crios"),T=A&&"msie"||I&&"firefox"||E&&"opera"||uc&&"uc"||liebao&&"liebao"||qq&&"qq"||zz&&"edge"||sogou&&"sogou"||f360&&"360"||maxth&&"maxth"||baidu&&"baidu"||weixin&&"weixin"||chromeIphone&&"chrome"||G&&"safari"||F&&"chrome"||H&&"chrome",U,V=A&&!W,W="CSS1Compat"==document.compatMode,X=!W,Y=A&&X&&document.documentElement&&!!document.documentElement.style.setExpression,Z=document.documentMode||A,$$=-1!=y.indexOf("windows")||-1!=y.indexOf("win32"),$_=-1!=y.indexOf("macintosh")||-1!=y.indexOf("mac os x")||-1!=window.navigator.platform.indexOf("Mac"),$a="https:"==document.location.protocol,$b=x.language||x.browserLanguage||x.userLanguage||x.systemLanguage,$c={noBoxSizing:Z<=7,ie:{cssBottomRight:D,cssFixed:D||Y,buggyCSS:D||Y}},$d="textContent"in document.createElement("div"),$e=!1;try{window.CustomEvent&&/\[native code\]/.test(window.CustomEvent.toString())&&(new window.CustomEvent("testevent",{bubbles:!1,cancelable:!0,detail:!0}),$e=!0)}catch(e){}switch(T){case"opera":U=+/\d+/.exec(new RegExp("opr[ /]\\d+").exec(y)||"");break;case"msie":case"firefox":case"chrome":U=U||+/\d+/.exec(new RegExp(T+"[ /]\\d+").exec(y)||"");break;case"baidu":U=+/\d+/.exec(new RegExp("bidubrowser[ /]\\d+").exec(y)||"");break;case"maxth":U=+/\d+/.exec(new RegExp("maxthon[ /]\\d+").exec(y)||"");break;case"qq":U=+/\d+/.exec(new RegExp("qqbrowser[ /]\\d+").exec(y)||"");break;case"liebao":U=+/\d+/.exec(new RegExp("lbbroser[ /]\\d+").exec(y)||"");break;case"uc":U=+/\d+/.exec(new RegExp("ucbrowser[ /]\\d+").exec(y)||"");break;case"sogou":U=+/\d+/.exec(new RegExp("metasr[ /]\\d+").exec(y)||"");break;default:U=+/\d+/.exec(/version[ \/]\d+/.exec(y)||"")}if(O&&(osVersion=+/\d+/.exec(new RegExp("iphone os \\d+").exec(y)||"")),D){var $i=[];$c.leaksMemory=function(e){p.isFunction(e),$i.push(e)};var $j=function(){for(var e=0;e<$i.length;e++)$i[e]()};$c.leaksMemory.remove=function(e){for(var t=$i.length-1;t>=0;t--)e==$i[t]&&$i.splice(t,1)},window.attachEvent("onunload",$j)}var $k="Shockwave Flash",$l="ShockwaveFlash.ShockwaveFlash",$m="application/x-shockwave-flash",$n="application/x-java-vm",$t={browser:T,version:U,osVersion:osVersion,isStrict:W,isQuirks:X,isOpera:E,isSafari:G,isWebKit:H,isChrome:!E&&F,isAndroid:P,isIPhone:L,isIPod:M,isIPad:N,isIOS:O,isWP7:Q,isMobile:R,isEdge:zz,isNewIE:z,isIE:A,isIE6:D,isIE7:C,isIE8:B,isFF:I,isFF2:J,isFF3:K,isBorderBox:V,isCustomEvents:$e,engineIE:Z,bugs:$c,isWindows:$$,isXP:/windows nt 5.1/.test(y),isMac:$_,isLinux:/Linux/.test(navigator.platform),isSecure:$a,secureURL:$f,hasFlash:$o(),hasJava:$p(),language:$b,getScrollbarSize:$q,getWindowClientHeight:$g,getWindowClientWidth:$h,isTextContent:$d,hasCSP:$r()};return $t.isPC=!$t.isMobile&&($t.isWindows||$t.isMac||$t.isEdge||$t.isLinux),$t}(),x=b.__$$__jx_ui_HTMLElement,y=/google inc\./i,z=/chrome/i,A=/apple computer, inc\./i,B=/crios/i,C=window.navigator.userAgent||"",D=window.navigator.vendor||"",F={checkLandscape:L,getZoomLevel:Y,getOffset:Z},E=G();_self.Device=F}();var isMobilePage=window.mobilePage||-1!=location.href.split("?")[0].indexOf("/visitor/mobile/")&&!ECHATObjKeyMap.outerId;_self.Browser.isMobile||isMobilePage||!_self.Browser.isPC?_self.Device.media=2:_self.Device.media=1,_self.Device.OS=this.Browser.isWindows&&"Windows"||this.Browser.isIPhone&&"iPhone"||this.Browser.isIPad&&"IPAD"||this.Browser.isIPod&&"IPOD"||this.Browser.isMac&&"OSX"||this.Browser.isAndroid&&"Android"||this.Device.isWP&&"Windows Phone"||this.Browser.isLinux&&"Linux"||"others",this.hasTranslate=this.Browser.isMobile,this.setTransform=function(e,t){var i="translate("+e+"px,"+t+"px)";_self.hasTranslate?$(this).css({"-webkit-transform":i,"-o-transfrom":i,"-ms-transform":i,"-moz-transform":i,transform:i}):$(this).css({left:e+"px",top:t+"px"})},this.setScale=function(e){var t=this;!function(){var e=_self.deviceInfo.getZoomLevel();(1/e).toFixed(2),window.pageXOffset,window.pageYOffset,window.innerWidth,window.innerHeight,t[0].clientWidth,t[0].clientHeight}()};var _clearSlct="getSelection"in window?function(){window.getSelection().removeAllRanges()}:function(){document.selection.empty()};this.pageSlide=function(e,t){$(e).attr("x","0"),$(document).on("mousedown touchstart",e,function(e){e=e||window.event;var i=!1;if(!(i=_isPointerEventType(e,"down"))||_isPrimaryTouch(e)){e=i?e:e.touches&&e.touches[0]||e;var a={};a.x2=void 0,a.y2=void 0;var n=0,o=0,s=$(this),r=this.parentNode.clientWidth,l=r/8,d=parseInt(s.attr("x")||this.offsetLeft)||0,c=this.clientWidth,u=-c+r-20;a.x1=e.clientX,a.y1=e.clientY,s.removeClass("transition");var f=function(e){e.cancelable=!0,e.preventDefault()};r=parseInt(c/parseInt(c/r)),document.body.addEventListener&&document.body.addEventListener("touchmove",f,{passive:!1});var m=function(e){if(s){e=i?e:e.touches&&e.touches[0]||e,a.x2=e.clientX,a.y2=e.clientY,n=a.x2-a.x1,o=a.y2-a.y1;var t=n+d;t=t>20?20:t<u?u:t,_self.setTransform.call(s,t,0),s.attr("x2",t),_clearSlct(),e.originalEvent&&(e=e.originalEvent),e.cancelable=!0,e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}},h=function(e){if(_clearSlct(),s){s.addClass("transition");var i=0;if(l<Math.abs(n)){parseInt(s.attr("x2"));n>=l&&d+r<=0?(_self.setTransform.call(s,d+r,0),s.attr("x",d+r),i=-1):n<=-l&&d-r+c>r/10?(_self.setTransform.call(s,d-r,0),s.attr("x",d-r),i=1):_self.setTransform.call(s,d,0)}else _self.setTransform.call(s,d,0);var a=t&&t(i);if($(document).off("mousemover mousemove touchmove pointermove",m).off("mouseup touchend pointerup",h),s=null,_clearSlct(),!1===a)return e.stopPropagation&&e.stopPropagation,e.preventDefault&&e.preventDefault(),!1;document.body.removeEventListener&&document.body.removeEventListener("touchmove",f)}};$(document).on("mousemover mousemove touchmove pointermove",m).on("mouseup touchend pointerup",h)}})},this.getCSSRule=function(e,t,i){if(i=i||window.document,e=e.toLowerCase(),i.styleSheets)for(var a=0;a<i.styleSheets.length;a++){var n=i.styleSheets[a],o=0,s=!1;do{if((s=n.cssRules?n.cssRules[o]:n.rules&&n.rules[o])&&s.selectorText&&s.selectorText.toLowerCase()==e)return"delete"==t?(n.cssRules?n.deleteRule(o):n.removeRule(o),!0):s;o++}while(s)}return!1},this.killCSSRule=function(e){return this.getCSSRule(e,"delete")},this.addCSSRule=function(e){return document.styleSheets&&(this.getCSSRule(e)||(document.styleSheets[0].addRule?document.styleSheets[0].addRule(e,null,0):document.styleSheets[0].insertRule(e+" { }",0))),this.getCSSRule(e)},this.addJS=function(e,t){function i(e){a.onload=a.onerror=a.onreadystatechange=null,n.removeChild(a),t&&t(e,a.innerHTML),a=null}var a=document.createElement("script");a.setAttribute("type","text/javascript");var n=document.getElementsByTagName("head")[0];"onload"in a?(a.onload=i,a.onerror=function(){i(!0)}):a.onreadystatechange=function(){/loaded|complete/.test(a.readyState)&&i()},a.src=e,n.appendChild(a)},this.addCSS=function(e){var t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e,t.media="screen";document.getElementsByTagName("head")[0].appendChild(t)},this.base64encode=function(e){var t,i,a,n,o,s,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(a=e.length,i=0,t="";i<a;){if(n=255&e.charCodeAt(i++),i==a){t+=r.charAt(n>>2),t+=r.charAt((3&n)<<4),t+="==";break}if(o=e.charCodeAt(i++),i==a){t+=r.charAt(n>>2),t+=r.charAt((3&n)<<4|(240&o)>>4),t+=r.charAt((15&o)<<2),t+="=";break}s=e.charCodeAt(i++),t+=r.charAt(n>>2),t+=r.charAt((3&n)<<4|(240&o)>>4),t+=r.charAt((15&o)<<2|(192&s)>>6),t+=r.charAt(63&s)}return t},this.iScrollParam={bounce:!this.Browser.isIOS||this.Browser.osVersion<13,preventDefault:!1,preventDefaultException:/^(A|PRE|INPUT|TEXTAREA|BUTTON|SELECT|LABEL)$/,tap:!1,click:!1,mouseWheel:!0,fadeScrollbars:!1},this.parseMsgByRule=function(e,t,i){if(t&&e){var a=this.regFace,n=this.regEmo||new RegExp("\\[#[a-z0-9A-Z]+(_[a-z0-9A-Z]+)*#\\]","g"),o=1,s=t[e.mt||0];return s?s=s.replace(/\$\{([^,]+),?([^,]+)?,?([^,]+)?,?([^,]+)?\}/g,function(t,i,a,n,s){if(o="1"==s?1:0,!a&&!n)return e[i];n=parseInt(n);var r=e[i];return r?(n>0&&r.replace(/\[#([^#]+)#\]/g,function(e,t,i,a){return i<n&&i+e.length>=n?n+=e.length-1:i<n&&(n+=e.length-1),e}),e[i].substring(a,n)):""}):(s=e.content)||(s=t[0]),(o||i&&i.notPlainText)&&(s=function(e,t){return e&&(e+"").replace(/<(?:.|\s)*?>/gi,"").substring(0,t||100)}(s)),a?s&&(s=function(e,t){if(!e)return e;var i=this.emo;return i&&(e=e.replace(a,function(e){arguments[0];var t=e.charCodeAt(0),a=e.charCodeAt(1),n=(a-56320+(t-55296<<10)+65536).toString(16);return i[n]?'<img class="img-emo" src="/res/emoji/32/'+n+'.png" />':i[t+"_"+a]?'<img class="img-emo" src="/res/emoji/32/'+t+"_"+a+'.png" />':e})),e=e.replace(n,function(e){var t=e.replace(/^\[#([\d\w_]+)#\]/g,"$1");return i&&i[t]||!i?'<img class="img-emo" src="/res/emoji/32/'+t+'.png" />':e})}(s)):s&&(s=s.replace(n,"[face]")),s}},this.lastMsgRule={0:"您有新的消息",604:"您的对话已接通",605:"您的对话已结束",621:"给您发送了一个信息填写邀请",622:"给您发送了一个信息填写邀请",640:"${content,0,30,1}",641:"[图片]",642:"[文件]",647:"${content,0,30,1}",648:"等待接入会话，排队位置:${position}",653:"[图片]",657:"[图文消息]",673:"请您对本次服务进行评价",674:"您有新的消息",675:"您有新的消息",676:"您有新的消息",10011:"[图文消息]",864:"${content,0,30,1}",865:"[图片]",866:"[文件]",680:"[链接]"},this.formatUnreadMsg=function(e){var t=this;if(!e.lastMsgContent)return{mt:e.mt,companyId:e.companyId,unreadMsgCount:e.unreadMsgNumber||e.unreadMsgCount||0};var i=this.lastMsgRule;return function(e){this.needHttps&&e.companyLogo&&(e.companyLogo=e.companyLogo.replace(/^http:/,this.needHttps)),void 0!==e.unreadMsgNumber&&(e.unreadMsgCount=e.unreadMsgNumber),e.lastMsg=JSON.parse(e.lastMsgContent),e.msgContent=t.parseMsgByRule(e.lastMsg,i)}(e),{chatUrl:(this.loaderHost||location.origin)+"/visitor/mobile/chat.html?companyId="+e.companyId+"&platformSign="+encodeURIComponent(e.signature)+(this.queryParams.fvMsg?"&fvMsg="+encodeURIComponent(this.queryParams.fvMsg):"")+"&metaData="+encodeURIComponent(this.queryParams.metaData)+"&myData="+encodeURIComponent(this.queryParams.myData),msgId:e.mid,platformId:e.platformId||void 0,mt:e.mt,companyId:e.companyId,companyLogo:e.companyLogo,companyName:e.companyName,msgContent:e.msgContent,unreadMsgCount:e.unreadMsgCount}},this.sendMsgboxUnread=function(){function e(){n.readySend=$.store(n.readySendName),n.readySend=n.readySend?JSON.parse(n.readySend):{order:[]}}function t(t,i){e();var a=n.readySend.order;if(0===i){if(t.mid&&(n.readySend.lastMid=t.mid),a.length>0){n.readySend[t.mid]=void 0,delete n.readySend[t.mid];for(o=0;o<a.length;o++)a[o]==t.mid&&a.splice(o,1)}}else if(!n.readySend[t.mid]&&(n.readySend[t.mid]=t,n.readySend.order.unshift(t.mid),n.readySend.order.length>10)){for(var o=10;o<a.length;o++)n.readySend[a[o]]=void 0,delete n.readySend[a[o]];n.readySend.order.length=10}$.store(n.readySendName,JSON.stringify(n.readySend))}function i(e){if(e&&(n.queue.push(e),t(e,1)),0!=n.queue.length){var o=$.cookie(n.cookieName);o&&(n.checkTimer||n.timeoutTimer)?n.checkTimer||n.timeoutTimer||(n.timeoutTimer=setTimeout(function(){n.timeoutTimer=null,i()},300)):(!o&&n.checkTimer&&clearTimeout(n.checkTimer),!o&&n.timeoutTimer&&clearTimeout(n.timeoutTimer),a(n.queue.shift()))}}function a(a){if(a){if(e(),n.readySend.lastMid&&n.readySend.lastMid>=a.mid)return i();n.cookieValue=a.mid+"_"+n.pageTag,$.cookie(n.cookieName,n.cookieValue),n.checkTimer=setTimeout(function(){n.checkTimer=null;$.cookie(n.cookieName)==n.cookieValue&&(o(a),$.cookie(n.cookieName,""),t(a,0)),$.cookie(n.cookieName)?n.timeoutTimer=setTimeout(function(){n.timeoutTimer=null,i()},300):i()},200)}}var n={cookieName:"",cookieValue:"",readySendName:"",readySend:{lastMid:"",order:[123],123:{}},queue:[],pageTag:(new Date).getTime(),checkTimer:null,timeoutTimer:null},o=null;return{send:i,queue:n.queue,init:function(e){if(!o&&_self.visitorId){var t;n.cookieName="unreadNewMsg_"+_self.visitorId,n.readySendName="unreadNewMsgMap_"+_self.visitorId,$.cookie(n.readySendName,""),n.cookieValue=$.cookie(n.cookieName),n.readySend=$.store(n.readySendName),n.readySend?n.readySend=JSON.parse(n.readySend):(n.readySend={order:[]},$.store(n.readySendName,'{ "order": [] }')),n.cookieValue&&(t=n.cookieValue.split("_")[0],n.readySend[t]&&a(n.readySend[t])),o=e}}}}(),$(document).on("drag",function(e){return(e=e||window.event).preventDefault&&e.preventDefault(),!1})}};UTIL.prototype.serverAdaptor={fuzzyBrandI18nRes:function(){}},window.SDK||__inline("serverTypeAdaptor.js"),__inline("storeInfo.js"),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.toString().replace(/(^\s+)|(\s+$)/g,"")}),Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var i in t)new RegExp("("+i+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[i]:("00"+t[i]).substr((""+t[i]).length)));return e},window.UTIL=UTIL,"undefined"==typeof console&&(window.console={log:function(e){}})}(EChatQuery),function(e){function t(){d=null,u.last&&(u.el.trigger("longTap"),u={})}function i(){d&&clearTimeout(d),d=null}function a(){s&&clearTimeout(s),r&&clearTimeout(r),l&&clearTimeout(l),d&&clearTimeout(d),s=r=l=d=null,u={}}function n(e){return("touch"==e.pointerType||e.pointerType==e.MSPOINTER_TYPE_TOUCH)&&e.isPrimary}function o(e,t){return e.type=="pointer"+t||e.type.toLowerCase()=="mspointer"+t}var s,r,l,d,c,u={};e(function(){var f,m,h,p,g=0,v=0;"MSGesture"in window&&((c=new MSGesture).target=document.body),e(document).bind("MSGestureEnd",function(e){var t=e.velocityX>1?"Right":e.velocityX<-1?"Left":e.velocityY>1?"Down":e.velocityY<-1?"Up":null;u.el&&t&&(u.el.trigger("swipe"),u.el.trigger("swipe"+t))}).on("touchstart",function(i){(p=o(i,"down"))&&!n(i)||(h=p?i:i.touches[0],i.touches&&1===i.touches.length&&u.x2&&(u.x2=void 0,u.y2=void 0),f=Date.now(),m=f-(u.last||f),u.el=e("tagName"in h.target?h.target:h.target.parentNode),s&&clearTimeout(s),u.x1=h.pageX,u.y1=h.pageY,m>0&&m<=250&&(u.isDoubleTap=!0),u.last=f,d=setTimeout(t,750),c&&p&&c.addPointer(i.pointerId))}).on("touchmove",function(e){(p=o(e,"move"))&&!n(e)||(h=p?e:e.touches[0],i(),u.x2=h.pageX,u.y2=h.pageY,g+=Math.abs(u.x1-u.x2),v+=Math.abs(u.y1-u.y2))}).on("touchend",function(t){(p=o(t,"up"))&&!n(t)||(i(),u.x2&&Math.abs(u.x1-u.x2)>30||u.y2&&Math.abs(u.y1-u.y2)>30?u.el&&(l=setTimeout(function(){u.el&&(u.el.trigger("swipe"),u.el.trigger("swipe"+function(e,t,i,a){return Math.abs(e-t)>=Math.abs(i-a)?e-t>0?"Left":"Right":i-a>0?"Up":"Down"}(u.x1,u.x2,u.y1,u.y2)),u={})},0)):"last"in u&&(g<30&&v<30?r=setTimeout(function(){var t=e.Event("tap");u.el&&(t.cancelTouch=a,u.el&&u.el.trigger(t),u.isDoubleTap?(u.el&&u.el.trigger("doubleTap"),u={}):s=setTimeout(function(){s=null,u.el&&u.el.trigger("singleTap"),u={}},250))},0):u={}),g=v=0)}).on("touchcancel MSPointerCancel pointercancel",a),e(window).on("scroll",a)}),["swipe","swipeLeft","swipeRight","swipeUp","swipeDown","doubleTap","tap","singleTap","longTap"].forEach(function(t){e.fn[t]=function(e){return this.on(t,e)}})}(window.EChatQuery),function(e){var t=new function(i){function a(t){setTimeout(function(){var i=u.apiServerDomain;if(console.log("****sendLog****",t,i),i&&t){t.tm=t.tm||(new Date).getTime();var a={companyId:u.companyId,visitorId:u.visitorId||"web371586",encryptVId:u.encryptVID||"megCLh6ooic=",metaData:view.chat.paramChat.metaData||"",data:JSON.stringify(t)};e.ajax({url:"https://"+i+"/chatapi/vcls",type:"post",contentType:"application/x-www-form-urlencoded; charset=UTF-8",data:a,success:function(e){},error:function(e){console.log("****sendLog**** error",e)}})}},10)}function n(e){h=!1,e&&(u.publish("chatEnded",e),p=!1),u.unSubscribe(["sendVisitorEvent","visitorCommonEvent"]),u.unSubscribe("restartChat"),u.subscribe("restartChat",function(){view.chat.publish("__callNative",{functionName:"restartChat"})})}function o(e,t,i,a){var n=a?m:f,o=i?i.item:(new Date).getTime(),r=i||{data:e,cb:t,time:o,sending:!0};return!(i&&104!=e.et)&&n.push(r),u.publish("__sendMessage",e,function(i){if(t&&(i.bridgeMsgId=e.bridgeMsgId,t.apply(this,arguments)),i.successful){for(var a=n.length-1;a>-1;a--)if(n[a]&&n[a].time==o){n.splice(a,1);break}s(!1)}else r.sending=!1}),!0}function s(e){var t=e?m:f;if(t.length>0)for(var i,a=0;a<t.length&&((i=t[a]).sending||(i.sending=!0,o(i.data,i.cb,i)));a++);}function r(e){u.unSubscribe(["sendVisitorEvent","visitorCommonEvent"]),u.subscribe("sendVisitorEvent",function(e,t,i){o(t,i,null,!0)}),u.subscribe("visitorCommonEvent",function(e,t,i){o(t,i,null,!1)})}function l(e,t,i){if(console.log(e,t,i),e)try{var n={functionName:e,value:t||""};i&&"function"==typeof i&&(n.callback="callback_"+y,window[n.callback]=function(){console.log("callback***"+n.callback,arguments),i.apply(i,arguments),window[n.callback]=null},y++),window.wkWebkit?window.webkit&&window.webkit.messageHandlers.callEchatNativeConnect.postMessage(JSON.stringify(n)):window.EchatJsBridge&&EchatJsBridge.callEchatNativeConnect(JSON.stringify(n)),a({tm:(new Date).getTime(),info:"EchatJsBridge",msg:JSON.stringify({functionName:e,value:t||""})})}catch(e){console.log(e)}}function d(e){return"string"==typeof e?JSON.parse(e+""):e}function c(e,t,i){var a=d(e);if(105==a.et||130==a.et||864==a.mt)a.mt=864,a.tm=a.tm||a.bridgeMsgId,a.f="c",130==a.et&&(a.ff="r"),a.m=0;else if(640==a.mt||641==a.mt||642==a.mt)a.f="s",640==a.mt&&(a.m=0),641==a.mt&&(a.m=2),642==a.mt&&(a.m=1);else if(127==a.et)a.f="c",a.mt=127;else if(12001==a.mt)a.f="r";else{if(104==a.et||644==a.mt||106==a.et||109==a.et)return;10011==a.mt&&(a.f=1==a.mst?"c":2==a.mst?"s":"x")}var n=(new Date).getTime()+""+(a.mid||a.tm);673==a.mt&&"unread"!=i||(t[n]=a,t.order?t.order.push(n):t.order=[n]),649!=a.mt&&604!=a.mt&&600!=a.mt||(t.config?t.config.push(a):t.config=[a])}e.cometd={getStatus:function(){return"sdk"}},UTIL.call(this,!0);var u=this,f=[],m=[],h=!1;this.selfMsg=function(e,t){var i=e;switch("0"==i.id&&(i.id=i.mid),i.mt+""){case"10009":return!1!==i.isForward||u.lastTalkId||(u.lastTalkId=view.chat.talkId,u.lastTalkType=view.chat.isInRobot?3:!0===view.chat.chatting?1:2),!1===i.isForward&&4!=i.type&&10!=i.type&&9!=i.type&&11!=i.type&&view.chat.publish("__chatStatus","exceptionEnd"),i.justConnect=4!=i.type&&10!=i.type,void n(i);case"600":window.chatVisitorId="chatVisitorId"+i.visitorId,window.encryptVID=u.encryptVID=i.encryptVID,u.visitorId=i.visitorId,window.encryptVID=u.companyId=i.companyId,view.chat.initVisitor(),u.publish("setVisitorInfo",i),(i.routeEntranceInfo||i.routeEntranceInfoString)&&(i.routeEntranceInfo=i.routeEntranceInfo||JSON.parse(i.routeEntranceInfoString),u.waitForRouterSelect=!0,u.publish("displayRouterInfo",i)),r(),u.publish("handshakeOk",e),h=!0,u.publish("updateVisitorInfo",{visitorId:i.visitorId,photo:i.photo});var a=u.dataHost;u.apiServerDomain=i.apiServerDomain,window.getCurrentDataHost(function(e){e&&e!=a&&(console.log("切换后 当前使用的域名："+e),e.match(/^http[s]?:\/\/[^\/]+/)&&(e="https://"+e.match(/^http[s]?:\/\/([^\/]+)/)[1],window.dataHost=u.dataHost=view.chat.dataHost=e)),u.apiServerDomain=i.apiServerDomain,u.ajaxQueryUnread&&u.ajaxQueryUnread(i.apiServerDomain)}),1!=i.visitorType||view.chat.paramChat.metaData||i.metaData||u.publish("toUpdateMetadata");break;case"671":u.publish("setChatParam",i);break;case"672":u.publish("setRestartTag",i);break;case"649":r(),u.publish("setconfig",i),(!0!==view.chat.chatting||view.chat.isInRobot)&&u.publish("waitingChat",i);break;case"651":case"682":break;case"652":this.publish("getErr",i);break;case"646":this.publish("getChatToken",i);break;default:!t&&u.receiveChat(e,!0)}};var p=!1;this.receiveChat=function(t,i){var a=t;switch("0"==a.id&&(a.id=a.mid),a.mt+""){case"127":case"902":this.publish("sendLocationInfo",a);break;case"658":a.current=!0,this.publish("orderReply",a);break;case"677":case"678":this.publish("startLeave",a);break;case"687":case"691":u.publish("startRobot",a);break;case"686":case"604":u.waitForRouterSelect=!1,function(e){u.publish("startChat",e)}(a),s(!0);break;case"605":return!1!==a.isForward||u.lastTalkId||(u.lastTalkId=view.chat.talkId,u.lastTalkType=view.chat.isInRobot?3:!0===view.chat.chatting?1:2),void((!a.fromHistory||a.fromDB)&&n(a));case"620":return void this.publish("staffState",a);case"640":this.publish("getMsg",a);break;case"641":a.identityKey&&(a.fileIdentity=a.identityKey),!a.clientFileId&&(a.clientFileId=a.identityKey),this.publish("getMsgImg",a);break;case"642":a.identityKey&&(a.fileIdentity=a.identityKey),!a.clientFileId&&(a.clientFileId=a.identityKey),this.publish("getMsgFile",a);break;case"644":this.publish("getMsgTyping",a);break;case"647":this.publish("getSysMsg",a);break;case"648":this.publish("getPosMsg",a);break;case"650":return void this.publish("refreshVerify",a);case"655":a.current=!0,u.publish("getLeaveMsg",a);break;case"864":this.publish("getMsgMine",a);break;case"865":a.identityKey&&(a.fileIdentity=a.identityKey),view.fileMsgs[a.clientFileId]&&(view.fileMsgs[a.clientFileId].sendStatus=4),this.publish("getMsgImg",a);break;case"866":a.identityKey&&(a.fileIdentity=a.identityKey),view.fileMsgs[a.clientFileId]&&(view.fileMsgs[a.clientFileId].sendStatus=4),this.publish("getMsgFile",a);break;case"local":case"local_upload":a.identityKey&&(a.fileIdentity=a.identityKey),a.fileIdentity||(a.fileIdentity=a.clientFileId),2==a.sendStatus||4==a.sendStatus?1==a.fileType?this.publish("getMsgImg",a):this.publish("getMsgFile",a):C.prepareUpload(a);break;case"874":this.publish("getHistory",a);break;case"876":return void this.publish("overLength",a);case"890":this.publish("inviteBook",a);break;case"892":this.publish("inviteBookOK",a);break;case"670":return void u.publish("entryCallback",a);case"673":u.publish("inviteSatisfy",a),e.store("ECHAT_inviteSatisfyId",a.mid);break;case"675":return a.staffName=a.staffName||a.staffNickName,u.publish("getLeaveReply",a),void(p=!1);case"680":u.publish("receiveURL",a);break;case"688":u.publish("receiveForm",a);break;case"698":u.publish("removeThisHistory");var o={visitorId:a.newVisitorId,metaData:a.metaData,formData:a.formData};u.metaData=a.metaData,u.formData=a.formData,a.myData&&(u.myData=a.myData,o.myData=a.myData),a.metaDataInfo&&a.metaDataInfo.photo&&(o.photo=a.metaDataInfo.photo),u.publish("refreshVisitorInfo",o);break;case"959":u.publish("submitForm",a);break;case"923":return void u.publish("updateVisitorInfo",{visitorId:a.newVisitorId,photo:a.metaDataInfo?a.metaDataInfo.photo:a.photo,metaData:a.metaData||"",myData:a.myData,formData:a.formData});case"928":return;case"12001":this.publish("getMsgRobot",a);break;case"10011":u.publish("receiveVisEvt",a);break;default:return void(!i&&u.selfMsg(t,!0))}p||(this.publish("removeLoading",a),p=!0)},this.receive=function(){},u.subscribe("restartChat",function(){view.chat.publish("__callNative",{functionName:"restartChat"})}),u.subscribe("_endConnect",function(){n({justConnect:!0})}),u.subscribe("__callNative",function(e,t,i){l(t.functionName,t.value,i)}),u.unSubscribe("__registChatAction"),u.subscribe("__registChatAction",function(e,t){l("registChatAction",t)});var g={},v=0,b=(new Date).getTime()+"";u.subscribe("__sendMessage",function(e,t,i){t.publishAck&&(t.bridgeMsgId=t.publishAck.bridgeMsgId,delete t.publishAck),t.bridgeMsgId?t.isResend=1:t.bridgeMsgId=b+ ++v,l("sendMessage",t),g[t.bridgeMsgId]=i}),u.subscribe("__loadPreHistory",function(e,t,i){l("loadPreHistory",{baseTalkId:u.lastTalkId||"",talkType:u.lastTalkType||""})}),u.subscribe("removeLoading",function(e,t,i){l("removeLoading")});var y=1;window.callEchatJsConnect=function(e){var t=d(e),i=!1;console.log(">>>callEchatJsConnect:"+JSON.stringify(e));try{t.functionName&&C[t.functionName]&&C[t.functionName](t.value)}catch(t){i=!0,a({tm:(new Date).getTime(),error:t.stack,msg:JSON.stringify(e)})}!i&&a({tm:(new Date).getTime(),info:"callEchatJsConnect",msg:JSON.stringify(e)})};var w,I,T={600:0,103:0,649:0,109:0,encryptVId:0},k=[],S=!1,C={preparedConnect:function(t){var i=d(t);window.initVisitorInfo,u.dataHost=i.dataHost,u.ajaxQueryUnread=function(t){if("0"==i.isConnect){if(S)return;S=!0;var a="https://"+(t||u.dataHost).replace(/([^\.]+)\./,"$1api.")+"/getVisitorUnReadMsgCount?sdkAppId="+encodeURIComponent(i.appId)+"&sdkAppSecret="+encodeURIComponent(i.appSecret)+"&encryptVId="+encodeURIComponent(i.encryptVId)+"&visitorId="+encodeURIComponent(i.visitorId||""|u.visitorId)+"&metaData="+(i.metaData?encodeURIComponent(i.metaData):"")+"&formData="+(i.formData?encodeURIComponent(i.formData):"");e.ajax({url:a,type:"jsonp",jsonpCB:"jsonpCallback",success:function(t){console.log(t),t&&t.unreadMsgCount>0&&(e("#restartChat").parents(".msg-info").remove(),view.chat.publish("restartChat")),callback},error:function(e){}})}},u.apiServerDomain&&u.ajaxQueryUnread(u.apiServerDomain)},msgFromServer:function(e){if(e){console.log("msgFromServer",e),void 0===u.lastTalkIdFromNative&&(t.publish("__callNative",{functionName:"queryTalkIDs"}),u.lastTalkIdFromNative="");var i=d(e);0===i.mid&&delete i.mid,i.bridgeMsgId&&g[i.bridgeMsgId]?(g[i.bridgeMsgId]&&g[i.bridgeMsgId](i),g[i.bridgeMsgId]=void 0):i.mt||i.encryptVId?(i.encryptVId&&(window.encryptVID=u.encryptVID=view.chat.encryptVID=i.encryptVId,i.companyId&&(u.companyId=view.chat.companyId=i.companyId)),i.mt&&"local"==i.mt&&i.fileType&&(1==i.fileType?i.mt="865":i.mt="866"),i.isForward=!1,u.receiveChat(i)):i.et||i.mt}},msgFromDB:function(i){console.log(i);var a=this;void 0===u.lastTalkIdFromNative&&(t.publish("__callNative",{functionName:"queryTalkIDs"}),u.lastTalkIdFromNative="");var n,o,s,r,l=d(i),c=[],f=("null"==l.chatDetailList?[]:l.chatDetailList)||[],m=f[f.length-1],h=m&&m.talkId||f[f.length-2]&&f[f.length-2].talkId;if("[object Array]"==Object.prototype.toString.call(f)&&0!=f.length){if(console.log("***msgFromDB***",e.extend([],f)),!u.lastTalkIdFromNative&&10009==m.mt){for(b=f.length-2;b>1;b--){if(605==f[b].mt&&f[b].talkId!=h){r=f[b].talkId||i.talkId,n={talkId:r,chatDetailList:f.splice(0,b+1)};break}if(10009==f[b].mt&&f[b].talkId!=h){for(var p=b-1;p>1;p--)if(655!=f[p].mt&&658!=f[p].mt&&f[p].talkId){n={talkId:f[p].talkId,chatDetailList:f.splice(0,b+1)};break}if(1!=p)break}}n&&(n.talkType=u.getTalkType(n.chatDetailList).talkType,setTimeout(function(){a.msgFromHistory(n)},1))}u.lastTalkIdFromNative||605!=m.mt&&10009!=m.mt||(m.isForward=!1,n||u.lastTalkId||(o=u.getTalkType(f),u.lastTalkId=o.talkId,u.lastTalkType=o.talkType));for(var g,v,b=0;b<f.length;b++){if(l=f[b],!s&&(s=l.talkId)&&u.hasPageHandleMsg==s)return;l.isForward="0"!=l.isForward&&l.isForward,l.mt&&644!=l.mt&&10005!=l.mt?(void 0!==T[l.mt]?(649==l.mt&&1==T[l.mt]?l.sdkChatBoxInfo&&c.push(l):(c.push(l),T[l.mt]=1),v=649==l.mt&&l.unreadMsgNumber>0):c.push(l),655!=l.mt&&658!=l.mt||(g=v),T.encryptVId=l.encryptVId||l.encryptVID||T.encryptVId):l.et&&104!=l.et&&1!=T[l.et]&&123!=l.et?void 0!==T[l.et]?(0==T[l.et]&&c.push(l),T[l.et]=1):c.push(l):"local"==l.mt&&(l.identityKey&&(l.fileIdentity=l.fileIdentity||l.identityKey),c.push(l)),l.id&&(l.id=l.mid||l.tm)}c.length&&(u.handleHistoryMsg(c),g&&10009==c[c.length-1].mt&&4==c[c.length-1].type&&setTimeout(function(){view.toggleLeaveToChat(1),e("#restartChat").parents("li").remove()},100)),u.hasPageHandleMsg=s}else u.hasPageHandleMsg=!0},allTalkIdFromHistory:function(e){if(console.log("******allTalkIdFromHistory****",e),u.lastTalkIdFromNative="",e){var t=d(e);if(t&&"null"==t[0]&&t.shift(),!t||!t[0]||1==t.length&&t[0].talkId==view.chat.talkId||t[0].talkId==u.lastTalkId)view.chat.hidePreHistory();else{for(var i=0;i<t.length;i++)t[i].talkIdType;u.lastTalkIdFromNative=t[0]&&t[0].talkId||"",view.chat.showPreHistory()}}else view.chat.hidePreHistory()},msgFromUnRead:function(e){if("null"!=e&&e){var t=d(e);if("[object Array]"==Object.prototype.toString.call(t)){console.log("*****************msgFromUnRead*handle*****************",t),k={};var i,a,n,o,s,r=t.length,l=!0;console.log(t);for(var f=0;f<r;f++)if(i=t[f].chatDetailList||[],a=i.length,s=t[f].talkId,u.lastTalkId||(u.lastTalkId=w=s,u.lastTalkType=I=t[f].lastTalkType,u.lastTalkIdLocked=!0),a){if(f==r-1){"605"!=i[a-1].mt&&"10009"!=i[a-1].mt||(u.hasPageHandleMsg?u.hasPageHandleMsg!=t[r-1].talkId&&C.msgFromDB(t[r-1]):C.msgFromDB(t[r-1]));break}k[s]={talkId:s,talkType:t[f].talkType};for(var m=0;m<i.length;m++)n=i[m],k[s],600!=n.mt&&n.mt,m>3&&600==n.mt&&(l=!1),!(l||671!=n.mt&&109!=n.et&&103!=n.et)||m>3&&600==n.mt||(l&&(12001!=n.mt||3!=n.type||204!=n.result&&205!=n.result||(l=!0)),"649"==n.mt?o=n:"600"==n.mt?(n.routeEntranceInfo=void 0,n.routeEntranceInfoString=void 0,o=null):"670"!=n.mt&&679!=n.mt&&604!=n.mt&&648!=n.mt||(o&&(o.sdkEntranceInfo=void 0),o&&(o.captChaToken=void 0)),c(n,k[s],"unread"));view.chat.showHis(k[s],(t[f].talkType||1)+"_"+s)}}else console.log("msgFromUnRead value 为Array json 格式，兼容多个会话的未读消息",t)}else console.log("msgFromUnRead length:null")},msgFromHistory:function(e){if("null"!=e&&e){var t=d(e);u.lastTalkId=w=t.talkId,u.lastTalkType=I=t.talkIdType||t.talkType,u.lastTalkIdLocked=!0,w==u.lastTalkIdFromNative&&(view.chat.hasPreHis=!1);for(var i={},a=t.chatDetailList||[],n=0;n<a.length;n++)c(a[n],i);console.log("%cmsgFromHistory showHis%c%o","color:green","color:green",i),view.chat.showHis(i,(I||1)+"_"+w)}else view.chat.hidePreHistory()},prepareUpload:function(t){var i=d(t);if(view.chat.isInWorkOrder)return view.prepareAddOrderFile(i);i.id=i.clientFileId,0===i.mid&&delete i.mid,_$(i.clientFileId)&&e("#"+i.clientFileId).remove(),content=view.getMsgSendingFile(i),view.chat.showMsg({id:i.clientFileId,f:"c",media:1,m:3==i.fileType||4==i.fileType?i.fileType:1},content)},uploadKey:function(e){C.prepareUpload({clientFileId:e})},uploadStart:function(e){var t=d(e);if(view.chat.isInWorkOrder)return view.updateOrderFile(t);t.id=t.clientFileId,0===t.mid&&delete t.mid;var i=view.getMsgSendingFile(t),a={1:lanRes.image,2:lanRes.fileHtml,4:lanRes.video,3:lanRes.voice};view.chat.publish("__visitorStartSendMsg","["+a[t.fileType]+"]"),i&&view.chat.updateMsg(t.clientFileId,i)},uploadProgress:function(e){var t=d(e);if(view.chat.isInWorkOrder)return 2==t.sendStatus?view.successOrderFile(t):view.updateOrderFile(t);if(t.id=t.clientFileId,!view.fileMsgs[t.clientFileId]||4!=view.fileMsgs[t.clientFileId].sendStatus){var i=view.getMsgSendingFile(t);i&&view.chat.updateMsg(t.clientFileId,i)}},uploadSuccess:function(e){view.chat.isInWorkOrder&&view.successOrderFile(d(e))},updateLocalMessage:function(e){var t=d(e);view.fileMsgs[t.clientFileId]&&(view.fileMsgs[t.clientFileId]=t)},downloadProgress:function(t){var i=d(t),a=view.fileMsgs[i.clientFileId],n=u.findMsgLiByMsg(i);a&&(a.loadStatus=i.loadStatus),n&&(barInfo=e(".file-load-bar-info",n).results[0],n=e(".msg-file",n).results[0],barInfo&&(1==i.loadStatus?(barInfo.innerHTML="点击打开",view.fileMsgs[i.clientFileId]=e.extend(view.fileMsgs[i.clientFileId],t)):2==i.loadStatus?(barInfo.innerHTML=i.progress+"%",e(".file-load-progress0",n).css("width",i.progress+"%")):3==i.loadStatus?barInfo.innerHTML="点击下载":4==i.loadStatus&&(barInfo.innerHTML='<span class="red">下载失败</span>点击重新下载')),n.className="msg-file file-load-status"+i.loadStatus)},callbackOpenFile:function(e){0==d(e).status&&alert("文件不存在")}};window.echatPageService=C,u.handleHistoryMsg=function(t){console.log("handleHistoryMsg",t);var i,n,o,s=t.length,r=t[s-1],l=!1,d=!0;if(s){if(600!=r.mt&&649!=r.mt||1!=s)if(605==r.mt)l=!0;else if(10009==r.mt)l=!0;else for(n=null,i=0;i<s;i++)r=t[i],i>3&&600==r.mt&&(d=!1),600==r.mt&&(u.companyId=r.companyId,void 0===o?o=i:t[o]=r),i>3&&600==r.mt||!(d||671!=r.mt&&109!=r.et&&103!=r.et)?(t.splice(i,1),i--,s--):(d&&(12001!=r.mt||3!=r.type||204!=r.result&&205!=r.result||(d=!0)),"649"==r.mt?n=r:"600"==r.mt?(r.routeEntranceInfo=void 0,r.routeEntranceInfoString=void 0,n=null):"670"!=r.mt&&"677"!=r.mt&&"678"!=r.mt&&679!=r.mt&&604!=r.mt||(n&&(n.sdkEntranceInfo=void 0),n&&(n.captChaToken=void 0)));else{if(!r.routeEntranceInfoString)return;if(1==s)return C.msgFromServer(r)}var c,f=e.store("ECHAT_inviteSatisfyId"),m=!0;for(f==e.store("ECHAT_inviteSatisfyHandle")&&(m=!1),i=s-1;i>-1;i--)600==(r=t[i]).mt?(r.routeEntranceInfo||r.routeEntranceInfoString)&&i<s-1&&(r.routeEntranceInfo=null,r.routeEntranceInfoString=null):649==r.mt?l&&(r.sdkEntranceInfo=null,r.captChaToken=null):673==r.mt&&(m?f<r.mid?r.del=!0:c?r.del=!0:c=r:r.del=!0);var h=[];for(i=0;i<s;i++)(r=t[i]).del||(r.fromDB=!0,r.fromHistory=!0,670!=r.mt&&(12001==r.mt&&3==r.type&&i<s-2||(105==r.et||130==r.et?r.mt=864:127==r.et&&(r.mt=127),!1===r.isForward&&605!=r.mt&&10009!=r.mt&&h.push[r],"local"==r.mt||"local_upload"==r.mt?view.chat.showMsg({id:r.clientFileId,f:"c",media:1,m:3==r.fileType||4==r.fileType?r.fileType:1},view.getMsgSendingFile(r)):function(e){setTimeout(function(){try{u.selfMsg(e)}catch(t){a({tm:(new Date).getTime(),error:t.stack,msg:e})}})}(r))));if(l&&h.length>1){var p={data:{chatDetailList:h}};u.publish("receiveUnread",p)}}},this.getTalkType=function(e){for(var t,i=e.length-1;i>0;i--){if(t=e[i].talkId||t,604==e[i].mt||648==e[i].mt||647==e[i].mt&&5==e[i].type)return{talkType:1,talkId:t};if(12001==e[i].mt||647==e[i].mt&&10==e[i].type)return{talkType:3,talkId:t};if(647==e[i].mt&&7==e[i].type)return{talkType:2,talkId:t}}for(i=e.length-1;i>0;i--)if(649==e[i].mt&&2==e[i].status)return{talkType:2,talkId:t};return{talkType:2,talkId:t}}};ECHATObjKeyMap.cometdId=t,t.setSub("chatId"),t.setSub("cometdId"),window.initChat=function(){e.store("ECHAT_chatStatus");setTimeout(function(){t.publish("__callNative",{functionName:"pageReady",value:{history:{data:[{mt:"649"},{mt:"604"},{mt:"10001"},{mt:"10011"},{mt:"865"},{mt:"641"},{mt:"10010"},{mt:"647"},{mt:"605"},{mt:"866"},{mt:"642"},{mt:"680"},{mt:"688"},{mt:"959"},{mt:"640"},{mt:"864"},{mt:"655"},{mt:"658"},{mt:"12001"},{mt:"673"},{mt:"648"},{mt:"local"},{et:"127"},{et:"105"},{et:"130"}]}}}),window.setVisitorInfo&&t.publish("__callNative",{functionName:"getVisitorId",callback:"setVisitorInfo"})})},window.retryTime=0}(EChatQuery),function(e,t){function i(t,i){if(t.isMini){var a=e("#content").height();e("#content").css("height",("close"==i?a+40:a-40)+"px")}else t.isMobile&&(e("#container").css(view.SDK?"paddingBottom":"bottom",e("#footer").height()+"px"),view.scrollToBottom&&view.scrollToBottom());view.scrollToBottom&&view.scrollToBottom()}function a(t,i,a){var n="",t=t||_$("entryForm"),o="",s="",r="";if(a?i=t[a]:i&&(a=i.name),1!=i.nodeType){n=[],s=[],r=[];for(var l=0;l<i.length;l++)i[l].checked&&(n.push(i[l].value),s.push(e(i[l]).attr("lb")),r.push(e(i[l]).attr("inputvalue")));o=e(i[0]).parents(".entry2-typeline").attr("lb"),n=n.join(","),s=s.join(","),r=r.join(",")}else if(o=e(i).attr("lb"),n=i.value.replace(/^[\s]+|[\s]+$/gi,""),"SELECT"==i.tagName)for(var d=0;d<i.length;d++)if(i[d].value==n){r=e(i[d]).attr("inputvalue"),s=e(i[d]).text();break}return{val:n,ipt:i,label:o,labelVal:s||n,inputValue:r}}function n(t,i,a,n){var r,l=!0,c=!1;if(1==t.nodeType?r=d[a]||d[t.type]:t.length>1&&t[0]&&(c=!0,t=t[0]),!i&&(t.className.indexOf("req")>-1||e(t).parents(".req").length)){l=!1;u="";u="text"==t.type?lanRes.inputPlease.replace("${inputName}",t.getAttribute("lb")):lanRes.inputPleaseJa2.replace("${inputName}",c?e(t).parents(".entry2-typeline").attr("lb"):t.getAttribute("lb")),_$("leave_tip_con").innerHTML=u}else if(i&&r)if(r.length&&i.length>r.length){l=!1;var u="";u="age"==a?lanRes.ageOverLengthJa.replace("${age}",t.getAttribute("lb")):t.getAttribute("lb")+lanRes.overLength,_$("leave_tip_con").innerHTML=u}else r.p&&!i.match(r.p)&&(l=!1,_$("leave_tip_con").innerHTML=r.msg||lanRes.visitor170+t.getAttribute("lb"));return view.chat.tipTimer&&clearTimeout(view.chat.tipTimer),n?(n&&n(l),l&&t.style?s():o()):l&&t.style?(t.style.borderColor="#FFFFFF",s()):(t.style.borderColor="#FF0000",o()),l}function o(t,i){view.chat.tipTimer&&clearTimeout(view.chat.tipTimer),t&&(_$("leave_tip_con").innerHTML=t),_$("leave_tip").className="leave-tip leave-tip-"+(i||"warn"),view.chat.tipTimer=setTimeout(function(){e("#leave_tip").addClass("tiphide")},3e3)}function s(){view.chat.tipTimer&&clearTimeout(view.chat.tipTimer),e("#leave_tip").addClass("tiphide")}function r(e){for(var t=!0,i=0;i<e.length&&(t=t&&"1"==e[i].configInline);i++);return t?"1":"0"}window._$=function(e){return e&&t.getElementById(e)},window._$s=function(e){return t.getElementsByTagName(e)},window.$=e,window.locationBase=window.locationBase||"",window.onerror=function(e){window.echatDebugConsole&&window.echatDebugConsole.log(e)};var l,d={};String.prototype.analyDomain=function(e){var t=this.toString(),i=[],a=t.indexOf(e);return a>=0?(i[0]=t.substring(0,a),t.substring(a+1)&&(i[1]=t.substring(a+1))):i[0]=t,i};var c=function(){UTIL.call(this),InputHandle.call(this),"undefined"!=typeof HistoryHandle&&HistoryHandle.call(this),"undefined"!=typeof MsgboxHandle&&MsgboxHandle.call(this),this.talkId="",this.KEY="chatId",ECHATObjKeyMap[this.KEY]=this,this.dataObject={staffInfos:{0:{img:"",name:""}},msgInfos:{hasVipHistory:!1,recentTalkId:"",currentPrevTalkId:""}},this.setSub(this.KEY),this.setSub("cometdId"),this.setSub("viewId"),this.errorList={},this.regFace=new RegExp("\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]|[#-®]|[‼-㊙]","g"),this.regEmo=new RegExp("\\[#[a-z0-9A-Z]+(_[a-z0-9A-Z]+)*#\\]","g"),this.unescapeSend=new RegExp("<d>","g");this.isMobile=2==this.Device.media||view.SDK||"xcx"==this.queryParams.launchfrom,this.isPcXcx=1==this.Device.media&&"xcx"==this.queryParams.launchfrom,this.isIOS=this.Browser.isIOS,this.isMini=!this.isMobile&&2==view.windowType,this.disableSoundTip=1==this.queryParams.disableSoundTip||view.SDKNative,this.plainText=!0,this.editorType=1,this.hasStorage&&(this.tempReferrer=this.hasStorage?e.store("echat_temp_referrer"):"",window.localStorage.removeItem("echat_temp_referrer")),"https:"==location.protocol||window.SDK?this.needHttps="https:":this.needHttps="",this.initVisitor(),this.init(),this.initBridge(),this.postMessage("miniReady"),this.setChatbox=function(t,i){if(i){var a="ECHAT_"+view.chat.companyId+"_"+t,n=JSON.stringify({chatStaffBackColor:i.chatStaffBackColor,chatStaffTxtColor:i.chatStaffTxtColor,chatVisitorBackColor:i.chatVisitorBackColor,chatVisitorTxtColor:i.chatVisitorTxtColor,sysMsgBackground:i.sysMsgBackground,sysMsgFontColor:i.sysMsgFontColor});i&&e.store(a,n,{path:"/",expires:365}),this.isIOS&&2==view.windowType&&this.postMessage({type:"updateLocalChatbox",key:a,value:n})}},this.getChatbox=function(t){var i=e.store("ECHAT_"+view.chat.companyId+"_"+t);return i&&JSON.parse(i)},this.addEchatInnerFrameParam=function(e){if(e){if(-1!=e.indexOf("&echatInnerFrame=1")||-1!=e.indexOf("?echatInnerFrame=1"))return e;var t=e.split("#"),i=t[1]||"",a=t[0];return a+((-1==a.indexOf("?")?0:1)?"&":"?")+"echatInnerFrame=1"+(i?"#":"")+i}},this.addFixedParam=function(e){if(!e||!view.echatSourceTagEnable||e.match(/^(mailto|tel|javascript):/i))return e||"";var t,i=new RegExp("(^|&)echatSourceTag=([^&]*)(&|$)","i"),a=e.analyDomain("?"),n="echatSourceTag="+(this.echatSourceTag||"");return t=(a[1]||a[0]).analyDomain("#"),t[0].match(i)?e:e=a.length>1?a[0]+"?"+t[0]+"&"+n+(t.length>1?"#"+t[1]:""):t[0]+"?"+n+(t.length>1?"#"+t[1]:"")}};c.prototype={replaceHtml:function(e){return e&&(e=(e+"").replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[face]")),e},initBridge:function(){var i=this,a=i.replaceHtml,n=new function(e,t,i){if(e&&i&&"function"==typeof i){var a=window,n=e;return a.addEventListener?(a.addEventListener("message",function(e){i(e,e.data)}),this.send=function(e){if(e&&t&&2==view.windowType&&window.top!=self)try{n.postMessage(e,t||"*")}catch(e){console.log(e)}}):this.send=function(){console.log("不支持 postMessage")},this}}(parent,i.queryParams.fromhost||(i.tempReferrer||t.referrer||"").split("/").slice(0,3).join("/"),function(e,t){i.publish("getCrossMessage",e)});this.subscribe("__chatStatus",function(a,o){i.outerChatStatus=o,n.send({act:100,eventAction:"chatStatus",eventLabel:o||""}),view.SDK&&e.store("ECHAT_chatStatus",o),"chatting"===o&&(!i.msg649.chatSmallBoxInfo&&!i.msg649.chatBoxInfo||i.msg649.chatSmallBoxInfo&&1==i.msg649.chatSmallBoxInfo.leftTopShowType||i.msg649.chatBoxInfo&&1==i.msg649.chatBoxInfo.enableQRCode)||"robot"===o&&(!i.msg649.robotSmallChatBox&&!i.msg649.robotPCChatBox||i.msg649.robotPCChatBox&&1==i.msg649.robotPCChatBox.enableQRCode||i.msg649.robotSmallChatBox&&1==i.msg649.robotSmallChatBox.leftTopShowType)?e("#qcode").show():e("#qcode").hide();var s=t.getElementsByTagName("body")[0],r=s.className;r=r.replace(/chatstatus-[^\s]+/gi,""),o&&(r+=" chatstatus-"+o),s.className=r}),this.subscribe("__staffStatus",function(e,t){n.send({act:100,eventAction:"staffStatus",eventLabel:t||""})}),this.subscribe("__chatStart",function(e,t){n.send({act:200,eventAction:"Served by Agent",eventLabel:t||""})}),this.subscribe("__chatQueue",function(e,t){n.send({act:100,eventAction:"queuePostion",eventLabel:t||""})}),this.subscribe("__chatStaffInfo",function(e,t){n.send({act:100,eventAction:"chatStaffInfo",eventLabel:JSON.stringify(t)})}),this.subscribe("__newMsg",function(e,t){var i=t.m;"s"==t.f&&t.c&&n.send({act:100,eventAction:"newMsg",eventLabel:0==i?a(t.c):1==i?"[file]":2==i?"[image]":""}),"r"==t.f&&(t.answer||t.c)&&n.send({act:100,eventAction:"newMsg",eventLabel:a(t.answer||t.c)})}),this.subscribe("__newSysMsg",function(e,t){var i=t.m;t.c&&n.send({act:100,eventAction:"newSysMsg",eventLabel:0==i?a(t.c):1==i?"[file]":2==i?"[image]":""})});var o=["","angry","unsatisfied","ok","satisfied","perfect"];this.subscribe("__evaluate",function(e,t,a){n.send({act:100,eventAction:"visitorEvaluate",eventLabel:t||""});var s=t.split("-");0==s[0]?n.send({act:200,eventAction:"Chat_Evaluate_Cancel",eventLabel:1==s[1]?"chatting":"end"}):n.send({act:200,eventAction:"Chat_Evaluate_"+o[i.evaluateScore-0],eventLabel:1==s[1]?"chatting":"end"})}),this.subscribe("__evaluateComment",function(e,t){n.send({act:200,eventAction:"Chat_Comment_submit",eventLabel:t.chatting?"chatting":"end"})}),this.subscribe("__visitorHide",function(e,t){n.send({act:100,eventAction:"visitorHide",eventLabel:t||""})})},initVisitor:function(){d={email:{p:/^[\w\d_\-\.]+@.+[\.].+/gi,msg:lanRes.invildEmail,length:50},phone:{p:/^[0-9\-]{0,20}$/,msg:lanRes.invildPhone,length:20},age:{p:/^[1-9][\d]{0,2}$/gi,msg:lanRes.invildAge,length:3},qq:{p:/^[1-9][\d]+$/gi,msg:lanRes.invildQQ,length:50},date:{p:/^[\d]{4}[-\/][\d]{2}[-\/][\d]{1,2}/gi,msg:lanRes.invildDate,length:50},address:{length:255},name:{length:50},wechat:{length:50},nickName:{length:50},birthday:{length:20},content:{length:1e3},memo:{length:255},textarea:{length:500},text:{length:100},number:{p:/^\-?\d*$/,length:50}},this.dataHost=window.dataHost,e("#inputLengthTip").html(lanRes.inputLengthTip1+" 30 "+lanRes.inputLengthTip2),view.SDK||(window.chatVisitorId&&e.cookie("ECHAT_"+window.companyId+"_chatVisitorId",chatVisitorId),window.encryptVID&&(e.cookie("ECHAT_"+window.companyId+"_encryptVID",encryptVID),this.encryptVID=encryptVID))},init:function(){function a(t,i){d.oldBodyEnterText;var a=d.getInput(!1),n=t.target||{},o=n.innerHTML||"";if(t.clipboardData){t.clipboardData.getData("text");t.clipboardData.items[0].getAsString(function(t){var s=i-a.length;(a=d.getInput(!1)).length>=i&&(n.innerHTML=o+t.substr(0,s),e("#inputLengthTip").html(lanRes.inputLengthTip1+" 0 "+lanRes.inputLengthTip2))})}else setTimeout(function(){(a=d.getInput(!1)).length>i?n.innerHTML=o:d.oldBodyEnterText=a,e("#inputLengthTip").html(lanRes.inputLengthTip1+"&nbsp;"+(i-d.oldBodyEnterText.length)+"&nbsp;"+lanRes.inputLengthTip2)})}function l(e){for(var t,i,a=view.chat,n=function(){for(var e=view.tempPlusFilePath,t=0;t<e.length;t++)if(0==e[t].status)return e[t].status=1,e[t]}(),o=n.path,s=a.fileUploadInfos["uploadServiceType"+e.uploadServiceType]||e,r={},l=a.needHttps?s.fileUploadHttpsUrl:s.fileUploadUrl,d=e.qiniuKey||e.token||e.aliyunKey&&e.aliyunKey.match(/\/([^\/]+$)/)[1],c=null,u={},f=s.fileUploadParam.split(","),m=0;m<f.length;m++)r[f[m].split("=")[0]]=(c=f[m].match(/\$\{([^\}]+)\}/))?e[c[1]]:f[m].split("=")[1];i=o.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1"),t=plus.uploader.createUpload(l,{method:"POST",priority:100},function(t,i){200==i?function(){for(var e=view.tempPlusFilePath,t=0;t<e.length&&e[t].path!=o;t++);view.tempPlusFilePath.splice(t,1)}():403!=i?(n.status=0,a.resendFile(e,d)):a.publish("getErr",{reqInfo:d,code:-2})});for(var h in r)"Content-Disposition"!=h&&"x:filename"!=h||(r[h]=i,window.plus&&t.addData(h,i)),u[h]=r[h],t.addData(h,r[h]);t.addFile(o,{key:"file",name:i}),t.start(),_$(d)||a.showMsg({id:d,f:"c"},'<div class="file-sending">'+lanRes.fileSending+"</div>")}var d=this;if(view.initViewEvent(this),d.filterMsg=view.hasNative&&d.queryParams.fvMsg,d.showTip=o,d.checkIpt=n,d.defaultVisitorImg=locationBase+"/res/imgs/visitor.png",d.defaultStaffImg=locationBase+"/res/imgs/staff.png",this.paramChat={companyId:d.companyId,visitorId:d.visitorId,firstTitle:d.queryParams.firstTitle||"",firstUrl:d.queryParams.firstUrl||"",referrer:d.queryParams.referrer||"",chatPage:d.queryParams.enterUrl||d.tempReferrer||t.referrer||"",chatPageTitle:d.queryParams.enterTitle||"",metaData:d.queryParams.metadata||"",formData:d.queryParams.formdata||"",myData:d.queryParams.myData||"",info:d.queryParams.info||"",echatTag:d.queryParams.echattag||"",lan:window.lanName,visEvt:d.queryParams.visEvt||"",eventId:d.queryParams.eventId||"",acdStaffId:d.queryParams.acdStaffId||"",acdType:d.queryParams.acdType||"",media:view.windowType||"",staffId:this.staffId||"",staffName:this.staffName||"",talkId:this.talkId||"",multipleFile:d.queryParams.multipleFile||0},window.initVisitorInfo){for(var c in window.initVisitorInfo)this.paramChat[c]=window.initVisitorInfo[c];try{var u="string"==typeof window.initVisitorInfo.visEvt?window.initVisitorInfo.visEvt:JSON.parse(window.initVisitorInfo.visEvt);u&&u.eventId&&(this.paramChat.eventId=u.eventId)}catch(e){}}this.subscribe("setConfig",function(t,i){var a;d.isInRobot?a=view.SDK?i.robotSdkChatBox:d.isMobile?i.robotPhoneChatBox:2==view.windowType?i.robotSmallChatBox:i.robotPCChatBox:(i.chatBoxInfo||i.chatSmallBoxInfo||i.mobileChatBoxInfo||i.sdkChatBoxInfo,a=view.SDK?i.sdkChatBoxInfo:d.isMobile?i.mobileChatBoxInfo:2==view.windowType?i.chatSmallBoxInfo:i.chatBoxInfo),view.echatSourceTagEnable=i.echatSourceTagEnable?parseInt(i.echatSourceTagEnable||0):0,view.hasSetAD&&(view.hasSetAD=!1,view.canSetAD=1),a&&(a.chatBoxTitle&&(view.pageTitle=(a.chatBoxTitle||"").replace(/\$\{[^}]+\}/g,""),view.titles&&(view.titles[1]=a.chatBoxTitle),d.changeDocTitle(a.chatBoxTitle),view.setDocumentTitle&&view.setDocumentTitle("c")),d.defaultStaffImg=a.defaultStaffImg||d.defaultStaffImg,d.defaultVisitorImg=a.defaultVisitorImg||d.defaultVisitorImg,d.needHttps&&(d.defaultStaffImg=d.defaultStaffImg.replace(/^http:/,d.needHttps),d.defaultVisitorImg=d.defaultVisitorImg.replace(/^http:/,d.needHttps)),d.busyCanSend="1"!=a.busyNotAllowSendStatus,e("#busyTip").html((a.busyNotAllowTips||"").replace(/(<p>|<\/p>)/gi,"")),e("#busyTipLine").addClass("hide").hide(),view.setConfig(d,i,a),Number(a.toolEmoji)?e(".menu-emo").removeClass("style-tool-hide"):e(".menu-emo").addClass("style-tool-hide"),Number(a.toolFile)?e(".menu-file").removeClass("style-tool-hide"):e(".menu-file").addClass("style-tool-hide"),Number(a.toolSatisfaction)?e(".menu-satisfy").removeClass("style-tool-hide"):e(".menu-satisfy").addClass("style-tool-hide"),Number(a.toolScreenshot)?e(".menu-capture").removeClass("style-tool-hide"):e(".menu-capture").addClass("style-tool-hide"),Number(a.toolTelephone)?e(".menu-phone").removeClass("style-tool-hide"):e(".menu-phone").addClass("style-tool-hide"),Number(a.toolCamera)?e(".menu-camera").removeClass("style-tool-hide"):e(".menu-camera").addClass("style-tool-hide"),Number(a.toolLocation)?e(".menu-map").removeClass("style-tool-hide"):e(".menu-map").addClass("style-tool-hide"),Number(a.toolVoice)?e(".record-switch").removeClass("style-tool-hide"):e(".record-switch").addClass("style-tool-hide")),d.toolScreenshot=Number(a?a.toolScreenshot:0)||0,d.leaveWordInfo=i.leaveWordInfo||i.mobileLeaveWordInfo||d.leaveWordInfo}),d.subscribe("sendLocationInfo",function(e,t){d.showLocation(t)}),d.leaveMsgMap={},d.subscribe("getLeaveMsg",function(i,a,n){a.realTalkId||(a.realTalkId=a.newsMsgId,a.fromHistory&&!a.current||(a.talkId=d.talkId||a.chatInfoType+"_"+a.newsMsgId));var o='<li class="clearfix '+(1==a.read?"":"fold")+'" talkid="'+a.talkId+'" id="msg'+a.tm+'"><div class="msg-leave" k="'+a.signature+'"><div class="msg-leave-title"><i class="msg-leave-i"></i>'+(a.staffNickName?'<span class="color0 msg-leave-name">'+a.staffNickName+"&nbsp;</span>":'<span class="msg-leave-name">'+lanRes.serviceStaff+"&nbsp;</span>")+'<span class="msg-leave-t">'+(4==a.chatInfoType?lanRes.staffLeave:lanRes.leaveStaffReply)+'</span></div><div class="msg-leave-con" ><div class="msg-leave-content">'+d.filterEmo(d.HTMLDecode(a.brief))+'</div><div class="msg-leave-dot">...</div><div class="msg-leave-link color0">'+lanRes.viewAll+"</div></div></div></li>",s=t.createElement("ul");s.innerHTML='<li class="clearfix" ><div class="color1 tc">'+d.getTimeStr(a.tm)+"</div></li>"+o;for(var r,l=this.getListMsgEl(a.talkId,a.tm,!!a.current),c=s.childNodes,u=0;r=c[u++];)1==r.nodeType&&(r=r.cloneNode(!0),l.appendChild(r));var f=e("#msg"+a.tm+" .msg-leave-title").results[0].offsetWidth,m=e("#msg"+a.tm+" .msg-leave-i").results[0].offsetWidth,h=e("#msg"+a.tm+" .msg-leave-t").results[0].offsetWidth,p=e("#msg"+a.tm+" .msg-leave-name").results[0].offsetWidth;if(p>f-h-m&&(p=f-h-m,e("#msg"+a.tm+" .msg-leave-name").attr("style","width:"+p+"px")),c=null,s=null,view.scrollToBottom(null,{transitionDuration:100,timeout:100}),a.current){if(a.f=n?"r":"s",a.c=a.brief,delete a.content,delete a.current,3==a.chatInfoType){var g,v="3_"+a.newsMsgId,b=d.updateHistoryComplete(v);b&&b[v]?((g=e.extend({},a)).talkId=a.newsMsgId,g.talkTypeId=v,d.pushHistory(g)):d.pushHistory(a),e(l).addClass("new-leave")}else a.talkId=a.newsMsgId,a.talkTypeId=a.chatInfoType+"_"+a.newsMsgId,d.pushHistory(a);l=null,d.handleNewMsgMid(a.mid,{c:a.brief,f:"s",m:0},!0,a),!d.isMobile&&view.setDocumentTitle&&view.setDocumentTitle("s")}d.leaveMsgMap[a.signature]=a}),d.subscribe("overLength",function(){o(lanRes.overLength)});view.chat.Browser.isAndroid&&navigator.userAgent.indexOf("baiduboxapp");e("#enter_btn").on(d.isMobile&&!d.isPcXcx?"touchend":"click",function(e){d.publish("_sendMsg");try{3==d.editorType?window.getSelection().empty():2==d.editorType&&d.win.getSelection().empty()}catch(e){}d.isMobile&&"qq"!=d.Browser.browser&&"weixin"!=d.Browser.browser&&"uc"!=d.Browser.browser&&(view.hideMenus(),d.getInputDocBody().blur(),view.inputBlur&&view.inputBlur(e))}),d.loadConsole=function(e){d.loadConsole=void 0,d.addJS(__uri("/visitor/common/lib/vconsole.js"),function(e){var t=window.console;new VConsole;t.log("location.href",location.href),t.log("msg600::",d.msg600),t.log("msg649::",d.msg649),d.subscribe("echatLog",function(e,t,i){window.console.log(t,i)})})},d.visitorCloseFunc=function(t){function i(){d.visitorClose=!0,d.publish("_endChat"),d.leaveAndClose?(d.publish("_endConnect"),d.publish("_closeWin")):d.isInWorkOrder?(d.publish("_endConnect"),d.publish("_closeWin"),e("#loading").show()):d.hasEntryOrCode||"0"==d.queryParams.autoChat?(d.publish("entryCallback",{success:!0}),d.publish("_endConnect"),d.publish("chatEnded",{closeReason:1}),d.publish("__visitorCloseCallback",{type:"close",memo:"信息收集/验证码,访客确认关闭"}),d.publish("__chatStatus","end-1-0"),d.publish("_closeWin")):ECHATObjKeyMap.cometdId.waitForRouterSelect?(d.publish("_endConnect"),d.publish("__visitorCloseCallback",{type:"close",memo:"咨询入口选择时,访客确认关闭"}),d.publish("__chatStatus","end-1-0"),d.publish("_closeWin")):d.outerChatStatus&&d.outerChatStatus.match(/waiting|chatting|leaveToService/)?d.publish("__visitorCloseCallback",{type:"wait",memo:"等待H5发送结束指令,Native将根据结束状态决定关闭view"}):(d.publish("__visitorCloseCallback",{type:"close",memo:"根据状态发现对话没有建立,访客确认关闭"}),d.publish("__chatStatus","end-1-0"))}if(d.visitorClose=!0,!1!==d.chatting&&"disconnected"!=EChatQuery.cometd.getStatus()||d.isInWorkOrder&&!(d.isInWorkOrder&&d.msg649.unreadMsgNumber&&parseInt(d.msg649.unreadMsgNumber))){if(1===t||!d.outerChatStatus||"registerChat"==d.outerChatStatus)return i();d.showDialog({tip:d.isInWorkOrder?lanRes.visitor188:lanRes.closeTip,ok:i,cancel:function(){d.visitorClose=!1,d.publish("__visitorCloseCallback",{type:"cancel",memo:"访客取消关闭"})}})}else d.publish("__visitorCloseCallback",{type:"close",memo:"对话已经结束/连接已经断开,可直接销毁"}),d.publish("_closeWin")},e(".action-close").on("click",d.visitorCloseFunc),e("#pre_his").on("click",function(){d.loadHistory()}),e("#inputPlaceholder").on("mouseover touchstart",function(){e(this).addClass("hide")}),this.subscribe("_endChat",function(e,t){d.publish("sendVisitorEvent",{et:107},function(){}),d.postMessage(3)}),e("#changelang").on("change",function(e){switch(parseInt(this.value)){case 0:lanResName="zhcn";break;case 1:lanResName="enus";break;case 2:lanResName="jp";break;default:lanResName="zhcn"}var i=t.createElement("script"),a=_$("langScript"),n=a.parentNode;i.id="langScript",i.src=supportLang[lanResName],n.replaceChild(i,a)}),e(t).on("click",".resend",function(){if(!view.handleNetwok||!view.handleNetwok()){var t=e(this).attr("dataid"),i=d.errorList[t];if(i.id=t,i.m=i.m||0,i.f=i.f||"c",i.c=i.c||i.content,!1!==d.chatting&&void 0!==d.chatting)if(d.isInRobot&&7==i.m)d.showTip(lanRes.visitor171);else{var a=_$(t);(a=a.previousElementSibling)&&a.childNodes[0]&&-1!=(a.childNodes[0].className+"").indexOf("color1")&&e(a).remove(),e("#"+t).remove(),d.sendToServer(i)}else 7==i.m?d.showTip(lanRes.visitor171):d.showTip(lanRes.visitor172)}}).on("click",".btn-restart",function(){view.handleNetwok&&view.handleNetwok()||("restartChat"==e(this).attr("id")&&setTimeout(function(){d.publish("restartChat")},10),e(".btn-restart").removeAttr("id").removeClass("btn-restart"),e(this).removeAttr("id").removeClass("btn-restart").text(lanRes.chatContinued))}),this.subscribe("displayRouterInfo",function(t,i){var a,n=i.routeEntranceInfo;a="string"==typeof n.entranceDetails?JSON.parse(n.entranceDetails):n.entranceDetails,n.chatBoxTitle?(view.pageTitle=(n.chatBoxTitle||"").replace(/\$\{[^}]+\}/g,""),d.changeDocTitle(n.chatBoxTitle),d.publish("__setTitle",n.chatBoxTitle)):d.publish("__setTitle",lanRes.onlineService);var o=n.routeStatusList,s={};if(o&&o.length)for(var r=0;r<o.length;r++)s[o[r].routeId]=2!=o[r].routeStatus;for(var l='<div id="routerTitle" class="router-title '+(n.title?"":"router-hide")+'">'+n.title+'</div><div id="routerList" class="router-list"><ul class="clearfix">',c=0,u=n.lines,f=n.chosenColor||"#0da7db",m=0;m<a.length;m++){var h=a[m].routeId;if(h){c++,s[h]||(a[m].icon=a[m].offlineIcon||a[m].icon,a[m].content=a[m].offlineContent||a[m].content);var p=c%u==0;d.needHttps&&a[m].icon&&(a[m].icon=a[m].icon.replace(/^http:/,d.needHttps));l+='<li class="router-item router-item-content'+(a[m].icon&&!a[m].content?1:a[m].icon&&a[m].content?2:!a[m].icon&&a[m].content?3:a[m].icon||a[m].content?"":3)+'" data="'+h+'" dataindex="'+m+'" '+(p?'style="border-right:none;"':"")+'><div class="router-item-content"><div class="router-item-icon '+(a[m].icon?"":"router-hide")+'">'+(a[m].icon?'<img onload="view.checkImg&&view.checkImg(this)" src="'+a[m].icon+'"/>':"")+"</div>"+(1==view.windowType?'<div class="router-item-text '+(a[m].content?"":"router-hide")+'">'+(a[m].content?'<div class="router-item-text-bg" style="background:'+f+';"></div><div class="router-item-text-tx">'+a[m].content+"</div>":"")+"</div>":"")+'</div><div class="router-item-theme">'+a[m].theme+"</div></li>"}}if(l+="</ul></div>",d.publish("removeLoading"),0==c)ECHATObjKeyMap.cometdId.waitForRouterSelect=!1,e("#router").hide();else{e("#loading").hide(),e("#mask").show();var g,v=150*u;e("#router").addClass("router-line"+u).html(l).css({width:view.px2rem?view.px2rem(v):v+"px",marginLeft:view.px2rem?view.px2rem(-v/2):-v/2+"px"}).show().removeClass("slideUp"),d.isMobile||e(".router-item").on("mouseover touchstart",function(t){e(this).addClass("hover"),e(".router-item-theme",this).css({background:f,color:"#FFF"})}).on("mouseout touchend",function(t){e(this).removeClass("hover"),e(".router-item-theme",this).css({background:"#fff",color:"#323232"})}),e(".router-item").off("click").on("click",function(t){var i=e(this).attr("dataindex"),o=e(this).attr("data");o&&a[i]&&a[i].routeId==o&&(d.routeId=o,d.routeEntranceTheme=a[i].theme,d.paramChat.echatTag=a[i].routeEntranceEchatTag||d.routeEntranceTheme,e("#loading").show(),d.publish("routerSelect"),d.publish("toSetID"),e("#router").hide(),e("#mask").hide(),ECHATObjKeyMap.cometdId.waitForRouterSelect=!1,a=null,n=null)});view.handleRouterSelect&&view.handleRouterSelect(c,u)||(g=e("#router").height()||200,e("#router").css({marginTop:-g/2+"px"}))}}),this.subscribe("getLeaveReply",function(e,t){t.content&&d._getMsg(t,0,t.content),928!=t.from&&d.publish("toSetID")}),this.subscribe("getNewUnreadMsgCount",function(e,t){(500002==t.platformId||500003==t.platformId||20==t.platformId)&&d.showTip("收到685"+t.lastMsgContent),view.handleNewUnreadMsgCount&&view.handleNewUnreadMsgCount(t),d.sendMsgboxUnread.send(t)});var f;this.subscribe("updateVisitorInfo",function(t,i){var a,n;d.visitorId!=i.visitorId&&(a="ECHAT_HIS_"+window.companyId+"_"+i.visitorId,d.historyKey&&a!=d.historyKey&&(d.historyKey=a,d.hasStorage&&(n=window.localStorage.getItem(a))&&(window.localStorage.removeItem(d.historyKey),e.store(a,n))),d.visitorId=i.visitorId),i.photo&&d.visitorImg!=i.photo&&(e(".avatar-icon-img").each(function(e){-1!=this.parentNode.className.indexOf("fr")&&(this.src=i.photo)}),d.visitorImg=i.photo),void 0!==i.metaData&&(d.paramChat.metaData=i.metaData),i.myData&&(d.paramChat.myData=i.myData),i.formData&&(d.paramChat.formData=i.formData)}),this.subscribe("refreshVisitorInfo",function(e,t){var i="ECHAT_HIS_"+window.companyId+"_"+t.visitorId;d.historyKey=i,d.visitorId=t.visitorId,d.paramChat.metaData=t.metaData,t.photo&&(d.visitorImg=t.photo),t.myData&&(d.paramChat.myData=t.myData),t.formData&&(d.paramChat.formData=t.formData)}),this.uploadUtil=function(){var e={},t=1,i=[];return e.setUploadService=function(e){t=(i=e)[0].uploadServiceType||1},e.getUploadServiceType=function(e){return t=i[0].uploadServiceType},e.getNextUploadType=function(e){var a,n=i.length,o=i[n-1].uploadServiceType;if((e=e||t)==o)return!1;for(var s=0;s<n;s++){if(a)return i[s].uploadServiceType;i[s].uploadServiceType==e&&(a=s+1)}return!1},e.getLastUploadType=function(){return i[i.length-1].uploadServiceType},e}(),this.subscribe("setVisitorInfo",function(t,i){e("#leaveDisabled").hide(),d.msg600=i,d.visitorImg=i.photo,d.visitorId=i.visitorId,d.companyId=i.companyId,d.appId=i.appId,d.appSecrect=i.appSecrect,window.encryptVID=i.encryptVID,d.isVip=1==i.visitorType,d.visitorType=i.visitorType;for(var n=[lanRes.visitor_doc,lanRes.visitor_audio,lanRes.visitor_video,lanRes.visitor_img,lanRes.visitor_compress,lanRes.visitor_other],o=[["doc","docx","xls","xlsx","ppt","pptx","pdf","txt"],["amr","mp3","wav","aac","ogg"],["mp4","mov","webm","avi","m4v","mkv"],["jpg","jpeg","png","gif","bmp"],["rar","zip"],["p12","ttf","otf","abr","log","m4a","wma","mid","hevc","3gp","ts","3g2","3gpp","3gpp2","aep","vsp","prproj","rmvb","rm","flv","heic","heif","psd","psb","indd","xd","sketch","ai","cdr","eps","webp","tif","c4d","max","ezp","xlsm","key","rar4","r00","r01","r02","r03","zipx","7z","001","kz","ace","c00","c01","c02","apk"]],s={},r=(i.uploadFileType||"").split(","),l=0;l<r.length;l++)for(var c=0;c<n.length;c++){var u=n[c];s[u]||(s[u]=[]),-1!==o[c].indexOf(r[l].toLowerCase())&&s[u].push(r[l].toLowerCase())}if(i.uploadFileSize&&(d.uploadFileSize=i.uploadFileSize||5242880,d.uploadFileType=i.uploadFileType,d.uploadFileTypeKey=s),d.qiniuDomain=i.qiniuBucketDomain,d.qiniuHttpsDomain=i.qiniuBucketHttpsDomain,d.platformName=i.platformName,d.platformLogo=i.platformLogo,d.companyName=i.companyName,d.companyLogo=i.companyLogo,d.companyMobileSite=i.companyMobileSite,d.companyWebSite=i.companyWebSite,UTIL.prototype.clearPrevStorage&&UTIL.prototype.clearPrevStorage.call(d,d.companyId,d.visitorId,window.chatVisitorId),d.sendMsgboxUnread.init(function(e){view.__nativeAPI&&view.__nativeAPI("platformNewMsg",d.formatUnreadMsg.call(d,e)),(500002==e.platformId||500003==e.platformId)&&d.showTip("platformNewMsg"+JSON.stringify(e))}),d.publish("initPageStatus",{companyId:d.companyId,companyName:d.companyName}),first600=1,d.apiServerDomain=(view.SDK||d.needHttps?"https:":"http:")+"//"+i.apiServerDomain,i.fileUploadInfos&&(d.uploadUtil.setUploadService(i.fileUploadInfos),d.fileUploadInfos=function(){i.fileUploadInfos=i.fileUploadInfos;for(var e={array:[]},t=0;t<i.fileUploadInfos.length;t++)e["uploadServiceType"+i.fileUploadInfos[t].uploadServiceType]=i.fileUploadInfos[t],e.array.push(i.fileUploadInfos[t].uploadServiceType);return e}()),d.historyKey||(d.historyKey="ECHAT_HIS_"+window.companyId+"_"+i.visitorId,d.hasPreHis=d.checkHistory(),d.isIOS&&2==view.windowType&&d.postMessage({type:"initLocalHistory",key:d.historyKey})),d.typingMaxLength=i.visitorTypingMaxLength>0?i.visitorTypingMaxLength:0,i.visitorInputContentMaxLength>0&&!f){var m=d.inputMaxLength=i.visitorInputContentMaxLength;f=!f,setTimeout(function(){var e=d.getInputDoc().getElementsByTagName("body")[0];e.addEventListener?(e.addEventListener("keydown",function(e){a(e,m)}),e.addEventListener("paste",function(e){a(e,m)})):(e.attachEvent("onkeydown",function(e){a(e,m)}),e.attachEvent("onpaste",function(e){a(e,m)}))},200)}}),d.oldBodyEnterText="",this.subscribe("setChatParam",function(e,t){d.msg600&&d.msg600.metaData&&(d.paramChat.metaData=d.msg600.metaData),d.paramChat.country=t.country||"",d.paramChat.province=t.province||"",d.paramChat.city=t.city||"",d.paramChat.searcher=t.searcher||"",d.paramChat.keyword=t.keyword||"",d.paramChat.firstUrl=d.paramChat.firstUrl||t.firstUrl,d.paramChat.referrer=d.paramChat.referrer||t.referrer,d.paramChat.eventId=d.paramChat.eventId||t.eventId,d.paramChat.companyId=d.companyId,d.paramChat.visitorId=d.visitorId,d.paramChat.osName=d.queryParams.osName,view.canSetAD++,view.setAD&&view.setAD()}),this.subscribe("updateChatParam",function(t,i){e.extend(d.paramChat,i)}),this.restartParam={},this.subscribe("setRestartTag",function(e,t){d.restartParam={nonce:t.nonce,reChatTag:t.reChatTag},t.talkId&&!d.talkId&&t.notStore&&(d.talkId=t.talkId),d.hasPreHis=d.checkHistory(),view.noScrollBottom=!1}),d.isAutoPop="1"==d.queryParams.autoPop,this.subscribe("handshakeOk",function(t,i){d.robotToHumanKey=null,e("#restartChat").text(lanRes.chatContinued),e(".btn-restart").removeAttr("id").removeClass("btn-restart")}),this.subscribe("changeToPlatform",function(e,t){d.platformData=t,d.paramChat.echatTag=t.echatTag}),this.checkFirstMsg=function(e){function t(e,t){return e&&(e+"").replace(/<(?:.|\s)*?>/gi,"").substring(0,t||100)}if(e){try{e=JSON.parse(e)}catch(e){return}return"text"==e.msgType&&e.content?{msgType:"text",content:t(e.content),translation:e.translation&&t(e.translation)}:"image"==e.msgType&&e.picUrl?{msgType:"image",picUrl:e.picUrl,thumbUrl:e.thumbUrl||""}:"video"==e.msgType&&e.fileUrl?{msgType:"video",fileUrl:e.fileUrl,fileSize:e.fileSize||0,fileName:e.fileName||"",thumbUrl:e.thumbUrl}:"file"==e.msgType&&e.fileUrl?{msgType:"file",fileUrl:e.fileUrl,fileSize:e.fileSize||0,fileName:e.fileName||""}:void 0}},this.subscribe("toUpdateMetadata",function(){e.ajax({url:d.apiServerDomain+"/chatapi/gvmc?from="+(view.SDKNative?3:1)+"&companyId="+d.companyId+"&encryptVId="+encodeURIComponent(window.encryptVID),type:"get",success:function(e){if((e="string"==typeof e?JSON.parse(e):e)&&e.result&&e.successful){var t=e.result;d.publish("updateVisitorInfo",{visitorId:d.visitorId,photo:t.metaDataInfo?t.metaDataInfo.photo:"",metaData:t.metaData||"",myData:t.myData})}},error:function(e){}})}),this.subscribe("toSetID",function(t,i){function a(e){return e?(e+"").replace(/<(?:.|\s)*?>/gi,""):e}d.talkId="",d.no103=!1;var n=n;if(d.companyOff=n,d.publish("__chatStatus","registerChat"),1!=d.visitorType||d.paramChat.metaData||d.publish("toUpdateMetadata"),view.SDKNative){o={et:109},d.routeId&&(o.routeId=d.routeId,o.routeEntranceTheme=d.routeEntranceTheme,o.echatTag=d.paramChat.echatTag),d.robotToHumanKey&&(o.robotToHumanKey=d.robotToHumanKey);return(s=d.data109)?(s.visEvt&&(o.visEvt=s.visEvt),s.routeId&&(o.routeId=s.routeId),s.routeEntranceTheme&&(o.routeEntranceTheme=s.routeEntranceTheme)):d.data109=o,void d.publish("__registChatAction",o)}var o;o={et:109,windowType:view.windowType,companyId:d.companyId,page:d.paramChat.chatPage||n,title:d.paramChat.chatPageTitle||n,firstEnterUrl:d.paramChat.firstUrl||n,firstEnterTitle:d.paramChat.firstTitle||n,referrer:d.paramChat.referrer||n,media:d.Device.media,browserName:d.Browser.browser,browserVersion:d.Browser.version,osName:d.queryParams.osName||d.Device.OS.toLowerCase(),screenResolution:window.screen.width+"x"+window.screen.height,echatTag:d.paramChat.echatTag||n,routerId:d.queryParams.routerid||n,departmentId:d.queryParams.departmentid||n,routeEntranceId:d.queryParams.routeentranceid||n,styleId:d.queryParams.styleid||n,multipleFile:d.queryParams.multiplefile||0,fm:d.checkFirstMsg(d.queryParams.fm),msgBox:d.queryParams.openByMsgbox?1:n},view.SDK&&(o.webSdk=1),d.robotToHumanKey&&(o.robotToHumanKey=d.robotToHumanKey),"1"==d.queryParams.autoPop&&d.isAutoPop&&(o.isAutoPop=1),"1"==d.queryParams.acceptInvite&&(o.acceptInvite=1),d.queryParams.bd_vid&&(o.containBdVidChatUrl=location.href),d.paramChat.acdStaffId&&(o.acdStaffId=d.paramChat.acdStaffId),d.paramChat.acdType&&(o.acdType=d.paramChat.acdType);var s=d.data109;d.data109=o,s&&(s.visEvt&&(o.visEvt=s.visEvt),s.routeId&&(o.routeId=s.routeId),s.routeEntranceTheme&&(o.routeEntranceTheme=s.routeEntranceTheme)),d.routeId&&(o.routeId=d.routeId,o.routeEntranceTheme=d.routeEntranceTheme);var r=d.queryParams.visitorid;if(r&&(o.visitorId=r,o.chatToken=d.queryParams.chattoken,o.tm=d.queryParams.tm,d.chatToken=o.chatToken),d.restartParam&&e.extend(o,d.restartParam),1==d.toLeaveWord&&(o.toLeaveWord=1,d.toLeaveWord=n),d.staffChatNeedConnect=!1,window.isInPlatform&&d.platformData&&(o.companyId=d.platformData.platfromId,o.routeId=d.platformData.routeId,o.echatTag=d.platformData.echatTag,o.toPlatformToken=d.platformData.toPlatformToken),d.paramChat.visEvt){var l;try{l=JSON.parse(d.paramChat.visEvt)}catch(e){l=d.paramChat.visEvt}if("object"==typeof l){var c={},u=!1;l.visEvt&&("object"==typeof l.visEvt?c=l.visEvt:u=!0),o.visEvt={customizeMsgType:l.customizeMsgType||2,question:l.question,dedup:1,eventId:l.eventId||c.eventId,title:a(l.title)||a(c.title),content:l.content||c.content,imageUrl:l.imageUrl||c.imageUrl,url:l.url||c.url,urlForVisitor:l.urlForVisitor||c.urlForVisitor,urlForStaff:l.urlForStaff||c.urlForStaff,memo:a(l.memo)||a(c.memo),visibility:l.visibility||c.visibility,urlEnableForVisitor:l.urlEnableForVisitor||c.urlEnableForVisitor,closeURLPage:l.closeURLPage||c.closeURLPage},u&&(o.visEvt=l.visEvt)}else o.visEvt=l;d.initVisEvt=d.paramChat.visEvt}d.publish("visitorCommonEvent",o),d.postMessage(2)}),"1"!=d.queryParams.autoPop&&"1"!=d.queryParams.acceptInvite||this.subscribe("_firstSendMsg",function(e,t){"0"==d.queryParams.autoChat&&(delete d.queryParams.autoChat,d.publish("toRegisterChat",t),delete d.queryParams.autoPop,d.isAutoPop=!1),"1"==d.queryParams.acceptInvite&&(d.queryParams.acceptInvite=void 0,delete d.queryParams.acceptInvite),this.unSubscribe("_firstSendMsg")}),this.subscribe("toRegisterChat",function(e,t){if("0"!=d.queryParams.autoChat&&(d.talkId="",!d.no103)){if(d.no103=!0,view.SDKNative)return a={et:103},d.eventId&&(a.eventId=d.eventId),console.log("__registChatAction",new Date),void d.publish("__registChatAction",a);var i=i,a={et:103,windowType:view.windowType,page:d.paramChat.chatPage||i,title:d.paramChat.chatPageTitle||i,firstEnterUrl:d.paramChat.firstUrl||i,firstEnterTitle:d.paramChat.firstTitle||i,referrer:d.paramChat.referrer||i,media:d.Device.media,browserName:d.Browser.browser,browserVersion:d.Browser.version,osName:d.queryParams.osName||d.Device.OS,screenResolution:window.screen.width+"x"+window.screen.height,echatTag:d.paramChat.echatTag||i};t&&t.code&&(a.captcha=t.code),"1"==d.queryParams.acceptInvite&&(a.acceptInvite=1),d.routeId&&(a.routeId=d.routeId,a.routeEntranceTheme=d.routeEntranceTheme),d.eventId&&(a.eventId=d.eventId),"1"==d.queryParams.autoPop&&(a.isAutoPop=1,t&&t.c&&(a.visitorWords=t.c)),d.publish("visitorCommonEvent",a,function(e){!0===e.successful&&d.publish("_pushVisitorEvent")})}}),this.subscribe("removeLoading",function(t,i){d.wait874List||(e("#loading").hide(),window.resizeFunc&&window.resizeFunc(),d.hasEntryOrCode||(e("#mask").hide(),e("#verify").hide()),e(".btn-close").removeClass("hide"),i&&d.initQcode())}),this.initQcode=function(){(!0!==d.companyOff&&!d.hasLeaveMsg||d.isInRobot)&&(d.isMobile||(d.showQcode?(e(".btn-qcode").removeClass("hide"),_$("qcode_img").setAttribute("loaded",""),_$("qcode_img").removeAttribute("loaded")):d.showQcode=d.toShowQcode()))},this.getLeaveConfig=function(e,t){return(e=e||d.msg649).offlineBoxInfo||e.offlineSmallBoxInfo||e.mobileOfflineBoxInfo||e.sdkOfflineBoxInfo},this.subscribe("toLeavePage",function(i,a,n){function s(){r&&1==c.enableThirdPartyParams&&c.thirdPartyParams&&(r=function(e,t,i){for(var a="",n=e.split("#"),o=n[1]||"",s=n[0],r=-1==s.indexOf("?")?0:1,l=0,d=t.length;l<d;l++){var c=t[l].paramName;"metaData"!=c&&"metadata"!=c||(c="metaData"),"formData"!=c&&"formdata"!=c||(c="formData"),i[c]&&(a+=(0!=r?"&":"?")+c+"="+encodeURIComponent(i[c]||""),r++)}return s+a+(o?"#"+o:"")}(r,c.thirdPartyParams,d.paramChat)),e("body").html(""),view.SDK?view.__nativeAPI("jumpToUrl",r):location.href=r}d.companyOff=!0;var r,l=!1,c=d.getLeaveConfig(a),u=!1;if(d.leaveAndClose){l=!1;var f="msg"+(p=(new Date).getTime()),m={t:(g=d.checkHistoryTime(p))?(new Date).format("hh:mm"):void 0,tm:p,mt:864,f:"c",m:0,hide:!0,c:d.entryVisitorMsg,id:f};d.entryVisitorMsg&&d.sendToServer(m),d.publish("__chatStatus","leaveToService");var h=e.extend({},m);h.c=d.entryLeaveContent,d.sendToServer(h,void 0,function(){d.visitorClose=!0,h.c.trim()&&o(lanRes.leavelSuc.alt,"ok"),d.publish("sendVisitorEvent",{et:107}),setTimeout(function(){},2e3)}),d.entryVisitorMsg=null}else if(c&&1==c.enable){if(n||(l=d.showEntryAndCode(a,!1)),l||d.publish("__chatStatus","leaveToService"),d.leaveAndClose&&e("#staffName").html("<span>"+lanRes.leaveWord+"</span>"),view.hideStaffInfo&&view.hideStaffInfo(),d.entryVisitorMsg){var p=(new Date).getTime(),f="msg"+p,g=d.checkHistoryTime(p),m={t:g?(new Date).format("hh:mm"):void 0,tm:p,mt:864,f:"c",m:0,hide:!0,c:d.entryVisitorMsg,id:f};d.sendToServer(m),d.entryVisitorMsg=null}view.showURLList&&!view.SDK&&(e(".menu-more").hide(),view.hideMenus()),view.handleLeave&&view.handleLeave("leaveToService",a)}else{if(c&&2==c.enable&&c.thirdPartyUrl)return d.publish("__chatStatus","leaveToUrl"),d.publish("__leaveToUrl",c.thirdPartyUrl),r=c.thirdPartyUrl,void(view.SDKNative&&window.setVisitorInfo?setTimeout(function(){s()},200):s());if(!c||0==c.enable||c&&2==c.enable&&!c.thirdPartyUrl){u=!0,d.publish("__chatStatus","leaveDisabled"),e("#inputPlaceholder").html(lanRes.disablePlaceholder),e("#footer").addClass("leave-disabled");var v=t.createElement("div");v.className="mask-disabled",e("#footer").append(v),e(t).off(),c&&view.handleLeave&&view.handleLeave("leaveDisabled",a),setTimeout(function(){d.publish("_endConnect"),d.companyOff=!0},200),view.hideStaffInfo&&view.hideStaffInfo(),view.showURLList&&(e(".menu-more").hide(),view.hideMenus())}}e(".btn-qcode").addClass("hide"),d.publish("removeLoading"),(l||u)&&e("#mask").show(),view.hideServiceIcon&&view.hideServiceIcon(),d.postMessage("toLeaveMessage")}),this.subscribe("refreshVerify",function(t,i){e("#verify_change").removeClass("loadin"),0==i.status||1==i.status&&e("#verify_input").addClass("error"),d.no103=!1,e("#verify_img").attr("src",d.dataHost+"/chatCaptCha.jpg?captChatToken="+i.captChaToken)}),this.bookformi=0,this.getBookComfirm=function(e){if(!e||!e[0])return e||"";var t;if(!(t=1==view.windowType&&1==e[0].type||1!=view.windowType&&3==e[0].type?e[0]:e[1])||!t.configuration)return"";var i=this.bookformi++,a=t.configuration,n=a.length,o=r(a);d.needHttps&&t.backImg&&(t.backImg=t.backImg.replace(/^http:/,d.needHttps));for(var s=' <div id="inviteBook'+i+'" class="book-table '+(3==t.type?"book-table-sm":"book-table-bg")+("1"==o?" book-all-line":"")+'" >'+(t.backImg?'<div><img onerror="view.imgError&&view.imgError(this)" id="inviteBookImg'+i+'" class="book-table-img hide" src="'+t.backImg+'" onload="imgLoadResize(this,'+i+')" /></div>':"")+'<form id="inviteBookForm'+i+'" class="book-items" onsubmit="return false;"> <div class="clearfix book-items-list" style="'+t.formPos+';">',l=0;l<n;l++){var c=a[l],u=1==c.configRequired?"req":"";s+='<div class="book-half book-item '+("1"==c.configInline?"book-one-line":"")+'"><label class="book-label" style="color:'+t.labelColor+'">'+c.configDesc+"</label>"+("gender"==c.configName?'<input type="text" lb="'+c.configDesc+'" class="book-ipt '+u+'" name="'+c.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"  value="'+(2==c.configValue?lanRes.female:1==c.configValue?lanRes.male:"")+'" readonly="readonly" />':"maritalStatus"==c.configName?'<input type="text" lb="'+c.configDesc+'" class="book-ipt '+u+'" name="'+c.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"  value="'+(2==c.configValue?lanRes.married:1==c.configValue?lanRes.unmarried:"")+'" readonly="readonly" />':'<input type="text" lb="'+c.configDesc+'" class="book-ipt '+u+'" name="'+c.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"  value="'+(c.configValue||"")+'" readonly="readonly" />')+"</div>"}return s+="</div></form></div>",setTimeout(function(){var e=_$("inviteBookForm"+i);if(e){var t=e.offsetHeight+(view.px2px?view.px2px(20):20)+e.offsetTop;_$("inviteBookLi"+i).style.minHeight=t+"px"}},1e3),'<li id="inviteBookLi'+i+'" class="clearfix book-confirm-wrap">'+s+"</li>"},this.showOrderSubmit=function(e){e.jobWindowInfo&&this.toShowOrderSubmit(e),d.publish("__chatStatus","workorder")},this.showEntryAndCode=function(t,i){var a=!1,n=t.entranceInfo||t.smallEntranceInfo||t.mobileEntranceInfo||t.sdkEntranceInfo,o=n&&1==n.visitorInfoEnable&&(i?1==n.enableOnline:1==n.enableOffline);return d.leaveAndCloseConfig&&!0===d.companyOff&&(n=d.leaveAndCloseConfig,o=!0),o&&d.toShowEntry(n,t)?(e("#verify").hide(),a=!0):t.captChaToken?(e("#entry").html("").hide(),e(".verify-change").attr("id","verify_change"),e(".verify-img").attr("id","verify_img"),e(".verify-ok").attr("id","verify_ok"),e(".verify-input").attr("id","verify_input"),d.publish("removeLoading"),d.toShowCode(),e("#verify_img").attr("src",d.dataHost+"/chatCaptCha.jpg?captChatToken="+t.captChaToken),e("#verify").show(),e("#mask").show(),a=!0):o&&(d.publish("entryCallback",{success:!0,mt:670}),a=!1),a&&(!0!==d.companyOff?d.publish("__setTitle",lanRes.onlineService):d.publish("__setTitle",lanRes.leaveWord)),d.hasEntryOrCode=a,a},this.subscribe("initRobot",function(t,a){function n(){var t=d.getInput(!1);t||(e("#input_suggest").addClass("hide").html(" "),view.resetContainerBaseFoot&&view.resetContainerBaseFoot()),!t||d.lastText==t&&l==t||(d.lastText=t,d.publish("sendVisitorEvent",{et:132,content:d.lastText})),d.typingTimer=setTimeout(n,c),l=t}a.robotConfigInfo.hasRobotDefImg&&(a.robotConfigInfo.robotImg=(a.robotPCChatBox||a.robotSmallChatBox||a.robotPhoneChatBox||a.robotSdkChatBox).defaultStaffImg),d.needHttps&&a.robotConfigInfo.robotImg&&(a.robotConfigInfo.robotImg=a.robotConfigInfo.robotImg.replace(/^http:/,d.needHttps)),d.staffImg=a.robotConfigInfo.robotImg,d.staffName=d.stringEncode(a.robotExtInfo&&a.robotExtInfo.nickName)||lanRes.robot,d.robotExtInfo=a.robotExtInfo||{},d.paramChat.staffId="-1",d.paramChat.staffName=d.staffName,d.paramChat.staffPhoto=d.staffImg,d.dataObject.robotInfo={img:d.staffImg,name:d.staffName},view.initRobotInfo&&view.initRobotInfo(a),d.bindPlainTextEvent(),view.setInnerAD(a),d.robotWordsInfo=a.robotWordsInfo,e("#toHumanWords").html(a.robotWordsInfo.toHumanWords||""),e("#textInput").attr("placeholder",a.robotWordsInfo.inputBoxWords||lanRes.inputPlaceholder2);var o=d.isVip?view.SDK?a.sdkVipVisitorRobotConfig:a.webVipVisitorRobotConfig:view.SDK?a.sdkVisitorRobotConfig:a.webVisitorRobotConfig;if(e("#robotToStaff").hide(),o&&"1"==o.enableManualSwitch?(!0===d.companyOff?(e("#robotToStaffWord").html(a.robotWordsInfo.offlineButtonWords||lanRes.robotToStaff),"1"==o.enableLeaveBtnWhenStaffOffline&&(e("#robotToStaff").show(),i(d))):(e("#robotToStaffWord").html(a.robotWordsInfo.onlineButtonWords||lanRes.robotToStaff),"1"==o.enableSwitchBtnWhenStaffOnline&&(e("#robotToStaff").show(),i(d))),view.handleShowRobotToStaff&&view.handleShowRobotToStaff()):e("#robotToStaff").hide(),"1"==a.robotWordsInfo.enableFedBack){var s=a.robotWordsInfo;"string"==typeof s.solvedSubitem&&(s.solvedSubitem=JSON.parse(s.solvedSubitem)),"string"==typeof s.unsolvedSubitem&&(s.unsolvedSubitem=JSON.parse(s.unsolvedSubitem)),d.needHttps&&(s.solvedButton&&(s.solvedButton=s.solvedButton.replace(/^http:/,d.needHttps)),s.unsolvedButton&&(s.unsolvedButton=s.unsolvedButton.replace(/^http:/,d.needHttps))),s.solvedSubitem||s.unsolvedSubitem?!view.dji||s.unsolvedWords||s.solvedWords?d.robotFeedback=function(e){var t=(e=e||{}).answerItem,i="",a='<div class="feedback-tip">'+(s.fedBackWords||"")+'</div><div class="feedback-tag"><i class="feed-icon-sel"></i><span>'+lanRes.hasSelected+'</span></div><div class="feedback-btns clearfix"><div class="feedback-btn-solve '+(1==e.feedback?"feedback-btn-solve-sel":"")+(view.dji&&!s.solvedWords?" hide":"")+'" type="1">'+(s.solvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+s.solvedButton+'"/>':"")+"<span>"+(s.solvedWords||"")+'</span></div><div class="feedback-btn-unsolve '+(2==e.feedback?"feedback-btn-unsolve-sel":"")+(view.dji&&!s.unsolvedWords?" hide":"")+'" type="2">'+(s.unsolvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+s.unsolvedButton+'"/>':"")+"<span>"+(s.unsolvedWords||"")+"</span></div></div>";if(t){if(2!=e.feedback&&s.solvedSubitem&&s.solvedSubitem.length>0){i+='<div class="feedback-sub-solved"><div class="robot-tip">'+lanRes.solvedReason+'</div><ul class="feedback-sub-list '+(e.feedbackSubitem?"robot-feedback-sub-had":"")+'" did="'+t.docId+'" qid="'+t.queryId+'" rid="'+t.robotDetailId+'" searchId="'+t.searchId+'" originQuestion="'+escape(t.originQuestion)+'">';for(n=0;n<s.solvedSubitem.length;n++)i+='<li class="feedback-sub-li sub-solved-li '+(e.feedbackSubitem==s.solvedSubitem[n].content?"feedback-sub-sel1":"")+'"><span class="list-style-dot">'+(n+1)+'.</span><span class="feedback-sub-content" type="1">'+s.solvedSubitem[n].content+"</span></li>";i+="</ul></div>"}if(1!=e.feedback&&s.unsolvedSubitem&&s.unsolvedSubitem.length>0){i+='<div class="feedback-sub-unsolved"><div class="robot-tip">'+lanRes.unsolvedReason+'</div><ul class="feedback-sub-list '+(e.feedbackSubitem?"robot-feedback-sub-had":"")+'" did="'+t.docId+'" qid="'+t.queryId+'" rid="'+t.robotDetailId+'" searchId="'+t.searchId+'" originQuestion="'+escape(t.originQuestion)+'">';for(var n=0;n<s.unsolvedSubitem.length;n++)i+='<li class="feedback-sub-li sub-unsolved-li '+(e.feedbackSubitem==s.unsolvedSubitem[n].content?"feedback-sub-sel2":"")+'"><span class="list-style-dot">'+(n+1)+'.</span><span class="feedback-sub-content" type="2">'+s.unsolvedSubitem[n].content+"</span></li>";i+="</ul>"}}return a+i+"</div></div>"}:d.robotFeedback=!1:d.robotFeedback=function(e){e=e||{};return'<div class="feedback-tip">'+(s.fedBackWords||"")+'</div><div class="feedback-tag"><i class="feed-icon-sel"></i><span>'+lanRes.hasSelected+'</span></div><div class="feedback-btns clearfix"><div class="feedback-btn-solve '+(1==e.feedback?"feedback-btn-solve-sel":"")+'" type="1">'+(s.solvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+s.solvedButton+'"/>':"")+"<span>"+(s.solvedWords||"")+'</psan></div><div class="feedback-btn-unsolve '+(2==e.feedback?"feedback-btn-unsolve-sel":"")+'" type="2">'+(s.unsolvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+s.unsolvedButton+'"/>':"")+"<span>"+(s.unsolvedWords||"")+"</span></div></div></div></div>"};var r=d.getCSSRule(".feedback-btn-solve");r&&s.solvedBackColor&&(r.style.backgroundColor=s.solvedBackColor),(r=d.getCSSRule(".sub-solved-li"))&&s.solvedBackColor&&(r.style.backgroundColor=s.solvedBackColor),(r=d.getCSSRule(".feedback-btn-solve-sel"))&&s.solvedSelectColor&&(r.style.backgroundColor=s.solvedSelectColor),(r=d.getCSSRule(".feedback-sub-sel1"))&&s.solvedSelectColor&&(r.style.backgroundColor=s.solvedSelectColor),(r=d.getCSSRule(".feedback-btn-unsolve"))&&s.unsolvedBackColor&&(r.style.backgroundColor=s.unsolvedBackColor),(r=d.getCSSRule(".sub-unsolved-li"))&&s.unsolvedBackColor&&(r.style.backgroundColor=s.unsolvedBackColor),(r=d.getCSSRule(".feedback-btn-unsolve-sel"))&&s.unsolvedSelectColor&&(r.style.backgroundColor=s.unsolvedSelectColor),(r=d.getCSSRule(".feedback-sub-sel2"))&&s.unsolvedSelectColor&&(r.style.backgroundColor=s.unsolvedSelectColor)}else d.robotFeedback=!1;d.unSubscribe("_sendQuestion"),d.subscribe("_sendQuestion",function(t,i){d.sendToServer({c:i.content,m:0,f:"c",id:(new Date).getTime(),talkId:d.talkId,data:{et:130,clickType:i.clickType,docId:i.docId,originDocId:i.originDocId,content:i.content}}),e("#input_suggest").addClass("hide").html(" "),view.resetContainerBaseFoot&&view.resetContainerBaseFoot()}),d.lastText=null,d.typingTimer&&clearTimeout(d.typingTimer);var l,c=12059==d.companyId?500:1500;d.hasInputAssociation&&(d.typingTimer=setTimeout(n,c)),d.openVisitorSend(),e("#toolbar").addClass("robot"),e("body").addClass("robot"),d.publish("onceStartRobot")}),d.subscribe("_showCommonQue",function(t,i){var a=i.content;a=d.handleMsgImg(a,i);var n=i.commonQuestions&&JSON.parse(i.commonQuestions);if(n&&n.length){i.commonQuesWords?a+='<div class="common-ques-tip">'+i.commonQuesWords+'</div><ul class="common-ques-list">':a+='<ul class="common-ques-list">';for(var o=0;o<n.length;o++)a+='<li class="common-ques-li" did="'+n[o].id+'" ques="'+escape(n[o].question||n[o].content)+'"><span class="list-style-dot">'+(o+1)+'.</span><span class="link-robot-ques">'+(n[o].question||n[o].content)+"</span></li>";a+="</ul>"}i.notStore||(d.talkId=i.talkId,d.paramChat.talkId=d.talkId,d.paramChat.staffPhone="",d.paramChat.staffInfo="",d.robotTalkId=i.talkId,view.startChatRefreshAD&&view.startChatRefreshAD(),d.publish("__chatStaffInfo",{staffId:d.paramChat.staffId,staffNickName:d.staffName||"",staffHead:d.staffImg,staffInfo:d.robotExtInfo.autograph||"",recordId:(d.isInRobot?"5_":"1_")+d.talkId})),d._getMsg.call(this,e.extend(i,{tm:i.tm,mt:12001,ff:"r",answer:i.content,staffImg:i.staffImg||d.staffImg,staffName:i.staffName||d.staffName,content:a}),0,a,"r")}),d.maxRobotLength=100,e("#inputLengthTip").html(lanRes.inputLengthTip1+" "+d.maxRobotLength+" "+lanRes.inputLengthTip2),d.handleInputLength=function(){var t;view.chat.isInRobot&&function(t,i){for(var a=0,i=2*i,n=0,o=0;o<t.length;o++){if(null!=t.charAt(o).match(/[^\x00-\xff]/gi)?(a+=2,n+=1):a+=1,a>=i)return d.setInput(t.substr(0,a-n)),void e("#inputLengthTip").html(lanRes.inputLengthTip1+" 0 "+lanRes.inputLengthTip2);var s=i/2-(parseInt(a/2)+a%2);e("#inputLengthTip").html(lanRes.inputLengthTip1+" "+s+" "+lanRes.inputLengthTip2)}}(t=d.getInput(),d.maxRobotLength),(view.chat.isInRobot||view.SDK)&&view.urlList&&(t||d.getInput()?(e(".menu-more").hide(),e("#enter_btn").removeClass("hide")):(e(".menu-more").show(),e("#enter_btn").addClass("hide")))},this.subscribe("onceStartRobot",function(t,i){d.unSubscribe("onceStartRobot"),view.urlList&&(e("#menu_more_robot").show(),e("#enter_btn").addClass("hide")),e("#list_msg").on("click",".common-ques-li",function(t){d.publish("_sendQuestion",{clickType:1,docId:e(this).attr("did"),content:unescape(e(this).attr("ques"))})}),e("#robotToStaffWord").on("click",function(){e("#inputLengthTip").html(lanRes.inputLengthTip1+d.inputMaxLength+lanRes.inputLengthTip2),"disconnected"==EChatQuery.cometd.getStatus()||d.isInRobot&&d.publish("sendVisitorEvent",{et:131}),d.getInputDocBody().blur()}),e("#input_suggest").on("click",".ipt-list-li",function(t){if((!view.handleNetwok||!view.handleNetwok())&&(d.setInput(unescape(e(this).attr("ques"))),d.isInRobot)){d.publish("_sendQuestion",{clickType:2,docId:e(this).attr("did"),content:unescape(e(this).attr("ques"))});d.getInput(!0)&&view.afterSend()}}),e("#list_msg").on("click",".question-list-li",function(t){d.publish("_sendQuestion",{clickType:1,docId:e(this).attr("did"),originDocId:e(this).attr("oid"),content:unescape(e(this).attr("ques"))})}),e("#list_his").on("click",".feedback-btn-unsolve",function(t){var i=this.parentNode.parentNode,a=e(i).attr("did");if(a){view.chat.lastFeedBack=i,d.publish("sendVisitorEvent",{et:133,docId:a,queryId:e(i).attr("qid"),robotDetailId:e(i).attr("rid"),searchId:e(i).attr("searchId"),originQuestion:unescape(e(i).attr("originQuestion")),feedBack:e(this).attr("type")}),e(i).attr("did","").addClass("robot-feedback-had robot-feedback-had2"),e(this).addClass("feedback-btn-unsolve-sel");var n=e(this).parents(".msg-robot").attr("id");n&&view.scrollToBottom(n)}}).on("click",".feedback-btn-solve",function(t){var i=this.parentNode.parentNode,a=e(i).attr("did");if(a){view.chat.lastFeedBack=i,d.publish("sendVisitorEvent",{et:133,docId:a,queryId:e(i).attr("qid"),robotDetailId:e(i).attr("rid"),searchId:e(i).attr("searchId"),originQuestion:unescape(e(i).attr("originQuestion")),feedBack:e(this).attr("type")}),e(i).attr("did","").addClass("robot-feedback-had robot-feedback-had1"),e(this).addClass("feedback-btn-solve-sel");var n=e(this).parents(".msg-robot").attr("id");n&&view.scrollToBottom(n)}}).on("click",".feedback-sub-content",function(t){var i=this.parentNode.parentNode,a=e(i).attr("did");if(a){var n=e(this).attr("type");d.publish("sendVisitorEvent",{et:133,docId:a,queryId:e(i).attr("qid"),robotDetailId:e(i).attr("rid"),searchId:e(i).attr("searchId"),originQuestion:unescape(e(i).attr("originQuestion")),feedBackSubitem:this.innerText||this.textContent||this.innerHTML}),e(i).attr("did","").addClass("robot-feedback-sub-had"),e(this.parentNode).addClass("feedback-sub-sel"+n)}})}),this.subscribe("endRobot",function(t,i){d.data109=null,d.typingTimer&&clearTimeout(d.typingTimer),d.isInRobot=0,e("#toolbar").removeClass("robot"),e("body").removeClass("robot"),e("#robotToStaff").hide(),d.isMobile&&view.hideMenus(),e(".robot-staff").removeClass("robot-staff"),d.unSubscribe("_sendQuestion"),d.robotTalkId&&d.handleSessionMsg({talkId:d.robotTalkId}),d.robotTalkId=null,d.staffName="",d.staffImg=void 0,d.staffId=void 0,delete d.paramChat.staffId,delete d.paramChat.staffName,delete d.paramChat.staffPhoto,delete d.paramChat.talkId,!d.isMobile&&d.changeToIframe(),e("#textInput").attr("placeholder",lanRes.mbTextareaInput.placeholder)}),e(".leave-bar-btn").on("click",function(){d.publish("restartChat")}),e(".robot-staff-close").on("click",function(){var t=this.parentNode;e(t).addClass("hide").hide(),view.handleShowRobotToStaff&&view.handleShowRobotToStaff(),i(d,"close")}),d.unSubscribe("getCrossMessage"),d.subscribe("getCrossMessage",function(e,t){var i=t.data,a=t.source;if(i)if(d.hasSearchInSameScreen&&"robot"==i.evt)"question"==i.type&&i.content?d.publish("_sendMsg",i.content):"sendVisEvt"==i.type&&i.content&&d.publish("_sendVisEvt",i.content);else if("echatPlugin"==i.evt){if("addStaffMsg"==i.type){if(console.log("***addStaffMsg******",i),!d.talkId||640!=i.msg.mt&&647!=i.msg.mt||!d.outerChatStatus.match(/waiting|chatting/))return;var n,o,s=d.talkId,r=(d.talkType||1)+"_"+s,l=d.initHistory(s);if(!l)return;if(o=l[r].order,1==i.autoMsg&&(i.msg.autoMsg=1),i.msg.talkId=s,o.length>0&&1==i.msg.autoMsg)for(var c=0;c<o.length;c++)if(1==(n=l[r][o[c]]).autoMsg&&n.c==i.msg.content)return void(_$(i.msg.mid+"")||_$(n.mid+"")||d.showMsg(n));640==i.msg.mt&&d.publish("getMsg",i.msg),647==i.msg.mt&&d.publish("getSysMsg",i.msg)}}else if("echatjs"==i.evt)if("echatInnerFrame"==i.type&&a)try{a.postMessage({type:"echatInnerFrameCallback",companyId:d.companyId,visitorId:d.visitorId,chatVisitorId:window.chatVisitorId,encryptVID:window.encryptVID,metaData:d.queryParams.metadata||"",formData:d.queryParams.formdata||"",inChatPage:!0},i.origin)}catch(e){}else"openChat"==i.type?((d.isMobile||2==view.windowType)&&view.hideURLSite&&view.hideURLSite(),d.publish("_triggerChat",i)):"closeFramePage"==i.type?(view.hideURLSite?view.hideURLSite():view.hideRightUrl&&view.hideRightUrl(i),view.__nativeAPI&&view.__nativeAPI("closeUrlView")):"sendTextMsg"==i.type?d.publish("_sendMsg",i.content):"sendVisEvt"==i.type&&d.publish("_sendVisEvt",i.content)});var m=d.isMobile&&!d.isPcXcx?"touchend":"click";e("#chat").on(m,".robot-staff",function(){d.isInRobot&&d.publish("sendVisitorEvent",{et:131})}).on(m,".end-chat",function(){d.visitorCloseFunc()}).on(m,".to-leave-word",function(){d.outerChatStatus&&d.outerChatStatus.match(/waiting|chatting|robot/)&&(d.toLeaveWord=1,d.publish("sendVisitorEvent",{et:107,toLeaveWord:1},function(){}))}),d.subscribe("_triggerChat",function(t,i){if("disconnected"==e.cometd.getStatus()||"sdk"==e.cometd.getStatus()){if("block"==_$("satisfy").style.display){if(i&&"showMiniChat"==i.action)return;e("#satisfy").hide(),e("#mask").hide()}setTimeout(function(){console.log(i&&"showMiniChat"==i.action?{needRouter:2==view.windowType&&d.visitorClose}:1),view.chat.publish("restartChat",i&&"showMiniChat"==i.action?{needRouter:2==view.windowType&&d.visitorClose}:void 0)},15),e("#restartChat").text(lanRes.chatContinued),e(".btn-restart").removeAttr("id").removeClass("btn-restart")}else d.isMobile||"firefox"!=d.Browser.browser&&d.focusInput()}),e("#content").on("click",".msg-leave",function(){var t,i=e(this).attr("k"),a=e(this).hasClass("msg-workorder"),n=d.leaveMsgMap[i]||d.orderMsgMap[i],o=d.apiServerDomain+"/chatapi/paodm/qd?companyId="+d.companyId+"&visitorId="+n.visitorId+"&chatInfoType="+(n.chatInfoType||9)+"&talkId="+(n.newsMsgId||n.jobId)+"&tm="+n.tm+"&token="+n.signature,i=n.token||"",s=n.nonce||"",r=d.msg600.photo||"",l=(d.msg600.lan,view.SDKNative?window.locationBase:(d.needHttps||"http:")+"//"+location.host),c=d.fileUploadInfos.array,u="in"==window.lanResName?"id":window.lanResName;if(t=a?l+"/visitor/common/order.html?lan="+u+"&url="+encodeURIComponent(o)+"&token="+i+"&nonce="+s+"&uploadFileSize="+d.uploadFileSize+"&photo="+encodeURIComponent(r)+"&fileUploadInfos="+JSON.stringify(c)+"&windowType="+view.windowType:l+"/visitor/common/record.html?lan="+u+"&url="+encodeURIComponent(o),t+="&linkOpenerNative="+(view.linkOpenerNative?"1":"0"),view.handlePushURL?-1==view.handlePushURL(t)&&window.open(t,"_blank"):a?view.showURLLink&&view.showURLLink(lanRes.visitor173,t,{from:5,workorder:1}):view.showURLLink&&view.showURLLink(lanRes.leaveMsgTitle,t,{from:5}),e("#msg"+n.tm).hasClass("fold"))if(e("#msg"+n.tm).removeClass("fold"),view.SDKNative)view.__nativeAPI("updateLocalMsg",{mid:n.mid,read:1});else if(d.hasStorage){var f=window.localStorage.getItem(d.historyKey);if(f){var m=(f=JSON.parse(f))[n.talkTypeId];m&&m[n.tm+"s"]&&(m[n.tm+"s"].read=1),d.updateHistory(f)}}}),this.subscribe("startRobot",function(e,t){d.hasSearchInSameScreen=1==d.msg649.enableSearchInTheSameScreen,d.hasInputAssociation=1==d.msg649.enableInputAssociate,d.isInRobot=!0,d.talkType=5,d.publish("clearSendingMsg","robot"),d.publish("setConfig",d.msg649),d.publish("initRobot",d.msg649),d.publish("__chatStatus","robot"),view.toggleLeaveToChat&&view.toggleLeaveToChat(2),d.queryParams.autoPop&&delete d.queryParams.autoPop,d.queryParams.autoChat&&delete d.queryParams.autoChat,d.isAutoPop=!1}),this.subscribe("startLeave",function(e,t){d.companyOff=!0,d.talkId=t.talkId,d.talkType=3,d.publish("setConfig",d.msg649),d.publish("toLeavePage",d.msg649,t),d.queryParams.autoPop&&delete d.queryParams.autoPop,d.queryParams.autoChat&&delete d.queryParams.autoChat,d.isAutoPop=!1}),this.subscribe("startChat",function(e,t){d.talkType=1,d.publish("setConfig",d.msg649),setTimeout(function(){d.toInitEvaluate(d.msg649)},10),this.startChat.apply(d,arguments),d.postMessage({type:"getStartChat",msg:t})}),d.orderMsgMap={},this.subscribe("orderReply",function(e,i){i.current&&(i.jobId=i.talkId,i.talkId=d.talkId||i.tm);var a='<li class="clearfix '+(1==i.read?"":"fold")+'" talkid="'+i.talkId+'" id="msg'+i.tm+'"><div class="msg-leave msg-workorder" k="'+i.signature+'"><div class="msg-leave-title"><i class="msg-leave-i"></i><span class="msg-leave-t">'+((i.staffNickName?'<span class="color0">'+i.staffNickName+"&nbsp;</span>":lanRes.serviceStaff)+lanRes.visitor174)+'</span></div><div class="msg-leave-con" ><div class="msg-leave-content">'+d.filterEmo(d.htmlToText(i.content||""))+'</div><div class="msg-leave-dot">...</div><div class="msg-leave-link color0">'+lanRes.viewAll+"</div></div></div></li>",n=t.createElement("ul");n.innerHTML='<li class="clearfix" ><div class="color1 tc">'+d.getTimeStr(i.tm)+"</div></li>"+a;for(var o,s=this.getListMsgEl(i.talkId,i.tm,!!i.current),r=n.childNodes,l=0;o=r[l++];)1==o.nodeType&&(o=o.cloneNode(!0),s.appendChild(o));r=null,n=null,view.scrollToBottom(null,{transitionDuration:100,timeout:100}),i.current&&(i.f="s",i.c=i.content,delete i.current,d.pushHistory(i),s=null),d.orderMsgMap[i.signature]=i}),this.subscribe("continueChat",function(e,t){setTimeout(function(){d.toInitEvaluate(d.msg649)},10),this.startChat.apply(d,arguments)}),this.subscribe("goingEntry",function(e,t){var i;1==t.status?d.showEntryAndCode(t,!0):((i=t.entranceInfo||t.smallEntranceInfo||t.mobileEntranceInfo||t.sdkEntranceInfo)&&1==i.visitorInfoEnable&&1==i.enableOffline||t.captChaToken)&&d.publish("toLeavePage",d.msg649)}),this.hasBoxConfig=function(e){return e.robotConfigInfo||e.robotPCChatBox||e.offlineBoxInfo||e.mobileOfflineBoxInfo||e.sdkOfflineBoxInfo||e.sdkChatBoxInfo||e.mobileChatBoxInfo||e.chatBoxInfo||e.chatSmallBoxInfo||e.offlineSmallBoxInfo||e.jobWindowInfo},this.resetDom=function(){e("#chat").removeClass("hide"),e("#orderSubmit").hide(),e("#footer").removeClass("hide").removeClass("leave-disabled"),e("#busyTipLine").addClass("hide").hide(),e("#input_suggest").addClass("hide").html(" "),d.isMobile&&e(".menu-phone").addClass("limit-hide"),d.isMobile||e("#portrait").hide(),e("#textInput").attr("placeholder",lanRes.mbTextareaInput.placeholder),e("#leaveDisabled").hide(),view.resetContentHeight&&view.resetContentHeight(),e("#container").removeClass("hide"),e("html").removeClass("page-leave"),e("html").removeClass("entry2"),d.hasEntryOrCode&&d.publish("entryCallback",{success:!0}),e("#inputPlaceholder").html(e("#inputPlaceholder").attr("placeholder")||lanRes[e("#inputPlaceholder").attr("langs")]),e("#inputLengthTip").hide(),d.getInput(!1)?e("#inputPlaceholder").addClass("hide"):e("#inputPlaceholder").removeClass("hide"),e("#router").hide()},this.subscribe("waitingChat",function(t,i){if(d.eventId=i.eventId,d.isInRobot&&2!=i.chatStatus&&(d.workOrder2RobotTalkId=d.robotTalkId,d.updateHistoryComplete(d.talkType+"_"+d.robotTalkId),d.publish("endRobot")),1!=i.canChatNow&&d.publish("setConfig",i),!i.unreadMsgNumber){var a=d.getLeaveConfig(i);if(2==i.status&&2!=i.chatStatus&&a&&(2==a.enable&&a.thirdPartyUrl||"0"==a.enable)&&(d.publish("toLeavePage",i),"0"==a.enable||"2"==a.enable))return}if(!1!==d.chatting&&d.talkId&&(d.lastTalkIdForTemp=d.talkId),i.routeId&&(d.routeId=i.routeId),d.chatting=-1,d.isInWorkOrder=!1,d.leaveAndClose=!1,d.sendMsgNum=0,view.toggleEnded&&view.toggleEnded("init"),d.resetDom(),d.sendMsgNum=0,d.hasBoxConfig(i)&&(d.msg649=e.extend(d.msg649||{},i),view.SDK&&e.store("ECHAT_"+d.companyId+"_649",JSON.stringify(e.extend(JSON.parse(e.store("ECHAT_"+d.companyId+"_649")||"{}"),i)))),4===Number(i.status)&&0===i.canChatNow?d.isInWorkOrder=!0:(d.isInWorkOrder=!1,delete d.workOrder2RobotTalkId),d.isInWorkOrder&&1===parseInt(d.queryParams.template)&&(e("body").css({"min-width":"auto"}),e("#header").attr("style","display:none !important"),e("#leftCustom").hide(),e("#rightAD").hide(),e("#rightCustom").hide(),e("#container_leave").css({right:0}),e(".foot-powerby").hide(),e("#container").addClass("order-initPosition")),i.unreadMsgNumber&&parseInt(i.unreadMsgNumber))return d.publish("setConfig",i),d.companyOff=2==i.status,d.hasLeaveMsg=!0,d.publish("removeLoading"),view.toggleLeaveToChat&&view.toggleLeaveToChat(1),void(view.initChatscroll&&view.initChatscroll());if(d.hasLeaveMsg=!1,view.toggleLeaveToChat&&view.toggleLeaveToChat(0),d.companyOff=2==i.status,d.hasChatInOtherPage=!1,e.store("ECHAT_"+d.companyId+"_"+window.chatVisitorId+"_chatStatus",i.chatStatus),2==i.chatStatus?d.hasChatInOtherPage=!0:1!=i.canChatNow&&d.publish("goingEntry",i),d.isInWorkOrder&&d.showOrderSubmit(i),d.publish("__staffStatus",i.status),ECHATObjKeyMap.cometdId.waitForRouterSelect&&d.publish("routerSelect"),ECHATObjKeyMap.cometdId.waitForRouterSelect=!1,d.isInRobot&&(i.robotPCChatBox||i.robotSmallChatBox||i.robotPhoneChatBox||i.robotSdkChatBox)||!d.isInRobot&&(i.chatBoxInfo||i.chatSmallBoxInfo||i.mobileChatBoxInfo||i.sdkChatBoxInfo)){var n=i.entranceInfo||i.smallEntranceInfo||i.mobileEntranceInfo||i.sdkEntranceInfo;n&&2==i.status&&1==n.visitorInfoEnable&&1==n.enableOffline&&"0"==n.offlineStartType||view.setInnerAD(i)}!0!==d.companyOff&&"0"==d.queryParams.autoChat&&!0!==d.chatting?(e(".menu-capture").addClass("hide"),e(".menu-file").addClass("hide")):!0===d.companyOff&&(e(".menu-capture").removeClass("hide"),e(".menu-file").removeClass("hide")),d.openVisitorSend(),d.publish("firstInitSound"),1==i.notThroughStatus&&d.publish("removeLoading")}),this.subscribe("firstInitSound",function(){d.unSubscribe("firstInitSound"),d.isMobile?window.audioInstance||(window.audioInstance=_$s("audio")[0]):window.ltIE10||window.audioInstance&&view.SDKNative||d.addJS("/visitor/common/audiojs/audiojs/audio.min.js",function(){audiojs.events.ready(function(){window.audioInstance=audiojs.create(_$("msgAudio"))})}),d.unSubscribe("_newMsg"),d.subscribe("_newMsg",function(){if(console.log(arguments),!d.disableSoundTip&&window.audioInstance){var e=window.audioInstance;try{e.play.apply(e)}catch(e){}}})}),this.subscribe("_addSendMsgNum",function(e,t){d.sendMsgNum++,d.allowEvaluateBaseWords<=d.sendMsgNum&&d.satisfyEnable&&d.toggleEvaluateMenu(4);var i=function(e){if(e)return 864==e.mt||105==e.et?{msgType:"text",textContent:(e=e.content||e.c||"")&&(e=e.replace(/<img [^>]+>/g,"[face]"))}:866==e.mt?{msgType:"file",fileName:e.fileName,fileUrl:e.fileUrl,fileType:e.fileType,fileSize:e.fileSize}:865==e.mt?{msgType:"image",smallImg:e.smallImg,bigImg:e.bigImg,sourceImg:e.sourceImg}:959==e.mt?{msgType:"formData",formName:e.template.name,formId:e.template.id}:void 0}(t);i&&d.postMessage({type:"visitorSendEvt",msg:i})});var h={};d.handleNewMsgMid=function(t,i,a,n){if(t&&!h[t])return h[t]=1,d.lasMid=d.lasMid||e.store("ECHAT_"+d.companyId+"_"+d.visitorId+"_mid")||0,d.lasMid<t?(i&&a&&(i.mid=t,!1!==n.isForward&&view.SDKNative||(n&&n.data&&680==n.data.mt&&((i=e.extend({},i)).c="[URL]"+n.data.pushUrlDetail.urlName+"["+n.data.pushUrlDetail.url+"]"),d.publish("_newMsg",i),"sys"==i.f?d.publish("__newSysMsg",i,n):d.publish("__newMsg",i,n))),e.store("ECHAT_"+d.companyId+"_"+d.visitorId+"_mid",t),(!1===view.showChangeTitle||view.miniShow||window.ltIE10)&&(e.store("ECHAT_"+d.companyId+"_"+window.chatVisitorId+"_mid_read",t),1!=view.windowType&&3!=view.windowType||!1!==view.showChangeTitle||e.store("ECHAT_"+d.companyId+"_"+window.chatVisitorId+"_mid_read_click",t)),a):void 0},d.getMsgId=function(e){return e.id||e.bridgeMsgId||e.fileIdentity||e.mid||"msg"+e.tm},d._getMsg=function(t,i,a,n,o){function s(e,o,s){s&&(e.c=""),s||!e.c&&!o||(e.c=o||e.c,d.showMsg(e)),delete e.id,delete e.hasResend,t.notStore||(1==i?e.tmf=l:2==i&&(e.fileIdentity=t.fileIdentity,e.fileName=t.fileName,e.bigImg=t.bigImg,e.smallImg=t.smallImg,e.sourceImg=t.sourceImg,e.c="img-temp"+l,e.sourceWidth=t.sourceWidth,e.sourceHeight=t.sourceHeight,e.tmf=l),e.autoMsg=t.autoMsg,"x"==n&&5!=e.m?e.c=t.content:"r"==n&&(e.c=t.content),(a||t)&&!d.isMobile&&view.setDocumentTitle&&view.setDocumentTitle(n),"c"!=n?(e.answer=t.answer||void 0,d.handleNewMsgMid(t.mid,e,!0,{mt:t.mt,mid:t.mid,__filterOrigin:t.__filterOrigin||a,data:t})):d.lasMid<e.mid&&(d.lasMid=e.mid),e.c&&d.pushHistory(e))}t.tm||(t.tm=(new Date).getTime());var r=new Date(t.tm?t.tm-0:void 0),l=t.id||t.bridgeMsgId||t.fileIdentity||t.mid||"msg"+t.tm,c=d.checkHistoryTime(t.tm),u={t:t.t||(c?r.format("hh:mm"):void 0),tm:t.tm,mt:a&&a.mt||t.mt,f:n||"s",m:i,c:a,mid:t.mid,hasResend:t.bridgeMsgId&&2==t.sendStatus,notEnd:t.notEnd,id:l};10==i&&(u.template=o,u.formUrl=t.formUrl,u.visitorId=t.visitorId,u.formInfo=t.formInfo,u.sendId=t.sendId),u.hasResend&&(d.errorList[l]=t),u.talkId=t.talkId||d.talkId,t.staffImg&&(u.staffImg=t.staffImg),(t.staffName||t.chatStaffNickName)&&(u.staffName=t.chatStaffNickName||t.staffName||t.staffNickName);var f=t.chatStaffId||t.staffId;f&&d.staffMap[f]&&(u=e.extend(u,d.staffMap[f])),"f"!=n&&"r"!=t.ff||(u.ff="r"),d.filterMsg>=2&&!t.notStore&&"c"!=u.f&&0==u.m&&u.c&&!t._hasFilterMsg?d.filterAndShowMsg(u,s):s(u)},this.filterAndShowMsg=function(e,t){if(e._hasFilterMsg)return t(e,e.c);var i=this;e.id||(console.log("error :send msg has no id"),e.id=(new Date).getTime()+""),this.processMsg.receiveMsgMap[e.id]=function(a){t(e,a,!a),i.processMsg.processNum--},this.processMsg.processNum++,this.publish("__receiveFilter",{msgId:e.id+"",receiveMsg:e.c})},this.escapeHtml=function(e){return"string"!=typeof e?e:e&&e.replace(/"/g,"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},this.handleMsgImg=function(e,t,i,a){var n=/\bsrc\b\s*=\s*[\'\"]?([^\'\"]*)[\'\"]?/i;return t=t||{},i=i||"",e=e&&e.replace(/<img\b.*?(?:\>|\/>)/gi,function(e){var o=a||n.exec(e);if(!o)return e;var s={smallImg:o=a||o[1],bigImg:o,sourceImg:o,fileName:lanRes.visitor175};return view.showMsgImg&&view.showMsgImg(s,i)||'<img onerror="view.imgError&&view.imgError(this)"'+(t.notEnd?"":'onload="javascript:view.scrollToBottom()"')+' id="img'+(s.tm||(new Date).getTime())+'" attname="'+s.fileName+'" bigimg="'+s.bigImg+'" src="'+s.smallImg+'" source="'+(s.sourceImg||"")+'" sw="'+(t.sourceWidth||"")+'" sh="'+(t.sourceHeight||"")+'" class="msg-img '+i+'"/>'})},this.handleMsgVideo=function(e){var t=/\bsrc\b\s*=\s*[\'\"]?([^\'\"]*)[\'\"]?/i;return e=e&&e.replace(/<video\b.*?(?:\>|\/>)/gi,function(e){var i=t.exec(e),a="";return i.length>1&&(a=i[1]),'<div class="msg-media msg-video msg-videotag bgwhite" videourl='+a+'> <div class="msg-video-angle"></div></div>'})};this.getVisEvtHtml=function(e){if(e.urlForVisitor){e.urlForVisitor=e.urlForVisitor.replace(/\s/g,"");var t=e.urlForVisitor.match(/^http\(['"]?([^'",]+)['"]?(\,['"]?(blank|inner)['"]?)?\)/i)||e.urlForVisitor.match(/^xcx\(['"]?([^'",]+)['"]?(\,['"]?(navigateTo|redirectTo|switchTab)['"]?)?\)/i);t?(e.url=t[1],e.openType=t[3]):e.url=""}else if(0==e.urlEnableForVisitor&&(e.url=void 0,delete e.url),e.url){var i=e.url.replace(/\s/g,"").match(/^apiUrl\(['"]?(\d+)['"]?(\,['"]?(reload|hash)['"]?)?\)/);i?e.toCrmUrlId=i[1]:(e.url.match(/(^http[s]?:)|(^file:)/i)||(e.url=""),e.toCrmUrlId=!1)}var a="";e.imageUrl&&(e.imageUrl=e.imageUrl.replace(/["']/,""),a=e.imageUrl?'<img onerror="view.imgError&&view.imgError(this)" class="custom-event-img" src="'+e.imageUrl+'"/>':"",e.url&&!e.toCrmUrlId||(a=this.handleMsgImg(a,e,"custom-event-img",e.imageUrl)));return function(e,t){var i=t?" border0":"";return e?'<div class="custom-event'+i+'"><div class="custom-event-wrap">{{imageUrl}}<div class="custom-event-content"><div class="custom-event-title" style="height:auto;margin-bottom:0;" title="{{title1}}">{{title}}</div><div class="custom-event-detail">{{content}}</div></div></div>{{memo}}</div>':'<a class="custom-event'+i+'" {{linkset}}><div class="custom-event-wrap">{{imageUrl}}<div class="custom-event-content"><div class="custom-event-title" style="height:auto;margin-bottom:0;" title="{{title1}}">{{title}}</div><div class="custom-event-detail">{{content}}</div></div></div>{{memo}}</a>'}(!e.url||e.toCrmUrlId,3==e.mst).replace(/\{\{linkset\}\}/,!e.url||e.toCrmUrlId?"":' href="'+e.url+("inner"==e.openType?'" target="inner" title="'+(e.title||lanRes.interactWnd)+'" ':"navigateTo"==e.openType||"redirectTo"==e.openType||"switchTab"==e.openType?'" target="'+e.openType+'" ':'" target="_blank" ')).replace(/\{\{title1\}\}/,d.escapeHtml(e.title)||"").replace(/\{\{title\}\}/,e.title||"").replace(/\{\{imageUrl\}\}/,a).replace(/\{\{content\}\}/,e.content||"").replace(/\{\{memo\}\}/,e.memo?'<div class="custom-event-memo">'+e.memo+"</div>":"")},this.subscribe("receiveVisEvt",function(e,t,i){if(!t.notStore&&t.talkId&&(d.talkId=t.talkId),2!=t.visibility){if(t.notStore&&t.c)return d._getMsg(t,5,t.c,t.f);d.isInRobot&&(t.ff="r");var a=d.getVisEvtHtml(t);2==t.customizeMsgType||3==t.mst?d._getMsg(t,5,'<li class="clearfix custom-event-li" id="msg'+t.tm+'">'+a+"</li>","x"):t.mst&&1!=t.mst?2==t.mst&&d._getMsg(t,5,a,i?"r":"s"):(d._getMsg(t,5,a,"c"),!t.notEnd&&d.publish("__visitorSendMsg","["+lanRes.imageAndHtml+"]"+(t.title||"")),!t.notEnd&&d.publish("__visitorStartSendMsg","["+lanRes.imageAndHtml+"]"+(t.title||"")),t.notStore||t.notEnd||"1"!=t.closeURLPage||(view.hideURLSite&&view.hideURLSite(),view.hideMenus&&view.hideMenus()),d.publish("_addSendMsgNum",t))}}),this.subscribe("receiveURL",function(e,t){var i=t.pushUrlDetail.url,a="";if(view.chat.needHttps&&i.match(/^http:/i)&&(a=" push-blank"),view.pushURLParam){var n=i.split("#");i=n[0]+(n[1]?"#"+n[1]:"")}var o='<a class="push-url clearfix'+a+'" target="info_frame3" href="'+i+'"><div class="push-icon echat bg1"></div><div class="push-content"><div class="push-name">'+d.stringEncode(t.pushUrlDetail.urlName)+' </div><div class="push-url-link">'+t.pushUrlDetail.url+"</div></div></a>";d._getMsg.call(this,t,6,o,"s"),t.notStore||t.notEnd||1==d.queryParams.echatIframeDisable||-1!=i.indexOf("echatIframeDisable=1")||view.handlePushURL&&view.handlePushURL(i,void 0,d.stringEncode(t.pushUrlDetail.urlName))}),this.subscribe("receiveForm",function(e,t){if(t.template){location.origin.match(/^http(s)?/)&&(t.formUrl=t.formUrl.replace(/^http(s)?:\/\/(.*?)\//,location.origin+"/"));var i=view.chat.getCSSRule(".bg0"),a=(view.chat.getCSSRule(".color0"),t.template),n=a.detailList||[],o=t.formUrl+"&visitorId="+t.visitorId+"&talkId="+t.talkId+"&sendId="+t.sendId+"&companyId="+view.chat.companyId+"&isVisitor=1&bgColor="+encodeURIComponent(i.style.backgroundColor||"")+"&dataHost="+encodeURIComponent(d.dataHost)+"&apiServerDomain="+encodeURIComponent(d.apiServerDomain),s=n.slice().splice(0,4),r='<li class="clearfix" style="padding: 5px 0;" id="msg'+t.tm+'"><a title="'+a.name+'" class="push-url clearfix form-link-box" target="'+(1==Number(view.windowType)?"info_frame3":"inner")+'" href="'+encodeURI(o)+'"><div style="text-align: center;font-size: 13px;font-weight: bold;padding: 0 0 10px;border-bottom: 1px solid #f3f3f3;color: #000;">'+a.name+'</div><ul style="line-height: 18px;padding: 5px 10px;color: #999;">'+function(){var e="";for(var t in s)e+="<li>"+s[t].label+"</li>";return e}()+'</ul><div style="text-align: center;padding: 5px;margin: 0 10px;border-radius: 15px;" class="bg0"><span style="">点击填写</span></div></a></li>';if(1==a.openType&&(!t.fromHistory||!1===t.isForward))switch(Number(view.windowType)){case 1:view.handlePushURL(encodeURI(o));break;default:view.showURLLink&&view.showURLLink(a.name,encodeURI(o))}delete t.template.openType,t.content=a.name,d._getMsg.call(this,t,10,r,"x",t.template)}}),this.subscribe("submitForm",function(e,t){if(t.template){location.origin.match(/^http(s)?/)&&(t.formUrl=t.formUrl.replace(/^http(s)?:\/\/(.*?)\//,location.origin+"/"));var i=view.chat.getCSSRule(".bg0"),a=t.template,n=t.formUrl+"&visitorId="+t.visitorId+"&talkId="+t.talkId+"&formInfoId="+t.formInfo.id+"&companyId="+view.chat.companyId+"&isVisitor=1&bgColor="+encodeURIComponent(i.style.backgroundColor||"")+"&dataHost="+encodeURIComponent(d.dataHost)+"&apiServerDomain="+encodeURIComponent(d.apiServerDomain)+"&showResult=1&tm="+(new Date).getTime(),o='<li class="clearfix" style="padding: 5px 0;" id="msg'+t.tm+'"><a target="'+(1==Number(view.windowType)?"info_frame3":"inner")+'" href="'+encodeURI(n)+'" href="" style="width: 220px;margin: 0 auto;padding: 10px;background-color: #fff;border-radius: 6px;font-weight: bold;display:block;text-decoration:none;color:#000;"><span style="background-image: url(/visitor/common/img/success.png);width: 20px;display: inline-block;height: 20px;background-size: 100%;background-repeat: no-repeat;vertical-align: middle;margin-right: 5px;"></span><span>'+a.commitMsg+'</span><span style="float: right;color: #ddd;">></span></a></li>';t.content=a.name,d._getMsg.call(this,t,10,o,"x",a),d.publish("_addSendMsgNum",t)}}),this.subscribe("getMsgImg",function(t,i,a){d.needHttps&&(d.qiniuDomain&&d.qiniuHttpsDomain&&(i.bigImg&&(i.bigImg=i.bigImg.replace(d.qiniuDomain,d.qiniuHttpsDomain)),i.smallImg&&(i.smallImg=i.smallImg.replace(d.qiniuDomain,d.qiniuHttpsDomain)),i.sourceImg&&(i.sourceImg=i.sourceImg.replace(d.qiniuDomain,d.qiniuHttpsDomain))),i.bigImg&&(i.bigImg=i.bigImg.replace(/^http:/,d.needHttps)),i.smallImg&&(i.smallImg=i.smallImg.replace(/^http:/,d.needHttps)),i.sourceImg&&(i.sourceImg=i.sourceImg.replace(/^http:/,d.needHttps))),i.fileName&&"temp.png"!=i.fileName&&"image.png"!=i.fileName||(i.fileName="Echat"+(new Date).format("yyyyMMddhhmmss")+".png"),i.sourceImg=i.sourceImg||i.bigImg;var n=view.showMsgImg&&view.showMsgImg(i)||"<img "+(i.notEnd?"":'onload="javascript:view.scrollToBottom()"')+' id="img'+(i.fileIdentity||i.tm||(new Date).getTime())+'" attname="'+i.fileName+'" bigimg="'+(i.bigImg||i.sourceImg)+'" src="'+i.smallImg+'" source="'+(i.sourceImg||"")+'" sw="'+(i.sourceWidth||"")+'" sh="'+(i.sourceHeight||"")+'" class="msg-img"/>';i.fileIdentity&&_$(i.clientFileId||i.fileIdentity)&&(d.addSendFile(),d.publish("__visitorSendMsg","["+lanRes.image+"]")),d.sendingFileToken&&d.sendingFileToken.end&&d.sendingFileToken.token==i.fileIdentity&&(d.sendingFileToken="",d.publish("_toggleEnableFile",!0)),i.id=i.clientFileId||i.identityKey||i.fileIdentity,d._getMsg.call(this,i,2,n,865==i.mt?"c":a?"r":"s"),setTimeout(function(){e("#"+i.id).attr("id",i.mid)}),view.initImgPlay&&view.initImgPlay(),d.isInRobot||865!=i.mt&&"local"!=i.mt||d.publish("_addSendMsgNum",i)}),this.subscribe("getMsgFile",function(t,i,a){d.needHttps&&i.fileUrl&&(d.qiniuDomain&&d.qiniuHttpsDomain&&(i.fileUrl=i.fileUrl.replace(d.qiniuDomain,d.qiniuHttpsDomain)),i.fileUrl=i.fileUrl.replace(/^http:/,d.needHttps)),!_$("downFrame")&&_$("downFileFrame")&&(_$("downFileFrame").innerHTML='<iframe id="downFile" name="downFile" style="display:none;"></iframe>');var n,o,s,r="downFile",l=i.fileUrl;d.isIOS&&(r="_blank"),(n=view.SDKNative?view.getMsgFile(i):i.c?i.c:"")||(o=i.fileUrl&&i.fileUrl.indexOf("?")>0?"&":"?",s=i.fileUrl+o+"attname="+encodeURIComponent(i.fileName),n=view.SDK||2!=i.fileType||window.ltIE10?'<div class="file-info"><div class="file-name">'+i.fileName+'</div><div class="file-size">'+(parseInt(i.fileSize/1024)+1)+'KB</div></div><div class="file-icon">&nbsp;</div><a class="file-link file-link-a color0" href="'+s+'" target="'+r+'">'+lanRes.download+"</a>":d.isMobile||view.hasNative&&window.__playVideo?'<div class="file-video" identity="'+i.fileIdentity+'" onclick="__playVideo(\''+l+"','"+(i.videoThumbUrl||"")+"','"+s+"','"+(i.fileName||"")+'\')" style="'+(i.videoThumbUrl?"background:url("+i.videoThumbUrl+") no-repeat;background-size:100%;":"")+'"><div class="icon_video"></div><div class="video_logo">VIDEO</div></di>':'<a class="file-video" target="_blank" href="/visitor/pc/video.html?videoUrl='+encodeURIComponent(s)+'" style="'+(i.videoThumbUrl?"background:url("+i.videoThumbUrl+") no-repeat;background-size:100%;":"")+'"><div class="icon_video"></div><div class="video_logo">VIDEO</div></a>');866==i.mt&&(i.fileIdentity||i.identityKey)&&(_$(i.clientFileId)||_$(i.fileIdentity||i.identityKey))&&(d.addSendFile(),d.publish("__visitorSendMsg","["+(2==i.fileType?lanRes.video:lanRes.fileHtml)+"]")),d.sendingFileToken&&d.sendingFileToken.end&&d.sendingFileToken==i.fileIdentity&&(d.sendingFileToken="",d.publish("_toggleEnableFile",!0)),i.id=i.clientFileId||i.identityKey||i.fileIdentity,d._getMsg.call(this,i,3==i.fileType||4==i.fileType?i.fileType:1,n,866==i.mt||"local"==i.mt?"c":a?"r":"s"),setTimeout(function(){e("#"+i.id).attr("id",i.mid)}),d.isInRobot||866!=i.mt&&"local"!=i.mt||d.publish("_addSendMsgNum",i)}),d.subscribe("_toggleEnableFile",function(i,a){if(!d.hasFormData){var n;(n=_$("file_up").contentDocument)||(n=t.frames.file_up.document);var o=n.getElementById("uploadInput");a?(e(".menu-file").removeClass("menu-file-sending").attr("title",lanRes.selectFile),o.setAttribute("disabled",""),o.disabled=!1,o.removeAttribute("disabled"),o.title=lanRes.selectFile,o.setAttribute("title",lanRes.selectFile)):(e(".menu-file").addClass("menu-file-sending").attr("title",d.sendingTitle),o.disabled="disabled",o.setAttribute("disabled","disabled"),o.title=d.sendingTitle,o.setAttribute("title",d.sendingTitle))}}),this.subscribe("getMsg",function(t,i){var a=(i.translation||i.content)+"";if(i.relateId){this.changeStorgeBackMsg(i.relateId);if(_$(i.relateId+"")){e("#"+i.relateId).html("");var n='<div style="padding: 10px 0 20px;text-align: center;"><span style="display: inline-block;padding: 8px 10px;background-color: #bfbfbf;border-radius: 5px;color: #FFF;">'+lanRes.backMsgTip+"</span></div>";e("#"+i.relateId).html(n)}}a&&"undefined"!==a&&(a=this.handleMsgImg(a,i),view.SDKNative&&(a=this.handleMsgVideo(a)),a=a.replace(/&nbsp;([^&\s])/g," $1"),i.staffImg||i.notStore||(i.staffId=d.staffId),d._getMsg.call(this,i,0,a),1!=i.outerMsg&&d.postMessage({type:"staffSendEvt",msg:i.content||i.c}))}),d.robotUnknowTime=0,this.subscribe("getMsgRobot",function(t,a){if("r"==a.f&&a.c)return d._getMsg.call(this,{talkId:a.talkId,tm:a.tm,mt:12001,ff:"r",staffImg:a.staffImg,staffName:a.staffName,content:a.c,notEnd:!0,notStore:!0},0,a.c,"r");var n,o,s,r,l,c,u=a.knowledgeAnswerList||[],f="",m='<ul class="question-list">',h='<div class="ipt-list">';if(a.nonTextMsg)10011==(f=a.nonTextMsg).mt?d.publish("receiveVisEvt",f,!0):641==f.mt?d.publish("getMsgImg",f,!0):642==f.mt&&d.publish("getMsgFile",f,!0);else if(4==a.type){if(a.notStore||a.fromDB||a.history)return;r=(s=a.segWords||[]).length>0;for(var p,g=!1,v=0,b=0;b<u.length;b++){if(n=u[b],o=n.question,g=!1,o==d.lastText&&r){b++,v=1,h='<div class="ipt-list"><a class="ipt-list-li" did="'+n.docId+'" ques="'+escape(n.question)+'"><b class="words-seg">'+o+"</b></a>";break}if(r){0;for(I=0;I<s.length;I++)p=s[I],p=d.escapeRegExp(p),o=o.replace(new RegExp(p,"igm"),function(e,t){g=!0;var i=arguments.length,a=arguments[i-2];if(!(a>0))return l='<b class="words-seg">'+e+"</b>";var n=arguments[i-1].substring(0,a),o=arguments[i-1].substring(a);if(p.match(/^s|sp|spa|span$/)&&n.match(/<$/))return e;if(p.match(/^n|an|pan|span$/)){var s="</span>".replace(p,",").split(",");if(n.match(new RegExp(s[0])&&o.match(s[1])))return e}return/(\<span[^>]*>([^<]+(?!\<\/span\>))?$)|(\<[a-zA-Z]+[^>]*$)/gi.test(n)?e:l='<b class="words-seg">'+e+"</b>"})}!g&&r||(v++,h+='<a class="ipt-list-li" did="'+n.docId+'" ques="'+escape(n.question)+'">'+o+"</a>")}v>0?e("#input_suggest").html(h+"</ul>").removeClass("hide"):(e("#input_suggest").addClass("hide").html(" "),view.resetContainerBaseFoot&&view.resetContainerBaseFoot())}else if(3==a.type)a.f,a.tip=a.tips,204==a.result||205==a.result?(d.showInfoTip(a,void 0,void 0,void 0,a.talkId),a.notStore||(d.robotToHumanKey=a.robotToHumanKey,d.publish("toSetID"),e("#input_suggest").addClass("hide").html(" "),view.resetContainerBaseFoot&&view.resetContainerBaseFoot(),d.handleNewMsgMid(a.mid,{c:a.tips,f:"sys",m:0},!0,a)),delete d.paramChat.staffId,delete d.paramChat.staffName,delete d.paramChat.staffPhoto,delete d.paramChat.talkId):206==a.result||202==a.result?console.log(206==a.result?"禁用留言":"禁用转人工"):207==a.result&&(d.showInfoTip(a,void 0,void 0,void 0,a.talkId),a.notStore||(1===a.companyStatus?e("#robotToStaffWord").html(d.msg649.robotWordsInfo.onlineButtonWords||lanRes.robotToStaff):e("#robotToStaffWord").html(d.msg649.robotWordsInfo.offlineButtonWords||lanRes.robotToStaff),e("#robotToStaff").show(),i(d),view.showRobotToStaff&&view.showRobotToStaff(a),view.handleShowRobotToStaff&&view.handleShowRobotToStaff(),d.handleNewMsgMid(a.mid,{c:a.tips,f:"sys",m:0},!0,a)));else if(5==a.type){(f=(f=a.tips||"").replace(/&nbsp;([^&\s])/g," $1"))&&d._getMsg.call(this,e.extend(a,{ff:"r",staffImg:a.staffImg||d.staffImg,staffName:a.staffName||d.staffName,content:'<div class="msg-item-robot">'+f+"</div>",notEnd:"r"==a.f,notStore:"r"==a.f,talkId:a.talkId}),0,'<div class="msg-item-robot">'+f+"</div>","r");var y,w=e("#q"+a.robotDetailId);a.feedback&&e(w).attr("did","").attr("qid","").addClass("robot-feedback-had").addClass("robot-feedback-had"+a.feedback).attr("feedback",a.feedback),2==a.feedback&&e(".feedback-btn-unsolve",w.results[0]).addClass("feedback-btn-unsolve-sel"),1==a.feedback&&e(".feedback-btn-solve",w.results[0]).addClass("feedback-btn-solve-sel"),a.feedbackSubitem&&(2==(y=e(w).attr("feedback"))?(e(".feedback-sub-solved",w.results[0]).remove(),console.log(e(".feedback-sub-li",w.results[0])),e(".feedback-sub-li",w.results[0]).each(function(){e(".feedback-sub-content",this).text()==a.feedbackSubitem&&(e(this).addClass("feedback-sub-sel2"),e(".feedback-sub-list",w.results[0]).addClass("robot-feedback-sub-had"))})):1==y&&(e(".feedback-sub-unsolved",w.results[0]).remove(),e(".feedback-sub-li",w.results[0]).each(function(){e(".feedback-sub-content",this).text()==a.feedbackSubitem&&(e(this).addClass("feedback-sub-sel1"),e(".feedback-sub-list",w.results[0]).addClass("robot-feedback-sub-had"))})),setTimeout(function(){view.scrollUpdate&&view.scrollUpdate()},100))}else if(6==a.type)(f=(f=a.tips||"").replace(/&nbsp;([^&\s])/g," $1"))&&d._getMsg.call(this,e.extend(a,{ff:"r",staffImg:a.staffImg||d.staffImg,staffName:a.staffName||d.staffName,content:'<div class="msg-item-robot">'+f+"</div>"}),0,'<div class="msg-item-robot">'+f+"</div>","r");else if(7==a.type)f=a.tips||a.content||"",d.showInfoTip(f),a.notStore&&d.handleNewMsgMid(a.mid,{c:f,f:"sys",m:0},!0,a);else if(1==a.type||2==a.type){if((n=u[0])?1==n.answerType&&n.suggestions.length>0?(f+=n.answer||"",c=n.suggestions,m+='<div class="robot-tip">'+(a.tips||"")+"</div>"):1==n.answerType?f+=a.tips||"":2==n.answerType?(f+='<div class="robot-tip">'+(a.tips||"")+"</div>",f+=n.answer||"",c=n.relateKnowledges,m+='<div class="robot-tip margin-top10">'+(a.tipsExt||"")+"</div>"):3==n.answerType?(c=n.suggestions,m+='<div class="robot-tip">'+(a.tips||"")+"</div>"):4==n.answerType?f+=n.answer||"":5==n.answerType?(f+=n.answer||"",c=n.relateKnowledges,m+='<div class="robot-tip">'+(a.tips||"")+"</div>"):6==n.answerType&&(f+=n.answer||"",c=n.relateKnowledges,m+='<div class="robot-tip margin-top10">'+(a.tips||"")+"</div>"):f+=a.tips||"",c&&c.length){for(var I=0;I<c.length;I++)m+='<li class="question-list-li" oid="'+n.docId+'" did="'+c[I].docId+'" ques="'+escape(c[I].question)+'"><span class="list-style-dot">'+(I+1)+'. </span><span class="color-link">'+c[I].question+"</span></li>";m+="</ul>"}else m="";var T,k="";1==n.feedback&&d.robotFeedback&&(!n.searchId&&(n.searchId=""),!n.originQuestion&&(n.originQuestion=""),T=a.relateId&&d.robotFeedbackTemp&&d.robotFeedbackTemp[a.relateId]||{},a.feedback=a.feedback||T.feedbackResult,k='<div id="q'+n.robotDetailId+'" class="robot-feedback'+(a.feedback?" robot-feedback-had robot-feedback-had"+a.feedback+'"':'" did="'+n.docId+'" qid="'+n.queryId+'" rid="'+n.robotDetailId+'" searchId="'+n.searchId+'" originQuestion="'+escape(n.originQuestion)+'"')+">"+d.robotFeedback({feedback:a.feedback,feedbackSubitem:T.feedbackSubitem,answerItem:n})),((f=(f=d.handleMsgImg(f,a)).replace(/&nbsp;([^&\s])/g," $1"))||m)&&d._getMsg.call(this,e.extend(a,{ff:"r",staffImg:a.staffImg||d.staffImg,staffName:a.staffName||d.staffName,answer:f,content:'<div class="msg-item-robot">'+f+m+"</div>"}),0,'<div class="msg-item-robot">'+f+m+"</div>"+k,"r")}}),this.subscribe("getMsgMine",function(e,t){var i=t.content;d.isInRobot&&(t.ff="r"),d.isInRobot||d.publish("_addSendMsgNum",t),d._getMsg.call(this,t,0,i,"c")}),this.resendFile=function(t,i){var a=this,n=t.uploadServiceType,o=a.uploadUtil.getNextUploadType(n);return!1!==o?(a.publish("sendVisitorEvent",{et:123,ssl:a.needHttps?1:void 0,uploadServiceType:o,ft:t.fileType},function(t){!t.successful||t.failure?!1===t.autoResend&&a.handleFileSelect.error():e("#"+i).remove()}),!1):(a.publish("getErr",{reqInfo:i,code:-2}),!0)},this.subscribe("getFileToken",function(i,a){if(view.tempPlusFilePath&&view.tempPlusFilePath.length)return l(a);2==a.fileType&&d.handleFileSelect.back();for(var n,o,s=d.fileUploadInfos["uploadServiceType"+a.uploadServiceType]||a,r={},c=d.needHttps?s.fileUploadHttpsUrl:s.fileUploadUrl,u=a.qiniuKey||a.token||a.aliyunKey&&a.aliyunKey.match(/\/([^\/]+$)/)[1],f=null,m=s.fileUploadParam.split(","),h=0;h<m.length;h++)r[m[h].split("=")[0]]=(f=m[h].match(/\$\{([^\}]+)\}/))?a[f[1]]:m[h].split("=")[1];if(a.fileType=a.fileType||2,1==a.fileType){if(!d.pasteFileSource)return;(_=new FormData).append("file",d.pasteFileSource)}if(a.uploadServiceType==d.uploadUtil.getLastUploadType()&&(c+="?token="+a.token),2!=a.fileType&&3!=a.fileType&&4!=a.fileType)1==a.fileType||(5==a.fileType?(d.fileToken=a,d.publish("_captureImg",null)):6==a.fileType&&(d.fileToken=a,d.publish("_captureImgIE",null)));else{x=t;d.hasFormData||(x=_$("file_up").contentDocument)||(x=t.frames.file_up.document);var p=x.getElementById("uploadInput"),g=p.value||p.getAttribute("value");if(!g)return void console.log("no file to send",g);for(var b,w=(p.files||[{}]).length,I=0;I<w;I++)if(0===y[I+""]||3===y[I+""]){b=I;break}var T=b+1===w;if(p.files){if(!p.files[b]||!p.files[b].size)return void console.log("no file to send",g);(p.files[b]||p.files[b].name)&&(g=p.files[b].name)}if(n=g.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1"),d.hasFormData){try{o=new FormData;for(var k in r)"Content-Disposition"!=k&&"x:filename"!=k||(r[k]=n),o.append(k,r[k]);o.append("file",p.files[b],n);var S=new XMLHttpRequest;S.open("POST",c,!0);var C=!1;S.onerror=S.ontimeout=S.onabort=function(){y[b]=3,!C&&d.resendFile(a,u),C=!0},S.addEventListener("load",function(e){200==S.status&&S.responseText&&(1==S.responseText||S.responseText.match(/\{\s*"errorCode"\s*:\s*1\s*}/))?(y[b]=2,T&&setTimeout(function(){t.forms.namedItem("uploadForm").reset()})):403==S.status||S.responseText&&S.responseText.match(/\{\s*"errorCode"\s*:\s*146\s*}/)||S.responseText&&S.responseText.match(/\{\s*"errorCode"\s*:\s*117\s*}/)?(y[b]=4,d.publish("getErr",{reqInfo:u,code:-2}),setTimeout(function(){t.forms.namedItem("uploadForm").reset()})):(y[b]=3,!C&&d.resendFile(a,u),C=!0)}),y[b]=1,S.send(o),_$(u)||d.showMsg({id:u,f:"c"},'<div class="file-sending">'+lanRes.fileSending+"</div>"),d.sendingFileToken={token:u,end:!0}}catch(e){if(!T)return;d.hasFormData=!1,d.hasInitFile=!1,d.addSendFile(),v=null,console.log("变为iframe上传")}T&&(p=o=null)}else{var x;(x=_$("file_up").contentDocument)||(x=t.frames.file_up.document);var _=x.getElementById("uploadForm");for(var k in r)if("Content-Disposition"!=k&&"x:filename"!=k||(r[k]=n),_[k])_[k].value=r[k];else{var E=x.createElement("input");E.name=k,E.type="hidden",E.value=r[k],_.insertBefore(E,p)}e(_).attr("action",c),_.submit(),d.showMsg({id:u,f:"c"},'<div class="file-sending">'+lanRes.fileSending+"</div>"),setTimeout(function(){d.sendingFileToken={token:u,end:!0},d.publish("_toggleEnableFile",!1)},10)}}}),this.subscribe("niuniuKey",function(e,t){if(t){var i=t.split(","),a=new Date,n=a.getFullYear()+""+(a.getMonth()+1)+a.getDate();a.setDate(a.getDate()+1);var o=a.getFullYear()+""+(a.getMonth()+1)+a.getDate();d["niuniu"+n]=i[0],d["niuniu"+o]=i[1]}});var p=navigator.userAgent.toLowerCase(),g=(p.indexOf("baidubrowser"),p.indexOf("mqqbrowser")>-1&&this.Device.OS,"uc"==this.Browser.browser);d.isMobile||d.isInRobot?this.bindPlainTextEvent():d.changeToIframe(),g&&e("#footer").addClass("footer-absolute");var v;d.resetForm=function(e){var i;if(d.hasFormData)i=t.forms.namedItem("uploadForm").reset();else{var a=_$("file_up").contentDocument||t.frames.file_up.document;i=a.getElementById("uploadForm")}setTimeout(function(){i&&i.reset()},e||10)},d.handleFileSelect=function(){var e,t,i="tempInitSendFile";return{back:function(){--e<1&&d.publish("enableSelectFile",i)},error:function(){--e<1&&d.publish("enableSelectFile",i)},change:function(a){t=e=a,d.publish("disableSelectFile",i)},isSending:function(){return e>0},reset:function(){t=e=0,d.publish("enableSelectFile",i)}}}(),d.subscribe("enableSelectFile",function(t,i){e(".menu-file").removeClass("menu-file-disabled"),e("#"+i).remove()}),d.subscribe("disableSelectFile",function(t,i){d.showMsg({id:i,f:"c"},'<div class="file-sending">'+lanRes.fileSending+"</div>"),e(".menu-file").addClass("menu-file-disabled")}),e("body").on("click",".menu-file-disabled",function(){d.handleFileSelect.isSending?d.showTip(lanRes.fileDisable):d.handleFileSelect.reset()});var b=function(t){return!(t>9)||(d.isMobile?(_$("leave_tip_con").innerHTML=lanRes.visitor176,d.tipTimer&&clearTimeout(d.tipTimer),e("#leave_tip").removeClass("tiphide"),d.tipTimer=setTimeout(function(){e("#leave_tip").addClass("tiphide")},3e3)):d.showDialog({tip:lanRes.visitor177,cancel:!1}),!1)};window.verifyFile=function(t){var i="";for(var a in d.uploadFileTypeKey)i+="<div>"+a+":"+d.uploadFileTypeKey[a].join("、")+"</div>";return!(!t||-1!=(","+d.uploadFileType+",").indexOf(","+t.toLowerCase()+","))&&(d.showDialog({tip:"ERROR: "+lanRes.upload_error+'。</br><span class="color0" id="supportFileType">'+lanRes.supportFileType+"</span><div style='display:none;cursor: pointer;' id='supportFiles'>"+i+"</div>",cancel:!1,contentStyle:"text-align: left",callback:function(){function t(t){var i="";try{i=e("#supportFiles").results[0].style.display}catch(e){}"block"===i?e("#supportFiles").hide():e("#supportFiles").show()}e("#supportFileType").off("click",t),e("#supportFileType").on("click",t)}}),!0)};var y={};window.fLoad=function(i){i||(i=_$("file_up").contentDocument)||(i=t.frames.file_up.document);var a=i.getElementById("uploadInput");view.dji&&(a.style.height="62px"),"1"===view.chat.queryParams.multipleFile&&(e(a).attr("multiple","multiple"),e(a).attr("title",lanRes.visitor176)),a.onchange=function(){function t(){if(d.outerChatStatus&&d.outerChatStatus.match(/(waiting|chatting|leaveToService|workorder)/))!function(){if(!d.outerChatStatus||!0===d.companyOff||d.busyCanSend&&"0"!=d.queryParams.autoChat||!0===d.chatting){var t=a.value||a.getAttribute("value");if(!b((a.files||[{}]).length))return!1;if(t){var i,n=t,o=(a.files||[{}]).length;d.handleFileSelect.change(o);for(var s=0;s<o;s++){if(a.files){if(!a.files[s]||!a.files[s].size){console.log("no file to send",t),d.handleFileSelect.error(),a.value=null;continue}(a.files[s]||a.files[s].name)&&(t=a.files[s].name)}i=-1!=t.indexOf(".")?t.replace(/.*\./,""):"";var r=t.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1");d.sendingTitle=r+"."+i+lanRes.fileSendWait,verifyFile(i)?(d.handleFileSelect.error(),a.value=null):d.getFileSize(a,s)>d.uploadFileSize?(d.showDialog({tip:lanRes.fileSizeOut.replace("${maxSize}",d.uploadFileSize/1024/1024+"M"),cancel:!1}),d.handleFileSelect.error(),a.value=null):(y[s+""]=0,a.files&&(n=a.files[s]),v=n,d.publish("sendVisitorEvent",{et:123,ssl:d.needHttps?1:void 0,uploadServiceType:d.uploadUtil.getUploadServiceType(),ft:2},function(e){e.successful&&!e.failure||!1===e.autoResend&&d.handleFileSelect.error()}),view.hideMenus&&view.hideMenus(0,!1))}}else console.log("no file to send",t)}else e("#busyTipLine").removeClass("hide").show()}();else{if(i>15)return;i++,setTimeout(t,80)}}y={};var i=0;t()},a.onclick=function(){view.hideMenus(),d.sendingFileToken}},d.addSendFile(),d.emojitimer=setTimeout(function(){try{d.loadEmoji()}catch(e){}},100),this.subscribe("getErr",function(t,i){var a=i.reqInfo,n=a&&_$(a);switch(i.code){case 16:e(".file-sending",n).html(lanRes.tooLargeUploadFail);break;case 17:e(".file-sending",n).html(lanRes.unsupportFileType);break;case 18:default:e(".file-sending",n).html(lanRes.unkownErrorUpload)}16!=i.code&&17!=i.code&&18!=i.code||d.addSendFile()}),this.subscribe("removeThisHistory",function(){d.lasMid=0,d.isRemoveThisHis=!0});var w=!1;this.subscribe("getHistory",function(t,i){function a(e){return(!l||e-l>6e4)&&(l=e,!0)}function n(e){}if(d.talkId=i.talkId,d.isRemoveThisHis&&(d.isRemoveThisHis=!1,e(".list-msg-his").remove()),!w){w=!0,setTimeout(function(){w=!1},1e3);var o,s,r=i.chatDetailList,l=0;if(d.robotFeedbackTemp={},d.isArray(r)){_$("list_msg");var c=d.getHistoryByTalkId(i.talkId),u=d.lasMid;c&&c.order&&c.order.length&&(u=c[c.order[c.order.length-1]].mid),d.sendMsgNum=0,orderedStaffInfo={},d.hasGetHistory=!0;for(var f=0;f<r.length;f++){if(o=r[f],s=o,o.mid<=u){if(1===view.miniTempCloseWs||d.hasGetHistory)continue;o.notStore=!0,o.notEnd=!0}if(315==o.dataType&&o.data&&(864==(o=JSON.parse(o.data)).mt&&d.isInRobot&&s.feedbackResult?d.robotFeedbackTemp[s.id]={feedbackResult:s.feedbackResult,feedbackSubitem:s.feedbackSubitem}:o.relateId=s.relateId||o.relateId),!(o.mt>1e3&&"10001"!=o.mt&&"10010"!=o.mt&&"10011"!=o.mt&&"12001"!=o.mt||_$("msg"+o.tm)||_$("msg"+o.mid)||_$(""+o.mid)||_$(""+o.id)||_$(""+o.tmf)||(864==o.mt||865==o.mt||866==o.mt)&&n(o.mid))){if(o.notEnd=!0,864==o.mt)d.publish("_addSendMsgNum",o);else if("10001"==o.mt||"686"==o.mt){if(orderedStaffInfo=d.updateStaffInfo(void 0,{staffId:o.toStaffId||o.staffId,staffNickName:o.staffNickName||o.toStaffNickName,staffDetailInfo:o.staffDetailInfo||o.toStaffDetailInfo}),"686"==o.mt)continue}else orderedStaffInfo.staffName&&(o=e.extend(o,orderedStaffInfo));if("10001"!=o.mt)if("10011"!=o.mt)if(865!=o.mt&&641!=o.mt)if(647!=o.mt&&"10010"!=o.mt&&605!=o.mt)if(866!=o.mt&&642!=o.mt)if(680!=o.mt)if(640!=o.mt)if(655!=o.mt)if(688!=o.mt)if(959!=o.mt)if(658!=o.mt){if(890==o.mt)1==o.templateInfoList[0].type||3==o.templateInfoList[0].type?(o.content=d.getBookComfirm(o.templateInfoList),o.m=3):(o.content=d.showInfoTip({f:"sys",tip:lanRes.receiveBookForm},void 0,void 0,!0,o.talkId,o.tm,!0),o.m=4);else if("12001"==o.mt){d.publish("getMsgRobot",o);continue}var m={t:a(o.tm)?new Date(o.tm).format("hh:mm"):void 0,tm:o.tm,mt:o.mt,c:o.content,ff:d.isInRobot?"r":void 0,f:864==o.mt?"c":890==o.mt?"x":"s",m:o.m||0,id:"msg"+(o.mid||o.tm),talkId:i.talkId,notEnd:!0,mid:o.mid};d.showMsg(m),delete m.id,3==m.m&&(m.c=o.templateInfoList),delete m.notEnd,d.pushHistory(m)}else d.publish("orderReply",o);else d.publish("submitForm",o);else d.publish("receiveForm",o);else d.publish("getLeaveMsg",o);else o.id=o.mid,d.publish("getMsg",o);else d.publish("receiveURL",o);else d.publish("getMsgFile",o);else{if(8==o.type)continue;d.publish("getSysMsg",o)}else d.publish("getMsgImg",o);else d.publish("receiveVisEvt",o);else d.staffMap[o.toStaffId]&&d.publish("getSysMsg",{talkId:i.talkId,tm:o.tm,mt:"10001",mid:o.mid,notStore:o.notStore,notEnd:o.notEnd,staffId:o.toStaffId,staffName:d.staffMap[o.toStaffId].staffName},o)}}if(setTimeout(function(){view.scrollToBottom(),d.isMobile&&e("#footer").removeClass("hide"),view.hideMenus(),d.wait874List=!1,d.publish("removeLoading")},10),d.isMobile&&"none"!=_$("loading").style.display&&e("#footer").addClass("hide"),view.miniShow){var h=e.store("ECHAT_"+view.chat.companyId+"_"+view.chat.visitorId+"_mid");h&&e.store("ECHAT_"+d.companyId+"_"+window.chatVisitorId+"_mid_read",h)}}else d.wait874List=!1,d.publish("removeLoading")}}),this.subscribe("getSysMsg",function(t,i){if((d.chatting||2!=i.type)&&11!=i.type){var a;if("10001"==i.mt)return a=(i.toStaffNickName||i.staffName||lanRes.serviceStaff)+" "+lanRes.transferStaff,d.showInfoTip(a,"msg"+i.tm,void 0,void 0,i.talkId,i.tm,i.notEnd),i.c="10001",i.f="x",void(i.notStore&&(d.pushHistory(i),d.handleNewMsgMid(i.mid,{m:0,f:"sys",c:a},!0,i)));if("647"!=i.mt||601!=i.exType||i.exType!=(this.preMsg||{}).exType){if(this.preMsg=i,i.notStore||!i.talkId||d.talkId&&1!=i.type&&10!=i.type&&7!=i.type||(d.talkId=i.talkId,!d.hasGetHistory&&d.companyOff),10==i.type)return i.notStore||(d.talkId=i.talkId,d.robotTalkId=i.talkId),void this.publish("_showCommonQue",i);if(a=i.content||i.c){var n=(a=this.handleMsgImg(a,i)).replace(/&nbsp;([^&\s])/g," $1");if(5==i.type||"s"==i.f)return i.staffId&&d.staffMap[i.staffId+""]&&(i=e.extend(i,d.staffMap[i.staffId+""])),void d._getMsg.call(this,i,0,n);if(d.showInfoTip({f:"sys",tip:a},"msg"+i.tm,void 0,void 0,i.talkId,i.tm,i.notEnd),!i.notStore){var o={mid:i.mid,tm:i.tm,f:"sys",mt:i.mt,m:0,c:a};if(o.talkId=i.talkId||d.talkId,d.pushHistory(o),o.c&&d.handleNewMsgMid(i.mid,o,!0,i),0===i.canTriggerWebTitleTip)return;i&&!d.isMobile&&view.setDocumentTitle&&view.setDocumentTitle("s")}}}}}),d.hasWaitingStatus=!1,this.subscribe("startQueueChat",function(e,t){d.talkType=1,d.talkId=t.talkId}),this.subscribe("getPosMsg",function(t,i){d.companyOff=!1,e("#positionInfo").remove(),d.hasWaitingStatus||(d.paramChat.talkId=i.talkId,d.talkId=i.talkId,d.publish("__chatStatus","waiting"),e.store("ECHAT_"+d.companyId+"_"+window.chatVisitorId+"_chatStatus",1),d.hasWaitingStatus=!0,d.publish("setConfig",d.msg649),d.busyCanSend?(e(".menu-capture").removeClass("hide"),e(".menu-file").removeClass("hide")):(e(".menu-capture").addClass("hide"),e(".menu-file").addClass("hide"))),d.queueTxt=d.msg649.queueTxt||d.msg649.mobileQueueTxt||d.queueTxt,d.queueTxt&&d.showInfoTip({f:"sys",tip:d.queueTxt.replace("${waitcount}",i.position)},"positionInfo","warn",void 0,i.talkId,i.tm),d.publish("__chatQueue",i.position),d.initQcode(),d.postMessage({type:"getPosMsg",msg:i})}),this.subscribe("inviteSatisfy",function(){setTimeout(function(){d.showSatisfy(2)},10),d.publish("__newMsg",{f:"s",m:0,c:"[evaluate]:客服邀请您评价"})}),this.subscribe("staffInfo",function(t,i){d.staffName=d.stringEncode(i.staffNickName||lanRes.serviceStaff);var a=i.staffDetailInfo;a&&"string"==typeof a&&(a=JSON.parse(a)),a&&a.staffHead&&(d.needHttps&&(a.staffHead=a.staffHead.replace(/^http:/,d.needHttps)),d.paramChat.staffPhoto=a.staffHead),d.paramChat.staffPhone=a.staffPhone||"",d.paramChat.staffInfo=a.staffInfo||"",d.staffImg=a.staffHead||d.defaultStaffImg,view.initServiceInfo&&view.initServiceInfo(d,a);d.dataObject.staffInfos[d.staffId]={name:d.staffName,img:d.staffImg},d.saveHistoryStaffInfos(),e(".sa-avatar").html('<img src="'+view.chat.staffImg+'"/>'),a&&d.saveHistoryStaff(d.staffImg,d.staffName),view.startChatRefreshAD&&view.startChatRefreshAD(),view.showStaffInfo&&d.staffInfoEnable&&d.staffInfoEnable.staffInfoChattingEnable&&view.showStaffInfo(),i.staffDetailInfoMsgList&&d.handleStaffMap(i.staffDetailInfoMsgList,i.notStore),d.publish("showChatStaffInfo"),d.publish("__chatStaffInfo",{staffId:d.paramChat.staffId,staffNickName:d.paramChat.staffName||"",staffPhone:d.paramChat.staffPhone,staffHead:d.staffImg,staffInfo:a.staffInfo||"",recordId:(d.isInRobot?"5_":"1_")+d.talkId})}),d.staffInfoRefreshMap={innerAD:{notEnableParam:!1,params:"[]",element:"#inner_frame",hash:!0,srcUrl:void 0,attr:"src",url:""},innerImgUrl:{attr:"href"},rightAD:null,leftAD:null,innerURL:{},merchantLink:null,staffInfo:null,urlList:null},this.subscribe("__chatStatus",function(t,i){i.match(/^waiting|chatting|robot|leave/)&&function(t,i){function a(t){if(t.srcUrl){var i=d.getADURL(!t.notEnableParam,t.params,t.srcUrl,view.chat.paramChat,t.hash),a=i;e(t.element).each(function(n,o){"IFRAME"==o.tagName&&(a=view.chat.addEchatInnerFrameParam(i)),"src"==t.attr?o.src=a:"href"==t.attr?o.href=a:e(o).attr(t.attr,a)}),t.url=a}}var n,o;for(n in d.staffInfoRefreshMap)if(o=d.staffInfoRefreshMap[n])if(d.isArray(o))for(var s=0;s<o.length;s++)a(o[s]);else a(o);var r="media="+(view.windowType||"")+"&staffId="+(d.staffId||"")+"&staffName="+encodeURIComponent(d.staffName||"")+"&companyId="+(d.companyId||"")+"&talkId="+(d.talkId||"")+"&echatTag="+(d.paramChat.echatTag||d.queryParams.echattag||"")+"&visitorId="+(d.visitorId||"")+"&country="+encodeURIComponent(d.paramChat.country||"")+"&province="+encodeURIComponent(d.paramChat.province||"")+"&city="+encodeURIComponent(d.paramChat.city||"")+"&keyword="+encodeURIComponent(d.paramChat.keyword||"");d.echatSourceTag=encodeURIComponent(r)}()}),this.subscribe("updateStaffInfo",this.updateStaffInfo),this.subscribe("chatEnded",function(t,i){d.talkId&&d.dataObject.msgInfos.currentPrevTalkId&&(d.dataObject.msgInfos.currentPrevTalkId=(d.talkType||1)+"_"+d.talkId);var a,n=d.chatting,o=d.isInRobot,s="2"!=view.windowType&&d.queryParams.redirectUrl,r=1==i.changeRoute||1==i.closeTag;if(d.chatting=!1,d.isInRobot=0,d.hasGetHistory=!1,view.miniTempCloseWs=0,d.companyOff=void 0,d.staffImg=void 0,d.hasWaitingStatus=!1,d.endChatEvent(),d.publish("clearSendingMsg","endchat"),this.unSubscribe("_sendMsg"),view.toggleEnded&&view.toggleEnded("end"),o&&d.publish("endRobot"),d.talkId&&3!=d.talkType&&i&&i.tm&&d.updateHistoryComplete(d.talkType+"_"+d.talkId),e(".btn-qcode").addClass("hide"),e(".menu-capture").addClass("hide"),e(".menu-file").addClass("hide"),e("#robotToStaff").addClass("hide").hide(),d.hasEntryOrCode&&d.publish("entryCallback",{success:!0}),11!=i.type&&e(".btn-close").addClass("hide"),d.isTimeOutClose=d.leaveAndClose,d.leaveAndClose&&("2"!=view.windowType&&d.queryParams.redirectUrl&&(location.href=d.queryParams.redirectUrl),e("#container").removeClass("hide"),e("#chat").removeClass("hide"),e("#footer").removeClass("hide"),e("html").removeClass("page-leave"),d.leaveAndClose=!1,d.entryLeaveContent=void 0,d.showInfoTip('<div class="btn-restart" id="restartChat">'+lanRes.toContinueChat+"</div>",void 0,void 0,void 0,i.talkId,i.tm)),"10009"!=i.mt||4!=i.type&&10!=i.type||(d.paramChat.visEvt=d.initVisEvt,delete d.queryParams.autoPop,delete d.queryParams.autoChat),1!=i.changeRoute&&this.publish("_hideCloseBtn",i),e.store("ECHAT_"+d.companyId+"_"+window.chatVisitorId+"_chatStatus",0),i.justConnect)!0===n&&d.talkId&&(d.lastTalkIdForTemp=d.talkId);else{d.lastTalkIdForTemp=void 0,i.content&&d.publish("getSysMsg",i),d.hasLeaveMsg||1==i.changeRoute||i.fromHistory&&(!i.fromHistory||!1!==i.isForward||"605"!=i.mt&&"10009"!=i.mt)||(e("#restartChat").parents("li").remove(),d.showInfoTip({f:"sys",tip:'<div class="btn-restart" id="restartChat">'+lanRes.toContinueChat+"</div>"},void 0,void 0,void 0,i.talkId,i.tm)),d.visitorClose=!i.fromHistory&&(1==i.closeReason||d.visitorClose&&"0"==i.closeReason),d.toggleEvaluateMenu(1);var l=!r&&!0===n&&d.showSatisfy(1);d.postMessage(3),view.msgboxClose&&view.triggerMsgBoxClose&&view.triggerMsgBoxClose(),r||i.fromHistory||l||1==d.toLeaveWord&&d.staffChatNeedConnect||s&&"2"!=view.windowType&&d.queryParams.redirectUrl||this.publish("_closeWin",i),i.talkId?d.talkId||(d.talkId=i.talkId):i.talkId=d.talkId,a=d.talkId,i.fromHistory&&!1!==i.isForward||("10009"!=i.mt||4!=i.type&&10!=i.type||(d.talkId="",e("#list_msg").show()),i.talkId&&d.handleSessionMsg(i),view.scrollToBottom()),d.talkId=a,i.fromHistory||11==i.type||(!view.SDK&&d.publish("__chatStatus","end-"+(i.closeReason||"0")+"-"+(l&&!o?"1":"0")),(d.staffChatNeedConnect||!view.SDK&&1==d.toLeaveWord||1==i.toChat)&&setTimeout(function(){d.publish("_triggerChat")},100))}}),this.subscribe("_closeWin",function(){if(!view.SDK&&d.visitorClose&&1!=d.toLeaveWord)if(d.leaveAndClose=!1,view.hasNative&&!view.SDK)d.publish("__visitorHide");else if(!(window.top==self&&window.EchatJsBridge||view.SDK)){var t;2==view.windowType?view.isMsgBoxChat&&view.hasNative||(t=function(){s(),setTimeout(function(){d.postMessage("hideMBmini"),e("#entry")&&e("#entry").html("").hide()},500)}):1==view.windowType&&(t=function(){try{window.opener=null,window.open("","_self").close(),window.close()}catch(e){try{window.close()}catch(e){}}}),d.isTimeOutClose?setTimeout(function(){t&&t(),d.isTimeOutClose=!1},1e3):t&&t()}}),this.subscribe("entryCallback",function(t,i){if(1==i.success){if(d.leaveAndClose&&2==view.windowType||(e("#entry").html("").hide(),e("#verify").hide(),e("#mask").hide(),e("body").removeClass("entry"),e("html").removeClass("entry2")),view.resetContainerBaseFoot&&view.resetContainerBaseFoot(),setTimeout(function(){view.scrollToBottom()},500),i.mid&&(delete d.queryParams.autoPop,delete d.queryParams.autoChat),d.hasEntryOrCode=!1,i.mt){d.no103=!1,d.publish("toRegisterChat");var a=d.entryParam;if(a){delete a.et,delete a.captcha;var n=e.store("ECHAT_"+d.companyId+"_ENTRY_HIS");n=n?JSON.parse(n):{},a=e.extend(n,a),e.store("ECHAT_"+d.companyId+"_ENTRY_HIS",JSON.stringify(a)),d.calcInnerADHeight&&d.calcInnerADHeight(),delete d.calcInnerADHeight}}}else d.publish("refreshVerify",{status:1})}),this.subscribe("receiveUnread",function(t,i){!view.SDKNative&&i.data.talkId&&(_$("list_msg").childNodes.length>1&&e("#list_msg").html(""),d.loadHistory("1_"+i.data.talkId)),d.talkId=i.data.talkId,d.unreadMsg?d.unreadMsg.push(i):d.unreadMsg=[i];var a,n=i.data.chatDetailList,o=n.length,s="",r=0,l=i.data.staffDetailInfoList;if(l&&l.length&&(d.handleStaffMap(l,!1),d.staffMap[l[l.length-1].staffId]),o){"downFile",d.isIOS&&"_blank";for(var c=0;c<o;c++)if(a=n[c],"","686"!=a.mt)if("10001"!=a.mt){if("640"==a.mt||"675"==a.mt||"647"==a.mt);else if("10011"==a.mt){if(2==a.visibility)continue}else if("641"==a.mt);else if("642"==a.mt);else{if("10012"==a.mt)continue;a.mt}r++}else d.updateStaffInfo(void 0,{staffId:a.toStaffId,staffNickName:a.toStaffNickName,staffDetailInfo:a.toStaffDetailInfo});else d.toInitEvaluate(d.msg649),setTimeout(function(){var t=d.staffImg;if(!t){var i=d.getHistoryByTalkId("1_"+a.talkId);i&&i.staffImg&&(t=i.staffImg)}t&&e(".sa-avatar").html('<img src="'+t+'"/>')}),d.updateStaffInfo(void 0,{staffId:a.staffId,staffNickName:a.staffNickName,staffDetailInfo:a.staffDetailInfo})}if(e("#unreadline").remove(),r>0){s='<li id="unreadline" class="clearfix pre-his unreadline" style="color:#FFA71E"><i class="hr-left hr-left2"></i><span langs="preHistory">'+lanRes.thisUnreadMsgNum.replace("${num}",r)+'</span><i class="hr-right hr-right2"></i></li>';e("#list_msg").append(s).show()}setTimeout(function(){view.scrollToBottom("unreadline")},800)}),e("#leave_tip").on("click",function(){d.tipTimer&&clearTimeout(d.tipTimer),e(this).addClass("tiphide")}),this.changeDocTitle=function(){if("title"in t)return function(e){t.title=e};var e,i=_$s("title");return i&&i[0]?e=i[0]:(e=t.createElement("title"),_$s("head")[0].appendChild(e)),"textContent"in e?function(e){_$s("title")[0].textContent=e}:"innerText"in e?function(e){_$s("title")[0].innerText=e}:function(){}}()},configToolMenus:function(t){t||(t={});var i=4;"1"!=t.toolEmoji?(e(".menu-emo").addClass("hide-important"),i--):e(".menu-emo").removeClass("hide-important"),"1"!=t.toolFile?(e(".menu-file").addClass("hide-important"),i--):e(".menu-file").removeClass("hide-important"),"1"!=t.toolSatisfaction?(e(".menu-satisfy").addClass("hide-important"),i--):e(".menu-satisfy").removeClass("hide-important"),e(".menu-capture").length>0&&("1"!=t.toolScreenshot?(e(".menu-capture").addClass("hide-important"),i--):e(".menu-capture").removeClass("hide-important")),e(".menu-phone").length>0&&("1"!=t.toolTelephone?(e(".menu-phone").addClass("hide-important"),i--):e(".menu-phone").removeClass("hide-important")),0==i?(e("#menu-tools").addClass("hide-important"),e("#container").addClass("menu-no-tools")):(e("#menu-tools").removeClass("hide-important"),e("#container").removeClass("menu-no-tools"))},plainTextToSendMsg:function(e){var t=this;return charMap={"<":"&lt;",">":"&gt;",'"':"&quot;"},e=e.replace(/\[#([^#]+)#\]/g,function(e,i){return"[#"+(t.lanEmo[i]||i)+"#]"}).replace(/[<">]/g,function(e){return charMap[e]})},processMsg:{processNum:0,sendMsgMap:{},receiveMsgMap:{}},openVisitorSend:function(){var t=this;this.unSubscribe("_sendMsg"),this.unSubscribe("_sendVisEvt"),this.subscribe("_sendMsg",function(i,a){if(!view.handleNetwok||!view.handleNetwok())if(t.isInRobot||!0===t.companyOff||t.busyCanSend||"0"==t.queryParams.autoChat||!0===t.chatting){var n=a||t.getInput(!0);if(n.trim())if(n.match(/^\[#echat::lihong#\]$/))t.loadConsole(7304);else{t.plainText&&(n=t.plainTextToSendMsg(n));var o=(new Date).getTime(),s="msg"+o,r=t.checkHistoryTime(o),l={filterMsg:1==t.filterMsg||3==t.filterMsg,t:r?(new Date).format("hh:mm"):void 0,tm:o,mt:864,f:"c",m:0,c:n,id:s};t.sendToServer(l),a||(t.lastText=null,view.afterSend()),t.publish("_firstSendMsg",{c:n}),t.publish("_addSendMsgNum",l)}}else e("#busyTipLine").removeClass("hide").show()}),this.subscribe("_sendVisEvt",function(i,a){if(!view.handleNetwok||!view.handleNetwok())if(t.isInRobot||!0===t.companyOff||t.busyCanSend||"0"==t.queryParams.autoChat||!0===t.chatting){var n;if("object"==typeof a){if(n={et:126,dedup:0,customizeMsgType:a.customizeMsgType||1,eventId:a.eventId,title:t.replaceHtml(a.title),content:a.content,imageUrl:a.imageUrl,url:a.url,urlForVisitor:a.urlForVisitor,urlForStaff:a.urlForStaff,memo:t.replaceHtml(a.memo),visibility:a.visibility,urlEnableForVisitor:a.urlEnableForVisitor,closeURLPage:a.closeURLPage,question:t.replaceHtml(a.question),visEvt:"object"==typeof a.visEvt?JSON.stringify(a.visEvt):a.visEvt},!a.question&&this.isInRobot&&1==a.customizeMsgType)return}else n={et:126,dedup:0,visEvt:a};var o=(new Date).getTime(),s="msg"+o,r=1==n.customizeMsgType?"c":"x",l="c"===r?t.getVisEvtHtml(n):"",d={t:t.checkHistoryTime(o)?(new Date).format("hh:mm"):void 0,tm:o,mt:10011,et:126,data:n,talkId:t.talkId,talkType:t.talkType,m:5,hide:"c"!==r,f:r,c:l,id:s};t.sendToServer(d,void 0,function(t){e("#"+s).remove()}),"c"==r&&(t.publish("_firstSendMsg",{c:l}),t.publish("_addSendMsgNum",d))}else e("#busyTipLine").removeClass("hide").show()})},postMessage:function(e){if(!this.doNotHasPostMessage&&2==view.windowType&&window.top!=self)try{return window.parent.postMessage(e,this.queryParams.fromhost||"*"),!0}catch(e){this.doNotHasPostMessage=!0,console.log(e)}return!1},getVisitorMessage:function(){},initDialog:function(){var t=this;t.hasInitDialog||(t.hasInitDialog=!0,e("body").on("click",".dialog-close",function(){e(".dialog").remove(),t.publish("_dialogCanel")}).on("click",".img-close",function(){e(".dialog").remove(),t.publish("_dialogCanel")}).on("click",".dialog-cancel",function(){e(".dialog").remove(),t.publish("_dialogCanel")}).on("click",".dialog-ok",function(){e(".dialog").remove(),t.publish("_dialogOk")}))},showDialog:function(t){function i(t){var o=e(".dialog").results,s=e(".dialog-ok").results[0],r=e(".dialog-cancel").results[0],l=e(".dialog-close").results[0];if(0==o.length)e("body").off(n,i);else{var d=t.srcElement||t.target;setTimeout(function(){s==d||e.fn.contains(s,d)?(a.publish("_dialogOk"),e(".dialog").remove()):(r==d||e.fn.contains(r,d)||l==d||e.fn.contains(l,d))&&(a.publish("_dialogCanel"),e(".dialog").remove())},50)}}var a=this,n=a.isMobile&&!a.isPcXcx?"tap":"click";e(".dialog").remove(),this.publish("_dialogCanel"),a.initDialog();var o=t.tip,s='<div class="dialog dialog-hide"><div class="dialog-close"><i class="img-close"></i></div><div class="dialog-title">'+lanRes.tip+'</div><div style="'+t.contentStyle+'" class="dialog-content">'+o+'</div><div class="dialog-btns"><a class="dialog-btn dialog-ok bg0"><div class="bg0 fade-div"></div><span>'+(t.okTip||lanRes.okay)+"</span></a>"+(!1!==t.cancel?'<a class="dialog-btn dialog-cancel bg0 has-fade"><div class="bg0 fade-div"></div><span>'+lanRes.cancel+"</span></a>":"")+"</div></div>";e(_$("index")||"body").append(s),t.callback&&t.callback(),a.unSubscribe(["_dialogOk","_dialogCanel"]),a.subscribe("_dialogOk",function(){e("body").off(n,i),t.ok&&t.ok(),a.unSubscribe(["_dialogOk","_dialogCanel"])}),a.subscribe("_dialogCanel",function(){e("body").off(n,i),t.cancel&&t.cancel(),a.unSubscribe(["_dialogOk","_dialogCanel"])}),setTimeout(function(){e("body").on(n,i),e(".dialog").removeClass("dialog-hide")},10),view.inputBlur&&view.inputBlur(void 0,1)},showAlertDialog:function(t){function i(t){var n=e(".dialog").results,o=e(".dialog-ok").results[0];0==n.length?e("body").off(a.isMobile&&!a.isPcXcx?"tap":"click",i):setTimeout(function(){(o==t.target||e.fn.contains(o,t.target))&&(a.publish("_dialogOk"),e(".dialog").remove())},50)}e(".dialog").remove();var a=this;a.initDialog();var n=t.tip,o='<div class="dialog dialog-hide"><div class="dialog-title">'+lanRes.tip+'</div><div class="dialog-content">'+n+'</div><div class="dialog-btns"><a class="dialog-btn dialog-ok bg0"><div class="bg0 fade-div"></div><span>'+(t.okTip||lanRes.okay)+"</span></a></div></div>";e("body").append(o),e("#mask").show(),setTimeout(function(){e("#mask").show()},100),a.unSubscribe(["_dialogOk"]),a.subscribe("_dialogOk",function(){e("body").off(a.isMobile&&!a.isPcXcx?"tap":"click",i),t.ok&&t.ok(),a.unSubscribe(["_dialogOk"]),e("#mask").hide()}),setTimeout(function(){e("body").on(a.isMobile&&!a.isPcXcx?"tap":"click",i),e(".dialog").removeClass("dialog-hide")},10)},getOrderSettingsByFields:function(e,t,i,a){for(var n,o,s,r={},i=i||"default",l=0;l<t.length;l++){if(n=r[t[l].field]=t[l],o=null,n.settings&&n.settings.length>0)if(1==n.settings.length)n.configs=n.settings[0].configs;else{for(var d=0;d<n.settings.length;d++){if(n.settings[d].lan==i){n.configs=n.settings[d].configs;break}"default"==n.settings[d].lan&&(o=n.settings[d].configs)}!n.configs&&(n.configs=o||n.settings[0].configs)}t[l].field===e&&(s=t[l])}a&&a(r,s,o)},toShowOrderSubmit:function(i){e(window).on("resize",function(){var e=t.activeElement;"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||setTimeout(function(){e.scrollIntoViewIfNeeded()},100)});var a=this,n="",o="",s=[],r=i.jobWindowInfo,l=r.configuration,d=r.fieldSettings;s.push(1!=view.windowType||view.dji?"entry2-mb":"entry2-pc"),!a.isMobile&&a.mini&&s.push("entry2-pc-mini"),s.push("entry2-form"),e("#orderSubmit")&&e("#orderSubmit").remove(),!view.SDKNative&&a.addCSS(a.isMobile&&!view.dji?__uri("/visitor/common/css/entry2.css"):__uri("/visitor/common/css/entry2pc.css"));for(var c='<div id="orderSubmit" class="{{entryClass}} order-form"><header class="ordertitle"><div class="margin-b5" style="font-size: 14px;">{{title}}</div><div class="order-tip">{{description}}</div></header><div class="entry2-wrap entry2-items order-content"><form id="orderForm">{{element}}</form><span class="order-button magr0 bg-c order-upload-button"><form class="order-upload" name="orderUploadForm" id="orderUploadForm" enctype="multipart/form-data" method="post"><input type="file"'+(a.isIOS?" ":' accept="*/*" ')+'title="'+lanRes.visitor189+'" name="file" id="orderUpload">'+lanRes.visitor189+'</form></span><div id="orderFileslist" class="order-fileslist"></div><div class="order-tip">'+lanRes.visitor178+'</div></div><footer class="order-footer"><span class="order-submit order-button bg0">{{submit}}</span></footer></div>',u='<div class="entry2-item"><div class="entry2-label {{req}}"><span class="req-span">*</span><span class="entry2-name">{{configDesc}}:</span></div><div class="entry2-typeline {{req}}" lb="{{configDesc}}">{{typeline}}</div></div>',f=0;f<l.length;f++)var m=l[f],h=a.getOrderSettingsByFields(m.configName,r.fieldSettings,m.lan,function(e,t,i){if(h=t,2!=m.filedType){var s=h.type;n=a.getElementByFieldType(e,s,m,""),o+=u.replace("{{typeline}}",n).replace(/\{\{configName\}\}/g,m.configName).replace(/\{\{configDesc\}\}/g,a.escapeHtml(m.configDesc)).replace(/\{\{wordDesc\}\}/g,a.escapeHtml(m.wordDesc)).replace(/\{\{value\}\}/g,"").replace(/\{\{req\}\}/g,1==m.configRequired?"req":"")}});var p=view.SDKNative?"jpg，png，gif，bmp，avi，mov，rmvb，rm，flv，mp4，3gp":"jpg，png，gif，txt，rar，zip，doc，docx，xls，xlsx，bmp，avi，mov，rmvb，rm，flv，mp4，3gp";if(o=c.replace("{{entryClass}}",s.join(" ")).replace("{{element}}",o).replace(/\{\{title\}\}/g,r.title).replace(/\{\{description\}\}/g,r.description).replace(/\{\{cancel\}\}/g,lanRes.cancel).replace(/\$\{uploadFileSize\}/g,a.uploadFileSize/1024/1024).replace(/\$\{filesTip\}/g,p).replace(/\{\{submit\}\}/g,lanRes.submit),1!=view.windowType||view.dji?e("body").append(o):e("#leave").html(o).removeClass("hide"),a.resetOptionField(l,d,"workorder"),a.publish("removeLoading"),this.isMobile&&e("#orderSubmit").off("click").bind("click","img",function(e){setTimeout(function(){view.showImg.call(this,"orderFileslist",e)},500)}),a.isMobile||1!=view.windowType||view.dji)self===window.top&&(e(".btn-close").addClass("hide"),setTimeout(function(){e(".btn-close").addClass("hide")},100)),e("#container").addClass("hide");else{e("#chat").addClass("hide"),e("#orderSubmit footer").remove(),window.opener||(e(".btn-close").addClass("hide"),setTimeout(function(){e(".btn-close").addClass("hide")},100));var g='<div class="order-submit order-button bg0">'+lanRes.submit+"</div>";e(".leave-entry-foot").html(g)}e("html").addClass("page-leave entry2"),e("#footer").addClass("hide"),setTimeout(function(){e("#mask").hide()},100),e("#orderUpload").off("click").bind("click",function(e){e.stopPropagation()}),view.SDKNative?view.bindOrderUpload(".order-upload-button","#orderUpload"):a.orderUploadFile(),a.addOrderSubmitEvent(l,".order-submit")},resetOptionField:function(t,i,a){var n=this.msg649,o=n.entranceInfo||n.smallEntranceInfo||n.mobileEntranceInfo||n.sdkEntranceInfo;orderConfigObj=n&&(this.msg649.jobWindowInfo||o)||{},lanByField={},fieldByKey={},settings=[],configs=[],fieldOverLenArr=[],url="workorder"===a?"/chatapi/jobh/dfd":"/chatapi/bfc/df",sendParams={companyId:this.companyId,requesterVisitorId:this.visitorId,token:orderConfigObj.token,nonce:orderConfigObj.nonce};for(var s=0;s<t.length;s++)lanByField[t[s].configName]=t[s].lan||"default";for(var r=0;r<i.length;r++)i[r].valueOverlength&&(fieldByKey[i[r].field]=i[r],fieldOverLenArr.push(i[r].fieldId));fieldOverLenArr.length>0&&(sendParams.fieldIds=fieldOverLenArr.join(","),e._ajax({url:this.apiServerDomain+url+"?"+this.addMapParams(sendParams),type:"jsonp",jsonpCB:"jsonpCallback",success:function(t){for(var i=0;i<t.length;i++){settings=t[i].settings,e("input[name="+t[i].field+"]").html("<option>请选择</option>");for(var a=0;a<settings.length;a++)if(lanByField[t[i].field]===settings[a].lan){configs=settings[a].configs;for(var n in configs){var o="<option value='{{value}}' inputvalue='{{inputvalue}}'>{{inputvalue}}</option>";o=o.replace(/\{\{value\}\}/g,configs[n].value).replace(/\{\{inputvalue\}\}/g,configs[n].item),e("select[name="+t[i].field+"]").append(o)}}}},error:function(){}}))},orderUploadFile:function(){var i=this,a=t.getElementById("orderUpload"),n=["jpg","png","gif","bmp"],s=["avi","mov","rmvb","rm","flv","mp4","3gp"],r=0;a.onchange=function(){function t(t,a,n){var o,s={smallImg:t||"",bigImg:t||"",sourceImg:t||"",fileName:lanRes.visitor175},d=0;switch(v){case"0":d="orderfile-icon",o='<a class="order-img" target="_blank"></a>';break;case"2":d="ordervideo-icon",o=i.isMobile?'<div class="order-img">':'<a class="order-img" target="_blank"></a>';break;case"4":d="orderimg-icon",o=view.showMsgImg&&view.showMsgImg(s)||'<img id="img'+(new Date).getTime()+'" src="'+s.smallImg+'" class="msg-img"/>'}var c=('<div dataindex="{{dataindex}}" class="{{classType}} load">{{fimg}}'+(2==v?"<i class='ordervideo-text'>VIDEO</i>":"")+'<span class="orderfile-name" title="{{fname}}">{{fname}}</span><i class="orderfile-del"></i><i class="orderfile-progress-num"></i><i class="orderfile-progress"></i></div>').replace(/\{\{classType\}\}/g,d).replace(/\{\{dataindex\}\}/g,n).replace(/\{\{fname\}\}/g,a).replace(/\{\{fimg\}\}/g,o);e(".order-fileslist").append(c),function(e){lastUploadFile=m;var t=i.msg649&&i.msg649.jobWindowInfo||{},a={token:t.token||"",nonce:t.nonce||"",fileType:v,tokenNum:1,companyId:i.companyId,requesterVisitorId:i.visitorId};b=a,l(y[r],e,e)}(n)}function l(t,a,n){var o;switch(t){case 1:o="/chatapi/jobh/gqt";break;case 2:o="/chatapi/jobh/gat";break;default:return b.uploadUrl=i.apiServerDomain+"/chatapi/jobh/fup",b.tm=(new Date).getTime(),e(".order-fileslist > div[dataindex='"+a+"']").attr("dataindex",b.tm),i.orderFileIndexObj[b.tm]=n,void d(b,t)}e._ajax({url:i.apiServerDomain+o+"?"+i.addMapParams(b),type:"jsonp",jsonpCB:"jsonpCallback",success:function(o){if(o.successful){var s=o.result.data[0],r=s.token||s.signature;e(".order-fileslist > div[dataindex='"+a+"']").attr("dataindex",r),i.orderFileIndexObj[r]=n,d(s,t)}else c(a)},error:function(){c(a)}})}function d(t,n){var s=new FormData;1==n?(s.append("key",t.qiniuKey),s.append("token",t.token)):2==n?(s.append("key",t.aliyunKey),s.append("policy",t.policy),s.append("callback",t.callback),s.append("success_action_status",200),s.append("signature",t.signature),s.append("OSSAccessKeyId",t.ossAccessKeyId),s.append("x:filename",m.name),s.append("x:companyid",i.companyId),s.append("x:visitorId",i.visitorId),s.append("x:filetype",v)):(s.append("companyId",t.companyId),s.append("requesterVisitorId",t.requesterVisitorId),s.append("fileType",t.fileType),s.append("tokenNum",t.tokenNum),s.append("nonce",t.nonce),s.append("token",t.token)),s.append("file",a.files[0]);var r=new XMLHttpRequest;r.open("POST",t.uploadUrl,!0),r.onerror=r.ontimeout=function(){c(t.tm||t.token||t.signature)},r.upload.onprogress=function(i){if(i.lengthComputable){var a=parseInt(i.loaded/i.total*100)+"%",n=t.tm||t.token||t.signature;e(".order-fileslist > div[dataindex='"+n+"'] .orderfile-progress-num").html(a),e(".order-fileslist > div[dataindex='"+n+"'] .orderfile-progress").css("width",a)}};var l=i.orderFileIndexObj[t.tm||t.token||t.signature];i.orderSubAttachments[l].xhr=r,r.addEventListener("load",function(n){var s=t.tm||t.token||t.signature,l=i.orderFileIndexObj[s];if(200==r.status&&r.responseText){var d=JSON.parse(r.responseText);d.successful||d.fname?(d=d.successful?d.result.data:d,i.orderSubAttachments[l].type=1,i.orderSubAttachments[l].fileValue={name:d.fname,url:d.sourceUrl,fileType:d.fileType,key:d.key,bucket:d.bucket},delete i.orderSubAttachments[l].xhr,function(t,a){var n=a.sourceUrl&&a.sourceUrl.indexOf("?")>0?"&":"?";downloadUrl=a.sourceUrl+n+"attname="+encodeURIComponent(a.fname),e(".order-fileslist > div[dataindex='"+t+"']").removeClass("load"),e(".order-fileslist > div[dataindex='"+t+"'] .orderfile-progress-num").html(""),0==a.fileType?e(".order-fileslist > div[dataindex='"+t+"'] .order-img").attr("href",a.sourceUrl):2==a.fileType?i.isMobile?e(".order-fileslist > div[dataindex='"+t+"'] .order-img").attr("onclick","view.__playVideo('"+a.sourceUrl+"','','"+downloadUrl+"','"+(a.fname||"")+"','"+(a.key||"")+"')"):e(".order-fileslist > div[dataindex='"+t+"'] .order-img").attr("href","/visitor/pc/video.html?videoUrl="+encodeURIComponent(a.sourceUrl)):4==a.fileType&&(e(".order-fileslist > div[dataindex='"+t+"'] img").attr("attname",a.fname).attr("src",a.sourceUrl).attr("source",a.sourceUrl),view.handleMessage&&e(".order-fileslist > div[dataindex='"+t+"'] img").attr("onclick","javascript:view.handleMessage('"+a.sourceUrl+'\',"orderFileslist")'))}(s,d),a.value=null,e(".order-fileslist > div .orderfile-del").off("click").bind("click",function(t){var a=this,n=e(this).context.parentElement.getAttribute("dataindex"),s=i.orderFileIndexObj[n],r=i.msg649&&i.msg649.jobWindowInfo||{},l={token:r.token||"",nonce:r.nonce||"",key:d.key,bucket:d.bucket,companyId:i.companyId,requesterVisitorId:i.visitorId};i.showDialog({tip:lanRes.visitor191,ok:function(){e._ajax({url:i.apiServerDomain+"/chatapi/jobh/df?"+i.addMapParams(l),type:"jsonp",jsonpCB:"jsonpCallback",success:function(t){e(a).context.parentElement.remove(),o(lanRes.visitor182,"ok"),e(".order-upload-button").css("display","inline-block"),i.orderSubAttachments.splice(s,1),function(){i.orderFileIndexObj={};for(var t=e(".order-fileslist > div").results||[],a=0;a<t.length;a++)t[a].getAttribute("dataindex").length>1&&(i.orderFileIndexObj[t[a].getAttribute("dataindex")]=a)}()}})},cancel:function(){}})})):c(s)}}),r.send(s)}function c(t){y[r+1]?l(y[r+=1],t,i.orderFileIndexObj[t]):(_$("leave_tip_con").innerHTML=lanRes.visitor181,e(".order-fileslist > div[dataindex='"+t+"']").remove(),o())}var u=a.value||a.getAttribute("value");if(i.orderSubAttachments.length>=20)return i.isMobile?o(lanRes.visitor179):i.showDialog({tip:lanRes.visitor180,cancel:!1}),a.value=null,!1;if(!u)return console.log("no file to send",u),!1;for(var f,m=u,h=(a.files||[{}]).length,p=0;p<h;p++){if(function(e){for(var t=!1,a=0;a<i.orderSubAttachments.length;a++){var n=i.orderSubAttachments[a];e.size==n.fileInfo.size&&e.name==n.fileInfo.name&&e.type==n.fileInfo.type&&(o(lanRes.visitor185),t=!0)}return t}(a.files[p]))return h-1===p&&(a.value=null),!1;if(a.files){if(!a.files[p]||!a.files[p].size){console.log("no file to send",u),a.value=null;continue}(a.files[p]||a.files[p].name)&&(u=a.files[p].name)}f=-1!=u.indexOf(".")?u.replace(/.*\./,""):"";var g=u.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1");if(i.sendingTitle=g+"."+f+lanRes.fileSendWait,verifyFile(f))a.value=null;else{if(i.getFileSize(a,p)>i.uploadFileSize)i.showDialog({tip:lanRes.fileSizeOut.replace("${maxSize}",i.uploadFileSize/1024/1024+"M"),cancel:!1}),i.handleFileSelect.error(),a.value=null;else{a.files&&(m=a.files[p]);var v=-1!==n.indexOf(f)?"4":-1!==s.indexOf(f)?"2":"0",b={},y=i.fileUploadInfos.array;!function(a){i.orderSubAttachments.push({fileInfo:m}),4==v?function(e,t){if(t&&e&&e.type.indexOf("image/")>-1){var i=new FileReader;i.onload=function(i){t({file:e,base64:i.target.result})},i.readAsDataURL(e)}else t&&t(null)}(m,function(e){e&&t(e.base64,e.file.name,a)}):t("",m.name,a),20===i.orderSubAttachments.length&&e(".order-upload-button").hide()}(i.orderSubAttachments.length),view.hideMenus&&view.hideMenus(0,!1)}}}},a.onclick=function(){view.hideMenus(),i.sendingFileToken}},getElementByFieldType:function(e,t,i,a){function n(e,t){for(var i=0;i<e.length;i++)if(e[i]==t)return!0;return!1}var o="",s={type1:'<input type="text" class="entry2-input {{req}}" maxlength="{{length}}" placeholder="{{wordDesc}}" lb="{{configDesc}}" name="{{configName}}" value="{{value}}"/>',type6b:'<input type="date" class="entry2-input {{req}}" placeholder="{{wordDesc}}" lb="{{configDesc}}" name="{{configName}}" value="{{value}}"/>',type6:'<div class="date-input-box"><input type="text" lb="{{configDesc}}" placeholder="{{wordDesc}}" value="{{value}}" class="entry2-input date-show"/><input type="date" lb="{{configDesc}}" placeholder="{{wordDesc}}" name="{{configName}}" value="{{value}}" class="entry2-input date-input"/><span class="date-select-icon echat-vs color0">&#xe638;</span></div>',type2:'<textarea class="entry2-textarea {{req}}" maxlength="{{length}}" rows="4" placeholder="{{wordDesc}}" lb="{{configDesc}}" name="{{configName}}" autoHeight="true">{{value}}</textarea>',type4:'<div class="entry2-checkbox"><label><input name="{{configName}}" value="{{configs.value}}" inputvalue="{{configs.item}}" lb="{{configDesc}}" type="radio" {{check}} /><span class="entry2-checkicon color0"></span><span>{{configs.item}}</span></label></div>',type5:'<div class="entry2-checkbox"><label><input name="{{configName}}" value="{{configs.value}}" inputvalue="{{configs.item}}" lb="{{configDesc}}" type="checkbox" {{check}} /><span class="entry2-checkicon color0"></span><span>{{configs.item}}</span></label></div>',type3:'<option value="{{configs.value}}" inputvalue="{{configs.item}}" {{check}} >{{configs.item}}</option>',type7:'<option value="{{configs.value}}" inputvalue="{{configs.item}}" {{check}} >{{configs.item}}</option>'};if(o=s["type"+t],6==t&&(window.ltIE10||this.isMobile))o=s.type6b;else if(4==t||5==t||3==t||7==t){if(configs=e[i.configName].configs||[],o=[],a=a?a.split(","):a,3==t||7==t){if(7==t){for(var r=[],l=configs.start;l<=configs.end&&(r.push({item:l,value:l}),150!=r.length);l+=configs.stepSize);configs=r||[]}o.push('<select class="entry2-select {{req}}" name="{{configName}}" lb="{{configDesc}}"><option value="">{{wordDesc}}</option>')}for(var c=0;c<configs.length;c++)o.push(s["type"+t].replace(/\{\{configs.item\}\}/g,this.escapeHtml(configs[c].item)).replace("{{configs.value}}",configs[c].value).replace("{{check}}",a&&n(a,configs[c].value)?3==t||7==t?"selected":"checked":""));3!=t&&7!=t||o.push("</select>"),o=o.join("")}else 1!=t&&2!=t||(o=o.replace("{{length}}",(d[i.configName]||d[1==t?"text":"textarea"]).length));return o},toShowEntry:function(i,a){e(window).on("resize",function(){var e=t.activeElement;"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||setTimeout(function(){e.scrollIntoViewIfNeeded()},100)});var n,o,s,l,d,c=this,u="",f="",m=[],h={},p=!1,g=i.fieldSettings||[],v=i.buzFieldSettings||[],b=c.msg600.lan||i.lan||"default",y=decodeURIComponent(e.store("ECHAT_"+c.companyId+"_ENTRY_HIS")||"{}");if(!view.SDKNative&&c.addCSS(c.isMobile&&!view.dji?__uri("/visitor/common/css/entry2.css"):__uri("/visitor/common/css/entry2pc.css")),e("#entry").remove(),view.dji&&1==i.entranceLevel)return!1;if(y=JSON.parse(y),1!=i.entranceLevel&&!0===c.companyOff&&0==i.offlineStartType&&(i.entranceLevel=1,p=!0,g=[{enable:1,field:"gender",fieldId:7106,isSystem:1,label:"性别",lan:"default",settings:[{configs:[{item:lanRes.male,sort:1,value:"1"},{item:lanRes.female,sort:2,value:"2"}],lan:"default"}],type:4,configs:[{item:lanRes.male,sort:1,value:"1"},{item:lanRes.female,sort:2,value:"2"}]},{enable:1,field:"maritalStatus",fieldId:7107,isSystem:1,label:"婚否",lan:"default",settings:[{configs:[{item:lanRes.married,sort:1,value:"2"},{item:lanRes.unmarried,sort:2,value:"1"}],lan:"default"}],type:4,configs:[{item:lanRes.married,sort:1,value:"2"},{item:lanRes.unmarried,sort:2,value:"1"}]},{enable:1,field:"age",fieldId:7109,isSystem:1,label:"年龄",lan:"default",settings:[{configs:{end:127,start:1,stepSize:1},lan:"default"}],type:7,configs:{end:127,start:1,stepSize:1}},{enable:1,field:"birthday",fieldId:7108,isSystem:1,label:"生日",settings:[],type:6}],i.upgradeOfflineVisitorInfoConfiguration=i.offlineVisitorInfoConfiguration,i.upgradeOfflineWelcomeWord=i.offlineWelcomeWord),1==i.entranceLevel){var w='<div class="entry2-item"><div class="entry2-label {{req}}"><span class="req-span">*</span><span class="entry2-name">{{configDesc}}:</span></div><div class="entry2-typeline {{req}}" lb="{{configDesc}}">{{typeline}}</div></div>';l=(s=!0===c.companyOff?i.upgradeOfflineVisitorInfoConfiguration:i.upgradeVisitorInfoConfiguration)&&s.length||0,!0===c.companyOff&&(i.upgradeVisitorInfoSubmitTxt=i.upgradeOfflineVisitorInfoSubmitTxt,i.upgradeWelcomeWord=i.upgradeOfflineWelcomeWord),m.push(1!=view.windowType||view.dji?"entry2-mb":"entry2-pc"),!c.isMobile&&c.mini&&m.push("entry2-pc-mini"),m.push(!0===c.companyOff&&0==i.offlineStartType?"entry2-form":"entry2-half");for(var I=h,T=g.concat(v),k=0;k<T.length;k++)if(R=I[T[k].field]=T[k],R=T[k],o=null,R.settings&&R.settings.length>0)if(1==R.settings.length)R.configs=R.settings[0].configs;else{for(var S=0;S<R.settings.length;S++){if(R.settings[S].lan==b){R.configs=R.settings[S].configs;break}"default"==R.settings[S].lan&&(o=R.settings[S].configs)}!R.configs&&(R.configs=o||R.settings[0].configs)}for(var C=0;C<l;C++)if(0==(n=s[C]).configWebVipVisitor&&c.isVip||0==n.configWebVisitor&&!c.isVip)n.disabled=!0;else{if(!h[n.configName]){if(!p){n.disabled=!0;continue}h[n.configName]={type:1}}var x=h[n.configName].type,_=y[n.configName];u=c.getElementByFieldType(h,x,n,_),f+=w.replace("{{typeline}}",u).replace(/\{\{configName\}\}/g,n.configName).replace(/\{\{configDesc\}\}/g,n.configDesc).replace(/\{\{wordDesc\}\}/g,"").replace(/\{\{value\}\}/g,_||"").replace(/\{\{req\}\}/g,1==n.configRequired?"req":"")}return!0===c.companyOff&&0==i.offlineStartType&&(f+=w.replace(/\{\{req\}\}/g,"req").replace(/\{\{configDesc\}\}/g,lanRes.leaveWordContent).replace("{{typeline}}",'<textarea rows="4" lb="'+lanRes.leaveWordContent+'" autoHeight="true"  class="entry2-textarea leave-entry-text req"></textarea>')),1==i.captChaEnable&&(f+=w.replace(/\{\{req\}\}/g,"req").replace(/\{\{configDesc\}\}/g,lanRes.validateCode).replace("{{typeline}}",'<input type="text" id="verify_input" lb="'+lanRes.validateCode+'" class="entry2-input entry2-input-code req" /><img alt="'+lanRes.validateCode+'" id="verify_img" src="'+c.dataHost+"/chatCaptCha.jpg?captChatToken="+a.captChaToken+'"/><span class="color0 cursor-p" id="verify_change">'+lanRes.nextPic+"</span>"),e(".verify-change").attr("id",""),e(".verify-img").attr("id",""),e(".verify-ok").attr("id",""),e(".verify-input").attr("id","")),f='<div id="entry" class="{{entryClass}}"><form id="entryForm" class="entry2-wrap"><div class="entry2-title bg0">{{upgradeWelcomeWord}}</div><div class="entry2-content"><div class="entry2-items">{{list}}</div>{{btns}}</form></div>'.replace("{{entryClass}}",m.join(" ")).replace("{{list}}",f).replace("{{upgradeWelcomeWord}}",i.upgradeWelcomeWord).replace("{{btns}}",1!=view.windowType||view.dji||!0!==c.companyOff||0!=i.offlineStartType?'<div class="entry2-submit"><div class="entry2-btn-submit bg0">{{upgradeVisitorInfoSubmitTxt}}</div></div></div>':"").replace("{{upgradeVisitorInfoSubmitTxt}}",!0===c.companyOff&&0==i.offlineStartType?lanRes.submit:i.upgradeVisitorInfoSubmitTxt).replace("{{close}}",lanRes.close).replace("{{submit}}",lanRes.submit),!0===c.companyOff&&0==i.offlineStartType?(c.leaveAndClose=!0,view.showLeavePage?view.showLeavePage(i):function(t,a){e(".verify-change").attr("id",""),e(".verify-img").attr("id",""),e(".verify-ok").attr("id",""),e(".verify-input").attr("id",""),1!=view.windowType||view.dji?e("body").append(t):e("#leave").html(t).removeClass("hide"),c.publish("removeLoading"),c.isMobile||1!=view.windowType||view.dji?e("#container").addClass("hide"):(e("#chat").addClass("hide"),e(".btn-close").addClass("hide"),setTimeout(function(){e(".btn-close").addClass("hide")},100)),e("html").addClass("page-leave entry2"),e("#footer").addClass("hide"),setTimeout(function(){e("#mask").hide()},100),view.toLeaveMessage&&view.toLeaveMessage(),c.addEntryEvent({list:s,configData:i,submitSelector:a,crm20:h}),c.resetOptionField(s,v,"entrance")}(f,1!=view.windowType||view.dji||!0!==c.companyOff||0!=i.offlineStartType?".entry2-btn-submit":".leave-enter-btn"),e("textarea[autoHeight]").autoHeight(),!0):(e("body").append(f),e("html").addClass("entry2"),c.resetOptionField(s,v,"entrance"),c.addEntryEvent({list:s,configData:i,submitSelector:".entry2-btn-submit",crm20:h}),e(".entry2-btn-close").on("click",function(e){c.visitorClose=!1,c.publish("_endChat"),c.publish("chatEnded",{}),(c.hasEntryOrCode||"0"==c.queryParams.autoChat)&&(c.publish("entryCallback",{success:!0}),c.publish("_endConnect")),delete c.queryParams.autoPop,delete c.queryParams.autoChat}),c.publish("removeLoading"),e("#mask").show(),e("textarea[autoHeight]").autoHeight(),!0)}l=(s=(!0===c.companyOff?i.offlineVisitorInfoConfiguration:i.visitorInfoConfiguration)||[])&&s.length||0,d=1!=i.captChaEnable&&r(s),c.needHttps&&i.visitorInfoBackImg&&(i.visitorInfoBackImg=i.visitorInfoBackImg.replace(/^http:/,c.needHttps)),i=e.extend({},i),!0===c.companyOff&&(i.welcomeWord=i.offlineWelcomeWord,i.welcomeWordPos=i.offlineWelcomeWordPos,i.entryCanClose=i.offlineEntryCanClose,i.visitorInfoCloseImg=i.offlineVisitorInfoCloseImg,i.visitorInfoClosePos=i.offlineVisitorInfoClosePos,i.visitorInfoFormPos=i.offlineVisitorInfoFormPos,i.visitorInfoBackImg=i.offlineVisitorInfoBackImg,i.visitorInfoLabelColor=i.offlineVisitorInfoLabelColor,i.visitorInfoInputColor=i.offlineVisitorInfoInputColor,i.visitorInfoSubmitPos=i.offlineVisitorInfoSubmitPos,i.visitorInfoSubmitTxt=i.offlineVisitorInfoSubmitTxt,i.buttonBackgroundColor=i.offlineButtonBackgroundColor,i.visitorInfoBackgroundColor=i.offlineVisitorInfoBackgroundColor,i.visitorInfoSubmitImg=i.offlineVisitorInfoSubmitImg),c.needHttps&&(i.visitorInfoCloseImg&&(i.visitorInfoCloseImg=i.visitorInfoCloseImg.replace(/^http:/,c.needHttps)),i.visitorInfoBackImg&&(i.visitorInfoBackImg=i.visitorInfoBackImg.replace(/^http:/,c.needHttps)),i.visitorInfoSubmitImg&&(i.visitorInfoSubmitImg=i.visitorInfoSubmitImg.replace(/^http:/,c.needHttps))),view.staticPx2rem&&(i.welcomeWordPos=i.welcomeWordPos&&view.staticPx2rem(i.welcomeWordPos),i.visitorInfoClosePos=i.visitorInfoClosePos&&view.staticPx2rem(i.visitorInfoClosePos),i.visitorInfoFormPos=i.visitorInfoFormPos&&view.staticPx2rem(i.visitorInfoFormPos),i.visitorInfoSubmitPos=i.visitorInfoSubmitPos&&view.staticPx2rem(i.visitorInfoSubmitPos));for(var E=' <div id="entryWrap" class="'+("1"==d?"book-all-line ":"")+'" >'+(1==i.entryCanClose&&i.visitorInfoCloseImg?'<div id="cancelEntryBtn" style="'+i.visitorInfoClosePos+'"><img src="'+i.visitorInfoCloseImg+'" onload="imgLoadResizeSelf(this)" /></div>':"")+(i.visitorInfoBackImg?'<div><img id="entryWrapImg" class="book-table-img hide" src="'+i.visitorInfoBackImg+'" onload="imgLoadResize(this,-1)" /></div>':"")+'<form id="entryForm" name="entryForm" class="book-items" ><div class="book-form-title" style="'+i.welcomeWordPos+'">'+(i.welcomeWord||"")+'</div> <div class="clearfix book-items-list" style="'+i.visitorInfoFormPos+';">',M=0,D=0,N=0,k=0;k<l;k++){var R,P=1==(R=s[k]).configRequired?" req ":"";if("1"==R.configInline?M=parseInt(M+1.5):M+=.5,"1"==R.configWebVipVisitor&&c.isVip||"1"==R.configWebVisitor&&!c.isVip){"1"==R.configInline?D=parseInt(D+1.5):D+=.5,0;var L=R.configName,_=y[L],x=window.ltIE10?"text":"birthday"==L?"date":"age"==L?"number":"text";E+='<div class="book-half book-item'+P+("1"==R.configInline?" book-one-line":"")+("gender"==L||"maritalStatus"==L?" book-item-opts":"")+'"><label class="book-label" style="color:'+i.visitorInfoLabelColor+'"><span class="req-span color0">*</span><span class="name-span">'+R.configDesc+"</span></label>"+("gender"==L?'<label class="input-radio-lb" style="color:'+i.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+P+'" name="gender" value="1" '+(1==_?'checked="checked"':"")+' lb="'+R.configDesc+'"/><span class="radio-span">'+lanRes.male+'</span></label><label class="input-radio-lb" style="color:'+i.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+P+'" name="gender" value="2" '+(2==_?'checked="checked"':"")+' lb="'+R.configDesc+'" /><span class="radio-span">'+lanRes.female+"</span></label>":"maritalStatus"==L?'<label class="input-radio-lb" style="color:'+i.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+P+'" name="maritalStatus" value="1" '+(1==_?'checked="checked"':"")+' lb="'+R.configDesc+'"/><span class="radio-span">'+lanRes.unmarried+'</span></label><label class="input-radio-lb" style="color:'+i.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+P+'" name="maritalStatus" value="2" '+(2==_?'checked="checked"':"")+' lb="'+R.configDesc+'"/><span class="radio-span">'+lanRes.married+"</span></label>":'<input type="'+x+'" lb="'+R.configDesc+'" class="book-ipt '+P+'" name="'+L+'" value="'+(_||"")+'" style="border-bottom-color:'+i.visitorInfoInputColor+";color:"+i.visitorInfoInputColor+';"/>')+"</div>"}else s[k].disabled=!0,N++}if(1==i.captChaEnable&&(E+='<div class="clearfix"><div class="book-half book-item req" id="verifyInner"><label class="book-label" style="color:'+i.visitorInfoLabelColor+'"><span class="req-span color0">*</span><span class="name-span">'+lanRes.validateCode+'</span></label><input type="text" id="verify_input" class="book-ipt req" lb="'+lanRes.validateCode+'" style="border-color:'+i.visitorInfoInputColor+'"/></div><div class="book-half book-item verify-line"><img alt="'+lanRes.validateCode+'" id="verify_img" src="'+c.dataHost+"/chatCaptCha.jpg?captChatToken="+a.captChaToken+'"/><span class="color0 cursor-p" id="verify_change">'+lanRes.nextPic+"</span></div></div>",e(".verify-change").attr("id",""),e(".verify-img").attr("id",""),e(".verify-ok").attr("id",""),e(".verify-input").attr("id","")),E+="</div>",E+='<div id="submitBtnentry" style="'+i.visitorInfoSubmitPos+'" class="book-btn"> <span class="book-btn-text">'+(i.visitorInfoSubmitTxt||"")+"</span></div>",E+="</form></div>",e("body").append('<div id="entry" class="entry-wrap">'+E+"</div>").show(),1==view.windowType&&(M=parseInt(M+.5),D=parseInt(D+.5),N=M-D),N>0&&setTimeout(function(){e(".book-items-list").css("paddingBottom",view.px2rem?view.px2rem(30*N):30*N+"px")},10),c.publish("removeLoading"),e("#mask").show(),e("body").addClass("entry"),i.visitorInfoSubmitImg&&!view.SDK){c.needHttps&&(i.visitorInfoSubmitImg=i.visitorInfoSubmitImg.replace(/^http:/,c.needHttps));var H=new Image;H.onload=function(){var e=_$("submitBtnentry").style;e.backgroundImage="url('"+i.visitorInfoSubmitImg+"')",e.backgroundSize=(view.px2rem?view.px2rem(this.width):this.width+"px")+" "+(view.px2rem?view.px2rem(this.height):this.height+"px"),e.lineHeight=view.px2rem?view.px2rem(this.height):this.height+"px",e.height=view.px2rem?view.px2rem(this.height):this.height+"px",e.width=view.px2rem?view.px2rem(this.width):this.width+"px",e=null,H=null},H.src=i.visitorInfoSubmitImg}return e("#cancelEntryBtn").on("click",function(e){var t=c.hasEntryOrCode;c.visitorClose=!1,c.publish("_endChat"),c.publish("chatEnded",{}),(t||"0"==c.queryParams.autoChat)&&(c.publish("entryCallback",{success:!0}),c.publish("_endConnect")),delete c.queryParams.autoPop,delete c.queryParams.autoChat}),c.addEntryEvent({list:s,configData:i,submitSelector:"#submitBtnentry"}),setTimeout(function(){var e=_$("entryForm").offsetHeight+(view.px2px?view.px2px(20):20)+_$("entryForm").offsetTop;_$("entry").style.minHeight=e+"px"},100),!0},orderSubAttachments:[],orderFileIndexObj:{},addOrderSubmitEvent:function(t,i){function o(i){if(i.stopPropagation(),d)return!1;for(var o,c,u,f,m=l,h={},p=!0,g=0,v=t.length;g<v;g++)if(o=null,label="",I=t[g],u=I.configName,c=m[u],!t[g].disabled&&c){if(f=a(m,c,u),o=f.val,!(p=n(c,o,u,function(t){c.nodeType?t?e(c).removeClass("error"):e(c).addClass("error"):c[0]&&c[0].nodeType&&e(c[0].parentNode.parentNode).addClass("error")})&&p))return!1;o&&p&&f.label+" "+f.labelVal+"\r\n ","1"!=t[g].configType&&"2"!=t[g].configType||"title"===u||(o=r.escapeHtml(o)),h[u]=o}if(view.handleNetwok&&view.handleNetwok())return!1;var b=r.msg649&&r.msg649.jobWindowInfo||{};h.eventId=r.msg649.eventId,h.routeId=r.msg649.routeId,h.token=b.token,h.nonce=b.nonce,h.styleId=r.msg649.styleId,h.jobTemplateId=r.msg649.jobWindowInfo.jobTemplateId,h.requesterLan=r.msg600.lan,h.echatTag=r.paramChat.echatTag||"",h.metaData=r.paramChat.metaData||"",h.myData=r.paramChat.myData||"",h.chatDomain=r.paramChat.referrer||"",h.firstUrl=r.paramChat.firstUrl||"",h.firstUrlTitle=r.paramChat.firstTitle||"",h.recordUrl=r.paramChat.chatPage||"",h.recordUrlTitle=r.paramChat.chatPageTitle||"",h.referrer=r.paramChat.referrer||"",h.robotInfoId=r.workOrder2RobotTalkId||"",h.media=view.SDK?4:1,h=function(e){for(var t in e)""===e[t]&&delete e[t];return e}(h);var y=!0;if(view.SDKNative&&view.orderUploadData.length>0){h.attachments=[],r.orderSubAttachments=[];var w;for(T in view.orderUploadData)(I=view.orderUploadData[T])&&I.index&&I.data?(w={type:1,fileValue:{url:I.data.sourceUrl,name:I.data.fname||"",size:I.data.fsize,fileType:4==I.data.fileType?2:4,key:I.data.key,bucket:I.data.bucket}},h.attachments.push(w)):!I.data&&I.index&&(y=!1);h.attachments=JSON.stringify(h.attachments)}else if(r.orderSubAttachments.length>0){h.attachments=[];for(var I,T=0;T<r.orderSubAttachments.length;T++)(I=r.orderSubAttachments[T]).name=encodeURIComponent(I.name),I.fileValue?h.attachments.push({type:I.type,fileValue:I.fileValue}):y=!1;h.attachments=JSON.stringify(h.attachments)}if(r.paramChat.acdStaffId&&(h.acdStaffId=r.paramChat.acdStaffId),r.paramChat.acdType&&(h.acdType=r.paramChat.acdType),d=!0,y)return s(h,function(e){d=!!e}),!1;r.showDialog({tip:lanRes.visitor190,ok:function(){for(var e=0;e<r.orderSubAttachments.length;e++)r.orderSubAttachments[e].xhr&&r.orderSubAttachments[e].xhr.abort();s(h,function(e){d=!!e})},cancel:function(){d=!1}})}function s(t,i){var a="1"===r.msg649.jobWindowInfo.jobQRCodeEnable,n=r.msg649.jobWindowInfo.commitSuccessHint;t.companyId=r.companyId,t.requesterVisitorId=r.visitorId,e._ajax({url:r.apiServerDomain+"/chatapi/jobh/cmj",type:"post",data:t,contentType:"application/x-www-form-urlencoded; charset=UTF-8",success:function(e){if("string"==typeof e&&e.length>4)try{e=JSON.parse(e)}catch(e){}e.successful?(i&&i(!0),r.overOrderForm(e.result.data,a,n)):(i&&i(!1),r.showDialog({tip:e.errorMsg,cancel:!1}))}})}var r=this,l=_$("orderForm");1!=view.windowType?view.handleShowOrderSubmit&&setTimeout(function(){view.handleShowOrderSubmit()},15):view.toLeaveMessage&&setTimeout(function(){view.toLeaveMessage()},15),e(".entry2-input",l).bind("blur",function(){var e=this.name;n(this,a(l,this,e).val,e,function(e){})}),e("textarea",l).bind("blur",function(){n(this,this.value.replace(/^[\s]+|[\s]+$/gi,""),"textarea",function(e){})}),e("input",l).bind("change",function(){var e=this.name;n(this,a(l,this,e).val,e,function(e){})}),e("select",l).bind("change",function(){n(this,this.value,"select",function(e){})}),e(".date-input",l).bind("change",function(t){var i=e(".date-show",this.parentNode);i&&i.val(this.value)});var d=!1;_$("orderForm").onsubmit=o,e(i).off("click").bind("click",o)},overOrderForm:function(t,i,a){if(t.codeUrl){e("#orderSubmit")&&e("#orderSubmit").remove();var n=i?t.codeUrl:locationBase+"/res/imgs/"+(view.SDK?"order_sdk.png":"order_web.png"),o=i?"order-complete":"order-complete-auto",s=i?'<div class="tip2">'+lanRes.visitor184+"</div>":"";_html='<div id="orderSubmit"><div class="'+o+'"><img src="'+n+'" /><div class="tip1">'+a+"</div>"+s+"</div></div>",1==view.windowType?e("#leave").html(_html).removeClass("hide"):e("body").append(_html),e(".leave-entry-foot")&&e(".leave-entry-foot").remove()}},addEntryEvent:function(t,i){function o(t){if(c)return!1;for(var o,l,u,f,m=_$("entryForm"),h={windowType:view.windowType},p="",g=!0,v=0,b=s.length;v<b;v++)if(w=null,"",o=s[v],u=o.configName,l=m[u],!s[v].disabled){if(f=a(null,l,u),w=f.val,!(g=n(l,w,u,function(t){l.nodeType?t?e(l).removeClass("error"):e(l).addClass("error"):l[0]&&l[0].nodeType&&e(l[0].parentNode.parentNode).addClass("error")})&&g))return!1;w&&g&&(p+=f.label+" "+(f.inputValue||w)+"\r\n "),h[u]=w}if(console.log(p),view.handleNetwok&&view.handleNetwok())return!1;if(h.leaveContent=void 0,d.leaveAndClose){var y=e(".leave-entry-text").results[0];if(n(y,y.value,"content",function(t){y.nodeType&&(t?e(y).removeClass("error"):e(y).addClass("error"))}),!y.value)return!1}if(1==r.captChaEnable){if(e("#verify_change").hasClass("loadin"))return!1;var w;if(!(w=e("#verify_input").val()))return e("#verify_input").addClass("error"),!1;e("#verify_change").addClass("loadin"),h.captcha=w}return h.et=106,"1"==d.queryParams.autoPop&&(h.isAutoPop=1),c=!0,d.entryParam=h,d.entryVisitorMsg=p,d.entryLeaveContent=y&&y.value,d.publish("visitorCommonEvent",h,function(t){t&&t.successful&&i&&i(),1==r.captChaEnable&&e("#verify_change").removeClass("loadin"),c=!1}),!1}var s=t.list,r=t.configData,l=t.submitSelector,d=(t.crm20,this);1==r.captChaEnable&&d.toShowCode(),view.handleShowEntry&&setTimeout(function(){view.handleShowEntry()},15),e("input",_$("entryForm")).bind("blur",function(){var e=this.name;n(this,a(null,this,e).val,e,function(e){})}),e("textarea",_$("entryForm")).bind("blur",function(){n(this,this.value.replace(/^[\s]+|[\s]+$/gi,""),"textarea",function(e){})}),e("select",_$("entryForm")).bind("change",function(){n(this,this.value,"select",function(e){})}),e(".date-input",_$("entryForm")).bind("change",function(t){var i=e(".date-show",this.parentNode);i&&i.val(this.value)});var c=!1;_$("entryForm").onsubmit=o,e(l).off("click").on("click",o)},toShowCode:function(){function t(){if(!e("#verify_change").hasClass("loadin")){e("#verify_change").addClass("loadin");var t={et:122,windowType:view.windowType,content:"refresh code"};"1"==i.queryParams.autoPop&&(t.isAutoPop=1),i.publish("visitorCommonEvent",t)}}var i=this;this.codeShowed&&(e("#verify_change").removeClass("loadin"),e("#verify_input").removeClass("error").val("")),this.codeShowed=!0,e("#verify_img").off("click").bind("click",t),e("#verify_change").off("click").bind("click",t),e("#verify_input").off("click").bind("keydown",function(){e("#verify_input").removeClass("error")}),e("#verify_ok").off("click").bind("click",function(){if(!e("#verify_change").hasClass("loadin")){var t=e("#verify_input").val();if(t){e("#verify_change").addClass("loadin");var a={et:106,captcha:t,windowType:view.windowType};"1"==i.queryParams.autoPop&&(a.isAutoPop=1),i.publish("visitorCommonEvent",a,function(){})}else e("#verify_input").addClass("error")}})},toShowQcode:function(){function t(t){if(e("#qcode_loading").show(),e("#qcode_img").attr("loaded","loaded").hide(),t){var a=(i.dataHost||"")+"/cqr?"+(i.needHttps?"ssl=1&":"")+"chatToken="+t+"&cqrChatPage="+encodeURIComponent(window.location.pathname),n=new Image;n.onload=function(){e("#qcode_loading").hide(),e("#qcode_img").attr({loaded:"loaded",src:a}).show(),setTimeout(function(){e("#qcode_img").removeAttr("loaded"),i.publish("_toGetChatToken")},54e4)},n.onerror=function(t){e("#qcode_img").removeAttr("loaded")},n.src=a}else i.publish("_toGetChatToken")}var i=this;return view.qcodeWechat||(i.subscribe("getChatToken",function(e,i){t(i.chatToken)}),i.subscribe("_toGetChatToken",function(){i.publish("visitorCommonEvent",{et:120,companyId:i.companyId})})),view.toggleQcode&&view.toggleQcode(t),!0},toInitEvaluate:function(t){var i,a,n=this,s=!1,r=t.evaluateInfo||t.smallEvaluateInfo||t.mobileEvaluateInfo||t.sdkEvaluateInfo||n.msg649&&(n.msg649.evaluateInfo||t.smallEvaluateInfo||n.msg649.mobileEvaluateInfo||n.msg649.sdkEvaluateInfo);if(!r)return n.satisfyEnable=!1,void this.toggleEvaluateMenu(1);if(0==r.enable?(n.satisfyEnable=!1,this.toggleEvaluateMenu(6)):(this.toggleEvaluateMenu(5),n.satisfyEnable=!0,1==r.enableVisitorEvaluateLimit&&parseInt(r.allowEvaluateBaseWords)>0&&(n.allowEvaluateBaseWords=parseInt(r.allowEvaluateBaseWords),n.sendMsgNum<n.allowEvaluateBaseWords?this.toggleEvaluateMenu(3):this.toggleEvaluateMenu(4))),!this.hasInitEvaluate){n.hasInitEvaluate=!0,(a=(i=l=1==r.evaluateType)?1==r.bestEnable?5:1==r.betterEnable?4:1==r.commonEnable?3:1==r.worseEnable?2:1==r.worstEnable&&1:5)||(a=5,s=!0),e("#satisfy_ipt").val(a);var d='<div class="sa-title tc"><div class="sa-title-left"></div><div class="sa-title-content"><span langs="evaluateTip">'+lanRes.evaluateTip+'</span><span class="sa-name sa-name5 emcolor">'+n.stringEncode(r.bestDesc)+'</span><span class="sa-name sa-name4 emcolor">'+n.stringEncode(r.betterDesc)+'</span><span class="sa-name sa-name3 emcolor">'+n.stringEncode(r.commonDesc)+'</span><span class="sa-name sa-name2 emcolor">'+n.stringEncode(r.worseDesc)+'</span><span class="sa-name sa-name1 emcolor">'+n.stringEncode(r.worstDesc)+'</span></div><div class="sa-title-right"></div></div>';if(i&&!s?(d+='<ul class="sa-imgs clearfix">',1==r.worstEnable&&(d+='<li class="sa-img sa-img1" v="1"><img class="sa-s-img" v="1" src="'+r.worstSelected.replace(/^http:/,n.needHttps||"http:")+'"/><img class="sa-un-img" v="1" src="'+r.worstUnSelected.replace(/^http:/,n.needHttps||"http:")+'"/></li>'),1==r.worseEnable&&(d+='<li class="sa-img sa-img2" v="2"><img class="sa-s-img" v="2" src="'+r.worseSelected.replace(/^http:/,n.needHttps||"http:")+'"/><img class="sa-un-img" v="2" src="'+r.worseUnSelected.replace(/^http:/,n.needHttps||"http:")+'"/></li>'),1==r.commonEnable&&(d+='<li class="sa-img sa-img3" v="3"><img class="sa-s-img" v="3" src="'+r.commonSelected.replace(/^http:/,n.needHttps||"http:")+'"/><img class="sa-un-img" v="3" src="'+r.commonUnSelected.replace(/^http:/,n.needHttps||"http:")+'"/></li>'),1==r.betterEnable&&(d+='<li class="sa-img sa-img4" v="4"><img class="sa-s-img" v="4" src="'+r.betterSelected.replace(/^http:/,n.needHttps||"http:")+'"/><img class="sa-un-img" v="4" src="'+r.betterUnSelected.replace(/^http:/,n.needHttps||"http:")+'"/></li>'),1==r.bestEnable&&(d+='<li class="sa-img sa-img5 sa-sli5" v="5"><img class="sa-s-img" v="5" src="'+r.bestSelected.replace(/^http:/,n.needHttps||"http:")+'"/><img class="sa-un-img" v="5" src="'+r.bestUnSelected.replace(/^http:/,n.needHttps||"http:")+'"/></li>'),d+="</ul>"):d+='<ul class="sa-stars clearfix"><li class="sa-sli sa-star emcolor" v="1">&#xe64d;</li><li class="sa-sli sa-star emcolor" v="2">&#xe64d;</li><li class="sa-sli sa-star emcolor" v="3">&#xe64d;</li><li class="sa-sli sa-star emcolor" v="4">&#xe64d;</li><li class="sa-sli sa-star emcolor sa-sli5" v="5">&#xe64d;</li></ul>',!i||!s){d+='<div class="sub-tabs clearfix " >',view.SDK&&(d+="<div>");for(var c=["worstConfiguration","worseConfiguration","commonConfiguration","betterConfiguration","bestConfiguration"],u=5;u>0;u--){var f=r[c[u-1]]||[],m=f.length;d+='<ul class="sub-tab sub-tab'+u+'" '+(m>0?"":'style="display:none"')+' id="subEvaluate'+u+'"> ';for(var h=0;h<m;h++){var p=f[h];d+='<li class="sa-cli" dataname="'+p.configName+'">'+n.stringEncode(p.configDesc)+"</li>"}d+="</ul>"}view.SDK&&(d+="</div>"),d+="</div>"}e("#satisfyConfig").html(d).addClass("sa-sel-"+a).attr("default",a),view.handleSatisfy&&view.handleSatisfy(s,i,a),e("#sa_ok").on(n.isMobile&&!n.isPcXcx?"touchend":"click",function(t){if(view.handleNetwok&&view.handleNetwok())return!1;view.SDK&&e.store("ECHAT_inviteSatisfyHandle",e.store("ECHAT_inviteSatisfyId")),n.isMobile&&t.preventDefault();var i=n.stringEncode(e("#sa_advise").val()),a=e("#satisfy_ipt").val(),r="";if("0"!=a&&a){if(!s){var l=e(".sa-cli",_$("subEvaluate"+a)).results||[],d=l.length;if(d>0)for(var c=0;c<d;c++)r+="&"+[e(l[c]).attr("dataname")]+"="+(e(l[c]).hasClass("sub-selected")?1:0)}var u=n.dataHost+"/ces?companyId="+n.companyId+"&talkId="+n.talkId+(n.paramChat.metaData?"&metaData="+encodeURIComponent(n.paramChat.metaData):"")+"&encryptVID="+encodeURIComponent(window.encryptVID||n.encryptVID)+"&visitorId="+encodeURIComponent(n.visitorId||"")+(view.SDK?"&appId="+encodeURIComponent(n.appId||""):"")+"&mainItem="+a+"&evaluateType="+n.satisfyType+"&media="+n.Device.media+"&windowType="+view.windowType+"&lan="+(window.lanName||"")+"&comment="+encodeURIComponent(i||"")+r;console.log("url***",u),e.ajax({url:u,type:"jsonp",jsonpCB:"jsonpCallback",success:function(e){if(console.log(e),n.satisfyShowed=n.talkId,1==e)n.evaluateScore=a,o(lanRes.successSubmitEval,"ok"),view.resetSatisfy&&view.resetSatisfy(),!1===n.chatting?(n.publish("_closeWin"),n.publish("__evaluate","1-2",a+"-2")):n.publish("__evaluate","1-1",a+"-1"),i&&n.publish("__evaluateComment",{comment:i,chatting:n.chatting});else{var t=lanRes.unkownErrorSubmitEval;129==e?t=lanRes.evaluateTimeout:130==e?t=lanRes.evaluateRepeat:133==e&&(t=lanRes.evaluateRepeatTime),o(t)}},error:function(){o(lanRes.unkownErrorSubmitEval)}}),e("#satisfy").removeClass("satisfy-show").hide(),e("#mask").off("click",n.hideSatisfy),e("#mask").hide(),_$("sa_advise").blur(),view.hideSatisfy&&view.hideSatisfy()}}),e("#sa_cancel").on(n.isMobile&&!n.isPcXcx?"touchend":"click",function(e){n.hideSatisfy(),n.isMobile&&e.preventDefault()})}},toggleEvaluateMenu:function(t){if(view.decideEvalMenu){var i=!0;return 2!=t&&4!=t&&5!=t||(i=!1),view.decideEvalMenu(i)}var a=e(".menu-satisfy"),n="hide",o="limit-hide";1==t?a.addClass(n).removeClass("show"):2==t?a.removeClass(n):3==t?a.addClass(o):4==t?a.removeClass(o).removeClass(n):5==t?a.addClass("show").removeClass(n):6==t&&a.addClass(n),this.hasWaitingStatus&&a.addClass(n).removeClass("show"),view.calcUrlList&&view.calcUrlList()},stringEncode:function(e){var i=t.createElement("div");return i.innerText?i.innerText=e:i.textContent=e,i.innerHTML},htmlToText:function(e){var i=t.createElement("div");return i.innerHTML=e,i.innerText},staffMap:{},handleStaffMap:function(t,i){var a,n={};if(t&&t.length>0)for(var o=0;o<t.length;o++)t[o].staffHead&&this.needHttps&&(t[o].staffHead=t[o].staffHead.replace(/^http:/,this.needHttps)),n[t[o].staffId+""]={staffId:t[o].staffId,staffName:t[o].staffNickName||lanRes.serviceStaff,staffImg:t[o].staffHead||this.defaultStaffImg},!a&&(a=n[t[o].staffId+""]);this.staffMap=i?e.extend(n,this.staffMap):e.extend(this.staffMap,n)},updateStaffInfo:function(t,i){if(i&&i.staffId){var a={};return a[i.staffId]={staffId:i.staffId,staffName:i.staffNickName||lanRes.serviceStaff,staffImg:i.staffHead||i.staffDetailInfo&&i.staffDetailInfo.staffHead||this.defaultStaffImg},e.extend(this.staffMap,a),a[i.staffId]}},startChat:function(t,i){function a(){function e(e){n.publish("sendVisitorEvent",{et:104,content:e})}var t=n.getInput(!1),i=t;t=t.replace(/^[\n\r\s]+$/,""),n.typingMaxLength>0&&i.length>n.typingMaxLength&&(t=t.substr(0,n.typingMaxLength),i=i.substr(0,n.typingMaxLength)),t&&n.lastText!=t&&(n.lastText=t,n.plainText&&(i=n.plainTextToSendMsg(t)),1!=n.filterMsg&&3!=n.filterMsg||!i?e(i):n.filterAndSendToServer({},function(t,i,a){a||e(i)},i)),n.typingTimer=setTimeout(a,5e3)}var n=this;n.hasWaitingStatus=!1,n.companyOff=!1,"679"!=i.mt&&"686"!=i.mt&&i.talkId&&!0===this.chatting&&this.staffId!=i.staffId&&this.talkId==i.talkId&&this.publish("getSysMsg",{talkId:i.talkId,tm:i.tm,mt:"10001",staffId:i.staffId,staffName:i.staffNickName},i),i.staffDetailInfo&&e.store("ECHAT_"+window.companyId+"_"+window.chatVisitorId+"_staffHead",i.staffDetailInfo.staffHead||""),e.store("ECHAT_"+n.companyId+"_"+window.chatVisitorId+"_chatStatus",2),this.satisfyShowed!=i.talkId&&(this.satisfyShowed=0),n.talkId&&n.talkId!=i.talkId&&(n.lastTalkIdForTemp=n.talkId),this.chatting=!0,i.talkId&&(this.talkId=i.talkId),"679"!=i.mt&&(this.staffId=i.staffId,this.staffName=i.staffNickName),this.paramChat.talkId=this.talkId,this.paramChat.staffId=this.staffId,this.paramChat.staffName=this.staffName,n.initQcode(),delete n.queryParams.autoPop,delete n.queryParams.autoChat,e("#busyTipLine").addClass("hide").hide(),i.staffDetailInfo&&n.publish("staffInfo",i),n.publish("__chatStatus","chatting"),1==i.startType&&n.publish("__chatStart",i.staffNickName),n.lastTalkIdForTemp&&(n.lastTalkIdForTemp!=n.talkId&&n.handleSessionMsg({talkId:n.lastTalkIdForTemp}),n.lastTalkIdForTemp=void 0),e(".menu-capture").removeClass("hide"),e(".menu-file").removeClass("hide"),this.publish("entryCallback",{success:!0}),this.endChatEvent(),n.lastText=null,n.typingTimer=setTimeout(a,5e3),this.subscribe("getMsgTyping",function(e,t){n.showTyping()}),this.subscribe("staffStatus",function(e,t){if(1!=t.status){n.publish("_staffEndChat",t);var i=new Date;this.showMsg({f:"s",t:n.checkHistoryTime(i.getTime())?i.format("hh:mm"):void 0},lanRes.staffLeaveEnd)}})},getADURL:function(e,t,i,a,n,o){if(!i)return"";if(!e||"0"==e||!t)return i;a=a||this.paramChat;var s="",r="",l="",d=i.split("#"),c=d[1]||"",u=d[0],f=-1==u.indexOf("?")?0:1,m="?";"string"==typeof t&&(t=JSON.parse(t));var h,p,g,v,b,y=["companyId","visitorId","echatTag","lan","country","province","city","searcher","keyword","metaData","formData","myData","referrer","firstUrl","chatPage","chatPageTitle","eventId","osName","talkId","staffId","staffName","staffPhoto","staffPhone","staffInfo"],w=0;if(view.chat.isArray(t)&&t.length){for(h=t.length,g=0;g<y.length&&("staffId"==(v=y[g])&&(r=s,s="",n&&(m="",f=c?1:0)),"staffId"!=v||a.staffId);g++)for(p=0;p<h;p++)if("metaData"!=(b=t[p].paramName)&&"metadata"!=b||(b="metaData"),"formData"!=b&&"formdata"!=b||(b="formData"),b==v){"metaData"==b?(w=1,s+=(0!=f?"&":m)+b+"="+encodeURIComponent(a[b]||""),b="myData",s+=(0!=++f?"&":m)+b+"="+encodeURIComponent(a[b]||""),f++,a[b="info"]&&(s+=(0!=f?"&":m)+b+"="+encodeURIComponent(a[b]||""),f++)):"myData"==b?w||(s+=(0!=f?"&":m)+b+"="+encodeURIComponent(a[b]||""),f++):"staffId"==b?(s+=(0!=f?"&":m)+b+"="+("-1"==encodeURIComponent(a[b]||"")?"":encodeURIComponent(a[b]||"")),f++):(s+=(0!=f?"&":m)+b+"="+encodeURIComponent(a[b]||""),f++);break}y.length==g&&(l=s,s="")}return n?u+r+(c?"#"+c+l:"#"+l):u+r+l+(c?"#"+c:"")},setInnerAD:function(t){function i(){var i=e("#portrait").height();1==r.chatBoxAdImgLinkFixed&&(i+=3==r.chatBoxInnerAdType?0:e(".innerAD").height()),t.height(i)}if(t.data){var a,n,o,s,r=t.data,l=r.chatBoxAdHeight;l=l?parseInt(l):0,e(".innerAD").each(function(){e("#list_msg").contains(this)||e(this).remove()}),e("#innerADWrap").addClass("hide"),2==r.chatBoxInnerAdType?(a=r.chatBoxInnerAdContent)&&(n='<li class="clearfix innerAD innerAD-text"><div>'+a+"</div></li>"):3==r.chatBoxInnerAdType&&l?((a=r.chatBoxInnerAdImg)&&view.chat.needHttps&&(a=a.replace(/^http:/,view.chat.needHttps)),this.lastLoadInnerImgName=s=(new Date).getTime(),window["resetInnerAdHeight"+s]=function(i,a,n){if(n==view.chat.lastLoadInnerImgName){var o=(a>i?i:a)+20;1==r.chatBoxAdImgLinkFixed?(e("#innerADWrap").css("height",o+"px"),t.height(e("#portrait").height()+o)):t.height(e("#portrait").height())}},a&&r.chatBoxInnerAdImgLinkUrl?(o=this.getADURL(r.chatBoxAdPostEnable,r.chatBoxInnerAdPostParamList||"{}",r.chatBoxInnerAdImgLinkUrl,view.chat.paramChat,1!=r.chatBoxInnerAdParamAppendType),n='<li class="clearfix innerAD innerAD-img"><a id="innerADLink" target="'+(1==r.chatBoxInnerAdImgLinkOpenType?view.SDK?"cover":"_blank":"inner")+'" href="'+o+'"><img onload="resetInnerAdHeight'+s+"(this.height,"+l+","+s+')" onerror="resetInnerAdHeight'+s+"(this.height,"+l+","+s+')" style="max-height:'+l+'px" src="'+a+'"/></a></li>',e.extend(this.staffInfoRefreshMap.innerImgUrl,{notEnableParam:1!=r.chatBoxAdPostEnable,srcUrl:r.chatBoxInnerAdImgLinkUrl,url:a,params:r.chatBoxInnerAdPostParamList||"{}",hash:1!=r.chatBoxInnerAdParamAppendType,element:"#innerADLink"})):a&&(n='<li class="clearfix innerAD innerAD-img"><img onload="resetInnerAdHeight'+s+"(this.height,"+l+","+s+')" style="max-height:'+l+'px" src="'+a+'"/></li>')):1==r.chatBoxInnerAdType&&l&&((a=r.chatBoxInnerAdUrl)&&view.chat.needHttps&&(a=a.replace(/^http:/,view.chat.needHttps)),(a=this.getADURL(r.chatBoxAdPostEnable,r.chatBoxInnerAdPostParamList||"{}",r.chatBoxInnerAdUrl,view.chat.paramChat,1!=r.chatBoxInnerAdParamAppendType))&&"0"!=r.chatBoxAdHeight&&(n='<li class="clearfix innerAD innerAD-url"><iframe id="inner_frame" class="ps-child" height="'+r.chatBoxAdHeight+'px" border="0" allowtransparency="true" scrolling="no" frameborder="0" style="width:100%;height:'+r.chatBoxAdHeight+'px" '+(this.msg649&&this.msg649.unreadMsgNumber?'src="'+view.chat.addEchatInnerFrameParam(a):"")+'" ></iframe></li>'),e.extend(this.staffInfoRefreshMap.innerAD,{notEnableParam:1!=r.chatBoxAdPostEnable,srcUrl:r.chatBoxInnerAdUrl,url:a,params:r.chatBoxInnerAdPostParamList||"{}",hash:1!=r.chatBoxInnerAdParamAppendType,element:"#inner_frame"})),n&&(1==r.chatBoxAdImgLinkFixed?e("#innerADWrap").html(n).removeClass("hide"):e("#list_msg").append(n),2==r.chatBoxInnerAdType&&(setTimeout(i,1e3),setTimeout(i,5e3))),i(),this.calcInnerADHeight=i}},sendMsgNum:0,sendToServer:function(t,i,a){function n(t,n,r,l){var d=t.id;t.hide||(delete t.hasResend,t.c=t.localMsg||t.c,o.showMsg(t)),r?o.pushHistory(t):"0"!=o.queryParams.autoChat&&(t.hide||e(".msg-con",_$(d)).append('<div class="msg-error" dataid="'+d+'">&nbsp;</div>'),delete t.id,s=n||(s||t.c||t.content),o.publish("sendVisitorEvent",t.data&&t.data.et?e.extend(t.data,{bridgeMsgId:t.bridgeMsgId,img:i?1:void 0,publishAck:t.publishAck||void 0}):{et:o.isInRobot?130:105,content:s,bridgeMsgId:t.bridgeMsgId,img:i?1:void 0,publishAck:t.publishAck||void 0,tm:view.SDK?(new Date).getTime():void 0},function(i,n){if(i.successful){t.talkId=o.talkId;var r=_$(d)||_$(i.mid)||_$(t.tm);if(i.mid&&(t.mid=i.mid||t.mid,o.lasMid<t.mid&&(o.lasMid=t.mid),t.mid&&d!=t.mid&&(e(r).attr("id",t.mid),t.id=t.mid)),a)try{a(i)}catch(e){}if(!t.hide)if(e(".msg-error",r).remove(),e("img",r).each(function(){e(this).attr("src",e(this).attr("src"))}),t.data&&126==t.data.et){var l=_$(d);l&&((l=l.previousElementSibling)&&l.childNodes[0]&&-1!=(l.childNodes[0].className+"").indexOf("color1")&&e(l).remove(),e("#"+d).remove(),view.scrollUpdate&&view.scrollUpdate())}else o.pushHistory(t);delete o.errorList[d],t=null}else t.c=s,o.errorList[d]=t,t.hide||(t.publishAck=i,e(".msg-error",r).addClass("resend")),n&&n()}))}var o=this,s=i||(t.c||t.content);t.visitorImg=o.visitorImg||o.defaultVisitorImg,o.isInRobot?t.ff="r":t.f=t.f||"c",t.filterMsg&&s&&!t.localMsg?(t.localMsg=t.c,o.filterAndSendToServer(t,n,s)):n(t,i);(s=t.c||t.content)&&o.publish("__visitorSendMsg",s.replace(o.regEmo,"[face]")),s&&o.publish("__visitorStartSendMsg",s.replace(o.regEmo,"[face]")),o.isInRobot&&(e("#input_suggest").addClass("hide").html(" "),view.resetContainerBaseFoot&&view.resetContainerBaseFoot())},filterAndSendToServer:function(e,t,i){var a=this;e.id||(console.log("error :send msg has no id"),e.id=(new Date).getTime()+""),this.processMsg.sendMsgMap[e.id]=function(i,n){n&&(e.localMsg=n),a.processMsg.processNum--,t(e,i,!i)},this.processMsg.processNum++,this.publish("__sendFilter",{msgId:e.id,sendMsg:i})},firstHistoryTime:(new Date).getTime(),checkHistoryTime:function(e){return this.firstHistoryTime,!this.lastHistoryTime||e-this.lastHistoryTime>6e4?(this.lastHistoryTime=e,!0):(e-this.firstHistoryTime<-6e4||e-this.firstHistoryTime>6e4)&&(this.firstHistoryTime=e,!0)},endChatEvent:function(){this.typingTimer&&clearInterval(this.typingTimer);this.unSubscribe(["staffStatus","getMsgTyping","inviteBook","inviteBookOK"])},clearShowTyping:function(){this.serviceTypingTimer&&clearInterval(this.serviceTypingTimer),e("#serviceTypingLine").addClass("hide-important"),e("#header").removeClass("typing"),2==view.windowType&&e("#qcode").removeClass("hide-important")},showTyping:function(){function i(){a.serviceTypingTime>5&&a.clearShowTyping();var t=n;a.serviceTypingTime++,e("#serviceTypingLine").html(t)}var a=this,n=lanRes.staffInput;this.clearShowTyping(),this.serviceTypingTime=0,i(),this.serviceTypingTimer=setInterval(i,500);var o=_$("serviceTypingLine");o||((o=t.createElement("div")).className="typing-line",o.id="serviceTypingLine",o.innerHTML=n+"&nbsp;.&nbsp;.&nbsp;.&nbsp;",a.isMobile?e("#staffName").append(o):(view.windowType,_$("header").insertBefore(o,_$("logoNormal")))),2==view.windowType&&e("#qcode").addClass("hide-important"),e("#serviceTypingLine").removeClass("hide-important"),e("#header").addClass("typing")},regMail:/\b\w{1,30}([\.-]\w{1,30}){0,10}@\w{1,30}([\.-]\w{1,20}){0,10}(\.\w{1,20}){0,10}\b/g,regPhone:/([^\d]|\b)((\d{11})|((\d{7,8})|(\d{4}|\d{3})[\-\s](\d{7,8})|(\d{4}|\d{3})[\-\s](\d{7,8})[\-\s](\d{4}|\d{3}|\d{2}|\d{1})|(\d{7,8})[\-\s](\d{4}|\d{3}|\d{2}|\d{1})))(?=[^\d]|\b)/gi,regLink:/((http|ftp|https):\/\/)(([\w\._\-]+\.[a-zA-Z]{2,6})|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,4})?(\/[\w,\&%_\!\*\(\)\'\;\:\@\=\+\.\/\[-~\-#\?]*)?/gi,filterEmailPhoneLink:function(e){var t=this.isMobile;return"string"!=typeof e||e.match(/(msg\-tel)|(msg\-link)|(msg\-mail)/)?e:(this.regPhone.lastIndex=0,this.regMail.lastIndex=0,this.regLink.lastIndex=0,(e=e.replace(this.regLink,function(e){var i=arguments.length,a=arguments[i-2];if(a>0){var n=arguments[i-1].substring(0,a);if(n=n.replace(/\<a[^>]*>([\s\S]*?)([^<]+(\<\/a\>))/g,""),/(\<(a|img|link|iframe|script)[^>]*>([^<]+(?!\<\/a\>))?)|(\<[a-zA-Z]+[^>]*$)/gi.test(n))return e}return t?'<a class="msg-link" href="'+e+'" target="visitorSiteIframe">'+e+"</a>":'<a class="msg-link" target="_blank" href="'+e+'">'+e+"</a>"})).indexOf("@")>1&&(e=e.replace(this.regMail,function(e){var t=arguments.length,i=arguments[t-2];if(i>0){var a=arguments[t-1].substring(0,i);if(/(\<(a|img|link|iframe|script)[^>]*>[^<]+(?!\<\/a\>)$)|(\<[a-zA-Z]+[^>]*$)/gi.test(a))return e}return'<a class="msg-mail" target="_blank" href="mailto:'+e+'">'+e+"</a>"})),e=e.replace(this.regPhone,function(e,i){var a=arguments.length,n=arguments[a-2];if(n>0){var o=arguments[a-1].substring(0,n+1);if(/(\<(a|img|link|iframe|script)[^>]*>[^<]+(?!\<\/a\>)$)|(\<[a-zA-Z]+[^>]*$)/gi.test(o))return e}var s=i,r=e.replace(/^[^\d]|\b/,"");return(s||"")+(t?'<a class="msg-tel" href="tel:'+r+'">'+r+"</a>":'<span class="msg-tel">'+r+"</span>")}))},updateMsg:function(t,i,a){var n=_$(t);n&&(e(".msg-item",n).html(i),a&&a.newId&&e(n).attr("id",a.newId))},showLocation:function(e){var t="https://restapi.amap.com/v3/staticmap?location="+(e.locationY||e.y)+","+(e.locationX||e.x)+"&zoom="+(e.scale||15)+"&size=400*200&key=5349312538cf80d1f6c008eb059b732c&markers=mid,,A:"+(e.locationY||e.y)+","+(e.locationX||e.x),i='<div class="msg-map"><a target="'+(view.SDK?"cover":"_blank")+'" href="http://uri.amap.com/marker?position='+(e.locationY||e.y)+","+(e.locationX||e.x)+"&name="+encodeURIComponent(e.label)+'&coordinate=gaode"><div class="msg-map-title"><div>'+e.label+'</div><div class="msg-map-addr">'+(e.address||"")+'</div></div><img onerror="view.imgError&&view.imgError(this)" onload="view.scrollToBottom()" class="view_img" src="'+t+'" draggable="false"/></a></div>',a={data:e,et:127};a.c=i,a.m=7,a.f="c",a.id=e.id,a.talkId=e.talkId,e.fromHistory||902==e.mt?this.showMsg(a):this.sendToServer(a)},showMsg:function(i,a){if(i){var n=i.talkId||this.talkId,o=i.id||i.mid||"msg"+(i.tm||(new Date).getTime()),s="msg"+(i.tm||(new Date).getTime());!i.id&&"s"==i.f&&_$(o)&&e("#"+o).remove(),"x"==i.f&&_$(s)&&_$(s).remove();var r,l=i.t?'<li class="clearfix" ><div class="color1 tc">'+i.t+"</div></li> ":"";if(0==i.m?(i.c&&(i.c=this.filterEmailPhoneLink(i.c)),r=i.c?(this.filterEmo(i.c)+"").replace(/((\r\n)|\n)/g,"</br>"):a):(r=i.c||a,i.m),i.c=r,r){var d=i.visitorImg||this.visitorImg||this.defaultVisitorImg;this.needHttps&&(this.staffImg&&(this.staffImg=this.staffImg.replace(/^http:/,this.needHttps)),d=this.visitorImg||d.replace(/^http:/,this.needHttps)),view.staticPx2rem&&(r=view.staticPx2rem(r));var c={toChat:"robot-staff ",endChat:"end-chat ",toLeaveWord:"to-leave-word "};r=r.replace(/\[\[#(toChat|endChat|toLeaveWord):([^\]]+)\]\]/g,function(e,t,i){return'<span class="link-in-msg '+(c[t]||"")+'">'+i+"</span>"}),1==i.withdraw?l+='<div style="padding: 10px 0 20px;text-align: center;"><span style="display: inline-block;padding: 8px 10px;background-color: #bfbfbf;border-radius: 5px;color: #FFF;">'+r+"</span></div>":"s"==i.f||"r"==i.f?l+='<li class="clearfix '+("r"==i.f?"msg-robot":"")+" mode"+i.m+(i.media?" msg-medias":"")+'" id="'+o+'" >'+(this.showAvatar?'<div class="avatar-icon fl staff-icons"><img onerror="view.imgError&&view.imgError(this)" class="avatar-icon-img" src="'+(i.staffImg||this.staffImg||this.defaultStaffImg)+'"/></div>':"")+'<div class="msg msg-lf fl"><div class="msg-staff-name">'+this.stringEncode(i.staffName||this.staffName||lanRes.serviceStaff)+'</div><div class="msg-con radius4 fl '+("r"==i.f?"bg10":"bg1")+(0!=i.m&&6!=i.m&&3!=i.m?" bgwhite":"")+'">'+(i.media||view.SDK&&(2==i.m||4==i.m||5==i.m||7==i.m)?"":'<i class="msg-angle '+("r"==i.f?view.SDK?"color10":"border-color-angle10":view.SDK?"color11":"border-color-angle1")+'"></i>'+(view.SDK?"":0!=i.m&&6!=i.m&&3!=i.m?'<i class="msg-angle2 bc-angle1-white"></i>':""))+'<div class="msg-item">'+r+"</div></div></div></li>":"c"==i.f?l+='<li class="clearfix mode'+i.m+(i.media?" msg-medias":"")+'" id="'+o+'" >'+(this.showAvatar?'<div class="avatar-icon fr"><img onerror="view.imgError&&view.imgError(this)" class="avatar-icon-img" src="'+d+'"/></div>':"")+'<div class="msg msg-rt fr"><div class="msg-con radius4 fr '+("r"==i.ff?"bg30":"bg3")+(0!=i.m&&5!=i.m&&3!=i.m?" bgwhite":"")+'">'+(i.media||view.SDK&&(2==i.m||4==i.m||5==i.m||7==i.m)?"":'<i class="msg-angle '+("r"==i.ff?view.SDK?"color30":"border-color-angle20":view.SDK?"color3":"border-color-angle2")+'"></i>'+(view.SDK?"":0!=i.m&&5!=i.m&&3!=i.m?'<i class="msg-angle2 bc-angle2-white"></i>':""))+(i.hasResend?'<div class="msg-error resend" dataid="'+i.id+'">&nbsp;</div>':"")+'<div class="msg-item">'+r.replace(/\n/g,"<br/>")+"</div></div></div></li>":l+=r;var u=t.createElement("ul");u.innerHTML=l;for(var f,m=this.getListMsgEl(n,i.tm),h=u.childNodes,p=0;f=h[p++];)if(1==f.nodeType){f=f.cloneNode(!0);var g=((i.id||"msg0")+"").replace("msg",""),v=t.getElementById(g);v&&v.innerHTML?v.innerHTML=f.innerHTML:m.appendChild(f)}if(h=null,u=null,i.notAppend)return l;if("serviceTypingLine"!=i.id&&"s"==i.f&&this.clearShowTyping(),i.notEnd){if(i.refresh)return void(view.chatScroll&&view.chatScroll.refresh())}else 0!=i.m&&1!=i.m&&5!=i.m&&view.scrollToBottom(null,{transitionDuration:100,timeout:"x"==i.f?1e3:1!=view.windowType?510:100}),!view.noScrollBottom&&setTimeout(function(e){view.scrollToBottom(void 0,{notVisitor:"c"!=i.f,refresh:i.refresh})},5)}}},changeStorgeBackMsg:function(e){if(!this.hasStorage)return!1;var t=window.localStorage.getItem(this.historyKey)?JSON.parse(window.localStorage.getItem(this.historyKey)):"",i=t?t.order[t.order.length-1]:"",a=t?t[i]:"";if(!a)return!1;delete t[i];var n;for(var o in a)if(a[o].mid==e){a[o].withdraw=1,a[o].c=lanRes.backMsgTip,a[o].m=0,a[o].mt="640",n=o;break}return t[i]=a,this.updateHistory(t),!!n&&parseInt(n)},updateHistory:function(t){var i=JSON.stringify(t);return this.hasStorage?(e.store(this.historyKey,i),this.isIOS&&2==view.windowType&&this.postMessage({type:"updateLocalHistory",key:this.historyKey,value:i}),i):i},updateHistoryComplete:function(e){if(this.hasStorage){var t=window.localStorage.getItem(this.historyKey);if((t=t&&JSON.parse(t))&&t[e]){if(t[e].complete=1,e.match(/^3_/))for(var i=t.order,a=0;a<i.length;a++)if(i[a]==e){i.splice(a,1),i.push(e);break}return this.updateHistory(t),t}}},initHistoryStaffInfos:function(){if(this.hasStorage){var t=e.store(this.historyKey+"_staff");if(t)try{t=JSON.parse(t);for(var i in t)this.dataObject.staffInfos[i]=t[i]}catch(e){}}},saveHistoryStaffInfos:function(){this.hasStorage&&e.store(this.historyKey+"_staff",JSON.stringify(this.dataObject.staffInfos))},getLocalHistory:function(e){if(this.hasStorage){var t=window.localStorage.getItem(this.historyKey);return t=t&&JSON.parse(t)}},initHistory:function(e){if(this.hasStorage){var t=window.localStorage.getItem(this.historyKey);return(t=t&&JSON.parse(t))||(t={order:[]}),t[e]||(t.order||(t.order=[]),t.order.push(e),t[e]={order:[]},this.dataObject.msgInfos.currentPrevTalkId&&(t[e].recentTalkId=this.dataObject.msgInfos.currentPrevTalkId)),t[e].order||(t[e].order=[]),t}},pushHistory:function(e){if(this.hasStorage&&!view.SDKNative&&e.c){var t=e.talkId||this.talkId,i=e.talkTypeId||(this.talkType||1)+"_"+t;if(t){e.talkTypeId=i;var a=this.initHistory(e.talkTypeId);if(a&&"c"==e.f){var n=a[i]||{},o=n.order;for(var s in o)if(n[o[s]].c==e.c&&n[o[s]].mid&&n[o[s]].mid==e.mid)return;if(o.length>0){var r=o[o.length-1];if(a[i][r].c==e.c&&r.indexOf("c")>-1){var l=a[i][r].tm-e.tm;if(l<200&&l>-200)return}}}"s"!=e.f||e.staffImg||(e.staffImg=this.staffImg,e.staffName=this.staffName),1!==e.m&&2!==e.m||a[i][e.tmf]?a[i][e.tm+e.f]||(a[i][e.tm+e.f]=e,a[i].order.push(e.tm+e.f)):(a[i][e.tmf]=e,a[i].order.push(e.tmf)),this.updateHistory(a)}}},saveHistoryStaff:function(e,t){if(this.hasStorage&&this.talkId){var i=(this.talkType||1)+"_"+this.talkId,a=this.initHistory(i);e&&!a[i].staffImg&&(a[i].staffImg=e||this.defaultStaffImg),e&&!a[i].staffName&&(a[i].staffName=t||lanRes.serviceStaff),this.updateHistory(a)}},checkHistory:function(t){if(this.dataObject.msgInfos.recentTalkId)return!0;if(!this.hasStorage)return e("#pre_his").hide(),!1;if(view.SDKNative)return!0;if(this.hasCheckHistory&&!t)return this.hasPreHis;this.talkId&&(this.hasCheckHistory=!0);var i=window.localStorage.getItem(this.historyKey);if(!i||'""'==i)return e("#pre_his").hide(),!1;i=JSON.parse(i);var a=this.talkType+"_"+this.talkId,n=i.order,o=n.length,s=!1;if(!o)return e("#pre_his").hide(),!1;if(1==o&&n&&n[0]&&n[0]==a)return e("#pre_his").hide(),!1;if(!t)return!0;if(o<2)return!1;for(var r=o-1;r>-1;r--)if(n[r]&&n[r]!=a&&!this.checkListMsgEl(n[r])){s=!0;break}return s},loadHistory:function(e){if(!this.hasStorage||!this.hasPreHis&&!e)return!1;if(!this.loadingPreHis){var t;if(view.SDKNative)this.publish("__loadPreHistory");else if(this.loadingPreHis=!0,(t=window.localStorage.getItem(this.historyKey))&&(t=JSON.parse(t)),this.loadLocalHisByRencent(t,e))if(t){if(!e||t[e]&&t[e].order&&0!=t[e].order.length){var i,a,n=t.order,o=n.length,s=this.talkId?this.talkType+"_"+this.talkId:"";if(o<(this.talkId?2:1)&&!e)return this.hasPreHis=!1,this.loadingPreHis=!1,!1;for(var r=o-1;r>-1&&(!e||n[r]==e);r--)if((e||n[r]&&n[r]!=s)&&(i=t[n[r]],a=this.checkListMsgEl(n[r]),i&&!a))return e&&(a=view.chat.getListMsgEl(e,i.order&&i[i.order[0]]&&i[i.order[0]].tm||(new Date).getTime(),!0)),0==r&&(i.recentTalkId&&t[i.recentTalkId]?this.hasPreHis=!0:this.hasPreHis=!1),this.showHis(i,n[r],!!e),!0;-1==r&&(this.hasPreHis=!1),this.loadingPreHis=!1,this.hasPreHis||this.hidePreHistory()}}else this.loadingPreHis=!1}},loadLocalHisByRencent:function(e,t){var i=(t=t||this.dataObject.msgInfos.recentTalkId)&&e&&e[t];return i&&i.complete?(this.showHis(i,t,!1),this.hasPreHis=this.checkHistory(!0)||i.recentTalkId,!1):t&&this.hasHisHandle&&this.dataObject.msgInfos.hasVipHistory?(this.publish("loadPreHistory"),!1):!!e||(this.hidePreHistory(),!1)},hidePreHistory:function(){this.loadingPreHis=!1,this.hasPreHis=!1,e("#pre_his").hide()},showPreHistory:function(){this.loadingPreHis=!1,this.hasPreHis=!0,e("#pre_his").show()},showHis:function(t,i,a){var n,o,s=this,r=0;o="string"==typeof i&&-1!=i.indexOf("_")?i.split("_")[1]:i;var l=this.staffImg,d=this.staffName,c={};view.preHisLoadingId="list_msg_"+i;var u=_$(view.preHisLoadingId);u||(u=s.getListMsgEl(i)),(this.dataObject.msgInfos.recentTalkId||t.recentTalkId)&&(this.dataObject.msgInfos.recentTalkId=t.recentTalkId),a?view.preHisLoadingId=null:(e(u).addClass("fake-hide"),e(".pre-his-icon").addClass("loading-spin")),view.handleHis&&view.handleHis(t);for(var f in t)if("order"!=f&&"staffImg"!=f&&"staffName"!=f&&"config"!=f&&"robotStaffImg"!=f&&"robotStaffName"!=f&&"callDatetime"!=f&&"recentTalkId"!=f&&"complete"!=f){if(n=e.extend({},t[f]),n.talkId=o,n.talkTypeId=i,n.fromHistory=!0,n.notStore=!0,n.notEnd=!0,_$("msg"+n.tm)||_$(""+n.mid)||_$(""+n.id)||_$(""+n.tmf)){if(655!=n.mt)continue}else 864==n.mt||865==n.mt||n.mt;if(n.t&&-1==(n.t+"").indexOf(" ")&&(n.t=s.getTimeStr(n.tm)),"649"==n.mt?n.robotConfigInfo&&t.robotStaffName?(this.staffImg=t.robotStaffImg,this.staffName=t.robotStaffName):(this.staffImg=t.staffImg,this.staffName=t.staffName):"604"==n.mt?c=!c.staffId&&n.staffDetailInfoMsgList&&n.staffDetailInfoMsgList.length?{staffId:n.staffDetailInfoMsgList[0].staffId,staffName:n.staffDetailInfoMsgList[0].staffNickName||lanRes.serviceStaff,staffImg:n.staffDetailInfoMsgList[0].staffHead||t.staffImg}:{staffId:n.staffId,staffName:n.staffNickName||lanRes.serviceStaff,staffImg:n.staffDetailInfo&&n.staffDetailInfo.staffHead||t.staffImg}:"688"==n.mt?(window.echatFormItem=window.echatFormItem||{},n.template.formInfoId?window.echatFormItem[n.template.formInfoId]=n.template:window.echatFormItem["template"+n.template.id]=n.template):"10001"==n.mt&&s.staffMap?c=s.updateStaffInfo(void 0,{staffId:n.toStaffId,staffNickName:n.toStaffNickName,staffDetailInfo:n.toStaffDetailInfo}):n.staffId&&s.staffMap[n.staffId]?(n.staffName=s.staffMap[n.staffId].staffName||t.staffName,n.staffImg=s.staffMap[n.staffId].staffImg||t.staffImg):!n.staffImg&&c.staffName&&(n=e.extend(n,c)),!a||864!=n.mt&&105!=n.et?!a||640!=n.mt&&641!=n.mt&&642!=n.mt||s.postMessage({type:"staffSendEvt",msg:640==n.mt?n.content||n.c:642==n?"[file]":641==n?"[image]":""}):s.publish("_addSendMsgNum",n),"10001"!=n.mt)if("10011"!=n.mt)if("10010"!=n.mt){if(!(n.mt>1e3&&"r"!=n.f))if(865!=n.mt&&641!=n.mt)if(647!=n.mt)if(866!=n.mt&&642!=n.mt)if("12001"!=n.mt)if(655!=n.mt)if(658!=n.mt)if(127!=n.mt&&902!=n.mt)if(680!=n.mt||n.c)if(688!=n.mt)if(959!=n.mt)if(605!=n.mt&&10009!=n.mt){if(640==n.mt&&view.SDKNative&&(n.c=this.handleMsgImg(n.c||n.content,n),n.c=this.handleMsgVideo(n.c||n.content)),(105==n.et||130==n.et)&&2==n.sendStatus){n.hasResend=!0;var m=n.id||s.getMsgId(n);n.id=m,s.errorList[m]=n}n.notAppend=!0,!n.c&&n.content&&(n.c=n.content),n.c&&this.showMsg(n),delete n.talkId}else 605==n.mt&&s.publish("getSysMsg",n);else s.publish("submitForm",n);else s.publish("receiveForm",n);else s.publish("receiveURL",n);else s.publish("sendLocationInfo",n);else s.publish("orderReply",n);else s.publish("getLeaveMsg",n);else s.publish("getMsgRobot",n);else s.publish("getMsgFile",n);else s.publish("getSysMsg",n);else r++,a&&(n.notEnd=!1),s.publish("getMsgImg",n),a&&(n.notEnd=!0)}else s.publish("getSysMsg",n);else s.publish("receiveVisEvt",n);else s.publish("getSysMsg",n)}if(this.staffImg=l,this.staffName=d,a)return view.chat.loadingPreHis=!1,void view.scrollToBottom();r=r>6?6:r,setTimeout(function(){e(u).removeClass("fake-hide"),view.scrollToLastPre(view.preHisLoadingId),view.chat.loadingPreHis=!1,view.preHisLoadingId=null,e(".pre-his-icon").removeClass("loading-spin"),s.hasPreHis||s.hidePreHistory()},500*(r||1))},clearHistoryByTalkId:function(e){if(this.hasStorage){var t=window.localStorage.getItem(this.historyKey);if((t=t?JSON.parse(t):"")&&t[e]){delete t[e];for(var i=t.order.length-1;i>=0;i--)t.order[i]==e&&t.order.splice(i,1)}this.updateHistory(t)}},getHistoryByTalkId:function(e){if(this.hasStorage){var t=window.localStorage.getItem(this.historyKey);return(t=t?JSON.parse(t):"")&&t[e]}},getListMsgEl:function(i,a,n){var o=this.checkListMsgEl(i);return o||(this.lastTalkIdForTemp,this.hasLeaveMsg||e(".list-his-hr").removeClass("hide"),o=t.createElement("ul"),o.id="list_msg_"+i,o.className="list-msg list-msg-his",a&&(o.innerHTML='<li class="clearfix list-his-hr color1 hide"><i class="hr-left"></i><span>'+this.getTimeStr(a)+'</span><i class="hr-right"></i></li>'),_$("list_his").insertBefore(o,n?_$("list_msg"):_$("pre_his").nextSibling),o)},checkListMsgEl:function(e){var t,i=_$("list_msg_"+e);return i||(e&&e!=this.talkId?(t="string"==typeof e&&-1!=e.indexOf("_")?e.split("_")[1]:e,i=t&&(_$("list_msg_"+t)||_$("list_msg_1_"+t)||_$("list_msg_2_"+t)||_$("list_msg_3_"+t)||_$("list_msg_4_"+t)||_$("list_msg_5_"+t))):_$("list_msg"))},handleSessionMsg:function(i){i.talkId||(i.talkId=Math.random());var a=i.talkId,n=_$("list_msg_"+a);if(n)return n;(n=t.createElement("ul")).id="list_msg_"+a,n.className="list-msg list-msg-his";for(var o,s=_$("list_msg").childNodes,r=0;o=s[r++];)1==o.nodeType&&(r--,-1!=o.className.indexOf("innerAD")&&o.childNodes&&"IFRAME"==o.childNodes[0].tagName?e(o).remove():n.appendChild(o));return _$("list_his").insertBefore(n,_$("list_msg")),n},getTimeStr:function(e){e=e&&e-0||void 0;var t=new Date,i=new Date(e).format("hh:mm");return e=e||t.getTime(),t.setHours(0,0,0,0),t=t.getTime(),(e>=t?lanRes.today:t-e<=864e5?lanRes.yesterday:t-e<=1728e5?lanRes.beforeYesterday:new Date(e).format("yyyy-MM-dd"))+" "+i},showInfoTip:function(i,a,n,o,s,r,l){var d;if("string"!=typeof i&&(i=(d=i)&&d.tip),d&&void 0===l&&(l=d.notEnd),i){view.staticPx2rem&&i&&(i=view.staticPx2rem(i));var c={toChat:"robot-staff ",endChat:"end-chat ",toLeaveWord:"to-leave-word "};i=(i=i.replace(/&nbsp;([^&\s])/g," $1")).replace(/\[\[#(toChat|endChat|toLeaveWord):([^\]]+)\]\]/g,function(e,t,i){return'<span class="link-in-msg '+(c[t]||"")+'">'+i+"</span>"}),a=a||"msg"+(new Date).getTime(),n=n||"icon";var u='<li class="clearfix '+(this.showAvatar?"msg-info-hasAvatar":"msg-info-noAvatar")+'" id="'+a+'" ><div class="'+(!d&&this.isInRobot||d&&"r"==d.f?"msg-info0":"msg-info")+' radius4"><div class="info-con">'+i+"</div></div></li>";if(o)return u;a&&_$(a)&&e("#"+a).remove();var f=t.createElement("ul");f.innerHTML=u;for(var m,h=this.getListMsgEl(s,r),p=f.childNodes,g=0;m=p[g++];)1==m.nodeType&&(m=m.cloneNode(!0),h.appendChild(m));p=null,f=null,!l&&view.scrollToBottom(null,{transitionDuration:100,timeout:100})}},resetStatisfy:function(){if(e("#sa_advise").val(""),!l)for(var t=e(".sa-sli").results,i=0;i<t.length;i++)e(t[i]).addClass("sa-star").html("&#xe64d;");var a=e("#satisfyConfig").attr("default");e("#satisfyConfig").attr("class","sa-sel-"+a),e(".sub-tab-sel").removeClass("sub-tab-sel"),e(".sub-tab"+a).addClass("sub-tab-sel"),e("#satisfy_ipt").val(a)},showSatisfy:function(t){if(this.hasInitEvaluate){if(this.allowEvaluateBaseWords>this.sendMsgNum&&1==t)return!1;if(this.notEvaluate)return this.notEvaluate=!1,!1;if(this.satisfyType=t,2==t||3==t||this.satisfyEnable&&!this.satisfyShowed){view.inputBlur&&view.inputBlur(),this.resetStatisfy();var i=this.hideSatisfy,a=setTimeout(function(){clearTimeout(a),e("#mask").off("click",i).on("click",i).show(),e("#satisfy").show()},0);return view.handleShowSatisfy&&view.handleShowSatisfy(),!0}return!1}},hideSatisfy:function(){var t=view.chat;e("#satisfy").removeClass("satisfy-show").hide(),e("#mask").hide().off("click",t.hideSatisfy),!1===t.chatting?(t.publish("_closeWin"),t.publish("__evaluate","0-2")):t.publish("__evaluate","0-1"),view.SDK&&e.store("ECHAT_inviteSatisfyHandle",e.store("ECHAT_inviteSatisfyId")),view.SDK&&_$("sa_advise").blur(),view.hideSatisfy&&view.hideSatisfy()},addJS:function(e,i){function a(e){n.onload=n.onerror=n.onreadystatechange=null,o.removeChild(n),n=null,i(e)}var n=t.createElement("script");n.setAttribute("type","text/javascript");var o=_$s("head")[0];"onload"in n?(n.onload=a,n.onerror=function(){a(!0)}):n.onreadystatechange=function(){/loaded|complete/.test(n.readyState)&&a()},n.src=e,o.appendChild(n)},addCSS:function(e){var i=t.createElement("link");i.rel="stylesheet",i.type="text/css",i.href=e,i.media="screen";_$s("head")[0].appendChild(i)},loadEmoji:function(){var t=this;if(!t.emo){if(view.loadEmoji)return view.loadEmoji();this.addCSS(t.isMobile&&view.px2px?__uri("/visitor/mobile/css/emoji.css"):t.isMobile?locationBase+"/res/emoji/emoji_x2.css":locationBase+"/res/emoji/emoji.css"),e.ajax({url:locationBase+"/res/emoji/emoji.json",async:!0,type:"get",contentType:"application/json;charset=UTF-8",success:function(e){t.emo="string"==typeof e?JSON.parse(e):e},error:function(e,t,i){console.log("ajax emoji error")}}),e.ajax({url:locationBase+"/res/emoji/emoji_"+(window.lanName.match(/^zh/i)?"zh":"en")+".json",async:!0,type:"get",contentType:"application/json;charset=UTF-8",success:function(e){t.emoLan="string"==typeof e?JSON.parse(e):e;var i={};for(var a in t.emoLan)i[t.emoLan[a]]=a;t.lanEmo=i},error:function(e,t,i){console.log("ajax emoji error")}}),e.ajax({url:locationBase+"/res/emoji/emojiFace.json",async:!0,type:"get",contentType:"application/json;charset=UTF-8",success:function(i){var a="string"==typeof i?JSON.parse(i):i;view.initEmotion.call(t,a),e("#emotion").on("click",".emoji",function(i){var a=e(this).attr("code"),n=t.getInput().length+a.length+4,o=t.inputMaxLength;n>o||(e("#inputLengthTip").html(lanRes.inputLengthTip1+(o-n)+lanRes.inputLengthTip2),!t.isMobile&&t.focusInput(),t.insertImg(a),t.oldBodyEnterText=t.getInput())})},error:function(e,t,i){console.log("ajax emoji error")}})}},filterEmo:function(e){if(!e||"string"!=typeof e)return e;var t=this.emo;return t&&(e=e.replace(this.regFace,function(e){arguments[0];var i=e.charCodeAt(0),a=e.charCodeAt(1),n=(a-56320+(i-55296<<10)+65536).toString(16);return t[n]?'<img class="img-emo" src="'+locationBase+"/res/emoji/32/"+n+'.png" />':t[i+"_"+a]?'<img class="img-emo" src="'+locationBase+"/res/emoji/32/"+i+"_"+a+'.png" />':e})),e=e.replace(this.regEmo,function(e){var i=e.replace(/^\[#([\d\w_]+)#\]/g,"$1");return t&&t[i]||!t?'<img class="img-emo" src="'+locationBase+"/res/emoji/32/"+i+'.png" />':e})},HTMLDecode:function(e){var i=t.createElement("div");null!=i.textContent?i.textContent=e:i.innerText=e;var a=i.innerHTML;return i=null,a},getFileSize:function(e,i){if(""!=e.value){var a=-1;if(e.files&&e.files[i])a=parseInt(e.files[i].size);else try{e.select();var n=t.selection.createRange().text;a=new ActiveXObject("Scripting.FileSystemObject").GetFile(n).size}catch(e){console.log("如果你用的是ie8以下 请将安全级别调低！")}return a}},hasFormData:function(){var e=!0;try{1==view.windowType&&new FileReader,new FormData}catch(t){e=!1}return e}(),hasInitFile:!1,addSendFile:function(){if(!view.SDKNative){if(this.hasInitFile)if(this.hasFormData);else{(i=_$("file_up"))&&(i.src="/visitor/common/upload.html?t="+(new Date).getTime())}else if(this.hasFormData)window.fLoad(t);else{var i=_$("file_up");if(i)return;e("#uploadForm").remove(),e(".menu-file").append('<iframe src="/visitor/common/upload.html" style="filter:alpha(opacity=0.1);opacity: 0.1;position: absolute;top:0;left:0;z-index: 999999999;" allowtransparency="true" id="file_up" frameborder="0" framespacing="0" marginheight="0" marginwidth="0" width="100%" height="100%" scrolling="no"></iframe>')}}},isImgHasPreview:function(t){var i=e(t);if(i.hasClass("msg-img"))return!0;if(i.hasClass("img-emo")||i.hasClass("custom-event-img")||!t.src)return!1;if(i.parents(".msg-info").length||i.parents(".msg-info0").length||i.parents(".msg-item").length){if(i.parents("a").attr("href"))return!1;if(!i.hasClass("info-icon-img")&&!i.parents(".portrait-title").length&&!i.parents(".feedback-btns").length)return!0}},setMerchantLogo:function(t){var i=[],a="",n="",o=t.chatLogoImgEnable,s="",r="",l=this.companyLogo||t.companyLogo,d=this.platformLogo||t.platformLogo,c=this.platformName||t.platformName,u=this.companyName||t.companyName;this.staffInfoRefreshMap.merchantLink=null,"1"==o&&(a="1"==t.chatLogoImgType?d:l)&&i.push('<img class="header-logo" src="'+a+'"/>'),"1"==t.companyNameEnable&&(n="1"==t.companyNameType?c:u)&&(n=n.replace(/</g,"&lt;").replace(/>/g,"&gt;"),i.push('<span class="header-logo-txt">'+n+"</span>")),"1"==t.subcompanyUrlEnable&&((s=t.subcompanyUrl)&&(r=this.getADURL(!0,t.subcompanyAdPostParamList,s,this.paramChat)),t.subcompanyButtonUrl&&i.push('<a class="merchant-link" href="'+(r||"")+'" target="_blank"><img class="merchant-icon" src="'+t.subcompanyButtonUrl+'"/></a>'),r&&(this.staffInfoRefreshMap.merchantLink={notEnableParam:!1,params:t.subcompanyAdPostParamList,element:".merchant-link",hash:!1,srcUrl:s,attr:"href",url:""})),e("#logobox").html(i.join(""))}},window.imgLoadResizeSelf=function(e){view.px2rem&&(e.style.width=view.px2rem(e.naturalWidth||e.width))},window.imgLoadResize=function(t,i){function a(){var t=1==view.windowType?600:260,a=this.naturalWidth||this.width,s=_$(n);s&&(a>t&&(a=t),s.style.width=view.px2rem?view.px2rem(a):a+"px",-1==i&&(s.style.marginLeft=view.px2rem?view.px2rem(-a/2):-a/2+"px"),e("#"+o).removeClass("hide").css("width",view.px2rem?view.px2rem(a):a+"px"),view.scrollToBottom())}Math.random();var n=-1==i?"entry":"inviteBook"+i,o=-1==i?"entryWrapImg":"inviteBookImg"+i;if(t.naturalWidth)a.call(t);else{var s=new Image;s.onload=a,s.src=t.src}};var u=!1;window.initReady=function(i){function a(e){e=e||[];for(var t=0;t<e.length;t++)n.Browser.isIOS&&e[t].removeAttribute("accept")}window.initReady=null,u=!0;var n=new c;if(3==view.windowType&&2!=n.media&&(n.media=2),setTimeout(window.initChat,0),"firefox"==n.Browser.browser&&e("body").on("drop",function(e){e.stopPropagation()}),"xcx"==n.queryParams.launchfrom&&(n.media=n.Device.media=2,n.addJS("https://res.wx.qq.com/open/js/jweixin-1.3.2.js")),"522116"!=n.companyId&&"521863"!=n.companyId||(lanRes.chatWith=" ","enus"==window.lanResName?lanRes.tip="Message":"zhcn"==window.lanResName?lanRes.tip="讯息":"zhtw"==window.lanResName&&(lanRes.tip="訊息")),n.Browser.isIOS){new MutationObserver(function(e){e.forEach(function(e){"childList"==e.type&&e.addedNodes.length&&a(e.target.querySelectorAll("input[type='file']"))})}).observe(t.body,{childList:!0,subtree:!0}),a(t.body.querySelectorAll("input[type='file']"))}},e(function(){initReady&&initReady()})}(EChatQuery,document);