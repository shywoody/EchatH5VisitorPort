function InputHandle(){var f=this;this.filterPasteData=function(e,t,i){var a=i?"\r\n":"<br/>";return e&&t?e.replace(/(^[\s\r\n]+)|[\r]|([\s\r\n]+$)/g,"").replace(/[\r\n]+([\r\n\s]+)*/g,a):e&&e.replace(/<(br|hr)\/?>/gi,"\n").replace(/<\/(br|p|div|table|section|footer|article|li|ul|ol)>/gi,"\n").replace(/(<[a-z]+(\s+[^>]*)?>)|(<\/?[a-z]+\/?>)/gi,"").replace(/([\r\n]+)|([\r\n]+[\s]+[\r\n]*)|([\r\n]*[\s]+[\r\n]+)/g,"\n").replace(/[\n]+/g,a)},this.getInput=function(e){if(f.plainText){var t=$("#textInput").val();if(t){if(e){$("#textInput").val("");_$("textInput")}return f.filterPasteData(t,!0,!0)}return t}f.getInputDoc();var i,a=f.getInputDocBody();null!=a.lastElementChild&&"SL_balloon_obj"==a.lastChild.id&&a.removeChild(a.lastChild);var n=i=a.innerHTML;if(500<n.length&&(n=i.replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[#$1#]")),e?(a.innerHTML="",$("#inputPlaceholder").removeClass("hide")):i.length,500<i.length)o=n;else{var o=n.replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[#$1#]");o=f.filterPasteData(o,!1,!0)}return 5e3<o.length&&(o=o.substring(0,5e3)),o},this.setInput=function(e){if(!e)return this.getInput(!0);if(e=e.replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[#$1#]").replace(/<(?!br|\/br)(?:.|\s)*?>/gi,"").replace(/&nbsp;/gi," ").replace(/^((<\/?br\/?>)|[\r\n\s]+)+|((<\/?br\/?>)|[\r\n\s]+)+$/gi,""),f.plainText)$("#textInput").val(e);else{f.getInputDoc();f.getInputDocBody().innerHTML=e}},this.inputScrollToView=function(e){var i=this,a=1;$(e).on("focus",function(e){window.top==window?(function t(){if(15<a)return;setTimeout(function(){var e=window.innerHeight+(i.isIOS?80:20);window.scrollTo(0,e),a++,t()},100)}(),a=1):i.postMessage("inputScroll")}),$(e).on("blur",function(e){a=1,setTimeout(function(){i.postMessage("inputScrollStop")},550)})},this.changeToIframe=function(e,t){if(this.plainText){this.plainText=!1,this.editorType=2;var a=this;$("#textInput").hide();var i=_$("html_input");if(i.style.display="block",!this.hasInitIframeInput){this.hasInitIframeInput=!0;var n=a.getInputDoc();try{n.designMode="on"}catch(e){console.log(e)}n.contentEditable=!0;try{window.isIE6?n.write('<html><head><meta http-equiv="Content-type" content="text/html;charset=utf-8"><style type=\'text/css\'>html,body{width:100%;height:100%;max-height: 100%;overflow: auto;margin:0;padding:0;background-color:transparent;font-family: "Microsoft YaHei", "Helvetica Neue", Helvetica,"微软雅黑", Arial, sans-serif, STHeiti, FangSong;}</style></head><body contenteditable="true"></body></html>'):(n.open(),n.write('<html><head><meta http-equiv="Content-type" content="text/html;charset=utf-8"><style type=\'text/css\'>html,body{width:100%;height:100%;max-height: 100%;overflow: auto;margin:0;padding:0;background-color:transparent;font-family: "Microsoft YaHei", "Helvetica Neue", Helvetica,"微软雅黑", Arial, sans-serif, STHeiti, FangSong;}'+(1==view.windowType?"":" .img-emo{width:20px;height:20px;")+'}</style></head><body contenteditable="true"></body></html>'),n.close())}catch(e){}var o=n.getElementsByTagName("body")[0];o.style.cssText="margin:0;padding:0;word-break:break-all;white-space: pre-wrap;word-wrap: break-word;width:100%;line-height:1.2;overflow:auto;",a.win=i.contentWindow||document.frames.html_input,a.getPos=s,d(a.win,"focus",r),d(a.win,"blur",l),d(o,"focus",r),d(o,"blur",l),d(o,"select",s),d(o,"click",function(e){s(),view.hideMenus()}),d(o,"keydown",function(e){$("#inputPlaceholder").addClass("hide");var t=e||a.win.event;return view.enter(t)}),d(o,"drop",function(e){setTimeout(function(){a.getInput(!1)&&$("#inputPlaceholder").addClass("hide")},100),a.Browser.browser}),d(n,"paste",function(e){setTimeout(function(){a.getInput(!1)?$("#inputPlaceholder").addClass("hide"):$("#inputPlaceholder").removeClass("hide")},100)}),a.isMobile&&a.inputScrollToView(o),view.initHtmlEdit&&view.initHtmlEdit(a.win,n),a.isMobile||a.addPaste(a.win,n),setTimeout(function(){a.getInput(!1)?$("#inputPlaceholder").addClass("hide"):$("#inputPlaceholder").removeClass("hide")},100)}}function s(e){$("#inputPlaceholder").addClass("hide");var t=a.getInputDoc(),i=null;return t.selection?i=t.selection.createRange():a.win.getSelection&&a.win.getSelection().rangeCount&&(i=a.win.getSelection().getRangeAt(0)),i&&(a.win.pos=i)}function r(){s(),view.hideMenus(0)}function l(){s(),a.getInput(!1)||$("#inputPlaceholder").removeClass("hide")}function d(e,t,i){e.addEventListener?e.addEventListener(t,i):e.attachEvent("on"+t,i)}},this.preRange=null,this.changeToPreInput=function(){if(this.plainText){this.editorType=3,this.plainText=!1;var n=this;$("#textInput").hide();var e,o=$("#html_pre_input"),t=o.results[0];o.css("display","block"),n.isMobile&&n.inputScrollToView(n.getInputDocBody()),t.onkeyup=function(){clearTimeout(e),e=setTimeout(function(){i()},300)},t.onkeydown=function(e){$("#inputPlaceholder").addClass("hide");e||window.event;return view.enter(e)},t.ontouchend=function(e){setTimeout(function(){i(e)},50)},t.ontouchstart=function(e){$("#inputPlaceholder").addClass("hide")},t.onfocus=function(){$("#inputPlaceholder").addClass("hide"),i(),view.hideMenus(0)},t.onblur=function(){n.getInput(!1)||$("#inputPlaceholder").removeClass("hide")},t.onclick=function(){i(),view.hideMenus(0),t.focus()},n.getPos=i}function i(e){var t,i=o.results[0];if(window.getSelection){var a=window.getSelection();try{t=a.getRangeAt(0)}catch(e){(t=document.createRange()).selectNodeContents(i),t.collapse(!1),t.select()}}else t=document.selection.createRange();return n.preRange=t}},this.bindPlainTextEvent=function(){this.plainText=!0,this.editorType=1,$("#textInput").show();var e=_$("html_input");$(e).hide();var r=this;function a(e){var t,i=_$("textInput");if(window.getSelection){var a=window.getSelection();try{t=a.getRangeAt(0)}catch(e){(t=document.createRange()).selectNodeContents(i),t.collapse(!0)}}else t=document.selection.createRange();return r.textRange=t}$("#inputPlaceholder").addClass("hide"),r.isMobile,this.hasBindPlainTextEvent||(this.hasBindPlainTextEvent=!0,view.bindPlainTextEvent(),$("#textInput").off("keydown").on("keydown",function(e){e=e||window.event;if(r.handleInputLength&&setTimeout(r.handleInputLength,50),!1!==view.enter(e)){if(8==(e.keyCode||e.which||e.charCode||0)){var t=_$("textInput"),i=t.value;if(t.createTextRange)console.log("手机端IE?");else{var n=t.selectionStart,o=-1,s=0;0<n&&i.replace(/\[#([^#]+)#\]/g,function(e,t,i,a){return i<n&&i+e.length>=n&&(s=(o=i)+e.length),e}),-1!=o&&t.setSelectionRange(o,s)}}a()}}).on("change input",function(){r.handleInputLength&&r.handleInputLength(),a()}).on("paste",function(e){return r.filterPasteText(e,void 0,window,document)}).on("drop",function(e){r.handleInputLength&&setTimeout(function(){r.handleInputLength()})}).on("focus",a),setTimeout(function(){_$("textInput")&&_$("textInput").scrollIntoView()},400),r.textRange=null,r.getPos=a)},this.filterPasteText=function(e,t,i,a){var n=a.getElementById("textInput");if(void 0===t&&(t=i.clipboardData&&clipboardData.setData?i.clipboardData.getData("text"):(e.originalEvent||e).clipboardData.getData("text/plain")||prompt("在这里输入文本")),t){if(t=f.filterPasteData(t,void 0,!0),e.returnValue=!1,e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),t&&f.plainText)if(a.selection){var o=a.selection.createRange();o.text=t}else if("number"==typeof n.selectionStart&&"number"==typeof n.selectionEnd){var s=n.selectionStart,r=n.selectionEnd,l=s,d=n.value;n.value=d.substring(0,s)+t+d.substring(r,d.length),l+=t.length,n.selectionStart=n.selectionEnd=l}else n.value+=t;else if(t&&a.body.createTextRange){if(a.selection)textRange=a.selection.createRange();else if(i.getSelection){var c=(o=i.getSelection()).getRangeAt(0),u=a.createElement("span");u.innerHTML="&#FEFF;",c.deleteContents(),c.insertNode(u),textRange=a.body.createTextRange(),textRange.moveToElementText(u),u.parentNode.removeChild(u)}textRange.text=t,textRange.collapse(!1),textRange.select()}else t&&a.execCommand("insertText",!1,t);return!1}return!0},this.getInputDoc=function(){var e;return 2==this.editorType?(e=_$("html_input").contentDocument)||(e=document.frames.html_input.document):e=document,e},this.getInputDocBody=function(){var e,t,i=this.editorType;return 3==i?(t=_$("html_pre_input")).blur||(t.blur=function(){window.focus()}):t=2==i?((e=_$("html_input").contentDocument)||(e=document.frames.html_input.document),e.body||e.getElementsByTagName("body")[0]):_$("textInput"),t},this.focusInput=function(e){var t,i,a,n=this.editorType;return 3==n?t=_$("html_pre_input"):2==n?(t=_$("html_input").contentWindow||document.frames.html_input,(i=_$("html_input").contentDocument)||(i=document.frames.html_input.document),a=i.body||i.getElementsByTagName("body")[0],e||a.focus()):t=_$("textInput"),e||t.focus(),!e&&a&&a.focus(),t},this.insertImg=function(e){var t=this;if(t.plainText)return view.insertImg?view.insertImg(_$("textInput"),"[#"+t.emoLan[e]+"#]"):(_$("textInput").value+="[#"+t.emoLan[e]+"#]",_$("textInput").scrollTop=_$("textInput").scrollHeight),void(view.textInputChange&&view.textInputChange());var i="/res/emoji/24/"+e+".png",a=this.getInputDoc(),n=this.getInputDocBody(),o=t.win,s=this.editorType,r=o?o.pos:null;if(3==s&&(o=window,r=t.preRange),a.selection&&!/opera/gi.test(view.chat.Browser.browser)){var l='<img class="img-emo" src="'+i+'" border="0" code="'+e+'" unselectable="on"/>';if(r)o.focus(),setTimeout(function(){(r=o.pos||r).move("textedit"),r.pasteHTML(l),r.collapse(!0),r.select(),t.focusInput()},100);else(l=a.createElement("img")).className="img-emo",l.src=i,l.border="0",l.setAttribute("code",e),l.setAttribute("unselectable","on"),a.getElementsByTagName("body")[0].appendChild(l),n.appendChild(l)}else if(window.getSelection){var d;(l=a.createElement("img")).className="img-emo",l.src=i,l.border="0",l.setAttribute("code",e),l.setAttribute("unselectable","on"),r?((d=o.getSelection()).removeAllRanges(),r.deleteContents(),r.insertNode(l),r.setStartAfter(l),r.setEndAfter(l),this.isMobile||(d.removeAllRanges(),d.addRange(r))):n.appendChild(l),setTimeout(function(){n.scrollTop=l.offsetTop,t.focusInput()},100)}$("#inputPlaceholder").addClass("hide")},this.addPaste=function(o,e){var t,s=this;function r(){setTimeout(function(){for(var e=s.getInputDocBody().getElementsByTagName("img"),t=0;t<e.length;t++)e[t].getAttribute("code")||(e[t].parentNode?e[t].parentNode.removeChild(e[t]):e[t].removeNode&&e[t].removeNode(!0))},2)}function i(e){if(r(),!0===s.companyOff||s.busyCanSend&&"0"!=s.queryParams.autoChat||!0===s.chatting)if(e.clipboardData&&e.clipboardData.items){var t=e.clipboardData.items;if(t)for(var i=t.length-1;-1<i;i--)if(-1!==t[i].type.indexOf("image")){var a=t[i].getAsFile(),n=(new Date).getTime()+"."+t[i].type.split("/")[1];l(a,function(e){e&&(e.fileName=n,d(e))});break}}else setTimeout(c,1)}function l(t,i){if(i&&t&&-1<t.type.indexOf("image/")){var e=new FileReader;e.onload=function(e){i({file:t,base64:e.target.result})},e.readAsDataURL(t)}else i&&i(null)}function d(e){$("#pasteImg").attr("src",e.base64),$("#pastePreview").removeClass("hide"),$("#maskVerify").removeClass("hide")}function c(){for(var e,t=s.getInputDocBody().getElementsByTagName("img"),i=0;i<t.length;i++)if(!t[i].getAttribute("code")){e=t[i];break}function a(){for(var e=s.getInputDocBody().getElementsByTagName("img"),t=0;t<e.length;t++)e[t].src.match(/webkit-fake-url:/i)&&e[t].parentNode.removeChild(e[t])}if(e){var n=e.currentSrc||e.src;n.match(/data:image\/[\w]+;base64/i)?d({base64:n}):n.match(/blob/i)?console.log("blob******************src"):n.match(/webkit-fake-url:/)?(console.log("safari等浏览器 粘贴图片无法发送"),o.removeEventListener("paste",a),o.addEventListener("paste",a)):n.match(/^(http[s]?:\/\/[^\/]+|)\/.+/gi)&&(s.getInputDocBody().innerHTML+=lanRes.picture+":"+n),e.parentNode?e.parentNode.removeChild(e):e.removeNode&&e.removeNode(!0)}}s.filterPaste(o,e),this.hasPasteCapture=t=s.hasFormData,!window.ltIE10&&t&&"safari"!=view.chat.Browser.browser||setTimeout(function(){$("#inputPlaceholder").attr("placeholder",lanRes.inputPlaceholder2).html(lanRes.inputPlaceholder2)},500),t?(o.addEventListener?o.addEventListener("paste",i):o.attachEvent("onpaste",i),$("#pasteOK").on("click",function(){view.chat.publish("sendVisitorEvent",{et:123,uploadServiceType:s.uploadServiceType,ssl:s.needHttps?1:void 0,ft:5},function(e){e.successful||(s.showTip(lanRes.networkFileError),$("#pasteError").removeClass("hide"),$("#pastePreview").removeClass("hide"),$("#maskVerify").removeClass("hide"))},{resend:!1}),s.captureFileSource=$("#pasteImg").attr("src").split("64,")[1],$("#pasteError").addClass("hide"),$("#pastePreview").addClass("hide"),$("#maskVerify").addClass("hide")}),$("#pasteCancel").on("click",function(){$("#pastePreview").addClass("hide"),$("#maskVerify").addClass("hide")})):e.addEventListener?e.addEventListener("paste",r):e.attachEvent("onpaste",r)},this.filterPaste=function(i,a){var c,u,f,m=this,h=-1!=navigator.appName.indexOf("Microsoft"),e=document.getElementById("html_input");function p(e){return e.getSelection?e.getSelection():e.document.selection}function g(e,t){e.removeAllRanges(),e.addRange(t)}function v(e){e.preventDefault()}function t(e){if(!m.plainText){var t=void 0;try{if(t=i.clipboardData&&i.clipboardData.getData?i.clipboardData.getData("Text"):e.clipboardData.getData("Text")||e.clipboardData.getData("text/plain"))return console.log("获取到了文本，就去按获取到的文本处理",t),m.filterPasteText(e,t,i,a)}catch(e){t=t&&m.filterPasteData(t)||""}return function(e,t){var i=t,a=_$("html_input"),n=a.contentWindow.document;{if(h){var o=n.selection.createRange();if(i)f=i;else{var s=document.getElementById("ifmTemp");s?s.contentWindow.document.body.innerHTML="":((s=document.createElement("IFRAME")).id="ifmTemp",s.style.width="1px",s.style.height="1px",s.style.position="absolute",s.style.border="none",s.style.left="-10000px",s.src="iframeblankpage.html",document.body.appendChild(s),s.contentWindow.document.designMode="On",s.contentWindow.document.open(),s.contentWindow.document.write("<body></body>"),s.contentWindow.document.close()),a.contentWindow.document.body.innerText,s.contentWindow.focus(),s.contentWindow.document.execCommand("Paste",!1,null),a.contentWindow.focus(),f="string"==typeof s.contentWindow.document.body.textContent?s.contentWindow.document.body.textContent:s.contentWindow.document.body.innerText,f=m.filterPasteData(f)}return o.pasteHTML(f),e&&(e.returnValue=!1,e.preventDefault&&e.preventDefault()),!1}if(i)return a.contentWindow.document.execCommand("inserthtml",!1,i),e&&(e.returnValue=!1,e.preventDefault&&e.preventDefault()),!1;var r=n.createElement("DIV");r.id="htmleditor_tempdiv",r.innerHTML="\ufeff",r.style.left="-10000px",r.style.height="1px",r.style.width="1px",r.style.position="absolute",r.style.overflow="hidden",n.body.appendChild(r),a.contentWindow.document.addEventListener("mousedown",v,!1),a.contentWindow.document.addEventListener("keydown",v,!1),enableKeyDown=!1,c=a.contentWindow,u=p(c).getRangeAt(0);var l=r.firstChild,d=n.createRange();return d.setStart(l,0),d.setEnd(l,1),g(p(c),d),"\ufeff"===("string"==typeof a.contentWindow.document.body.textContent?a.contentWindow.document.body.textContent:a.contentWindow.document.body.innerText)&&"",window.setTimeout(function(){if("\ufeff"===r.innerHTML)return f="",void n.body.removeChild(r);f="string"==typeof r.textContent?r.textContent:r.innerText,u&&g(p(c),u),f=m.filterPasteData(f),r.innerHTML=f,a.contentWindow.document.execCommand("inserthtml",!1,f),n.body.removeChild(r)},1),enableKeyDown=!0,a.contentWindow.document.removeEventListener("mousedown",v,!1),a.contentWindow.document.removeEventListener("keydown",v,!1),!0}}(e,t)}}e&&(h?(e.contentWindow.document.documentElement.attachEvent("onpaste",t),e.contentWindow.document.documentElement.attachEvent("ondrop",m.filterDrop)):(e.contentWindow.document.addEventListener("paste",t,!1),e.contentWindow.document.body.addEventListener("drop",m.filterDrop,!1)))},this.filterDrop=function(e){var t=(e=e||window.event).dataTransfer&&e.dataTransfer.getData("text");if(!t)return e.returnValue=!1,e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),!1;t=f.filterPasteData(t,void 0,f.plainText),f.isInrobot&&(t=t.substring(0,f.maxRobotLength));var i=f.getInputDoc(),a=f.getInputDocBody(),n=f.win,o=f.editorType,s=n?n.pos:null;if(3==o)n=window,s=f.preRange;else if(1==o)return void(s=f.textRange);if(i.selection&&!/opera/gi.test(view.chat.Browser.browser)){if(f.plainText?this.focus():n.focus(),!s)return e.dataTransfer.setData("text"),!0;setTimeout(function(){(s=(3==o?f.preRange:1==o?f.textRange:n.pos)||s).pasteHTML(t),s.collapse(!0),s.select()},1)}else if(window.getSelection){var r;if(s)if(1==o)_$("textInput").focus(),document.execCommand("insertText",!1,t);else{var l=i.createElement("div");l.innerHTML=t,(r=n.getSelection()).removeAllRanges(),s.deleteContents(),s.insertNode(l),s.setStartAfter(l),s.setEndAfter(l),f.isMobile||(r.removeAllRanges(),r.addRange(s))}else a.innerHTML+=t;l&&setTimeout(function(){a.scrollTop=l.offsetTop},100)}return e&&(e.returnValue=!1,e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()),!1}}!function(){var e=function(){function n(e,t,i){var a="0x"+t-65536;return a!=a||i?t:a<0?String.fromCharCode(65536+a):String.fromCharCode(a>>10|55296,1023&a|56320)}function o(){r()}var h,s,p,r,g=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,l=/^[^{]+\{\s*\[native \w/,d=/[\t\r\n\f]/g,t=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,c=/\S+/g,v={find:{},filter:{}},u=window.document,f=window.document,m="echatQuery"+1*new Date,b={},e=[],y=e.slice,w=e.push,I=new RegExp("\\\\([\\da-f]{1,6}"+i+"?|("+i+")|.)","ig"),i="[\\x20\\t\\r\\n\\f]";function k(e){return e._zid||(e._zid=z++)}var T={TAG:function(e){var t=e.replace(I,n).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=new RegExp("(^|"+i+")"+e+"("+i+"|$)");return function(e){return t.test("string"==typeof e.className&&e.className||void 0!==e.getAttribute&&e.getAttribute("class")||"")}}};function C(e){f.createElement;var t=f.createElement("div");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function S(e,t,i){var a=t&&t.ownerDocument;i=i||[];return e?e.nodeType||e==window.document||e==window?(this.context=e,this.results=[e],this.length=1,this):H(e)?void 0!==W?this.readyList.push(e):e():e instanceof S?e:((t?t.ownerDocument||t:u)!==f&&r(t),t=t||f,this.selector=e,this.context=t,this.results=function(e,t,i,a){if(!e)return i;var n,o,s,r,l,d=t?t.nodeType:9;if(r=g.exec(e),11!==d&&(r=g.exec(e)))if(n=r[1]){if(9===d){if(!(s=t.getElementById(n)))return i;if(s.id===n)return i.push(s),i}else if(t.ownerDocument&&(s=t.ownerDocument.getElementById(n))&&p(t,s)&&s.id===n)return i.push(s),i}else{if(n=r[2])return(u=v.find.TAG(n,t))&&w.apply(i,u),i;if((n=r[3])&&b.getElementsByClassName&&t.getElementsByClassName)return w.apply(i,t.getElementsByClassName(n)),i}1!==d&&(a=t,l=e);if(l)try{return w.apply(i,a.querySelectorAll(l)),i}catch(e){}var c,u=v.find.TAG("*",t),f=u.length;{if(o=0,c=r[2]){var m=[];if(i=t.getElementsByTagName(c),s=K,"*"!==c)return i;for(;s=i[o++];)1===s.nodeType&&m.push(s);return m}for(var h=(0,T.CLASS)(r[3]);o!==f&&null!=(s=u[o]);o++)s&&1===s.nodeType&&h(s)&&i.push(s)}return i}(e,t,i,a),void(this.length=this.results.length)):(this.length=0,this)}b.getElementsByTagName=C(function(e){return e.appendChild(f.createComment("")),!e.getElementsByTagName("*").length}),(r=function(e){var t,i,a=e?e.ownerDocument||e:u;return a===f||9!==a.nodeType||a.documentElement,s=(f=a).documentElement,(i=f.defaultView)&&i.top!==i&&(i.addEventListener?i.addEventListener("unload",o,!1):i.attachEvent&&i.attachEvent("onunload",o)),b.attributes=C(function(e){return e.className="i",!e.getAttribute("className")}),b.getElementsByTagName=C(function(e){return e.appendChild(f.createComment("")),!e.getElementsByTagName("*").length}),b.getElementsByClassName=l.test(a.getElementsByClassName),b.getById=C(function(e){return s.appendChild(e).id=m,!f.getElementsByName||!f.getElementsByName(m).length}),b.getById?(v.find.ID=function(e,t){if(void 0!==t.getElementById){var i=t.getElementById(e);return i?[i]:[]}},v.filter.ID=function(e){var t=e.replace(I,n);return function(e){return e.getAttribute("id")===t}}):(delete v.find.ID,v.filter.ID=function(e){var i=e.replace(I,n);return function(e){var t=void 0!==e.getAttributeNode&&e.getAttributeNode("id");return t&&t.value===i}}),b.qsa=l.test(a.querySelectorAll),v.find.TAG=b.getElementsByTagName?function(e,t){return void 0!==t.getElementsByTagName?t.getElementsByTagName(e):b.qsa?t.querySelectorAll(e):void 0}:function(e,t){for(var i,a=[],n=0,o=u.getElementsByTagName(e);i=o[n++];)1===i.nodeType&&p(t,i)&&a.push(i);return a},v.find.CLASS=b.getElementsByClassName&&function(e,t){if(void 0!==t.getElementsByClassName&&documentIsHTML)return t.getElementsByClassName(e)},t=l.test(s.compareDocumentPosition),p=t||l.test(s.contains)?function(e,t){if(!e||!t)return!1;var i=9===e.nodeType?e.documentElement:e,a=t&&t.parentNode;return e===a||!(!a||1!==a.nodeType||!(i.contains?i.contains(a):e.compareDocumentPosition&&16&e.compareDocumentPosition(a)))}:function(e,t){if(!e)return!1;if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},a})();var x=0,_=/(\=)\?(&|$)|\?\?/i;(h=function(e,t,i){return new S(e,t)}).ajaxJSONP=function(i,a){if(!("type"in i))return h.ajax(i);var n,e=window.document,t=i.jsonpCallback,o=(H(t)?t():t)||"jsonp"+ ++x,s=e.createElement("script"),r=window[o],l={abort:function(e){h(script).triggerHandler("error",e||"abort")}};a&&a.promise(l);e.getElementsByTagName("head")[0];function d(e,t){h(s).remove(),e&&"error"==e.type||!n?i.error&&i.error(null,t||"error",l,i,a):i.success&&i.success(n[0],l,i,a),window[o]=r,n&&H(r)&&r(n[0]),r=n=K}window[o]=function(){n=arguments};var c="$1"+o+"$2";i.url=i.url.replace(_,c);var u="";if(i.data){for(var f in i.data){var m="string"==typeof i.data[f]?i.data[f]:JSON.stringify(i.data[f]);u="&"+f+"="+encodeURIComponent(m)}u&&(u=u.substring(1),u+="&")}return i.url+=(/\?/.test(i.url)?"&":"?")+u+(i.jsonpCB||"jsonp")+"="+o,"onload"in s?(s.onload=d,s.onerror=function(){d({type:"error"})}):s.onreadystatechange=function(){/loaded|complete/.test(s.readyState)&&d()},i.beforeSend&&!1===i.beforeSend(l)?console.log("abort",i):(s.src=i.url,e.getElementsByTagName("head")[0].appendChild(s)),l},h.ajax=function(e){if("jsonp"==e.jsonp||"JSONP"==e.jsonp||"jsonp"==e.type||"JSONP"==e.type)return h.ajaxJSONP(e,e.deferred);var t=function(){var t;try{t=new XMLHttpRequest}catch(e){for(var i=["Msxml3.XMLHTTP","Msxml2.XMLHTTP","Microsoft.XMLHTTP"],a=0,n=i.length;a<n;a++)try{t=new ActiveXObject(i[a]);break}catch(e){continue}}return t}();if(t.onreadystatechange=function(){4==t.readyState&&(200==t.status?e.success&&e.success(t.responseText):e.error(t,t.responseText))},t.open(e.type,e.url,!0),e.header)for(var i in e.header)t.setRequestHeader(i,e.header[i]);e.header&&(e.header["Content-Type"]||e.header["Content-type"]||e.header["content-type"])&&!1===e.contentType||t.setRequestHeader("Content-type",e.contentType||"application/json;charset=UTF-8;"),e.beforeSend&&e.beforeSend(t);var a=e.data,n="";if(a&&"[object object]"==Object.prototype.toString.apply(a).toLowerCase())for(var o in a)n+="&"+o+"="+encodeURIComponent(a[o]);a=window.XMLHttpRequest?a||null:a||K,t.send(n?n.substring(1):a)};var E,a,M,N,R=/^-ms-/,D=/-([\da-z])/gi,L=function(e){return e.replace(R,"ms-").replace(D,function(e,t){return t.toUpperCase()})};(a=f.createElement("div")).innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",M=(M=(N=a.getElementsByTagName("a")[0])&&N.style).cssText="float:left;opacity:.5",E={float:M.cssFloat?"cssFloat":"styleFloat"},N=a=null;function P(e){return"string"==typeof e}var H=function(e){return null!=e&&("function"==typeof e||"[object Function]"===Object.prototype.toString.call(e))},B=function(e){return"[object Array]"===Object.prototype.toString.apply(e)},A={},F=A.toString;function $(e){return"object"==function(e){return null==e?String(e):A[F.call(e)]||"object"}(e)}function O(e){return null==e?"":(e+"").replace(t,"")}var U=function(e){return $(e)&&!function(e){return null!=e&&e==e.window}(e)&&Object.getPrototypeOf(e)==Object.prototype};function q(e,t,i){for(var a in t)i&&(U(t[a])||B(t[a]))?(U(t[a])&&!U(e[a])&&(e[a]={}),B(t[a])&&!B(e[a])&&(e[a]=[]),q(e[a],t[a],i)):t[a]!==K&&(e[a]=t[a])}h.extend=function(e,t,i){for(var a in t)i&&(U(t[a])||B(t[a]))?(U(t[a])&&!U(e[a])&&(e[a]={}),B(t[a])&&!B(e[a])&&(e[a]=[]),q(e[a],t[a],i)):t[a]!==K&&(e[a]=t[a]);return e},h.cookie=function(e,t,i){if(1<arguments.length&&(!/Object/.test(Object.prototype.toString.call(t))||null===t||t===K)){if(i=h.extend({},i),null!==t&&t!==K||(i.expires=-1),"number"==typeof i.expires){var a=i.expires,n=i.expires=new Date;n.setDate(n.getDate()+a)}return t=String(t),f.cookie=[encodeURIComponent(e),"=",i.raw?t:encodeURIComponent(t),i.expires?"; expires="+i.expires.toUTCString():"","; path="+(i.path||"/"),i.domain?"; domain="+i.domain:"",i.secure?"; secure":""].join("")}for(var o,s=(i=t||{}).raw?function(e){return e}:decodeURIComponent,r=f.cookie.split("; "),l=0;o=r[l]&&r[l].split("=");l++)if(s(o[0])===e)return s(o[1]||"");return null},h.toJSON=JSON.stringify;var V={src:!0,href:!0},j={isFunction:H,isArray:B,isString:P,isObject:$,isPlainObject:U,trim:O,contains:p,readyList:[],find:function(i){var a={};return this.each(function(e,t){S.call(a,i,t,a.results)}),a},match:function(i,e){var t=new S(e),a=null;return t.each(function(e,t){if(t==i||p(t,i))return a=t,!0}),a},parents:function(e){var t,i,a,n,o;if(e&&this.results&&0<this.results.length&&(t=g.exec(e))&&((o=t[1])?i=function(e){return e.id==o}:(o=t[2])?(o=o.toUpperCase(),i=function(e){return e.tagName==o}):(o=t[3])&&(i=function(e){if(e.className){for(var t=e.className.split(" "),i=0;i<t.length;i++)if(t[i]==o)return!0;return!1}}),i))for(a=this.results[0];n=a.parentNode;){if(i(n))return new S(n,this.context,[]);a=n}return new S(null,this.context,[])},html:function(i){return i||""===i?this.each(function(e,t){t.innerHTML=i}):this.results&&this.results[0]?this.results[0].innerHTML:null},text:function(i){return"string"==typeof i?this.each(function(e,t){"string"==typeof t.textContent?t.textContent=i:t.innerText=i}):this.results&&this.results[0]?this.results[0].textContent||this.results[0].innerText:null},append:function(i){if(i){if(P(i)){var e=f.createElement("div");e.innerHTML=i;var a=e.childNodes;this.each(function(e,t){var i;for(e=0;i=a[e++];)1==i.nodeType&&(i=i.cloneNode(!0),t.appendChild(i))})}else this.each(function(e,t){t.appendChild(i)});return this}},insertBefore:function(i,a){if(i){var n;if(P(i)){var e=f.createElement("div");e.innerHTML=i;var o=e.childNodes;this.each(function(e,t){var i;for(e=0;i=o[e++];)1==i.nodeType&&(i=i.cloneNode(!0),(n=a||t.childNodes[0])?t.insertBefore(i,n):t.appendChild(i))})}else this.each(function(e,t){(n=a||t.childNodes[0])?t.insertBefore(i,n):t.appendChild(i)});return this}},show:function(){return this.each(function(e,t){t.style.display="block"}),this},hide:function(){return this.each(function(e,t){t.style.display="none"}),this},removeClass:function(e){for(var t,i,a,n,o=this.results.length,s=0,r=0,l=(e||"").match(c)||[];r<o;r++)if(i=1===(t=this.results[r]).nodeType&&(t.className?(" "+t.className+" ").replace(d," "):"")){for(s=0;a=l[s++];)for(;0<=i.indexOf(" "+a+" ");)i=i.replace(" "+a+" "," ");n=e?O(i):"",t.className!==n&&(t.className=n)}else t.className="";return this},addClass:function(e){for(var t,i,a,n,o=this.results.length,s=0,r=0,l=(e||"").match(c)||[];r<o;r++)if(i=1===(t=this.results[r]).nodeType&&(t.className?(" "+t.className+" ").replace(d," "):"")){for(s=0;a=l[s++];)for(;i.indexOf(" "+a+" ")<0;)i+=a+" ";n=e?O(i):"",t.className!==n&&(t.className=n)}else t.className=e;return this},attr:function(e,t){if(!e)return this;if(void 0===t){if("string"==typeof e)return this.results&&0<this.results.length?this.getAttr(this.results[0],e):"";var i=this.results?this.results.length:0;for(var a in e)for(var n=0;n<i;n++){var o=this.results[n];V[a]?o[a]=e[a]:o.setAttribute(a+"",e[a])}}else for(i=this.results?this.results.length:0,n=0;n<i;n++){(o=this.results[n]).setAttribute(e,t),V[e]?o[e]=t:o.setAttribute(e,t)}return this},css:function(e,t){if(!e)return this;if(void 0===t)if("string"==typeof e)this.css(e,0===t?"0":"inherit");else for(var i=this.results?this.results.length:0,a=0;a<i;a++)for(var n in e){var o=L(n);o=E[o]||o;var s=this.results[a];try{s.style[o]=e[n]}catch(e){console.log(e.message),console.log("css:"+o+":"+n)}}else try{for(i=this.results?this.results.length:0,a=0;a<i;a++){o=L(e);o=E[o]||o,(s=this.results[a]).style[o]=t}}catch(e){return this}return this},remove:function(){for(var e=this.results?this.results.length:0,t=0;t<e;t++){var i=this.results[t];i.parentNode.removeChild(i)}return this.length=0,this.results=[],this},removeAttr:function(i){return this.each(function(e,t){t.setAttribute(i,""),t.removeAttribute(i)})},ready:function(e){for(var t,i=0;this.readyList&&(t=this.readyList[i]);)t.call(window),i++;return this},hasClass:function(e){for(var t=this.results?this.results.length:0,i=[],a=T.CLASS(e),n=0;n<t;n++){var o=this.results[n];a(o)&&i.push(o)}return i.length},max:function(e,t){return t<e?e:t},width:function(){return this.results&&this.results[0]?j.max(this.results[0].offsetWidth,this.results[0].clientWidth):null},height:function(){return this.results&&this.results[0]?j.max(this.results[0].offsetHeight,this.results[0].clientHeight):null},val:function(e){return void 0===e?this.results&&this.results[0]?this.results[0].value:null:(this.results&&this.results[0]&&(this.results[0].value=e+""),this)},getAttr:function(e,t){return e.getAttribute(t)},each:function(e,t){if(B(e))for(var i=0;i<e.length&&!t.call(e[i],i,e[i]);i++);else if(H(e)){t=e,e=this.results||[];for(i=0;i<e.length&&!t.call(e[i],i,e[i]);i++);}else for(var i in e)if(t.call(e[i],i,e[i]))break;return this}},W=function(){var e=function(){W&&(j.ready(),W=K)},t=window.document;function i(){t.removeEventListener("DOMContentLoaded",i,!1),t.removeEventListener("load",i,!1),e()}function a(){"complete"==t.readyState&&(t.detachEvent("onreadystatechange",a),t.detachEvent("onload",n),e())}function n(){t.detachEvent("onreadystatechange",a),t.detachEvent("onload",n),e()}if(t.addEventListener)t.addEventListener("DOMContentLoaded",i,!1),window.addEventListener("load",i,!1);else if(t.attachEvent)t.attachEvent("onreadystatechange",a),window.attachEvent("onload",n);else if(t.lastChild==t.body)return e();0<(t.getElementsByTagName("body")||[]).length&&e()};W(),h.fn=j,h.each=j.each;var K,z=1,J=(y=Array.prototype.slice,{}),Q={},Y="onfocusin"in window,X={focus:"focusin",blur:"focusout"},G={mouseenter:"mouseover",mouseleave:"mouseout"};function k(e){return e._zid||(e._zid=z++)}function Z(e,t,i,a){if((t=ee(t)).ns)var n=function(e){return new RegExp("(?:^| )"+e.replace(" "," .* ?")+"(?: |$)")}(t.ns);var o=J[k(e)]||[];for(var s,r=[],l=0;l<o.length;l++)!(s=o[l])||t.e&&s.e!=t.e||t.ns&&!n.test(s.ns)||i&&k(s.fn)!==k(i)||a&&s.sel!=a||r.push(o[l]);return r}function ee(e){var t=(""+e).split(".");return{e:t[0],ns:t.slice(1).sort().join(" ")}}function te(e,t){return e.del&&!Y&&e.e in X||!!t}function ie(e){return G[e]||Y&&X[e]||e}function ae(n,e,o,s,r,l,d){var t=k(n),c=J[t]||(J[t]=[]);h.fn.each(e.split(/\s/),function(e,t){if("ready"==t)return h(f).ready(o);var i=ee(t);i.fn=o,i.sel=r,i.e in G&&(o=function(e){var t=e.relatedTarget;if(!t||t!==this&&!h.contains(this,t))return i.fn.apply(this,arguments)});var a=(i.del=l)||o;i.proxy=function(e){if(!(e=de(e)).isImmediatePropagationStopped()){e.data=s;var t=a.apply(n,e._args==K?[e]:[e].concat(e._args));return!1===t&&(e.preventDefault(),e.stopPropagation()),t}},i.i=c.length,c.push(i),"addEventListener"in n?n.addEventListener(ie(i.e),i.proxy,te(i,d)):n.attachEvent("on"+ie(i.e),i.proxy)})}function ne(i,e,a,n,o){var s=k(i);h.fn.each((e||"").split(/\s/),function(e,t){h.fn.each(Z(i,t,a,n),function(e,t){delete J[s][t.i],"removeEventListener"in i?i.removeEventListener(ie(t.e),t.proxy,te(t,o)):i.detachEvent("on"+ie(t.e),t.proxy)})})}Q.click=Q.mousedown=Q.mouseup=Q.mousemove="MouseEvents",h.event={add:ae,remove:ne},h.proxy=function(e,t){var i=2 in arguments&&y.call(arguments,2);if(H(e)){function a(){return e.apply(t,i?i.concat(y.call(arguments)):arguments)}return a._zid=k(e),a}if(P(t))return i?(i.unshift(e[t],e),h.proxy.apply(null,i)):h.proxy(e[t],e);throw new TypeError("expected function")},h.fn.bind=function(e,t,i){return this.on(e,t,i)},h.fn.unbind=function(e,t){return this.off(e,t)},h.fn.one=function(e,t,i,a){return this.on(e,t,i,a,1)};var oe=function(){return!0},se=function(){return!1},re=/^([A-Z]|returnValue$|layer[XY]$)/,le={preventDefault:"isDefaultPrevented",stopImmediatePropagation:"isImmediatePropagationStopped",stopPropagation:"isPropagationStopped"};function de(a,n){return!n&&a.isDefaultPrevented||(n=n||a,h.each(le,function(e,t){var i=n[e];a[e]=function(){return this[t]=oe,i&&i.apply(n,arguments)},a[t]=se}),(n.defaultPrevented!==K?n.defaultPrevented:"returnValue"in n?!1===n.returnValue:n.getPreventDefault&&n.getPreventDefault())&&(a.isDefaultPrevented=oe)),a}function ce(e){var t,i={originalEvent:e};for(t in e)re.test(t)||e[t]===K||(i[t]=e[t]);return de(i,e)}function ue(){}h.fn.delegate=function(e,t,i){return this.on(t,e,i)},h.fn.undelegate=function(e,t,i){return this.off(t,e,i)},h.fn.live=function(e,t){return h(f.getElementsByTagName("body")[0]).delegate(this.selector,e,t),this},h.fn.die=function(e,t){return h(f.getElementsByTagName("body")[0]).undelegate(this.selector,e,t),this},h.fn.on=function(t,o,i,s,a){var r,l,n=this;return t&&!P(t)?(h.each(t,function(e,t){n.on(e,o,i,t,a)}),n):(P(o)||H(s)||!1===s||(s=i,i=o,o=K),s!==K&&!1!==i||(s=i,i=K),!1===s&&(s=se),n.each(function(e,n){a&&(r=function(e){return ne(n,e.type,s),s.apply(this,arguments)}),o&&(l=function(e){var t,i=(e=e||window.event).target||e.srcElement,a=j.match(i,o);if(a&&a!==n)return t=h.extend(ce(e),{currentTarget:a,liveFired:n}),(r||s).apply(a,[t].concat(y.call(arguments,1)))}),ae(n,t,s,i,o,l||r)}))},h.fn.off=function(e,i,t){var a=this;return e&&!P(e)?(h.each(e,function(e,t){a.off(e,i,t)}),a):(P(i)||H(t)||!1===t||(t=i,i=K),!1===t&&(t=se),a.each(function(){ne(this,e,t,i)}))},h.fn.trigger=function(e,t){return(e=P(e)||U(e)?h.Event(e):de(e))._args=t,this.each(function(){e.type in X&&"function"==typeof this[e.type]?this[e.type]():"dispatchEvent"in this?this.dispatchEvent(e):h(this).triggerHandler(e,t)})},h.fn.triggerHandler=function(i,a){var n,o;return this.each(function(e,t){(n=ce(P(i)?h.Event(i):i))._args=a,n.target=t,h.each(Z(t,i.type||i),function(e,t){if(o=t.proxy(n),n.isImmediatePropagationStopped())return!1})}),o},h.fn.each("focusin focusout focus blur load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select keydown keypress keyup error".split(" "),function(e,t){h.fn[t]=function(e){return 0 in arguments?this.bind(t,e):this.trigger(t)}}),h.Event=function(e,t){P(e)||(e=(t=e).type);var i=f.createEvent(Q[e]||"Events"),a=!0;if(t)for(var n in t)"bubbles"==n?a=!!t[n]:i[n]=t[n];return i.initEvent(e,a,!0),de(i)},h.isBoolean=ue,h.isDate=ue,h.isFunction=ue,h.isNaN=ue,h.isNumber=ue,h.isObject=ue,h.isRegExp=ue,h.isString=ue,h.isUndefined=ue;for(var fe=h,me="Array Boolean Date NaN Number Function Object RegExp Undefined".split(" "),he=0;he<me.length;he++){var pe=me[he];fe["is"+pe]=function(t){return function(e){return e!=e?"NaN"===t:RegExp(t).test(Object.prototype.toString.call(e))}}(pe)}return S.prototype=h.fn,h}();window.EChatQuery=e}(),function($){void 0===window.ECHATObjKeyMap&&(window.ECHATObjKeyMap={});var UTIL=function(justBase){this.ECHATConfig={contextPath:"/mychat/visitor"};var _self=this,Hi,Ii,aj;if(this.bot=/spider|bot/i.test(navigator.userAgent),this.subMap={},this.eventMap={},this.setSub=function(e){this.subMap[e]=e},this.removeSub=function(e){delete this.subMap["string"==typeof e?e:e.KEY]},this.publish=function(e){var t=this.subMap;for(var i in t){var a=ECHATObjKeyMap[i];if(a&&a.eventMap&&a.eventMap[e]){var n=a.eventMap[e];if(this.isArray(n))for(var o=0;o<n.length;o++)n[o].apply(a,arguments)}}},this.subscribe=function(e,t){this.eventMap[e]?this.eventMap[e].push(t):this.eventMap[e]=[t]},this.unSubscribeAll=function(){this.eventMap={}},this.unSubscribe=function(e){if(this.isArray(e))for(var t=0;t<e.length;t++)delete this.eventMap[e[t]];else delete this.eventMap[e]},this.isArray=function(e){return"[object Array]"===Object.prototype.toString.apply(e)},this.getQueryString=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),i=location.search.substr(1).match(t);if(null!=i)return decodeURIComponent(i[2])},this.escapeRegExp=(Hi=/[\\^$.*+?()[\]{}|]/g,Ii=new RegExp(Hi.source),function(e){return e&&Ii.test(e)?e.replace(Hi,"\\$&"):e}),this.getQueryParams=function(e){var t={};"string"!=typeof e&&(e=location.search),-1!=e.indexOf("#")&&(e=e.substring(0,e.indexOf("#"))),-1!=e.indexOf("?")&&(e=e.substring(e.indexOf("?")+1));for(var i,a=e.split("&"),n=a.length,o=0;o<n;o++)a[o]&&(i=a[o].split("="))[0]&&i[1]&&(t[i[0]]=decodeURIComponent(i[1]),t[i[0].toLowerCase()]=t[i[0]]);if(t.visEvt)try{var s=JSON.parse(t.visEvt);s&&s.eventId&&(t.eventId=s.eventId,t.eventid=s.eventId)}catch(e){t.visEvt=void 0,delete t.visEvt}return t},this.queryParams=this.getQueryParams(),this.companyId=this.getQueryString("companyid"),this.getBackground=function(e,t){var i=[],a=parseInt(t||100)/100,n=(e||"rgb(255,255,255)").toLocaleLowerCase().trim();if(0==n.indexOf("rgb"))n=n.replace("rgb","rgba").replace(")",","+a+")");else if(0==n.indexOf("#")){n=n.replace("#","").split("");for(var o=0;o<n.length;o++)3==n.length?i.push(parseInt("0x"+n[o]+n[o])):o%2==0&&i.push(parseInt("0x"+n[o]+n[o+1]));i.push(a),n="rgba("+i.join()+")"}return n},this.hasStorage=function(){var e;try{if(!window.localStorage)return!1;if(window.localStorage.setItem("echt_test_storage","ok"),!(e=window.localStorage.getItem("echt_test_storage")))return!1}catch(e){return!1}return e&&window.localStorage.removeItem("echt_test_storage"),!0}(),this.hasCookie=($.cookie("echt_test_cookie","ok"),!!$.cookie("echt_test_cookie")&&($.cookie("echt_test_cookie",null),!0)),$.store=(aj=this.hasStorage,aj?function(e,t,i){return e?1<arguments.length&&(!/Object/.test(Object.prototype.toString.call(t))||null==t)?(i=$.extend({},i),null==t&&(i.expires=-1),t=String(t),i.session?window.sessionStorage.setItem(e,t):window.localStorage.setItem(e,t),t):(i=t||{}).local?window.localStorage.getItem(e):i.session?window.sessionStorage.getItem(e):window.localStorage.getItem(e)||window.sessionStorage.getItem(e)||$.cookie(e):null}:$.cookie),!justBase){this.getDeviceInfo=function(){_self.deviceInfo=F;var b=_self,f=b.indexOf=(ej=Array.prototype.indexOf,"function"==typeof ej&&/\[native code\]/.test(ej.toString())||(ej=function(e){if(null==this)throw new TypeError;var t=Object(this),i=t.length>>>0;if(0==i)return-1;var a=0;if(0<arguments.length&&((a=Number(arguments[1]))!=a?a=0:0!=a&&a!=1/0&&a!=-1/0&&(a=(0<a||-1)*Math.floor(Math.abs(a)))),i<=a)return-1;for(var n=0<=a?a:Math.max(i-Math.abs(a),0);n<i;n++)if(n in t&&t[n]===e)return n;return-1}),function(e,t,i){return ej.call(t,e,i)}),ej,h=b.isFunction=function(e){return"function"==typeof e},i=b.isString=function(e){return"string"==typeof e},q=b.Browser=function(){var x=navigator,y=x.userAgent.toLowerCase(),osVersion=0,z=+(/trident.*rv:? *([0-9]+)/.exec(y)||[])[1]||!1,A=$s(),zz=/edge/.exec(y)||!A&&!!window.StyleMedia||!1,B=8==A,C=7==A,D=6==A,E=window.opera&&"[object Opera]"==Object.prototype.toString.call(window.opera)||/webkit/.test(y)&&(/opr/.test(y)||/opera/.test(y)),F="Google Inc."==navigator.vendor,G="Apple Computer, Inc."==navigator.vendor,H=!A&&(F||G||/webkit|khtml/.test(y)),I=+/\d+/.exec(/firefox\/\d+/i.exec(navigator.userAgent)||""),J=-1<y.indexOf("firefox/2"),K=-1<y.indexOf("firefox/3"),L=-1!=y.indexOf("iphone"),M=-1!=y.indexOf("ipod"),N=-1!=y.indexOf("ipad"),O=L||N||M,Q=-1!=y.indexOf("wp7"),kgBrowser=-1!=y.indexOf("kgbrowser"),meizu=-1!=y.indexOf("mzbrowser"),P=meizu||-1!=y.indexOf("android"),R=O||P||Q||kgBrowser||meizu,S,uc=-1!=y.indexOf("ucbrowser"),liebao=-1!=y.indexOf("lbbroser")||-1<y.indexOf("liebao"),qq=-1!=y.indexOf("qqbrowser"),sogou=-1!=y.indexOf("metasr")||-1!=y.indexOf("sogou"),f360=y.match(/360|qhbrowser|qihoobrowser/i),maxth=-1!=y.indexOf("maxthon"),baidu=-1!=y.indexOf("bidubrowser")||-1!=y.indexOf("baidubrowser")||-1!=y.indexOf("baidu"),weixin=-1!=y.indexOf("micromessenger"),chromeIphone=L&&-1!=y.indexOf("crios"),T=(A?"msie":I&&"firefox")||E&&"opera"||uc&&"uc"||liebao&&"liebao"||qq&&"qq"||zz&&"edge"||sogou&&"sogou"||f360&&"360"||maxth&&"maxth"||baidu&&"baidu"||weixin&&"weixin"||chromeIphone&&"chrome"||G&&"safari"||F&&"chrome"||H&&"chrome",U,V=A&&!W,W="CSS1Compat"==document.compatMode,X=!W,Y=A&&X&&document.documentElement&&!!document.documentElement.style.setExpression,Z=document.documentMode||A,$$=-1!=y.indexOf("windows")||-1!=y.indexOf("win32"),$_=-1!=y.indexOf("macintosh")||-1!=y.indexOf("mac os x")||-1!=window.navigator.platform.indexOf("Mac"),$a="https:"==document.location.protocol,$b=x.language||x.browserLanguage||x.userLanguage||x.systemLanguage,$c={noBoxSizing:Z<=7,ie:{cssBottomRight:D,cssFixed:D||Y,buggyCSS:D||Y}},$d="textContent"in document.createElement("div"),$e=!1;try{window.CustomEvent&&/\[native code\]/.test(window.CustomEvent.toString())&&(new window.CustomEvent("testevent",{bubbles:!1,cancelable:!0,detail:!0}),$e=!0)}catch(e){}switch(T){case"opera":U=+/\d+/.exec(new RegExp("opr[ /]\\d+").exec(y)||"");break;case"msie":case"firefox":case"chrome":U=U||+/\d+/.exec(new RegExp(T+"[ /]\\d+").exec(y)||"");break;case"baidu":U=+/\d+/.exec(new RegExp("bidubrowser[ /]\\d+").exec(y)||"");break;case"maxth":U=+/\d+/.exec(new RegExp("maxthon[ /]\\d+").exec(y)||"");break;case"qq":U=+/\d+/.exec(new RegExp("qqbrowser[ /]\\d+").exec(y)||"");break;case"liebao":U=+/\d+/.exec(new RegExp("lbbroser[ /]\\d+").exec(y)||"");break;case"uc":U=+/\d+/.exec(new RegExp("ucbrowser[ /]\\d+").exec(y)||"");break;case"sogou":U=+/\d+/.exec(new RegExp("metasr[ /]\\d+").exec(y)||"");break;default:U=+/\d+/.exec(/version[ \/]\d+/.exec(y)||"")}function $f(e){return e.replace(/^http:/,$a?"https:":"http:")}function $g(){return window.innerHeight!==a?window.innerHeight:document.documentElement?document.documentElement.offsetHeight:document.getElementsByTagName("body").length?document.getElementsByTagName("body")[0].clientHeight:0}function $h(){return window.innerWidth!==a?window.innerWidth:document.documentElement?document.documentElement.offsetWidth:document.getElementsByTagName("body").length?document.getElementsByTagName("body")[0].clientWidth:0}if(O&&(osVersion=+/\d+/.exec(new RegExp("iphone os \\d+").exec(y)||"")),D){var $i=[];$c.leaksMemory=function(e){p.isFunction(e),$i.push(e)};var $j=function(){for(var e=0;e<$i.length;e++)$i[e]()};$c.leaksMemory.remove=function(e){for(var t=$i.length-1;0<=t;t--)e==$i[t]&&$i.splice(t,1)},window.attachEvent("onunload",$j)}var $k="Shockwave Flash",$l="ShockwaveFlash.ShockwaveFlash",$m="application/x-shockwave-flash",$n="application/x-java-vm";function $o(){var e,t=x.plugins&&x.plugins[$k];if(t)return(e=x.mimeTypes&&x.mimeTypes[$m])&&!e.enabledPlugin?null:t.description;if(window.ActiveXObject)try{return(t=new window.ActiveXObject($l)).AllowScriptAccess="always",t.GetVariable("$version")}catch(e){}}function $p(){var e=x.mimeTypes;return A?!Q&&("javaEnabled"in x&&x.javaEnabled()):(e=e&&e[$n])&&(e=e.enabledPlugin)?e.name:void 0}function $q(){if(!k(S))return S;var e=document.createElement("div"),t=document.createElement("div"),i=e.style,a=t.style;return i.overflow="auto",i.width=i.height="100px",i.position="absolute",i.top="-1000px",a.width="100%",a.height="200px",e.appendChild(t),document.body.appendChild(e),S=e.offsetWidth-e.clientWidth,document.body.removeChild(e),S}function $r(){try{return eval("false")}catch(e){return!0}}function $s(){for(var e=3,t=document.createElement("div"),i=t.getElementsByTagName("i");t.innerHTML="\x3c!--[if gt IE "+ ++e+"]><i></i><![endif]--\x3e",i[0];);return 4<e?e:document.documentMode}var $t={browser:T,version:U,osVersion:osVersion,isStrict:W,isQuirks:X,isOpera:E,isSafari:G,isWebKit:H,isChrome:!E&&F,isAndroid:P,isIPhone:L,isIPod:M,isIPad:N,isIOS:O,isWP7:Q,isMobile:R,isEdge:zz,isNewIE:z,isIE:A,isIE6:D,isIE7:C,isIE8:B,isFF:I,isFF2:J,isFF3:K,isBorderBox:V,isCustomEvents:$e,engineIE:Z,bugs:$c,isWindows:$$,isXP:/windows nt 5.1/.test(y),isMac:$_,isLinux:/Linux/.test(navigator.platform),isSecure:$a,secureURL:$f,hasFlash:$o(),hasJava:$p(),language:$b,getScrollbarSize:$q,getWindowClientHeight:$g,getWindowClientWidth:$h,isTextContent:$d,hasCSP:$r()};return $t.isPC=!$t.isMobile&&($t.isWindows||$t.isMac||$t.isEdge||$t.isLinux),$t}(),x=b.__$$__jx_ui_HTMLElement,y=/google inc\./i,z=/chrome/i,A=/apple computer, inc\./i,B=/crios/i,C=window.navigator.userAgent||"",D=window.navigator.vendor||"",F={checkLandscape:L,getZoomLevel:Y,getOffset:Z},E=G();function G(){var e=C||D||window.opera;return/mobile|kgbrowser|(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))}function L(){return window.document.documentElement.clientWidth>window.document.documentElement.clientHeight}function R(){return E&&/(iemobile|windows phone)/i.test(C)}function T(){return E&&y.test(D)&&(!z.test(C)||/samsung/i.test(C))}function Y(){var e=window.document.documentElement.clientWidth,t=1.2<e/window.document.documentElement.clientHeight,i=window.screen.width,a=window.screen.height;t&&i<a&&(i=window.screen.height,a=window.screen.width);var n=window.innerWidth,o=e/i;window.devicePixelRatio&&T()&&640<i?o*=window.devicePixelRatio:R()&&(o*=1.5);var s=e/n/o;return s=(s/1.2).toFixed(2),(i/n).toFixed(2)}function Z(){var e=window,t=e.document.documentElement,i=e.document.body,a=null,n={top:0,left:0};if(h(t.getBoundingClientRect)&&(h(e.getComputedStyle)?"relative"==e.getComputedStyle(i).position?a=i:"relative"==e.getComputedStyle(t).position&&(a=t):i.currentStyle?"relative"==i.currentStyle.position?a=i:"relative"==t.currentStyle.position&&(a=t):"relative"==i.style.position?a=i:"relative"==t.style.position&&(a=t)),a){var o=a.getBoundingClientRect();n.top=o.top+e.pageYOffset-t.clientTop,n.left=o.left+e.pageXOffset-t.clientLeft}return n}_self.Device=F}();var isMobilePage=window.mobilePage||-1!=location.href.split("?")[0].indexOf("/visitor/mobile/")&&!ECHATObjKeyMap.outerId;_self.Browser.isMobile||isMobilePage||!_self.Browser.isPC?_self.Device.media=2:_self.Device.media=1,_self.Device.OS=(this.Browser.isWindows?"Windows":this.Browser.isIPhone&&"iPhone")||this.Browser.isIPad&&"IPAD"||this.Browser.isIPod&&"IPOD"||this.Browser.isMac&&"OSX"||this.Browser.isAndroid&&"Android"||this.Device.isWP&&"Windows Phone"||this.Browser.isLinux&&"Linux"||"others",this.hasTranslate=this.Browser.isMobile,this.setTransform=function(e,t){var i="translate("+e+"px,"+t+"px)";_self.hasTranslate?$(this).css({"-webkit-transform":i,"-o-transfrom":i,"-ms-transform":i,"-moz-transform":i,transform:i}):$(this).css({left:e+"px",top:t+"px"})},this.setScale=function(e){var t=this;(1/_self.deviceInfo.getZoomLevel()).toFixed(2),window.pageXOffset,window.pageYOffset,window.innerWidth,window.innerHeight,t[0].clientWidth,t[0].clientHeight};var _clearSlct="getSelection"in window?function(){window.getSelection().removeAllRanges()}:function(){document.selection.empty()},rm,sm;this.pageSlide=function(e,h){$(document).on("mousedown touchstart MSPointerDown pointerdown",e,function(e){e=e||window.event;var i;if(!(i=_isPointerEventType(e,"down"))||_isPrimaryTouch(e)){e=i?e:e.touches&&e.touches[0]||e;var a={x2:void 0,y2:void 0},n=0,o=$(this),s=this.parentNode.clientWidth,r=s/8,l=parseInt(o.attr("x")||this.offsetLeft)||0,d=this.clientWidth,c=-d+s-20;a.x1=e.clientX,a.y1=e.clientY,o.removeClass("transition");function u(e){e.preventDefault()}document.body.addEventListener("touchmove",u,{passive:!1});function f(e){e=i?e:e.touches&&e.touches[0]||e,a.x2=e.clientX,a.y2=e.clientY,n=a.x2-a.x1,a.y2-a.y1;var t=n+l;t=20<t?20:t<c?c:t,_self.setTransform.call(o,t,0),o.attr("x2",t),_clearSlct()}var m=function(e){if(_clearSlct(),o){o.addClass("transition");var t=0;if(r<Math.abs(n)){parseInt(o.attr("x2"));r<=n&&l+s<=0?(_self.setTransform.call(o,l+s,0),o.attr("x",l+s),t=-1):n<=-r&&0<l-s+d?(_self.setTransform.call(o,l-s,0),o.attr("x",l-s),t=1):_self.setTransform.call(o,l,0)}else _self.setTransform.call(o,l,0);var i=h&&h(t);if($(document).off("mousemover mousemove touchmove MSPointerMove pointermove",f).off("mouseup touchend MSPointerUp pointerup",m),o=null,_clearSlct(),!1===i)return e.stopPropagation&&e.stopPropagation,e.preventDefault&&e.preventDefault(),!1;document.body.removeEventListener("touchmove",u)}};$(document).on("mousemover mousemove touchmove MSPointerMove pointermove",f).on("mouseup touchend MSPointerUp pointerup",m)}})},this.getCSSRule=function(e,t,i){if(i=i||window.document,e=e.toLowerCase(),i.styleSheets)for(var a=0;a<i.styleSheets.length;a++){var n=i.styleSheets[a],o=0,s=!1;do{if((s=n.cssRules?n.cssRules[o]:n.rules[o])&&s.selectorText&&s.selectorText.toLowerCase()==e)return"delete"==t?(n.cssRules?n.deleteRule(o):n.removeRule(o),!0):s;o++}while(s)}return!1},this.killCSSRule=function(e){return this.getCSSRule(e,"delete")},this.addCSSRule=function(e){return document.styleSheets&&(this.getCSSRule(e)||(document.styleSheets[0].addRule?document.styleSheets[0].addRule(e,null,0):document.styleSheets[0].insertRule(e+" { }",0))),this.getCSSRule(e)},this.addJS=function(e,t){var i=document.createElement("script");i.setAttribute("type","text/javascript");var a=document.getElementsByTagName("head")[0];function n(e){i.onload=i.onerror=i.onreadystatechange=null,a.removeChild(i),t&&t(e,i.innerHTML),i=null}"onload"in i?(i.onload=n,i.onerror=function(){n(!0)}):i.onreadystatechange=function(){/loaded|complete/.test(i.readyState)&&n()},i.src=e,a.appendChild(i)},this.addCSS=function(e){var t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e,t.media="screen",document.getElementsByTagName("head")[0].appendChild(t)},this.base64encode=function(e){var t,i,a,n,o,s,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(a=e.length,i=0,t="";i<a;){if(n=255&e.charCodeAt(i++),i==a){t+=r.charAt(n>>2),t+=r.charAt((3&n)<<4),t+="==";break}if(o=e.charCodeAt(i++),i==a){t+=r.charAt(n>>2),t+=r.charAt((3&n)<<4|(240&o)>>4),t+=r.charAt((15&o)<<2),t+="=";break}s=e.charCodeAt(i++),t+=r.charAt(n>>2),t+=r.charAt((3&n)<<4|(240&o)>>4),t+=r.charAt((15&o)<<2|(192&s)>>6),t+=r.charAt(63&s)}return t},this.iScrollParam={preventDefault:!1,preventDefaultException:/^(A|PRE|INPUT|TEXTAREA|BUTTON|SELECT|LABEL)$/,tap:!1,click:!1,mouseWheel:!1,fadeScrollbars:!1},this.parseMsgByRule=function(s,e,t){if(e&&s){var i,a,o=this.regFace,r=this.regEmo||new RegExp("\\[#[a-z0-9A-Z]+(_[a-z0-9A-Z]+)?#\\]","g"),l=1,n=e[s.mt||0];return n?n=n.replace(/\$\{([^,]+),?([^,]+)?,?([^,]+)?,?([^,]+)?\}/g,function(e,t,i,n,a){if(l="1"==a?1:0,!i&&!n)return s[t];n=parseInt(n);var o=s[t];return 0<n&&o.replace(/\[#([^#]+)#\]/g,function(e,t,i,a){return i<n&&i+e.length>=n?n+=e.length-1:i<n&&(n+=e.length-1),e}),s[t].substring(i,n)}):(n=s.content)||(n=e[0]),(l||t&&t.notPlainText)&&(n=(i=n)&&i.replace(/<(?:.|\s)*?>/gi,"").substring(0,a||100)),n=o?n&&function(e){if(!e)return e;var n=this.emo;return n&&(e=e.replace(o,function(e){var t=e.charCodeAt(0),i=e.charCodeAt(1),a=(i-56320+(t-55296<<10)+65536).toString(16);return n[a]?'<img class="img-emo" src="/res/emoji/32/'+a+'.png" />':n[t+"_"+i]?'<img class="img-emo" src="/res/emoji/32/'+t+"_"+i+'.png" />':e})),e=e.replace(r,function(e){var t=e.replace(/^\[#([\d\w_]+)#\]/g,"$1");return n&&n[t]||!n?'<img class="img-emo" src="/res/emoji/32/'+t+'.png" />':e})}(n):n&&n.replace(r,"[face]")}},this.lastMsgRule={0:"您有新的消息",604:"您的对话已接通",605:"您的对话已结束",621:"给您发送了一个信息填写邀请",622:"给您发送了一个信息填写邀请",640:"${content,0,30,1}",641:"[图片]",642:"[文件]",647:"${content,0,30,1}",648:"等待接入会话，排队位置:${position}",653:"[图片]",657:"[图文消息]",673:"请您对本次服务进行评价",674:"您有新的消息",675:"您有新的消息",676:"您有新的消息",10011:"[图文消息]",864:"${content,0,30,1}",865:"[图片]",866:"[文件]",680:"[链接]"},this.formatUnreadMsg=function(e){var t=this;if(!e.lastMsgContent)return{unreadMsgCount:e.unreadMsgNumber||e.unreadMsgCount||0};var i=this.lastMsgRule;return function(e){this.needHttps&&e.companyLogo&&(e.companyLogo=e.companyLogo.replace(/^http:/,this.needHttps)),void 0!==e.unreadMsgNumber&&(e.unreadMsgCount=e.unreadMsgNumber),e.lastMsg=JSON.parse(e.lastMsgContent),e.msgContent=t.parseMsgByRule(e.lastMsg,i)}(e),{chatUrl:(this.loaderHost||location.origin)+"/visitor/mobile/chat.html?companyId="+e.companyId+"&platformSign="+encodeURIComponent(e.signature)+"&metaData="+encodeURIComponent(this.queryParams.metaData)+"&myData="+encodeURIComponent(this.queryParams.myData),msgId:e.mid,platformId:e.platformId||void 0,companyId:e.companyId,companyLogo:e.companyLogo,companyName:e.companyName,msgContent:e.msgContent,unreadMsgCount:e.unreadMsgCount}},this.sendMsgboxUnread=(rm={cookieName:"",cookieValue:"",readySendName:"",readySend:{lastMid:"",order:[123],123:{}},queue:[],pageTag:(new Date).getTime(),checkTimer:null,timeoutTimer:null},sm=null,{send:wm,queue:rm.queue,init:function(e){var t;!sm&&_self.visitorId&&(rm.cookieName="unreadNewMsg_"+_self.visitorId,rm.readySendName="unreadNewMsgMap_"+_self.visitorId,$.cookie(rm.readySendName,""),rm.cookieValue=$.cookie(rm.cookieName),rm.readySend=$.store(rm.readySendName),rm.readySend?rm.readySend=JSON.parse(rm.readySend):(rm.readySend={order:[]},$.store(rm.readySendName,'{ "order": [] }')),rm.cookieValue&&(t=rm.cookieValue.split("_")[0],rm.readySend[t]&&xm(rm.readySend[t])),sm=e)}}),$(document).on("drag",function(e){return(e=e||window.event).preventDefault&&e.preventDefault(),!1})}function _isPointerEventType(e,t){return e.type=="pointer"+t||e.type.toLowerCase()=="mspointer"+t||e.type=="mouse"+t}function _isPrimaryTouch(e){return-1<e.type.indexOf("mouse")||("touch"==e.pointerType||e.pointerType==e.MSPOINTER_TYPE_TOUCH)&&e.isPrimary}function um(){rm.readySend=$.store(rm.readySendName),rm.readySend=rm.readySend?JSON.parse(rm.readySend):{order:[]}}function vm(e,t){um();var i=rm.readySend.order;if(0===t){if(e.mid&&(rm.readySend.lastMid=e.mid),0<i.length){rm.readySend[e.mid]=void 0,delete rm.readySend[e.mid];for(var a=0;a<i.length;a++)i[a]==e.mid&&i.splice(a,1)}}else if(!rm.readySend[e.mid]&&(rm.readySend[e.mid]=e,rm.readySend.order.unshift(e.mid),10<rm.readySend.order.length)){for(a=10;a<i.length;a++)rm.readySend[i[a]]=void 0,delete rm.readySend[i[a]];rm.readySend.order.length=10}$.store(rm.readySendName,JSON.stringify(rm.readySend))}function wm(e){if(e&&(rm.queue.push(e),vm(e,1)),0!=rm.queue.length){var t=$.cookie(rm.cookieName);t&&(rm.checkTimer||rm.timeoutTimer)?rm.checkTimer||rm.timeoutTimer||(rm.timeoutTimer=setTimeout(function(){rm.timeoutTimer=null,wm()},300)):(!t&&rm.checkTimer&&clearTimeout(rm.checkTimer),!t&&rm.timeoutTimer&&clearTimeout(rm.timeoutTimer),xm(rm.queue.shift()))}}function xm(e){if(e){if(um(),rm.readySend.lastMid&&rm.readySend.lastMid>=e.mid)return wm();rm.cookieValue=e.mid+"_"+rm.pageTag,$.cookie(rm.cookieName,rm.cookieValue),rm.checkTimer=setTimeout(function(){rm.checkTimer=null,$.cookie(rm.cookieName)==rm.cookieValue&&(sm(e),$.cookie(rm.cookieName,""),vm(e,0)),$.cookie(rm.cookieName)?rm.timeoutTimer=setTimeout(function(){rm.timeoutTimer=null,wm()},300):wm()},200)}}};"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.toString().replace(/(^\s+)|(\s+$)/g,"")}),Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var i in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),t)new RegExp("("+i+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[i]:("00"+t[i]).substr((""+t[i]).length)));return e},window.UTIL=UTIL,"undefined"==typeof console&&(window.console={log:function(e){}})}(EChatQuery),function(k){var T=new function(e){k.cometd={getStatus:function(){return"sdk"}},UTIL.call(this,!0);var m=this,r=[],l=[],a=!(this.selfMsg=function(e,t){var i=e;switch("0"==i.id&&(i.id=i.mid),i.mt+""){case"10009":return!1!==i.isForward||m.lastTalkId||(m.lastTalkId=view.chat.talkId,m.lastTalkType=view.chat.isInRobot?3:!0===view.chat.chatting?1:2),!1===i.isForward&&4!=i.type&&10!=i.type&&9!=i.type&&view.chat.publish("__chatStatus","exceptionEnd"),i.justConnect=4!=i.type&&10!=i.type,void n(i);case"600":window.chatVisitorId="chatVisitorId"+i.visitorId,window.encryptVID=m.encryptVID=i.encryptVID,m.visitorId=i.visitorId,window.encryptVID=m.companyId=i.companyId,view.chat.initVisitor(),m.publish("setVisitorInfo",i),(i.routeEntranceInfo||i.routeEntranceInfoString)&&(i.routeEntranceInfo=i.routeEntranceInfo||JSON.parse(i.routeEntranceInfoString),m.waitForRouterSelect=!0,m.publish("displayRouterInfo",i)),m.unSubscribe(["sendVisitorEvent","visitorCommonEvent"]),m.subscribe("sendVisitorEvent",function(e,t,i){o(t,i,null,!0)}),m.subscribe("visitorCommonEvent",function(e,t,i){o(t,i,null,!1)}),m.publish("handshakeOk",e),!0,m.publish("updateVisitorInfo",i);break;case"671":m.publish("setChatParam",i);break;case"672":m.publish("setRestartTag",i);break;case"649":m.publish("setconfig",i),!0===view.chat.chatting&&!view.chat.isInRobot||m.publish("waitingChat",i);break;case"651":case"682":break;case"652":this.publish("getErr",i);break;case"646":this.publish("getChatToken",i);break;default:t||m.receiveChat(e,!0)}});function n(e){!1,e&&(m.publish("chatEnded",e),a=!1),m.unSubscribe(["sendVisitorEvent","visitorCommonEvent"]),m.unSubscribe("restartChat"),m.subscribe("restartChat",function(){view.chat.publish("__callNative",{functionName:"restartChat"})})}function o(i,a,e,t){var n=t?l:r,o=e?e.item:(new Date).getTime(),s=e||{data:i,cb:a,time:o,sending:!0};return e&&104!=i.et||n.push(s),m.publish("__sendMessage",i,function(e){if(a&&(e.bridgeMsgId=i.bridgeMsgId,a.apply(this,arguments)),e.successful){for(var t=n.length-1;-1<t;t--)if(n[t]&&n[t].time==o){n.splice(t,1);break}d(!1)}else s.sending=!1}),!0}function d(e){var t=e?l:r;if(0<t.length)for(var i,a=0;a<t.length&&((i=t[a]).sending||(i.sending=!0,o(i.data,i.cb,i)));a++);}this.receiveChat=function(e,t){var i=e;switch("0"==i.id&&(i.id=i.mid),i.mt+""){case"127":case"902":this.publish("sendLocationInfo",i);break;case"677":case"678":this.publish("startLeave",i);break;case"687":m.publish("startRobot",i);break;case"686":case"604":m.waitForRouterSelect=!1,function(e){m.publish("startChat",e)}(i),d(!0);break;case"605":return!1!==i.isForward||m.lastTalkId||(m.lastTalkId=view.chat.talkId,m.lastTalkType=view.chat.isInRobot?3:!0===view.chat.chatting?1:2),void(i.fromHistory&&!i.fromDB||n(i));case"620":return void this.publish("staffState",i);case"640":this.publish("getMsg",i);break;case"641":i.identityKey&&(i.fileIdentity=i.identityKey),i.clientFileId||(i.clientFileId=i.identityKey),this.publish("getMsgImg",i);break;case"642":i.identityKey&&(i.fileIdentity=i.identityKey),i.clientFileId||(i.clientFileId=i.identityKey),this.publish("getMsgFile",i);break;case"644":this.publish("getMsgTyping",i);break;case"647":this.publish("getSysMsg",i);break;case"648":this.publish("getPosMsg",i);break;case"650":return void this.publish("refreshVerify",i);case"655":i.current=!0,m.publish("getLeaveMsg",i);break;case"864":this.publish("getMsgMine",i);break;case"865":i.identityKey&&(i.fileIdentity=i.identityKey),view.fileMsgs[i.clientFileId]&&(view.fileMsgs[i.clientFileId].sendStatus=4),this.publish("getMsgImg",i);break;case"866":i.identityKey&&(i.fileIdentity=i.identityKey),view.fileMsgs[i.clientFileId]&&(view.fileMsgs[i.clientFileId].sendStatus=4),this.publish("getMsgFile",i);break;case"local":case"local_upload":i.identityKey&&(i.fileIdentity=i.identityKey),i.fileIdentity||(i.fileIdentity=i.clientFileId),2==i.sendStatus||4==i.sendStatus?1==i.fileType?this.publish("getMsgImg",i):this.publish("getMsgFile",i):w.prepareUpload(i);break;case"874":this.publish("getHistory",i);break;case"876":return void this.publish("overLength",i);case"890":this.publish("inviteBook",i);break;case"892":this.publish("inviteBookOK",i);break;case"670":return void m.publish("entryCallback",i);case"673":m.publish("inviteSatisfy",i),k.store("ECHAT_inviteSatisfyId",i.mid);break;case"675":return i.staffName=i.staffName||i.staffNickName,m.publish("getLeaveReply",i),void(a=!1);case"680":m.publish("receiveURL",i);break;case"923":return void m.publish("updateVisitorInfo",{visitorId:i.newVisitorId,photo:i.metaDataInfo.photo});case"928":return;case"12001":this.publish("getMsgRobot",i);break;case"10011":m.publish("receiveVisEvt",i);break;default:return void(t||m.selfMsg(e,!0))}a||(this.publish("removeLoading",i),a=!0),892!=i.mt&&890!=i.mt&&866!=i.mt&&874!=i.mt&&865!=i.mt&&864!=i.mt&&642!=i.mt&&641!=i.mt&&640!=i.mt||i.tm&&(view.chat.lastMsgTM=i.tm)},this.receive=function(){},m.subscribe("restartChat",function(){view.chat.publish("__callNative",{functionName:"restartChat"})}),m.subscribe("_endConnect",function(){n({justConnect:!0})}),m.subscribe("__callNative",function(e,t,i){h(t.functionName,t.value,i)}),m.unSubscribe("__registChatAction"),m.subscribe("__registChatAction",function(e,t){h("registChatAction",t)});var s={},c=0,u=(new Date).getTime()+"";m.subscribe("__sendMessage",function(e,t,i){t.publishAck&&(t.bridgeMsgId=t.publishAck.bridgeMsgId,delete t.publishAck),t.bridgeMsgId?t.isResend=1:t.bridgeMsgId=u+ ++c,h("sendMessage",t),s[t.bridgeMsgId]=i}),m.subscribe("__loadPreHistory",function(e,t,i){h("loadPreHistory",{baseTalkId:m.lastTalkId||"",talkType:m.lastTalkType||""})}),m.subscribe("removeLoading",function(e,t,i){h("removeLoading")});var f=1;function h(e,t,i){if(console.log(e,t,i),e)try{var a={functionName:e,value:t||""};i&&"function"==typeof i&&(a.callback="callback_"+f,window[a.callback]=function(){console.log("callback***"+a.callback,arguments),i.apply(i,arguments),window[a.callback]=null},f++),window.wkWebkit?window.webkit&&window.webkit.messageHandlers.callEchatNativeConnect.postMessage(JSON.stringify(a)):window.EchatJsBridge&&EchatJsBridge.callEchatNativeConnect(JSON.stringify(a))}catch(e){console.log(e)}}function p(e){return"string"==typeof e?JSON.parse(e+""):e}window.callEchatJsConnect=function(e){var t=p(e);"isCometdConnect"!=t.functionName&&"msgFromDB"!=t.functionName&&"msgFromUnRead"!=t.functionName&&console.log(">>>callEchatJsConnect:"+JSON.stringify(e)),t.functionName&&w[t.functionName]&&w[t.functionName](t.value)};var g,v={600:0,103:0,649:0,109:0,encryptVId:0},b=[],y=!1,w={preparedConnect:function(e){var t=p(e);if(window.initVisitorInfo,"0"==t.isConnect){if(y)return;y=!0;t.dataHost;var i="https://"+(t.dataHost||view.chat.json.dataHost).replace(/([^\.]+)\./,"$1api.")+"/getVisitorUnReadMsgCount?sdkAppId="+encodeURIComponent(e.appId)+"&sdkAppSecret="+encodeURIComponent(e.appSecret)+"&encryptVId="+encodeURIComponent(t.encryptVId)+"&visitorId="+encodeURIComponent(t.visitorId||""|m.visitorId)+"&metaData="+(t.metaData?encodeURIComponent(t.metaData):"");k.ajax({url:i,type:"jsonp",jsonpCB:"jsonpCallback",success:function(e){console.log(e),e&&0<e.unreadMsgCount&&(k("#restartChat").parents(".msg-info").remove(),view.chat.publish("restartChat"))},error:function(e){}})}},msgFromServer:function(e){if(e){console.log("msgFromServer",e);var t=p(e);t.bridgeMsgId&&s[t.bridgeMsgId]?(s[t.bridgeMsgId]&&s[t.bridgeMsgId](t),s[t.bridgeMsgId]=void 0):t.mt||t.encryptVId?(t.encryptVId&&(window.encryptVID=m.encryptVID=view.chat.encryptVID=t.encryptVId,t.companyId&&(m.companyId=view.chat.companyId=t.companyId)),t.mt&&"local"==t.mt&&t.fileType&&(1==t.fileType?t.mt="865":t.mt="866"),t.isForward=!1,m.receiveChat(t)):t.et||t.mt}},msgFromDB:function(e){var t=this;void 0===m.lastTalkIdFromNative&&T.publish("__callNative",{functionName:"queryTalkIDs"});var i,a,n,o=p(e),s=[],r=("null"==o.chatDetailList?[]:o.chatDetailList)||[],l=r[r.length-1],d=r[r.length-1].talkId||r[r.length-2].talkId;if("[object Array]"==Object.prototype.toString.call(r)&&0!=r.length){if(console.log("***msgFromDB***",k.extend([],r)),!m.lastTalkIdFromNative&&10009==l.mt){for(var c=r.length-2;1<c;c--){if(605==r[c].mt&&r[c].talkId!=d){i={talkId:r[c].talkId,chatDetailList:r.splice(0,c+1)};break}if(10009==r[c].mt&&r[c].talkId!=d){for(var u=c-1;1<u;u--)if(655!=r[u].mt&&r[u].talkId){i={talkId:r[u].talkId,chatDetailList:r.splice(0,c+1)};break}if(1!=u)break}}i&&(i.talkType=m.getTalkType(i.chatDetailList).talkType,setTimeout(function(){t.msgFromHistory(i)},1))}m.lastTalkIdFromNative||605!=l.mt&&10009!=l.mt||(l.isForward=!1,i||m.lastTalkId||(a=m.getTalkType(r),m.lastTalkId=a.talkId,m.lastTalkType=a.talkType));for(c=0;c<r.length;c++){if(o=r[c],!n&&(n=o.talkId)&&m.hasPageHandleMsg==n)return;o.isForward="0"!=o.isForward&&o.isForward,o.mt&&644!=o.mt&&10005!=o.mt?(void 0!==v[o.mt]?649==o.mt&&1==v[o.mt]?o.sdkChatBoxInfo&&s.push(o):(s.push(o),v[o.mt]=1):s.push(o),v.encryptVId=o.encryptVId||o.encryptVID||v.encryptVId):o.et&&104!=o.et&&1!=v[o.et]&&123!=o.et?void 0!==v[o.et]?(0==v[o.et]&&s.push(o),v[o.et]=1):s.push(o):"local"==o.mt&&(o.identityKey&&(o.fileIdentity=o.fileIdentity||o.identityKey),s.push(o)),o.id&&(o.id=o.mid||o.tm)}s.length&&m.handleHistoryMsg(s),m.hasPageHandleMsg=n}else m.hasPageHandleMsg=!0},allTalkIdFromHistory:function(e){if(console.log("******allTalkIdFromHistory****",e),m.lastTalkIdFromNative="",e){var t=p(e);1<t.length&&"null"==t[0]&&(t.shift(),view.chat.showPreHistory()),"null"==t[0]?view.chat.hidePreHistory():m.lastTalkIdFromNative=t[0]&&t[0].talkId||""}else view.chat.hidePreHistory()},msgFromUnRead:function(e){if("null"!=e&&e){var t=p(e);if("[object Array]"==Object.prototype.toString.call(t)){console.log("*****************msgFromUnRead*handle*****************",t),b={};var i,a,n,o,s,r=t.length,l=!0;console.log(t);for(var d=0;d<r;d++)if(a=(i=t[d].chatDetailList||[]).length,s=t[d].talkId,m.lastTalkId||(m.lastTalkId=g=s,m.lastTalkType=t[d].lastTalkType,m.lastTalkIdLocked=!0),a){if(d==r-1){"605"!=i[a-1].mt&&"10009"!=i[a-1].mt||(m.hasPageHandleMsg?m.hasPageHandleMsg!=t[r-1].talkId&&w.msgFromDB(t[r-1]):w.msgFromDB(t[r-1]));break}b[s]={talkId:s,talkType:t[d].talkType};for(var c=0;c<i.length;c++)n=i[c],b[s],600!=n.mt&&n.mt,3<c&&600==n.mt&&(l=!1),!(l||671!=n.mt&&109!=n.et&&103!=n.et)||3<c&&600==n.mt||(l&&(12001!=n.mt||3!=n.type||204!=n.result&&205!=n.result||(l=!0)),"649"==n.mt?o=n:"600"==n.mt?(n.routeEntranceInfo=void 0,n.routeEntranceInfoString=void 0,o=null):"670"!=n.mt&&679!=n.mt&&604!=n.mt&&648!=n.mt||(o&&(o.sdkEntranceInfo=void 0),o&&(o.captChaToken=void 0)),I(n,b[s],"unread"));view.chat.showHis(b[s],s)}}else console.log("msgFromUnRead value 为Array json 格式，兼容多个会话的未读消息",t)}else console.log("msgFromUnRead length:null")},msgFromHistory:function(e){if("null"!=e&&e){var t=p(e);m.lastTalkId=g=t.talkId,m.lastTalkType=t.talkIdType||t.talkType,m.lastTalkIdLocked=!0,g==m.lastTalkIdFromNative&&view.chat.hidePreHistory();for(var i={},a=t.chatDetailList||[],n=0;n<a.length;n++)I(a[n],i);console.log("%cmsgFromHistory showHis%c%o","color:green","color:green",i),view.chat.showHis(i,g)}else view.chat.hidePreHistory()},prepareUpload:function(e){var t=p(e);_$(t.clientFileId)&&k("#"+t.clientFileId).remove(),content=view.getMsgSendingFile(t),view.chat.showMsg({id:t.clientFileId,f:"c",media:1,m:3==t.fileType||4==t.fileType?t.fileType:1},content)},uploadKey:function(e){w.prepareUpload({clientFileId:e})},uploadStart:function(e){var t=p(e),i=view.getMsgSendingFile(t),a={1:lanRes.image,2:lanRes.fileHtml,4:lanRes.video,3:lanRes.voice};that.publish("__visitorStartSendMsg","["+a[t.fileType]+"]"),i&&view.chat.updateMsg(t.clientFileId,i)},uploadProgress:function(e){var t=p(e);if(!view.fileMsgs[t.clientFileId]||4!=view.fileMsgs[t.clientFileId].sendStatus){var i=view.getMsgSendingFile(t);i&&view.chat.updateMsg(t.clientFileId,i)}},updateLocalMessage:function(e){var t=p(e);view.fileMsgs[t.clientFileId]&&(view.fileMsgs[t.clientFileId]=t)},downloadProgress:function(e){var t=p(e),i=view.fileMsgs[t.clientFileId],a=_$(t.identityKey||t.fileIdentity);i&&(i.loadStatus=t.loadStatus),a&&(barInfo=k(".file-load-bar-info",a).results[0],a=k(".msg-file",a).results[0],barInfo&&(1==t.loadStatus?(barInfo.innerHTML="点击打开",view.fileMsgs[t.clientFileId]=k.extend(view.fileMsgs[t.clientFileId],e)):2==t.loadStatus?(barInfo.innerHTML=t.progress+"%",k(".file-load-progress0",a).css("width",t.progress+"%")):3==t.loadStatus&&(barInfo.innerHTML="点击下载")),a.className="msg-file file-load-status"+t.loadStatus)},callbackOpenFile:function(e){0==p(e).status&&alert("文件不存在")}};function I(e,t,i){var a=p(e);if(105==a.et||130==a.et||864==a.mt)a.mt=864,a.tm=a.tm||a.bridgeMsgId,a.f="c",130==a.et&&(a.ff="r"),a.m=0;else if(640==a.mt||641==a.mt||642==a.mt)a.f="s",640==a.mt&&(a.m=0),641==a.mt&&(a.m=2),642==a.mt&&(a.m=1);else if(127==a.et)a.f="c",a.mt=127;else if(12001==a.mt)a.f="r";else{if(104==a.et||644==a.mt||106==a.et||109==a.et)return;10011==a.mt&&(a.f=1==a.mst?"c":2==a.mst?"s":"x")}var n=a.tm||(new Date).getTime();673==a.mt&&"unread"!=i||(t[n]=a,t.order?t.order.push(n):t.order=[n]),649!=a.mt&&604!=a.mt&&600!=a.mt||(t.config?t.config.push(a):t.config=[a])}window.echatPageService=w,m.handleHistoryMsg=function(e){console.log("handleHistoryMsg",e);var t,i,a,n=e.length,o=e[n-1],s=!1,r=!0;if(n){if(600!=o.mt&&649!=o.mt||1!=n)if(605==o.mt)s=!0;else if(10009==o.mt)s=!0;else for(i=null,t=0;t<n;t++)o=e[t],3<t&&600==o.mt&&(r=!1),600==o.mt&&(m.companyId=o.companyId,void 0===a?a=t:e[a]=o),3<t&&600==o.mt||!(r||671!=o.mt&&109!=o.et&&103!=o.et)?(e.splice(t,1),t--,n--):(r&&(12001!=o.mt||3!=o.type||204!=o.result&&205!=o.result||(r=!0)),"649"==o.mt?i=o:"600"==o.mt?(o.routeEntranceInfo=void 0,o.routeEntranceInfoString=void 0,i=null):"670"!=o.mt&&"677"!=o.mt&&"678"!=o.mt&&679!=o.mt&&604!=o.mt||(i&&(i.sdkEntranceInfo=void 0),i&&(i.captChaToken=void 0)));else{if(!o.routeEntranceInfoString)return void!0;if(1==n)return w.msgFromServer(o)}var l,d=k.store("ECHAT_inviteSatisfyId"),c=!0;for(d==k.store("ECHAT_inviteSatisfyHandle")&&(c=!1),t=n-1;-1<t;t--)600==(o=e[t]).mt?(o.routeEntranceInfo||o.routeEntranceInfoString)&&t<n-1&&(o.routeEntranceInfo=null,o.routeEntranceInfoString=null):649==o.mt?s&&(o.sdkEntranceInfo=null,o.captChaToken=null):673==o.mt&&(c?d<o.mid?o.del=!0:l?o.del=!0:l=o:o.del=!0);var u=[];for(t=0;t<n;t++)(o=e[t]).del||(o.fromDB=!0,o.fromHistory=!0,670!=o.mt&&(12001==o.mt&&3==o.type&&t<n-2||(105==o.et||130==o.et?o.mt=864:127==o.et&&(o.mt=127),!1===o.isForward&&605!=o.mt&&10009!=o.mt&&u.push[o],"local"==o.mt||"local_upload"==o.mt?view.chat.showMsg({id:o.clientFileId,f:"c",media:1,m:3==o.fileType||4==o.fileType?o.fileType:1},view.getMsgSendingFile(o)):m.selfMsg(o))));if(s&&1<u.length){var f={data:{chatDetailList:u}};m.publish("receiveUnread",f)}}},this.getTalkType=function(e){for(var t,i=e.length-1;0<i;i--){if(t=e[i].talkId||t,604==e[i].mt||648==e[i].mt||647==e[i].mt&&5==e[i].type)return{talkType:1,talkId:t};if(12001==e[i].mt||647==e[i].mt&&10==e[i].type)return{talkType:3,talkId:t};if(647==e[i].mt&&7==e[i].type)return{talkType:2,talkId:t}}for(i=e.length-1;0<i;i--)if(649==e[i].mt&&2==e[i].status)return{talkType:2,talkId:t};return{talkType:2,talkId:t}}};(ECHATObjKeyMap.cometdId=T).setSub("chatId"),T.setSub("cometdId"),window.initChat=function(){k.store("ECHAT_chatStatus");setTimeout(function(){T.publish("__callNative",{functionName:"pageReady",value:{history:{data:[{mt:"649"},{mt:"604"},{mt:"10001"},{mt:"10011"},{mt:"865"},{mt:"641"},{mt:"10010"},{mt:"647"},{mt:"605"},{mt:"866"},{mt:"642"},{mt:"680"},{mt:"640"},{mt:"864"},{mt:"655"},{mt:"12001"},{mt:"673"},{mt:"648"},{mt:"local"},{et:"127"},{et:"105"},{et:"130"}]}}}),window.setVisitorInfo&&window.EchatJsBridge&&EchatJsBridge.callEchatNative('{"functionName": "getVisitorId","callback":"setVisitorInfo"}'),T.publish("__callNative",{functionName:"getUnReadMessage"})})},window.retryTime=0}(EChatQuery),function(x,_){var m;window._$=function(e){return e&&_.getElementById(e)},window._$s=function(e){return _.getElementsByTagName(e)},window.$=x,window.locationBase=window.locationBase||"",window.onerror=function(e){};var s={email:{p:/^[\w\d_\-\.]+@.+[\.].+/gi,msg:lanRes.invildEmail,length:50},phone:{p:/^[0-9\-]{0,20}$/,msg:lanRes.invildPhone,length:20},age:{p:/^[1-9][\d]{0,2}$/gi,msg:lanRes.invildAge,length:3},qq:{p:/^[1-9][\d]+$/gi,msg:lanRes.invildQQ,length:50},date:{p:/^[\d]{4}[-\/][\d]{2}[-\/][\d]{1,2}/gi,msg:lanRes.invildDate,length:50},address:{length:255},name:{length:50},wechat:{length:50},nickName:{length:50},birthday:{length:20},content:{length:1e3}};function w(e,t){if(e.isMini){var i=x("#content").height();x("#content").css("height",("close"==t?i+40:i-40)+"px")}else e.isMobile&&(x("#container").css(view.SDK?"paddingBottom":"bottom",x("#footer").height()+"px"),view.scrollToBottom&&view.scrollToBottom());view.scrollToBottom&&view.scrollToBottom()}function v(e,t,i,a){var n=!0;if(2<=e.length&&e[0]&&(e=e[0]),!t&&0<e.className.indexOf("req")){n=!1;var o="";o="text"==e.type?lanRes.inputPlease.replace("${inputName}",e.getAttribute("lb")):lanRes.inputPleaseJa2.replace("${inputName}",e.getAttribute("lb")),_$("leave_tip_con").innerHTML=o}else if(t&&s[i])if(s[i].length&&t.length>s[i].length){n=!1;o="";o="age"==i?lanRes.ageOverLengthJa.replace("${age}",e.getAttribute("lb")):e.getAttribute("lb")+lanRes.overLength,_$("leave_tip_con").innerHTML=o}else s[i].p&&!t.match(s[i].p)&&(n=!1,_$("leave_tip_con").innerHTML=s[i].msg);return view.chat.tipTimer&&clearTimeout(view.chat.tipTimer),a?(a&&a(n),n&&e.style?r():h()):n&&e.style?(e.style.borderColor="#FFFFFF",r()):(e.style.borderColor="#FF0000",h()),n}function h(e,t){view.chat.tipTimer&&clearTimeout(view.chat.tipTimer),e&&(_$("leave_tip_con").innerHTML=e),_$("leave_tip").className="leave-tip leave-tip-"+(t||"warn"),view.chat.tipTimer=setTimeout(function(){x("#leave_tip").addClass("tiphide")},3e3)}function r(){view.chat.tipTimer&&clearTimeout(view.chat.tipTimer),x("#leave_tip").addClass("tiphide")}function E(e){for(var t=!0,i=0;i<e.length&&(t=t&&"1"==e[i].configInline);i++);return t?"1":"0"}String.prototype.analyDomain=function(e){var t=this.toString(),i=[],a=t.indexOf(e);return 0<=a?(i[0]=t.substring(0,a),t.substring(a+1)&&(i[1]=t.substring(a+1))):i[0]=t,i};function i(){UTIL.call(this),InputHandle.call(this),this.talkId="",this.KEY="chatId",(ECHATObjKeyMap[this.KEY]=this).setSub(this.KEY),this.setSub("cometdId"),this.setSub("viewId"),this.errorList={},this.regFace=new RegExp("\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]|[#-®]|[‼-㊙]","g"),this.regEmo=new RegExp("\\[#[a-z0-9A-Z]+(_[a-z0-9A-Z]+)?#\\]","g"),this.unescapeSend=new RegExp("<d>","g"),this.isMobile=2==this.Device.media||view.SDK,this.isIOS=this.Browser.isIOS,this.isMini=!this.isMobile&&2==view.windowType,this.disableSoundTip=1==this.queryParams.disableSoundTip||view.SDKNative,this.plainText=!0,this.editorType=1,this.hasStorage=function(){try{if(!window.localStorage)return!1;if(window.localStorage.setItem("echt_test_storage","ok"),!window.localStorage.getItem("echt_test_storage"))return!1}catch(e){return!1}return!0}(),this.hasStorage&&(this.tempReferrer=this.hasStorage?window.localStorage.getItem("echat_temp_referrer"):"",window.localStorage.setItem("echat_temp_referrer","")),"https:"==location.protocol||window.SDK?this.needHttps="https:":this.needHttps="",this.initVisitor(),this.init(),this.initBridge(),this.postMessage("miniReady"),this.setChatbox=function(e,t){t&&x.store("ECHAT_"+view.chat.companyId+"_"+e,JSON.stringify({chatStaffBackColor:t.chatStaffBackColor,chatStaffTxtColor:t.chatStaffTxtColor,chatVisitorBackColor:t.chatVisitorBackColor,chatVisitorTxtColor:t.chatVisitorTxtColor,sysMsgBackground:t.sysMsgBackground,sysMsgFontColor:t.sysMsgFontColor}),{path:"/",expires:365})},this.getChatbox=function(e){var t=x.store("ECHAT_"+view.chat.companyId+"_"+e);return t&&JSON.parse(t)},this.addEchatInnerFrameParam=function(e){if(e){if(-1!=e.indexOf("&echatInnerFrame=1")||-1!=e.indexOf("?echatInnerFrame=1"))return e;var t=e.split("#"),i=t[1]||"",a=t[0],n=-1==a.indexOf("?")?0:1;return a+(n?"&":"?")+"echatInnerFrame=1"+(i?"#":"")+i}},this.addFixedParam=function(e){if(!e||!view.echatSoureTagEnable||e.match(/^(mailto|tel|javascript):/i))return e||"";var t,i=new RegExp("(^|&)echatSourceTag=([^&]*)(&|$)","i"),a=e.analyDomain("?"),n="echatSourceTag="+(this.echatSourceTag||"");return(t=(a[1]||a[0]).analyDomain("#"))[0].match(i)?e:e=1<a.length?a[0]+"?"+t[0]+"&"+n+(1<t.length?"#"+t[1]:""):t[0]+"?"+n+(1<t.length?"#"+t[1]:"")}}i.prototype={replaceHtml:function(e){return e=e&&e.replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[face]")},initBridge:function(){var n=this;var a=n.replaceHtml,o=new function(e,t,i){if(e&&i&&"function"==typeof i){var a=window,n=e;return a.addEventListener?(a.addEventListener("message",function(e){i(e,e.data)}),this.send=function(e){if(e&&t&&2==view.windowType&&window.top!=self)try{n.postMessage(e,t||"*")}catch(e){console.log(e)}}):this.send=function(){console.log("不支持 postMessage")},this}}(parent,n.queryParams.fromhost||(n.tempReferrer||_.referrer||"").split("/").slice(0,3).join("/"),function(e,t){n.publish("getCrossMessage",e)});this.subscribe("__chatStatus",function(e,t){n.outerChatStatus=t,o.send({act:100,eventAction:"chatStatus",eventLabel:t||""}),x.store("ECHAT_chatStatus",t);var i=_.getElementsByTagName("body")[0],a=i.className;a=a.replace(/chatstatus-[^\s]+/gi,""),t&&(a+=" chatstatus-"+t),i.className=a}),this.subscribe("__staffStatus",function(e,t){o.send({act:100,eventAction:"staffStatus",eventLabel:t||""})}),this.subscribe("__chatStart",function(e,t){o.send({act:200,eventAction:"Served by Agent",eventLabel:t||""})}),this.subscribe("__chatQueue",function(e,t){o.send({act:100,eventAction:"queuePostion",eventLabel:t||""})}),this.subscribe("__chatStaffInfo",function(e,t){o.send({act:100,eventAction:"chatStaffInfo",eventLabel:JSON.stringify(t)})}),this.subscribe("__newMsg",function(e,t){var i=t.m;"s"==t.f&&t.c&&o.send({act:100,eventAction:"newMsg",eventLabel:0==i?a(t.c):1==i?"[file]":2==i?"[image]":""}),"r"==t.f&&(t.answer||t.c)&&o.send({act:100,eventAction:"newMsg",eventLabel:a(t.answer||t.c)})}),this.subscribe("__newSysMsg",function(e,t){var i=t.m;t.c&&o.send({act:100,eventAction:"newSysMsg",eventLabel:0==i?a(t.c):1==i?"[file]":2==i?"[image]":""})});var s=["","angry","unsatisfied","ok","satisfied","perfect"];this.subscribe("__evaluate",function(e,t){o.send({act:100,eventAction:"visitorEvaluate",eventLabel:t||""});var i=t.split("-");0==i[0]?o.send({act:200,eventAction:"Chat_Evaluate_Cancel",eventLabel:1==i[1]?"chatting":"end"}):o.send({act:200,eventAction:"Chat_Evaluate_"+s[n.evaluateScore-0],eventLabel:1==i[1]?"chatting":"end"})}),this.subscribe("__evaluateComment",function(e,t){o.send({act:200,eventAction:"Chat_Comment_submit",eventLabel:t.chatting?"chatting":"end"})}),this.subscribe("__visitorHide",function(e,t){o.send({act:100,eventAction:"visitorHide",eventLabel:t||""})})},initVisitor:function(){s={email:{p:/^[\w\d_\-\.]+@.+[\.].+/gi,msg:lanRes.invildEmail,length:50},phone:{p:/^[0-9\-]{0,20}$/,msg:lanRes.invildPhone,length:20},age:{p:/^[1-9]([0-9]|([0-2][0-7])?)$/g,msg:lanRes.invildAge,length:3},qq:{p:/^[1-9][\d]+$/gi,msg:lanRes.invildQQ,length:50},date:{p:/^[\d]{4}[-\/][\d]{2}[-\/][\d]{1,2}/gi,msg:lanRes.invildDate,length:50},address:{length:255},name:{length:50},wechat:{length:50},nickName:{length:50},birthday:{length:20},content:{length:1e3}},this.dataHost=window.dataHost,x("#inputLengthTip").html(lanRes.inputLengthTip1+" 30 "+lanRes.inputLengthTip2),view.SDK||(window.chatVisitorId&&x.store("ECHAT_"+window.companyId+"_chatVisitorId",chatVisitorId),window.encryptVID&&(x.store("ECHAT_"+window.companyId+"_encryptVID",encryptVID),this.encryptVID=encryptVID))},init:function(){view.initViewEvent(this);var T=this;if(T.showTip=h,T.checkIpt=v,T.uploadServiceType=1,T.defaultVisitorImg=locationBase+"/res/imgs/visitor.png",T.defaultStaffImg=locationBase+"/res/imgs/staff.png",this.paramChat={companyId:T.companyId,visitorId:T.visitorId,firstTitle:T.queryParams.firstTitle||"",firstUrl:T.queryParams.firstUrl||"",referrer:T.queryParams.referrer||"",chatPage:T.queryParams.enterUrl||T.tempReferrer||_.referrer||"",chatPageTitle:T.queryParams.enterTitle||"",metaData:T.queryParams.metadata||"",myData:T.queryParams.myData||"",info:T.queryParams.info||"",echatTag:T.queryParams.echattag||"",lan:window.lanName,visEvt:T.queryParams.visEvt||"",eventId:T.queryParams.eventId||"",media:view.windowType||"",staffId:this.staffId||"",staffName:this.staffName||"",talkId:this.talkId||"",multipleFile:T.queryParams.multipleFile||0},window.initVisitorInfo){for(var e in window.initVisitorInfo)this.paramChat[e]=window.initVisitorInfo[e];try{var t="string"==typeof window.initVisitorInfo.visEvt?window.initVisitorInfo.visEvt:JSON.parse(window.initVisitorInfo.visEvt);t&&t.eventId&&(this.paramChat.eventId=t.eventId)}catch(e){}}this.subscribe("setConfig",function(e,t){var i;i=T.isInRobot?view.SDK?t.robotSdkChatBox:T.isMobile?t.robotPhoneChatBox:2==view.windowType?t.robotSmallChatBox:t.robotPCChatBox:(t.chatBoxInfo||t.chatSmallBoxInfo||t.mobileChatBoxInfo||t.sdkChatBoxInfo||(t=T.msg649),view.SDK?t.sdkChatBoxInfo:T.isMobile?t.mobileChatBoxInfo:2==view.windowType?t.chatSmallBoxInfo:t.chatBoxInfo),view.echatSoureTagEnable=t.echatSoureTagEnable?parseInt(t.echatSoureTagEnable||0):0,view.hasSetAD&&(view.hasSetAD=!1,view.canSetAD=1),i&&(i.chatBoxTitle&&(view.pageTitle=i.chatBoxTitle,view.titles&&(view.titles[1]=i.chatBoxTitle),T.changeDocTitle(i.chatBoxTitle),view.setDocumentTitle&&view.setDocumentTitle("c")),T.defaultStaffImg=i.defaultStaffImg||T.defaultStaffImg,T.defaultVisitorImg=i.defaultVisitorImg||T.defaultVisitorImg,T.needHttps&&(T.defaultStaffImg=T.defaultStaffImg.replace(/^http:/,T.needHttps),T.defaultVisitorImg=T.defaultVisitorImg.replace(/^http:/,T.needHttps)),T.busyCanSend="1"!=i.busyNotAllowSendStatus,x("#busyTip").html((i.busyNotAllowTips||"").replace(/(<p>|<\/p>)/gi,"")),x("#busyTipLine").addClass("hide").hide(),view.setConfig(T,t,i),Number(i.toolEmoji)?x(".menu-emo").removeClass("style-tool-hide"):x(".menu-emo").addClass("style-tool-hide"),Number(i.toolFile)?x(".menu-file").removeClass("style-tool-hide"):x(".menu-file").addClass("style-tool-hide"),Number(i.toolSatisfaction)?x(".menu-satisfy").removeClass("style-tool-hide"):x(".menu-satisfy").addClass("style-tool-hide"),Number(i.toolScreenshot)?x(".menu-capture").removeClass("style-tool-hide"):x(".menu-capture").addClass("style-tool-hide"),Number(i.toolTelephone)?x(".menu-phone").removeClass("style-tool-hide"):x(".menu-phone").addClass("style-tool-hide")),T.toolScreenshot=Number(i?i.toolScreenshot:0)||0,T.leaveWordInfo=t.leaveWordInfo||t.mobileLeaveWordInfo||T.leaveWordInfo}),T.subscribe("sendLocationInfo",function(e,t){T.showLocation(t)}),T.leaveMsgMap={},T.subscribe("getLeaveMsg",function(e,t,i){t.realTalkId||(t.realTalkId=t.newsMsgId,t.fromHistory&&!t.current||(t.talkId=T.talkId||t.newsMsgId+"leave"));var a='<li class="clearfix '+(1!=t.read||t.current?"fold":"")+'" talkid="'+t.talkId+'" id="msg'+t.tm+'"><div class="msg-leave" k="'+t.signature+'"><div class="msg-leave-title"><i class="msg-leave-i"></i><span class="msg-leave-t">'+((t.staffNickName?'<span class="color0">'+t.staffNickName+"&nbsp;</span>":lanRes.serviceStaff)+(4==t.chatInfoType?lanRes.staffLeave:lanRes.leaveStaffReply))+'</span></div><div class="msg-leave-con" ><div class="msg-leave-content">'+T.filterEmo(t.brief)+'</div><div class="msg-leave-dot">...</div><div class="msg-leave-link color0">'+lanRes.viewAll+"</div></div></div></li>",n=_.createElement("ul");n.innerHTML='<li class="clearfix" ><div class="color1 tc">'+T.getTimeStr(t.tm)+"</div></li>"+a;for(var o,s=this.getListMsgEl(t.talkId,t.tm,!!t.current),r=n.childNodes,l=0;o=r[l++];)1==o.nodeType&&(o=o.cloneNode(!0),s.appendChild(o));n=r=null,view.scrollToBottom(null,{transitionDuration:100,timeout:100}),t.current&&(t.f=i?"r":"s",t.c=t.brief,delete t.content,delete t.current,T.pushHistory(t),3==t.chatInfoType&&x(s).addClass("new-leave"),s=null),T.leaveMsgMap[t.signature]=t}),T.subscribe("overLength",function(){h(lanRes.overLength)});var a;view.chat.Browser.isAndroid&&navigator.userAgent.indexOf("baiduboxapp");function n(e,i){T.oldBodyEnterText;var a=T.getInput(!1),n=e.currentTarget,o=n.innerHTML;if(e.clipboardData){e.clipboardData.getData("text");e.clipboardData.items[0].getAsString(function(e){var t=i-a.length;(a=T.getInput(!1)).length>=i&&(n.innerHTML=o+e.substr(0,t),x("#inputLengthTip").html(lanRes.inputLengthTip1+" 0 "+lanRes.inputLengthTip2))})}else setTimeout(function(){(a=T.getInput(!1)).length>i?n.innerHTML=o:T.oldBodyEnterText=a,x("#inputLengthTip").html(lanRes.inputLengthTip1+"&nbsp;"+(i-T.oldBodyEnterText.length)+"&nbsp;"+lanRes.inputLengthTip2)})}function r(e,t){T.unSubscribe("_showCommonQue");var i=t.content,a=t.commonQuestions&&JSON.parse(t.commonQuestions);if(a&&a.length){t.commonQuesWords?i+='<div class="common-ques-tip">'+t.commonQuesWords+'</div><ul class="common-ques-list">':i+='<ul class="common-ques-list">';for(var n=0;n<a.length;n++)i+='<li class="common-ques-li" did="'+a[n].id+'" ques="'+escape(a[n].question)+'"><span class="list-style-dot">'+(n+1)+'.</span><span class="link-robot-ques">'+a[n].question+"</span></li>";i+="</ul>"}t.notStore||(T.talkId=t.talkId,T.paramChat.talkId=T.talkId,T.paramChat.staffPhone="",T.paramChat.staffInfo="",T.robotTalkId=t.talkId,view.startChatRefreshAD&&view.startChatRefreshAD(),T.publish("__chatStaffInfo",{staffId:T.paramChat.staffId,staffNickName:T.staffName||"",staffHead:T.staffImg,staffInfo:T.robotExtInfo.autograph||"",recordId:(T.isInRobot?"5_":"1_")+T.talkId})),T._getMsg.call(this,x.extend(t,{tm:t.tm,mt:12001,ff:"r",answer:t.content,staffImg:T.staffImg,staffName:T.staffName,content:i}),0,i,"r")}x("#enter_btn").on(T.isMobile?"touchend":"click",function(e){T.publish("_sendMsg");try{3==T.editorType?window.getSelection().empty():2==T.editorType&&T.win.getSelection().empty()}catch(e){}T.isMobile&&"qq"!=T.Browser.browser&&"weixin"!=T.Browser.browser&&"uc"!=T.Browser.browser&&(view.hideMenus(),T.getInputDocBody().blur(),view.inputBlur&&view.inputBlur(e))}),T.loadConsole=function(e){T.loadConsole=void 0,T.addJS(__uri("/visitor/mobile/js/vconsole.js"),function(e){var t=window.console;new VConsole;t.log("location.href",location.href),t.log("msg600::",T.msg600),t.log("msg649::",T.msg649),T.subscribe("echatLog",function(e,t,i){window.console.log(t,i)})})},T.visitorCloseFunc=function(e){if(!(T.visitorClose=!0)===T.chatting||"disconnected"==EChatQuery.cometd.getStatus())T.publish("__visitorCloseCallback",{type:"close",memo:"对话已经结束/连接已经断开,可直接销毁"}),T.publish("_closeWin");else{function t(){T.visitorClose=!0,T.publish("_endChat"),T.leaveAndClose?(T.publish("_endConnect"),T.publish("_closeWin")):T.hasEntryOrCode||"0"==T.queryParams.autoChat?(T.publish("entryCallback",{success:!0}),T.publish("_endConnect"),T.publish("chatEnded",{closeReason:1}),T.publish("__visitorCloseCallback",{type:"close",memo:"信息收集/验证码,访客确认关闭"}),T.publish("__chatStatus","end-1-0"),T.publish("_closeWin")):ECHATObjKeyMap.cometdId.waitForRouterSelect?(T.publish("_endConnect"),T.publish("__visitorCloseCallback",{type:"close",memo:"咨询入口选择时,访客确认关闭"}),T.publish("__chatStatus","end-1-0"),T.publish("_closeWin")):T.outerChatStatus&&T.outerChatStatus.match(/waiting|chatting|leaveToService/)?T.publish("__visitorCloseCallback",{type:"wait",memo:"等待H5发送结束指令,Native将根据结束状态决定关闭view"}):(T.publish("__visitorCloseCallback",{type:"close",memo:"根据状态发现对话没有建立,访客确认关闭"}),T.publish("__chatStatus","end-1-0"))}if(1===e)return t();T.showDialog({tip:lanRes.closeTip,ok:t,cancel:function(){T.visitorClose=!1,T.publish("__visitorCloseCallback",{type:"cancel",memo:"访客取消关闭"})}})}},x(".action-close").on("click",T.visitorCloseFunc),x("#pre_his").on("click",function(){T.loadHistory()}),x("#inputPlaceholder").on("mouseover touchstart",function(){x(this).addClass("hide")}),this.subscribe("_endChat",function(e,t){T.publish("sendVisitorEvent",{et:107},function(){}),T.postMessage(3)}),x("#changelang").on("change",function(e){switch(parseInt(this.value)){case 0:lanResName="zhcn";break;case 1:lanResName="enus";break;case 2:lanResName="jp";break;default:lanResName="zhcn"}var t=_.createElement("script"),i=_$("langScript"),a=i.parentNode;t.id="langScript",t.src=supportLang[lanResName],a.replaceChild(t,i)}),x(_).on("click",".resend",function(){if(!view.handleNetwok||!view.handleNetwok()){var e=x(this).attr("dataid"),t=T.errorList[e];if(t.id=e,t.m=t.m||0,t.f=t.f||"c",t.c=t.c||t.content,!1!==T.chatting&&void 0!==T.chatting)if(T.isInRobot&&7==t.m)T.showTip("请进入人工服务后再发送位置消息");else{var i=_$(e);(i=i.previousElementSibling)&&i.childNodes[0]&&-1!=(i.childNodes[0].className+"").indexOf("color1")&&x(i).remove(),x("#"+e).remove(),T.sendToServer(t)}else 7==t.m?T.showTip("请进入人工服务后再发送位置消息"):T.showTip("请继续对话后再发送消息")}}).on("click",".btn-restart",function(){view.handleNetwok&&view.handleNetwok()||("restartChat"==x(this).attr("id")&&setTimeout(function(){T.publish("restartChat")},10),x(".btn-restart").removeAttr("id").removeClass("btn-restart"),x(this).removeAttr("id").removeClass("btn-restart").text(lanRes.chatContinued))}),this.subscribe("displayRouterInfo",function(e,t){var a,n=t.routeEntranceInfo;a="string"==typeof n.entranceDetails?JSON.parse(n.entranceDetails):n.entranceDetails,n.chatBoxTitle&&(view.pageTitle=n.chatBoxTitle,T.changeDocTitle(n.chatBoxTitle));var i=n.routeStatusList,o={};if(i&&i.length)for(var s=0;s<i.length;s++)o[i[s].routeId]=2!=i[s].routeStatus;for(var r='<div id="routerTitle" class="router-title '+(n.title?"":"router-hide")+'">'+n.title+'</div><div id="routerList" class="router-list"><ul class="clearfix">',l=0,d=n.lines,c=n.chosenColor||"#0da7db",u=0;u<a.length;u++){var f=a[u].routeId;if(f){l++,o[f]||(a[u].icon=a[u].offlineIcon||a[u].icon,a[u].content=a[u].offlineContent||a[u].content);var m=l%d==0;T.needHttps&&a[u].icon&&(a[u].icon=a[u].icon.replace(/^http:/,T.needHttps)),r+='<li class="router-item router-item-content'+(a[u].icon&&!a[u].content?1:a[u].icon&&a[u].content?2:!a[u].icon&&a[u].content?3:a[u].icon||a[u].content?"":3)+'" data="'+f+'" dataindex="'+u+'" '+(m?'style="border-right:none;"':"")+'><div class="router-item-content"><div class="router-item-icon '+(a[u].icon?"":"router-hide")+'">'+(a[u].icon?'<img onload="view.checkImg&&view.checkImg(this)" src="'+a[u].icon+'"/>':"")+"</div>"+(1==view.windowType?'<div class="router-item-text '+(a[u].content?"":"router-hide")+'">'+(a[u].content?'<div class="router-item-text-bg" style="background:'+c+';"></div><div class="router-item-text-tx">'+a[u].content+"</div>":"")+"</div>":"")+'</div><div class="router-item-theme">'+a[u].theme+"</div></li>"}}if(r+="</ul></div>",T.publish("removeLoading"),0==l)ECHATObjKeyMap.cometdId.waitForRouterSelect=!1,x("#router").hide();else{x("#loading").hide(),x("#mask").show();var h,p=150*d;x("#router").addClass("router-line"+d).html(r).css({width:view.px2rem?view.px2rem(p):p+"px",marginLeft:view.px2rem?view.px2rem(-p/2):-p/2+"px"}).show().removeClass("slideUp"),T.isMobile||x(".router-item").on("mouseover touchstart",function(e){x(this).addClass("hover"),x(".router-item-theme",this).css({background:c,color:"#FFF"})}).on("mouseout touchend",function(e){x(this).removeClass("hover"),x(".router-item-theme",this).css({background:"#fff",color:"#323232"})}),x(".router-item").off("click").on("click",function(e){var t=x(this).attr("dataindex"),i=x(this).attr("data");i&&a[t]&&a[t].routeId==i&&(T.routeId=i,T.routeEntranceTheme=a[t].theme,T.paramChat.echatTag=a[t].routeEntranceEchatTag||T.routeEntranceTheme,x("#loading").show(),T.publish("routerSelect"),T.publish("toSetID"),x("#router").hide(),x("#mask").hide(),ECHATObjKeyMap.cometdId.waitForRouterSelect=!1,n=a=null)}),view.handleRouterSelect&&view.handleRouterSelect(l,d)||(h=x("#router").height()||200,x("#router").css({marginTop:-h/2+"px"}))}}),this.subscribe("getLeaveReply",function(e,t){t.content&&T._getMsg(t,0,t.content),928!=t.from&&T.publish("toSetID")}),this.subscribe("getNewUnreadMsgCount",function(e,t){500002!=t.platformId&&500003!=t.platformId&&20!=t.platformId||T.showTip("收到685"+t.lastMsgContent),view.handleNewUnreadMsgCount&&view.handleNewUnreadMsgCount(t),T.sendMsgboxUnread.send(t)}),this.subscribe("updateVisitorInfo",function(e,t){var i,a;T.visitorId!=t.visitorId&&(i="CHAT_HIS_"+window.companyId+"_"+t.visitorId,T.historyKey&&i!=T.historyKey&&(T.historyKey=i,T.hasStorage&&(a=window.localStorage.getItem(i))&&(window.localStorage.removeItem(T.historyKey),window.localStorage.setItem(i,a))),T.visitorId=t.visitorId),t.photo&&T.visitorImg!=t.photo&&(x(".avatar-icon-img").each(function(e){-1!=this.parentNode.className.indexOf("fr")&&(this.src=t.photo)}),T.visitorImg=t.photo)}),this.subscribe("setVisitorInfo",function(e,i){if(T.msg600=i,T.visitorImg=i.photo,T.visitorId=i.visitorId,T.companyId=i.companyId,T.appId=i.appId,T.appSecrect=i.appSecrect,window.encryptVID=i.encryptVID,T.isVip=1==i.visitorType,T.visitorType=i.visitorType,i.uploadFileSize&&(T.uploadFileSize=i.uploadFileSize||5242880,T.uploadFileType=i.uploadFileType),T.qiniuDomain=i.qiniuBucketDomain,T.qiniuHttpsDomain=i.qiniuBucketHttpsDomain,T.platformName=i.platformName,T.platformLogo=i.platformLogo,T.companyName=i.companyName,T.companyLogo=i.companyLogo,T.companyMobileSite=i.companyMobileSite,T.companyWebSite=i.companyWebSite,T.sendMsgboxUnread.init(function(e){view.__nativeAPI&&view.__nativeAPI("platformNewMsg",T.formatUnreadMsg.call(T,e)),500002!=e.platformId&&500003!=e.platformId||T.showTip("platformNewMsg"+JSON.stringify(e))}),T.publish("initPageStatus",{companyId:T.companyId,companyName:T.companyName}),first600=1,T.apiServerDomain=i.apiServerDomain,i.fileUploadInfos||(i.fileUploadInfos=[{fileBucketDomain:T.dataHost,fileBucketHttpsDomain:T.dataHost,fileUploadHttpsUrl:T.dataHost+"/fup",fileUploadParam:"token=${token},uploadServiceType=${uploadServiceType}",fileUploadUrl:T.dataHost+"/fup",uploadServiceType:3}]),T.fileUploadInfosLength=i.fileUploadInfos.length,T.fileUploadInfos=function(){i.fileUploadInfos=i.fileUploadInfos;for(var e={},t=0;t<i.fileUploadInfos.length;t++)e["uploadServiceType"+i.fileUploadInfos[t].uploadServiceType]=i.fileUploadInfos[t];return e}(),T.historyKey||(T.historyKey="CHAT_HIS_"+window.companyId+"_"+i.visitorId,T.hasPreHis=T.checkHistory()),1==i.limitVisitorInputContentLengthEnable&&!a){var t=T.inputMaxLength=i.visitorInputContentMaxLength;a=!a,x("#inputLengthTip").html(lanRes.inputLengthTip1+t+lanRes.inputLengthTip2),x("#inputLengthTip").show(),setTimeout(function(){var e=T.getInputDoc().getElementsByTagName("body")[0];e.addEventListener?(e.addEventListener("keydown",function(e){n(e,t)}),e.addEventListener("paste",function(e){n(e,t)})):(e.attachEvent("onkeydown",function(e){n(e,t)}),e.attachEvent("onpaste",function(e){n(e,t)}))},200)}}),T.oldBodyEnterText="",this.subscribe("setChatParam",function(e,t){T.paramChat.country=t.country||"",T.paramChat.province=t.province||"",T.paramChat.city=t.city||"",T.paramChat.searcher=t.searcher||"",T.paramChat.keyword=t.keyword||"",T.paramChat.firstUrl=T.paramChat.firstUrl||t.firstUrl,T.paramChat.referrer=T.paramChat.referrer||t.referrer,T.paramChat.companyId=T.companyId,T.paramChat.visitorId=T.visitorId,T.paramChat.osName=T.queryParams.osName,view.canSetAD++,view.setAD&&view.setAD()}),this.subscribe("setRestartTag",function(e,t){T.restartParam={nonce:t.nonce,reChatTag:t.reChatTag},t.talkId&&!T.talkId&&t.notStore&&(T.talkId=t.talkId),x.store("ECHAT_talkId",t.talkId),T.hasPreHis=T.checkHistory(),view.noScrollBottom=!1}),T.isAutoPop="1"==T.queryParams.autoPop,this.subscribe("handshakeOk",function(e,t){T.robotToHumanKey=null,x("#restartChat").text(lanRes.chatContinued),x(".btn-restart").removeAttr("id").removeClass("btn-restart")}),this.subscribe("changeToPlatform",function(e,t){T.platformData=t,T.paramChat.echatTag=t.echatTag}),this.subscribe("toSetID",function(e,t){T.talkId="",T.no103=!1;var i,a=a;if(T.companyOff=a,T.publish("__chatStatus","registerChat"),view.SDKNative)return i={et:109},T.routeId&&(i.routeId=T.routeId,i.routeEntranceTheme=T.routeEntranceTheme,i.echatTag=T.paramChat.echatTag),T.robotToHumanKey&&(i.robotToHumanKey=T.robotToHumanKey),(n=T.data109)?(n.visEvt&&(i.visEvt=n.visEvt),n.routeId&&(i.routeId=n.routeId),n.routeEntranceTheme&&(i.routeEntranceTheme=n.routeEntranceTheme)):T.data109=i,void T.publish("__registChatAction",i);i={et:109,windowType:view.windowType,companyId:T.companyId,page:T.paramChat.chatPage||a,title:T.paramChat.chatPageTitle||a,firstEnterUrl:T.paramChat.firstUrl||a,firstEnterTitle:T.paramChat.firstTitle||a,referrer:T.paramChat.referrer||a,media:T.Device.media,browserName:T.Browser.browser,browserVersion:T.Browser.version,osName:T.queryParams.osName||T.Device.OS.toLowerCase(),screenResolution:window.screen.width+"x"+window.screen.height,echatTag:T.paramChat.echatTag||a,routerId:T.queryParams.routerid||a,departmentId:T.queryParams.departmentid||a,routeEntranceId:T.queryParams.routeentranceid||a,styleId:T.queryParams.styleid||a,multipleFile:T.queryParams.multiplefile||0},view.SDK&&(i.webSdk=1),T.robotToHumanKey&&(i.robotToHumanKey=T.robotToHumanKey),"1"==T.queryParams.autoPop&&T.isAutoPop&&(i.isAutoPop=1),"1"==T.queryParams.acceptInvite&&(i.acceptInvite=1),T.routeId&&(i.routeId=T.routeId,i.routeEntranceTheme=T.routeEntranceTheme);var n,o=T.queryParams.visitorid;if(o&&(i.visitorId=o,i.chatToken=T.queryParams.chattoken,i.tm=T.queryParams.tm,T.chatToken=i.chatToken),T.restartParam&&x.extend(i,T.restartParam),1==T.toLeaveWord&&(i.toLeaveWord=1,T.toLeaveWord=a),T.staffChatNeedConnect=!1,window.isInPlatform&&T.platformData&&(i.companyId=T.platformData.platfromId,i.routeId=T.platformData.routeId,i.echatTag=T.platformData.echatTag,i.toPlatformToken=T.platformData.toPlatformToken),T.paramChat.visEvt){var s=JSON.parse(T.paramChat.visEvt);function r(e){return e?e.replace(/<(?:.|\s)*?>/gi,""):e}i.visEvt={customizeMsgType:2,dedup:1,eventId:s.eventId,title:r(s.title),content:s.content,imageUrl:s.imageUrl,url:s.url,urlForVisitor:s.urlForVisitor,urlForStaff:s.urlForStaff,memo:r(s.memo),visibility:s.visibility,urlEnableForVisitor:s.urlEnableForVisitor,closeURLPage:s.closeURLPage},T.initVisEvt=T.paramChat.visEvt,T.paramChat.visEvt=null,delete T.paramChat.visEvt}(n=T.data109)?(n.visEvt&&(i.visEvt=n.visEvt),n.routeId&&(i.routeId=n.routeId),n.routeEntranceTheme&&(i.routeEntranceTheme=n.routeEntranceTheme)):T.data109=i,T.publish("visitorCommonEvent",i),T.postMessage(2)}),"1"!=T.queryParams.autoPop&&"1"!=T.queryParams.acceptInvite||this.subscribe("_firstSendMsg",function(e,t){"0"==T.queryParams.autoChat&&(delete T.queryParams.autoChat,T.publish("toRegisterChat",t),delete T.queryParams.autoPop,T.isAutoPop=!1),"1"==T.queryParams.acceptInvite&&(T.queryParams.acceptInvite=void 0,delete T.queryParams.acceptInvite),this.unSubscribe("_firstSendMsg")}),this.subscribe("toRegisterChat",function(e,t){if("0"!=T.queryParams.autoChat&&(T.talkId="",!T.no103)){if(T.no103=!0,view.SDKNative)return a={et:103},T.eventId&&(a.eventId=T.eventId),console.log("__registChatAction",new Date),void T.publish("__registChatAction",a);var i=i,a={et:103,windowType:view.windowType,page:T.paramChat.chatPage||i,title:T.paramChat.chatPageTitle||i,firstEnterUrl:T.paramChat.firstUrl||i,firstEnterTitle:T.paramChat.firstTitle||i,referrer:T.paramChat.referrer||i,media:T.Device.media,browserName:T.Browser.browser,browserVersion:T.Browser.version,osName:T.queryParams.osName||T.Device.OS,screenResolution:window.screen.width+"x"+window.screen.height,echatTag:T.paramChat.echatTag||i};t&&t.code&&(a.captcha=t.code),"1"==T.queryParams.acceptInvite&&(a.acceptInvite=1),T.routeId&&(a.routeId=T.routeId,a.routeEntranceTheme=T.routeEntranceTheme),"1"==T.queryParams.autoPop&&(a.isAutoPop=1,t&&t.c&&(a.visitorWords=t.c)),T.publish("visitorCommonEvent",a,function(e){!0===e.successful&&T.publish("_pushVisitorEvent")})}}),this.subscribe("removeLoading",function(e,t){T.wait874List||(x("#loading").hide(),window.resizeFunc&&window.resizeFunc(),T.hasEntryOrCode||(x("#mask").hide(),x("#verify").hide()),x(".btn-close").removeClass("hide"),t&&T.initQcode())}),this.initQcode=function(){(!0!==T.companyOff&&!T.hasLeaveMsg||T.isInRobot)&&(T.isMobile||(T.showQcode?(x(".btn-qcode").removeClass("hide"),_$("qcode_img").setAttribute("loaded",""),_$("qcode_img").removeAttribute("loaded")):T.showQcode=T.toShowQcode()))},this.getLeaveConfig=function(e,t){var i=e.offlineBoxInfo||e.offlineSmallBoxInfo||e.mobileOfflineBoxInfo||e.sdkOfflineBoxInfo;return!i&&T.msg649&&(i=T.msg649.offlineBoxInfo||T.msg649.offlineSmallBoxInfo||T.msg649.mobileOfflineBoxInfo||T.msg649.sdkOfflineBoxInfo),i},this.subscribe("toLeavePage",function(e,t,i){var a,n=!(T.companyOff=!0),o=T.getLeaveConfig(t),s=!1;if(T.leaveAndClose){n=!1;var r="msg"+(c=(new Date).getTime()),l={t:T.checkHistoryTime(c)?(new Date).format("hh:mm"):void 0,tm:c,mt:864,f:"c",m:0,hide:!0,c:T.entryVisitorMsg,id:r};T.entryVisitorMsg&&T.sendToServer(l),T.publish("__chatStatus","leaveToService");var d=x.extend({},l);d.c=x(".leave-entry-text").val(),T.sendToServer(d,void 0,function(){view.SDKNative||T.publish("_endConnect"),T.visitorClose=!0,d.c.trim()&&h(lanRes.leavelSuc.alt,"ok"),setTimeout(function(){view.SDKNative&&T.publish("sendVisitorEvent",{et:107})&&T.publish("_endConnect"),T.publish("_closeWin"),T.leaveAndClose=!1},2e3)}),T.entryVisitorMsg=null}else if(o&&1==o.enable){if(i||(n=T.showEntryAndCode(t,!1)),n||T.publish("__chatStatus","leaveToService"),x("#staffName").html("<span>"+lanRes.leaveWord+"</span>"),view.hideStaffInfo&&view.hideStaffInfo(),T.entryVisitorMsg){var c;r="msg"+(c=(new Date).getTime()),l={t:T.checkHistoryTime(c)?(new Date).format("hh:mm"):void 0,tm:c,mt:864,f:"c",m:0,hide:!0,c:T.entryVisitorMsg,id:r};T.sendToServer(l),T.entryVisitorMsg=null}view.showURLList&&!view.SDK&&(x(".menu-more").hide(),view.hideMenus()),view.handleLeave&&view.handleLeave("leaveToService",t)}else{if(o&&2==o.enable&&o.thirdPartyUrl){function u(){a&&1==o.enableThirdPartyParams&&o.thirdPartyParams&&(a=function(e,t,i){for(var a="",n=e.split("#"),o=n[1]||"",s=n[0],r=-1==s.indexOf("?")?0:1,l=0,d=t.length;l<d;l++){var c=t[l].paramName;"metaData"!=c&&"metadata"!=c||(c="metaData"),i[c]&&(a+=(0!=r?"&":"?")+c+"="+encodeURIComponent(i[c]||""),r++)}return s+a+(o?"#"+o:"")}(a,o.thirdPartyParams,T.paramChat)),x("body").html(""),view.SDK?view.__nativeAPI("jumpToUrl",a):location.href=a}return T.publish("__chatStatus","leaveToUrl"),T.publish("__leaveToUrl",o.thirdPartyUrl),a=o.thirdPartyUrl,void(view.SDKNative&&window.setVisitorInfo?setTimeout(function(){u()},200):u())}if(!o||0==o.enable||o&&2==o.enable&&!o.thirdPartyUrl){s=!0,T.publish("__chatStatus","leaveDisabled"),x("#inputPlaceholder").html(lanRes.disablePlaceholder),x("#footer").addClass("leave-disabled");var f=_.createElement("div");f.className="mask-disabled",x("#footer").append(f),x(_).off(),o&&view.handleLeave&&view.handleLeave("leaveDisabled",t),setTimeout(function(){T.publish("_endConnect"),T.companyOff=!0},200),view.hideStaffInfo&&view.hideStaffInfo(),view.showURLList&&(x(".menu-more").hide(),view.hideMenus())}}x(".btn-qcode").addClass("hide"),T.publish("removeLoading"),(n||s)&&x("#mask").show(),view.hideServiceIcon&&view.hideServiceIcon(),T.postMessage("toLeaveMessage")}),this.subscribe("refreshVerify",function(e,t){x("#verify_change").removeClass("loadin"),0==t.status||1==t.status&&x("#verify_input").addClass("error"),T.no103=!1,x("#verify_img").attr("src",T.dataHost+"/chatCaptCha.jpg?captChatToken="+t.captChaToken)}),this.bookformi=0,this.getBookComfirm=function(e){if(!e||!e[0])return e||"";var t;if(!(t=1==view.windowType&&1==e[0].type||1!=view.windowType&&3==e[0].type?e[0]:e[1])||!t.configuration)return"";var i=this.bookformi++,a=t.configuration,n=a.length,o=E(a);T.needHttps&&t.backImg&&(t.backImg=t.backImg.replace(/^http:/,T.needHttps));for(var s=' <div id="inviteBook'+i+'" class="book-table '+(3==t.type?"book-table-sm":"book-table-bg")+("1"==o?" book-all-line":"")+'" >'+(t.backImg?'<div><img onerror="view.imgError&&view.imgError(this)" id="inviteBookImg'+i+'" class="book-table-img hide" src="'+t.backImg+'" onload="imgLoadResize(this,'+i+')" /></div>':"")+'<form id="inviteBookForm'+i+'" class="book-items" onsubmit="return false;"> <div class="clearfix book-items-list" style="'+t.formPos+';">',r=0;r<n;r++){var l=a[r],d=1==l.configRequired?"req":"";s+='<div class="book-half book-item '+("1"==l.configInline?"book-one-line":"")+'"><label class="book-label" style="color:'+t.labelColor+'">'+l.configDesc+"</label>"+("gender"==l.configName?'<input type="text" lb="'+l.configDesc+'" class="book-ipt '+d+'" name="'+l.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"  value="'+(2==l.configValue?lanRes.female:1==l.configValue?lanRes.male:"")+'" readonly="readonly" />':"maritalStatus"==l.configName?'<input type="text" lb="'+l.configDesc+'" class="book-ipt '+d+'" name="'+l.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"  value="'+(2==l.configValue?lanRes.married:1==l.configValue?lanRes.unmarried:"")+'" readonly="readonly" />':'<input type="text" lb="'+l.configDesc+'" class="book-ipt '+d+'" name="'+l.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"  value="'+(l.configValue||"")+'" readonly="readonly" />')+"</div>"}return s+="</div></form></div>",setTimeout(function(){var e=_$("inviteBookForm"+i);if(e){var t=e.offsetHeight+(view.px2px?view.px2px(20):20)+e.offsetTop;_$("inviteBookLi"+i).style.minHeight=t+"px"}},1e3),'<li id="inviteBookLi'+i+'" class="clearfix book-confirm-wrap">'+s+"</li>"},this.showEntryAndCode=function(e,t){var i=!1,a=e.entranceInfo||e.smallEntranceInfo||e.mobileEntranceInfo||e.sdkEntranceInfo,n=a&&1==a.visitorInfoEnable&&(t?1==a.enableOnline:1==a.enableOffline);T.leaveAndCloseConfig&&!0===T.companyOff&&(a=T.leaveAndCloseConfig,n=!0);a&&(!0===T.companyOff?a.offlineVisitorInfoConfiguration:a.visitorInfoConfiguration);return n&&T.toShowEntry(a,e)?(x("#verify").hide(),i=!0):e.captChaToken?(x("#entry").html("").hide(),x(".verify-change").attr("id","verify_change"),x(".verify-img").attr("id","verify_img"),x(".verify-ok").attr("id","verify_ok"),x(".verify-input").attr("id","verify_input"),T.publish("removeLoading"),T.toShowCode(),x("#verify_img").attr("src",T.dataHost+"/chatCaptCha.jpg?captChatToken="+e.captChaToken),x("#verify").show(),x("#mask").show(),i=!0):n&&(T.publish("entryCallback",{success:!0,mt:670}),i=!1),T.hasEntryOrCode=i},this.subscribe("initRobot",function(e,t){T.needHttps&&t.robotConfigInfo.robotImg&&(t.robotConfigInfo.robotImg=t.robotConfigInfo.robotImg.replace(/^http:/,T.needHttps)),T.staffImg=t.robotConfigInfo.robotImg,T.staffName=t.robotExtInfo&&t.robotExtInfo.nickName||lanRes.robot,T.robotExtInfo=t.robotExtInfo||{},T.paramChat.staffId="-1",T.paramChat.staffName=T.staffName,T.paramChat.staffPhoto=T.staffImg,view.initRobotInfo&&view.initRobotInfo(t),T.bindPlainTextEvent(),view.setInnerAD(t),T.robotWordsInfo=t.robotWordsInfo,x("#toHumanWords").html(t.robotWordsInfo.toHumanWords||""),x("#textInput").attr("placeholder",t.robotWordsInfo.inputBoxWords||lanRes.inputPlaceholder2);var i=T.isVip?view.SDK?t.sdkVipVisitorRobotConfig:t.webVipVisitorRobotConfig:view.SDK?t.sdkVisitorRobotConfig:t.webVisitorRobotConfig;if(x("#robotToStaff").hide(),"1"==i.enableManualSwitch?(!0===T.companyOff?(x("#robotToStaffWord").html(lanRes.leaveWord),"1"==i.enableLeaveBtnWhenStaffOffline&&(x("#robotToStaff").show(),w(T))):(x("#robotToStaffWord").html(lanRes.robotToStaff),"1"==i.enableSwitchBtnWhenStaffOnline&&(x("#robotToStaff").show(),w(T))),view.handleShowRobotToStaff&&view.handleShowRobotToStaff()):x("#robotToStaff").remove(),"1"==t.robotWordsInfo.enableFedBack){var o=t.robotWordsInfo;"string"==typeof o.solvedSubitem&&(o.solvedSubitem=JSON.parse(o.solvedSubitem)),"string"==typeof o.unsolvedSubitem&&(o.unsolvedSubitem=JSON.parse(o.unsolvedSubitem)),T.needHttps&&(o.solvedButton&&(o.solvedButton=o.solvedButton.replace(/^http:/,T.needHttps)),o.unsolvedButton&&(o.unsolvedButton=o.unsolvedButton.replace(/^http:/,T.needHttps))),o.solvedSubitem||o.unsolvedSubitem?!view.dji||o.unsolvedWords||o.solvedWords?T.robotFeedback=function(e){var t=(e=e||{}).answerItem,i="",a='<div class="feedback-tip">'+(o.fedBackWords||"")+'</div><div class="feedback-tag"><i class="feed-icon-sel"></i><span>'+lanRes.hasSelected+'</span></div><div class="feedback-btns clearfix"><div class="feedback-btn-solve '+(1==e.feedback?"feedback-btn-solve-sel":"")+(view.dji&&!o.solvedWords?" hide":"")+'" type="1">'+(o.solvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+o.solvedButton+'"/>':"")+"<span>"+(o.solvedWords||"")+'</span></div><div class="feedback-btn-unsolve '+(2==e.feedback?"feedback-btn-unsolve-sel":"")+(view.dji&&!o.unsolvedWords?" hide":"")+'" type="2">'+(o.unsolvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+o.unsolvedButton+'"/>':"")+"<span>"+(o.unsolvedWords||"")+"</span></div></div>";if(t){if(2!=e.feedback&&o.solvedSubitem&&0<o.solvedSubitem.length){i+='<div class="feedback-sub-solved"><div class="robot-tip">'+lanRes.solvedReason+'</div><ul class="feedback-sub-list '+(e.feedbackSubitem?"robot-feedback-sub-had":"")+'" did="'+t.docId+'" qid="'+t.queryId+'" rid="'+t.robotDetailId+'" searchId="'+t.searchId+'" originQuestion="'+escape(t.originQuestion)+'">';for(var n=0;n<o.solvedSubitem.length;n++)i+='<li class="feedback-sub-li sub-solved-li '+(e.feedbackSubitem==o.solvedSubitem[n].content?"feedback-sub-sel1":"")+'"><span class="list-style-dot">'+(n+1)+'.</span><span class="feedback-sub-content" type="1">'+o.solvedSubitem[n].content+"</span></li>";i+="</ul></div>"}if(1!=e.feedback&&o.unsolvedSubitem&&0<o.unsolvedSubitem.length){i+='<div class="feedback-sub-unsolved"><div class="robot-tip">'+lanRes.unsolvedReason+'</div><ul class="feedback-sub-list '+(e.feedbackSubitem?"robot-feedback-sub-had":"")+'" did="'+t.docId+'" qid="'+t.queryId+'" rid="'+t.robotDetailId+'" searchId="'+t.searchId+'" originQuestion="'+escape(t.originQuestion)+'">';for(n=0;n<o.unsolvedSubitem.length;n++)i+='<li class="feedback-sub-li sub-unsolved-li '+(e.feedbackSubitem==o.unsolvedSubitem[n].content?"feedback-sub-sel2":"")+'"><span class="list-style-dot">'+(n+1)+'.</span><span class="feedback-sub-content" type="2">'+o.unsolvedSubitem[n].content+"</span></li>";i+="</ul>"}}return a+i+"</div></div>"}:T.robotFeedback=!1:T.robotFeedback=function(e){return e=e||{},'<div class="feedback-tip">'+(o.fedBackWords||"")+'</div><div class="feedback-tag"><i class="feed-icon-sel"></i><span>'+lanRes.hasSelected+'</span></div><div class="feedback-btns clearfix"><div class="feedback-btn-solve '+(1==e.feedback?"feedback-btn-solve-sel":"")+'" type="1">'+(o.solvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+o.solvedButton+'"/>':"")+"<span>"+(o.solvedWords||"")+'</psan></div><div class="feedback-btn-unsolve '+(2==e.feedback?"feedback-btn-unsolve-sel":"")+'" type="2">'+(o.unsolvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+o.unsolvedButton+'"/>':"")+"<span>"+(o.unsolvedWords||"")+"</span></div></div></div></div>"};var a=T.getCSSRule(".feedback-btn-solve");a&&o.solvedBackColor&&(a.style.backgroundColor=o.solvedBackColor),(a=T.getCSSRule(".sub-solved-li"))&&o.solvedBackColor&&(a.style.backgroundColor=o.solvedBackColor),(a=T.getCSSRule(".feedback-btn-solve-sel"))&&o.solvedSelectColor&&(a.style.backgroundColor=o.solvedSelectColor),(a=T.getCSSRule(".feedback-sub-sel1"))&&o.solvedSelectColor&&(a.style.backgroundColor=o.solvedSelectColor),(a=T.getCSSRule(".feedback-btn-unsolve"))&&o.unsolvedBackColor&&(a.style.backgroundColor=o.unsolvedBackColor),(a=T.getCSSRule(".sub-unsolved-li"))&&o.unsolvedBackColor&&(a.style.backgroundColor=o.unsolvedBackColor),(a=T.getCSSRule(".feedback-btn-unsolve-sel"))&&o.unsolvedSelectColor&&(a.style.backgroundColor=o.unsolvedSelectColor),(a=T.getCSSRule(".feedback-sub-sel2"))&&o.unsolvedSelectColor&&(a.style.backgroundColor=o.unsolvedSelectColor)}else T.robotFeedback=!1;T.unSubscribe("_sendQuestion"),T.subscribe("_sendQuestion",function(e,t){T.publish("sendVisitorEvent",{et:130,docId:t.docId,originDocId:t.originDocId,content:t.content}),T._getMsg({mt:130,ff:"r",tm:(new Date).getTime()},0,t.content,"c"),x("#input_suggest").addClass("hide").html(" ")}),T.lastText=null,T.typingTimer&&clearTimeout(T.typingTimer);var n,s=12059==T.companyId?500:1500;if(T.hasInputAssociation){T.typingTimer=setTimeout(function e(){var t=T.getInput(!1);t||x("#input_suggest").addClass("hide").html(" "),!t||T.lastText==t&&n==t||(T.lastText=t,T.publish("sendVisitorEvent",{et:132,content:T.lastText})),T.typingTimer=setTimeout(e,s),n=t},s)}T.openVisitorSend(),x("#toolbar").addClass("robot"),x("body").addClass("robot"),T.publish("onceStartRobot"),T.subscribe("_showCommonQue",r)}),T.maxRobotLength=100,x("#inputLengthTip").html(lanRes.inputLengthTip1+" "+T.maxRobotLength+" "+lanRes.inputLengthTip2),T.handleInputLength=function(){var e;view.chat.isInRobot&&function(e,t){for(var i=0,a=(t=2*t,0),n=0;n<e.length;n++){if(null!=e.charAt(n).match(/[^\x00-\xff]/gi)?(i+=2,a+=1):i+=1,t<=i)return T.setInput(e.substr(0,i-a)),x("#inputLengthTip").html(lanRes.inputLengthTip1+" 0 "+lanRes.inputLengthTip2);var o=t/2-(parseInt(i/2)+i%2);x("#inputLengthTip").html(lanRes.inputLengthTip1+" "+o+" "+lanRes.inputLengthTip2)}}(e=T.getInput(),T.maxRobotLength),(view.chat.isInRobot||view.SDK)&&view.urlList&&(e||T.getInput()?(x(".menu-more").hide(),x("#enter_btn").removeClass("hide")):(x(".menu-more").show(),x("#enter_btn").addClass("hide")))},this.subscribe("onceStartRobot",function(e,t){T.unSubscribe("onceStartRobot"),view.urlList&&(x("#menu_more_robot").show(),x("#enter_btn").addClass("hide")),x("#list_msg").on("click",".common-ques-li",function(e){T.publish("_sendQuestion",{docId:x(this).attr("did"),content:unescape(x(this).attr("ques"))})}),x("#robotToStaffWord").on("click",function(){x("#inputLengthTip").html(lanRes.inputLengthTip1+T.inputMaxLength+lanRes.inputLengthTip2),"disconnected"==EChatQuery.cometd.getStatus()||T.isInRobot&&T.publish("sendVisitorEvent",{et:131}),T.getInputDocBody().blur()}),x("#input_suggest").on("click",".ipt-list-li",function(e){view.handleNetwok&&view.handleNetwok()||(T.setInput(unescape(x(this).attr("ques"))),T.isInRobot&&(T.publish("_sendQuestion",{docId:x(this).attr("did"),content:unescape(x(this).attr("ques"))}),T.getInput(!0)&&view.afterSend()))}),x("#list_msg").on("click",".question-list-li",function(e){T.publish("_sendQuestion",{docId:x(this).attr("did"),originDocId:x(this).attr("oid"),content:unescape(x(this).attr("ques"))})}),x("#list_his").on("click",".feedback-btn-unsolve",function(e){var t=this.parentNode.parentNode,i=x(t).attr("did");if(i){view.chat.lastFeedBack=t,T.publish("sendVisitorEvent",{et:133,docId:i,queryId:x(t).attr("qid"),robotDetailId:x(t).attr("rid"),searchId:x(t).attr("searchId"),originQuestion:unescape(x(t).attr("originQuestion")),feedBack:x(this).attr("type")}),x(t).attr("did","").addClass("robot-feedback-had robot-feedback-had2"),x(this).addClass("feedback-btn-unsolve-sel");var a=x(this).parents(".msg-robot").attr("id");a&&view.scrollToBottom(a)}}).on("click",".feedback-btn-solve",function(e){var t=this.parentNode.parentNode,i=x(t).attr("did");if(i){view.chat.lastFeedBack=t,T.publish("sendVisitorEvent",{et:133,docId:i,queryId:x(t).attr("qid"),robotDetailId:x(t).attr("rid"),searchId:x(t).attr("searchId"),originQuestion:unescape(x(t).attr("originQuestion")),feedBack:x(this).attr("type")}),x(t).attr("did","").addClass("robot-feedback-had robot-feedback-had1"),x(this).addClass("feedback-btn-solve-sel");var a=x(this).parents(".msg-robot").attr("id");a&&view.scrollToBottom(a)}}).on("click",".feedback-sub-content",function(e){var t=this.parentNode.parentNode,i=x(t).attr("did");if(i){var a=x(this).attr("type");T.publish("sendVisitorEvent",{et:133,docId:i,queryId:x(t).attr("qid"),robotDetailId:x(t).attr("rid"),searchId:x(t).attr("searchId"),originQuestion:unescape(x(t).attr("originQuestion")),feedBackSubitem:this.innerText||this.textContent||this.innerHTML}),x(t).attr("did","").addClass("robot-feedback-sub-had"),x(this.parentNode).addClass("feedback-sub-sel"+a)}})}),this.subscribe("endRobot",function(e,t){T.data109=null,T.typingTimer&&clearTimeout(T.typingTimer),T.isInRobot=0,x("#toolbar").removeClass("robot"),x("body").removeClass("robot"),x("#robotToStaff").hide(),T.isMobile&&view.hideMenus(),x(".robot-staff").removeClass("robot-staff"),T.unSubscribe("_sendQuestion"),T.robotTalkId&&T.handleSessionMsg({talkId:T.robotTalkId}),T.robotTalkId=null,T.staffName="",T.staffImg=void 0,T.staffId=void 0,delete T.paramChat.staffId,delete T.paramChat.staffName,delete T.paramChat.staffPhoto,delete T.paramChat.talkId,T.isMobile||T.changeToIframe(),x("#textInput").attr("placeholder",lanRes.mbTextareaInput.placeholder)}),x(".leave-bar-btn").on("click",function(){T.publish("restartChat")}),x(".robot-staff-close").on("click",function(){var e=this.parentNode;x(e).addClass("hide").hide(),view.handleShowRobotToStaff&&view.handleShowRobotToStaff(),w(T,"close")}),T.unSubscribe("getCrossMessage"),T.subscribe("getCrossMessage",function(e,t){var i=t.data,a=t.source;if(i)if(T.hasSearchInSameScreen&&"robot"==i.evt)"question"==i.type&&i.content&&T.publish("_sendMsg",i.content);else if("echatjs"==i.evt){if("echatInnerFrame"==i.type&&a)try{a.postMessage({type:"echatInnerFrameCallback",companyId:T.companyId,visitorId:T.visitorId,chatVisitorId:window.chatVisitorId,encryptVID:window.encryptVID,metaData:T.queryParams.metadata||"",inChatPage:!0},i.origin)}catch(e){}else"openChat"==i.type?((T.isMobile||2==view.windowType)&&view.hideURLSite&&view.hideURLSite(),T.publish("_triggerChat",i)):"closeFramePage"==i.type&&(view.hideURLSite?view.hideURLSite():x(".tab-push-close").click());"sendTextMsg"==i.type&&T.publish("_sendMsg",i.content)}});var i=T.isMobile?"touchend":"click";x("#chat").on(i,".robot-staff",function(){T.isInRobot&&T.publish("sendVisitorEvent",{et:131})}).on(i,".end-chat",function(){T.visitorCloseFunc()}).on(i,".to-leave-word",function(){T.outerChatStatus&&T.outerChatStatus.match(/waiting|chatting|robot/)&&(T.toLeaveWord=1,T.publish("sendVisitorEvent",{et:107,toLeaveWord:1},function(){}))}),T.subscribe("_triggerChat",function(e,t){if("disconnected"==x.cometd.getStatus()||"sdk"==x.cometd.getStatus()){if("block"==_$("satisfy").style.display){if(t&&"showMiniChat"==t.action)return;x("#satisfy").hide(),x("#mask").hide()}setTimeout(function(){view.chat.publish("restartChat")},15),x("#restartChat").text(lanRes.chatContinued),x(".btn-restart").removeAttr("id").removeClass("btn-restart")}else T.isMobile||"firefox"!=T.Browser.browser&&T.focusInput()}),x("#content").on("click",".msg-leave",function(){var e,t=x(this).attr("k"),i=T.leaveMsgMap[t],a=(view.SDK||T.needHttps?"https:":"http:")+"//"+T.apiServerDomain+"/chatapi/paodm/qd?companyId="+T.companyId+"&visitorId="+i.visitorId+"&chatInfoType="+i.chatInfoType+"&talkId="+i.newsMsgId+"&tm="+i.tm+"&token="+i.signature;if(e=view.SDKNative?window.locationBase+"/visitor/common/record.html?lan="+window.lanResName+"&url="+encodeURIComponent(a):(T.needHttps||"http:")+"//"+location.host+"/visitor/common/record.html?lan="+window.lanResName+"&url="+encodeURIComponent(a),view.handlePushURL?-1==view.handlePushURL(e)&&window.open(e,"_blank"):view.showURLLink&&view.showURLLink(lanRes.leaveMsgTitle,e,{from:5}),x("#msg"+i.tm).hasClass("fold"))if(!0,T.handleNewMsgMid(i.mid,i,!1,i),x("#msg"+i.tm).removeClass("fold"),view.SDKNative)view.__nativeAPI("updateLocalMsg",{mid:i.mid,read:1});else if(T.hasStorage){var n=window.localStorage.getItem(T.historyKey);if(n){var o=(n=JSON.parse(n))[i.talkId];o&&o[i.tm+"s"]&&(o[i.tm+"s"].read=1),window.localStorage.setItem(T.historyKey,JSON.stringify(n))}}}),this.subscribe("startRobot",function(e,t){var i=T.msg649.privilegeCode;T.hasSearchInSameScreen=!1,T.hasInputAssociation=!1,i&&(T.hasSearchInSameScreen=1==i.charAt(i.length-46),T.hasInputAssociation=1==i.charAt(i.length-5)),T.isInRobot=!0,T.publish("__chatStatus","robot"),T.publish("clearSendingMsg","robot"),T.publish("setConfig",T.msg649),T.publish("initRobot",T.msg649),view.toggleLeaveToChat&&view.toggleLeaveToChat(2),T.queryParams.autoPop&&delete T.queryParams.autoPop,T.queryParams.autoChat&&delete T.queryParams.autoChat,T.isAutoPop=!1}),this.subscribe("startLeave",function(e,t){T.companyOff=!0,T.talkId=t.talkId,T.publish("setConfig",T.msg649),T.publish("toLeavePage",T.msg649,t)}),this.subscribe("startChat",function(e,t){T.publish("setConfig",T.msg649),setTimeout(function(){T.toInitEvaluate(T.msg649)},10),this.startChat.apply(T,arguments)}),this.subscribe("continueChat",function(e,t){setTimeout(function(){T.toInitEvaluate(T.msg649)},10),this.startChat.apply(T,arguments)}),this.subscribe("goingEntry",function(e,t){var i;1==t.status?T.showEntryAndCode(t,!0):(i=t.entranceInfo||t.smallEntranceInfo||t.mobileEntranceInfo||t.sdkEntranceInfo)&&1==i.visitorInfoEnable&&1==i.enableOffline&&T.publish("toLeavePage",T.msg649)}),this.hasBoxConfig=function(e){return e.robotConfigInfo||e.robotPCChatBox||e.offlineBoxInfo||e.mobileOfflineBoxInfo||e.sdkOfflineBoxInfo||e.sdkChatBoxInfo||e.mobileChatBoxInfo||e.chatBoxInfo||e.chatSmallBoxInfo||e.offlineSmallBoxInfo},this.subscribe("waitingChat",function(e,t){T.eventId=t.eventId,T.isInRobot&&T.publish("endRobot"),1!=t.canChatNow&&T.publish("setConfig",t);var i=T.getLeaveConfig(t);if(2!=t.status||2==t.chatStatus||!i||!(2==i.enable&&i.thirdPartyUrl||"0"==i.enable)||(T.publish("toLeavePage",t),"0"!=i.enable&&"2"!=i.enable)){if(!1!==T.chatting&&T.talkId&&(T.lastTalkIdForTemp=T.talkId),T.chatting=-1,T.leaveAndClose=!1,T.sendMsgNum=0,view.toggleEnded&&view.toggleEnded("init"),x("#chat").removeClass("hide"),x("#footer").removeClass("hide").removeClass("leave-disabled"),x("#leave").addClass("hide"),x("#busyTipLine").addClass("hide").hide(),T.isMobile&&x(".menu-phone").addClass("limit-hide"),T.isMobile||x("#portrait").hide(),x("#textInput").attr("placeholder",lanRes.mbTextareaInput.placeholder),x("#leaveDisabled").hide(),x("#staffName").html(x("#staffName").html()||lanRes.waitting),view.resetContentHeight&&view.resetContentHeight(),x("#leave").addClass("hide"),x("#container").removeClass("hide"),x(".leave-entry-foot").addClass("hide"),x("#container_leave").addClass("hide"),x("html").removeClass("page-leave"),T.hasEntryOrCode&&T.publish("entryCallback",{success:!0}),T.sendMsgNum=0,x("#inputPlaceholder").html(x("#inputPlaceholder").attr("placeholder")||lanRes[x("#inputPlaceholder").attr("langs")]),T.hasBoxConfig(t)&&(T.msg649=x.extend(T.msg649||{},t),view.SDK&&x.store("ECHAT_"+T.companyId+"_649",JSON.stringify(x.extend(JSON.parse(x.store("ECHAT_"+T.companyId+"_649")||"{}"),t)))),t.unreadMsgNumber&&parseInt(t.unreadMsgNumber))return T.companyOff=2==t.status,T.hasLeaveMsg=!0,T.publish("removeLoading"),void(view.toggleLeaveToChat&&view.toggleLeaveToChat(1));if(T.hasLeaveMsg=!1,view.toggleLeaveToChat&&view.toggleLeaveToChat(0),x("#inputLengthTip").hide(),T.getInput(!1)?x("#inputPlaceholder").addClass("hide"):x("#inputPlaceholder").removeClass("hide"),T.companyOff=2==t.status,T.hasChatInOtherPage=!1,x.cookie("ECHAT_"+T.companyId+"_"+window.chatVisitorId+"_chatStatus",t.chatStatus,{path:"/"}),2==t.chatStatus?(T.wait874List=!0,T.hasChatInOtherPage=!0):1!=t.canChatNow&&T.publish("goingEntry",t),T.publish("__staffStatus",t.status),x("#router").hide(),ECHATObjKeyMap.cometdId.waitForRouterSelect&&T.publish("routerSelect"),ECHATObjKeyMap.cometdId.waitForRouterSelect=!1,T.isInRobot&&(t.robotPCChatBox||t.robotSmallChatBox||t.robotPhoneChatBox||t.robotSdkChatBox)||!T.isInRobot&&(t.chatBoxInfo||t.chatSmallBoxInfo||t.mobileChatBoxInfo||t.sdkChatBoxInfo)){var a=t.entranceInfo||t.smallEntranceInfo||t.mobileEntranceInfo||t.sdkEntranceInfo;a&&2==t.status&&1==a.visitorInfoEnable&&1==a.enableOffline&&"0"==a.offlineStartType||view.setInnerAD(t)}!0===T.companyOff||T.busyCanSend&&"0"!=T.queryParams.autoChat||!0===T.chatting?(!0!==T.companyOff&&T.busyCanSend&&!0!==T.chatting||!0===T.companyOff)&&(x(".menu-capture").removeClass("hide"),x(".menu-file").removeClass("hide")):(x(".menu-capture").addClass("hide"),x(".menu-file").addClass("hide")),T.openVisitorSend(),T.publish("firstInitSound"),1==t.notThroughStatus&&T.publish("removeLoading")}}),this.subscribe("firstInitSound",function(){T.unSubscribe("firstInitSound"),T.isMobile?window.audioInstance||(window.audioInstance=_$s("audio")[0]):window.ltIE10||window.audioInstance&&view.SDKNative||T.addJS("/visitor/common/audiojs/audiojs/audio.min.js",function(){audiojs.events.ready(function(){window.audioInstance=audiojs.create(_$("msgAudio"))})}),T.unSubscribe("_newMsg"),T.subscribe("_newMsg",function(){if(!T.disableSoundTip&&window.audioInstance){var e=window.audioInstance;try{e.play.apply(e)}catch(e){}}})}),this.subscribe("_addSendMsgNum",function(e,t){T.sendMsgNum++,T.allowEvaluateBaseWords<=T.sendMsgNum&&T.toggleEvaluateMenu(4)});var o={};T.handleNewMsgMid=function(e,t,i,a){if(e&&!o[e])return o[e]=1,T.lasMid=T.lasMid||x.store("ECHAT_"+T.companyId+"_"+T.visitorId+"_mid")||0,T.lasMid<e?(t&&i&&(t.mid=e,!1!==a.isForward&&view.SDKNative||(T.publish("_newMsg",t),"sys"==t.f?T.publish("__newSysMsg",t,a||{}):T.publish("__newMsg",t,a||{}))),x.store("ECHAT_"+T.companyId+"_"+T.visitorId+"_mid",e),(!1===view.showChangeTitle||view.miniShow||window.ltIE10)&&(x.cookie("ECHAT_"+T.companyId+"_"+window.chatVisitorId+"_mid_read",e,{path:"/"}),1!=view.windowType&&3!=view.windowType||!1!==view.showChangeTitle||x.cookie("ECHAT_"+T.companyId+"_"+window.chatVisitorId+"_mid_read_click",e,{path:"/"})),i):void 0},T._getMsg=function(e,t,i,a){e.tm||(e.tm=(new Date).getTime());var n=new Date(e.tm?e.tm-0:void 0),o=e.id||e.bridgeMsgId||e.fileIdentity||"msg"+e.tm,s=T.checkHistoryTime(e.tm),r={t:e.t||(s?n.format("hh:mm"):void 0),tm:e.tm,mt:i&&i.mt||e.mt,f:a||"s",m:t,c:i,hasResend:e.bridgeMsgId&&2==e.sendStatus,notEnd:e.notEnd,id:o};r.hasResend&&(T.errorList[o]=e),r.talkId=e.talkId||T.talkId,e.staffImg&&(r.staffImg=e.staffImg),e.staffName&&(r.staffName=e.staffName||e.staffNickName),e.staffId&&!e.staffName&&T.staffMap[e.staffId]&&(r=x.extend(r,T.staffMap[e.staffId])),"f"!=a&&"r"!=e.ff||(r.ff="r"),r.c&&T.showMsg(r),delete r.id,delete r.hasResend,e.notStore||(1==t?r.tmf=o:2==t&&(r.fileName=e.fileName,r.bigImg=e.bigImg,r.smallImg=e.smallImg,r.sourceImg=e.sourceImg,r.c="img-temp"+o,r.sourceWidth=e.sourceWidth,r.sourceHeight=e.sourceHeight,r.tmf=o),"x"==a&&5!=r.m?r.c=e.content:"r"==a&&(r.c=e.content),(i||e)&&!T.isMobile&&view.setDocumentTitle&&view.setDocumentTitle(a),"c"!=a&&(r.answer=e.answer||void 0,T.handleNewMsgMid(e.mid,r,!0,i)),r.c&&T.pushHistory(r))},this.escapeHtml=function(e){return e&&e.replace(/"/g,"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};this.subscribe("receiveVisEvt",function(e,t,i){if(!t.notStore&&t.talkId&&(T.talkId=t.talkId),2!=t.visibility){if(t.notStore&&t.c)return T._getMsg(t,5,t.c,t.f);if(t.urlForVisitor){t.urlForVisitor=t.urlForVisitor.replace(/\s/g,"");var a=t.urlForVisitor.match(/^http\(['"]?([^'",]+)['"]?(\,['"]?(blank|inner)['"]?)?\)/i)||t.urlForVisitor.match(/^xcx\(['"]?([^'",]+)['"]?(\,['"]?(navigateTo|redirectTo|switchTab)['"]?)?\)/i);a?(t.url=a[1],t.openType=a[3]):t.url=""}else if(0==t.urlEnableForVisitor&&(t.url=void 0,delete t.url),t.url){var n=t.url.replace(/\s/g,"").match(/^apiUrl\(['"]?(\d+)['"]?(\,['"]?(reload|hash)['"]?)?\)/);n?t.toCrmUrlId=n[1]:(t.url.match(/(^http[s]?:)|(^file:)/i)||(t.url=""),t.toCrmUrlId=!1)}var o="";if(t.imageUrl&&(t.imageUrl=t.imageUrl.replace(/["']/,""),o=t.imageUrl?'<img onerror="view.imgError&&view.imgError(this)" class="custom-event-img" src="'+t.imageUrl+'"/>':"",!t.url||t.toCrmUrlId)){o=o.replace(/<img\b.*?(?:\>|\/>)/gi,function(){var e={smallImg:t.imageUrl,bigImg:t.imageUrl,sourceImg:t.imageUrl,fileName:"预览"};return view.showMsgImg?view.showMsgImg(e,"custom-event-img"):'<img  onerror="view.imgError&&view.imgError(this)"'+(e.notEnd?"":'onload="javascript:view.scrollToBottom()"')+' id="img'+(e.tm||(new Date).getTime())+'" attname="'+e.fileName+'" bigimg="'+e.bigImg+'" src="'+e.smallImg+'" source="'+(e.sourceImg||"")+'" sw="'+(e.sourceWidth||"")+'" sh="'+(e.sourceHeight||"")+'" class="msg-img custom-event-img"/>'})}var s=function(e){return e?'<div class="custom-event '+(T.isInRobot?"bg30":"bg3")+'"><div class="custom-event-wrap">{{imageUrl}}<div class="custom-event-content"><div class="custom-event-title" style="height:auto;margin-bottom:0;" title="{{title1}}">{{title}}</div><div class="custom-event-detail">{{content}}</div></div></div>{{memo}}</div>':'<a class="custom-event '+(T.isInRobot?"bg30":"bg3")+'" {{linkset}}><div class="custom-event-wrap">{{imageUrl}}<div class="custom-event-content"><div class="custom-event-title" style="height:auto;margin-bottom:0;" title="{{title1}}">{{title}}</div><div class="custom-event-detail">{{content}}</div></div></div>{{memo}}</a>'}(!t.url||t.toCrmUrlId).replace(/\{\{linkset\}\}/,!t.url||t.toCrmUrlId?"":' href="'+t.url+("inner"==t.openType?'" target="inner" title="'+(t.title||lanRes.interactWnd)+'" ':"navigateTo"==t.openType||"redirectTo"==t.openType||"switchTab"==t.openType?'" target="'+t.openType+'" ':'" target="_blank" ')).replace(/\{\{title1\}\}/,T.escapeHtml(t.title)||"").replace(/\{\{title\}\}/,t.title||"").replace(/\{\{imageUrl\}\}/,o).replace(/\{\{content\}\}/,t.content||"").replace(/\{\{memo\}\}/,t.memo?'<div class="custom-event-memo">'+t.memo+"</div>":"");2==t.customizeMsgType||3==t.mst?T._getMsg(t,5,'<li class="clearfix custom-event-li" id="msg'+t.tm+'">'+s+"</li>","x"):t.mst&&1!=t.mst?2==t.mst&&T._getMsg(t,5,s,i?"r":"s"):(T._getMsg(t,5,s,"c"),t.notEnd||T.publish("__visitorSendMsg","["+lanRes.imageAndHtml+"]"+(t.title||"")),t.notEnd||T.publish("__visitorStartSendMsg","["+lanRes.imageAndHtml+"]"+(t.title||"")),t.notStore||t.notEnd||"1"!=t.closeURLPage||(view.hideURLSite&&view.hideURLSite(),view.hideMenus&&view.hideMenus()))}}),this.subscribe("receiveURL",function(e,t){var i=t.pushUrlDetail.url,a="";if(view.chat.needHttps&&i.match(/^http:/i)&&(a=" push-blank"),view.pushURLParam){var n=i.split("#");i=n[0]+(-1==n[0].indexOf("?")?"?":"&")+view.pushURLParam+(n[1]?"#"+n[1]:"")}var o='<a class="push-url clearfix'+a+'" target="info_frame3" href="'+i+'"><div class="push-icon echat bg1"></div><div class="push-content"><div class="push-name">'+t.pushUrlDetail.urlName+' </div><div class="push-url-link">'+t.pushUrlDetail.url+"</div></div></a>";T._getMsg.call(this,t,6,o,"s"),1!=T.queryParams.echatIframeDisable&&-1==i.indexOf("echatIframeDisable=1")&&view.handlePushURL&&view.handlePushURL(i,void 0,t.pushUrlDetail.urlName)}),this.subscribe("getMsgImg",function(e,t,i){T.needHttps&&(T.qiniuDomain&&T.qiniuHttpsDomain&&(t.bigImg&&(t.bigImg=t.bigImg.replace(T.qiniuDomain,T.qiniuHttpsDomain)),t.smallImg&&(t.smallImg=t.smallImg.replace(T.qiniuDomain,T.qiniuHttpsDomain)),t.sourceImg&&(t.sourceImg=t.sourceImg.replace(T.qiniuDomain,T.qiniuHttpsDomain))),t.bigImg&&(t.bigImg=t.bigImg.replace(/^http:/,T.needHttps)),t.smallImg&&(t.smallImg=t.smallImg.replace(/^http:/,T.needHttps)),t.sourceImg&&(t.sourceImg=t.sourceImg.replace(/^http:/,T.needHttps))),t.fileName&&"temp.png"!=t.fileName||(t.fileName="Echat"+(new Date).format("yyyyMMddhhmmss")+".png"),t.sourceImg=t.sourceImg||t.bigImg;var a=view.showMsgImg?view.showMsgImg(t):"<img "+(t.notEnd?"":'onload="javascript:view.scrollToBottom()"')+' id="img'+(t.fileIdentity||t.tm||(new Date).getTime())+'" attname="'+t.fileName+'" bigimg="'+(t.bigImg||t.sourceImg)+'" src="'+t.smallImg+'" source="'+(t.sourceImg||"")+'" sw="'+(t.sourceWidth||"")+'" sh="'+(t.sourceHeight||"")+'" class="msg-img"/>';t.fileIdentity&&_$(t.clientFileId||t.fileIdentity)&&(T.addSendFile(),T.publish("__visitorSendMsg","["+lanRes.image+"]")),T.sendingFileToken&&T.sendingFileToken.end&&T.sendingFileToken.token==t.fileIdentity&&(T.sendingFileToken="",T.publish("_toggleEnableFile",!0)),t.id=t.clientFileId||t.identityKey||t.fileIdentity,T._getMsg.call(this,t,2,a,865==t.mt?"c":i?"r":"s"),view.initImgPlay&&view.initImgPlay(),T.isInRobot||865!=t.mt&&"local"!=t.mt||T.publish("_addSendMsgNum")}),this.subscribe("getMsgFile",function(e,t,i){T.needHttps&&t.fileUrl&&(T.qiniuDomain&&T.qiniuHttpsDomain&&(t.fileUrl=t.fileUrl.replace(T.qiniuDomain,T.qiniuHttpsDomain)),t.fileUrl=t.fileUrl.replace(/^http:/,T.needHttps)),!_$("downFrame")&&_$("downFileFrame")&&(_$("downFileFrame").innerHTML='<iframe id="downFile" name="downFile" style="display:none;"></iframe>');var a,n,o,s="downFile",r=t.fileUrl;T.isIOS&&(s="_blank"),(a=view.SDKNative?view.getMsgFile(t):t.c?t.c:"")||(n=t.fileUrl&&0<t.fileUrl.indexOf("?")?"&":"?",o=t.fileUrl+n+"attname="+encodeURIComponent(t.fileName),a=view.SDK||2!=t.fileType||window.ltIE10?'<div class="file-info"><div class="file-name">'+t.fileName+'</div><div class="file-size">'+(parseInt(t.fileSize/1024)+1)+'KB</div></div><div class="file-icon">&nbsp;</div><a class="file-link file-link-a color0" href="'+o+'" target="'+s+'">'+lanRes.download+"</a>":T.isMobile?'<div class="file-video" identity="'+t.fileIdentity+'" onclick="__playVideo(\''+r+"','"+(t.videoThumbUrl||"")+"','"+o+"','"+(t.fileName||"")+'\')" style="'+(t.videoThumbUrl?"background:url("+t.videoThumbUrl+") no-repeat;background-size:100%;":"")+'"><div class="icon_video"></div><div class="video_logo">VIDEO</div></di>':'<a class="file-video" target="_blank" href="/visitor/pc/video.html?videoUrl='+encodeURIComponent(r)+'" style="'+(t.videoThumbUrl?"background:url("+t.videoThumbUrl+") no-repeat;background-size:100%;":"")+'"><div class="icon_video"></div><div class="video_logo">VIDEO</div></a>'),866==t.mt&&(t.fileIdentity||t.identityKey)&&(_$(t.clientFileId)||_$(t.fileIdentity||t.identityKey))&&(T.addSendFile(),T.publish("__visitorSendMsg","["+(2==t.fileType?lanRes.video:lanRes.fileHtml)+"]")),T.sendingFileToken&&T.sendingFileToken.end&&T.sendingFileToken==t.fileIdentity&&(T.sendingFileToken="",T.publish("_toggleEnableFile",!0)),t.id=t.clientFileId||t.identityKey||t.fileIdentity,T._getMsg.call(this,t,3==t.fileType||4==t.fileType?t.fileType:1,a,866==t.mt||"local"==t.mt?"c":i?"r":"s"),T.isInRobot||866!=t.mt&&"local"!=t.mt||T.publish("_addSendMsgNum")}),T.subscribe("_toggleEnableFile",function(e,t){if(!T.hasFormData){var i;(i=_$("file_up").contentDocument)||(i=_.frames.file_up.document);var a=i.getElementById("uploadInput");t?(x(".menu-file").removeClass("menu-file-sending").attr("title",lanRes.selectFile),a.setAttribute("disabled",""),a.disabled=!1,a.removeAttribute("disabled"),a.title=lanRes.selectFile,a.setAttribute("title",lanRes.selectFile)):(x(".menu-file").addClass("menu-file-sending").attr("title",T.sendingTitle),a.disabled="disabled",a.setAttribute("disabled","disabled"),a.title=T.sendingTitle,a.setAttribute("title",T.sendingTitle))}}),this.subscribe("getMsg",function(e,t){var i=(t.translation||t.content)+"";if(t.relateId){var a=this.changeStorgeBackMsg(t.relateId);if(a){x("#msg"+a).html("");var n='<div style="padding: 10px 0 20px;text-align: center;"><span style="display: inline-block;padding: 8px 10px;background-color: #bfbfbf;border-radius: 5px;color: #FFF;">'+lanRes.backMsgTip+"</span></div>";x("#msg"+a).html(n)}}if(i){i=(i=i.replace(/<img\b.*?(?:\>|\/>)/gi,function(e){var t=/\bsrc\b\s*=\s*[\'\"]?([^\'\"]*)[\'\"]?/i.exec(e)[1],i={smallImg:t,bigImg:t,sourceImg:t,fileName:"预览"};return view.showMsgImg?view.showMsgImg(i):'<img onerror="view.imgError&&view.imgError(this)" '+(i.notEnd?"":'onload="javascript:view.scrollToBottom()"')+' id="img'+(i.tm||(new Date).getTime())+'" attname="'+i.fileName+'" bigimg="'+(i.bigImg||i.sourceImg||"")+'" src="'+i.smallImg+'" source="'+(i.sourceImg||"")+'" sw="'+(i.sourceWidth||"")+'" sh="'+(i.sourceHeight||"")+'" class="msg-img"/>'})).replace(/&nbsp;([^&\s])/g," $1"),t.staffImg||t.notStore||(t.staffId=T.staffId),T._getMsg.call(this,t,0,i)}}),T.robotUnknowTime=0,this.subscribe("getMsgRobot",function(e,t){if("r"==t.f&&t.c)return T._getMsg.call(this,{talkId:t.talkId,tm:t.tm,mt:12001,ff:"r",staffImg:t.staffImg,staffName:t.staffName,content:t.c,notEnd:!0,notStore:!0},0,t.c,"r");var i,a,n,o,s=t.knowledgeAnswerList||[],r=!1,l="",d='<ul class="question-list">',c='<div class="ipt-list">';if(t.nonTextMsg)10011==(l=t.nonTextMsg).mt?T.publish("receiveVisEvt",l,!0):641==l.mt?T.publish("getMsgImg",l,!0):642==l.mt&&T.publish("getMsgFile",l,!0);else if(4==t.type){if(t.notStore)return;n=t.segWords;for(var u,f=!1,m=0,h=0;h<s.length;h++){if(a=(i=s[h]).question,f=!1,a==T.lastText){h++,m=1,c='<div class="ipt-list"><a class="ipt-list-li" did="'+i.docId+'" ques="'+escape(i.question)+'"><b class="words-seg">'+a+"</b></a>";break}if(n)for(var p=0;p<n.length;p++)u=n[p],u=T.escapeRegExp(u),a=a.replace(new RegExp(u,"igm"),function(e,t){f=!0;var i=arguments.length,a=arguments[i-2];if(!(0<a))return'<b class="words-seg">'+e+"</b>";var n=arguments[i-1].substring(0,a),o=arguments[i-1].substring(a);if(u.match(/^s|sp|spa|span$/)&&n.match(/<$/))return e;if(u.match(/^n|an|pan|span$/)){var s="</span>".replace(u,",").split(",");if(n.match(new RegExp(s[0])&&o.match(s[1])))return e}return/(\<span[^>]*>([^<]+(?!\<\/span\>))?$)|(\<[a-zA-Z]+[^>]*$)/gi.test(n)?e:'<b class="words-seg">'+e+"</b>"});f&&(m++,c+='<a class="ipt-list-li" did="'+i.docId+'" ques="'+escape(i.question)+'">'+a+"</a>")}0<m?x("#input_suggest").html(c+"</ul>").removeClass("hide"):x("#input_suggest").addClass("hide").html(" ")}else if(3==t.type)t.f,t.tip=t.tips,204==t.result||205==t.result?(T.showInfoTip(t,void 0,void 0,void 0,t.talkId),t.notStore||(T.robotToHumanKey=t.robotToHumanKey,T.publish("toSetID"),x("#input_suggest").addClass("hide").html(" "),T.handleNewMsgMid(t.mid,{c:t.tips,f:"sys",m:0},!0,t)),delete T.paramChat.staffId,delete T.paramChat.staffName,delete T.paramChat.staffPhoto,delete T.paramChat.talkId):206==t.result||202==t.result?console.log(206==t.result?"禁用留言":"禁用转人工"):207==t.result&&(T.showInfoTip(t,void 0,void 0,void 0,t.talkId),t.notStore||(x("#robotToStaff").show(),w(T),view.showRobotToStaff&&view.showRobotToStaff(t),view.handleShowRobotToStaff&&view.handleShowRobotToStaff(),T.handleNewMsgMid(t.mid,{c:t.tips,f:"sys",m:0},!0,t)));else if(5==t.type){(l=(l=t.tips||"").replace(/&nbsp;([^&\s])/g," $1"))&&T._getMsg.call(this,x.extend(t,{ff:"r",staffImg:t.staffImg||T.staffImg,staffName:t.staffName||T.staffName,content:'<div class="msg-item-robot"> '+l+"</div>",notEnd:"r"==t.f,notStore:"r"==t.f,talkId:t.talkId}),0,'<div class="msg-item-robot"> '+l+"</div>","r");var g,v=x("#q"+t.robotDetailId);t.feedback&&x(v).attr("did","").attr("qid","").addClass("robot-feedback-had").addClass("robot-feedback-had"+t.feedback).attr("feedback",t.feedback),2==t.feedback&&x(".feedback-btn-unsolve",v.results[0]).addClass("feedback-btn-unsolve-sel"),1==t.feedback&&x(".feedback-btn-solve",v.results[0]).addClass("feedback-btn-solve-sel"),t.feedbackSubitem&&(2==(g=x(v).attr("feedback"))?(x(".feedback-sub-solved",v.results[0]).remove(),console.log(x(".feedback-sub-li",v.results[0])),x(".feedback-sub-li",v.results[0]).each(function(){x(".feedback-sub-content",this).text()==t.feedbackSubitem&&(x(this).addClass("feedback-sub-sel2"),x(".feedback-sub-list",v.results[0]).addClass("robot-feedback-sub-had"))})):1==g&&(x(".feedback-sub-unsolved",v.results[0]).remove(),x(".feedback-sub-li",v.results[0]).each(function(){x(".feedback-sub-content",this).text()==t.feedbackSubitem&&(x(this).addClass("feedback-sub-sel1"),x(".feedback-sub-list",v.results[0]).addClass("robot-feedback-sub-had"))})),setTimeout(function(){view.scrollUpdate()},100))}else if(6==t.type)(l=(l=t.tips||"").replace(/&nbsp;([^&\s])/g," $1"))&&T._getMsg.call(this,x.extend(t,{ff:"r",staffImg:t.staffImg||T.staffImg,staffName:t.staffName||T.staffName,content:'<div class="msg-item-robot"> '+l+"</div>"}),0,'<div class="msg-item-robot"> '+l+"</div>","r");else if(7==t.type)l=t.tips||t.content||"",T.showInfoTip(l),t.notStore&&T.handleNewMsgMid(t.mid,{c:l,f:"sys",m:0},!0,t);else if(1==t.type||2==t.type){if((i=s[0])?1==i.answerType?l+=t.tips||"":2==i.answerType?(r=1==i.type,l+='<div class="robot-tip">'+(t.tips||"")+"</div>",l+=i.answer||"",o=i.relateKnowledges,d+='<div class="robot-tip margin-top10">'+(t.tipsExt||"")+"</div>"):3==i.answerType?(o=i.suggestions,d+='<div class="robot-tip">'+(t.tips||"")+"</div>"):4==i.answerType?l+=i.answer||"":5==i.answerType?(l+=i.answer||"",r=1==i.type,o=i.relateKnowledges,d+='<div class="robot-tip">'+(t.tips||"")+"</div>"):6==i.answerType&&(l+=i.answer||"",r=1==i.type,o=i.relateKnowledges,d+='<div class="robot-tip margin-top10">'+(t.tips||"")+"</div>"):l+=t.tips||"",o&&o.length){for(p=0;p<o.length;p++)d+='<li class="question-list-li" oid="'+i.docId+'" did="'+o[p].docId+'" ques="'+escape(o[p].question)+'"><span class="list-style-dot">'+(p+1)+'. </span><span class="color-link">'+o[p].question+"</span></li>";d+="</ul>"}else d="";var b,y="";r&&T.robotFeedback&&(i.searchId||(i.searchId=""),i.originQuestion||(i.originQuestion=""),b=t.relateId&&T.robotFeedbackTemp&&T.robotFeedbackTemp[t.relateId]||{},t.feedback=t.feedback||b.feedbackResult,y='<div id="q'+i.robotDetailId+'" class="robot-feedback'+(t.feedback?" robot-feedback-had robot-feedback-had"+t.feedback+'"':'" did="'+i.docId+'" qid="'+i.queryId+'" rid="'+i.robotDetailId+'" searchId="'+i.searchId+'" originQuestion="'+escape(i.originQuestion)+'"')+">"+T.robotFeedback({feedback:t.feedback,feedbackSubitem:b.feedbackSubitem,answerItem:i})),((l=l.replace(/&nbsp;([^&\s])/g," $1"))||d)&&T._getMsg.call(this,x.extend(t,{ff:"r",staffImg:t.staffImg||T.staffImg,staffName:t.staffName||T.staffName,answer:l,content:'<div class="msg-item-robot"> '+l+d+"</div>"}),0,'<div class="msg-item-robot"> '+l+d+"</div>"+y,"r")}}),this.subscribe("getMsgMine",function(e,t){var i=t.content;T.isInRobot&&(t.ff="r"),T.isInRobot||T.publish("_addSendMsgNum"),T._getMsg.call(this,t,0,i,"c")}),this.resendFile=function(e,t,i){var a=this;if(a.uploadServiceType<a.fileUploadInfosLength&&e.uploadServiceType<a.fileUploadInfosLength){var n=a.uploadServiceType;return(!i||n-i<=0)&&(n=++a.uploadServiceType),a.publish("sendVisitorEvent",{et:123,ssl:a.needHttps?1:void 0,uploadServiceType:n,ft:e.fileType},function(e){!e.successful||e.failure?!1===e.autoResend&&a.handleFileSelect.error():x("#"+t).remove()}),!1}return a.publish("getErr",{reqInfo:t,code:-2}),!0},this.subscribe("getFileToken",function(e,t){2==t.fileType&&T.handleFileSelect.back();var i,a,n=T.fileUploadInfos["uploadServiceType"+(t.uploadServiceType||T.uploadServiceType)]||t,o={},s=T.needHttps?n.fileUploadHttpsUrl:n.fileUploadUrl,r=t.qiniuKey||t.token||t.aliyunKey&&t.aliyunKey.match(/\/([^\/]+$)/)[1],l=null,d=n.fileUploadParam.split(",");t.uploadServiceType;for(var c=0;c<d.length;c++)o[d[c].split("=")[0]]=(l=d[c].match(/\$\{([^\}]+)\}/))?t[l[1]]:d[c].split("=")[1];if(t.fileType=t.fileType||2,1==t.fileType){if(!T.pasteFileSource)return;(I=new FormData).append("file",T.pasteFileSource)}if(3===t.uploadServiceType&&(s+="?token="+t.token),2!=t.fileType&&3!=t.fileType&&4!=t.fileType)1==t.fileType||(5==t.fileType?(T.fileToken=t,T.publish("_captureImg",null)):6==t.fileType&&(T.fileToken=t,T.publish("_captureImgIE",null)));else{var u=_;T.hasFormData||(u=_$("file_up").contentDocument)||(u=_.frames.file_up.document);var f=u.getElementById("uploadInput"),m=f.value||f.getAttribute("value");if(!m)return void console.log("no file to send",m);for(var h,p=(f.files||[{}]).length,g=0;g<p;g++)if(0===C[g+""]||3===C[g+""]){h=g;break}var v=h+1===p;if(f.files){if(!f.files[h]||!f.files[h].size)return void console.log("no file to send",m);(f.files[h]||f.files[h].name)&&(m=f.files[h].name)}if(i=m.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1"),T.hasFormData){try{for(var b in a=new FormData,o)"Content-Disposition"!=b&&"x:filename"!=b||(o[b]=i),a.append(b,o[b]);a.append("file",f.files[h],i);var y=new XMLHttpRequest;y.open("POST",s,!0);var w=!1;y.onerror=y.ontimeout=y.onabort=function(){C[h]=3,w||T.resendFile(t,r,t.uploadServiceType),w=!0},y.addEventListener("load",function(e){200==y.status&&y.responseText&&(1==y.responseText||y.responseText.match(/\{\s*"errorCode"\s*:\s*1\s*}/))?(C[h]=2,v&&setTimeout(function(){_.forms.namedItem("uploadForm").reset()})):403==y.status||y.responseText&&y.responseText.match(/\{\s*"errorCode"\s*:\s*146\s*}/)?(C[h]=4,T.publish("getErr",{reqInfo:r,code:-2}),setTimeout(function(){_.forms.namedItem("uploadForm").reset()})):(C[h]=3,w||T.resendFile(t,r,t.uploadServiceType),w=!0)}),C[h]=1,y.send(a),_$(r)||T.showMsg({id:r,f:"c"},'<div class="file-sending">'+lanRes.fileSending+"</div>"),T.sendingFileToken={token:r,end:!0}}catch(e){if(!v)return;T.hasFormData=!1,T.hasInitFile=!1,T.addSendFile(),null,console.log("变为iframe上传")}v&&(f=a=null)}else{(u=_$("file_up").contentDocument)||(u=_.frames.file_up.document);var I=u.getElementById("uploadForm");for(var b in o)if("Content-Disposition"!=b&&"x:filename"!=b||(o[b]=i),I[b])I[b].value=o[b];else{var k=u.createElement("input");k.name=b,k.type="hidden",k.value=o[b],I.insertBefore(k,f)}x(I).attr("action",s),I.submit(),T.showMsg({id:r,f:"c"},'<div class="file-sending">'+lanRes.fileSending+"</div>"),setTimeout(function(){T.sendingFileToken={token:r,end:!0},T.publish("_toggleEnableFile",!1)},10)}}}),this.subscribe("niuniuKey",function(e,t){if(t){var i=t.split(","),a=new Date,n=a.getFullYear()+""+(a.getMonth()+1)+a.getDate();a.setDate(a.getDate()+1);var o=a.getFullYear()+""+(a.getMonth()+1)+a.getDate();T["niuniu"+n]=i[0],T["niuniu"+o]=i[1]}});var s,l,d=navigator.userAgent.toLowerCase(),c=(d.indexOf("baidubrowser"),-1<d.indexOf("mqqbrowser")&&this.Device.OS,"uc"==this.Browser.browser);T.isMobile||T.isInRobot?this.bindPlainTextEvent():T.changeToIframe(),c&&x("#footer").addClass("footer-absolute"),T.resetForm=function(e){var t;if(T.hasFormData)t=_.forms.namedItem("uploadForm").reset();else{var i=_$("file_up").contentDocument||_.frames.file_up.document;t=i.getElementById("uploadForm")}setTimeout(function(){t&&t.reset()},e||10)},T.handleFileSelect=(l="tempInitSendFile",{back:function(){--s<1&&T.publish("enableSelectFile",l)},error:function(){--s<1&&T.publish("enableSelectFile",l)},change:function(e){s=e,T.publish("disableSelectFile",l)},isSending:function(){return 0<s},reset:function(){s=0,T.publish("enableSelectFile",l)}}),T.subscribe("enableSelectFile",function(e,t){x(".menu-file").removeClass("menu-file-disabled"),x("#"+t).remove()}),T.subscribe("disableSelectFile",function(e,t){T.showMsg({id:t,f:"c"},'<div class="file-sending">'+lanRes.fileSending+"</div>"),x(".menu-file").addClass("menu-file-disabled")}),x("body").on("click",".menu-file-disabled",function(){T.handleFileSelect.isSending?T.showTip(lanRes.fileDisable):T.handleFileSelect.reset()});var C={};window.fLoad=function(e){(e=e||_$("file_up").contentDocument)||(e=_.frames.file_up.document);var s=e.getElementById("uploadInput");view.dji&&(s.style.height="62px"),"1"===view.chat.queryParams.multipleFile&&(x(s).attr("multiple","multiple"),x(s).attr("title","最多选择9个文件")),s.onchange=function(){if(C={},!0===T.companyOff||T.busyCanSend&&"0"!=T.queryParams.autoChat||!0===T.chatting){var e=s.value||s.getAttribute("value");if(!function(e){return!(9<e)||(T.isMobile?(_$("leave_tip_con").innerHTML="最多选择9个文件",T.tipTimer&&clearTimeout(T.tipTimer),x("#leave_tip").removeClass("tiphide"),T.tipTimer=setTimeout(function(){x("#leave_tip").addClass("tiphide")},3e3)):T.showDialog({tip:"选择文件超过最大限制,最多选择9个文件！",cancel:!1}),!1)}((s.files||[{}]).length))return!1;if(e){var t=e,i=(s.files||[{}]).length;T.handleFileSelect.change(i);for(var a=0;a<i;a++){if(s.files){if(!s.files[a]||!s.files[a].size){console.log("no file to send",e),T.handleFileSelect.error();continue}(s.files[a]||s.files[a].name)&&(e=s.files[a].name)}var n=e.replace(/.+\./,""),o=e.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1");if(T.sendingTitle=o+"."+n+lanRes.fileSendWait,n&&-1==T.uploadFileType.indexOf(n.toLowerCase()))T.showDialog({tip:"ERROR: "+lanRes.unsupportFileType+"。</br>"+lanRes.supportFileType+": "+T.uploadFileType,cancel:!1}),T.handleFileSelect.error();else T.getFileSize(s,a)>T.uploadFileSize?(T.showDialog({tip:lanRes.fileSizeOut.replace("${maxSize}",T.uploadFileSize/1024/1024+"M"),cancel:!1}),T.handleFileSelect.error()):(C[a+""]=0,s.files&&(t=s.files[a]),t,T.publish("sendVisitorEvent",{et:123,ssl:T.needHttps?1:void 0,uploadServiceType:T.uploadServiceType,ft:2},function(e){e.successful&&!e.failure||!1===e.autoResend&&T.handleFileSelect.error()}),view.hideMenus&&view.hideMenus(0,!1))}}else console.log("no file to send",e)}else x("#busyTipLine").removeClass("hide").show()},s.onclick=function(){view.hideMenus(),T.sendingFileToken}},T.addSendFile(),T.emojitimer=setTimeout(function(){try{T.loadEmoji()}catch(e){}},100),this.subscribe("getErr",function(e,t){var i=t.reqInfo,a=i&&_$(i);switch(t.code){case 16:x(".file-sending",a).html(lanRes.tooLargeUploadFail);break;case 17:x(".file-sending",a).html(lanRes.unsupportFileType);break;case 18:default:x(".file-sending",a).html(lanRes.unkownErrorUpload)}16!=t.code&&17!=t.code&&18!=t.code||T.addSendFile()});var g=!1;this.subscribe("getHistory",function(e,t){if(T.talkId=t.talkId,T.hasGetHistory=!0,!g){g=!0,setTimeout(function(){g=!1},1e3);var i,a,n,o,s,r=t.chatDetailList,l=0;if(T.robotFeedbackTemp={},T.isArray(r)){T.lastMsgTM||!0,o=_$("list_msg"),n=function(e){var t,i=e.length,a=[];if(!i)return a;for(var n=0;n<i;n++)(t=x(e[n]).parents("li").results).length&&a.push(t[0]);return a}(x(".msg-error",o).results);for(var d,c=o.childNodes,u=c.length,f=0;f<u;f++)if(1==(d=c[f]).nodeType&&x(c[f]).hasClass("innerAD")){d=d.cloneNode(!0);break}o.innerHTML="",f<u&&o.appendChild(d),T.clearHistoryByTalkId(T.talkId),T.sendMsgNum=0,orderedStaffInfo={};for(var m=0;m<r.length;m++)if(315==(a=i=r[m]).dataType&&i.data&&(864==(i=JSON.parse(i.data)).mt&&T.isInRobot&&a.feedbackResult?T.robotFeedbackTemp[a.id]={feedbackResult:a.feedbackResult,feedbackSubitem:a.feedbackSubitem}:i.relateId=a.relateId||i.relateId),!(1e3<i.mt&&"10001"!=i.mt&&"10010"!=i.mt&&"10011"!=i.mt&&"12001"!=i.mt)){if(0<x("#msg"+i.tm).results.length&&x("#msg"+i.tm).remove(),T.lastMsgTM=i.tm,i.notEnd=!0,864==i.mt)T.publish("_addSendMsgNum");else if("10001"==i.mt||"686"==i.mt){if(orderedStaffInfo=T.updateStaffInfo(void 0,{staffId:i.toStaffId||i.staffId,staffNickName:i.staffNickName||i.toStaffNickName,staffDetailInfo:i.staffDetailInfo||i.toStaffDetailInfo}),"686"==i.mt)continue}else orderedStaffInfo.staffName&&(i=x.extend(i,orderedStaffInfo));if("10001"!=i.mt)if("10011"!=i.mt)if(865!=i.mt&&641!=i.mt)if(647!=i.mt&&"10010"!=i.mt&&605!=i.mt)if(866!=i.mt&&642!=i.mt)if(680!=i.mt)if(640!=i.mt)if(655!=i.mt){if(890==i.mt)1==i.templateInfoList[0].type||3==i.templateInfoList[0].type?(i.content=T.getBookComfirm(i.templateInfoList),i.m=3):(i.content=T.showInfoTip({f:"sys",tip:lanRes.receiveBookForm},void 0,void 0,!0,i.talkId,i.tm,!0),i.m=4);else if("12001"==i.mt){T.publish("getMsgRobot",i);continue}var h={t:(s=i.tm,(!l||6e4<s-l)&&(l=s,1)?new Date(i.tm).format("hh:mm"):void 0),tm:i.tm,mt:i.mt,c:i.content,ff:T.isInRobot?"r":void 0,f:864==i.mt?"c":890==i.mt?"x":"s",m:i.m||0,id:"msg"+i.tm,talkId:t.talkId,notEnd:!0};T.showMsg(h),delete h.id,3==h.m&&(h.c=i.templateInfoList),delete h.notEnd,T.pushHistory(h)}else T.publish("getLeaveMsg",i);else T.publish("getMsg",i);else T.publish("receiveURL",i);else T.publish("getMsgFile",i);else{if(8==i.type)continue;T.publish("getSysMsg",i)}else T.publish("getMsgImg",i);else T.publish("receiveVisEvt",i);else T.staffMap[i.toStaffId]&&T.publish("getSysMsg",{talkId:t.talkId,tm:i.tm,mt:"10001",mid:i.mid,notStore:i.notStore,notEnd:i.notEnd,staffId:i.toStaffId,staffName:T.staffMap[i.toStaffId].staffName},i)}for(m=0;m<n.length;m++)o.appendChild(n[m]),x("img",n[m]).each(function(){x(this).attr("src",x(this).attr("src"))});if(setTimeout(function(){view.scrollToBottom(),T.isMobile&&x("#footer").removeClass("hide"),view.hideMenus(),T.wait874List=!1,T.publish("removeLoading")},10),T.isMobile&&"none"!=_$("loading").style.display&&x("#footer").addClass("hide"),view.miniShow){var p=x.store("ECHAT_"+view.chat.companyId+"_"+view.chat.visitorId+"_mid");p&&x.cookie("ECHAT_"+view.chat.companyId+"_"+window.chatVisitorId+"_mid_read",p)}}else T.wait874List=!1,T.publish("removeLoading")}}),this.subscribe("getSysMsg",function(e,t){if(T.chatting||2!=t.type){var i;if("10001"==t.mt)return i=(t.staffName||lanRes.serviceStaff)+" "+lanRes.transferStaff,T.showInfoTip(i,"msg"+t.tm,void 0,void 0,t.talkId,t.tm,t.notEnd),t.c="10001",t.f="x",void(t.notStore&&(T.pushHistory(t),T.handleNewMsgMid(t.mid,{m:0,f:"sys",c:i},!0,t)));if("647"!=t.mt||601!=t.exType||t.exType!=(this.preMsg||{}).exType){if((this.preMsg=t).notStore||!t.talkId||T.talkId&&1!=t.type&&10!=t.type&&7!=t.type||(T.talkId=t.talkId,T.hasGetHistory||T.companyOff),10==t.type)return t.notStore||(T.talkId=t.talkId,T.robotTalkId=t.talkId),void this.publish("_showCommonQue",t);if(i=t.content||t.c){var a=(i=i.replace(/<img\b.*?(?:\>|\/>)/gi,function(e){var t=/\bsrc\b\s*=\s*[\'\"]?([^\'\"]*)[\'\"]?/i.exec(e)[1],i={smallImg:t,bigImg:t,sourceImg:t,fileName:"预览"};return view.showMsgImg?view.showMsgImg(i):"<img "+(i.notEnd?"":'onload="javascript:view.scrollToBottom()"')+' id="img'+(i.tm||(new Date).getTime())+'" attname="'+i.fileName+'" bigimg="'+(i.bigImg||i.sourceImg||"")+'" src="'+i.smallImg+'" source="'+(i.sourceImg||"")+'" sw="'+(i.sourceWidth||"")+'" sh="'+(i.sourceHeight||"")+'" class="msg-img"/>'})).replace(/&nbsp;([^&\s])/g," $1");if(5==t.type||"s"==t.f)return t.staffId&&T.staffMap[t.staffId+""]&&(t=x.extend(t,T.staffMap[t.staffId+""])),void T._getMsg.call(this,t,0,a);if(T.showInfoTip({f:"sys",tip:i},"msg"+t.tm,void 0,void 0,t.talkId,t.tm,t.notEnd),!t.notStore){var n={tm:t.tm,f:"sys",mt:t.mt,m:0,c:i};n.talkId=t.talkId||T.talkId,T.pushHistory(n),n.c&&T.handleNewMsgMid(t.mid,n,!0,t),t&&!T.isMobile&&view.setDocumentTitle&&view.setDocumentTitle("s")}}}}}),T.hasWaitingStatus=!1,this.subscribe("getPosMsg",function(e,t){T.companyOff=!1,x("#positionInfo").remove(),T.hasWaitingStatus||(T.publish("__chatStatus","waiting"),x.cookie("ECHAT_"+T.companyId+"_"+window.chatVisitorId+"_chatStatus",1,{path:"/"}),T.hasWaitingStatus=!0,T.publish("setConfig",T.msg649)),T.queueTxt=T.msg649.queueTxt||T.msg649.mobileQueueTxt||T.queueTxt,T.queueTxt&&T.showInfoTip({f:"sys",tip:T.queueTxt.replace("${waitcount}",t.position)},"positionInfo","warn",void 0,t.talkId,t.tm),T.publish("__chatQueue",t.position),T.initQcode()}),this.subscribe("inviteSatisfy",function(){T.showSatisfy(2)}),this.subscribe("staffInfo",function(e,t){T.staffName=t.staffNickName||lanRes.serviceStaff;var i=t.staffDetailInfo;i&&"string"==typeof i&&(i=JSON.parse(i)),i&&i.staffHead&&(T.needHttps&&(i.staffHead=i.staffHead.replace(/^http:/,T.needHttps)),T.paramChat.staffPhoto=i.staffHead),T.paramChat.staffPhone=i.staffPhone||"",T.paramChat.staffInfo=i.staffInfo||"",T.staffImg=i.staffHead||T.defaultStaffImg,view.initServiceInfo&&view.initServiceInfo(T,i),x(".sa-avatar").html('<img src="'+view.chat.staffImg+'"/>'),i&&T.saveHistoryStaff(T.staffImg,T.staffName),view.startChatRefreshAD&&view.startChatRefreshAD(),view.showStaffInfo&&T.staffInfoEnable&&T.staffInfoEnable.staffInfoChattingEnable&&view.showStaffInfo(),t.staffDetailInfoMsgList&&T.handleStaffMap(t.staffDetailInfoMsgList,t.notStore),T.publish("showChatStaffInfo"),T.publish("__chatStaffInfo",{staffId:T.paramChat.staffId,staffNickName:T.paramChat.staffName||"",staffPhone:T.paramChat.staffPhone,staffHead:T.staffImg,staffInfo:i.staffInfo||"",recordId:(T.isInRobot?"5_":"1_")+T.talkId})}),T.staffInfoRefreshMap={innerAD:{notEnableParam:!1,params:"[]",element:"#inner_frame",hash:!0,srcUrl:void 0,attr:"src",url:""},innerImgUrl:{attr:"href"},rightAD:null,leftAD:null,innerURL:{},merchantLink:null,staffInfo:null,urlList:null},T.subscribe("__chatStaffInfo",function(e,t){var i,a,o;for(i in T.staffInfoRefreshMap)if(a=T.staffInfoRefreshMap[i])if(T.isArray(a))for(var n=0;n<a.length;n++)s(a[n]);else s(a);function s(a){if(a.srcUrl){var n=T.getADURL(!a.notEnableParam,a.params,a.srcUrl,view.chat.paramChat,a.hash);x(a.element).each(function(e,t){var i=n;"IFRAME"==t.tagName&&(i=view.chat.addEchatInnerFrameParam(n)),"src"==a.attr?t.src=i:"href"==a.attr?t.href=i:x(t).attr(a.attr,i)}),a.url=o}}var r="media="+(view.windowType||"")+"&staffId="+(T.staffId||"")+"&staffName="+(T.staffName||"")+"&companyId="+(T.companyId||"")+"&talkId="+(T.talkId||"")+"&echatTag="+(T.queryParams.echattag||"");T.echatSourceTag=encodeURIComponent(r)}),this.subscribe("updateStaffInfo",this.updateStaffInfo),this.subscribe("chatEnded",function(e,t){var i,a=T.chatting,n=T.isInRobot;if(T.chatting=!1,T.isInRobot=0,T.hasGetHistory=!1,T.companyOff=void 0,T.staffImg=void 0,T.hasWaitingStatus=!1,T.endChatEvent(),T.publish("clearSendingMsg","endchat"),this.unSubscribe("_sendMsg"),view.toggleEnded&&view.toggleEnded("end"),x(".btn-close").addClass("hide"),x(".btn-qcode").addClass("hide"),x(".menu-capture").addClass("hide"),x(".menu-file").addClass("hide"),x("#robotToStaff").addClass("hide").hide(),T.hasEntryOrCode&&T.publish("entryCallback",{success:!0}),T.leaveAndClose&&view&&("3"==view.windowType||view.SDK)&&(x("#leave").addClass("hide"),x("#container").removeClass("hide"),x("#chat").removeClass("hide"),x("#footer").removeClass("hide"),x(".leave-entry-foot").addClass("hide"),x("#container_leave").addClass("hide"),x("html").removeClass("page-leave"),T.leaveAndClose=!1,T.showInfoTip('<div class="btn-restart" id="restartChat">'+lanRes.toContinueChat+"</div>",void 0,void 0,void 0,t.talkId,t.tm)),"10009"!=t.mt||4!=t.type&&10!=t.type||(T.paramChat.visEvt=T.initVisEvt,delete T.queryParams.autoPop,delete T.queryParams.autoChat),this.publish("_hideCloseBtn",t),x.cookie("ECHAT_"+T.companyId+"_"+window.chatVisitorId+"_chatStatus",0,{path:"/"}),t.justConnect)!0===a&&T.talkId&&(T.lastTalkIdForTemp=T.talkId);else{T.lastTalkIdForTemp=void 0,t.content&&T.publish("getSysMsg",t),T.hasLeaveMsg||t.fromHistory&&(!t.fromHistory||!1!==t.isForward||"605"!=t.mt&&"10009"!=t.mt)||(x("#restartChat").parents("li").remove(),T.showInfoTip({f:"sys",tip:'<div class="btn-restart" id="restartChat">'+lanRes.toContinueChat+"</div>"},void 0,void 0,void 0,t.talkId,t.tm)),T.visitorClose=!t.fromHistory&&(1==t.closeReason||T.visitorClose&&"0"==t.closeReason),T.toggleEvaluateMenu(1);var o=!0===a&&T.showSatisfy(1);T.postMessage(3),t.fromHistory||o||1==T.toLeaveWord&&T.staffChatNeedConnect||this.publish("_closeWin",t),t.talkId?T.talkId||(T.talkId=t.talkId):t.talkId=T.talkId,i=T.talkId,t.fromHistory&&!1!==t.isForward||("10009"!=t.mt||4!=t.type&&10!=t.type||(T.talkId="",x("#list_msg").show()),t.talkId&&T.handleSessionMsg(t),view.scrollToBottom()),T.talkId=i,t.fromHistory||(T.publish("__chatStatus","end-"+(t.closeReason||"0")+"-"+(o&&!n?"1":"0")),(T.staffChatNeedConnect||!view.SDK&&1==T.toLeaveWord||1==t.toChat)&&setTimeout(function(){T.publish("_triggerChat")},100))}}),this.subscribe("_closeWin",function(){if(!view.SDK&&T.visitorClose&&1!=T.toLeaveWord&&(T.leaveAndClose=!1,!(window.top==self&&window.EchatJsBridge||view.SDK)))if(2==view.windowType)view.isMsgBoxChat&&view.hasNative||T.postMessage("hideMBmini");else if(1==view.windowType)try{window.opener=null,window.open("","_self").close(),window.close()}catch(e){try{window.close()}catch(e){}}}),this.subscribe("entryCallback",function(e,t){if(1==t.success){if(x("#entry").html("").hide(),x("#verify").hide(),x("#mask").hide(),x("body").removeClass("entry"),T.hasEntryOrCode=!1,t.mt){T.publish("toRegisterChat");var i=T.entryParam;if(i){delete i.et,delete i.captcha;var a=x.store("ECHAT_"+T.companyId+"_ENTRY_HIS");a=a?JSON.parse(a):{},i=x.extend(a,i),x.store("ECHAT_"+T.companyId+"_ENTRY_HIS",JSON.stringify(i))}}}else T.publish("refreshVerify",{status:1})}),this.subscribe("receiveUnread",function(e,t){view.SDKNative||T.hasChatInOtherPage||T.lastTalkIdForTemp||!t.data.talkId||(_$("list_msg").childNodes.length<2&&x("#list_msg").html(""),T.loadHistory(t.data.talkId)),T.talkId=t.data.talkId,T.unreadMsg?T.unreadMsg.push(t):T.unreadMsg=[t];var i,a,n,o,s=t.data.chatDetailList,r=s.length,l="",d="",c=0,u=t.data.staffDetailInfoList;if(u&&u.length&&(T.handleStaffMap(u,!1),o=T.staffMap[u[u.length-1].staffId]),r){n="downFile",T.isIOS&&(n="_blank");for(var f=0;f<r;f++)if(i=s[f],a="","686"!=s[f].mt)if("10001"!=s[f].mt){if("640"==s[f].mt||"675"==s[f].mt||"647"==s[f].mt)d=s[f].content;else if("641"==s[f].mt)T.needHttps&&(T.qiniuDomain&&T.qiniuHttpsDomain&&(i.bigImg=i.bigImg.replace(T.qiniuDomain,T.qiniuHttpsDomain),i.smallImg=i.smallImg.replace(T.qiniuDomain,T.qiniuHttpsDomain)),i.bigImg=i.bigImg.replace(/^http:/,T.needHttps),i.smallImg=i.smallImg.replace(/^http:/,T.needHttps)),d=view.showMsgImg?view.showMsgImg(i):'<img attname="'+i.fileName+'" bigimg="'+(i.bigImg||i.sourceImg||"")+'" src="'+i.smallImg+'" class="msg-img"/>';else if("642"==s[f].mt)a="unread-file",T.needHttps&&(T.qiniuDomain&&T.qiniuHttpsDomain&&(i.fileUrl=i.fileUrl.replace(T.qiniuDomain,T.qiniuHttpsDomain)),i.fileUrl=i.fileUrl.replace(/^http:/,T.needHttps)),d='<div class="file-info"><div class="file-name">'+i.fileName+'</div><a class="file-size file-link" href="'+i.fileUrl+(!i.fileUrl||!i.fileUrl.match(/http[s]?:\/\/[^\/]*(qn|qiniu)[^\/]*\//i)&&i.fileUrl.match(/http[s]?:\/\/[^\/]*(oss)[^\/]*\//i)?"":(-1==i.fileUrl.indexOf("?")?"?":"&")+"attname="+i.fileName)+'" target="'+n+'"><span class="unread-size">'+(parseInt(i.fileSize/1024)+1)+'KB</span><span class="unread-download color0">'+lanRes.download+'</span></a></div><div class="file-icon">&nbsp;</div>';else if("10012"==s[f].mt);else if(680==s[f].mt){var m=s[f].pushUrlDetail.url,h="";if(view.chat.needHttps&&m.match(/^http:/i)&&(h=" push-blank"),view.pushURLParam){var p=m.split("#");m=p[0]+(-1==p[0].indexOf("?")?"?":"&")+view.pushURLParam+(p[1]?"#"+p[1]:"")}d='<a class="push-url clearfix'+h+'" target="info_frame3" href="'+m+'"><div class="push-icon echat bg1"></div><div class="push-content"><div class="push-name">'+s[f].pushUrlDetail.urlName+' </div><div class="push-url-link">'+s[f].pushUrlDetail.url+"</div></div></a>"}c++,d=680==s[f].mt?d:T.filterEmailPhoneLink(d),(d=(T.filterEmo(d)||"").replace(/\n/g,"</br>"))&&(o&&i.staffId&&i.staffId!=o.staffId&&(i.staffId=o.staffId),i.staffId&&T.staffMap[i.staffId]?(i.staffImg=T.staffMap[i.staffId].staffImg||T.defaultStaffImg,i.staffName=T.staffMap[i.staffId].staffName||i.staffNickName,T.needHttps&&i.staffImg&&(i.staffImg=i.staffImg.replace(/^http:/,T.needHttps)),l+='<li class="clearfix list-unread-li '+a+'"><div class="avatar-icon fl staff-icons"><img class="avatar-icon-img" src="'+i.staffImg+'"></div><div class="fl unread-staff-name">'+(i.staffName||lanRes.serviceStaff)+'：</div><div class="fl unread-msg">'+d+"</div></li>"):l+='<li class="clearfix list-unread-li '+(a="list-unread-sys")+'"><div class="avatar-icon fl staff-icons"><img class="avatar-icon-img" src="'+T.defaultStaffImg+'"></div><div class="fl unread-staff-name">'+lanRes.serviceSys+'：</div><div class="fl unread-msg">'+d+"</div></li>")}else o=T.updateStaffInfo(void 0,{staffId:i.toStaffId||i.staffId,staffNickName:i.staffNickName||i.toStaffNickName,staffDetailInfo:i.staffDetailInfo||i.toStaffDetailInfo});else i.staffDetailInfoList&&T.handleStaffMap(i.staffDetailInfoList,!1),i.staffDetailInfo&&(o=T.updateStaffInfo(void 0,i));x("#list_unread").append(l),view.showUnread&&view.showUnread(c)}}),x("#unread_close").on("click",function(){view.removeUnreadMsg&&view.removeUnreadMsg()}),x("#leave_tip").on("click",function(){T.tipTimer&&clearTimeout(T.tipTimer),x(this).addClass("tiphide")}),this.changeDocTitle=function(){if("title"in _)return function(e){_.title=e};var e,t=_$s("title");return t&&t[0]?e=t[0]:(e=_.createElement("title"),_$s("head")[0].appendChild(e)),"textContent"in e?function(e){_$s("title")[0].textContent=e}:"innerText"in e?function(e){_$s("title")[0].innerText=e}:function(){}}()},configToolMenus:function(e){var t=4;"1"!=(e=e||{}).toolEmoji?(x(".menu-emo").addClass("hide-important"),t--):x(".menu-emo").removeClass("hide-important"),"1"!=e.toolFile?(x(".menu-file").addClass("hide-important"),t--):x(".menu-file").removeClass("hide-important"),"1"!=e.toolSatisfaction?(x(".menu-satisfy").addClass("hide-important"),t--):x(".menu-satisfy").removeClass("hide-important"),0<x(".menu-capture").length&&("1"!=e.toolScreenshot?(x(".menu-capture").addClass("hide-important"),t--):x(".menu-capture").removeClass("hide-important")),0<x(".menu-phone").length&&("1"!=e.toolTelephone?(x(".menu-phone").addClass("hide-important"),t--):x(".menu-phone").removeClass("hide-important")),0==t?(x("#menu-tools").addClass("hide-important"),x("#container").addClass("menu-no-tools")):(x("#menu-tools").removeClass("hide-important"),x("#container").removeClass("menu-no-tools"))},plainTextToSendMsg:function(e){var i=this;return charMap={"<":"&lt;",">":"&gt;",'"':"&quot;"},e=e.replace(/\[#([^#]+)#\]/g,function(e,t){return"[#"+(i.lanEmo[t]||t)+"#]"}).replace(/[<">]/g,function(e){return charMap[e]})},openVisitorSend:function(){var s=this;this.unSubscribe("_sendMsg"),this.subscribe("_sendMsg",function(e,t){if(!view.handleNetwok||!view.handleNetwok())if(s.isInRobot||!0===s.companyOff||s.busyCanSend||"0"==s.queryParams.autoChat||!0===s.chatting){var i=t||s.getInput(!0);if(i.trim())if(i.match(/^\[#echat::lihong#\]$/))s.loadConsole(7304);else{s.plainText&&(i=s.plainTextToSendMsg(i));var a=(new Date).getTime(),n="msg"+a,o={t:s.checkHistoryTime(a)?(new Date).format("hh:mm"):void 0,tm:a,mt:864,f:"c",m:0,c:i,id:n};s.sendToServer(o),t||(s.lastText=null,view.afterSend()),s.publish("_firstSendMsg",{c:i}),s.publish("_addSendMsgNum")}}else x("#busyTipLine").removeClass("hide").show()})},postMessage:function(e){if(!this.doNotHasPostMessage&&2==view.windowType&&window.top!=self)try{return window.parent.postMessage(e,this.queryParams.fromhost||"*"),!0}catch(e){this.doNotHasPostMessage=!0,console.log(e)}return!1},getVisitorMessage:function(){},initDialog:function(){var e=this;e.hasInitDialog||(e.hasInitDialog=!0,x("body").on("click",".dialog-close",function(){x(".dialog").remove(),e.publish("_dialogCanel")}).on("click",".img-close",function(){x(".dialog").remove(),e.publish("_dialogCanel")}).on("click",".dialog-cancel",function(){x(".dialog").remove(),e.publish("_dialogCanel")}).on("click",".dialog-ok",function(){x(".dialog").remove(),e.publish("_dialogOk")}))},showDialog:function(e){var n=this,o=n.isMobile?"tap":"click";x(".dialog").remove(),this.publish("_dialogCanel"),n.initDialog();var t=e.tip,i='<div class="dialog dialog-hide"><div class="dialog-close"><i class="img-close"></i></div><div class="dialog-title">'+lanRes.tip+'</div><div class="dialog-content">'+t+'</div><div class="dialog-btns"><a class="dialog-btn dialog-ok bg0"><div class="bg0 fade-div"></div><span>'+(e.okTip||lanRes.okay)+"</span></a>"+(!1!==e.cancel?'<a class="dialog-btn dialog-cancel bg0 has-fade"><div class="bg0 fade-div"></div><span>'+lanRes.cancel+"</span></a>":"")+"</div></div>";function s(e){var t=x(".dialog").results,i=x(".dialog-ok").results[0];if(0==t.length)x("body").off(o,s);else{var a=e.srcElement||e.target;setTimeout(function(){i==a||x.fn.contains(i,a)?n.publish("_dialogOk"):n.publish("_dialogCanel"),x(".dialog").remove()},50)}}x(_$("index")||"body").append(i),n.unSubscribe(["_dialogOk","_dialogCanel"]),n.subscribe("_dialogOk",function(){x("body").off(o,s),e.ok&&e.ok(),n.unSubscribe(["_dialogOk","_dialogCanel"])}),n.subscribe("_dialogCanel",function(){x("body").off(o,s),e.cancel&&e.cancel(),n.unSubscribe(["_dialogOk","_dialogCanel"])}),setTimeout(function(){x("body").on(o,s),x(".dialog").removeClass("dialog-hide")},10),view.inputBlur&&view.inputBlur(void 0,1)},showAlertDialog:function(e){x(".dialog").remove();var a=this;a.initDialog();var t=e.tip,i='<div class="dialog dialog-hide"><div class="dialog-title">'+lanRes.tip+'</div><div class="dialog-content">'+t+'</div><div class="dialog-btns"><a class="dialog-btn dialog-ok bg0"><div class="bg0 fade-div"></div><span>'+(e.okTip||lanRes.okay)+"</span></a></div></div>";function n(e){var t=x(".dialog").results,i=x(".dialog-ok").results[0];0==t.length?x("body").off(a.isMobile?"tap":"click",n):setTimeout(function(){i!=e.target&&!x.fn.contains(i,e.target)||(a.publish("_dialogOk"),x(".dialog").remove())},50)}x("body").append(i),x("#mask").show(),setTimeout(function(){x("#mask").show()},100),a.unSubscribe(["_dialogOk"]),a.subscribe("_dialogOk",function(){x("body").off(a.isMobile?"tap":"click",n),e.ok&&e.ok(),a.unSubscribe(["_dialogOk"]),x("#mask").hide()}),setTimeout(function(){x("body").on(a.isMobile?"tap":"click",n),x(".dialog").removeClass("dialog-hide")},10)},toShowEntry:function(i,e){x(window).on("resize",function(){var e=_.activeElement;"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||setTimeout(function(){e.scrollIntoViewIfNeeded()},100)});var t=this,a="entry",n=(!0===t.companyOff?i.offlineVisitorInfoConfiguration:i.visitorInfoConfiguration)||[],o=n&&n.length||0,s=1!=i.captChaEnable&&E(n),r=decodeURIComponent(x.store("ECHAT_"+t.companyId+"_ENTRY_HIS")||"{}");r=JSON.parse(r),t.needHttps&&i.visitorInfoBackImg&&(i.visitorInfoBackImg=i.visitorInfoBackImg.replace(/^http:/,t.needHttps));var l,d=t.getFormParam(n);if(d&&d.param&&(r=d.param,window.blur()),x("#entry").html(""),x("#leave").html(""),!0===t.companyOff&&"0"==i.offlineStartType){if(t.leaveAndClose=!0,view.showLeavePage)view.showLeavePage(i);else{var c='<div class="leave-entry-title">{{offlineWelcomeWord}}</div> <div class="leave-entry-content"><form id="entryForm" name="entryForm">{{temp.items}}</form><div class="leave-entry-item leave-entry-one-line leave-content"><div><label class="leave-entry-label" style="vertical-align: top;color:{{offlineVisitorInfoLabelColor}}"> <span class="req-span" style="visibility:visible">*</span><span class="name-span">{{lanRes.leaveWordContent}}</span></label><div class="leave-entry-inputs"><textarea class="leave-entry-text req" autoHeight="true" lb="{{lanRes.leaveWordContent}}" style="border-color:{{offlineVisitorInfoInputColor}};color:{{offlineVisitorInfoInputColor}}">'+(r.leaveContent||"")+"</textarea></div></div></div>{{temp.code}}"+(view.SDK?'<div class="leave-enter-btn bg0" >'+lanRes.submit+"</div>":"")+"</div>",u='<div class="leave-entry-item leave-entry-one-line entry-code"><div><label class="leave-entry-label" style="color:{{offlineVisitorInfoLabelColor}}"> <span class="req-span">*</span><span class="name-span" >{{lanRes.validateCode}}</span></label> <input class="book-ipt" id="verify_input" placeholder="{{lanRes.inputCode}}" style="border-color:{{offlineVisitorInfoInputColor}};color:{{offlineVisitorInfoInputColor}}"/> <img class="img-code" alt="'+lanRes.validateCode+'" id="verify_img" src="'+t.dataHost+"/chatCaptCha.jpg?captChatToken="+e.captChaToken+'"/><span class="color0 cursor-p" id="verify_change">{{lanRes.nextPic}}</span></div></div>';view.SDK&&(u='<div class="leave-entry-item leave-entry-one-line entry-code"><div><label class="leave-entry-label" style="color:{{offlineVisitorInfoLabelColor}}"> <span class="req-span">*</span><span class="name-span" >{{lanRes.validateCode}}</span></label><div class="verify-flex flex"><input class="book-ipt verify-input flex1" id="verify_input" placeholder="{{lanRes.inputCode}}" style="border-color:{{offlineVisitorInfoInputColor}};color:{{offlineVisitorInfoInputColor}}"/><div class="verify-imgs"> <img class="img-code" alt="'+lanRes.validateCode+'" id="verify_img" src="'+t.dataHost+"/chatCaptCha.jpg?captChatToken="+e.captChaToken+'"/><span class="verify-change" id="verify_change"></span></div></div></div>');for(var f=[],m=0,h=0;h<o;h++){var p=1==(T=n[h]).configRequired?" req ":"";if("1"==T.configWebVipVisitor&&t.isVip||"1"==T.configWebVisitor&&!t.isVip){var g='<div class="leave-entry-item leave-entry-half {{item.online}} {{item.req}}"><div><label class="leave-entry-label" style="color:{{offlineVisitorInfoLabelColor}}"><span class="req-span">*</span><span class="name-span">{{item.configDesc}}</span></label><div class="leave-entry-inputs">',v=r[C=T.configName],b=window.ltIE10?"text":"birthday"==C?"date":"age"==C?"number":"text";if("gender"!=C&&"maritalStatus"!=C||(g=g.replace("leave-entry-item","leave-entry-item leave-entry-opts")),g=g+("gender"==C?'<label class="input-radio-lb" style="color:{{offlineVisitorInfoLabelColor}}"><input type="radio" class="book-radio {{item.req}}" name="gender" value="1" '+(1==v?'checked="checked"':"")+' lb="{{item.configDesc}}"/><span class="radio-span">{{lanRes.male}}</span></label><label class="input-radio-lb" style="color:{{offlineVisitorInfoLabelColor}}"><input type="radio" class="book-radio '+p+'" name="gender" value="2" '+(2==v?'checked="checked"':"")+' lb="{{item.configDesc}}"/><span class="radio-span">{{lanRes.female}}</span></label>':"maritalStatus"==C?'<label class="input-radio-lb" style="color:{{offlineVisitorInfoLabelColor}}"><input type="radio" class="book-radio {{item.req}}" name="maritalStatus" value="1" '+(1==v?'checked="checked"':"")+' lb="{{item.configDesc}}"/><span class="radio-span">{{lanRes.unmarried}}</span></label><label class="input-radio-lb" style="color:{{offlineVisitorInfoLabelColor}}"><input type="radio" class="book-radio {{item.req}}" name="maritalStatus" value="2" '+(2==v?'checked="checked"':"")+' lb="{{item.configDesc}}"/><span class="radio-span">{{lanRes.married}}</span></label>':'<input type="'+b+'" name="{{item.configName}}" value="'+(v||"")+'" lb="{{item.configDesc}}" class="leave-entry-ipt {{item.req}}" style="border-color:{{offlineVisitorInfoInputColor}};color:{{offlineVisitorInfoInputColor}}"/>')+"</div></div></div>",1==T.configInline)g=g.replace("{{item.online}}","leave-entry-one-line");else{var y=n[h-1]||{};g=0==h||1==y.configInline||1!=T.configInline&&1!=y.halfLineLead?(T.halfLineLead=1,g.replace("{{item.online}}","leave-entry-halflead")):g.replace("{{item.online}}","")}g=g.replace(/\{\{item\.req\}\}/g,1==T.configRequired?"req":"").replace(/\{\{item\.([a-zA-Z]+)}\}/g,function(e,t){return T[t]||""}),f.push(g)}else n[h].disabled=!0}c=c.replace("{{temp.code}}",1==i.captChaEnable?u:"").replace("{{temp.items}}",0<f.length?f.join(""):"").replace(/\{\{([a-zA-Z]+)}\}/g,function(e,t){return i[t]||""}).replace(/\{\{lanRes\.([a-zA-Z]+)}\}/g,function(e,t){return lanRes[t]||""}),x(".verify-change").attr("id",""),x(".verify-img").attr("id",""),x(".verify-ok").attr("id",""),x(".verify-input").attr("id",""),x("#leave").html(c).removeClass("hide"),t.publish("removeLoading"),t.isMobile||1!=view.windowType||view.dji?x("#container").addClass("hide"):(x("#chat").addClass("hide"),x(".btn-close").addClass("hide"),setTimeout(function(){x(".btn-close").addClass("hide")},100)),x(".leave-entry-foot").removeClass("hide"),x("#container_leave").removeClass("hide"),x("html").addClass("page-leave"),x("#footer").addClass("hide"),view.SDK&&i.offlineVisitorInfoBackgroundColor&&x(".leave-entry-title").css("background",i.offlineVisitorInfoBackgroundColor),setTimeout(function(){x("#mask").hide()},100),view.toLeaveMessage&&view.toLeaveMessage(i),1==i.captChaEnable&&t.toShowCode(),t.addEntryEvent(n,i,".leave-enter-btn"),x.fn.autoHeight=function(){function e(e){e.style.height="auto",e.style.height=e.scrollHeight+"px"}this.each(function(){e(this),x(this).on("keyup",function(){e(this)})})},x("textarea[autoHeight]").autoHeight()}return!0}i=x.extend({},i),!0===t.companyOff&&(i.welcomeWord=i.offlineWelcomeWord,i.welcomeWordPos=i.offlineWelcomeWordPos,i.entryCanClose=i.offlineEntryCanClose,i.visitorInfoCloseImg=i.offlineVisitorInfoCloseImg,i.visitorInfoClosePos=i.offlineVisitorInfoClosePos,i.visitorInfoFormPos=i.offlineVisitorInfoFormPos,i.visitorInfoBackImg=i.offlineVisitorInfoBackImg,i.visitorInfoLabelColor=i.offlineVisitorInfoLabelColor,i.visitorInfoInputColor=i.offlineVisitorInfoInputColor,i.visitorInfoSubmitPos=i.offlineVisitorInfoSubmitPos,i.visitorInfoSubmitTxt=i.offlineVisitorInfoSubmitTxt,i.buttonBackgroundColor=i.offlineButtonBackgroundColor,i.visitorInfoBackgroundColor=i.offlineVisitorInfoBackgroundColor,i.visitorInfoSubmitImg=i.offlineVisitorInfoSubmitImg),t.needHttps&&(i.visitorInfoCloseImg&&(i.visitorInfoCloseImg=i.visitorInfoCloseImg.replace(/^http:/,t.needHttps)),i.visitorInfoBackImg&&(i.visitorInfoBackImg=i.visitorInfoBackImg.replace(/^http:/,t.needHttps)),i.visitorInfoSubmitImg&&(i.visitorInfoSubmitImg=i.visitorInfoSubmitImg.replace(/^http:/,t.needHttps))),view.staticPx2rem&&(i.welcomeWordPos=i.welcomeWordPos&&view.staticPx2rem(i.welcomeWordPos),i.visitorInfoClosePos=i.visitorInfoClosePos&&view.staticPx2rem(i.visitorInfoClosePos),i.visitorInfoFormPos=i.visitorInfoFormPos&&view.staticPx2rem(i.visitorInfoFormPos),i.visitorInfoSubmitPos=i.visitorInfoSubmitPos&&view.staticPx2rem(i.visitorInfoSubmitPos)),l=view.SDK?'<div id="entryWrap" ><form id="entryForm" name="entryForm" class="book-items" ><div class="book-form-title" style="background-color'+i.visitorInfoBackgroundColor+'">'+(i.welcomeWord||"")+'</div> <div class="clearfix book-items-list"><div class="book-items-scroller">':' <div id="entryWrap" class="'+("1"==s?"book-all-line ":"")+'" >'+(1==i.entryCanClose&&i.visitorInfoCloseImg?'<div id="cancelEntryBtn" style="'+i.visitorInfoClosePos+'"><img src="'+i.visitorInfoCloseImg+'" onload="imgLoadResizeSelf(this)" /></div>':"")+(i.visitorInfoBackImg?'<div><img id="entryWrapImg" class="book-table-img hide" src="'+i.visitorInfoBackImg+'" onload="imgLoadResize(this,-1)" /></div>':"")+'<form id="entryForm" name="entryForm" class="book-items" ><div class="book-form-title" style="'+i.welcomeWordPos+'">'+(i.welcomeWord||"")+'</div> <div class="clearfix book-items-list" style="'+i.visitorInfoFormPos+';">';var w=0,I=0,k=(m=0,'&nbsp;&nbsp;<input type="radio" class="book-radio {{cls}}" lb="{{lb}}" name="');i.visitorInfoInputColor;view.SDK&&(k='<label class="input-radio-lb"><input type="radio" class="book-radio {{cls}}" lb="{{lb}}" name="');for(h=0;h<o;h++){var T;p=1==(T=n[h]).configRequired?" req ":"";if("1"==T.configInline?w=parseInt(w+1.5):w+=.5,"1"==T.configWebVipVisitor&&t.isVip||"1"==T.configWebVisitor&&!t.isVip){"1"==T.configInline?I=parseInt(I+1.5):I+=.5,0;var C;v=r[C=T.configName],b=window.ltIE10?"text":"birthday"==C?"date":"age"==C?"number":"text","gender"!=C&&"maritalStatus"!=C||k.replace("{{cls}}",p).replace("{{lb}}",T.configDesc);l+='<div class="book-half book-item'+p+("1"==T.configInline?" book-one-line":"")+("gender"==C||"maritalStatus"==C?" book-item-opts":"")+'"><label class="book-label" style="color:'+i.visitorInfoLabelColor+'"><span class="req-span color0">*</span><span class="name-span">'+T.configDesc+"</span></label>"+("gender"==C?'<label class="input-radio-lb" style="color:'+i.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+p+'" name="gender" value="1" '+(1==v?'checked="checked"':"")+' lb="'+T.configDesc+'"/><span class="radio-span">'+lanRes.male+'</span></label><label class="input-radio-lb" style="color:'+i.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+p+'" name="gender" value="2" '+(2==v?'checked="checked"':"")+' lb="'+T.configDesc+'" /><span class="radio-span">'+lanRes.female+"</span></label>":"maritalStatus"==C?'<label class="input-radio-lb" style="color:'+i.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+p+'" name="maritalStatus" value="1" '+(1==v?'checked="checked"':"")+' lb="'+T.configDesc+'"/><span class="radio-span">'+lanRes.unmarried+'</span></label><label class="input-radio-lb" style="color:'+i.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+p+'" name="maritalStatus" value="2" '+(2==v?'checked="checked"':"")+' lb="'+T.configDesc+'"/><span class="radio-span">'+lanRes.married+"</span></label>":'<input type="'+b+'" lb="'+T.configDesc+'" class="book-ipt '+p+'" name="'+C+'" value="'+(v||"")+'" style="'+(view.SDK?"border-color:":"border-bottom-color:")+i.visitorInfoInputColor+";color:"+i.visitorInfoInputColor+';"/>')+"</div>"}else n[h].disabled=!0,m++}if(1==i.captChaEnable&&(view.SDK?l+='<div class="book-item req" id="verifyInner"><label class="book-label" style="color:'+i.visitorInfoLabelColor+'"><span class="req-span color0">*</span><span class="name-span">'+lanRes.validateCode+'</span></label><div class="verify-flex flex"><input type="text" id="verify_input" class="book-ipt verify-input flex1 req" lb="'+lanRes.validateCode+'" style="border-color:'+i.visitorInfoInputColor+'"/><div class="verify-imgs"><img alt="'+lanRes.validateCode+'" id="verify_img" src="'+t.dataHost+"/chatCaptCha.jpg?captChatToken="+e.captChaToken+'"/><span class="verify-change" id="verify_change"></span></div></div></div>':l+='<div class="clearfix"><div class="book-half book-item req" id="verifyInner"><label class="book-label" style="color:'+i.visitorInfoLabelColor+'"><span class="req-span color0">*</span><span class="name-span">'+lanRes.validateCode+'</span></label><input type="text" id="verify_input" class="book-ipt req" lb="'+lanRes.validateCode+'" style="border-color:'+i.visitorInfoInputColor+'"/></div><div class="book-half book-item verify-line"><img alt="'+lanRes.validateCode+'" id="verify_img" src="'+t.dataHost+"/chatCaptCha.jpg?captChatToken="+e.captChaToken+'"/><span class="color0 cursor-p" id="verify_change">'+lanRes.nextPic+"</span></div></div>",x(".verify-change").attr("id",""),x(".verify-img").attr("id",""),x(".verify-ok").attr("id",""),x(".verify-input").attr("id","")),view.SDK?l+='<div id="submitBtnentry" class="book-btn bg0" style="background:'+i.buttonBackgroundColor+'">'+(i.visitorInfoSubmitTxt||lanRes.submit)+"</div></div></div>":(l+="</div>",l+='<div id="submitBtnentry" style="'+i.visitorInfoSubmitPos+'" class="book-btn"> <span class="book-btn-text">'+(i.visitorInfoSubmitTxt||"")+"</span></div>"),l+="</form></div>",x("#entry").html(l).show(),view.SDK&&i.visitorInfoBackgroundColor&&x(".book-form-title").css("background",i.visitorInfoBackgroundColor),view.handleShowEntry&&view.handleShowEntry(!1),1==view.windowType&&(w=parseInt(w+.5),I=parseInt(I+.5),m=w-I),0<m&&!view.SDK&&setTimeout(function(){x(".book-items-list").css("paddingBottom",view.px2rem?view.px2rem(30*m):30*m+"px")},10),t.publish("removeLoading"),1==i.captChaEnable&&t.toShowCode(),x("#mask").show(),x("body").addClass("entry"),i.visitorInfoSubmitImg&&!view.SDK){t.needHttps&&(i.visitorInfoSubmitImg=i.visitorInfoSubmitImg.replace(/^http:/,t.needHttps));var S=new Image;S.onload=function(){var e=_$("submitBtn"+a).style;e.backgroundImage="url('"+i.visitorInfoSubmitImg+"')",e.backgroundSize=(view.px2rem?view.px2rem(this.width):this.width+"px")+" "+(view.px2rem?view.px2rem(this.height):this.height+"px"),e.lineHeight=view.px2rem?view.px2rem(this.height):this.height+"px",e.height=view.px2rem?view.px2rem(this.height):this.height+"px",e.width=view.px2rem?view.px2rem(this.width):this.width+"px",S=e=null},S.src=i.visitorInfoSubmitImg}return x("#cancelEntryBtn").on("click",function(e){t.visitorClose=!1,t.publish("_endChat"),t.publish("chatEnded",{}),!t.hasEntryOrCode&&"0"!=t.queryParams.autoChat||(t.publish("entryCallback",{success:!0}),t.publish("_endConnect")),delete t.queryParams.autoPop,delete t.queryParams.autoChat}),t.addEntryEvent(n,i,"#submitBtn"+a),t.isMobile,view.SDK||setTimeout(function(){var e=_$("entryForm").offsetHeight+(view.px2px?view.px2px(20):20)+_$("entryForm").offsetTop;_$("entry").style.minHeight=e+"px"},100),!0},getFormParam:function(e,t){if(!e||!_$("entryForm"))return!1;for(var i,a,n=_$("entryForm"),o={windowType:view.windowType},s="",r=!0,l=0,d=e.length;l<d;l++){a=null,i="";var c=e[l].configName;if(!e[l].disabled){var u=n[c];if(u){if(!u.value&&1<u.length&&u[0])for(var f=0;f<u.length;f++)u[f].checked&&(a=u[f].value,i=x(u[f]).attr("lb"));if(a=(a=a||u.value)&&a.replace(/^[\s]+|[\s]+$/gi,""),t&&!(r=v(u,a,c,function(e){u.nodeType&&(e?x(u).removeClass("error"):x(u).addClass("error"))})&&r))return!1;a&&r&&(i=i||x(u.length?u[0]:u).attr("lb"),s+="gender"==c?i+" "+(1==a?lanRes.male:lanRes.female)+"\r\n ":"maritalStatus"==c?i+" "+(1==a?lanRes.unmarried:lanRes.married)+"\r\n ":i+" "+a+"\r\n "),o[c]=a}}}var m=x(".leave-entry-text").results[0];return m&&(o.leaveContent=m.value),{param:o,visitorMsg:s}},addEntryEvent:function(s,r,e,l){var d=this;x("input",_$("entryForm")).bind("blur",function(){var e=this.name,t=this.value.replace(/^[\s]+|[\s]+$/gi,"");v(this,t,e,function(e){})});var c=!1;function t(e){if(c)return!1;if(view.handleNetwok&&view.handleNetwok())return!1;var t=d.getFormParam(s,!0);if(!1===t)return t;var i=t.param,a=t.visitorMsg;if(i.leaveContent=void 0,d.leaveAndClose){var n=x(".leave-entry-text").results[0];if(v(n,n.value,"content",function(e){n.nodeType&&(e?x(n).removeClass("error"):x(n).addClass("error"))}),!n.value)return!1}if(1==r.captChaEnable){if(x("#verify_change").hasClass("loadin"))return!1;var o=x("#verify_input").val();if(!o)return x("#verify_input").addClass("error"),!1;x("#verify_change").addClass("loadin"),i.captcha=o}return i.et=106,"1"==d.queryParams.autoPop&&(i.isAutoPop=1),c=!0,d.entryParam=i,d.entryVisitorMsg=a,d.publish("visitorCommonEvent",i,function(e){e&&e.successful&&l&&l(),1==r.captChaEnable&&x("#verify_change").removeClass("loadin"),c=!1}),!1}_$("entryForm").onsubmit=t,x(e).off("click").on("click",t)},toShowCode:function(){var i=this;function e(){if(!x("#verify_change").hasClass("loadin")){x("#verify_change").addClass("loadin");var e={et:122,windowType:view.windowType,content:"refresh code"};"1"==i.queryParams.autoPop&&(e.isAutoPop=1),i.publish("visitorCommonEvent",e)}}this.codeShowed&&(x("#verify_change").removeClass("loadin"),x("#verify_input").removeClass("error").val("")),this.codeShowed=!0,x("#verify_img").off("click").bind("click",e),x("#verify_change").off("click").bind("click",e),x("#verify_input").off("click").bind("keydown",function(){x("#verify_input").removeClass("error")}),x("#verify_ok").off("click").bind("click",function(){if(!x("#verify_change").hasClass("loadin")){var e=x("#verify_input").val();if(e){x("#verify_change").addClass("loadin");var t={et:106,captcha:e,windowType:view.windowType};"1"==i.queryParams.autoPop&&(t.isAutoPop=1),i.publish("visitorCommonEvent",t,function(){})}else x("#verify_input").addClass("error")}})},toShowQcode:function(){var a=this;function i(e){if(x("#qcode_loading").show(),x("#qcode_img").attr("loaded","loaded").hide(),e){var t=(a.dataHost||"")+"/cqr?"+(a.needHttps?"ssl=1&":"")+"chatToken="+e,i=new Image;i.onload=function(){x("#qcode_loading").hide(),x("#qcode_img").attr({loaded:"loaded",src:t}).show(),setTimeout(function(){x("#qcode_img").removeAttr("loaded"),a.publish("_toGetChatToken")},54e4)},i.onerror=function(e){x("#qcode_img").removeAttr("loaded")},i.src=t}else a.publish("_toGetChatToken")}return view.qcodeWechat||(a.subscribe("getChatToken",function(e,t){i(t.chatToken)}),a.subscribe("_toGetChatToken",function(){a.publish("visitorCommonEvent",{et:120,companyId:a.companyId})})),view.toggleQcode&&view.toggleQcode(i),!0},toInitEvaluate:function(e){var t,i,l=this,d=!1,a=e.evaluateInfo||e.smallEvaluateInfo||e.mobileEvaluateInfo||e.sdkEvaluateInfo||l.msg649&&(l.msg649.evaluateInfo||e.smallEvaluateInfo||l.msg649.mobileEvaluateInfo||l.msg649.sdkEvaluateInfo);if(!a)return l.satisfyEnable=!1,void this.toggleEvaluateMenu(1);if(0==a.enable?(l.satisfyEnable=!1,this.toggleEvaluateMenu(6)):(this.toggleEvaluateMenu(5),l.satisfyEnable=!0,1==a.enableVisitorEvaluateLimit&&0<parseInt(a.allowEvaluateBaseWords)&&(l.allowEvaluateBaseWords=parseInt(a.allowEvaluateBaseWords),l.sendMsgNum<l.allowEvaluateBaseWords?this.toggleEvaluateMenu(3):this.toggleEvaluateMenu(4))),!this.hasInitEvaluate){l.hasInitEvaluate=!0,(i=(t=m=1==a.evaluateType)?1==a.bestEnable?5:1==a.betterEnable?4:1==a.commonEnable?3:1==a.worseEnable?2:1==a.worstEnable&&1:5)||(i=5,d=!0),x("#satisfy_ipt").val(i);var n='<div class="sa-title tc"><div class="sa-title-left"></div><div class="sa-title-content"><span langs="evaluateTip">'+lanRes.evaluateTip+'</span><span class="sa-name sa-name5 emcolor">'+a.bestDesc+'</span><span class="sa-name sa-name4 emcolor">'+a.betterDesc+'</span><span class="sa-name sa-name3 emcolor">'+a.commonDesc+'</span><span class="sa-name sa-name2 emcolor">'+a.worseDesc+'</span><span class="sa-name sa-name1 emcolor">'+a.worstDesc+'</span></div><div class="sa-title-right"></div></div>';if(t&&!d?(n+='<ul class="sa-imgs clearfix">',1==a.worstEnable&&(n+='<li class="sa-img sa-img1" v="1"><img class="sa-s-img" v="1" src="'+a.worstSelected.replace(/^http:/,l.needHttps||"http:")+'"/><img class="sa-un-img" v="1" src="'+a.worstUnSelected.replace(/^http:/,l.needHttps||"http:")+'"/></li>'),1==a.worseEnable&&(n+='<li class="sa-img sa-img2" v="2"><img class="sa-s-img" v="2" src="'+a.worseSelected.replace(/^http:/,l.needHttps||"http:")+'"/><img class="sa-un-img" v="2" src="'+a.worseUnSelected.replace(/^http:/,l.needHttps||"http:")+'"/></li>'),1==a.commonEnable&&(n+='<li class="sa-img sa-img3" v="3"><img class="sa-s-img" v="3" src="'+a.commonSelected.replace(/^http:/,l.needHttps||"http:")+'"/><img class="sa-un-img" v="3" src="'+a.commonUnSelected.replace(/^http:/,l.needHttps||"http:")+'"/></li>'),1==a.betterEnable&&(n+='<li class="sa-img sa-img4" v="4"><img class="sa-s-img" v="4" src="'+a.betterSelected.replace(/^http:/,l.needHttps||"http:")+'"/><img class="sa-un-img" v="4" src="'+a.betterUnSelected.replace(/^http:/,l.needHttps||"http:")+'"/></li>'),1==a.bestEnable&&(n+='<li class="sa-img sa-img5 sa-sli5" v="5"><img class="sa-s-img" v="5" src="'+a.bestSelected.replace(/^http:/,l.needHttps||"http:")+'"/><img class="sa-un-img" v="5" src="'+a.bestUnSelected.replace(/^http:/,l.needHttps||"http:")+'"/></li>'),n+="</ul>"):n+='<ul class="sa-stars clearfix"><li class="sa-sli sa-star emcolor" v="1">&#xe64d;</li><li class="sa-sli sa-star emcolor" v="2">&#xe64d;</li><li class="sa-sli sa-star emcolor" v="3">&#xe64d;</li><li class="sa-sli sa-star emcolor" v="4">&#xe64d;</li><li class="sa-sli sa-star emcolor sa-sli5" v="5">&#xe64d;</li></ul>',!t||!d){n+='<div class="sub-tabs clearfix " >',view.SDK&&(n+="<div>");for(var o=["worstConfiguration","worseConfiguration","commonConfiguration","betterConfiguration","bestConfiguration"],s=5;0<s;s--){var r=a[o[s-1]]||[],c=r.length;n+='<ul class="sub-tab sub-tab'+s+'" '+(0<c?"":'style="display:none"')+' id="subEvaluate'+s+'"> ';for(var u=0;u<c;u++){var f=r[u];n+='<li class="sa-cli" dataname="'+f.configName+'">'+f.configDesc+"</li>"}n+="</ul>"}view.SDK&&(n+="</div>"),n+="</div>"}x("#satisfyConfig").html(n).addClass("sa-sel-"+i),view.handleSatisfy&&view.handleSatisfy(d,t,i),x("#sa_ok").on(l.isMobile?"touchend":"click",function(e){if(view.handleNetwok&&view.handleNetwok())return!1;x.store("ECHAT_inviteSatisfyHandle",x.store("ECHAT_inviteSatisfyId")),l.isMobile&&e.preventDefault();var i=x("#sa_advise").val(),a=x("#satisfy_ipt").val(),t="";if("0"!=a&&a){if(!d){var n=x(".sa-cli",_$("subEvaluate"+a)).results||[],o=n.length;if(0<o)for(var s=0;s<o;s++)t+="&"+[x(n[s]).attr("dataname")]+"="+(x(n[s]).hasClass("sub-selected")?1:0)}var r=l.dataHost+"/ces?companyId="+l.companyId+"&talkId="+l.talkId+"&visitorId="+encodeURIComponent(l.visitorId||"")+(view.SDK?"&appId="+encodeURIComponent(l.appId||""):"")+"&nonce="+encodeURIComponent(l.restartParam.nonce||"")+"&reChatTag="+encodeURIComponent(l.restartParam.reChatTag||"")+"&mainItem="+a+"&evaluateType="+l.satisfyType+"&media="+l.Device.media+"&windowType="+view.windowType+"&lan="+(window.lanName||"")+"&comment="+encodeURIComponent(i||"")+t;console.log("url***",r),x.ajax({url:r,type:"jsonp",jsonpCB:"jsonpCallback",success:function(e){if(console.log(e),l.satisfyShowed=l.talkId,1==e)l.evaluateScore=a,h(lanRes.successSubmitEval,"ok"),view.resetSatisfy&&view.resetSatisfy(),!1===l.chatting?(l.publish("_closeWin"),l.publish("__evaluate","1-2")):l.publish("__evaluate","1-1"),i&&l.publish("__evaluateComment",{comment:i,chatting:l.chatting});else{var t=lanRes.unkownErrorSubmitEval;129==e?t=lanRes.evaluateTimeout:130==e?t=lanRes.evaluateRepeat:133==e&&(t=lanRes.evaluateRepeatTime),h(t)}},error:function(){h(lanRes.unkownErrorSubmitEval)}}),x("#satisfy").removeClass("satisfy-show").hide(),x("#mask").off("click",l.hideSatisfy),x("#mask").hide(),_$("sa_advise").blur(),view.hideSatisfy&&view.hideSatisfy()}}),x("#sa_cancel").on(l.isMobile?"touchend":"click",function(e){l.hideSatisfy(),l.isMobile&&e.preventDefault()})}},toggleEvaluateMenu:function(e){if(view.decideEvalMenu)return view.decideEvalMenu(e%2);var t=x(".menu-satisfy"),i="show",a="hide",n="limit-hide";1==e?t.addClass(a).removeClass(i):2==e?t.removeClass(a):3==e?t.addClass(n):4==e?t.removeClass(n).removeClass(a):5==e?t.addClass(i).removeClass(a):6==e&&t.hide(),this.hasWaitingStatus&&t.addClass(a).removeClass(i)},staffMap:{},handleStaffMap:function(e,t){var i,a=this,n={};if(e&&0<e.length)for(var o=0;o<e.length;o++)e[o].staffHead&&a.needHttps&&(e[o].staffHead=e[o].staffHead.replace(/^http:/,a.needHttps)),n[e[o].staffId+""]={staffId:e[o].staffId,staffName:e[o].staffNickName||lanRes.serviceStaff,staffImg:e[o].staffHead||a.defaultStaffImg},i=i||n[e[o].staffId+""];a.staffMap=t?x.extend(n,a.staffMap):x.extend(a.staffMap,n)},updateStaffInfo:function(e,t){if(t&&t.staffId){var i={};return i[t.staffId]={staffId:t.staffId,staffName:t.staffNickName||lanRes.serviceStaff,staffImg:t.staffHead||t.staffDetailInfo&&t.staffDetailInfo.staffHead||this.defaultStaffImg},x.extend(this.staffMap,i),i[t.staffId]}},startChat:function(e,t){var g=this;g.hasWaitingStatus=!1,g.companyOff=!1,"679"!=t.mt&&"686"!=t.mt&&t.talkId&&!0===this.chatting&&this.staffId!=t.staffId&&this.talkId==t.talkId&&this.publish("getSysMsg",{talkId:t.talkId,tm:t.tm,mt:"10001",staffId:t.staffId,staffName:t.staffNickName},t),t.staffDetailInfo&&x.cookie("ECHAT_"+window.companyId+"_"+window.chatVisitorId+"_staffHead",t.staffDetailInfo.staffHead||"",{path:"/"}),x.cookie("ECHAT_"+g.companyId+"_"+window.chatVisitorId+"_chatStatus",2,{path:"/"}),this.satisfyShowed!=t.talkId&&(this.satisfyShowed=0),g.talkId&&g.talkId!=t.talkId&&(g.lastTalkIdForTemp=g.talkId),this.chatting=!0,t.talkId&&(this.talkId=t.talkId),"679"!=t.mt&&(this.staffId=t.staffId,this.staffName=t.staffNickName),this.paramChat.talkId=this.talkId,this.paramChat.staffId=this.staffId,this.paramChat.staffName=this.staffName,g.publish("__chatStatus","chatting"),g.initQcode(),delete g.queryParams.autoPop,delete g.queryParams.autoChat,x("#busyTipLine").addClass("hide").hide(),1==t.startType&&g.publish("__chatStart",t.staffNickName),g.lastTalkIdForTemp&&(g.lastTalkIdForTemp!=g.talkId&&g.handleSessionMsg({talkId:g.lastTalkIdForTemp}),g.lastTalkIdForTemp=void 0),t.staffDetailInfo&&g.publish("staffInfo",t),x(".menu-capture").removeClass("hide"),x(".menu-file").removeClass("hide"),this.publish("entryCallback",{success:!0}),this.endChatEvent(),g.lastText=null,g.typingTimer=setTimeout(function e(){var t=g.getInput(!1),i=t;(t=t.replace(/^[\n\r\s]+$/,""))&&g.lastText!=t&&(g.lastText=t,g.plainText&&(i=g.plainTextToSendMsg(t)),g.publish("sendVisitorEvent",{et:104,content:i})),g.typingTimer=setTimeout(e,2e3)},2e3),this.subscribe("getMsgTyping",function(e,t){g.showTyping()}),this.subscribe("staffStatus",function(e,t){if(1!=t.status){g.publish("_staffEndChat",t);var i=new Date;this.showMsg({f:"s",t:g.checkHistoryTime(i.getTime())?i.format("hh:mm"):void 0},lanRes.staffLeaveEnd)}}),this.subscribe("inviteBook",function(e,t){var i,a=t.templateInfoList;0==(i=1==view.windowType&&(0==a[0].type||1==a[0].type)||1!=view.windowType&&(2==a[0].type||3==a[0].type)?a[0]:a[1]).type||2==i.type?g._getMsg({mt:t.mt,tm:t.tm,notEnd:t.notEnd,content:g.showInfoTip({f:"sys",tip:"客服给您发送了一个预约表。"},void 0,void 0,!0,t.talkId,t.tm,t.notEnd)},4,function(t,e,i){var d=t.groupId,c=g.bookformi++,u=t.configuration,f=u.length,a=1!=t.captChaEnable&&E(u);g.needHttps&&t.backImg&&(t.backImg=t.backImg.replace(/^http:/,g.needHttps));for(var n=' <div id="inviteBook'+c+'" class="book-table '+("1"==a?"book-all-line":"")+'" >'+(t.backImg?'<div><img id="inviteBookImg'+c+'" class="book-table-img hide" src="'+t.backImg+'" onload="imgLoadResize(this,'+c+')"/></div>':"")+'<form id="inviteBookForm'+c+'" class="book-items"> <div class="clearfix book-items-list" style="'+t.formPos+';">',o=0;o<f;o++){var s=u[o],r=1==s.configRequired?"req":"",l=window.ltIE10?"text":"birthday"==s.configName?"date":"age"==s.configName?"number":"text";n+='<div class="book-half book-item '+("1"==s.configInline?"book-one-line":"")+'"><label class="book-label" style="color:'+t.labelColor+'">'+s.configDesc+"</label>"+("gender"==s.configName?'&nbsp;&nbsp;<input type="radio" class="book-radio '+r+'" name="gender" value="1" lb="'+s.configDesc+'"/><span style="color:'+t.inputColor+';">'+lanRes.male+'</span> <input type="radio" class="book-radio '+r+'" name="gender" value="2" /><span style="color:'+t.inputColor+';">'+lanRes.female+"</span>":"maritalStatus"==s.configName?'&nbsp;&nbsp;<input type="radio" class="book-radio '+r+'" name="maritalStatus" value="1" lb="'+s.configDesc+'"/><span  style="color:'+t.inputColor+';">'+lanRes.unmarried+'</span><input type="radio" class="book-radio '+r+'" name="maritalStatus" value="2" /><span  style="color:'+t.inputColor+';">'+lanRes.married+"</span>":'<input type="'+l+'" lb="'+s.configDesc+'" class="book-ipt '+r+'" name="'+s.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"/>')+"</div>"}if(n+="</div>",n+='<div id="submitBtn'+c+'" style="'+t.submitPos+'" class="book-btn"> <span class="book-btn-text">'+(t.submitTxt||"")+"</span></div>",n+="</form></div>",x(g.getListMsgEl(e,i)).append('<li id="inviteBookLi'+c+'" class="clearfix book-wrap">'+n+"</li>"),t.submitImg){var m=new Image;g.needHttps&&(t.submitImg=t.submitImg.replace(/^http:/,g.needHttps)),m.onload=function(){var e=_$("submitBtn"+c).style;e.backgroundImage="url('"+t.submitImg+"')",e.lineHeight=view.px2rem?view.px2rem(this.height):this.height+"px",e.height=view.px2rem?view.px2rem(this.height):this.height+"px",e.width=view.px2rem?view.px2rem(this.width):this.width+"px",t=m=e=null},t.submitImg&&(m.src=t.submitImg)}x("input",_$("inviteBook"+c)).bind("blur",function(){var e=this.name,t=this.value.replace(/^[\s]+|[\s]+$/gi,"");v(this,t,e,function(e){})});var h=0;function p(e){if(h)return!1;for(var t,i=_$("inviteBookForm"+c),a="companyId="+g.companyId+"&visitorId="+g.visitorId+"&groupId="+d+"&p="+encodeURIComponent(g.encryptVID),n=!0,o=0;o<f;o++){t=null;var s=u[o].configName,r=i[s];if(!r.value&&1<r.length&&r[0])for(var l=0;l<r.length;l++)r[l].checked&&(t=r[l].value);if(!(n=v(r,t=(t=t||r.value).replace(/^[\s]+|[\s]+$/gi,""),s,function(e){})&&n))return!1;a+="&"+s+"="+t}return n&&(h=1,x.ajax({url:g.dataHost+"/cvi?"+a,type:"jsonp",jsonpCB:"jsonpCallback",success:function(e){h=0,1==e?x(".book-wrap").remove():g.showInfoTip(lanRes.unkownErrorSubmit,void 0,"warn")},error:function(){h=0,g.showInfoTip(lanRes.unkownErrorSubmit,void 0,"warn")}})),!1}x("#submitBtn"+c).bind(g.isMobile?"tap":"click",p),_$("inviteBookForm"+c).onsubmit=p,g.isMobile,setTimeout(function(){var e=_$("inviteBookForm"+c).offsetHeight+(view.px2px?view.px2px(20):20)+_$("inviteBookForm"+c).offsetTop;_$("inviteBookLi"+c).style.minHeight=e+"px",view.scrollToBottom()},100)}(i,t.talkId,t.tm),"x"):g._getMsg({mt:t.mt,tm:t.tm,content:a},3,g.getBookComfirm(a),"x")}),this.subscribe("inviteBookOK",function(e,t){if(console.log("不应发送892 inviteBookOK "),1==t.success){if(x("#entry").hide(),x("#verify").hide(),x("#mask").hide(),g.hasEntryOrCode=!1,t.mt){var i=g.entryParam;if(i){delete i.et,delete i.captcha;var a=x.store("ECHAT_"+g.companyId+"_ENTRY_HIS");a=a?JSON.parse(a):{},i=x.extend(a,i),x.store("ECHAT_"+g.companyId+"_ENTRY_HIS",JSON.stringify(i))}}}else g.publish("refreshVerify",{status:1});x(".book-wrap").remove(),g.showInfoTip({f:"sys",tip:lanRes.submitInfoSucc})})},getADURL:function(e,t,i,a,n,o){if(!i)return"";if(!e||"0"==e||!t)return i;a=a||this.paramChat;var s="",r="",l="",d=i.split("#"),c=d[1]||"",u=d[0],f=-1==u.indexOf("?")?0:1,m="?";"string"==typeof t&&(t=JSON.parse(t));var h,p,g,v,b,y=["companyId","visitorId","echatTag","lan","country","province","city","searcher","keyword","metaData","referrer","firstUrl","chatPage","chatPageTitle","eventId","osName","staffId","staffName","staffPhoto","talkId","staffPhone","staffInfo"];if(view.chat.isArray(t)&&t.length){for(h=t.length,g=0;g<y.length&&("staffId"==(v=y[g])&&(r=s,s="",n&&(m="",f=c?1:0)),"staffId"!=v||a.staffId);g++)for(p=0;p<h;p++)if("metaData"!=(b=t[p].paramName)&&"metadata"!=b||(b="metaData"),b==v){"metaData"==b?(s+=(0!=f?"&":m)+b+"="+encodeURIComponent(a[b]||""),s+=(0!=++f?"&":m)+(b="myData")+"="+encodeURIComponent(a[b]||""),f++,a[b="info"]&&(s+=(0!=f?"&":m)+b+"="+encodeURIComponent(a[b]||""),f++)):(s+="staffId"==b?(0!=f?"&":m)+b+"="+("-1"==encodeURIComponent(a[b]||"")?"":encodeURIComponent(a[b]||"")):(0!=f?"&":m)+b+"="+encodeURIComponent(a[b]||""),f++);break}y.length==g&&(l=s,s="")}return n?u+r+(c?"#"+c+l:"#"+l):u+r+l+(c?"#"+c:"")},setInnerAD:function(n){if(n.data){var e,t,i,a,o=n.data,s=this,r=o.chatBoxAdHeight;r=r?parseInt(r):0,x(".innerAD").each(function(){x("#list_msg").contains(this)||x(this).remove()}),x("#innerADWrap").addClass("hide"),2==o.chatBoxInnerAdType?(e=o.chatBoxInnerAdContent)&&(t='<li class="clearfix innerAD innerAD-text"><div>'+e+"</div></li>"):3==o.chatBoxInnerAdType&&r?((e=o.chatBoxInnerAdImg)&&view.chat.needHttps&&(e=e.replace(/^http:/,view.chat.needHttps)),s.lastLoadInnerImgName=a=(new Date).getTime(),window["resetInnerAdHeight"+a]=function(e,t,i){if(i==view.chat.lastLoadInnerImgName){var a=(e<t?e:t)+20;1==o.chatBoxAdImgLinkFixed?(x("#innerADWrap").css("height",a+"px"),n.height(x("#portrait").height()+a)):n.height(x("#portrait").height())}},e&&o.chatBoxInnerAdImgLinkUrl?(i=s.getADURL(o.chatBoxAdPostEnable,o.chatBoxInnerAdPostParamList||"{}",o.chatBoxInnerAdImgLinkUrl,view.chat.paramChat,1!=o.chatBoxInnerAdParamAppendType),t='<li class="clearfix innerAD innerAD-img"><a id="innerADLink" target="'+(1==o.chatBoxInnerAdImgLinkOpenType?view.SDK?"cover":"_blank":"inner")+'" href="'+i+'"><img onload="resetInnerAdHeight'+a+"(this.height,"+r+","+a+')" onerror="resetInnerAdHeight'+a+"(this.height,"+r+","+a+')" style="max-height:'+r+'px" src="'+e+'"/></a></li>',x.extend(s.staffInfoRefreshMap.innerImgUrl,{notEnableParam:1!=o.chatBoxAdPostEnable,srcUrl:o.chatBoxInnerAdImgLinkUrl,url:e,params:o.chatBoxInnerAdPostParamList||"{}",hash:1!=o.chatBoxInnerAdParamAppendType,element:"#innerADLink"})):e&&(t='<li class="clearfix innerAD innerAD-img"><img onload="resetInnerAdHeight'+a+"(this.height,"+r+","+a+')" style="max-height:'+r+'px" src="'+e+'"/></li>')):1==o.chatBoxInnerAdType&&r&&((e=o.chatBoxInnerAdUrl)&&view.chat.needHttps&&(e=e.replace(/^http:/,view.chat.needHttps)),(e=s.getADURL(o.chatBoxAdPostEnable,o.chatBoxInnerAdPostParamList||"{}",o.chatBoxInnerAdUrl,view.chat.paramChat,1!=o.chatBoxInnerAdParamAppendType))&&"0"!=o.chatBoxAdHeight&&(t='<li class="clearfix innerAD innerAD-url"><iframe id="inner_frame" class="ps-child" height="'+o.chatBoxAdHeight+'px" border="0" allowtransparency="true" scrolling="no" frameborder="0" style="width:100%;height:'+o.chatBoxAdHeight+'px" src="'+view.chat.addEchatInnerFrameParam(e)+'" ></iframe></li>'),x.extend(s.staffInfoRefreshMap.innerAD,{notEnableParam:1!=o.chatBoxAdPostEnable,srcUrl:o.chatBoxInnerAdUrl,url:e,params:o.chatBoxInnerAdPostParamList||"{}",hash:1!=o.chatBoxInnerAdParamAppendType,element:"#inner_frame"})),t&&(1==o.chatBoxAdImgLinkFixed?x("#innerADWrap").html(t).removeClass("hide"):x("#list_msg").append(t),2==o.chatBoxInnerAdType&&(setTimeout(l,1e3),setTimeout(l,5e3))),l()}function l(){var e=x("#portrait").height();1==o.chatBoxAdImgLinkFixed&&(e+=3==o.chatBoxInnerAdType?0:x(".innerAD").height()),n.height(e)}},sendMsgNum:0,sendToServer:function(t,e,i){var a=this,n=e||(t.c||t.content);t.visitorImg=a.visitorImg||a.defaultVisitorImg,a.isInRobot?t.ff="r":t.f=t.f||"c",t.hide||(delete t.hasResend,a.showMsg(t));var o=t.id;delete t.id,"0"!=a.queryParams.autoChat&&(t.hide||x(".msg-con",_$(o)).append('<div class="msg-error">&nbsp;</div>'),this.publish("sendVisitorEvent",t.data&&t.data.et?x.extend(t.data,{bridgeMsgId:t.bridgeMsgId,img:e?1:void 0,publishAck:t.publishAck||void 0}):{et:a.isInRobot?130:105,content:n,bridgeMsgId:t.bridgeMsgId,img:e?1:void 0,publishAck:t.publishAck||void 0},function(e){e.successful?(t.talkId=a.talkId,t.hide||(x(".msg-error",_$(o)).remove(),x("img",_$(o)).each(function(){x(this).attr("src",x(this).attr("src"))}),a.pushHistory(t)),delete a.errorList[o],i&&i(),t=null):(t.c=n,(a.errorList[o]=t).hide||(t.publishAck=e,x(".msg-error",_$(o)).addClass("resend").attr("dataid",o)))})),n&&a.publish("__visitorSendMsg",n.replace(a.regEmo,"[face]")),n&&a.publish("__visitorStartSendMsg",n.replace(a.regEmo,"[face]")),a.isInRobot&&x("#input_suggest").addClass("hide").html(" "),a.lastMsgTM=t.tm||(new Date).getTime()},checkHistoryTime:function(e){return(!this.lastHistoryTime||6e4<e-this.lastHistoryTime)&&(this.lastHistoryTime=e,!0)},endChatEvent:function(){this.typingTimer&&clearInterval(this.typingTimer);this.unSubscribe(["staffStatus","getMsgTyping","inviteBook","inviteBookOK"])},showTyping:function(){var i=this,a=lanRes.staffInput;function e(){var e;switch(5<i.serviceTypingTime&&(clearInterval(i.serviceTypingTimer),x("#serviceTypingLine").remove()),i.serviceTypingTime%3){case 0:e=a+"&nbsp;.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";break;case 1:e=a+"&nbsp;.&nbsp;.&nbsp;&nbsp;&nbsp;";break;case 2:e=a+"&nbsp;.&nbsp;.&nbsp;.&nbsp;"}i.serviceTypingTime++;var t=_$("serviceTypingLine");t&&x(".msg-item",t).html(e)}this.serviceTypingTimer&&clearInterval(this.serviceTypingTimer),x("#serviceTypingLine").remove(),this.serviceTypingTime=0,e(),this.serviceTypingTimer=setInterval(e,500),this.showMsg({f:"s",m:0,notEnd:!1,id:"serviceTypingLine"},a+"&nbsp;.&nbsp;.&nbsp;.&nbsp;")},regMail:/\b\w{1,30}([\.-]\w{1,30}){0,10}@\w{1,30}([\.-]\w{1,20}){0,10}(\.\w{1,20}){0,10}\b/g,regPhone:/([^\d]|\b)((\d{11})|((\d{7,8})|(\d{4}|\d{3})[\-\s](\d{7,8})|(\d{4}|\d{3})[\-\s](\d{7,8})[\-\s](\d{4}|\d{3}|\d{2}|\d{1})|(\d{7,8})[\-\s](\d{4}|\d{3}|\d{2}|\d{1})))(?=[^\d]|\b)/gi,regLink:/((http|ftp|https):\/\/)(([\w\._\-]+\.[a-zA-Z]{2,6})|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,4})?(\/[\w,\&%_\!\*\(\)\'\;\:\@\=\+\.\/\[-~\-#\?]*)?/gi,filterEmailPhoneLink:function(e){var r=this.isMobile;return"string"!=typeof e||e.match(/(msg\-tel)|(msg\-link)|(msg\-mail)/)?e:(this.regPhone.lastIndex=0,this.regMail.lastIndex=0,this.regLink.lastIndex=0,1<(e=e.replace(this.regLink,function(e){var t=arguments.length,i=arguments[t-2];if(0<i){var a=arguments[t-1].substring(0,i);if(/(\<(a|img|link|iframe|script)[^>]*>([^<]+(?!\<\/a\>))?$)|(\<[a-zA-Z]+[^>]*$)/gi.test(a))return e}return r?'<a class="msg-link" href="'+e+'" target="visitorSiteIframe">'+e+"</a>":'<a class="msg-link" target="_blank" href="'+e+'">'+e+"</a>"})).indexOf("@")&&(e=e.replace(this.regMail,function(e){var t=arguments.length,i=arguments[t-2];if(0<i){var a=arguments[t-1].substring(0,i);if(/(\<(a|img|link|iframe|script)[^>]*>[^<]+(?!\<\/a\>)$)|(\<[a-zA-Z]+[^>]*$)/gi.test(a))return e}return'<a class="msg-mail" target="_blank" href="mailto:'+e+'">'+e+"</a>"})),e=e.replace(this.regPhone,function(e,t){var i=arguments.length,a=arguments[i-2];if(0<a){var n=arguments[i-1].substring(0,a);if(/(\<(a|img|link|iframe|script)[^>]*>[^<]+(?!\<\/a\>)$)|(\<[a-zA-Z]+[^>]*$)/gi.test(n))return e}var o=t,s=e.replace(/^[^\d]|\b/,"");return(o||"")+(r?'<a class="msg-tel" href="tel:'+s+'">'+s+"</a>":'<span class="msg-tel">'+s+"</span>")}))},updateMsg:function(e,t,i){var a=_$(e);a&&(x(".msg-item",a).html(t),i&&i.newId&&x(a).attr("id",i.newId))},showLocation:function(e){var t="https://restapi.amap.com/v3/staticmap?location="+(e.locationY||e.y)+","+(e.locationX||e.x)+"&zoom="+(e.scale||15)+"&size=400*200&key=5349312538cf80d1f6c008eb059b732c&markers=mid,,A:"+(e.locationY||e.y)+","+(e.locationX||e.x),i='<div class="msg-map"><a target="'+(view.SDK?"cover":"_blank")+'" href="http://uri.amap.com/marker?position='+(e.locationY||e.y)+","+(e.locationX||e.x)+"&name="+encodeURIComponent(e.label)+'&coordinate=gaode"><div class="msg-map-title"><div>'+e.label+'</div><div class="msg-map-addr">'+(e.address||"")+'</div></div><img onerror="view.imgError&&view.imgError(this)" onload="view.scrollToBottom()" class="view_img" src="'+t+'" draggable="false"/></a></div>',a={data:e,et:127};a.c=i,a.m=7,a.f="c",a.id=e.id,a.talkId=e.talkId,e.fromHistory||902==e.mt?this.showMsg(a):this.sendToServer(a)},showMsg:function(t,e){if(t){var i=this,a=t.talkId||i.talkId,n=t.id||"msg"+(t.tm||(new Date).getTime());!t.id&&"s"==t.f&&_$(n)&&x("#"+n).remove();var o,s=t.t?'<li class="clearfix" ><div class="color1 tc">'+t.t+"</div></li> ":"";if(0==t.m?(t.c&&(t.c=i.filterEmailPhoneLink(t.c)),o=t.c?(i.filterEmo(t.c)+"").replace(/((\r\n)|\n)/g,"</br>"):e):(o=t.c||e,t.m),t.c=o){var r=t.visitorImg||i.visitorImg||i.defaultVisitorImg;i.needHttps&&(i.staffImg&&(i.staffImg=i.staffImg.replace(/^http:/,i.needHttps)),r=i.visitorImg||r.replace(/^http:/,i.needHttps)),view.staticPx2rem&&(o=view.staticPx2rem(o));var l={toChat:"robot-staff ",endChat:"end-chat ",toLeaveWord:"to-leave-word "};o=o.replace(/\[\[#(toChat|endChat|toLeaveWord):([^\]]+)\]\]/g,function(e,t,i){return'<span class="link-in-msg '+(l[t]||"")+'">'+i+"</span>"}),1==t.withdraw?s+='<div style="padding: 10px 0 20px;text-align: center;"><span style="display: inline-block;padding: 8px 10px;background-color: #bfbfbf;border-radius: 5px;color: #FFF;">'+o+"</span></div>":"s"==t.f||"r"==t.f?s+='<li class="clearfix '+("r"==t.f?"msg-robot":"")+" mode"+t.m+(t.media?" msg-medias":"")+'" id="'+n+'" >'+(i.showAvatar?'<div class="avatar-icon fl staff-icons"><img onerror="view.imgError&&view.imgError(this)" class="avatar-icon-img" src="'+(t.staffImg||i.staffImg||i.defaultStaffImg)+'"/></div>':"")+'<div class="msg msg-lf fl"><div class="msg-staff-name">'+(t.staffName||i.staffName||lanRes.serviceStaff)+'</div><div class="msg-con radius4 fl '+("r"==t.f?"bg10":"bg1")+(0!=t.m&&6!=t.m&&3!=t.m?" bgwhite":"")+'">'+(t.media?"":'<i class="msg-angle '+("r"==t.f?view.SDK?"color10":"border-color-angle10":view.SDK?"color11":"border-color-angle1")+'"></i>'+(view.SDK?"":0!=t.m&&6!=t.m&&3!=t.m?'<i class="msg-angle2 bc-angle1-white"></i>':""))+'<div class="msg-item">'+o+"</div></div></div></li>":"c"==t.f?s+='<li class="clearfix mode'+t.m+(t.media?" msg-medias":"")+'" id="'+n+'" >'+(i.showAvatar?'<div class="avatar-icon fr"><img onerror="view.imgError&&view.imgError(this)" class="avatar-icon-img" src="'+r+'"/></div>':"")+'<div class="msg msg-rt fr"><div class="msg-con radius4 fr '+("r"==t.ff?"bg30":"bg3")+(0!=t.m&&5!=t.m&&3!=t.m?" bgwhite":"")+'">'+(t.media?"":'<i class="msg-angle '+("r"==t.ff?view.SDK?"color30":"border-color-angle20":view.SDK?"color3":"border-color-angle2")+'"></i>'+(view.SDK?"":0!=t.m&&5!=t.m&&3!=t.m?'<i class="msg-angle2 bc-angle2-white"></i>':""))+(t.hasResend?'<div class="msg-error resend" dataid="'+t.id+'">&nbsp;</div>':"")+'<div class="msg-item">'+o.replace(/\n/g,"<br/>")+"</div></div></div></li>":s+=o;var d=_.createElement("ul");d.innerHTML=s;for(var c,u=i.getListMsgEl(a,t.tm),f=d.childNodes,m=0;c=f[m++];)if(1==c.nodeType){c=c.cloneNode(!0);var h=((t.id||"msg0")+"").replace("msg",""),p=_.getElementById(h);p&&p.innerHTML?p.innerHTML=c.innerHTML:u.appendChild(c)}if(d=f=null,t.notAppend)return s;"c"==t.f&&this.serviceTypingTimer?x("#list_msg").append(_$("serviceTypingLine")):"serviceTypingLine"!=t.id&&"s"==t.f&&this.serviceTypingTimer&&(clearInterval(this.serviceTypingTimer),x("#serviceTypingLine").remove()),t.notEnd||(0!=t.m&&1!=t.m&&5!=t.m&&view.scrollToBottom(null,{transitionDuration:100,timeout:"x"==t.f?1e3:1!=view.windowType?510:100}),view.noScrollBottom||setTimeout(function(e){view.scrollToBottom(void 0,{notVisitor:"c"!=t.f})},5))}}},changeStorgeBackMsg:function(e){var t,i=window.localStorage.getItem(this.historyKey)?JSON.parse(window.localStorage.getItem(this.historyKey)):"",a=i?i.order[i.order.length-1]:"",n=i?i[a]:"";if(!n)return!1;for(var o in delete i[a],n)if(n[o].mid==e){n[o].withdraw=1,n[o].c=lanRes.backMsgTip,n[o].m=0,n[o].mt="640",t=o;break}return i[a]=n,window.localStorage.setItem(this.historyKey,JSON.stringify(i)),!!t&&parseInt(t)},initHistory:function(e){if(this.hasStorage){var t=window.localStorage.getItem(this.historyKey);return(t=(t=t&&JSON.parse(t))||{order:[]})[e]||(t.order||(t.order=[]),t.order.push(e),t[e]={order:[]}),t[e].order||(t[e].order=[]),t}},pushHistory:function(e){if(this.hasStorage&&!view.SDKNative&&e.c){var t=e.talkId||this.talkId;if(t){e.talkId=t;var i=this.initHistory(t);if(i&&"c"==e.f){var a=i[t].order;if(0<a.length){var n=a[a.length-1];if(i[t][n].c==e.c&&-1<n.indexOf("c")){var o=i[t][n].tm-e.tm;if(o<200&&-200<o)return}}}"s"!=e.f||e.staffImg||(e.staffImg=this.staffImg,e.staffName=this.staffName),1!==e.m&&2!==e.m||i[t][e.tmf]?i[t][e.tm+e.f]||(i[t][e.tm+e.f]=e,i[t].order.push(e.tm+e.f)):(i[t][e.tmf]=e,i[t].order.push(e.tmf)),window.localStorage.setItem(this.historyKey,JSON.stringify(i))}}},saveHistoryStaff:function(e,t){if(this.hasStorage&&this.talkId){var i=this.initHistory(this.talkId);e&&!i[this.talkId].staffImg&&(i[this.talkId].staffImg=e||this.defaultStaffImg),e&&!i[this.talkId].staffName&&(i[this.talkId].staffName=t||lanRes.serviceStaff),window.localStorage.setItem(this.historyKey,JSON.stringify(i))}},checkHistory:function(){if(!this.hasStorage)return x("#pre_his").hide(),!1;if(view.SDKNative)return!0;if(this.hasCheckHistory)return this.hasPreHis;this.talkId&&(this.hasCheckHistory=!0);var e=window.localStorage.getItem(this.historyKey);if(!e||'""'==e)return x("#pre_his").hide(),!1;var t=(e=JSON.parse(e)).order,i=t.length;return i&&(1!=i||!t||!t[0]||t[0]!=this.talkId)||(x("#pre_his").hide(),!1)},loadHistory:function(e){if(!this.hasStorage||!this.hasPreHis)return!1;if(!this.loadingPreHis){var t;if(view.SDKNative)this.publish("__loadPreHistory");else if(this.loadingPreHis=!0,t=(t=window.localStorage.getItem(this.historyKey))&&JSON.parse(t)){if(e&&(!t[e]||!t[e].order||0==t[e].order.length))return;var i=new Date,a=((new Date).getTime(),t.order),n=a.length;if(i.setHours(0,0,0,0),i=i.getTime(),n<2)return this.hasPreHis=!1,this.loadingPreHis=!1;for(var o=n-1;-1<o&&(!e||a[o]==e);o--)if(a[o]&&a[o]!=this.talkId){0==o&&(this.hasPreHis=!1,x("#pre_his").hide());var s=t[a[o]],r=_$("list_msg_"+a[o]);if(s&&!r){console.log(s),this.showHis(s,a[o]);break}if(x(r).hasClass("new-leave"))continue}}}},hidePreHistory:function(){this.loadingPreHis=!1,this.hasPreHis=!1,x("#pre_his").hide()},showPreHistory:function(){this.loadingPreHis=!1,this.hasPreHis=!0,x("#pre_his").show()},showHis:function(e,t){var i,a=this,n=this.staffImg,o=this.staffName,s={};for(var r in view.handleHis&&view.handleHis(e,t),view.preHisLoadingId="list_msg_"+t,e)"order"!=r&&"staffImg"!=r&&"staffName"!=r&&"config"!=r&&((i=x.extend({},e[r])).talkId=t,i.fromHistory=!0,i.notStore=!0,i.notEnd=!0,i.t&&-1==(i.t+"").indexOf(" ")&&(i.t=a.getTimeStr(i.tm)),"649"==i.mt?i.robotConfigInfo&&e.robotStaffName?(this.staffImg=e.robotStaffImg,this.staffName=e.robotStaffName):(this.staffImg=e.staffImg,this.staffName=e.staffName):"604"==i.mt?s=!s.staffId&&i.staffDetailInfoMsgList&&i.staffDetailInfoMsgList.length?{staffId:i.staffDetailInfoMsgList[0].staffId,staffName:i.staffDetailInfoMsgList[0].staffNickName||lanRes.serviceStaff,staffImg:i.staffDetailInfoMsgList[0].staffHead||e.staffImg}:{staffId:i.staffId,staffName:i.staffNickName||lanRes.serviceStaff,staffImg:i.staffDetailInfo&&i.staffDetailInfo.staffHead||e.staffImg}:"10001"==i.mt&&a.staffMap?s=a.updateStaffInfo(void 0,{staffId:i.toStaffId,staffNickName:i.toStaffNickName,staffDetailInfo:i.toStaffDetailInfo}):i.staffId&&a.staffMap[i.staffId]?(i.staffName=a.staffMap[i.staffId].staffName||e.staffName,i.staffImg=a.staffMap[i.staffId].staffImg||e.staffImg):!i.staffImg&&s.staffName&&(i=x.extend(i,s)),"10001"!=i.mt?"10011"!=i.mt?"10010"!=i.mt?1e3<i.mt&&"r"!=i.f||(865!=i.mt&&641!=i.mt?647!=i.mt?866!=i.mt&&642!=i.mt?"12001"!=i.mt?655!=i.mt?127!=i.mt&&902!=i.mt?680!=i.mt?605!=i.mt&&10009!=i.mt?(i.notAppend=!0,3==i.m&&i.c&&(i.c=this.getBookComfirm(i.c)),!i.c&&i.content&&(i.c=i.content),i.c&&this.showMsg(i),delete i.talkId):605==i.mt&&a.publish("getSysMsg",i):a.publish("receiveURL",i):a.publish("sendLocationInfo",i):a.publish("getLeaveMsg",i):a.publish("getMsgRobot",i):a.publish("getMsgFile",i):a.publish("getSysMsg",i):a.publish("getMsgImg",i)):a.publish("getSysMsg",i):a.publish("receiveVisEvt",i):a.publish("getSysMsg",i));this.staffImg=n,this.staffName=o,view.scrollToLastPre(view.preHisLoadingId),setTimeout(function(){view.scrollToLastPre(view.preHisLoadingId),view.preHisLoadingId=null},500),this.loadingPreHis=!1},clearHistoryByTalkId:function(e){var t=window.localStorage.getItem(this.historyKey);if((t=t?JSON.parse(t):"")&&t[e]){delete t[e];for(var i=t.order.length-1;0<=i;i--)t.order[i]==e&&t.order.splice(i,1)}window.localStorage.setItem(this.historyKey,JSON.stringify(t))},getListMsgEl:function(e,t,i){var a=_$("list_msg_"+e);return a||(e!=this.talkId&&e?(this.hasLeaveMsg||x(".list-his-hr").removeClass("hide"),(a=_.createElement("ul")).id="list_msg_"+e,a.className="list-msg list-msg-his",a.innerHTML='<li class="clearfix list-his-hr color1 hide"><i class="hr-left"></i><span>'+this.getTimeStr(t)+'</span><i class="hr-right"></i></li>',_$("list_his").insertBefore(a,i?_$("list_msg"):_$("pre_his").nextSibling),a):_$("list_msg"))},handleSessionMsg:function(e){e.talkId||(e.talkId=Math.random());var t=e.talkId,i=_$("list_msg_"+t);if(i)return i;(i=_.createElement("ul")).id="list_msg_"+t,i.className="list-msg list-msg-his";for(var a,n=_$("list_msg").childNodes,o=0;a=n[o++];)1==a.nodeType&&(o--,-1!=a.className.indexOf("innerAD")&&a.childNodes&&"IFRAME"==a.childNodes[0].tagName?x(a).remove():i.appendChild(a));return _$("list_his").insertBefore(i,_$("list_msg")),i},getTimeStr:function(e){e=e&&e-0||void 0;var t=new Date,i=new Date(e).format("hh:mm");return e=e||t.getTime(),t.setHours(0,0,0,0),((t=t.getTime())<=e?lanRes.today:t-e<=864e5?lanRes.yesterday:t-e<=1728e5?lanRes.beforeYesterday:new Date(e).format("yyyy-MM-dd"))+" "+i},showSysTip:function(e,t,i,a,n){i=i||"msg"+t,view.staticPx2rem&&e&&(e=view.staticPx2rem(e));var o='<li class="clearfix" id="'+i+'" ><div class="color1 tc">'+new Date(t).format("hh:mm")+'</div></li><li class="clearfix tc" id="'+i+'" ><div class="msg-sys radius4 tc">'+e+"</div></li>",s=_.createElement("ul");s.innerHTML=o;for(var r,l=this.getListMsgEl(n,t),d=s.childNodes,c=0;r=d[c++];)1==r.nodeType&&(r=r.cloneNode(!0),l.appendChild(r));s=d=null,a||view.scrollToBottom(null,{transitionDuration:100,timeout:100})},showInfoTip:function(e,t,i,a,n,o,s){var r;if("string"!=typeof e&&(e=(r=e)&&r.tip),e){view.staticPx2rem&&e&&(e=view.staticPx2rem(e)),e=e.replace(/&nbsp;([^&\s])/g," $1");var l={toChat:"robot-staff ",endChat:"end-chat ",toLeaveWord:"to-leave-word "};e=e.replace(/\[\[#(toChat|endChat|toLeaveWord):([^\]]+)\]\]/g,function(e,t,i){return'<span class="link-in-msg '+(l[t]||"")+'">'+i+"</span>"}),t=t||"msg"+(new Date).getTime(),"icon";var d='<li class="clearfix '+(this.showAvatar?"msg-info-hasAvatar":"msg-info-noAvatar")+'" id="'+t+'" ><div class="'+(!r&&this.isInRobot||r&&"r"==r.f?"msg-info0":"msg-info")+' radius4"><div class="info-con">'+e+"</div></div></li>";if(a)return d;t&&_$(t)&&x("#"+t).remove();var c=_.createElement("ul");c.innerHTML=d;for(var u,f=this.getListMsgEl(n,o),m=c.childNodes,h=0;u=m[h++];)1==u.nodeType&&(u=u.cloneNode(!0),f.appendChild(u));c=m=null,s||view.scrollToBottom(null,{transitionDuration:100,timeout:100})}},resetStatisfy:function(){if(x("#sa_advise").val(""),!m)for(var e=x(".sa-sli").results,t=0;t<e.length;t++)x(e[t]).addClass("sa-star").html("&#xe64d;");x("#satisfyConfig").attr("class","sa-sel-5"),x(".sub-tab-sel").removeClass("sub-tab-sel"),x(".sub-tab5").addClass("sub-tab-sel")},showSatisfy:function(e){if(this.allowEvaluateBaseWords>this.sendMsgNum&&1==e)return!1;if(2==(this.satisfyType=e)||3==e||this.satisfyEnable&&!this.satisfyShowed){view.inputBlur&&view.inputBlur(),this.resetStatisfy();var t=this.hideSatisfy,i=setTimeout(function(){clearTimeout(i),x("#mask").off("click",t).on("click",t).show(),x("#satisfy").show()},0);return view.handleShowSatisfy&&view.handleShowSatisfy(),!0}return!1},hideSatisfy:function(){var e=view.chat;x("#satisfy").removeClass("satisfy-show").hide(),x("#mask").hide().off("click",e.hideSatisfy),!1===e.chatting?(e.publish("_closeWin"),e.publish("__evaluate","0-2")):e.publish("__evaluate","0-1"),x.store("ECHAT_inviteSatisfyHandle",x.store("ECHAT_inviteSatisfyId")),view.SDK&&_$("sa_advise").blur(),view.hideSatisfy&&view.hideSatisfy()},addJS:function(e,t){var i=_.createElement("script");i.setAttribute("type","text/javascript");var a=_$s("head")[0];function n(e){i.onload=i.onerror=i.onreadystatechange=null,a.removeChild(i),i=null,t(e)}"onload"in i?(i.onload=n,i.onerror=function(){n(!0)}):i.onreadystatechange=function(){/loaded|complete/.test(i.readyState)&&n()},i.src=e,a.appendChild(i)},addCSS:function(e){var t=_.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e,t.media="screen",_$s("head")[0].appendChild(t)},loadEmoji:function(){var n=this;if(!n.emo){if(view.loadEmoji)return view.loadEmoji();this.addCSS(n.isMobile&&view.px2px?__uri("/visitor/mobile/css/emoji.css"):n.isMobile?locationBase+"/res/emoji/emoji_x2.css":locationBase+"/res/emoji/emoji.css"),x.ajax({url:locationBase+"/res/emoji/emoji.json",async:!0,type:"get",contentType:"application/json;charset=UTF-8",data:void 0,beforeSend:function(e){},success:function(e){n.emo=JSON.parse(e)},error:function(e,t,i){console.log("ajax emoji error")}}),x.ajax({url:locationBase+"/res/emoji/emoji_"+(window.lanName.match(/^zh/i)?"zh":"en")+".json",async:!0,type:"get",contentType:"application/json;charset=UTF-8",data:void 0,beforeSend:function(e){},success:function(e){n.emoLan=JSON.parse(e);var t={};for(var i in n.emoLan)t[n.emoLan[i]]=i;n.lanEmo=t},error:function(e,t,i){console.log("ajax emoji error")}}),x.ajax({url:locationBase+"/res/emoji/emojiFace.json",async:!0,type:"get",contentType:"application/json;charset=UTF-8",data:void 0,beforeSend:function(e){},success:function(e){var t=JSON.parse(e);view.initEmotion.call(n,t),x("#emotion").on(n.isMobile?"tap":"click",".emoji",function(e){var t=x(this).attr("code"),i=n.getInput().length+t.length+4,a=n.inputMaxLength;a<i||(x("#inputLengthTip").html(lanRes.inputLengthTip1+(a-i)+lanRes.inputLengthTip2),n.isMobile||n.focusInput(),n.insertImg(t),n.oldBodyEnterText=n.getInput())})},error:function(e,t,i){console.log("ajax emoji error")}})}},filterEmo:function(e){if(!e||"string"!=typeof e)return e;var n=this.emo;return n&&(e=e.replace(this.regFace,function(e){var t=e.charCodeAt(0),i=e.charCodeAt(1),a=(i-56320+(t-55296<<10)+65536).toString(16);return n[a]?'<img class="img-emo" src="'+locationBase+"/res/emoji/32/"+a+'.png" />':n[t+"_"+i]?'<img class="img-emo" src="'+locationBase+"/res/emoji/32/"+t+"_"+i+'.png" />':e})),e=e.replace(this.regEmo,function(e){var t=e.replace(/^\[#([\d\w_]+)#\]/g,"$1");return n&&n[t]||!n?'<img class="img-emo" src="'+locationBase+"/res/emoji/32/"+t+'.png" />':e})},getFileSize:function(e,t){if(""!=e.value){var i=-1;if(e.files&&e.files[t])i=parseInt(e.files[t].size);else try{e.select();var a=_.selection.createRange().text;i=new ActiveXObject("Scripting.FileSystemObject").GetFile(a).size}catch(e){console.log("如果你用的是ie8以下 请将安全级别调低！")}return i}},hasFormData:function(){var t=!0;try{1==view.windowType&&new FileReader,new FormData}catch(e){t=!1}return t}(),hasInitFile:!1,addSendFile:function(){if(!view.SDKNative){if(this.hasInitFile)if(this.hasFormData);else(e=_$("file_up"))&&(e.src="/visitor/common/upload.html?t="+(new Date).getTime());else if(this.hasFormData)window.fLoad(_);else{var e;if(e=_$("file_up"))return;x("#uploadForm").remove(),x(".menu-file").append('<iframe src="/visitor/common/upload.html" style="filter:alpha(opacity=0.1);opacity: 0.1;position: absolute;top:0;left:0;z-index: 999999999;" allowtransparency="true" id="file_up" frameborder="0" framespacing="0" marginheight="0" marginwidth="0" width="100%" height="100%" scrolling="no"></iframe>')}}},isImgHasPreview:function(e){var t=x(e);if(t.hasClass("msg-img"))return!0;if(t.hasClass("img-emo")||t.hasClass("custom-event-img"))return!1;if(t.parents(".msg-info").length||t.parents(".msg-info0").length||t.parents(".msg-item").length){if(t.parents("a").attr("href"))return!1;if(!t.hasClass("info-icon-img")&&!t.parents(".portrait-title").length&&!t.parents(".feedback-btns").length)return!0}},setMerchantLogo:function(e){var t=[],i=this,a="",n="",o=e.chatLogoImgEnable,s="",r="";i.staffInfoRefreshMap.merchantLink=null,"1"==o&&(a="1"==e.chatLogoImgType?i.platformLogo:i.companyLogo)&&t.push('<img class="header-logo" src="'+a+'"/>'),"1"==e.companyNameEnable&&(n="1"==e.companyNameType?i.platformName:i.companyName)&&t.push('<span class="header-logo-txt">'+n+"</span>"),"1"==e.subcompanyUrlEnable&&((s=e.subcompanyUrl)&&(r=i.getADURL(!0,e.subcompanyAdPostParamList,s,i.paramChat)),e.subcompanyButtonUrl&&t.push('<a class="merchant-link" href="'+(r||"")+'" target="_blank"><img class="merchant-icon" src="'+e.subcompanyButtonUrl+'"/></a>'),r&&(i.staffInfoRefreshMap.merchantLink={notEnableParam:!1,params:e.subcompanyAdPostParamList,element:".merchant-link",hash:!1,srcUrl:s,attr:"href",url:""})),x("#logobox").html(t.join(""))}},window.imgLoadResizeSelf=function(e){view.px2rem&&(e.style.width=view.px2rem(e.naturalWidth||e.width))};window.imgLoadResize=function(e,a){Math.random();var n=-1==a?"entry":"inviteBook"+a,o=-1==a?"entryWrapImg":"inviteBookImg"+a;function t(){var e=1==view.windowType?600:260,t=this.naturalWidth||this.width,i=_$(n);i&&(e<t&&(t=e),i.style.width=view.px2rem?view.px2rem(t):t+"px",-1==a&&(i.style.marginLeft=view.px2rem?view.px2rem(-t/2):-t/2+"px"),x("#"+o).removeClass("hide").css("width",view.px2rem?view.px2rem(t):t+"px"),view.scrollToBottom())}if(e.naturalWidth)t.call(e);else{var i=new Image;i.onload=t,i.src=e.src}};x(function(e){!0;var t=new i;setTimeout(window.initChat,0),"firefox"==t.Browser.browser&&x("body").on("drop",function(e){e.stopPropagation()}),"xcx"==t.queryParams.launchfrom&&t.addJS("https://res.wx.qq.com/open/js/jweixin-1.3.2.js")})}(EChatQuery,document),function(r){var l,d,c,u,f,m={};function h(){u=null,m.last&&(m.el.trigger("longTap"),m={})}function p(){u&&clearTimeout(u),u=null}function g(){l&&clearTimeout(l),d&&clearTimeout(d),c&&clearTimeout(c),u&&clearTimeout(u),l=d=c=u=null,m={}}function v(e){return("touch"==e.pointerType||e.pointerType==e.MSPOINTER_TYPE_TOUCH)&&e.isPrimary}function b(e,t){return e.type=="pointer"+t||e.type.toLowerCase()=="mspointer"+t}r(function(){var t,i,a,n,o=0,s=0;"MSGesture"in window&&((f=new MSGesture).target=document.body),r(document).bind("MSGestureEnd",function(e){var t=1<e.velocityX?"Right":e.velocityX<-1?"Left":1<e.velocityY?"Down":e.velocityY<-1?"Up":null;m.el&&t&&(m.el.trigger("swipe"),m.el.trigger("swipe"+t))}).on("touchstart",function(e){(n=b(e,"down"))&&!v(e)||(a=n?e:e.touches[0],e.touches&&1===e.touches.length&&m.x2&&(m.x2=void 0,m.y2=void 0),t=Date.now(),i=t-(m.last||t),m.el=r("tagName"in a.target?a.target:a.target.parentNode),l&&clearTimeout(l),m.x1=a.pageX,m.y1=a.pageY,0<i&&i<=250&&(m.isDoubleTap=!0),m.last=t,u=setTimeout(h,750),f&&n&&f.addPointer(e.pointerId))}).on("touchmove",function(e){(n=b(e,"move"))&&!v(e)||(a=n?e:e.touches[0],p(),m.x2=a.pageX,m.y2=a.pageY,o+=Math.abs(m.x1-m.x2),s+=Math.abs(m.y1-m.y2))}).on("touchend",function(e){(n=b(e,"up"))&&!v(e)||(p(),m.x2&&30<Math.abs(m.x1-m.x2)||m.y2&&30<Math.abs(m.y1-m.y2)?m.el&&(c=setTimeout(function(){m.el&&(m.el.trigger("swipe"),m.el.trigger("swipe"+function(e,t,i,a){return Math.abs(e-t)>=Math.abs(i-a)?0<e-t?"Left":"Right":0<i-a?"Up":"Down"}(m.x1,m.x2,m.y1,m.y2)),m={})},0)):"last"in m&&(o<30&&s<30?d=setTimeout(function(){var e=r.Event("tap");m.el&&(e.cancelTouch=g,m.el&&m.el.trigger(e),m.isDoubleTap?(m.el&&m.el.trigger("doubleTap"),m={}):l=setTimeout(function(){l=null,m.el&&m.el.trigger("singleTap"),m={}},250))},0):m={}),o=s=0)}).on("touchcancel MSPointerCancel pointercancel",g),r(window).on("scroll",g)}),["swipe","swipeLeft","swipeRight","swipeUp","swipeDown","doubleTap","tap","singleTap","longTap"].forEach(function(t){r.fn[t]=function(e){return this.on(t,e)}})}(window.EChatQuery);