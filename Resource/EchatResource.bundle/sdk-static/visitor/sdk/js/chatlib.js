function InputHandle(){var e=this;this.filterPasteData=function(e,t,i){var a=e&&e.replace(/^(<div>)(<br(\/)?>)+(<\/div>)/gi,"").replace(/(<div>)(<br(\/)?>)+(<\/div>)/gi,"\n").replace(/<([br|hr|div])+(\/)?>/gi,"\n").replace(/<\/(br|p|table|section|footer|article|li|ul|ol)>/gi,"\n").replace(/(<[a-z]+(\s+[^>]*)?\/?>)|(<\/[a-z]+>)/gi,"").replace(/&nbsp;/g," ");return"function"==typeof String.prototype.trimEnd?(t&&(e=e.trimEnd()),a=a.trimEnd()):(t&&(e=e.replace(/(\n|\r|[<br>]|\s)+$\w{0}/g,"")),a=a.replace(/(\n|\r|[<br>]|\s)+$\w{0}/g,"")),e&&t?e:a},this.getInput=function(t){if(e.plainText){var i=$("#textInput").val();if(i){if(t){$("#textInput").val("");_$("textInput")}return e.filterPasteData(i,!0,!0)}return i}var a,n,s,o=e.getInputDocBody();return null!=o.lastElementChild&&"SL_balloon_obj"==o.lastChild.id&&o.removeChild(o.lastChild),a=o.innerHTML,n=a.replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[#$1#]"),t?(o.innerHTML="",$("#inputPlaceholder").removeClass("hide")):a.length,(s=a.length>15e3?n:e.filterPasteData(n,!1,!0)).length>5e3&&(s=s.length>15e3?e.filterPasteData(s.substring(0,5e3),!1,!0):s.substring(0,5e3)),s},this.setInput=function(t){if(!t)return this.getInput(!0);if(t=t.replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[#$1#]").replace(/<(?!br|\/br)(?:.|\s)*?>/gi,"").replace(/&nbsp;/gi," ").replace(/^((<\/?br\/?>)|[\r\n\s]+)+|((<\/?br\/?>)|[\r\n\s]+)+$/gi,""),e.plainText)$("#textInput").val(t);else{e.getInputDoc();e.getInputDocBody().innerHTML=t}},this.inputScrollToView=function(e){function t(){a>15||setTimeout(function(){var e=window.innerHeight+(i.isIOS?80:20);window.scrollTo(0,e),a++,t()},100)}var i=this,a=1;$(e).on("focus",function(e){window.top==window?(t(),a=1):i.postMessage("inputScroll")}),$(e).on("blur",function(e){a=1,setTimeout(function(){i.postMessage("inputScrollStop")},550)})},this.changeToIframe=function(e,t){function i(e){$("#inputPlaceholder").addClass("hide");var t=o.getInputDoc(),i=null;return t.selection?i=t.selection.createRange():o.win.getSelection&&o.win.getSelection().rangeCount&&(i=o.win.getSelection().getRangeAt(0)),i&&(o.win.pos=i)}function a(){i(),view.hideMenus(0)}function n(){i(),o.getInput(!1)||$("#inputPlaceholder").removeClass("hide")}function s(e,t,i){e.addEventListener?e.addEventListener(t,i):e.attachEvent("on"+t,i)}if(this.plainText){this.plainText=!1,this.editorType=2;var o=this;$("#textInput").hide();var r=_$("html_input");if(r.style.display="block",!this.hasInitIframeInput){this.hasInitIframeInput=!0;var l=o.getInputDoc();try{l.designMode="on"}catch(e){console.log(e)}l.contentEditable=!0;try{window.isIE6?l.write('<html><head><meta http-equiv="Content-type" content="text/html;charset=utf-8"><style type=\'text/css\'>html,body{width:100%;height:100%;max-height: 100%;overflow-y: auto;overflow-x:hidden;margin:0;padding:0;background-color:transparent;font-family: "Microsoft YaHei", "Helvetica Neue", Helvetica,"微软雅黑", Arial, sans-serif, STHeiti, FangSong;}</style></head><body contenteditable="true"></body></html>'):(l.open(),l.write('<html><head><meta http-equiv="Content-type" content="text/html;charset=utf-8"><style type=\'text/css\'>html,body{width:100%;height:100%;max-height: 100%;overflow-y: auto;overflow-x:hidden;margin:0;padding:0;background-color:transparent;font-family: "Microsoft YaHei", "Helvetica Neue", Helvetica,"微软雅黑", Arial, sans-serif, STHeiti, FangSong;}'+(1==view.windowType?"":" .img-emo{width:20px;height:20px;")+'}</style></head><body contenteditable="true"></body></html>'),l.close())}catch(e){}var d=l.getElementsByTagName("body")[0];d.style.cssText="margin:0;padding:0;word-break:break-all;word-wrap: break-word;width:100%;line-height:1.2;overflow-y: auto;overflow-x:hidden;",o.win=r.contentWindow||document.frames.html_input,o.getPos=i,s(o.win,"focus",a),s(o.win,"blur",n),s(d,"focus",a),s(d,"blur",n),s(d,"select",i),s(d,"click",function(e){i(),view.hideMenus()}),s(d,"keydown",function(e){$("#inputPlaceholder").addClass("hide");var t=e||o.win.event;return view.enter(t)}),s(d,"drop",function(e){setTimeout(function(){o.getInput(!1)&&$("#inputPlaceholder").addClass("hide")},100),o.Browser.browser}),s(l,"paste",function(e){setTimeout(function(){o.getInput(!1)?$("#inputPlaceholder").addClass("hide"):$("#inputPlaceholder").removeClass("hide")},100)}),o.isMobile&&o.inputScrollToView(d),view.initHtmlEdit&&view.initHtmlEdit(o.win,l),o.isMobile||o.addPaste(o.win,l),setTimeout(function(){o.getInput(!1)?$("#inputPlaceholder").addClass("hide"):$("#inputPlaceholder").removeClass("hide")},100)}}},this.preRange=null,this.changeToPreInput=function(){function e(e){var a,n=i.results[0];if(window.getSelection){var s=window.getSelection();try{a=s.getRangeAt(0)}catch(e){(a=document.createRange()).selectNodeContents(n),a.collapse(!1),a.select()}}else a=document.selection.createRange();return t.preRange=a,a}if(this.plainText){this.editorType=3,this.plainText=!1;var t=this;$("#textInput").hide();var i=$("#html_pre_input"),a=i.results[0];i.css("display","block"),t.isMobile&&t.inputScrollToView(t.getInputDocBody());var n;a.onkeyup=function(){clearTimeout(n),n=setTimeout(function(){e()},300)},a.onkeydown=function(e){$("#inputPlaceholder").addClass("hide");e||window.event;return view.enter(e)},a.ontouchend=function(t){setTimeout(function(){e()},50)},a.ontouchstart=function(e){$("#inputPlaceholder").addClass("hide")},a.onfocus=function(){$("#inputPlaceholder").addClass("hide"),e(),view.hideMenus(0)},a.onblur=function(){t.getInput(!1)||$("#inputPlaceholder").removeClass("hide")},a.onclick=function(){e(),view.hideMenus(0),a.focus()},t.getPos=e}},this.bindPlainTextEvent=function(){function e(e){var t,a=_$("textInput");if(window.getSelection){var n=window.getSelection();try{t=n.getRangeAt(0)}catch(e){(t=document.createRange()).selectNodeContents(a),t.collapse(!0)}}else t=document.selection.createRange();return i.textRange=t,t}this.plainText=!0,this.editorType=1,$("#textInput").show();var t=_$("html_input");$(t).hide();var i=this;$("#inputPlaceholder").addClass("hide"),i.isMobile,this.hasBindPlainTextEvent||(this.hasBindPlainTextEvent=!0,view.bindPlainTextEvent(),$("#textInput").off("keydown").on("keydown",function(t){t=t||window.event;if(i.handleInputLength&&setTimeout(i.handleInputLength,50),!1!==view.enter(t)){if(8==(t.keyCode||t.which||t.charCode||0)){var a=_$("textInput"),n=a.value;if(a.createTextRange)console.log("手机端IE?");else{var s=a.selectionStart,o=-1,r=0;s>0&&n.replace(/\[#([^#]+)#\]/g,function(e,t,i,a){return i<s&&i+e.length>=s&&(o=i,r=i+e.length),e}),-1!=o&&a.setSelectionRange(o,r)}}e()}}).on("change input",function(){e()}).on("paste",function(e){return i.filterPasteText(e,void 0,window,document)}).on("drop",function(e){i.handleInputLength&&setTimeout(function(){i.handleInputLength()})}).on("focus",e),setTimeout(function(){_$("textInput")&&_$("textInput").scrollIntoView(!1)},400),i.textRange=null,i.getPos=e)},this.filterPasteText=function(t,i,a,n){var s=n.getElementById("textInput");if(void 0===i&&(i=a.clipboardData&&clipboardData.setData?a.clipboardData.getData("text"):t.clipboardData&&t.clipboardData.setData?t.clipboardData.getData("text"):(t.originalEvent||t).clipboardData.getData("text/plain")||prompt("在这里输入文本")),i){if(i=e.filterPasteData(i,void 0,!0),t.returnValue=!1,t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation(),i&&e.plainText)if(n.selection){var o=n.selection.createRange();o.text=i}else if("number"==typeof s.selectionStart&&"number"==typeof s.selectionEnd){var r=s.selectionStart,l=s.selectionEnd,d=r,c=s.value;s.value=c.substring(0,r)+i+c.substring(l,c.length),d+=i.length,s.selectionStart=s.selectionEnd=d}else s.value+=i;else if(i&&n.body.createTextRange){if(n.selection)textRange=n.selection.createRange();else if(a.getSelection){var f=(o=a.getSelection()).getRangeAt(0),u=n.createElement("span");u.innerHTML="&#FEFF;",f.deleteContents(),f.insertNode(u),textRange=n.body.createTextRange(),textRange.moveToElementText(u),u.parentNode.removeChild(u)}textRange.text=i,textRange.collapse(!1),textRange.select()}else i&&n.execCommand("insertText",!1,i);return!1}return!0},this.getInputDoc=function(){var e;return 2==this.editorType?(e=_$("html_input").contentDocument)||(e=document.frames.html_input.document):e=document,e},this.getInputDocBody=function(){var e,t,i=this.editorType;return 3==i?(t=_$("html_pre_input")).blur||(t.blur=function(){window.focus()}):2==i?((e=_$("html_input").contentDocument)||(e=document.frames.html_input.document),t=e.body||e.getElementsByTagName("body")[0]):t=_$("textInput"),t},this.focusInput=function(e){var t,i,a,n=this.editorType;return 3==n?t=_$("html_pre_input"):2==n?(t=_$("html_input").contentWindow||document.frames.html_input,(i=_$("html_input").contentDocument)||(i=document.frames.html_input.document),a=i.body||i.getElementsByTagName("body")[0],!e&&a.focus()):t=_$("textInput"),!e&&t.focus(),!e&&a&&a.focus(),t},this.insertBr=function(){var t,i,a,n=e.win,s=this.getInputDoc().createElement("div"),o=this.getInputDoc().createElement("br");n.getSelection?t=n.getSelection():i=n.document.selection,(i=t.getRangeAt(0)).endContainer.data&&i.endContainer.data.length!==i.endOffset?a=o:(s.appendChild(o),a=s),t.removeAllRanges(),i.deleteContents(),i.insertNode(a),i.setStartAfter(a),i.setEndAfter(a),e.isMobile||(t.removeAllRanges(),t.addRange(i)),e.focusInput()},this.insertImg=function(e){var t=this;if(t.plainText)return view.insertImg?view.insertImg(_$("textInput"),"[#"+t.emoLan[e]+"#]"):(_$("textInput").value+="[#"+t.emoLan[e]+"#]",_$("textInput").scrollTop=_$("textInput").scrollHeight),void(view.textInputChange&&view.textInputChange());var i="/res/emoji/24/"+e+".png",a=this.getInputDoc(),n=this.getInputDocBody(),s=t.win,o=this.editorType,r=s?s.pos:null;if(3==o&&(s=window,r=t.preRange),a.selection&&!/opera/gi.test(view.chat.Browser.browser)){d='<img class="img-emo" src="'+i+'" border="0" code="'+e+'" unselectable="on"/>';if(r)s.focus(),setTimeout(function(){(r=s.pos||r).move("textedit"),r.pasteHTML(d),r.collapse(!0),r.select(),t.focusInput()},100);else{(d=a.createElement("img")).className="img-emo",d.src=i,d.border="0",d.setAttribute("code",e),d.setAttribute("unselectable","on"),a.getElementsByTagName("body")[0].appendChild(d),n.appendChild(d)}}else if(window.getSelection){var l,d;(d=a.createElement("img")).className="img-emo",d.src=i,d.border="0",d.setAttribute("code",e),d.setAttribute("unselectable","on"),r?((l=s.getSelection()).removeAllRanges(),r.deleteContents(),r.insertNode(d),r.setStartAfter(d),r.setEndAfter(d),this.isMobile||(l.removeAllRanges(),l.addRange(r))):n.appendChild(d),setTimeout(function(){n.scrollTop=d.offsetTop,t.focusInput()},100)}$("#inputPlaceholder").addClass("hide")},this.previewPasteImage=function(e){$("#pasteImg").attr("src",e.base64),$("#pastePreview").removeClass("hide"),$("#maskVerify").removeClass("hide")},this.addPaste=function(e,t){function i(){setTimeout(function(){for(var e=o.getInputDocBody().getElementsByTagName("img"),t=0;t<e.length;t++)e[t].getAttribute("code")||(e[t].parentNode?e[t].parentNode.removeChild(e[t]):e[t].removeNode&&e[t].removeNode(!0))},2)}function a(e){if(view.chat.isInRobot)o.showAlertDialog({tip:lanRes.pasteTip1});else if(i(),!0===o.companyOff||o.busyCanSend&&"0"!=o.queryParams.autoChat||!0===o.chatting)if(e.clipboardData&&e.clipboardData.items){var t=e.clipboardData.items;if(t)for(var a=t.length-1;a>-1;a--)if(-1!==t[a].type.indexOf("image")){var s=t[a].getAsFile(),r=(new Date).getTime()+"."+t[a].type.split("/")[1];!function(e,t){if(t&&e&&e.type.indexOf("image/")>-1){var i=new FileReader;i.onload=function(i){t({file:e,base64:i.target.result})},i.readAsDataURL(e)}else t&&t(null)}(s,function(e){e&&(e.fileName=r,o.previewPasteImage(e))});break}}else setTimeout(n,1)}function n(){function t(){for(var e=o.getInputDocBody().getElementsByTagName("img"),t=0;t<e.length;t++)e[t].src.match(/webkit-fake-url:/i)&&e[t].parentNode.removeChild(e[t])}for(var i,a=o.getInputDocBody().getElementsByTagName("img"),n=0;n<a.length;n++)if(!a[n].getAttribute("code")){i=a[n];break}if(i){var s=i.currentSrc||i.src;s.match(/data:image\/[\w]+;base64/i)?previewPasteImage({base64:s}):s.match(/blob/i)?console.log("blob******************src"):s.match(/webkit-fake-url:/)?(console.log("safari等浏览器 粘贴图片无法发送"),e.removeEventListener("paste",t),e.addEventListener("paste",t)):s.match(/^(http[s]?:\/\/[^\/]+|)\/.+/gi)&&(o.getInputDocBody().innerHTML+=lanRes.picture+":"+s),i.parentNode?i.parentNode.removeChild(i):i.removeNode&&i.removeNode(!0)}}var s,o=this;o.filterPaste(e,t),this.hasPasteCapture=s=o.hasFormData,!window.ltIE10&&s&&"safari"!=view.chat.Browser.browser||setTimeout(function(){$("#inputPlaceholder").attr("placeholder",lanRes.inputPlaceholder2).html(lanRes.inputPlaceholder2)},500),s?(e.addEventListener?(e.addEventListener("paste",a),window.addEventListener("paste",a)):e.attachEvent("onpaste",a),$("#pasteOK").on("click",function(){view.chat.publish("sendVisitorEvent",{et:123,uploadServiceType:o.uploadUtil.getUploadServiceType(),ssl:o.needHttps?1:void 0,ft:5},function(e){e.successful||(o.showTip(lanRes.networkFileError),$("#pasteError").removeClass("hide"),$("#pastePreview").removeClass("hide"),$("#maskVerify").removeClass("hide"))},{resend:!1}),o.captureFileSource=$("#pasteImg").attr("src").split("64,")[1]||o.captureFileSource,$("#pasteError").addClass("hide"),$("#pastePreview").addClass("hide"),$("#maskVerify").addClass("hide")}),$("#pasteCancel").on("click",function(){$("#pastePreview").addClass("hide"),$("#maskVerify").addClass("hide")})):t.addEventListener?t.addEventListener("paste",i):t.attachEvent("onpaste",i)},this.filterPaste=function(e,t){function i(e){return e.getSelection?e.getSelection():e.document.selection}function a(e,t){e.removeAllRanges(),e.addRange(t)}function n(e){e.preventDefault()}function s(s){if(!c.plainText){var u=void 0;try{if(u=e.clipboardData&&e.clipboardData.getData?e.clipboardData.getData("Text"):s.clipboardData.getData("Text")||s.clipboardData.getData("text/plain"))return console.log("获取到了文本，就去按获取到的文本处理",u),c.filterPasteText(s,u,e,t)}catch(e){u=u&&c.filterPasteData(u)||""}return function(e,t){var s=t,u=_$("html_input"),m=u.contentWindow.document;{if(f){var h=m.selection.createRange();if(s)d=s;else{var p=document.getElementById("ifmTemp");p?p.contentWindow.document.body.innerHTML="":((p=document.createElement("IFRAME")).id="ifmTemp",p.style.width="1px",p.style.height="1px",p.style.position="absolute",p.style.border="none",p.style.left="-10000px",p.src="iframeblankpage.html",document.body.appendChild(p),p.contentWindow.document.designMode="On",p.contentWindow.document.open(),p.contentWindow.document.write("<body></body>"),p.contentWindow.document.close()),l=u.contentWindow.document.body.innerText,p.contentWindow.focus(),p.contentWindow.document.execCommand("Paste",!1,null),u.contentWindow.focus(),d="string"==typeof p.contentWindow.document.body.textContent?p.contentWindow.document.body.textContent:p.contentWindow.document.body.innerText,d=c.filterPasteData(d)}return h.pasteHTML(d),e&&(e.returnValue=!1,e.preventDefault&&e.preventDefault()),!1}if(s)return u.contentWindow.document.execCommand("inserthtml",!1,s),e&&(e.returnValue=!1,e.preventDefault&&e.preventDefault()),!1;var g=m.createElement("DIV");g.id="htmleditor_tempdiv",g.innerHTML="\ufeff",g.style.left="-10000px",g.style.height="1px",g.style.width="1px",g.style.position="absolute",g.style.overflow="hidden",m.body.appendChild(g),u.contentWindow.document.addEventListener("mousedown",n,!1),u.contentWindow.document.addEventListener("keydown",n,!1),enableKeyDown=!1,o=u.contentWindow,r=i(o).getRangeAt(0);var v=g.firstChild,b=m.createRange();return b.setStart(v,0),b.setEnd(v,1),a(i(o),b),"\ufeff"===(l="string"==typeof u.contentWindow.document.body.textContent?u.contentWindow.document.body.textContent:u.contentWindow.document.body.innerText)&&(l=""),window.setTimeout(function(){if("\ufeff"===g.innerHTML)return d="",void m.body.removeChild(g);d="string"==typeof g.textContent?g.textContent:g.innerText,r&&a(i(o),r),d=c.filterPasteData(d),g.innerHTML=d,u.contentWindow.document.execCommand("inserthtml",!1,d),m.body.removeChild(g)},1),enableKeyDown=!0,u.contentWindow.document.removeEventListener("mousedown",n,!1),u.contentWindow.document.removeEventListener("keydown",n,!1),!0}}(s,u)}}var o,r,l,d,c=this,f=-1!=navigator.appName.indexOf("Microsoft"),u=document.getElementById("html_input");u&&(f?(u.contentWindow.document.documentElement.attachEvent("onpaste",s),u.contentWindow.document.documentElement.attachEvent("ondrop",c.filterDrop)):(u.contentWindow.document.addEventListener("paste",s,!1),u.contentWindow.document.body.addEventListener("drop",c.filterDrop,!1)))},this.filterDrop=function(t){var i=(t=t||window.event).dataTransfer&&t.dataTransfer.getData("text");if(!i)return t.returnValue=!1,t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation(),!1;i=e.filterPasteData(i,void 0,e.plainText),e.isInrobot&&(i=i.substring(0,e.maxRobotLength));var a=e.getInputDoc(),n=e.getInputDocBody(),s=e.win,o=e.editorType,r=s?s.pos:null;if(3==o)s=window,r=e.preRange;else if(1==o)return void(r=e.textRange);if(a.selection&&!/opera/gi.test(view.chat.Browser.browser)){if(e.plainText?this.focus():s.focus(),!r)return t.dataTransfer.setData("text"),!0;setTimeout(function(){(r=(3==o?e.preRange:1==o?e.textRange:s.pos)||r).pasteHTML(i),r.collapse(!0),r.select()},1)}else if(window.getSelection){var l;if(r)if(1==o)_$("textInput").focus(),document.execCommand("insertText",!1,i);else{var d=a.createElement("div");d.innerHTML=i,(l=s.getSelection()).removeAllRanges(),r.deleteContents(),r.insertNode(d),r.setStartAfter(d),r.setEndAfter(d),e.isMobile||(l.removeAllRanges(),l.addRange(r))}else n.innerHTML+=i;d&&setTimeout(function(){n.scrollTop=d.offsetTop},100)}return t&&(t.returnValue=!1,t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault()),!1}}!function(){var e=function(){function e(e){return e._zid||(e._zid=Z++)}function t(e){C.createElement;var t=C.createElement("div");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function i(e,t,a){var n=t&&t.ownerDocument,a=a||[];return e?e.nodeType||e==window.document||e==window?(this.context=e,this.results=[e],this.length=1,this):q(e)?void 0!==Y?this.readyList.push(e):e():e instanceof i?e:((t?t.ownerDocument||t:S)!==C&&v(t),t=t||C,this.selector=e,this.context=t,this.results=function(e,t,i,a){if(!e)return i;var n,s,o,r,l,d=t?t.nodeType:9;if(r=b.exec(e),11!==d&&r)if(n=r[1]){if(9===d){if(!(o=t.getElementById(n)))return i;if(o.id===n)return i.push(o),i}else if(t.ownerDocument&&(o=t.ownerDocument.getElementById(n))&&g(t,o)&&o.id===n)return i.push(o),i}else{if(n=r[2])return(f=k.find.TAG(n,t))&&N.apply(i,f),i;if((n=r[3])&&_.getElementsByClassName&&t.getElementsByClassName)return N.apply(i,t.getElementsByClassName(n)),i}1!==d&&(a=t,l=e);if(l)try{return N.apply(i,a.querySelectorAll(l)),i}catch(e){}if(!r)return i;var c,f=k.find.TAG("*",t),u=f.length;{if(s=0,c=r[2]){var m=[];if(i=t.getElementsByTagName(c),o=G,"*"===c){for(;o=i[s++];)1===o.nodeType&&m.push(o);return m}return i}for(var h=(0,H.CLASS)(r[3]);s!==u&&null!=(o=f[s]);s++)o&&1===o.nodeType&&h(o)&&i.push(o)}return i}(e,t,a,n),void(this.length=this.results.length)):(this.length=0,this.results=this.results||a,this)}function a(e){return"object"==function(e){return null==e?String(e):W[K.call(e)]||"object"}(e)}function n(e,t,i){for(var a in t)i&&(z(t[a])||V(t[a]))?(z(t[a])&&!z(e[a])&&(e[a]={}),V(t[a])&&!V(e[a])&&(e[a]=[]),n(e[a],t[a],i)):t[a]!==G&&(e[a]=t[a])}function e(e){return e._zid||(e._zid=Z++)}function s(t,i,a,n){function s(t){return t&&(!i.e||t.e==i.e)&&(!i.ns||r.test(t.ns))&&(!a||e(t.fn)===e(a))&&(!n||t.sel==n)}if((i=o(i)).ns)var r=function(e){return new RegExp("(?:^| )"+e.replace(" "," .* ?")+"(?: |$)")}(i.ns);for(var l=ee[e(t)]||[],d=[],c=0;c<l.length;c++)s(l[c])&&d.push(l[c]);return d}function o(e){var t=(""+e).split(".");return{e:t[0],ns:t.slice(1).sort().join(" ")}}function r(e,t){return e.del&&!ie&&e.e in ae||!!t}function l(e){return ne[e]||ie&&ae[e]||e}function d(t,i,a,n,s,d,c){var u=e(t),m=ee[u]||(ee[u]=[]);h.fn.each(i.split(/\s/),function(e,i){if("ready"==i)return h(C).ready(a);var u=o(i);u.fn=a,u.sel=s,u.e in ne&&(a=function(e){var t=e.relatedTarget;if(!t||t!==this&&!h.contains(this,t))return u.fn.apply(this,arguments)}),u.del=d;var p=d||a;u.proxy=function(e){if(!(e=f(e)).isImmediatePropagationStopped()){e.data=n;var i=p.apply(t,e._args==G?[e]:[e].concat(e._args));return!1===i&&(e.preventDefault(),e.stopPropagation()),i}},u.i=m.length,m.push(u),"addEventListener"in t?t.addEventListener(l(u.e),u.proxy,r(u,c)):t.attachEvent("on"+l(u.e),u.proxy)})}function c(t,i,a,n,o){var d=e(t);h.fn.each((i||"").split(/\s/),function(e,i){h.fn.each(s(t,i,a,n),function(e,i){delete ee[d][i.i],"removeEventListener"in t?t.removeEventListener(l(i.e),i.proxy,r(i,o)):t.detachEvent("on"+l(i.e),i.proxy)})})}function f(e,t){return!t&&e.isDefaultPrevented||(t||(t=e),h.each(le,function(i,a){var n=t[i];e[i]=function(){return this[a]=se,n&&n.apply(t,arguments)},e[a]=oe}),(t.defaultPrevented!==G?t.defaultPrevented:"returnValue"in t?!1===t.returnValue:t.getPreventDefault&&t.getPreventDefault())&&(e.isDefaultPrevented=se)),e}function u(e){var t,i={originalEvent:e};for(t in e)re.test(t)||e[t]===G||(i[t]=e[t]);return f(i,e)}function m(){}var h,p,g,v,b=/^(?:#([\w-/_]+)|(\w+)|\.([\w-]+))$/,y=/^[^{]+\{\s*\[native \w/,w=/[\t\r\n\f]/g,I=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,T=/\S+/g,k={find:{},filter:{}},S=window.document,C=window.document,x="echatQuery"+1*new Date,_={},E=[],M=E.slice,N=E.push,D=new RegExp("\\\\([\\da-f]{1,6}"+P+"?|("+P+")|.)","ig"),R=function(e,t,i){var a="0x"+t-65536;return a!=a||i?t:a<0?String.fromCharCode(a+65536):String.fromCharCode(a>>10|55296,1023&a|56320)},P="[\\x20\\t\\r\\n\\f]",L=function(){v()},H={TAG:function(e){var t=e.replace(D,R).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=new RegExp("(^|"+P+")"+e+"("+P+"|$)");return function(e){return t.test("string"==typeof e.className&&e.className||void 0!==e.getAttribute&&e.getAttribute("class")||"")}}};_.getElementsByTagName=t(function(e){return e.appendChild(C.createComment("")),!e.getElementsByTagName("*").length}),(v=function(e){var i,a,n=e?e.ownerDocument||e:S;return n===C||9!==n.nodeType||n.documentElement,C=n,p=C.documentElement,(a=C.defaultView)&&a.top!==a&&(a.addEventListener?a.addEventListener("unload",L,!1):a.attachEvent&&a.attachEvent("onunload",L)),_.attributes=t(function(e){return e.className="i",!e.getAttribute("className")}),_.getElementsByTagName=t(function(e){return e.appendChild(C.createComment("")),!e.getElementsByTagName("*").length}),_.getElementsByClassName=y.test(n.getElementsByClassName),_.getById=t(function(e){return p.appendChild(e).id=x,!C.getElementsByName||!C.getElementsByName(x).length}),_.getById?(k.find.ID=function(e,t){if(void 0!==t.getElementById){var i=t.getElementById(e);return i?[i]:[]}},k.filter.ID=function(e){var t=e.replace(D,R);return function(e){return e.getAttribute("id")===t}}):(delete k.find.ID,k.filter.ID=function(e){var t=e.replace(D,R);return function(e){var i=void 0!==e.getAttributeNode&&e.getAttributeNode("id");return i&&i.value===t}}),_.qsa=y.test(n.querySelectorAll),k.find.TAG=_.getElementsByTagName?function(e,t){return void 0!==t.getElementsByTagName?t.getElementsByTagName(e):_.qsa?t.querySelectorAll(e):void 0}:function(e,t){for(var i,a=[],n=0,s=S.getElementsByTagName(e);i=s[n++];)1===i.nodeType&&g(t,i)&&a.push(i);return a},k.find.CLASS=_.getElementsByClassName&&function(e,t){if(void 0!==t.getElementsByClassName&&documentIsHTML)return t.getElementsByClassName(e)},i=y.test(p.compareDocumentPosition),g=i||y.test(p.contains)?function(e,t){if(!e||!t)return!1;var i=9===e.nodeType?e.documentElement:e,a=t&&t.parentNode;return e===a||!(!a||1!==a.nodeType||!(i.contains?i.contains(a):e.compareDocumentPosition&&16&e.compareDocumentPosition(a)))}:function(e,t){if(!e)return!1;if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},n})();var F=0,B=/(\=)\?(&|$)|\?\?/i;(h=function(e,t,a){return new i(e,t)}).ajaxJSONP=function(e,t){function i(i,n){h(r).remove(),i&&"error"==i.type||!a?e.error&&e.error(null,n||"error",c,e,t):e.success&&e.success(a[0],c,e,t),window[o]=l,a&&q(l)&&l(a[0]),l=a=G}if(!("type"in e))return h.ajax(e);var a,n=window.document,s=e.jsonpCallback,o=(q(s)?s():s)||"jsonp"+ ++F,r=n.createElement("script"),l=window[o],d=function(t){e.errorSwitch?e.errorSwitch():i({type:"error",timeout:1}),h(script).triggerHandler("error",t||"abort")},c={abort:d};t&&t.promise(c);n.getElementsByTagName("head")[0];window[o]=function(){a=arguments};var f="$1"+o+"$2";e.url=e.url.replace(B,f);var u="";if(e.data){for(var m in e.data){var p="string"==typeof e.data[m]?e.data[m]:JSON.stringify(e.data[m]);u="&"+m+"="+encodeURIComponent(p)}u&&(u=u.substring(1),u+="&")}e.url+=(/\?/.test(e.url)?"&":"?")+u+(e.jsonpCB||"jsonp")+"="+o;return"onload"in r?(r.onload=i,r.onerror=function(){i({type:"error"})}):r.onreadystatechange=function(){/loaded|complete/.test(r.readyState)&&i()},e.beforeSend&&!1===e.beforeSend(c)?(console.log("abort",e),c):(r.src=e.url,n.getElementsByTagName("head")[0].appendChild(r),e.timeout>0&&(abortTimeout=setTimeout(function(){d("timeout"),c.isTimeout=1},e.timeout)),c)},h.ajax=h._ajax=function(e){if("jsonp"==e.jsonp||"JSONP"==e.jsonp||"jsonp"==e.type||"JSONP"==e.type)return h.ajaxJSONP(e,e.deferred);var t=function(){var e;try{e=new XMLHttpRequest}catch(n){for(var t=["Msxml3.XMLHTTP","Msxml2.XMLHTTP","Microsoft.XMLHTTP"],i=0,a=t.length;i<a;i++)try{e=new ActiveXObject(t[i]);break}catch(e){continue}}return e}();t.onreadystatechange=function(){4==t.readyState&&(200==t.status?e.success&&e.success(t.responseText):0==t.status&&e.errorSwitch?e.errorSwitch():e.error&&e.error(t,t.responseText))};var i=e.data,a="";if(i&&"[object object]"==Object.prototype.toString.apply(i).toLowerCase())for(var n in i)a+="&"+n+"="+encodeURIComponent(i[n]);a&&e.type.match(/get/i)&&(-1!=e.url.indexOf("?")?e.url+=a:e.url+="?"+a.substring(1),a="",i=null),window.XMLHttpRequest?i||(i=null):i||(i=G),t.open(e.type.toUpperCase(),e.url,!0),e.timeout&&(t.timeout=e.timeout);try{if(e.xhrFields)for(fe in e.xhrFields)t[fe]=e.xhrFields[fe]}catch(e){}if(e.header)for(var s in e.header)t.setRequestHeader(s,e.header[s]);e.header&&(e.header["Content-Type"]||e.header["Content-type"]||e.header["content-type"])&&!1===e.contentType||t.setRequestHeader("Content-type",e.contentType||"application/json;charset=UTF-8;"),e.beforeSend&&e.beforeSend(t),t.send(a?a.substring(1):i)};var A,U=/^-ms-/,O=/-([\da-z])/gi,$=function(e){return e.replace(U,"ms-").replace(O,function(e,t){return t.toUpperCase()})};!function(){var e,t,i;(e=C.createElement("div")).innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",t=(t=(i=e.getElementsByTagName("a")[0])&&i.style).cssText="float:left;opacity:.5",A={float:t.cssFloat?"cssFloat":"styleFloat"},e=null,i=null}();var q=function(e){return null!=e&&("function"==typeof e||"[object Function]"===Object.prototype.toString.call(e))},V=function(e){return"[object Array]"===Object.prototype.toString.apply(e)},j=function(e){return"string"==typeof e},W={},K=W.toString,z=function(e){return a(e)&&!function(e){return null!=e&&e==e.window}(e)&&Object.getPrototypeOf(e)==Object.prototype},J=function(e){return null==e?"":(e+"").replace(I,"")};h.extend=function(e,t,i){for(var a in t)i&&(z(t[a])||V(t[a]))?(z(t[a])&&!z(e[a])&&(e[a]={}),V(t[a])&&!V(e[a])&&(e[a]=[]),n(e[a],t[a],i)):t[a]!==G&&(e[a]=t[a]);return e},h.cookie=function(e,t,i){if(arguments.length>1&&(!/Object/.test(Object.prototype.toString.call(t))||null===t||t===G)){if(i=h.extend({},i),null!==t&&t!==G||(i.expires=-1),"number"==typeof i.expires){var a=i.expires,n=i.expires=new Date;n.setDate(n.getDate()+a)}return t=String(t),C.cookie=[encodeURIComponent(e),"=",i.raw?t:encodeURIComponent(t),i.expires?"; expires="+i.expires.toUTCString():"","; path="+(i.path||"/"),i.domain?"; domain="+i.domain:"",i.secure?"; secure":""].join("")}for(var s,o=(i=t||{}).raw?function(e){return e}:decodeURIComponent,r=C.cookie.split("; "),l=0;s=r[l]&&r[l].split("=");l++)if(o(s[0])===e)return o(s[1]||"");return null},h.toJSON=JSON.stringify;var Q={src:!0,href:!0},X={isFunction:q,isArray:V,isString:j,isObject:a,isPlainObject:z,trim:J,contains:g,readyList:[],find:function(e){var t={};return this.each(function(a,n){i.call(t,e,n,t.results)}),t},match:function(e,t){var a=null;return new i(t).each(function(t,i){if(i==e||g(i,e))return a=i,!0}),a},parents:function(e){var t,a,n,s,o;if(e&&this.results&&this.results.length>0&&(t=b.exec(e))&&((o=t[1])?a=function(e){return e.id==o}:(o=t[2])?(o=o.toUpperCase(),a=function(e){return e.tagName==o}):(o=t[3])&&(a=function(e){if(e.className){for(var t=e.className.split(" "),i=0;i<t.length;i++)if(t[i]==o)return!0;return!1}}),a))for(n=this.results[0];s=n.parentNode;){if(a(s))return new i(s,this.context,[]);n=s}return new i(null,this.context,[])},html:function(e){return e||""===e?this.each(function(t,i){i.innerHTML=e}):this.results&&this.results[0]?this.results[0].innerHTML:null},text:function(e){return"string"==typeof e?this.each(function(t,i){"string"==typeof i.textContent?i.textContent=e:i.innerText=e}):this.results&&this.results[0]?this.results[0].textContent||this.results[0].innerText:null},append:function(e){if(e){if(j(e)){var t=C.createElement("div");t.innerHTML=e;var i=t.childNodes;this.each(function(e,t){for(var a,e=0;a=i[e++];)1==a.nodeType&&(a=a.cloneNode(!0),t.appendChild(a))})}else this.each(function(t,i){i.appendChild(e)});return this}},insertBefore:function(e,t){if(e){var i;if(j(e)){var a=C.createElement("div");a.innerHTML=e;var n=a.childNodes;this.each(function(e,a){for(var s,e=0;s=n[e++];)1==s.nodeType&&(s=s.cloneNode(!0),(i=t||a.childNodes[0])?a.insertBefore(s,i):a.appendChild(s))})}else this.each(function(a,n){(i=t||n.childNodes[0])?n.insertBefore(e,i):n.appendChild(e)});return this}},show:function(){return this.each(function(e,t){t.style.display="block"}),this},hide:function(){return this.each(function(e,t){t.style.display="none"}),this},removeClass:function(e){for(var t,i,a,n,s=this.results.length,o=0,r=0,l=(e||"").match(T)||[];r<s;r++)if(t=this.results[r],i=1===t.nodeType&&(t.className?(" "+t.className+" ").replace(w," "):"")){for(o=0;a=l[o++];)for(;i.indexOf(" "+a+" ")>=0;)i=i.replace(" "+a+" "," ");n=e?J(i):"",t.className!==n&&(t.className=n)}else t.className="";return this},addClass:function(e){for(var t,i,a,n,s=this.results.length,o=0,r=0,l=(e||"").match(T)||[];r<s;r++)if(t=this.results[r],i=1===t.nodeType&&(t.className?(" "+t.className+" ").replace(w," "):"")){for(o=0;a=l[o++];)for(;i.indexOf(" "+a+" ")<0;)i+=a+" ";n=e?J(i):"",t.className!==n&&(t.className=n)}else t.className=e;return this},attr:function(e,t){if(!e)return this;if(void 0===t){if("string"==typeof e)return this.results&&this.results.length>0?this.getAttr(this.results[0],e):"";a=this.results?this.results.length:0;for(var i in e)for(n=0;n<a;n++){s=this.results[n];Q[i]?s[i]=e[i]:s.setAttribute(i+"",e[i])}}else for(var a=this.results?this.results.length:0,n=0;n<a;n++){var s;(s=this.results[n]).setAttribute(e,t),Q[e]?s[e]=t:s.setAttribute(e,t)}return this},css:function(e,t){if(!e)return this;if(void 0===t)if("string"==typeof e)this.css(e,0===t?"0":"inherit");else for(var i=this.results?this.results.length:0,a=0;a<i;a++)for(var n in e){s=$(n);s=A[s]||s;o=this.results[a];try{o.style[s]=e[n]}catch(e){console.log(e.message),console.log("css:"+s+":"+n)}}else try{for(var i=this.results?this.results.length:0,a=0;a<i;a++){var s=$(e);s=A[s]||s;var o;(o=this.results[a]).style[s]=t}}catch(e){return this}return this},remove:function(){for(var e=this.results?this.results.length:0,t=0;t<e;t++){var i=this.results[t];i.parentNode.removeChild(i)}return this.length=0,this.results=[],this},removeAttr:function(e){return this.each(function(t,i){i.setAttribute(e,""),i.removeAttribute(e)})},ready:function(e){for(var t,i=0;this.readyList&&(t=this.readyList[i]);)t.call(window),i++;return this},hasClass:function(e){for(var t=this.results?this.results.length:0,i=[],a=H.CLASS(e),n=0;n<t;n++){var s=this.results[n];a(s)&&i.push(s)}return i.length},max:function(e,t){return e>t?e:t},width:function(){return this.results&&this.results[0]?X.max(this.results[0].offsetWidth,this.results[0].clientWidth):null},height:function(){return this.results&&this.results[0]?X.max(this.results[0].offsetHeight,this.results[0].clientHeight):null},val:function(e){return void 0===e?this.results&&this.results[0]?this.results[0].value:null:(this.results&&this.results[0]&&(this.results[0].value=e+""),this)},getAttr:function(e,t){return e.getAttribute(t)},each:function(e,t){if(V(e))for(i=0;i<e.length&&!t.call(e[i],i,e[i]);i++);else if(q(e)){t=e,e=this.results||[];for(i=0;i<e.length&&!t.call(e[i],i,e[i]);i++);}else for(var i in e)if(t.call(e[i],i,e[i]))break;return this}},Y=function(){function e(){n.removeEventListener("DOMContentLoaded",e,!1),n.removeEventListener("load",e,!1),a()}function t(){"complete"==n.readyState&&(n.detachEvent("onreadystatechange",t),n.detachEvent("onload",i),a())}function i(){n.detachEvent("onreadystatechange",t),n.detachEvent("onload",i),a()}var a=function(){Y&&(X.ready(),Y=G)},n=window.document;if(n.addEventListener)n.addEventListener("DOMContentLoaded",e,!1),window.addEventListener("load",e,!1);else if(n.attachEvent)n.attachEvent("onreadystatechange",t),window.attachEvent("onload",i);else if(n.lastChild==n.body)return a();(n.getElementsByTagName("body")||[]).length>0&&a()};Y(),h.fn=X,h.each=X.each;var G,Z=1,M=Array.prototype.slice,ee={},te={},ie="onfocusin"in window,ae={focus:"focusin",blur:"focusout"},ne={mouseenter:"mouseover",mouseleave:"mouseout"};te.click=te.mousedown=te.mouseup=te.mousemove="MouseEvents",h.event={add:d,remove:c},h.proxy=function(t,i){var a=2 in arguments&&M.call(arguments,2);if(q(t)){var n=function(){return t.apply(i,a?a.concat(M.call(arguments)):arguments)};return n._zid=e(t),n}if(j(i))return a?(a.unshift(t[i],t),h.proxy.apply(null,a)):h.proxy(t[i],t);throw new TypeError("expected function")},h.fn.bind=function(e,t,i){return this.on(e,t,i)},h.fn.unbind=function(e,t){return this.off(e,t)},h.fn.one=function(e,t,i,a){return this.on(e,t,i,a,1)};var se=function(){return!0},oe=function(){return!1},re=/^([A-Z]|returnValue$|layer[XY]$)/,le={preventDefault:"isDefaultPrevented",stopImmediatePropagation:"isImmediatePropagationStopped",stopPropagation:"isPropagationStopped"};h.fn.delegate=function(e,t,i){return this.on(t,e,i)},h.fn.undelegate=function(e,t,i){return this.off(t,e,i)},h.fn.live=function(e,t){return h(C.getElementsByTagName("body")[0]).delegate(this.selector,e,t),this},h.fn.die=function(e,t){return h(C.getElementsByTagName("body")[0]).undelegate(this.selector,e,t),this},h.fn.on=function(e,t,i,a,n){var s,o,r=this;return e&&!j(e)?(h.each(e,function(e,a){r.on(e,t,i,a,n)}),r):(j(t)||q(a)||!1===a||(a=i,i=t,t=G),a!==G&&!1!==i||(a=i,i=G),!1===a&&(a=oe),r.each(function(r,l){n&&(s=function(e){return c(l,e.type,a),a.apply(this,arguments)}),t&&(o=function(e){var i,n=(e=e||window.event).target||e.srcElement,o=X.match(n,t);if(o&&o!==l)return i=h.extend(u(e),{currentTarget:o,liveFired:l}),(s||a).apply(o,[i].concat(M.call(arguments,1)))}),d(l,e,a,i,t,o||s)}))},h.fn.off=function(e,t,i){var a=this;return e&&!j(e)?(h.each(e,function(e,i){a.off(e,t,i)}),a):(j(t)||q(i)||!1===i||(i=t,t=G),!1===i&&(i=oe),a.each(function(){c(this,e,i,t)}))},h.fn.trigger=function(e,t){return e=j(e)||z(e)?h.Event(e):f(e),e._args=t,this.each(function(){e.type in ae&&"function"==typeof this[e.type]?this[e.type]():"dispatchEvent"in this?this.dispatchEvent(e):h(this).triggerHandler(e,t)})},h.fn.triggerHandler=function(e,t){var i,a;return this.each(function(n,o){(i=u(j(e)?h.Event(e):e))._args=t,i.target=o,h.each(s(o,e.type||e),function(e,t){if(a=t.proxy(i),i.isImmediatePropagationStopped())return!1})}),a},h.fn.each("focusin focusout focus blur load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select keydown keypress keyup error".split(" "),function(e,t){h.fn[t]=function(e){return 0 in arguments?this.bind(t,e):this.trigger(t)}}),h.Event=function(e,t){j(e)||(t=e,e=t.type);var i=C.createEvent(te[e]||"Events"),a=!0;if(t)for(var n in t)"bubbles"==n?a=!!t[n]:i[n]=t[n];return i.initEvent(e,a,!0),f(i)},h.fn.autoHeight=function(){this.each(function(){h(this).on("keyup",function(){!function(e){e.style.height="auto",e.style.height=e.scrollHeight+"px"}(this)})})},h.isBoolean=m,h.isDate=m,h.isFunction=m,h.isNaN=m,h.isNumber=m,h.isObject=m,h.isRegExp=m,h.isString=m,h.isUndefined=m;for(var de=h,ce="Array Boolean Date NaN Number Function Object RegExp Undefined".split(" "),fe=0;fe<ce.length;fe++){var ue=ce[fe];de["is"+ue]=function(e){return function(t){return t!=t?"NaN"===e:RegExp(e).test(Object.prototype.toString.call(t))}}(ue)}return i.prototype=h.fn,h}();window.EChatQuery=e}(),function($){void 0===window.ECHATObjKeyMap&&(window.ECHATObjKeyMap={});var UTIL=function(justBase){function _isPointerEventType(e,t){return e.type=="pointer"+t||e.type.toLowerCase()=="mspointer"+t||e.type=="mouse"+t}function _isPrimaryTouch(e){return e.type.indexOf("mouse")>-1||("touch"==e.pointerType||e.pointerType==e.MSPOINTER_TYPE_TOUCH)&&e.isPrimary}this.ECHATConfig={contextPath:"/mychat/visitor"};var _self=this;if(this.bot=/spider|bot/i.test(navigator.userAgent),this.subMap={},this.eventMap={},this.setSub=function(e){this.subMap[e]=e},this.removeSub=function(e){delete this.subMap["string"==typeof e?e:e.KEY]},this.publish=function(e){var t=this.subMap;for(var i in t){var a=ECHATObjKeyMap[i];if(a&&a.eventMap&&a.eventMap[e]){var n=a.eventMap[e];if(this.isArray(n))for(var s=0;s<n.length;s++)n[s],n[s].apply(a,arguments)}}},this.subscribe=function(e,t){this.eventMap[e]?this.eventMap[e].push(t):this.eventMap[e]=[t]},this.unSubscribeAll=function(){this.eventMap={}},this.unSubscribe=function(e){if(this.isArray(e))for(var t=0;t<e.length;t++)delete this.eventMap[e[t]];else delete this.eventMap[e]},this.isArray=function(e){return"[object Array]"===Object.prototype.toString.apply(e)},this.throttle=function(e,t,i){var a,n=Date.now();return function s(o){var r=arguments,l=Date.now();a&&clearTimeout(a),l-n>=t?(e.apply(this,r),n=Date.now()):i&&(a=setTimeout(s,t),o&&o(a))}},this.getQueryString=function(e){var t,i=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),a=location.search.substr(1).match(i);if(null!=a){try{t=decodeURIComponent(a[2])}catch(e){console.log(e.stack)}return t}},this.escapeRegExp=function(e){var t=/[\\^$.*+?()[\]{}|]/g,i=new RegExp(t.source);return function(e){return e&&i.test(e)?e.replace(t,"\\$&"):e}}(),this.addMapParams=function(e){var t=[];for(var i in e)t.push(i+"="+encodeURIComponent(e[i]||""));return t.join("&")},this.packParam=function(e){var t,i="";for(var a in e)(t=0===e[a]||!1===e[a]?e[a]+"":e[a]||"")&&(i+=(i?"&":"")+a+"="+encodeURIComponent(t));return i},this.getQueryParams=function(e){var t={};"string"!=typeof e&&(e=location.search),-1!=e.indexOf("#")&&(e=e.substring(0,e.indexOf("#"))),-1!=e.indexOf("?")&&(e=e.substring(e.indexOf("?")+1));for(var i,a=e.split("&"),n=a.length,s=0;s<n;s++)if(a[s]&&(i=a[s].split("="))[0]&&i[1]){try{t[i[0]]=decodeURIComponent(i[1])}catch(e){console.log(e.stack)}t[i[0].toLowerCase()]=t[i[0]]}if(t.visEvt)try{var o=JSON.parse(t.visEvt);o&&o.eventId&&(t.eventId=o.eventId,t.eventid=o.eventId)}catch(e){}return t},this.findMsgLiByMsg=function(e){return e.mid&&document.getElementById(e.mid)||e.id&&document.getElementById(e.id)||e.identityKey&&document.getElementById(e.identityKey)||e.fileIdentity&&document.getElementById(e.fileIdentity)||e.clientFileId&&document.getElementById(e.clientFileId)},this.queryParams=this.getQueryParams(),this.companyId=this.getQueryString("companyid"),this.getBackground=function(e,t){var i=[],a=parseInt(t||100)/100,n=(e||"rgb(255,255,255)").toLocaleLowerCase().trim();if(0==n.indexOf("rgb"))n=n.replace("rgb","rgba").replace(")",","+a+")");else if(0==n.indexOf("#")){n=n.replace("#","").split("");for(var s=0;s<n.length;s++)3==n.length?i.push(parseInt("0x"+n[s]+n[s])):s%2==0&&i.push(parseInt("0x"+n[s]+n[s+1]));i.push(a),n="rgba("+i.join()+")"}return n},this.hasStorage=function(){var e;try{if(!window.localStorage)return!1;if(window.localStorage.setItem("echt_test_storage","ok"),!(e=window.localStorage.getItem("echt_test_storage")))return!1;e&&window.localStorage.removeItem("echt_test_storage")}catch(e){return!1}return!0}(),this.hasCookie=function(){$.cookie("echt_test_cookie","ok");return!!$.cookie("echt_test_cookie")&&($.cookie("echt_test_cookie",null),!0)}(),$.store=function(e){return e?function(e,t,i){if(!e)return null;try{return arguments.length>1&&(!/Object/.test(Object.prototype.toString.call(t))||null===t||void 0===t)?(i=$.extend({},i),null!==t&&void 0!==t||(i.expires=-1),t=String(t),i.session?window.sessionStorage.setItem(e,t):window.localStorage.setItem(e,t),t):(i=t||{}).local?window.localStorage.getItem(e):i.session?window.sessionStorage.getItem(e):window.localStorage.getItem(e)||window.sessionStorage.getItem(e)||$.cookie(e)}catch(a){try{window.localStorage.removeItem(e),$.store(e,t,i)}catch(e){_self.hasStorage=!1}}}:$.cookie}(this.hasStorage),!justBase){this.checkDomain=function(e,t){function i(e){return e.replace(/^http[s]?:\/\//i,"")}function a(e){var t=e.match(/[.]?([^.]+[.][^.]+)$/);return t?t[1]:i(e)}if(!e||!t||!t.length)return!1;e=a(e);for(var n=0;n<t.length;n++)if(t[n]&&(e==i(t[n])||e==a(t[n])))return!0;return!1},this.getDeviceInfo=function(){function G(){var e=C||D||window.opera;return/mobile|kgbrowser|(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))}function L(){return window.document.documentElement.clientWidth>window.document.documentElement.clientHeight}function R(){return E&&/(iemobile|windows phone)/i.test(C)}function T(){return E&&y.test(D)&&(!z.test(C)||/samsung/i.test(C))}function Y(){var e=window.document.documentElement.clientWidth,t=e/window.document.documentElement.clientHeight>1.2,i=window.screen.width,a=window.screen.height;t&&i<a&&(!0,i=window.screen.height,a=window.screen.width);var n=window.innerWidth,s=e/i;window.devicePixelRatio&&T()&&i>640?s*=window.devicePixelRatio:R()&&(s*=1.5);var o=e/n/s;return o=(o/1.2).toFixed(2),(i/n).toFixed(2)}function Z(){var e=window,t=e.document.documentElement,i=e.document.body,a=null,n={top:0,left:0};if(h(t.getBoundingClientRect)&&(h(e.getComputedStyle)?"relative"==e.getComputedStyle(i).position?a=i:"relative"==e.getComputedStyle(t).position&&(a=t):i.currentStyle?"relative"==i.currentStyle.position?a=i:"relative"==t.currentStyle.position&&(a=t):"relative"==i.style.position?a=i:"relative"==t.style.position&&(a=t)),a){var s=a.getBoundingClientRect();n.top=s.top+e.pageYOffset-t.clientTop,n.left=s.left+e.pageXOffset-t.clientLeft}return n}_self.deviceInfo=F;var b=_self,f=b.indexOf=function(){var e=Array.prototype.indexOf;return"function"==typeof e&&/\[native code\]/.test(e.toString())||(e=function(e){if(null==this)throw new TypeError;var t=Object(this),i=t.length>>>0;if(0===i)return-1;var a=0;if(arguments.length>0&&((a=Number(arguments[1]))!=a?a=0:0!=a&&a!=1/0&&a!=-1/0&&(a=(a>0||-1)*Math.floor(Math.abs(a)))),a>=i)return-1;for(var n=a>=0?a:Math.max(i-Math.abs(a),0);n<i;n++)if(n in t&&t[n]===e)return n;return-1}),function(t,i,a){return e.call(i,t,a)}}(),h=b.isFunction=function(){return function(e){return"function"==typeof e}}(),i=b.isString=function(){return function(e){return"string"==typeof e}}(),q=b.Browser=function(){function $f(e){return e.replace(/^http:/,$a?"https:":"http:")}function $g(){return window.innerHeight!==a?window.innerHeight:document.documentElement?document.documentElement.offsetHeight:document.getElementsByTagName("body").length?document.getElementsByTagName("body")[0].clientHeight:0}function $h(){return window.innerWidth!==a?window.innerWidth:document.documentElement?document.documentElement.offsetWidth:document.getElementsByTagName("body").length?document.getElementsByTagName("body")[0].clientWidth:0}function $o(){var e,t=x.plugins&&x.plugins[$k];if(t)return(e=x.mimeTypes&&x.mimeTypes[$m])&&!e.enabledPlugin?null:t.description;if(window.ActiveXObject)try{return t=new window.ActiveXObject($l),t.AllowScriptAccess="always",t.GetVariable("$version")}catch(e){}}function $p(){var e=x.mimeTypes;return A?!Q&&("javaEnabled"in x&&x.javaEnabled()):e&&(e=e[$n])&&(e=e.enabledPlugin)?e.name:void 0}function $q(){if(!k(S))return S;var e=document.createElement("div"),t=document.createElement("div"),i=e.style,a=t.style;return i.overflow="auto",i.width=i.height="100px",i.position="absolute",i.top="-1000px",a.width="100%",a.height="200px",e.appendChild(t),document.body.appendChild(e),S=e.offsetWidth-e.clientWidth,document.body.removeChild(e),S}function $r(){try{return eval("false")}catch(e){return!0}}function $s(){for(var e=3,t=document.createElement("div"),i=t.getElementsByTagName("i");t.innerHTML="\x3c!--[if gt IE "+ ++e+"]><i></i><![endif]--\x3e",i[0];);return e>4?e:document.documentMode}var x=navigator,y=x.userAgent.toLowerCase(),osVersion=0,z=+(/trident.*rv:? *([0-9]+)/.exec(y)||[])[1]||!1,A=$s(),zz=/edge/.exec(y)||!A&&!!window.StyleMedia||!1,B=8==A,C=7==A,D=6==A,E=window.opera&&"[object Opera]"==Object.prototype.toString.call(window.opera)||/webkit/.test(y)&&(/opr/.test(y)||/opera/.test(y)),F="Google Inc."==navigator.vendor,G="Apple Computer, Inc."==navigator.vendor,H=!A&&(F||G||/webkit|khtml/.test(y)),I=+/\d+/.exec(/firefox\/\d+/i.exec(navigator.userAgent)||""),J=y.indexOf("firefox/2")>-1,K=y.indexOf("firefox/3")>-1,L=-1!=y.indexOf("iphone"),M=-1!=y.indexOf("ipod"),N=-1!=y.indexOf("ipad"),O=L||N||M,Q=-1!=y.indexOf("wp7"),kgBrowser=-1!=y.indexOf("kgbrowser"),meizu=-1!=y.indexOf("mzbrowser"),P=meizu||-1!=y.indexOf("android"),R=O||P||Q||kgBrowser||meizu,S,uc=-1!=y.indexOf("ucbrowser"),liebao=-1!=y.indexOf("lbbroser")||y.indexOf("liebao")>-1,qq=-1!=y.indexOf("qqbrowser"),sogou=-1!=y.indexOf("metasr")||-1!=y.indexOf("sogou"),f360=y.match(/360|qhbrowser|qihoobrowser/i),maxth=-1!=y.indexOf("maxthon"),baidu=-1!=y.indexOf("bidubrowser")||-1!=y.indexOf("baidubrowser")||-1!=y.indexOf("baidu"),weixin=-1!=y.indexOf("micromessenger"),chromeIphone=L&&-1!=y.indexOf("crios"),T=A&&"msie"||I&&"firefox"||E&&"opera"||uc&&"uc"||liebao&&"liebao"||qq&&"qq"||zz&&"edge"||sogou&&"sogou"||f360&&"360"||maxth&&"maxth"||baidu&&"baidu"||weixin&&"weixin"||chromeIphone&&"chrome"||G&&"safari"||F&&"chrome"||H&&"chrome",U,V=A&&!W,W="CSS1Compat"==document.compatMode,X=!W,Y=A&&X&&document.documentElement&&!!document.documentElement.style.setExpression,Z=document.documentMode||A,$$=-1!=y.indexOf("windows")||-1!=y.indexOf("win32"),$_=-1!=y.indexOf("macintosh")||-1!=y.indexOf("mac os x")||-1!=window.navigator.platform.indexOf("Mac"),$a="https:"==document.location.protocol,$b=x.language||x.browserLanguage||x.userLanguage||x.systemLanguage,$c={noBoxSizing:Z<=7,ie:{cssBottomRight:D,cssFixed:D||Y,buggyCSS:D||Y}},$d="textContent"in document.createElement("div"),$e=!1;try{window.CustomEvent&&/\[native code\]/.test(window.CustomEvent.toString())&&(new window.CustomEvent("testevent",{bubbles:!1,cancelable:!0,detail:!0}),$e=!0)}catch(e){}switch(T){case"opera":U=+/\d+/.exec(new RegExp("opr[ /]\\d+").exec(y)||"");break;case"msie":case"firefox":case"chrome":U=U||+/\d+/.exec(new RegExp(T+"[ /]\\d+").exec(y)||"");break;case"baidu":U=+/\d+/.exec(new RegExp("bidubrowser[ /]\\d+").exec(y)||"");break;case"maxth":U=+/\d+/.exec(new RegExp("maxthon[ /]\\d+").exec(y)||"");break;case"qq":U=+/\d+/.exec(new RegExp("qqbrowser[ /]\\d+").exec(y)||"");break;case"liebao":U=+/\d+/.exec(new RegExp("lbbroser[ /]\\d+").exec(y)||"");break;case"uc":U=+/\d+/.exec(new RegExp("ucbrowser[ /]\\d+").exec(y)||"");break;case"sogou":U=+/\d+/.exec(new RegExp("metasr[ /]\\d+").exec(y)||"");break;default:U=+/\d+/.exec(/version[ \/]\d+/.exec(y)||"")}if(O&&(osVersion=+/\d+/.exec(new RegExp("iphone os \\d+").exec(y)||"")),D){var $i=[];$c.leaksMemory=function(e){p.isFunction(e),$i.push(e)};var $j=function(){for(var e=0;e<$i.length;e++)$i[e]()};$c.leaksMemory.remove=function(e){for(var t=$i.length-1;t>=0;t--)e==$i[t]&&$i.splice(t,1)},window.attachEvent("onunload",$j)}var $k="Shockwave Flash",$l="ShockwaveFlash.ShockwaveFlash",$m="application/x-shockwave-flash",$n="application/x-java-vm",$t={browser:T,version:U,osVersion:osVersion,isStrict:W,isQuirks:X,isOpera:E,isSafari:G,isWebKit:H,isChrome:!E&&F,isAndroid:P,isIPhone:L,isIPod:M,isIPad:N,isIOS:O,isWP7:Q,isMobile:R,isEdge:zz,isNewIE:z,isIE:A,isIE6:D,isIE7:C,isIE8:B,isFF:I,isFF2:J,isFF3:K,isBorderBox:V,isCustomEvents:$e,engineIE:Z,bugs:$c,isWindows:$$,isXP:/windows nt 5.1/.test(y),isMac:$_,isLinux:/Linux/.test(navigator.platform),isSecure:$a,secureURL:$f,hasFlash:$o(),hasJava:$p(),language:$b,getScrollbarSize:$q,getWindowClientHeight:$g,getWindowClientWidth:$h,isTextContent:$d,hasCSP:$r()};return $t.isPC=!$t.isMobile&&($t.isWindows||$t.isMac||$t.isEdge||$t.isLinux),$t}(),x=b.__$$__jx_ui_HTMLElement,y=/google inc\./i,z=/chrome/i,A=/apple computer, inc\./i,B=/crios/i,C=window.navigator.userAgent||"",D=window.navigator.vendor||"",F={checkLandscape:L,getZoomLevel:Y,getOffset:Z},E=G();_self.Device=F}();var isMobilePage=window.mobilePage||-1!=location.href.split("?")[0].indexOf("/visitor/mobile/")&&!ECHATObjKeyMap.outerId;_self.Browser.isMobile||isMobilePage||!_self.Browser.isPC?_self.Device.media=2:_self.Device.media=1,_self.Device.OS=this.Browser.isWindows&&"Windows"||this.Browser.isIPhone&&"iPhone"||this.Browser.isIPad&&"IPAD"||this.Browser.isIPod&&"IPOD"||this.Browser.isMac&&"OSX"||this.Browser.isAndroid&&"Android"||this.Device.isWP&&"Windows Phone"||this.Browser.isLinux&&"Linux"||"others",this.hasTranslate=this.Browser.isMobile,this.setTransform=function(e,t){var i="translate("+e+"px,"+t+"px)";_self.hasTranslate?$(this).css({"-webkit-transform":i,"-o-transfrom":i,"-ms-transform":i,"-moz-transform":i,transform:i}):$(this).css({left:e+"px",top:t+"px"})},this.setScale=function(e){var t=this;!function(){var e=_self.deviceInfo.getZoomLevel();(1/e).toFixed(2),window.pageXOffset,window.pageYOffset,window.innerWidth,window.innerHeight,t[0].clientWidth,t[0].clientHeight}()};var _clearSlct="getSelection"in window?function(){window.getSelection().removeAllRanges()}:function(){document.selection.empty()};this.pageSlide=function(e,t){$(e).attr("x","0"),$(document).on("mousedown touchstart",e,function(e){e=e||window.event;var i=!1;if(!(i=_isPointerEventType(e,"down"))||_isPrimaryTouch(e)){e=i?e:e.touches&&e.touches[0]||e;var a={};a.x2=void 0,a.y2=void 0;var n=0,s=0,o=$(this),r=this.parentNode.clientWidth,l=r/8,d=parseInt(o.attr("x")||this.offsetLeft)||0,c=this.clientWidth,f=-c+r-20;a.x1=e.clientX,a.y1=e.clientY,o.removeClass("transition");var u=function(e){e.cancelable=!0,e.preventDefault()};r=parseInt(c/parseInt(c/r)),document.body.addEventListener&&document.body.addEventListener("touchmove",u,{passive:!1});var m=function(e){if(o){e=i?e:e.touches&&e.touches[0]||e,a.x2=e.clientX,a.y2=e.clientY,n=a.x2-a.x1,s=a.y2-a.y1;var t=n+d;t=t>20?20:t<f?f:t,_self.setTransform.call(o,t,0),o.attr("x2",t),_clearSlct(),e.originalEvent&&(e=e.originalEvent),e.cancelable=!0,e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}},h=function(e){if(_clearSlct(),o){o.addClass("transition");var i=0;if(l<Math.abs(n)){parseInt(o.attr("x2"));n>=l&&d+r<=0?(_self.setTransform.call(o,d+r,0),o.attr("x",d+r),i=-1):n<=-l&&d-r+c>r/10?(_self.setTransform.call(o,d-r,0),o.attr("x",d-r),i=1):_self.setTransform.call(o,d,0)}else _self.setTransform.call(o,d,0);var a=t&&t(i);if($(document).off("mousemover mousemove touchmove pointermove",m).off("mouseup touchend pointerup",h),o=null,_clearSlct(),!1===a)return e.stopPropagation&&e.stopPropagation,e.preventDefault&&e.preventDefault(),!1;document.body.removeEventListener&&document.body.removeEventListener("touchmove",u)}};$(document).on("mousemover mousemove touchmove pointermove",m).on("mouseup touchend pointerup",h)}})},this.getCSSRule=function(e,t,i){if(i=i||window.document,e=e.toLowerCase(),i.styleSheets)for(var a=0;a<i.styleSheets.length;a++){var n=i.styleSheets[a],s=0,o=!1;do{if((o=n.cssRules?n.cssRules[s]:n.rules&&n.rules[s])&&o.selectorText&&o.selectorText.toLowerCase()==e)return"delete"==t?(n.cssRules?n.deleteRule(s):n.removeRule(s),!0):o;s++}while(o)}return!1},this.killCSSRule=function(e){return this.getCSSRule(e,"delete")},this.addCSSRule=function(e){return document.styleSheets&&(this.getCSSRule(e)||(document.styleSheets[0].addRule?document.styleSheets[0].addRule(e,null,0):document.styleSheets[0].insertRule(e+" { }",0))),this.getCSSRule(e)},this.addJS=function(e,t){function i(e){a.onload=a.onerror=a.onreadystatechange=null,n.removeChild(a),t&&t(e,a.innerHTML),a=null}var a=document.createElement("script");a.setAttribute("type","text/javascript");var n=document.getElementsByTagName("head")[0];"onload"in a?(a.onload=i,a.onerror=function(){i(!0)}):a.onreadystatechange=function(){/loaded|complete/.test(a.readyState)&&i()},a.src=e,n.appendChild(a)},this.addCSS=function(e){var t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e,t.media="screen";document.getElementsByTagName("head")[0].appendChild(t)},this.base64encode=function(e){var t,i,a,n,s,o,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(a=e.length,i=0,t="";i<a;){if(n=255&e.charCodeAt(i++),i==a){t+=r.charAt(n>>2),t+=r.charAt((3&n)<<4),t+="==";break}if(s=e.charCodeAt(i++),i==a){t+=r.charAt(n>>2),t+=r.charAt((3&n)<<4|(240&s)>>4),t+=r.charAt((15&s)<<2),t+="=";break}o=e.charCodeAt(i++),t+=r.charAt(n>>2),t+=r.charAt((3&n)<<4|(240&s)>>4),t+=r.charAt((15&s)<<2|(192&o)>>6),t+=r.charAt(63&o)}return t},this.iScrollParam={bounce:!this.Browser.isIOS||this.Browser.osVersion<13,preventDefault:!1,preventDefaultException:/^(A|PRE|INPUT|TEXTAREA|BUTTON|SELECT|LABEL)$/,tap:!1,click:!1,mouseWheel:!0,fadeScrollbars:!1},this.parseMsgByRule=function(e,t,i){if(t&&e){var a=this.regFace,n=this.regEmo||new RegExp("\\[#[a-z0-9A-Z]+(_[a-z0-9A-Z]+)*#\\]","g"),s=1,o=t[e.mt||0];return o?o=o.replace(/\$\{([^,]+),?([^,]+)?,?([^,]+)?,?([^,]+)?\}/g,function(t,i,a,n,o){if(s="1"==o?1:0,!a&&!n)return e[i];n=parseInt(n);var r=e[i];return r?(n>0&&r.replace(/\[#([^#]+)#\]/g,function(e,t,i,a){return i<n&&i+e.length>=n?n+=e.length-1:i<n&&(n+=e.length-1),e}),e[i].substring(a,n)):""}):(o=e.content)||(o=t[0]),(s||i&&i.notPlainText)&&(o=function(e,t){return e&&(e+"").replace(/<(?:.|\s)*?>/gi,"").substring(0,t||100)}(o)),a?o&&(o=function(e,t){if(!e)return e;var i=this.emo;return i&&(e=e.replace(a,function(e){arguments[0];var t=e.charCodeAt(0),a=e.charCodeAt(1),n=(a-56320+(t-55296<<10)+65536).toString(16);return i[n]?'<img class="img-emo" src="/res/emoji/32/'+n+'.png" />':i[t+"_"+a]?'<img class="img-emo" src="/res/emoji/32/'+t+"_"+a+'.png" />':e})),e=e.replace(n,function(e){var t=e.replace(/^\[#([\d\w_]+)#\]/g,"$1");return i&&i[t]||!i?'<img class="img-emo" src="/res/emoji/32/'+t+'.png" />':e})}(o)):o&&(o=o.replace(n,"[face]")),o}},this.lastMsgRule={0:"您有新的消息",604:"您的对话已接通",605:"您的对话已结束",621:"给您发送了一个信息填写邀请",622:"给您发送了一个信息填写邀请",640:"${content,0,30,1}",641:"[图片]",642:"[文件]",647:"${content,0,30,1}",648:"等待接入会话，排队位置:${position}",653:"[图片]",657:"[图文消息]",673:"请您对本次服务进行评价",674:"您有新的消息",675:"您有新的消息",676:"您有新的消息",10011:"[图文消息]",864:"${content,0,30,1}",865:"[图片]",866:"[文件]",680:"[链接]"},this.formatUnreadMsg=function(e){var t=this;if(!e.lastMsgContent)return{unreadMsgCount:e.unreadMsgNumber||e.unreadMsgCount||0};var i=this.lastMsgRule;return function(e){this.needHttps&&e.companyLogo&&(e.companyLogo=e.companyLogo.replace(/^http:/,this.needHttps)),void 0!==e.unreadMsgNumber&&(e.unreadMsgCount=e.unreadMsgNumber),e.lastMsg=JSON.parse(e.lastMsgContent),e.msgContent=t.parseMsgByRule(e.lastMsg,i)}(e),{chatUrl:(this.loaderHost||location.origin)+"/visitor/mobile/chat.html?companyId="+e.companyId+"&platformSign="+encodeURIComponent(e.signature)+(this.queryParams.fvMsg?"&fvMsg="+encodeURIComponent(this.queryParams.fvMsg):"")+"&metaData="+encodeURIComponent(this.queryParams.metaData)+"&myData="+encodeURIComponent(this.queryParams.myData),msgId:e.mid,platformId:e.platformId||void 0,companyId:e.companyId,companyLogo:e.companyLogo,companyName:e.companyName,msgContent:e.msgContent,unreadMsgCount:e.unreadMsgCount}},this.sendMsgboxUnread=function(){function e(){n.readySend=$.store(n.readySendName),n.readySend=n.readySend?JSON.parse(n.readySend):{order:[]}}function t(t,i){e();var a=n.readySend.order;if(0===i){if(t.mid&&(n.readySend.lastMid=t.mid),a.length>0){n.readySend[t.mid]=void 0,delete n.readySend[t.mid];for(s=0;s<a.length;s++)a[s]==t.mid&&a.splice(s,1)}}else if(!n.readySend[t.mid]&&(n.readySend[t.mid]=t,n.readySend.order.unshift(t.mid),n.readySend.order.length>10)){for(var s=10;s<a.length;s++)n.readySend[a[s]]=void 0,delete n.readySend[a[s]];n.readySend.order.length=10}$.store(n.readySendName,JSON.stringify(n.readySend))}function i(e){if(e&&(n.queue.push(e),t(e,1)),0!=n.queue.length){var s=$.cookie(n.cookieName);s&&(n.checkTimer||n.timeoutTimer)?n.checkTimer||n.timeoutTimer||(n.timeoutTimer=setTimeout(function(){n.timeoutTimer=null,i()},300)):(!s&&n.checkTimer&&clearTimeout(n.checkTimer),!s&&n.timeoutTimer&&clearTimeout(n.timeoutTimer),a(n.queue.shift()))}}function a(a){if(a){if(e(),n.readySend.lastMid&&n.readySend.lastMid>=a.mid)return i();n.cookieValue=a.mid+"_"+n.pageTag,$.cookie(n.cookieName,n.cookieValue),n.checkTimer=setTimeout(function(){n.checkTimer=null;$.cookie(n.cookieName)==n.cookieValue&&(s(a),$.cookie(n.cookieName,""),t(a,0)),$.cookie(n.cookieName)?n.timeoutTimer=setTimeout(function(){n.timeoutTimer=null,i()},300):i()},200)}}var n={cookieName:"",cookieValue:"",readySendName:"",readySend:{lastMid:"",order:[123],123:{}},queue:[],pageTag:(new Date).getTime(),checkTimer:null,timeoutTimer:null},s=null;return{send:i,queue:n.queue,init:function(e){if(!s&&_self.visitorId){var t;n.cookieName="unreadNewMsg_"+_self.visitorId,n.readySendName="unreadNewMsgMap_"+_self.visitorId,$.cookie(n.readySendName,""),n.cookieValue=$.cookie(n.cookieName),n.readySend=$.store(n.readySendName),n.readySend?n.readySend=JSON.parse(n.readySend):(n.readySend={order:[]},$.store(n.readySendName,'{ "order": [] }')),n.cookieValue&&(t=n.cookieValue.split("_")[0],n.readySend[t]&&a(n.readySend[t])),s=e}}}}(),$(document).on("drag",function(e){return(e=e||window.event).preventDefault&&e.preventDefault(),!1})}};UTIL.prototype.serverAdaptor={fuzzyBrandI18nRes:function(){}},window.SDK||__inline("serverTypeAdaptor.js"),__inline("storeInfo.js"),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.toString().replace(/(^\s+)|(\s+$)/g,"")}),Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var i in t)new RegExp("("+i+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[i]:("00"+t[i]).substr((""+t[i]).length)));return e},window.UTIL=UTIL,"undefined"==typeof console&&(window.console={log:function(e){}})}(EChatQuery),function(e){function t(){d=null,f.last&&(f.el.trigger("longTap"),f={})}function i(){d&&clearTimeout(d),d=null}function a(){o&&clearTimeout(o),r&&clearTimeout(r),l&&clearTimeout(l),d&&clearTimeout(d),o=r=l=d=null,f={}}function n(e){return("touch"==e.pointerType||e.pointerType==e.MSPOINTER_TYPE_TOUCH)&&e.isPrimary}function s(e,t){return e.type=="pointer"+t||e.type.toLowerCase()=="mspointer"+t}var o,r,l,d,c,f={};e(function(){var u,m,h,p,g=0,v=0;"MSGesture"in window&&((c=new MSGesture).target=document.body),e(document).bind("MSGestureEnd",function(e){var t=e.velocityX>1?"Right":e.velocityX<-1?"Left":e.velocityY>1?"Down":e.velocityY<-1?"Up":null;f.el&&t&&(f.el.trigger("swipe"),f.el.trigger("swipe"+t))}).on("touchstart",function(i){(p=s(i,"down"))&&!n(i)||(h=p?i:i.touches[0],i.touches&&1===i.touches.length&&f.x2&&(f.x2=void 0,f.y2=void 0),u=Date.now(),m=u-(f.last||u),f.el=e("tagName"in h.target?h.target:h.target.parentNode),o&&clearTimeout(o),f.x1=h.pageX,f.y1=h.pageY,m>0&&m<=250&&(f.isDoubleTap=!0),f.last=u,d=setTimeout(t,750),c&&p&&c.addPointer(i.pointerId))}).on("touchmove",function(e){(p=s(e,"move"))&&!n(e)||(h=p?e:e.touches[0],i(),f.x2=h.pageX,f.y2=h.pageY,g+=Math.abs(f.x1-f.x2),v+=Math.abs(f.y1-f.y2))}).on("touchend",function(t){(p=s(t,"up"))&&!n(t)||(i(),f.x2&&Math.abs(f.x1-f.x2)>30||f.y2&&Math.abs(f.y1-f.y2)>30?f.el&&(l=setTimeout(function(){f.el&&(f.el.trigger("swipe"),f.el.trigger("swipe"+function(e,t,i,a){return Math.abs(e-t)>=Math.abs(i-a)?e-t>0?"Left":"Right":i-a>0?"Up":"Down"}(f.x1,f.x2,f.y1,f.y2)),f={})},0)):"last"in f&&(g<30&&v<30?r=setTimeout(function(){var t=e.Event("tap");f.el&&(t.cancelTouch=a,f.el&&f.el.trigger(t),f.isDoubleTap?(f.el&&f.el.trigger("doubleTap"),f={}):o=setTimeout(function(){o=null,f.el&&f.el.trigger("singleTap"),f={}},250))},0):f={}),g=v=0)}).on("touchcancel MSPointerCancel pointercancel",a),e(window).on("scroll",a)}),["swipe","swipeLeft","swipeRight","swipeUp","swipeDown","doubleTap","tap","singleTap","longTap"].forEach(function(t){e.fn[t]=function(e){return this.on(t,e)}})}(window.EChatQuery),function(e){var t=new function(i){function a(e){m=!1,e&&(c.publish("chatEnded",e),h=!1),c.unSubscribe(["sendVisitorEvent","visitorCommonEvent"]),c.unSubscribe("restartChat"),c.subscribe("restartChat",function(){view.chat.publish("__callNative",{functionName:"restartChat"})})}function n(e,t,i,a){var n=a?u:f,o=i?i.item:(new Date).getTime(),r=i||{data:e,cb:t,time:o,sending:!0};return!(i&&104!=e.et)&&n.push(r),c.publish("__sendMessage",e,function(i){if(t&&(i.bridgeMsgId=e.bridgeMsgId,t.apply(this,arguments)),i.successful){for(var a=n.length-1;a>-1;a--)if(n[a]&&n[a].time==o){n.splice(a,1);break}s(!1)}else r.sending=!1}),!0}function s(e){var t=e?u:f;if(t.length>0)for(var i,a=0;a<t.length&&((i=t[a]).sending||(i.sending=!0,n(i.data,i.cb,i)));a++);}function o(e){c.unSubscribe(["sendVisitorEvent","visitorCommonEvent"]),c.subscribe("sendVisitorEvent",function(e,t,i){n(t,i,null,!0)}),c.subscribe("visitorCommonEvent",function(e,t,i){n(t,i,null,!1)})}function r(e,t,i){if(console.log(e,t,i),e)try{var a={functionName:e,value:t||""};i&&"function"==typeof i&&(a.callback="callback_"+b,window[a.callback]=function(){console.log("callback***"+a.callback,arguments),i.apply(i,arguments),window[a.callback]=null},b++),window.wkWebkit?window.webkit&&window.webkit.messageHandlers.callEchatNativeConnect.postMessage(JSON.stringify(a)):window.EchatJsBridge&&EchatJsBridge.callEchatNativeConnect(JSON.stringify(a))}catch(e){console.log(e)}}function l(e){return"string"==typeof e?JSON.parse(e+""):e}function d(e,t,i){var a=l(e);if(105==a.et||130==a.et||864==a.mt)a.mt=864,a.tm=a.tm||a.bridgeMsgId,a.f="c",130==a.et&&(a.ff="r"),a.m=0;else if(640==a.mt||641==a.mt||642==a.mt)a.f="s",640==a.mt&&(a.m=0),641==a.mt&&(a.m=2),642==a.mt&&(a.m=1);else if(127==a.et)a.f="c",a.mt=127;else if(12001==a.mt)a.f="r";else{if(104==a.et||644==a.mt||106==a.et||109==a.et)return;10011==a.mt&&(a.f=1==a.mst?"c":2==a.mst?"s":"x")}var n=a.tm||(new Date).getTime();673==a.mt&&"unread"!=i||(t[n]=a,t.order?t.order.push(n):t.order=[n]),649!=a.mt&&604!=a.mt&&600!=a.mt||(t.config?t.config.push(a):t.config=[a])}e.cometd={getStatus:function(){return"sdk"}},UTIL.call(this,!0);var c=this,f=[],u=[],m=!1;this.selfMsg=function(e,t){var i=e;switch("0"==i.id&&(i.id=i.mid),i.mt+""){case"10009":return!1!==i.isForward||c.lastTalkId||(c.lastTalkId=view.chat.talkId,c.lastTalkType=view.chat.isInRobot?3:!0===view.chat.chatting?1:2),!1===i.isForward&&4!=i.type&&10!=i.type&&9!=i.type&&11!=i.type&&view.chat.publish("__chatStatus","exceptionEnd"),i.justConnect=4!=i.type&&10!=i.type,void a(i);case"600":window.chatVisitorId="chatVisitorId"+i.visitorId,window.encryptVID=c.encryptVID=i.encryptVID,c.visitorId=i.visitorId,window.encryptVID=c.companyId=i.companyId,view.chat.initVisitor(),c.publish("setVisitorInfo",i),(i.routeEntranceInfo||i.routeEntranceInfoString)&&(i.routeEntranceInfo=i.routeEntranceInfo||JSON.parse(i.routeEntranceInfoString),c.waitForRouterSelect=!0,c.publish("displayRouterInfo",i)),o(),c.publish("handshakeOk",e),m=!0,c.publish("updateVisitorInfo",i);var n=c.dataHost;window.getCurrentDataHost(function(e){e&&e!=n&&(console.log("切换后 当前使用的域名："+e),e.match(/^http[s]?:\/\/[^\/]+/)&&(e="https://"+e.match(/^http[s]?:\/\/([^\/]+)/)[1],window.dataHost=c.dataHost=view.chat.dataHost=e)),c.apiServerDomain=i.apiServerDomain,c.ajaxQueryUnread&&c.ajaxQueryUnread(i.apiServerDomain)});break;case"671":c.publish("setChatParam",i);break;case"672":c.publish("setRestartTag",i);break;case"649":o(),c.publish("setconfig",i),(!0!==view.chat.chatting||view.chat.isInRobot)&&c.publish("waitingChat",i);break;case"651":case"682":break;case"652":this.publish("getErr",i);break;case"646":this.publish("getChatToken",i);break;default:!t&&c.receiveChat(e,!0)}};var h=!1;this.receiveChat=function(t,i){var n=t;switch("0"==n.id&&(n.id=n.mid),n.mt+""){case"127":case"902":this.publish("sendLocationInfo",n);break;case"658":n.current=!0,this.publish("orderReply",n);break;case"677":case"678":this.publish("startLeave",n);break;case"687":case"691":c.publish("startRobot",n);break;case"686":case"604":c.waitForRouterSelect=!1,function(e){c.publish("startChat",e)}(n),s(!0);break;case"605":return!1!==n.isForward||c.lastTalkId||(c.lastTalkId=view.chat.talkId,c.lastTalkType=view.chat.isInRobot?3:!0===view.chat.chatting?1:2),void((!n.fromHistory||n.fromDB)&&a(n));case"620":return void this.publish("staffState",n);case"640":this.publish("getMsg",n);break;case"641":n.identityKey&&(n.fileIdentity=n.identityKey),!n.clientFileId&&(n.clientFileId=n.identityKey),this.publish("getMsgImg",n);break;case"642":n.identityKey&&(n.fileIdentity=n.identityKey),!n.clientFileId&&(n.clientFileId=n.identityKey),this.publish("getMsgFile",n);break;case"644":this.publish("getMsgTyping",n);break;case"647":this.publish("getSysMsg",n);break;case"648":this.publish("getPosMsg",n);break;case"650":return void this.publish("refreshVerify",n);case"655":n.current=!0,c.publish("getLeaveMsg",n);break;case"864":this.publish("getMsgMine",n);break;case"865":n.identityKey&&(n.fileIdentity=n.identityKey),view.fileMsgs[n.clientFileId]&&(view.fileMsgs[n.clientFileId].sendStatus=4),this.publish("getMsgImg",n);break;case"866":n.identityKey&&(n.fileIdentity=n.identityKey),view.fileMsgs[n.clientFileId]&&(view.fileMsgs[n.clientFileId].sendStatus=4),this.publish("getMsgFile",n);break;case"local":case"local_upload":n.identityKey&&(n.fileIdentity=n.identityKey),n.fileIdentity||(n.fileIdentity=n.clientFileId),2==n.sendStatus||4==n.sendStatus?1==n.fileType?this.publish("getMsgImg",n):this.publish("getMsgFile",n):S.prepareUpload(n);break;case"874":this.publish("getHistory",n);break;case"876":return void this.publish("overLength",n);case"890":this.publish("inviteBook",n);break;case"892":this.publish("inviteBookOK",n);break;case"670":return void c.publish("entryCallback",n);case"673":c.publish("inviteSatisfy",n),e.store("ECHAT_inviteSatisfyId",n.mid);break;case"675":return n.staffName=n.staffName||n.staffNickName,c.publish("getLeaveReply",n),void(h=!1);case"680":c.publish("receiveURL",n);break;case"688":c.publish("receiveForm",n);break;case"959":c.publish("submitForm",n);break;case"923":return void c.publish("updateVisitorInfo",{visitorId:n.newVisitorId,photo:n.metaDataInfo.photo});case"928":return;case"12001":this.publish("getMsgRobot",n);break;case"10011":c.publish("receiveVisEvt",n);break;default:return void(!i&&c.selfMsg(t,!0))}h||(this.publish("removeLoading",n),h=!0)},this.receive=function(){},c.subscribe("restartChat",function(){view.chat.publish("__callNative",{functionName:"restartChat"})}),c.subscribe("_endConnect",function(){a({justConnect:!0})}),c.subscribe("__callNative",function(e,t,i){r(t.functionName,t.value,i)}),c.unSubscribe("__registChatAction"),c.subscribe("__registChatAction",function(e,t){r("registChatAction",t)});var p={},g=0,v=(new Date).getTime()+"";c.subscribe("__sendMessage",function(e,t,i){t.publishAck&&(t.bridgeMsgId=t.publishAck.bridgeMsgId,delete t.publishAck),t.bridgeMsgId?t.isResend=1:t.bridgeMsgId=v+ ++g,r("sendMessage",t),p[t.bridgeMsgId]=i}),c.subscribe("__loadPreHistory",function(e,t,i){r("loadPreHistory",{baseTalkId:c.lastTalkId||"",talkType:c.lastTalkType||""})}),c.subscribe("removeLoading",function(e,t,i){r("removeLoading")});var b=1;window.callEchatJsConnect=function(e){var t=l(e);"isCometdConnect"!=t.functionName&&"msgFromDB"!=t.functionName&&"msgFromUnRead"!=t.functionName&&console.log(">>>callEchatJsConnect:"+JSON.stringify(e)),t.functionName&&S[t.functionName]&&S[t.functionName](t.value)};var y,w,I={600:0,103:0,649:0,109:0,encryptVId:0},T=[],k=!1,S={preparedConnect:function(t){var i=l(t);window.initVisitorInfo,c.dataHost=i.dataHost,c.ajaxQueryUnread=function(t){if("0"==i.isConnect){if(k)return;k=!0;var a="https://"+(t||c.dataHost).replace(/([^\.]+)\./,"$1api.")+"/getVisitorUnReadMsgCount?sdkAppId="+encodeURIComponent(i.appId)+"&sdkAppSecret="+encodeURIComponent(i.appSecret)+"&encryptVId="+encodeURIComponent(i.encryptVId)+"&visitorId="+encodeURIComponent(i.visitorId||""|c.visitorId)+"&metaData="+(i.metaData?encodeURIComponent(i.metaData):"")+"&formData="+(i.formData?encodeURIComponent(i.formData):"");e.ajax({url:a,type:"jsonp",jsonpCB:"jsonpCallback",success:function(t){console.log(t),t&&t.unreadMsgCount>0&&(e("#restartChat").parents(".msg-info").remove(),view.chat.publish("restartChat")),callback},error:function(e){}})}},c.apiServerDomain&&c.ajaxQueryUnread(c.apiServerDomain)},msgFromServer:function(e){if(e){console.log("msgFromServer",e),void 0===c.lastTalkIdFromNative&&(t.publish("__callNative",{functionName:"queryTalkIDs"}),c.lastTalkIdFromNative="");var i=l(e);0===i.mid&&delete i.mid,i.bridgeMsgId&&p[i.bridgeMsgId]?(p[i.bridgeMsgId]&&p[i.bridgeMsgId](i),p[i.bridgeMsgId]=void 0):i.mt||i.encryptVId?(i.encryptVId&&(window.encryptVID=c.encryptVID=view.chat.encryptVID=i.encryptVId,i.companyId&&(c.companyId=view.chat.companyId=i.companyId)),i.mt&&"local"==i.mt&&i.fileType&&(1==i.fileType?i.mt="865":i.mt="866"),i.isForward=!1,c.receiveChat(i)):i.et||i.mt}},msgFromDB:function(i){console.log(i);var a=this;void 0===c.lastTalkIdFromNative&&(t.publish("__callNative",{functionName:"queryTalkIDs"}),c.lastTalkIdFromNative="");var n,s,o,r,d=l(i),f=[],u=("null"==d.chatDetailList?[]:d.chatDetailList)||[],m=u[u.length-1],h=m&&m.talkId||u[u.length-2]&&u[u.length-2].talkId;if("[object Array]"==Object.prototype.toString.call(u)&&0!=u.length){if(console.log("***msgFromDB***",e.extend([],u)),!c.lastTalkIdFromNative&&10009==m.mt){for(b=u.length-2;b>1;b--){if(605==u[b].mt&&u[b].talkId!=h){r=u[b].talkId||i.talkId,n={talkId:r,chatDetailList:u.splice(0,b+1)};break}if(10009==u[b].mt&&u[b].talkId!=h){for(var p=b-1;p>1;p--)if(655!=u[p].mt&&658!=u[p].mt&&u[p].talkId){n={talkId:u[p].talkId,chatDetailList:u.splice(0,b+1)};break}if(1!=p)break}}n&&(n.talkType=c.getTalkType(n.chatDetailList).talkType,setTimeout(function(){a.msgFromHistory(n)},1))}c.lastTalkIdFromNative||605!=m.mt&&10009!=m.mt||(m.isForward=!1,n||c.lastTalkId||(s=c.getTalkType(u),c.lastTalkId=s.talkId,c.lastTalkType=s.talkType));for(var g,v,b=0;b<u.length;b++){if(d=u[b],!o&&(o=d.talkId)&&c.hasPageHandleMsg==o)return;d.isForward="0"!=d.isForward&&d.isForward,d.mt&&644!=d.mt&&10005!=d.mt?(void 0!==I[d.mt]?(649==d.mt&&1==I[d.mt]?d.sdkChatBoxInfo&&f.push(d):(f.push(d),I[d.mt]=1),v=649==d.mt&&d.unreadMsgNumber>0):f.push(d),655!=d.mt&&658!=d.mt||(g=v),I.encryptVId=d.encryptVId||d.encryptVID||I.encryptVId):d.et&&104!=d.et&&1!=I[d.et]&&123!=d.et?void 0!==I[d.et]?(0==I[d.et]&&f.push(d),I[d.et]=1):f.push(d):"local"==d.mt&&(d.identityKey&&(d.fileIdentity=d.fileIdentity||d.identityKey),f.push(d)),d.id&&(d.id=d.mid||d.tm)}f.length&&(c.handleHistoryMsg(f),g&&10009==f[f.length-1].mt&&4==f[f.length-1].type&&setTimeout(function(){view.toggleLeaveToChat(1),e("#restartChat").parents("li").remove()},100)),c.hasPageHandleMsg=o}else c.hasPageHandleMsg=!0},allTalkIdFromHistory:function(e){if(console.log("******allTalkIdFromHistory****",e),c.lastTalkIdFromNative="",e){var t=l(e);if(t&&"null"==t[0]&&t.shift(),!t||!t[0]||1==t.length&&t[0].talkId==view.chat.talkId||t[0].talkId==c.lastTalkId)view.chat.hidePreHistory();else{for(var i=0;i<t.length;i++)t[i].talkIdType;c.lastTalkIdFromNative=t[0]&&t[0].talkId||"",view.chat.showPreHistory()}}else view.chat.hidePreHistory()},msgFromUnRead:function(e){if("null"!=e&&e){var t=l(e);if("[object Array]"==Object.prototype.toString.call(t)){console.log("*****************msgFromUnRead*handle*****************",t),T={};var i,a,n,s,o,r=t.length,f=!0;console.log(t);for(var u=0;u<r;u++)if(i=t[u].chatDetailList||[],a=i.length,o=t[u].talkId,c.lastTalkId||(c.lastTalkId=y=o,c.lastTalkType=w=t[u].lastTalkType,c.lastTalkIdLocked=!0),a){if(u==r-1){"605"!=i[a-1].mt&&"10009"!=i[a-1].mt||(c.hasPageHandleMsg?c.hasPageHandleMsg!=t[r-1].talkId&&S.msgFromDB(t[r-1]):S.msgFromDB(t[r-1]));break}T[o]={talkId:o,talkType:t[u].talkType};for(var m=0;m<i.length;m++)n=i[m],T[o],600!=n.mt&&n.mt,m>3&&600==n.mt&&(f=!1),!(f||671!=n.mt&&109!=n.et&&103!=n.et)||m>3&&600==n.mt||(f&&(12001!=n.mt||3!=n.type||204!=n.result&&205!=n.result||(f=!0)),"649"==n.mt?s=n:"600"==n.mt?(n.routeEntranceInfo=void 0,n.routeEntranceInfoString=void 0,s=null):"670"!=n.mt&&679!=n.mt&&604!=n.mt&&648!=n.mt||(s&&(s.sdkEntranceInfo=void 0),s&&(s.captChaToken=void 0)),d(n,T[o],"unread"));view.chat.showHis(T[o],(t[u].talkType||1)+"_"+o)}}else console.log("msgFromUnRead value 为Array json 格式，兼容多个会话的未读消息",t)}else console.log("msgFromUnRead length:null")},msgFromHistory:function(e){if("null"!=e&&e){var t=l(e);c.lastTalkId=y=t.talkId,c.lastTalkType=w=t.talkIdType||t.talkType,c.lastTalkIdLocked=!0,y==c.lastTalkIdFromNative&&(view.chat.hasPreHis=!1);for(var i={},a=t.chatDetailList||[],n=0;n<a.length;n++)d(a[n],i);console.log("%cmsgFromHistory showHis%c%o","color:green","color:green",i),view.chat.showHis(i,(w||1)+"_"+y)}else view.chat.hidePreHistory()},prepareUpload:function(t){var i=l(t);if(view.chat.isInWorkOrder)return view.prepareAddOrderFile(i);i.id=i.clientFileId,0===i.mid&&delete i.mid,_$(i.clientFileId)&&e("#"+i.clientFileId).remove(),content=view.getMsgSendingFile(i),view.chat.showMsg({id:i.clientFileId,f:"c",media:1,m:3==i.fileType||4==i.fileType?i.fileType:1},content)},uploadKey:function(e){S.prepareUpload({clientFileId:e})},uploadStart:function(e){var t=l(e);if(view.chat.isInWorkOrder)return view.updateOrderFile(t);t.id=t.clientFileId,0===t.mid&&delete t.mid;var i=view.getMsgSendingFile(t),a={1:lanRes.image,2:lanRes.fileHtml,4:lanRes.video,3:lanRes.voice};view.chat.publish("__visitorStartSendMsg","["+a[t.fileType]+"]"),i&&view.chat.updateMsg(t.clientFileId,i)},uploadProgress:function(e){var t=l(e);if(view.chat.isInWorkOrder)return 2==t.sendStatus?view.successOrderFile(t):view.updateOrderFile(t);if(t.id=t.clientFileId,!view.fileMsgs[t.clientFileId]||4!=view.fileMsgs[t.clientFileId].sendStatus){var i=view.getMsgSendingFile(t);i&&view.chat.updateMsg(t.clientFileId,i)}},uploadSuccess:function(e){view.chat.isInWorkOrder&&view.successOrderFile(l(e))},updateLocalMessage:function(e){var t=l(e);view.fileMsgs[t.clientFileId]&&(view.fileMsgs[t.clientFileId]=t)},downloadProgress:function(t){var i=l(t),a=view.fileMsgs[i.clientFileId],n=c.findMsgLiByMsg(i);a&&(a.loadStatus=i.loadStatus),n&&(barInfo=e(".file-load-bar-info",n).results[0],n=e(".msg-file",n).results[0],barInfo&&(1==i.loadStatus?(barInfo.innerHTML="点击打开",view.fileMsgs[i.clientFileId]=e.extend(view.fileMsgs[i.clientFileId],t)):2==i.loadStatus?(barInfo.innerHTML=i.progress+"%",e(".file-load-progress0",n).css("width",i.progress+"%")):3==i.loadStatus?barInfo.innerHTML="点击下载":4==i.loadStatus&&(barInfo.innerHTML='<span class="red">下载失败</span>点击重新下载')),n.className="msg-file file-load-status"+i.loadStatus)},callbackOpenFile:function(e){0==l(e).status&&alert("文件不存在")}};window.echatPageService=S,c.handleHistoryMsg=function(t){console.log("handleHistoryMsg",t);var i,a,n,s=t.length,o=t[s-1],r=!1,l=!0;if(s){if(600!=o.mt&&649!=o.mt||1!=s)if(605==o.mt)r=!0;else if(10009==o.mt)r=!0;else for(a=null,i=0;i<s;i++)o=t[i],i>3&&600==o.mt&&(l=!1),600==o.mt&&(c.companyId=o.companyId,void 0===n?n=i:t[n]=o),i>3&&600==o.mt||!(l||671!=o.mt&&109!=o.et&&103!=o.et)?(t.splice(i,1),i--,s--):(l&&(12001!=o.mt||3!=o.type||204!=o.result&&205!=o.result||(l=!0)),"649"==o.mt?a=o:"600"==o.mt?(o.routeEntranceInfo=void 0,o.routeEntranceInfoString=void 0,a=null):"670"!=o.mt&&"677"!=o.mt&&"678"!=o.mt&&679!=o.mt&&604!=o.mt||(a&&(a.sdkEntranceInfo=void 0),a&&(a.captChaToken=void 0)));else{if(!o.routeEntranceInfoString)return;if(1==s)return S.msgFromServer(o)}var d,f=e.store("ECHAT_inviteSatisfyId"),u=!0;for(f==e.store("ECHAT_inviteSatisfyHandle")&&(u=!1),i=s-1;i>-1;i--)600==(o=t[i]).mt?(o.routeEntranceInfo||o.routeEntranceInfoString)&&i<s-1&&(o.routeEntranceInfo=null,o.routeEntranceInfoString=null):649==o.mt?r&&(o.sdkEntranceInfo=null,o.captChaToken=null):673==o.mt&&(u?f<o.mid?o.del=!0:d?o.del=!0:d=o:o.del=!0);var m=[];for(i=0;i<s;i++)(o=t[i]).del||(o.fromDB=!0,o.fromHistory=!0,670!=o.mt&&(12001==o.mt&&3==o.type&&i<s-2||(105==o.et||130==o.et?o.mt=864:127==o.et&&(o.mt=127),!1===o.isForward&&605!=o.mt&&10009!=o.mt&&m.push[o],"local"==o.mt||"local_upload"==o.mt?view.chat.showMsg({id:o.clientFileId,f:"c",media:1,m:3==o.fileType||4==o.fileType?o.fileType:1},view.getMsgSendingFile(o)):c.selfMsg(o))));if(r&&m.length>1){var h={data:{chatDetailList:m}};c.publish("receiveUnread",h)}}},this.getTalkType=function(e){for(var t,i=e.length-1;i>0;i--){if(t=e[i].talkId||t,604==e[i].mt||648==e[i].mt||647==e[i].mt&&5==e[i].type)return{talkType:1,talkId:t};if(12001==e[i].mt||647==e[i].mt&&10==e[i].type)return{talkType:3,talkId:t};if(647==e[i].mt&&7==e[i].type)return{talkType:2,talkId:t}}for(i=e.length-1;i>0;i--)if(649==e[i].mt&&2==e[i].status)return{talkType:2,talkId:t};return{talkType:2,talkId:t}}};ECHATObjKeyMap.cometdId=t,t.setSub("chatId"),t.setSub("cometdId"),window.initChat=function(){e.store("ECHAT_chatStatus");setTimeout(function(){t.publish("__callNative",{functionName:"pageReady",value:{history:{data:[{mt:"649"},{mt:"604"},{mt:"10001"},{mt:"10011"},{mt:"865"},{mt:"641"},{mt:"10010"},{mt:"647"},{mt:"605"},{mt:"866"},{mt:"642"},{mt:"680"},{mt:"688"},{mt:"959"},{mt:"640"},{mt:"864"},{mt:"655"},{mt:"658"},{mt:"12001"},{mt:"673"},{mt:"648"},{mt:"local"},{et:"127"},{et:"105"},{et:"130"}]}}}),window.setVisitorInfo&&t.publish("__callNative",{functionName:"getVisitorId",callback:"setVisitorInfo"})})},window.retryTime=0}(EChatQuery),function(e,t){function i(t,i){if(t.isMini){var a=e("#content").height();e("#content").css("height",("close"==i?a+40:a-40)+"px")}else t.isMobile&&(e("#container").css(view.SDK?"paddingBottom":"bottom",e("#footer").height()+"px"),view.scrollToBottom&&view.scrollToBottom());view.scrollToBottom&&view.scrollToBottom()}function a(t,i,a){var n="",t=t||_$("entryForm"),s="",o="",r="";if(a?i=t[a]:i&&(a=i.name),1!=i.nodeType){n=[],o=[],r=[];for(var l=0;l<i.length;l++)i[l].checked&&(n.push(i[l].value),o.push(e(i[l]).attr("lb")),r.push(e(i[l]).attr("inputvalue")));s=e(i[0]).parents(".entry2-typeline").attr("lb"),n=n.join(","),o=o.join(","),r=r.join(",")}else if(s=e(i).attr("lb"),n=i.value.replace(/^[\s]+|[\s]+$/gi,""),"SELECT"==i.tagName)for(var d=0;d<i.length;d++)if(i[d].value==n){r=e(i[d]).attr("inputvalue"),o=e(i[d]).text();break}return{val:n,ipt:i,label:s,labelVal:o||n,inputValue:r}}function n(t,i,a,n){var r,l=!0,c=!1;if(1==t.nodeType?r=d[a]||d[t.type]:t.length>1&&t[0]&&(c=!0,t=t[0]),!i&&(t.className.indexOf("req")>-1||e(t).parents(".req").length)){l=!1;f="";f="text"==t.type?lanRes.inputPlease.replace("${inputName}",t.getAttribute("lb")):lanRes.inputPleaseJa2.replace("${inputName}",c?e(t).parents(".entry2-typeline").attr("lb"):t.getAttribute("lb")),_$("leave_tip_con").innerHTML=f}else if(i&&r)if(r.length&&i.length>r.length){l=!1;var f="";f="age"==a?lanRes.ageOverLengthJa.replace("${age}",t.getAttribute("lb")):t.getAttribute("lb")+lanRes.overLength,_$("leave_tip_con").innerHTML=f}else r.p&&!i.match(r.p)&&(l=!1,_$("leave_tip_con").innerHTML=r.msg||lanRes.visitor170+t.getAttribute("lb"));return view.chat.tipTimer&&clearTimeout(view.chat.tipTimer),n?(n&&n(l),l&&t.style?o():s()):l&&t.style?(t.style.borderColor="#FFFFFF",o()):(t.style.borderColor="#FF0000",s()),l}function s(t,i){view.chat.tipTimer&&clearTimeout(view.chat.tipTimer),t&&(_$("leave_tip_con").innerHTML=t),_$("leave_tip").className="leave-tip leave-tip-"+(i||"warn"),view.chat.tipTimer=setTimeout(function(){e("#leave_tip").addClass("tiphide")},3e3)}function o(){view.chat.tipTimer&&clearTimeout(view.chat.tipTimer),e("#leave_tip").addClass("tiphide")}function r(e){for(var t=!0,i=0;i<e.length&&(t=t&&"1"==e[i].configInline);i++);return t?"1":"0"}window._$=function(e){return e&&t.getElementById(e)},window._$s=function(e){return t.getElementsByTagName(e)},window.$=e,window.locationBase=window.locationBase||"",window.onerror=function(e){window.echatDebugConsole&&window.echatDebugConsole.log(e)};var l,d={};String.prototype.analyDomain=function(e){var t=this.toString(),i=[],a=t.indexOf(e);return a>=0?(i[0]=t.substring(0,a),t.substring(a+1)&&(i[1]=t.substring(a+1))):i[0]=t,i};var c=function(){UTIL.call(this),InputHandle.call(this),"undefined"!=typeof HistoryHandle&&HistoryHandle.call(this),this.talkId="",this.KEY="chatId",ECHATObjKeyMap[this.KEY]=this,this.dataObject={staffInfos:{0:{img:"",name:""}},msgInfos:{hasVipHistory:!1,recentTalkId:"",currentPrevTalkId:""}},this.setSub(this.KEY),this.setSub("cometdId"),this.setSub("viewId"),this.errorList={},this.regFace=new RegExp("\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]|[#-®]|[‼-㊙]","g"),this.regEmo=new RegExp("\\[#[a-z0-9A-Z]+(_[a-z0-9A-Z]+)*#\\]","g"),this.unescapeSend=new RegExp("<d>","g");this.isMobile=2==this.Device.media||view.SDK||"xcx"==this.queryParams.launchfrom,this.isPcXcx=1==this.Device.media&&"xcx"==this.queryParams.launchfrom,this.isIOS=this.Browser.isIOS,this.isMini=!this.isMobile&&2==view.windowType,this.disableSoundTip=1==this.queryParams.disableSoundTip||view.SDKNative,this.plainText=!0,this.editorType=1,this.hasStorage&&(this.tempReferrer=this.hasStorage?e.store("echat_temp_referrer"):"",window.localStorage.removeItem("echat_temp_referrer")),"https:"==location.protocol||window.SDK?this.needHttps="https:":this.needHttps="",this.initVisitor(),this.init(),this.initBridge(),this.postMessage("miniReady"),this.setChatbox=function(t,i){if(i){var a="ECHAT_"+view.chat.companyId+"_"+t,n=JSON.stringify({chatStaffBackColor:i.chatStaffBackColor,chatStaffTxtColor:i.chatStaffTxtColor,chatVisitorBackColor:i.chatVisitorBackColor,chatVisitorTxtColor:i.chatVisitorTxtColor,sysMsgBackground:i.sysMsgBackground,sysMsgFontColor:i.sysMsgFontColor});i&&e.store(a,n,{path:"/",expires:365}),this.isIOS&&2==view.windowType&&this.postMessage({type:"updateLocalChatbox",key:a,value:n})}},this.getChatbox=function(t){var i=e.store("ECHAT_"+view.chat.companyId+"_"+t);return i&&JSON.parse(i)},this.addEchatInnerFrameParam=function(e){if(e){if(-1!=e.indexOf("&echatInnerFrame=1")||-1!=e.indexOf("?echatInnerFrame=1"))return e;var t=e.split("#"),i=t[1]||"",a=t[0];return a+((-1==a.indexOf("?")?0:1)?"&":"?")+"echatInnerFrame=1"+(i?"#":"")+i}},this.addFixedParam=function(e){if(!e||!view.echatSourceTagEnable||e.match(/^(mailto|tel|javascript):/i))return e||"";var t,i=new RegExp("(^|&)echatSourceTag=([^&]*)(&|$)","i"),a=e.analyDomain("?"),n="echatSourceTag="+(this.echatSourceTag||"");return t=(a[1]||a[0]).analyDomain("#"),t[0].match(i)?e:e=a.length>1?a[0]+"?"+t[0]+"&"+n+(t.length>1?"#"+t[1]:""):t[0]+"?"+n+(t.length>1?"#"+t[1]:"")}};c.prototype={replaceHtml:function(e){return e&&(e=(e+"").replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[face]")),e},initBridge:function(){var i=this,a=i.replaceHtml,n=new function(e,t,i){if(e&&i&&"function"==typeof i){var a=window,n=e;return a.addEventListener?(a.addEventListener("message",function(e){i(e,e.data)}),this.send=function(e){if(e&&t&&2==view.windowType&&window.top!=self)try{n.postMessage(e,t||"*")}catch(e){console.log(e)}}):this.send=function(){console.log("不支持 postMessage")},this}}(parent,i.queryParams.fromhost||(i.tempReferrer||t.referrer||"").split("/").slice(0,3).join("/"),function(e,t){i.publish("getCrossMessage",e)});this.subscribe("__chatStatus",function(a,s){i.outerChatStatus=s,n.send({act:100,eventAction:"chatStatus",eventLabel:s||""}),view.SDK&&e.store("ECHAT_chatStatus",s),"chatting"===s&&(!i.msg649.chatSmallBoxInfo&&!i.msg649.chatBoxInfo||i.msg649.chatSmallBoxInfo&&1==i.msg649.chatSmallBoxInfo.leftTopShowType||i.msg649.chatBoxInfo&&1==i.msg649.chatBoxInfo.enableQRCode)||"robot"===s&&(!i.msg649.robotSmallChatBox&&!i.msg649.robotPCChatBox||i.msg649.robotPCChatBox&&1==i.msg649.robotPCChatBox.enableQRCode||i.msg649.robotSmallChatBox&&1==i.msg649.robotSmallChatBox.leftTopShowType)?e("#qcode").show():e("#qcode").hide();var o=t.getElementsByTagName("body")[0],r=o.className;r=r.replace(/chatstatus-[^\s]+/gi,""),s&&(r+=" chatstatus-"+s),o.className=r}),this.subscribe("__staffStatus",function(e,t){n.send({act:100,eventAction:"staffStatus",eventLabel:t||""})}),this.subscribe("__chatStart",function(e,t){n.send({act:200,eventAction:"Served by Agent",eventLabel:t||""})}),this.subscribe("__chatQueue",function(e,t){n.send({act:100,eventAction:"queuePostion",eventLabel:t||""})}),this.subscribe("__chatStaffInfo",function(e,t){n.send({act:100,eventAction:"chatStaffInfo",eventLabel:JSON.stringify(t)})}),this.subscribe("__newMsg",function(e,t){var i=t.m;"s"==t.f&&t.c&&n.send({act:100,eventAction:"newMsg",eventLabel:0==i?a(t.c):1==i?"[file]":2==i?"[image]":""}),"r"==t.f&&(t.answer||t.c)&&n.send({act:100,eventAction:"newMsg",eventLabel:a(t.answer||t.c)})}),this.subscribe("__newSysMsg",function(e,t){var i=t.m;t.c&&n.send({act:100,eventAction:"newSysMsg",eventLabel:0==i?a(t.c):1==i?"[file]":2==i?"[image]":""})});var s=["","angry","unsatisfied","ok","satisfied","perfect"];this.subscribe("__evaluate",function(e,t,a){n.send({act:100,eventAction:"visitorEvaluate",eventLabel:t||""});var o=t.split("-");0==o[0]?n.send({act:200,eventAction:"Chat_Evaluate_Cancel",eventLabel:1==o[1]?"chatting":"end"}):n.send({act:200,eventAction:"Chat_Evaluate_"+s[i.evaluateScore-0],eventLabel:1==o[1]?"chatting":"end"})}),this.subscribe("__evaluateComment",function(e,t){n.send({act:200,eventAction:"Chat_Comment_submit",eventLabel:t.chatting?"chatting":"end"})}),this.subscribe("__visitorHide",function(e,t){n.send({act:100,eventAction:"visitorHide",eventLabel:t||""})})},initVisitor:function(){d={email:{p:/^[\w\d_\-\.]+@.+[\.].+/gi,msg:lanRes.invildEmail,length:50},phone:{p:/^[0-9\-]{0,20}$/,msg:lanRes.invildPhone,length:20},age:{p:/^[1-9][\d]{0,2}$/gi,msg:lanRes.invildAge,length:3},qq:{p:/^[1-9][\d]+$/gi,msg:lanRes.invildQQ,length:50},date:{p:/^[\d]{4}[-\/][\d]{2}[-\/][\d]{1,2}/gi,msg:lanRes.invildDate,length:50},address:{length:255},name:{length:50},wechat:{length:50},nickName:{length:50},birthday:{length:20},content:{length:1e3},memo:{length:255},textarea:{length:500},text:{length:100},number:{p:/^\-?\d*$/,length:50}},this.dataHost=window.dataHost,e("#inputLengthTip").html(lanRes.inputLengthTip1+" 30 "+lanRes.inputLengthTip2),view.SDK||(window.chatVisitorId&&e.cookie("ECHAT_"+window.companyId+"_chatVisitorId",chatVisitorId),window.encryptVID&&(e.cookie("ECHAT_"+window.companyId+"_encryptVID",encryptVID),this.encryptVID=encryptVID))},init:function(){function a(t,i){l.oldBodyEnterText;var a=l.getInput(!1),n=t.target||{},s=n.innerHTML||"";if(t.clipboardData){t.clipboardData.getData("text");t.clipboardData.items[0].getAsString(function(t){var o=i-a.length;(a=l.getInput(!1)).length>=i&&(n.innerHTML=s+t.substr(0,o),e("#inputLengthTip").html(lanRes.inputLengthTip1+" 0 "+lanRes.inputLengthTip2))})}else setTimeout(function(){(a=l.getInput(!1)).length>i?n.innerHTML=s:l.oldBodyEnterText=a,e("#inputLengthTip").html(lanRes.inputLengthTip1+"&nbsp;"+(i-l.oldBodyEnterText.length)+"&nbsp;"+lanRes.inputLengthTip2)})}function o(e){for(var t,i,a=view.chat,n=function(){for(var e=view.tempPlusFilePath,t=0;t<e.length;t++)if(0==e[t].status)return e[t].status=1,e[t]}(),s=n.path,o=a.fileUploadInfos["uploadServiceType"+e.uploadServiceType]||e,r={},l=a.needHttps?o.fileUploadHttpsUrl:o.fileUploadUrl,d=e.qiniuKey||e.token||e.aliyunKey&&e.aliyunKey.match(/\/([^\/]+$)/)[1],c=null,f={},u=o.fileUploadParam.split(","),m=0;m<u.length;m++)r[u[m].split("=")[0]]=(c=u[m].match(/\$\{([^\}]+)\}/))?e[c[1]]:u[m].split("=")[1];i=s.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1"),t=plus.uploader.createUpload(l,{method:"POST",priority:100},function(t,i){200==i?function(){for(var e=view.tempPlusFilePath,t=0;t<e.length&&e[t].path!=s;t++);view.tempPlusFilePath.splice(t,1)}():403!=i?(n.status=0,a.resendFile(e,d)):a.publish("getErr",{reqInfo:d,code:-2})});for(var h in r)"Content-Disposition"!=h&&"x:filename"!=h||(r[h]=i,window.plus&&t.addData(h,i)),f[h]=r[h],t.addData(h,r[h]);t.addFile(s,{key:"file",name:i}),t.start(),_$(d)||a.showMsg({id:d,f:"c"},'<div class="file-sending">'+lanRes.fileSending+"</div>")}var l=this;if(view.initViewEvent(this),l.filterMsg=view.hasNative&&l.queryParams.fvMsg,l.showTip=s,l.checkIpt=n,l.defaultVisitorImg=locationBase+"/res/imgs/visitor.png",l.defaultStaffImg=locationBase+"/res/imgs/staff.png",this.paramChat={companyId:l.companyId,visitorId:l.visitorId,firstTitle:l.queryParams.firstTitle||"",firstUrl:l.queryParams.firstUrl||"",referrer:l.queryParams.referrer||"",chatPage:l.queryParams.enterUrl||l.tempReferrer||t.referrer||"",chatPageTitle:l.queryParams.enterTitle||"",metaData:l.queryParams.metadata||"",formData:l.queryParams.formdata||"",myData:l.queryParams.myData||"",info:l.queryParams.info||"",echatTag:l.queryParams.echattag||"",lan:window.lanName,visEvt:l.queryParams.visEvt||"",eventId:l.queryParams.eventId||"",acdStaffId:l.queryParams.acdStaffId||"",acdType:l.queryParams.acdType||"",media:view.windowType||"",staffId:this.staffId||"",staffName:this.staffName||"",talkId:this.talkId||"",multipleFile:l.queryParams.multipleFile||0},window.initVisitorInfo){for(var d in window.initVisitorInfo)this.paramChat[d]=window.initVisitorInfo[d];try{var c="string"==typeof window.initVisitorInfo.visEvt?window.initVisitorInfo.visEvt:JSON.parse(window.initVisitorInfo.visEvt);c&&c.eventId&&(this.paramChat.eventId=c.eventId)}catch(e){}}this.subscribe("setConfig",function(t,i){var a;l.isInRobot?a=view.SDK?i.robotSdkChatBox:l.isMobile?i.robotPhoneChatBox:2==view.windowType?i.robotSmallChatBox:i.robotPCChatBox:(i.chatBoxInfo||i.chatSmallBoxInfo||i.mobileChatBoxInfo||i.sdkChatBoxInfo,a=view.SDK?i.sdkChatBoxInfo:l.isMobile?i.mobileChatBoxInfo:2==view.windowType?i.chatSmallBoxInfo:i.chatBoxInfo),view.echatSourceTagEnable=i.echatSourceTagEnable?parseInt(i.echatSourceTagEnable||0):0,view.hasSetAD&&(view.hasSetAD=!1,view.canSetAD=1),a&&(a.chatBoxTitle&&(view.pageTitle=a.chatBoxTitle,view.titles&&(view.titles[1]=a.chatBoxTitle),l.changeDocTitle(a.chatBoxTitle),view.setDocumentTitle&&view.setDocumentTitle("c")),l.defaultStaffImg=a.defaultStaffImg||l.defaultStaffImg,l.defaultVisitorImg=a.defaultVisitorImg||l.defaultVisitorImg,l.needHttps&&(l.defaultStaffImg=l.defaultStaffImg.replace(/^http:/,l.needHttps),l.defaultVisitorImg=l.defaultVisitorImg.replace(/^http:/,l.needHttps)),l.busyCanSend="1"!=a.busyNotAllowSendStatus,e("#busyTip").html((a.busyNotAllowTips||"").replace(/(<p>|<\/p>)/gi,"")),e("#busyTipLine").addClass("hide").hide(),view.setConfig(l,i,a),Number(a.toolEmoji)?e(".menu-emo").removeClass("style-tool-hide"):e(".menu-emo").addClass("style-tool-hide"),Number(a.toolFile)?e(".menu-file").removeClass("style-tool-hide"):e(".menu-file").addClass("style-tool-hide"),Number(a.toolSatisfaction)?e(".menu-satisfy").removeClass("style-tool-hide"):e(".menu-satisfy").addClass("style-tool-hide"),Number(a.toolScreenshot)?e(".menu-capture").removeClass("style-tool-hide"):e(".menu-capture").addClass("style-tool-hide"),Number(a.toolTelephone)?e(".menu-phone").removeClass("style-tool-hide"):e(".menu-phone").addClass("style-tool-hide"),Number(a.toolCamera)?e(".menu-camera").removeClass("style-tool-hide"):e(".menu-camera").addClass("style-tool-hide"),Number(a.toolLocation)?e(".menu-map").removeClass("style-tool-hide"):e(".menu-map").addClass("style-tool-hide"),Number(a.toolVoice)?e(".record-switch").removeClass("style-tool-hide"):e(".record-switch").addClass("style-tool-hide")),l.toolScreenshot=Number(a?a.toolScreenshot:0)||0,l.leaveWordInfo=i.leaveWordInfo||i.mobileLeaveWordInfo||l.leaveWordInfo}),l.subscribe("sendLocationInfo",function(e,t){l.showLocation(t)}),l.leaveMsgMap={},l.subscribe("getLeaveMsg",function(i,a,n){a.realTalkId||(a.realTalkId=a.newsMsgId,a.fromHistory&&!a.current||(a.talkId=l.talkId||a.chatInfoType+"_"+a.newsMsgId));var s='<li class="clearfix '+(1==a.read?"":"fold")+'" talkid="'+a.talkId+'" id="msg'+a.tm+'"><div class="msg-leave" k="'+a.signature+'"><div class="msg-leave-title"><i class="msg-leave-i"></i>'+(a.staffNickName?'<span class="color0 msg-leave-name">'+a.staffNickName+"&nbsp;</span>":'<span class="msg-leave-name">'+lanRes.serviceStaff+"&nbsp;</span>")+'<span class="msg-leave-t">'+(4==a.chatInfoType?lanRes.staffLeave:lanRes.leaveStaffReply)+'</span></div><div class="msg-leave-con" ><div class="msg-leave-content">'+l.filterEmo(l.HTMLDecode(a.brief))+'</div><div class="msg-leave-dot">...</div><div class="msg-leave-link color0">'+lanRes.viewAll+"</div></div></div></li>",o=t.createElement("ul");o.innerHTML='<li class="clearfix" ><div class="color1 tc">'+l.getTimeStr(a.tm)+"</div></li>"+s;for(var r,d=this.getListMsgEl(a.talkId,a.tm,!!a.current),c=o.childNodes,f=0;r=c[f++];)1==r.nodeType&&(r=r.cloneNode(!0),d.appendChild(r));var u=e("#msg"+a.tm+" .msg-leave-title").results[0].offsetWidth,m=e("#msg"+a.tm+" .msg-leave-i").results[0].offsetWidth,h=e("#msg"+a.tm+" .msg-leave-t").results[0].offsetWidth,p=e("#msg"+a.tm+" .msg-leave-name").results[0].offsetWidth;if(p>u-h-m&&(p=u-h-m,e("#msg"+a.tm+" .msg-leave-name").attr("style","width:"+p+"px")),c=null,o=null,view.scrollToBottom(null,{transitionDuration:100,timeout:100}),a.current){if(a.f=n?"r":"s",a.c=a.brief,delete a.content,delete a.current,3==a.chatInfoType){var g,v="3_"+a.newsMsgId,b=l.updateHistoryComplete(v);b&&b[v]?((g=e.extend({},a)).talkId=a.newsMsgId,g.talkTypeId=v,l.pushHistory(g)):l.pushHistory(a),e(d).addClass("new-leave")}else a.talkId=a.newsMsgId,a.talkTypeId=a.chatInfoType+"_"+a.newsMsgId,l.pushHistory(a);d=null,l.handleNewMsgMid(a.mid,{c:a.brief,f:"s",m:0},!0,a),!l.isMobile&&view.setDocumentTitle&&view.setDocumentTitle("s")}l.leaveMsgMap[a.signature]=a}),l.subscribe("overLength",function(){s(lanRes.overLength)});view.chat.Browser.isAndroid&&navigator.userAgent.indexOf("baiduboxapp");e("#enter_btn").on(l.isMobile&&!l.isPcXcx?"touchend":"click",function(e){l.publish("_sendMsg");try{3==l.editorType?window.getSelection().empty():2==l.editorType&&l.win.getSelection().empty()}catch(e){}l.isMobile&&"qq"!=l.Browser.browser&&"weixin"!=l.Browser.browser&&"uc"!=l.Browser.browser&&(view.hideMenus(),l.getInputDocBody().blur(),view.inputBlur&&view.inputBlur(e))}),l.loadConsole=function(e){l.loadConsole=void 0,l.addJS(__uri("/visitor/common/lib/vconsole.js"),function(e){var t=window.console;new VConsole;t.log("location.href",location.href),t.log("msg600::",l.msg600),t.log("msg649::",l.msg649),l.subscribe("echatLog",function(e,t,i){window.console.log(t,i)})})},l.visitorCloseFunc=function(t){function i(){l.visitorClose=!0,l.publish("_endChat"),l.leaveAndClose?(l.publish("_endConnect"),l.publish("_closeWin")):l.isInWorkOrder?(l.publish("_endConnect"),l.publish("_closeWin"),e("#loading").show()):l.hasEntryOrCode||"0"==l.queryParams.autoChat?(l.publish("entryCallback",{success:!0}),l.publish("_endConnect"),l.publish("chatEnded",{closeReason:1}),l.publish("__visitorCloseCallback",{type:"close",memo:"信息收集/验证码,访客确认关闭"}),l.publish("__chatStatus","end-1-0"),l.publish("_closeWin")):ECHATObjKeyMap.cometdId.waitForRouterSelect?(l.publish("_endConnect"),l.publish("__visitorCloseCallback",{type:"close",memo:"咨询入口选择时,访客确认关闭"}),l.publish("__chatStatus","end-1-0"),l.publish("_closeWin")):l.outerChatStatus&&l.outerChatStatus.match(/waiting|chatting|leaveToService/)?l.publish("__visitorCloseCallback",{type:"wait",memo:"等待H5发送结束指令,Native将根据结束状态决定关闭view"}):(l.publish("__visitorCloseCallback",{type:"close",memo:"根据状态发现对话没有建立,访客确认关闭"}),l.publish("__chatStatus","end-1-0"))}if(l.visitorClose=!0,!1!==l.chatting&&"disconnected"!=EChatQuery.cometd.getStatus()||l.isInWorkOrder&&!(l.isInWorkOrder&&l.msg649.unreadMsgNumber&&parseInt(l.msg649.unreadMsgNumber))){if(1===t||!l.outerChatStatus||"registerChat"==l.outerChatStatus)return i();l.showDialog({tip:l.isInWorkOrder?lanRes.visitor188:lanRes.closeTip,ok:i,cancel:function(){l.visitorClose=!1,l.publish("__visitorCloseCallback",{type:"cancel",memo:"访客取消关闭"})}})}else l.publish("__visitorCloseCallback",{type:"close",memo:"对话已经结束/连接已经断开,可直接销毁"}),l.publish("_closeWin")},e(".action-close").on("click",l.visitorCloseFunc),e("#pre_his").on("click",function(){l.loadHistory()}),e("#inputPlaceholder").on("mouseover touchstart",function(){e(this).addClass("hide")}),this.subscribe("_endChat",function(e,t){l.publish("sendVisitorEvent",{et:107},function(){}),l.postMessage(3)}),e("#changelang").on("change",function(e){switch(parseInt(this.value)){case 0:lanResName="zhcn";break;case 1:lanResName="enus";break;case 2:lanResName="jp";break;default:lanResName="zhcn"}var i=t.createElement("script"),a=_$("langScript"),n=a.parentNode;i.id="langScript",i.src=supportLang[lanResName],n.replaceChild(i,a)}),e(t).on("click",".resend",function(){if(!view.handleNetwok||!view.handleNetwok()){var t=e(this).attr("dataid"),i=l.errorList[t];if(i.id=t,i.m=i.m||0,i.f=i.f||"c",i.c=i.c||i.content,!1!==l.chatting&&void 0!==l.chatting)if(l.isInRobot&&7==i.m)l.showTip(lanRes.visitor171);else{var a=_$(t);(a=a.previousElementSibling)&&a.childNodes[0]&&-1!=(a.childNodes[0].className+"").indexOf("color1")&&e(a).remove(),e("#"+t).remove(),l.sendToServer(i)}else 7==i.m?l.showTip(lanRes.visitor171):l.showTip(lanRes.visitor172)}}).on("click",".btn-restart",function(){view.handleNetwok&&view.handleNetwok()||("restartChat"==e(this).attr("id")&&setTimeout(function(){l.publish("restartChat")},10),e(".btn-restart").removeAttr("id").removeClass("btn-restart"),e(this).removeAttr("id").removeClass("btn-restart").text(lanRes.chatContinued))}),this.subscribe("displayRouterInfo",function(t,i){var a,n=i.routeEntranceInfo;a="string"==typeof n.entranceDetails?JSON.parse(n.entranceDetails):n.entranceDetails,n.chatBoxTitle?(view.pageTitle=n.chatBoxTitle,l.changeDocTitle(n.chatBoxTitle),l.publish("__setTitle",n.chatBoxTitle)):l.publish("__setTitle",lanRes.onlineService);var s=n.routeStatusList,o={};if(s&&s.length)for(var r=0;r<s.length;r++)o[s[r].routeId]=2!=s[r].routeStatus;for(var d='<div id="routerTitle" class="router-title '+(n.title?"":"router-hide")+'">'+n.title+'</div><div id="routerList" class="router-list"><ul class="clearfix">',c=0,f=n.lines,u=n.chosenColor||"#0da7db",m=0;m<a.length;m++){var h=a[m].routeId;if(h){c++,o[h]||(a[m].icon=a[m].offlineIcon||a[m].icon,a[m].content=a[m].offlineContent||a[m].content);var p=c%f==0;l.needHttps&&a[m].icon&&(a[m].icon=a[m].icon.replace(/^http:/,l.needHttps));d+='<li class="router-item router-item-content'+(a[m].icon&&!a[m].content?1:a[m].icon&&a[m].content?2:!a[m].icon&&a[m].content?3:a[m].icon||a[m].content?"":3)+'" data="'+h+'" dataindex="'+m+'" '+(p?'style="border-right:none;"':"")+'><div class="router-item-content"><div class="router-item-icon '+(a[m].icon?"":"router-hide")+'">'+(a[m].icon?'<img onload="view.checkImg&&view.checkImg(this)" src="'+a[m].icon+'"/>':"")+"</div>"+(1==view.windowType?'<div class="router-item-text '+(a[m].content?"":"router-hide")+'">'+(a[m].content?'<div class="router-item-text-bg" style="background:'+u+';"></div><div class="router-item-text-tx">'+a[m].content+"</div>":"")+"</div>":"")+'</div><div class="router-item-theme">'+a[m].theme+"</div></li>"}}if(d+="</ul></div>",l.publish("removeLoading"),0==c)ECHATObjKeyMap.cometdId.waitForRouterSelect=!1,e("#router").hide();else{e("#loading").hide(),e("#mask").show();var g,v=150*f;e("#router").addClass("router-line"+f).html(d).css({width:view.px2rem?view.px2rem(v):v+"px",marginLeft:view.px2rem?view.px2rem(-v/2):-v/2+"px"}).show().removeClass("slideUp"),l.isMobile||e(".router-item").on("mouseover touchstart",function(t){e(this).addClass("hover"),e(".router-item-theme",this).css({background:u,color:"#FFF"})}).on("mouseout touchend",function(t){e(this).removeClass("hover"),e(".router-item-theme",this).css({background:"#fff",color:"#323232"})}),e(".router-item").off("click").on("click",function(t){var i=e(this).attr("dataindex"),s=e(this).attr("data");s&&a[i]&&a[i].routeId==s&&(l.routeId=s,l.routeEntranceTheme=a[i].theme,l.paramChat.echatTag=a[i].routeEntranceEchatTag||l.routeEntranceTheme,e("#loading").show(),l.publish("routerSelect"),l.publish("toSetID"),e("#router").hide(),e("#mask").hide(),ECHATObjKeyMap.cometdId.waitForRouterSelect=!1,a=null,n=null)});view.handleRouterSelect&&view.handleRouterSelect(c,f)||(g=e("#router").height()||200,e("#router").css({marginTop:-g/2+"px"}))}}),this.subscribe("getLeaveReply",function(e,t){t.content&&l._getMsg(t,0,t.content),928!=t.from&&l.publish("toSetID")}),this.subscribe("getNewUnreadMsgCount",function(e,t){(500002==t.platformId||500003==t.platformId||20==t.platformId)&&l.showTip("收到685"+t.lastMsgContent),view.handleNewUnreadMsgCount&&view.handleNewUnreadMsgCount(t),l.sendMsgboxUnread.send(t)});var f;this.subscribe("updateVisitorInfo",function(t,i){var a,n;l.visitorId!=i.visitorId&&(a="ECHAT_HIS_"+window.companyId+"_"+i.visitorId,l.historyKey&&a!=l.historyKey&&(l.historyKey=a,l.hasStorage&&(n=window.localStorage.getItem(a))&&(window.localStorage.removeItem(l.historyKey),e.store(a,n))),l.visitorId=i.visitorId),i.photo&&l.visitorImg!=i.photo&&(e(".avatar-icon-img").each(function(e){-1!=this.parentNode.className.indexOf("fr")&&(this.src=i.photo)}),l.visitorImg=i.photo)}),this.subscribe("refreshVisitorInfo",function(e,t){var i="ECHAT_HIS_"+window.companyId+"_"+t.visitorId;l.historyKey=i,l.visitorId=t.visitorId,l.paramChat.metaData=t.metaData,t.photo&&(l.visitorImg=t.photo),t.myData&&(l.paramChat.myData=t.myData),t.formData&&(l.paramChat.formData=t.formData)}),this.uploadUtil=function(){var e={},t=1,i=[];return e.setUploadService=function(e){t=(i=e)[0].uploadServiceType||1},e.getUploadServiceType=function(e){return t=i[0].uploadServiceType},e.getNextUploadType=function(e){var a,n=i.length,s=i[n-1].uploadServiceType;if((e=e||t)==s)return!1;for(var o=0;o<n;o++){if(a)return i[o].uploadServiceType;i[o].uploadServiceType==e&&(a=o+1)}return!1},e.getLastUploadType=function(){return i[i.length-1].uploadServiceType},e}(),this.subscribe("setVisitorInfo",function(t,i){e("#leaveDisabled").hide(),l.msg600=i,l.visitorImg=i.photo,l.visitorId=i.visitorId,l.companyId=i.companyId,l.appId=i.appId,l.appSecrect=i.appSecrect,window.encryptVID=i.encryptVID,l.isVip=1==i.visitorType,l.visitorType=i.visitorType;for(var n=[lanRes.visitor_doc,lanRes.visitor_audio,lanRes.visitor_video,lanRes.visitor_img,lanRes.visitor_compress,lanRes.visitor_other],s=[["doc","docx","xls","xlsx","ppt","pptx","pdf","txt"],["amr","mp3","wav","aac","ogg"],["mp4","mov","webm","avi","m4v","mkv"],["jpg","jpeg","png","gif","bmp"],["rar","zip"],["p12","ttf","otf","abr","log","m4a","wma","mid","hevc","3gp","ts","3g2","3gpp","3gpp2","aep","vsp","prproj","rmvb","rm","flv","heic","heif","psd","psb","indd","xd","sketch","ai","cdr","eps","webp","tif","c4d","max","ezp","xlsm","key","rar4","r00","r01","r02","r03","zipx","7z","001","kz","ace","c00","c01","c02"]],o={},r=(i.uploadFileType||"").split(","),d=0;d<r.length;d++)for(var c=0;c<n.length;c++){var u=n[c];o[u]||(o[u]=[]),-1!==s[c].indexOf(r[d].toLowerCase())&&o[u].push(r[d].toLowerCase())}if(i.uploadFileSize&&(l.uploadFileSize=i.uploadFileSize||5242880,l.uploadFileType=i.uploadFileType,l.uploadFileTypeKey=o),l.qiniuDomain=i.qiniuBucketDomain,l.qiniuHttpsDomain=i.qiniuBucketHttpsDomain,l.platformName=i.platformName,l.platformLogo=i.platformLogo,l.companyName=i.companyName,l.companyLogo=i.companyLogo,l.companyMobileSite=i.companyMobileSite,l.companyWebSite=i.companyWebSite,UTIL.prototype.clearPrevStorage&&UTIL.prototype.clearPrevStorage.call(l,l.companyId,l.visitorId,window.chatVisitorId),l.sendMsgboxUnread.init(function(e){view.__nativeAPI&&view.__nativeAPI("platformNewMsg",l.formatUnreadMsg.call(l,e)),(500002==e.platformId||500003==e.platformId)&&l.showTip("platformNewMsg"+JSON.stringify(e))}),l.publish("initPageStatus",{companyId:l.companyId,companyName:l.companyName}),first600=1,l.apiServerDomain=(view.SDK||l.needHttps?"https:":"http:")+"//"+i.apiServerDomain,i.fileUploadInfos&&(l.uploadUtil.setUploadService(i.fileUploadInfos),l.fileUploadInfos=function(){i.fileUploadInfos=i.fileUploadInfos;for(var e={array:[]},t=0;t<i.fileUploadInfos.length;t++)e["uploadServiceType"+i.fileUploadInfos[t].uploadServiceType]=i.fileUploadInfos[t],e.array.push(i.fileUploadInfos[t].uploadServiceType);return e}()),l.historyKey||(l.historyKey="ECHAT_HIS_"+window.companyId+"_"+i.visitorId,l.hasPreHis=l.checkHistory(),l.isIOS&&2==view.windowType&&l.postMessage({type:"initLocalHistory",key:l.historyKey})),1==i.limitVisitorInputContentLengthEnable&&!f){var m=l.inputMaxLength=i.visitorInputContentMaxLength;f=!f,e("#inputLengthTip").html(lanRes.inputLengthTip1+m+lanRes.inputLengthTip2),e("#inputLengthTip").show(),setTimeout(function(){var e=l.getInputDoc().getElementsByTagName("body")[0];e.addEventListener?(e.addEventListener("keydown",function(e){a(e,m)}),e.addEventListener("paste",function(e){a(e,m)})):(e.attachEvent("onkeydown",function(e){a(e,m)}),e.attachEvent("onpaste",function(e){a(e,m)}))},200)}}),l.oldBodyEnterText="",this.subscribe("setChatParam",function(e,t){l.paramChat.country=t.country||"",l.paramChat.province=t.province||"",l.paramChat.city=t.city||"",l.paramChat.searcher=t.searcher||"",l.paramChat.keyword=t.keyword||"",l.paramChat.firstUrl=l.paramChat.firstUrl||t.firstUrl,l.paramChat.referrer=l.paramChat.referrer||t.referrer,l.paramChat.companyId=l.companyId,l.paramChat.visitorId=l.visitorId,l.paramChat.osName=l.queryParams.osName,view.canSetAD++,view.setAD&&view.setAD()}),this.subscribe("updateChatParam",function(t,i){e.extend(l.paramChat,i)}),this.subscribe("setRestartTag",function(e,t){l.restartParam={nonce:t.nonce,reChatTag:t.reChatTag},t.talkId&&!l.talkId&&t.notStore&&(l.talkId=t.talkId),l.hasPreHis=l.checkHistory(),view.noScrollBottom=!1}),l.isAutoPop="1"==l.queryParams.autoPop,this.subscribe("handshakeOk",function(t,i){l.robotToHumanKey=null,e("#restartChat").text(lanRes.chatContinued),e(".btn-restart").removeAttr("id").removeClass("btn-restart")}),this.subscribe("changeToPlatform",function(e,t){l.platformData=t,l.paramChat.echatTag=t.echatTag}),this.checkFirstMsg=function(e){function t(e,t){return e&&(e+"").replace(/<(?:.|\s)*?>/gi,"").substring(0,t||100)}if(e){try{e=JSON.parse(e)}catch(e){return}return"text"==e.msgType&&e.content?{msgType:"text",content:t(e.content),translation:e.translation&&t(e.translation)}:"image"==e.msgType&&e.picUrl?{msgType:"image",picUrl:e.picUrl,thumbUrl:e.thumbUrl||""}:"video"==e.msgType&&e.fileUrl?{msgType:"video",fileUrl:e.fileUrl,fileSize:e.fileSize||0,fileName:e.fileName||"",thumbUrl:e.thumbUrl}:"file"==e.msgType&&e.fileUrl?{msgType:"file",fileUrl:e.fileUrl,fileSize:e.fileSize||0,fileName:e.fileName||""}:void 0}},this.subscribe("toSetID",function(t,i){function a(e){return e?(e+"").replace(/<(?:.|\s)*?>/gi,""):e}l.talkId="",l.no103=!1;var n=n;if(l.companyOff=n,l.publish("__chatStatus","registerChat"),view.SDKNative){s={et:109},l.routeId&&(s.routeId=l.routeId,s.routeEntranceTheme=l.routeEntranceTheme,s.echatTag=l.paramChat.echatTag),l.robotToHumanKey&&(s.robotToHumanKey=l.robotToHumanKey);return(o=l.data109)?(o.visEvt&&(s.visEvt=o.visEvt),o.routeId&&(s.routeId=o.routeId),o.routeEntranceTheme&&(s.routeEntranceTheme=o.routeEntranceTheme)):l.data109=s,void l.publish("__registChatAction",s)}var s;s={et:109,windowType:view.windowType,companyId:l.companyId,page:l.paramChat.chatPage||n,title:l.paramChat.chatPageTitle||n,firstEnterUrl:l.paramChat.firstUrl||n,firstEnterTitle:l.paramChat.firstTitle||n,referrer:l.paramChat.referrer||n,media:l.Device.media,browserName:l.Browser.browser,browserVersion:l.Browser.version,osName:l.queryParams.osName||l.Device.OS.toLowerCase(),screenResolution:window.screen.width+"x"+window.screen.height,echatTag:l.paramChat.echatTag||n,routerId:l.queryParams.routerid||n,departmentId:l.queryParams.departmentid||n,routeEntranceId:l.queryParams.routeentranceid||n,styleId:l.queryParams.styleid||n,multipleFile:l.queryParams.multiplefile||0,fm:l.checkFirstMsg(l.queryParams.fm)},view.SDK&&(s.webSdk=1),l.robotToHumanKey&&(s.robotToHumanKey=l.robotToHumanKey),"1"==l.queryParams.autoPop&&l.isAutoPop&&(s.isAutoPop=1),"1"==l.queryParams.acceptInvite&&(s.acceptInvite=1),l.queryParams.bd_vid&&(s.containBdVidChatUrl=location.href),l.paramChat.acdStaffId&&(s.acdStaffId=l.paramChat.acdStaffId),l.paramChat.acdType&&(s.acdType=l.paramChat.acdType);var o=l.data109;l.data109=s,o&&(o.visEvt&&(s.visEvt=o.visEvt),o.routeId&&(s.routeId=o.routeId),o.routeEntranceTheme&&(s.routeEntranceTheme=o.routeEntranceTheme)),l.routeId&&(s.routeId=l.routeId,s.routeEntranceTheme=l.routeEntranceTheme);var r=l.queryParams.visitorid;if(r&&(s.visitorId=r,s.chatToken=l.queryParams.chattoken,s.tm=l.queryParams.tm,l.chatToken=s.chatToken),l.restartParam&&e.extend(s,l.restartParam),1==l.toLeaveWord&&(s.toLeaveWord=1,l.toLeaveWord=n),l.staffChatNeedConnect=!1,window.isInPlatform&&l.platformData&&(s.companyId=l.platformData.platfromId,s.routeId=l.platformData.routeId,s.echatTag=l.platformData.echatTag,s.toPlatformToken=l.platformData.toPlatformToken),l.paramChat.visEvt){var d;try{d=JSON.parse(l.paramChat.visEvt)}catch(e){d=l.paramChat.visEvt}if("object"==typeof d){var c={},f=!1;d.visEvt&&("object"==typeof d.visEvt?c=d.visEvt:f=!0),s.visEvt={customizeMsgType:d.customizeMsgType||2,question:d.question,dedup:1,eventId:d.eventId||c.eventId,title:a(d.title)||a(c.title),content:d.content||c.content,imageUrl:d.imageUrl||c.imageUrl,url:d.url||c.url,urlForVisitor:d.urlForVisitor||c.urlForVisitor,urlForStaff:d.urlForStaff||c.urlForStaff,memo:a(d.memo)||a(c.memo),visibility:d.visibility||c.visibility,urlEnableForVisitor:d.urlEnableForVisitor||c.urlEnableForVisitor,closeURLPage:d.closeURLPage||c.closeURLPage},f&&(s.visEvt=d.visEvt)}else s.visEvt=d;l.initVisEvt=l.paramChat.visEvt}l.publish("visitorCommonEvent",s),l.postMessage(2)}),"1"!=l.queryParams.autoPop&&"1"!=l.queryParams.acceptInvite||this.subscribe("_firstSendMsg",function(e,t){"0"==l.queryParams.autoChat&&(delete l.queryParams.autoChat,l.publish("toRegisterChat",t),delete l.queryParams.autoPop,l.isAutoPop=!1),"1"==l.queryParams.acceptInvite&&(l.queryParams.acceptInvite=void 0,delete l.queryParams.acceptInvite),this.unSubscribe("_firstSendMsg")}),this.subscribe("toRegisterChat",function(e,t){if("0"!=l.queryParams.autoChat&&(l.talkId="",!l.no103)){if(l.no103=!0,view.SDKNative)return a={et:103},l.eventId&&(a.eventId=l.eventId),console.log("__registChatAction",new Date),void l.publish("__registChatAction",a);var i=i,a={et:103,windowType:view.windowType,page:l.paramChat.chatPage||i,title:l.paramChat.chatPageTitle||i,firstEnterUrl:l.paramChat.firstUrl||i,firstEnterTitle:l.paramChat.firstTitle||i,referrer:l.paramChat.referrer||i,media:l.Device.media,browserName:l.Browser.browser,browserVersion:l.Browser.version,osName:l.queryParams.osName||l.Device.OS,screenResolution:window.screen.width+"x"+window.screen.height,echatTag:l.paramChat.echatTag||i};t&&t.code&&(a.captcha=t.code),"1"==l.queryParams.acceptInvite&&(a.acceptInvite=1),l.routeId&&(a.routeId=l.routeId,a.routeEntranceTheme=l.routeEntranceTheme),l.eventId&&(a.eventId=l.eventId),"1"==l.queryParams.autoPop&&(a.isAutoPop=1,t&&t.c&&(a.visitorWords=t.c)),l.publish("visitorCommonEvent",a,function(e){!0===e.successful&&l.publish("_pushVisitorEvent")})}}),this.subscribe("removeLoading",function(t,i){l.wait874List||(e("#loading").hide(),window.resizeFunc&&window.resizeFunc(),l.hasEntryOrCode||(e("#mask").hide(),e("#verify").hide()),e(".btn-close").removeClass("hide"),i&&l.initQcode())}),this.initQcode=function(){(!0!==l.companyOff&&!l.hasLeaveMsg||l.isInRobot)&&(l.isMobile||(l.showQcode?(e(".btn-qcode").removeClass("hide"),_$("qcode_img").setAttribute("loaded",""),_$("qcode_img").removeAttribute("loaded")):l.showQcode=l.toShowQcode()))},this.getLeaveConfig=function(e,t){return(e=e||l.msg649).offlineBoxInfo||e.offlineSmallBoxInfo||e.mobileOfflineBoxInfo||e.sdkOfflineBoxInfo},this.subscribe("toLeavePage",function(i,a,n){function o(){r&&1==c.enableThirdPartyParams&&c.thirdPartyParams&&(r=function(e,t,i){for(var a="",n=e.split("#"),s=n[1]||"",o=n[0],r=-1==o.indexOf("?")?0:1,l=0,d=t.length;l<d;l++){var c=t[l].paramName;"metaData"!=c&&"metadata"!=c||(c="metaData"),"formData"!=c&&"formdata"!=c||(c="formData"),i[c]&&(a+=(0!=r?"&":"?")+c+"="+encodeURIComponent(i[c]||""),r++)}return o+a+(s?"#"+s:"")}(r,c.thirdPartyParams,l.paramChat)),e("body").html(""),view.SDK?view.__nativeAPI("jumpToUrl",r):location.href=r}l.companyOff=!0;var r,d=!1,c=l.getLeaveConfig(a),f=!1;if(l.leaveAndClose){d=!1;var u="msg"+(p=(new Date).getTime()),m={t:(g=l.checkHistoryTime(p))?(new Date).format("hh:mm"):void 0,tm:p,mt:864,f:"c",m:0,hide:!0,c:l.entryVisitorMsg,id:u};l.entryVisitorMsg&&l.sendToServer(m),l.publish("__chatStatus","leaveToService");var h=e.extend({},m);h.c=l.entryLeaveContent,l.sendToServer(h,void 0,function(){l.visitorClose=!0,h.c.trim()&&s(lanRes.leavelSuc.alt,"ok"),l.publish("sendVisitorEvent",{et:107}),setTimeout(function(){l.leaveAndClose=!1},2e3)}),l.entryVisitorMsg=null}else if(c&&1==c.enable){if(n||(d=l.showEntryAndCode(a,!1)),d||l.publish("__chatStatus","leaveToService"),l.leaveAndClose&&e("#staffName").html("<span>"+lanRes.leaveWord+"</span>"),view.hideStaffInfo&&view.hideStaffInfo(),l.entryVisitorMsg){var p=(new Date).getTime(),u="msg"+p,g=l.checkHistoryTime(p),m={t:g?(new Date).format("hh:mm"):void 0,tm:p,mt:864,f:"c",m:0,hide:!0,c:l.entryVisitorMsg,id:u};l.sendToServer(m),l.entryVisitorMsg=null}view.showURLList&&!view.SDK&&(e(".menu-more").hide(),view.hideMenus()),view.handleLeave&&view.handleLeave("leaveToService",a)}else{if(c&&2==c.enable&&c.thirdPartyUrl)return l.publish("__chatStatus","leaveToUrl"),l.publish("__leaveToUrl",c.thirdPartyUrl),r=c.thirdPartyUrl,void(view.SDKNative&&window.setVisitorInfo?setTimeout(function(){o()},200):o());if(!c||0==c.enable||c&&2==c.enable&&!c.thirdPartyUrl){f=!0,l.publish("__chatStatus","leaveDisabled"),e("#inputPlaceholder").html(lanRes.disablePlaceholder),e("#footer").addClass("leave-disabled");var v=t.createElement("div");v.className="mask-disabled",e("#footer").append(v),e(t).off(),c&&view.handleLeave&&view.handleLeave("leaveDisabled",a),setTimeout(function(){l.publish("_endConnect"),l.companyOff=!0},200),view.hideStaffInfo&&view.hideStaffInfo(),view.showURLList&&(e(".menu-more").hide(),view.hideMenus())}}e(".btn-qcode").addClass("hide"),l.publish("removeLoading"),(d||f)&&e("#mask").show(),view.hideServiceIcon&&view.hideServiceIcon(),l.postMessage("toLeaveMessage")}),this.subscribe("refreshVerify",function(t,i){e("#verify_change").removeClass("loadin"),0==i.status||1==i.status&&e("#verify_input").addClass("error"),l.no103=!1,e("#verify_img").attr("src",l.dataHost+"/chatCaptCha.jpg?captChatToken="+i.captChaToken)}),this.bookformi=0,this.getBookComfirm=function(e){if(!e||!e[0])return e||"";var t;if(!(t=1==view.windowType&&1==e[0].type||1!=view.windowType&&3==e[0].type?e[0]:e[1])||!t.configuration)return"";var i=this.bookformi++,a=t.configuration,n=a.length,s=r(a);l.needHttps&&t.backImg&&(t.backImg=t.backImg.replace(/^http:/,l.needHttps));for(var o=' <div id="inviteBook'+i+'" class="book-table '+(3==t.type?"book-table-sm":"book-table-bg")+("1"==s?" book-all-line":"")+'" >'+(t.backImg?'<div><img onerror="view.imgError&&view.imgError(this)" id="inviteBookImg'+i+'" class="book-table-img hide" src="'+t.backImg+'" onload="imgLoadResize(this,'+i+')" /></div>':"")+'<form id="inviteBookForm'+i+'" class="book-items" onsubmit="return false;"> <div class="clearfix book-items-list" style="'+t.formPos+';">',d=0;d<n;d++){var c=a[d],f=1==c.configRequired?"req":"";o+='<div class="book-half book-item '+("1"==c.configInline?"book-one-line":"")+'"><label class="book-label" style="color:'+t.labelColor+'">'+c.configDesc+"</label>"+("gender"==c.configName?'<input type="text" lb="'+c.configDesc+'" class="book-ipt '+f+'" name="'+c.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"  value="'+(2==c.configValue?lanRes.female:1==c.configValue?lanRes.male:"")+'" readonly="readonly" />':"maritalStatus"==c.configName?'<input type="text" lb="'+c.configDesc+'" class="book-ipt '+f+'" name="'+c.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"  value="'+(2==c.configValue?lanRes.married:1==c.configValue?lanRes.unmarried:"")+'" readonly="readonly" />':'<input type="text" lb="'+c.configDesc+'" class="book-ipt '+f+'" name="'+c.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"  value="'+(c.configValue||"")+'" readonly="readonly" />')+"</div>"}return o+="</div></form></div>",setTimeout(function(){var e=_$("inviteBookForm"+i);if(e){var t=e.offsetHeight+(view.px2px?view.px2px(20):20)+e.offsetTop;_$("inviteBookLi"+i).style.minHeight=t+"px"}},1e3),'<li id="inviteBookLi'+i+'" class="clearfix book-confirm-wrap">'+o+"</li>"},this.showOrderSubmit=function(e){e.jobWindowInfo&&this.toShowOrderSubmit(e),l.publish("__chatStatus","workorder")},this.showEntryAndCode=function(t,i){var a=!1,n=t.entranceInfo||t.smallEntranceInfo||t.mobileEntranceInfo||t.sdkEntranceInfo,s=n&&1==n.visitorInfoEnable&&(i?1==n.enableOnline:1==n.enableOffline);return l.leaveAndCloseConfig&&!0===l.companyOff&&(n=l.leaveAndCloseConfig,s=!0),s&&l.toShowEntry(n,t)?(e("#verify").hide(),a=!0):t.captChaToken?(e("#entry").html("").hide(),e(".verify-change").attr("id","verify_change"),e(".verify-img").attr("id","verify_img"),e(".verify-ok").attr("id","verify_ok"),e(".verify-input").attr("id","verify_input"),l.publish("removeLoading"),l.toShowCode(),e("#verify_img").attr("src",l.dataHost+"/chatCaptCha.jpg?captChatToken="+t.captChaToken),e("#verify").show(),e("#mask").show(),a=!0):s&&(l.publish("entryCallback",{success:!0,mt:670}),a=!1),a&&(!0!==l.companyOff?l.publish("__setTitle",lanRes.onlineService):l.publish("__setTitle",lanRes.leaveWord)),l.hasEntryOrCode=a,a},this.subscribe("initRobot",function(t,a){function n(){var t=l.getInput(!1);t||(e("#input_suggest").addClass("hide").html(" "),view.resetContainerBaseFoot&&view.resetContainerBaseFoot()),!t||l.lastText==t&&d==t||(l.lastText=t,l.publish("sendVisitorEvent",{et:132,content:l.lastText})),l.typingTimer=setTimeout(n,c),d=t}a.robotConfigInfo.hasRobotDefImg&&(a.robotConfigInfo.robotImg=(a.robotPCChatBox||a.robotSmallChatBox||a.robotPhoneChatBox||a.robotSdkChatBox).defaultStaffImg),l.needHttps&&a.robotConfigInfo.robotImg&&(a.robotConfigInfo.robotImg=a.robotConfigInfo.robotImg.replace(/^http:/,l.needHttps)),l.staffImg=a.robotConfigInfo.robotImg,l.staffName=l.stringEncode(a.robotExtInfo&&a.robotExtInfo.nickName)||lanRes.robot,l.robotExtInfo=a.robotExtInfo||{},l.paramChat.staffId="-1",l.paramChat.staffName=l.staffName,l.paramChat.staffPhoto=l.staffImg,l.dataObject.robotInfo={img:l.staffImg,name:l.staffName},view.initRobotInfo&&view.initRobotInfo(a),l.bindPlainTextEvent(),view.setInnerAD(a),l.robotWordsInfo=a.robotWordsInfo,e("#toHumanWords").html(a.robotWordsInfo.toHumanWords||""),e("#textInput").attr("placeholder",a.robotWordsInfo.inputBoxWords||lanRes.inputPlaceholder2);var s=l.isVip?view.SDK?a.sdkVipVisitorRobotConfig:a.webVipVisitorRobotConfig:view.SDK?a.sdkVisitorRobotConfig:a.webVisitorRobotConfig;if(e("#robotToStaff").hide(),"1"==s.enableManualSwitch?(!0===l.companyOff?(e("#robotToStaffWord").html(a.robotWordsInfo.offlineButtonWords||lanRes.robotToStaff),"1"==s.enableLeaveBtnWhenStaffOffline&&(e("#robotToStaff").show(),i(l))):(e("#robotToStaffWord").html(a.robotWordsInfo.onlineButtonWords||lanRes.robotToStaff),"1"==s.enableSwitchBtnWhenStaffOnline&&(e("#robotToStaff").show(),i(l))),view.handleShowRobotToStaff&&view.handleShowRobotToStaff()):e("#robotToStaff").remove(),"1"==a.robotWordsInfo.enableFedBack){var o=a.robotWordsInfo;"string"==typeof o.solvedSubitem&&(o.solvedSubitem=JSON.parse(o.solvedSubitem)),"string"==typeof o.unsolvedSubitem&&(o.unsolvedSubitem=JSON.parse(o.unsolvedSubitem)),l.needHttps&&(o.solvedButton&&(o.solvedButton=o.solvedButton.replace(/^http:/,l.needHttps)),o.unsolvedButton&&(o.unsolvedButton=o.unsolvedButton.replace(/^http:/,l.needHttps))),o.solvedSubitem||o.unsolvedSubitem?!view.dji||o.unsolvedWords||o.solvedWords?l.robotFeedback=function(e){var t=(e=e||{}).answerItem,i="",a='<div class="feedback-tip">'+(o.fedBackWords||"")+'</div><div class="feedback-tag"><i class="feed-icon-sel"></i><span>'+lanRes.hasSelected+'</span></div><div class="feedback-btns clearfix"><div class="feedback-btn-solve '+(1==e.feedback?"feedback-btn-solve-sel":"")+(view.dji&&!o.solvedWords?" hide":"")+'" type="1">'+(o.solvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+o.solvedButton+'"/>':"")+"<span>"+(o.solvedWords||"")+'</span></div><div class="feedback-btn-unsolve '+(2==e.feedback?"feedback-btn-unsolve-sel":"")+(view.dji&&!o.unsolvedWords?" hide":"")+'" type="2">'+(o.unsolvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+o.unsolvedButton+'"/>':"")+"<span>"+(o.unsolvedWords||"")+"</span></div></div>";if(t){if(2!=e.feedback&&o.solvedSubitem&&o.solvedSubitem.length>0){i+='<div class="feedback-sub-solved"><div class="robot-tip">'+lanRes.solvedReason+'</div><ul class="feedback-sub-list '+(e.feedbackSubitem?"robot-feedback-sub-had":"")+'" did="'+t.docId+'" qid="'+t.queryId+'" rid="'+t.robotDetailId+'" searchId="'+t.searchId+'" originQuestion="'+escape(t.originQuestion)+'">';for(n=0;n<o.solvedSubitem.length;n++)i+='<li class="feedback-sub-li sub-solved-li '+(e.feedbackSubitem==o.solvedSubitem[n].content?"feedback-sub-sel1":"")+'"><span class="list-style-dot">'+(n+1)+'.</span><span class="feedback-sub-content" type="1">'+o.solvedSubitem[n].content+"</span></li>";i+="</ul></div>"}if(1!=e.feedback&&o.unsolvedSubitem&&o.unsolvedSubitem.length>0){i+='<div class="feedback-sub-unsolved"><div class="robot-tip">'+lanRes.unsolvedReason+'</div><ul class="feedback-sub-list '+(e.feedbackSubitem?"robot-feedback-sub-had":"")+'" did="'+t.docId+'" qid="'+t.queryId+'" rid="'+t.robotDetailId+'" searchId="'+t.searchId+'" originQuestion="'+escape(t.originQuestion)+'">';for(var n=0;n<o.unsolvedSubitem.length;n++)i+='<li class="feedback-sub-li sub-unsolved-li '+(e.feedbackSubitem==o.unsolvedSubitem[n].content?"feedback-sub-sel2":"")+'"><span class="list-style-dot">'+(n+1)+'.</span><span class="feedback-sub-content" type="2">'+o.unsolvedSubitem[n].content+"</span></li>";i+="</ul>"}}return a+i+"</div></div>"}:l.robotFeedback=!1:l.robotFeedback=function(e){e=e||{};return'<div class="feedback-tip">'+(o.fedBackWords||"")+'</div><div class="feedback-tag"><i class="feed-icon-sel"></i><span>'+lanRes.hasSelected+'</span></div><div class="feedback-btns clearfix"><div class="feedback-btn-solve '+(1==e.feedback?"feedback-btn-solve-sel":"")+'" type="1">'+(o.solvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+o.solvedButton+'"/>':"")+"<span>"+(o.solvedWords||"")+'</psan></div><div class="feedback-btn-unsolve '+(2==e.feedback?"feedback-btn-unsolve-sel":"")+'" type="2">'+(o.unsolvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+o.unsolvedButton+'"/>':"")+"<span>"+(o.unsolvedWords||"")+"</span></div></div></div></div>"};var r=l.getCSSRule(".feedback-btn-solve");r&&o.solvedBackColor&&(r.style.backgroundColor=o.solvedBackColor),(r=l.getCSSRule(".sub-solved-li"))&&o.solvedBackColor&&(r.style.backgroundColor=o.solvedBackColor),(r=l.getCSSRule(".feedback-btn-solve-sel"))&&o.solvedSelectColor&&(r.style.backgroundColor=o.solvedSelectColor),(r=l.getCSSRule(".feedback-sub-sel1"))&&o.solvedSelectColor&&(r.style.backgroundColor=o.solvedSelectColor),(r=l.getCSSRule(".feedback-btn-unsolve"))&&o.unsolvedBackColor&&(r.style.backgroundColor=o.unsolvedBackColor),(r=l.getCSSRule(".sub-unsolved-li"))&&o.unsolvedBackColor&&(r.style.backgroundColor=o.unsolvedBackColor),(r=l.getCSSRule(".feedback-btn-unsolve-sel"))&&o.unsolvedSelectColor&&(r.style.backgroundColor=o.unsolvedSelectColor),(r=l.getCSSRule(".feedback-sub-sel2"))&&o.unsolvedSelectColor&&(r.style.backgroundColor=o.unsolvedSelectColor)}else l.robotFeedback=!1;l.unSubscribe("_sendQuestion"),l.subscribe("_sendQuestion",function(t,i){l.publish("sendVisitorEvent",{et:130,docId:i.docId,originDocId:i.originDocId,content:i.content}),l._getMsg({mt:130,ff:"r",tm:(new Date).getTime()},0,i.content,"c"),e("#input_suggest").addClass("hide").html(" "),view.resetContainerBaseFoot&&view.resetContainerBaseFoot()}),l.lastText=null,l.typingTimer&&clearTimeout(l.typingTimer);var d,c=12059==l.companyId?500:1500;l.hasInputAssociation&&(l.typingTimer=setTimeout(n,c)),l.openVisitorSend(),e("#toolbar").addClass("robot"),e("body").addClass("robot"),l.publish("onceStartRobot")}),l.subscribe("_showCommonQue",function(t,i){var a=i.content;a=l.handleMsgImg(a,i);var n=i.commonQuestions&&JSON.parse(i.commonQuestions);if(n&&n.length){i.commonQuesWords?a+='<div class="common-ques-tip">'+i.commonQuesWords+'</div><ul class="common-ques-list">':a+='<ul class="common-ques-list">';for(var s=0;s<n.length;s++)a+='<li class="common-ques-li" did="'+n[s].id+'" ques="'+escape(n[s].question||n[s].content)+'"><span class="list-style-dot">'+(s+1)+'.</span><span class="link-robot-ques">'+(n[s].question||n[s].content)+"</span></li>";a+="</ul>"}i.notStore||(l.talkId=i.talkId,l.paramChat.talkId=l.talkId,l.paramChat.staffPhone="",l.paramChat.staffInfo="",l.robotTalkId=i.talkId,view.startChatRefreshAD&&view.startChatRefreshAD(),l.publish("__chatStaffInfo",{staffId:l.paramChat.staffId,staffNickName:l.staffName||"",staffHead:l.staffImg,staffInfo:l.robotExtInfo.autograph||"",recordId:(l.isInRobot?"5_":"1_")+l.talkId})),l._getMsg.call(this,e.extend(i,{tm:i.tm,mt:12001,ff:"r",answer:i.content,staffImg:i.staffImg||l.staffImg,staffName:i.staffName||l.staffName,content:a}),0,a,"r")}),l.maxRobotLength=100,e("#inputLengthTip").html(lanRes.inputLengthTip1+" "+l.maxRobotLength+" "+lanRes.inputLengthTip2),l.handleInputLength=function(){var t;view.chat.isInRobot&&function(t,i){for(var a=0,i=2*i,n=0,s=0;s<t.length;s++){if(null!=t.charAt(s).match(/[^\x00-\xff]/gi)?(a+=2,n+=1):a+=1,a>=i)return l.setInput(t.substr(0,a-n)),void e("#inputLengthTip").html(lanRes.inputLengthTip1+" 0 "+lanRes.inputLengthTip2);var o=i/2-(parseInt(a/2)+a%2);e("#inputLengthTip").html(lanRes.inputLengthTip1+" "+o+" "+lanRes.inputLengthTip2)}}(t=l.getInput(),l.maxRobotLength),(view.chat.isInRobot||view.SDK)&&view.urlList&&(t||l.getInput()?(e(".menu-more").hide(),e("#enter_btn").removeClass("hide")):(e(".menu-more").show(),e("#enter_btn").addClass("hide")))},this.subscribe("onceStartRobot",function(t,i){l.unSubscribe("onceStartRobot"),view.urlList&&(e("#menu_more_robot").show(),e("#enter_btn").addClass("hide")),e("#list_msg").on("click",".common-ques-li",function(t){l.publish("_sendQuestion",{docId:e(this).attr("did"),content:unescape(e(this).attr("ques"))})}),e("#robotToStaffWord").on("click",function(){e("#inputLengthTip").html(lanRes.inputLengthTip1+l.inputMaxLength+lanRes.inputLengthTip2),"disconnected"==EChatQuery.cometd.getStatus()||l.isInRobot&&l.publish("sendVisitorEvent",{et:131}),l.getInputDocBody().blur()}),e("#input_suggest").on("click",".ipt-list-li",function(t){if((!view.handleNetwok||!view.handleNetwok())&&(l.setInput(unescape(e(this).attr("ques"))),l.isInRobot)){l.publish("_sendQuestion",{docId:e(this).attr("did"),content:unescape(e(this).attr("ques"))});l.getInput(!0)&&view.afterSend()}}),e("#list_msg").on("click",".question-list-li",function(t){l.publish("_sendQuestion",{docId:e(this).attr("did"),originDocId:e(this).attr("oid"),content:unescape(e(this).attr("ques"))})}),e("#list_his").on("click",".feedback-btn-unsolve",function(t){var i=this.parentNode.parentNode,a=e(i).attr("did");if(a){view.chat.lastFeedBack=i,l.publish("sendVisitorEvent",{et:133,docId:a,queryId:e(i).attr("qid"),robotDetailId:e(i).attr("rid"),searchId:e(i).attr("searchId"),originQuestion:unescape(e(i).attr("originQuestion")),feedBack:e(this).attr("type")}),e(i).attr("did","").addClass("robot-feedback-had robot-feedback-had2"),e(this).addClass("feedback-btn-unsolve-sel");var n=e(this).parents(".msg-robot").attr("id");n&&view.scrollToBottom(n)}}).on("click",".feedback-btn-solve",function(t){var i=this.parentNode.parentNode,a=e(i).attr("did");if(a){view.chat.lastFeedBack=i,l.publish("sendVisitorEvent",{et:133,docId:a,queryId:e(i).attr("qid"),robotDetailId:e(i).attr("rid"),searchId:e(i).attr("searchId"),originQuestion:unescape(e(i).attr("originQuestion")),feedBack:e(this).attr("type")}),e(i).attr("did","").addClass("robot-feedback-had robot-feedback-had1"),e(this).addClass("feedback-btn-solve-sel");var n=e(this).parents(".msg-robot").attr("id");n&&view.scrollToBottom(n)}}).on("click",".feedback-sub-content",function(t){var i=this.parentNode.parentNode,a=e(i).attr("did");if(a){var n=e(this).attr("type");l.publish("sendVisitorEvent",{et:133,docId:a,queryId:e(i).attr("qid"),robotDetailId:e(i).attr("rid"),searchId:e(i).attr("searchId"),originQuestion:unescape(e(i).attr("originQuestion")),feedBackSubitem:this.innerText||this.textContent||this.innerHTML}),e(i).attr("did","").addClass("robot-feedback-sub-had"),e(this.parentNode).addClass("feedback-sub-sel"+n)}})}),this.subscribe("endRobot",function(t,i){l.data109=null,l.typingTimer&&clearTimeout(l.typingTimer),l.isInRobot=0,e("#toolbar").removeClass("robot"),e("body").removeClass("robot"),e("#robotToStaff").hide(),l.isMobile&&view.hideMenus(),e(".robot-staff").removeClass("robot-staff"),l.unSubscribe("_sendQuestion"),l.robotTalkId&&l.handleSessionMsg({talkId:l.robotTalkId}),l.robotTalkId=null,l.staffName="",l.staffImg=void 0,l.staffId=void 0,delete l.paramChat.staffId,delete l.paramChat.staffName,delete l.paramChat.staffPhoto,delete l.paramChat.talkId,!l.isMobile&&l.changeToIframe(),e("#textInput").attr("placeholder",lanRes.mbTextareaInput.placeholder)}),e(".leave-bar-btn").on("click",function(){l.publish("restartChat")}),e(".robot-staff-close").on("click",function(){var t=this.parentNode;e(t).addClass("hide").hide(),view.handleShowRobotToStaff&&view.handleShowRobotToStaff(),i(l,"close")}),l.unSubscribe("getCrossMessage"),l.subscribe("getCrossMessage",function(e,t){var i=t.data,a=t.source;if(i)if(l.hasSearchInSameScreen&&"robot"==i.evt)"question"==i.type&&i.content?l.publish("_sendMsg",i.content):"sendVisEvt"==i.type&&i.content&&l.publish("_sendVisEvt",i.content);else if("echatPlugin"==i.evt){if("addStaffMsg"==i.type){if(console.log("***addStaffMsg******",i),!l.talkId||640!=i.msg.mt&&647!=i.msg.mt||!l.outerChatStatus.match(/waiting|chatting/))return;var n,s,o=l.talkId,r=(l.talkType||1)+"_"+o,d=l.initHistory(o);if(!d)return;if(s=d[r].order,1==i.autoMsg&&(i.msg.autoMsg=1),i.msg.talkId=o,s.length>0&&1==i.msg.autoMsg)for(var c=0;c<s.length;c++)if(1==(n=d[r][s[c]]).autoMsg&&n.c==i.msg.content)return void(_$(i.msg.mid+"")||_$(n.mid+"")||l.showMsg(n));640==i.msg.mt&&l.publish("getMsg",i.msg),647==i.msg.mt&&l.publish("getSysMsg",i.msg)}}else if("echatjs"==i.evt)if("echatInnerFrame"==i.type&&a)try{a.postMessage({type:"echatInnerFrameCallback",companyId:l.companyId,visitorId:l.visitorId,chatVisitorId:window.chatVisitorId,encryptVID:window.encryptVID,metaData:l.queryParams.metadata||"",formData:l.queryParams.formdata||"",inChatPage:!0},i.origin)}catch(e){}else"openChat"==i.type?((l.isMobile||2==view.windowType)&&view.hideURLSite&&view.hideURLSite(),l.publish("_triggerChat",i)):"closeFramePage"==i.type?(view.hideURLSite?view.hideURLSite():view.hideRightUrl&&view.hideRightUrl(i),view.__nativeAPI&&view.__nativeAPI("closeUrlView")):"sendTextMsg"==i.type?l.publish("_sendMsg",i.content):"sendVisEvt"==i.type&&l.publish("_sendVisEvt",i.content)});var u=l.isMobile&&!l.isPcXcx?"touchend":"click";e("#chat").on(u,".robot-staff",function(){l.isInRobot&&l.publish("sendVisitorEvent",{et:131})}).on(u,".end-chat",function(){l.visitorCloseFunc()}).on(u,".to-leave-word",function(){l.outerChatStatus&&l.outerChatStatus.match(/waiting|chatting|robot/)&&(l.toLeaveWord=1,l.publish("sendVisitorEvent",{et:107,toLeaveWord:1},function(){}))}),l.subscribe("_triggerChat",function(t,i){if("disconnected"==e.cometd.getStatus()||"sdk"==e.cometd.getStatus()){if("block"==_$("satisfy").style.display){if(i&&"showMiniChat"==i.action)return;e("#satisfy").hide(),e("#mask").hide()}setTimeout(function(){console.log(i&&"showMiniChat"==i.action?{needRouter:2==view.windowType&&l.visitorClose}:1),view.chat.publish("restartChat",i&&"showMiniChat"==i.action?{needRouter:2==view.windowType&&l.visitorClose}:void 0)},15),e("#restartChat").text(lanRes.chatContinued),e(".btn-restart").removeAttr("id").removeClass("btn-restart")}else l.isMobile||"firefox"!=l.Browser.browser&&l.focusInput()}),e("#content").on("click",".msg-leave",function(){var t,i=e(this).attr("k"),a=e(this).hasClass("msg-workorder"),n=l.leaveMsgMap[i]||l.orderMsgMap[i],s=l.apiServerDomain+"/chatapi/paodm/qd?companyId="+l.companyId+"&visitorId="+n.visitorId+"&chatInfoType="+(n.chatInfoType||9)+"&talkId="+(n.newsMsgId||n.jobId)+"&tm="+n.tm+"&token="+n.signature,i=n.token||"",o=n.nonce||"",r=l.msg600.photo||"",d=l.msg600.lan,c=view.SDKNative?window.locationBase:(l.needHttps||"http:")+"//"+location.host,f=l.fileUploadInfos.array,u="in"==window.lanResName?"id":window.lanResName;if(t=a?c+"/visitor/common/order.html?lan="+d+"&url="+encodeURIComponent(s)+"&token="+i+"&nonce="+o+"&uploadFileSize="+l.uploadFileSize+"&photo="+encodeURIComponent(r)+"&fileUploadInfos="+JSON.stringify(f)+"&windowType="+view.windowType:c+"/visitor/common/record.html?lan="+u+"&url="+encodeURIComponent(s),t+="&linkOpenerNative="+(view.linkOpenerNative?"1":"0"),view.handlePushURL?-1==view.handlePushURL(t)&&window.open(t,"_blank"):a?view.showURLLink&&view.showURLLink(lanRes.visitor173,t,{from:5,workorder:1}):view.showURLLink&&view.showURLLink(lanRes.leaveMsgTitle,t,{from:5}),e("#msg"+n.tm).hasClass("fold"))if(e("#msg"+n.tm).removeClass("fold"),view.SDKNative)view.__nativeAPI("updateLocalMsg",{mid:n.mid,read:1});else if(l.hasStorage){var m=window.localStorage.getItem(l.historyKey);if(m){var h=(m=JSON.parse(m))[n.talkTypeId];h&&h[n.tm+"s"]&&(h[n.tm+"s"].read=1),l.updateHistory(m)}}}),this.subscribe("startRobot",function(e,t){l.hasSearchInSameScreen=1==l.msg649.enableSearchInTheSameScreen,l.hasInputAssociation=1==l.msg649.enableInputAssociate,l.isInRobot=!0,l.talkType=5,l.publish("clearSendingMsg","robot"),l.publish("setConfig",l.msg649),l.publish("initRobot",l.msg649),l.publish("__chatStatus","robot"),view.toggleLeaveToChat&&view.toggleLeaveToChat(2),l.queryParams.autoPop&&delete l.queryParams.autoPop,l.queryParams.autoChat&&delete l.queryParams.autoChat,l.isAutoPop=!1}),this.subscribe("startLeave",function(e,t){l.companyOff=!0,l.talkId=t.talkId,l.talkType=3,l.publish("setConfig",l.msg649),l.publish("toLeavePage",l.msg649,t),l.queryParams.autoPop&&delete l.queryParams.autoPop,l.queryParams.autoChat&&delete l.queryParams.autoChat,l.isAutoPop=!1}),this.subscribe("startChat",function(e,t){l.talkType=1,l.publish("setConfig",l.msg649),setTimeout(function(){l.toInitEvaluate(l.msg649)},10),this.startChat.apply(l,arguments),l.postMessage({type:"getStartChat",msg:t})}),l.orderMsgMap={},this.subscribe("orderReply",function(e,i){i.current&&(i.jobId=i.talkId,i.talkId=l.talkId||i.tm);var a='<li class="clearfix '+(1==i.read?"":"fold")+'" talkid="'+i.talkId+'" id="msg'+i.tm+'"><div class="msg-leave msg-workorder" k="'+i.signature+'"><div class="msg-leave-title"><i class="msg-leave-i"></i><span class="msg-leave-t">'+((i.staffNickName?'<span class="color0">'+i.staffNickName+"&nbsp;</span>":lanRes.serviceStaff)+lanRes.visitor174)+'</span></div><div class="msg-leave-con" ><div class="msg-leave-content">'+l.filterEmo(i.content||"")+'</div><div class="msg-leave-dot">...</div><div class="msg-leave-link color0">'+lanRes.viewAll+"</div></div></div></li>",n=t.createElement("ul");n.innerHTML='<li class="clearfix" ><div class="color1 tc">'+l.getTimeStr(i.tm)+"</div></li>"+a;for(var s,o=this.getListMsgEl(i.talkId,i.tm,!!i.current),r=n.childNodes,d=0;s=r[d++];)1==s.nodeType&&(s=s.cloneNode(!0),o.appendChild(s));r=null,n=null,view.scrollToBottom(null,{transitionDuration:100,timeout:100}),i.current&&(i.f="s",i.c=i.content,delete i.current,l.pushHistory(i),o=null),l.orderMsgMap[i.signature]=i}),this.subscribe("continueChat",function(e,t){setTimeout(function(){l.toInitEvaluate(l.msg649)},10),this.startChat.apply(l,arguments)}),this.subscribe("goingEntry",function(e,t){var i;1==t.status?l.showEntryAndCode(t,!0):((i=t.entranceInfo||t.smallEntranceInfo||t.mobileEntranceInfo||t.sdkEntranceInfo)&&1==i.visitorInfoEnable&&1==i.enableOffline||t.captChaToken)&&l.publish("toLeavePage",l.msg649)}),this.hasBoxConfig=function(e){return e.robotConfigInfo||e.robotPCChatBox||e.offlineBoxInfo||e.mobileOfflineBoxInfo||e.sdkOfflineBoxInfo||e.sdkChatBoxInfo||e.mobileChatBoxInfo||e.chatBoxInfo||e.chatSmallBoxInfo||e.offlineSmallBoxInfo||e.jobWindowInfo},this.resetDom=function(){e("#chat").removeClass("hide"),e("#orderSubmit").hide(),e("#footer").removeClass("hide").removeClass("leave-disabled"),e("#busyTipLine").addClass("hide").hide(),e("#input_suggest").addClass("hide").html(" "),l.isMobile&&e(".menu-phone").addClass("limit-hide"),l.isMobile||e("#portrait").hide(),e("#textInput").attr("placeholder",lanRes.mbTextareaInput.placeholder),e("#leaveDisabled").hide(),view.resetContentHeight&&view.resetContentHeight(),e("#container").removeClass("hide"),e("html").removeClass("page-leave"),e("html").removeClass("entry2"),l.hasEntryOrCode&&l.publish("entryCallback",{success:!0}),e("#inputPlaceholder").html(e("#inputPlaceholder").attr("placeholder")||lanRes[e("#inputPlaceholder").attr("langs")]),e("#inputLengthTip").hide(),l.getInput(!1)?e("#inputPlaceholder").addClass("hide"):e("#inputPlaceholder").removeClass("hide"),e("#router").hide()},this.subscribe("waitingChat",function(t,i){if(l.eventId=i.eventId,l.isInRobot&&(l.workOrder2RobotTalkId=l.robotTalkId,l.updateHistoryComplete(l.talkType+"_"+l.robotTalkId),l.publish("endRobot")),1!=i.canChatNow&&l.publish("setConfig",i),!i.unreadMsgNumber){var a=l.getLeaveConfig(i);if(2==i.status&&2!=i.chatStatus&&a&&(2==a.enable&&a.thirdPartyUrl||"0"==a.enable)&&(l.publish("toLeavePage",i),"0"==a.enable||"2"==a.enable))return}if(!1!==l.chatting&&l.talkId&&(l.lastTalkIdForTemp=l.talkId),i.routeId&&(l.routeId=i.routeId),l.chatting=-1,l.isInWorkOrder=!1,l.leaveAndClose=!1,l.sendMsgNum=0,view.toggleEnded&&view.toggleEnded("init"),l.resetDom(),l.sendMsgNum=0,l.hasBoxConfig(i)&&(l.msg649=e.extend(l.msg649||{},i),view.SDK&&e.store("ECHAT_"+l.companyId+"_649",JSON.stringify(e.extend(JSON.parse(e.store("ECHAT_"+l.companyId+"_649")||"{}"),i)))),4===Number(i.status)&&0===i.canChatNow?l.isInWorkOrder=!0:(l.isInWorkOrder=!1,delete l.workOrder2RobotTalkId),l.isInWorkOrder&&1===Number.parseInt(l.queryParams.template)&&(e("body").css({"min-width":"auto"}),e("#header").attr("style","display:none !important"),e("#leftCustom").hide(),e("#rightAD").hide(),e("#rightCustom").hide(),e("#container_leave").css({right:0}),e(".foot-powerby").hide(),e("#container").addClass("order-initPosition")),i.unreadMsgNumber&&parseInt(i.unreadMsgNumber))return l.publish("setConfig",i),l.companyOff=2==i.status,l.hasLeaveMsg=!0,l.publish("removeLoading"),view.toggleLeaveToChat&&view.toggleLeaveToChat(1),void(view.initChatscroll&&view.initChatscroll());if(l.hasLeaveMsg=!1,view.toggleLeaveToChat&&view.toggleLeaveToChat(0),l.companyOff=2==i.status,l.hasChatInOtherPage=!1,e.store("ECHAT_"+l.companyId+"_"+window.chatVisitorId+"_chatStatus",i.chatStatus),2==i.chatStatus?(l.wait874List=!0,l.hasChatInOtherPage=!0):1!=i.canChatNow&&l.publish("goingEntry",i),l.isInWorkOrder&&l.showOrderSubmit(i),l.publish("__staffStatus",i.status),ECHATObjKeyMap.cometdId.waitForRouterSelect&&l.publish("routerSelect"),ECHATObjKeyMap.cometdId.waitForRouterSelect=!1,l.isInRobot&&(i.robotPCChatBox||i.robotSmallChatBox||i.robotPhoneChatBox||i.robotSdkChatBox)||!l.isInRobot&&(i.chatBoxInfo||i.chatSmallBoxInfo||i.mobileChatBoxInfo||i.sdkChatBoxInfo)){var n=i.entranceInfo||i.smallEntranceInfo||i.mobileEntranceInfo||i.sdkEntranceInfo;n&&2==i.status&&1==n.visitorInfoEnable&&1==n.enableOffline&&"0"==n.offlineStartType||view.setInnerAD(i)}!0!==l.companyOff&&"0"==l.queryParams.autoChat&&!0!==l.chatting?(e(".menu-capture").addClass("hide"),e(".menu-file").addClass("hide")):!0===l.companyOff&&(e(".menu-capture").removeClass("hide"),e(".menu-file").removeClass("hide")),l.openVisitorSend(),l.publish("firstInitSound"),1==i.notThroughStatus&&l.publish("removeLoading")}),this.subscribe("firstInitSound",function(){l.unSubscribe("firstInitSound"),l.isMobile?window.audioInstance||(window.audioInstance=_$s("audio")[0]):window.ltIE10||window.audioInstance&&view.SDKNative||l.addJS("/visitor/common/audiojs/audiojs/audio.min.js",function(){audiojs.events.ready(function(){window.audioInstance=audiojs.create(_$("msgAudio"))})}),l.unSubscribe("_newMsg"),l.subscribe("_newMsg",function(){if(console.log(arguments),!l.disableSoundTip&&window.audioInstance){var e=window.audioInstance;try{e.play.apply(e)}catch(e){}}})}),this.subscribe("_addSendMsgNum",function(e,t){l.sendMsgNum++,l.allowEvaluateBaseWords<=l.sendMsgNum&&l.toggleEvaluateMenu(4);var i=function(e){if(e)return 864==e.mt||105==e.et?{msgType:"text",textContent:(e=e.content||e.c||"")&&(e=e.replace(/<img [^>]+>/g,"[face]"))}:866==e.mt?{msgType:"file",fileName:e.fileName,fileUrl:e.fileUrl,fileType:e.fileType,fileSize:e.fileSize}:865==e.mt?{msgType:"image",smallImg:e.smallImg,bigImg:e.bigImg,sourceImg:e.sourceImg}:959==e.mt?{msgType:"formData",formName:e.template.name,formId:e.template.id}:void 0}(t);i&&l.postMessage({type:"visitorSendEvt",msg:i})});var m={};l.handleNewMsgMid=function(t,i,a,n){if(t&&!m[t])return m[t]=1,l.lasMid=l.lasMid||e.store("ECHAT_"+l.companyId+"_"+l.visitorId+"_mid")||0,l.lasMid<t?(i&&a&&(i.mid=t,!1!==n.isForward&&view.SDKNative||(n&&n.data&&680==n.data.mt&&((i=e.extend({},i)).c="[URL]"+n.data.pushUrlDetail.urlName+"["+n.data.pushUrlDetail.url+"]"),l.publish("_newMsg",i),"sys"==i.f?l.publish("__newSysMsg",i,n):l.publish("__newMsg",i,n))),e.store("ECHAT_"+l.companyId+"_"+l.visitorId+"_mid",t),(!1===view.showChangeTitle||view.miniShow||window.ltIE10)&&(e.store("ECHAT_"+l.companyId+"_"+window.chatVisitorId+"_mid_read",t),1!=view.windowType&&3!=view.windowType||!1!==view.showChangeTitle||e.store("ECHAT_"+l.companyId+"_"+window.chatVisitorId+"_mid_read_click",t)),a):void 0},l._getMsg=function(t,i,a,n,s){function o(e,s,o){o&&(e.c=""),o||!e.c&&!s||(e.c=s||e.c,l.showMsg(e)),delete e.id,delete e.hasResend,t.notStore||(1==i?e.tmf=d:2==i&&(e.fileIdentity=t.fileIdentity,e.fileName=t.fileName,e.bigImg=t.bigImg,e.smallImg=t.smallImg,e.sourceImg=t.sourceImg,e.c="img-temp"+d,e.sourceWidth=t.sourceWidth,e.sourceHeight=t.sourceHeight,e.tmf=d),e.autoMsg=t.autoMsg,"x"==n&&5!=e.m?e.c=t.content:"r"==n&&(e.c=t.content),(a||t)&&!l.isMobile&&view.setDocumentTitle&&view.setDocumentTitle(n),"c"!=n?(e.answer=t.answer||void 0,l.handleNewMsgMid(t.mid,e,!0,{mt:t.mt,mid:t.mid,__filterOrigin:t.__filterOrigin||a,data:t})):l.lasMid<e.mid&&(l.lasMid=e.mid),e.c&&l.pushHistory(e))}t.tm||(t.tm=(new Date).getTime());var r=new Date(t.tm?t.tm-0:void 0),d=t.id||t.bridgeMsgId||t.fileIdentity||t.mid||"msg"+t.tm,c=l.checkHistoryTime(t.tm),f={t:t.t||(c?r.format("hh:mm"):void 0),tm:t.tm,mt:a&&a.mt||t.mt,f:n||"s",m:i,c:a,mid:t.mid,hasResend:t.bridgeMsgId&&2==t.sendStatus,notEnd:t.notEnd,id:d};10==i&&(f.template=s,f.formUrl=t.formUrl,f.visitorId=t.visitorId,f.formInfo=t.formInfo,f.sendId=t.sendId),f.hasResend&&(l.errorList[d]=t),f.talkId=t.talkId||l.talkId,t.staffImg&&(f.staffImg=t.staffImg),t.staffName&&(f.staffName=t.staffName||t.staffNickName),t.staffId&&!t.staffName&&l.staffMap[t.staffId]&&(f=e.extend(f,l.staffMap[t.staffId])),"f"!=n&&"r"!=t.ff||(f.ff="r"),l.filterMsg>=2&&!t.notStore&&"c"!=f.f&&0==f.m&&f.c&&!t._hasFilterMsg?l.filterAndShowMsg(f,o):o(f)},this.filterAndShowMsg=function(e,t){if(e._hasFilterMsg)return t(e,e.c);var i=this;e.id||(console.log("error :send msg has no id"),e.id=(new Date).getTime()+""),this.processMsg.receiveMsgMap[e.id]=function(a){t(e,a,!a),i.processMsg.processNum--},this.processMsg.processNum++,this.publish("__receiveFilter",{msgId:e.id+"",receiveMsg:e.c})},this.escapeHtml=function(e){return e&&e.replace(/"/g,"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},this.handleMsgImg=function(e,t,i,a){var n=/\bsrc\b\s*=\s*[\'\"]?([^\'\"]*)[\'\"]?/i;return t=t||{},i=i||"",e=e&&e.replace(/<img\b.*?(?:\>|\/>)/gi,function(e){var s=a||n.exec(e);if(!s)return e;var o={smallImg:s=a||s[1],bigImg:s,sourceImg:s,fileName:lanRes.visitor175};return view.showMsgImg&&view.showMsgImg(o,i)||'<img onerror="view.imgError&&view.imgError(this)"'+(t.notEnd?"":'onload="javascript:view.scrollToBottom()"')+' id="img'+(o.tm||(new Date).getTime())+'" attname="'+o.fileName+'" bigimg="'+o.bigImg+'" src="'+o.smallImg+'" source="'+(o.sourceImg||"")+'" sw="'+(t.sourceWidth||"")+'" sh="'+(t.sourceHeight||"")+'" class="msg-img '+i+'"/>'})},this.handleMsgVideo=function(e){var t=/\bsrc\b\s*=\s*[\'\"]?([^\'\"]*)[\'\"]?/i;return e=e&&e.replace(/<video\b.*?(?:\>|\/>)/gi,function(e){var i=t.exec(e),a="";return i.length>1&&(a=i[1]),'<div class="msg-media msg-video msg-videotag bgwhite" videourl='+a+'> <div class="msg-video-angle"></div></div>'})};this.getVisEvtHtml=function(e){if(e.urlForVisitor){e.urlForVisitor=e.urlForVisitor.replace(/\s/g,"");var t=e.urlForVisitor.match(/^http\(['"]?([^'",]+)['"]?(\,['"]?(blank|inner)['"]?)?\)/i)||e.urlForVisitor.match(/^xcx\(['"]?([^'",]+)['"]?(\,['"]?(navigateTo|redirectTo|switchTab)['"]?)?\)/i);t?(e.url=t[1],e.openType=t[3]):e.url=""}else if(0==e.urlEnableForVisitor&&(e.url=void 0,delete e.url),e.url){var i=e.url.replace(/\s/g,"").match(/^apiUrl\(['"]?(\d+)['"]?(\,['"]?(reload|hash)['"]?)?\)/);i?e.toCrmUrlId=i[1]:(e.url.match(/(^http[s]?:)|(^file:)/i)||(e.url=""),e.toCrmUrlId=!1)}var a="";e.imageUrl&&(e.imageUrl=e.imageUrl.replace(/["']/,""),a=e.imageUrl?'<img onerror="view.imgError&&view.imgError(this)" class="custom-event-img" src="'+e.imageUrl+'"/>':"",e.url&&!e.toCrmUrlId||(a=this.handleMsgImg(a,e,"custom-event-img",e.imageUrl)));return function(e,t){var i=t?" border0":"";return e?'<div class="custom-event'+i+'"><div class="custom-event-wrap">{{imageUrl}}<div class="custom-event-content"><div class="custom-event-title" style="height:auto;margin-bottom:0;" title="{{title1}}">{{title}}</div><div class="custom-event-detail">{{content}}</div></div></div>{{memo}}</div>':'<a class="custom-event'+i+'" {{linkset}}><div class="custom-event-wrap">{{imageUrl}}<div class="custom-event-content"><div class="custom-event-title" style="height:auto;margin-bottom:0;" title="{{title1}}">{{title}}</div><div class="custom-event-detail">{{content}}</div></div></div>{{memo}}</a>'}(!e.url||e.toCrmUrlId,3==e.mst).replace(/\{\{linkset\}\}/,!e.url||e.toCrmUrlId?"":' href="'+e.url+("inner"==e.openType?'" target="inner" title="'+(e.title||lanRes.interactWnd)+'" ':"navigateTo"==e.openType||"redirectTo"==e.openType||"switchTab"==e.openType?'" target="'+e.openType+'" ':'" target="_blank" ')).replace(/\{\{title1\}\}/,l.escapeHtml(e.title)||"").replace(/\{\{title\}\}/,e.title||"").replace(/\{\{imageUrl\}\}/,a).replace(/\{\{content\}\}/,e.content||"").replace(/\{\{memo\}\}/,e.memo?'<div class="custom-event-memo">'+e.memo+"</div>":"")},this.subscribe("receiveVisEvt",function(e,t,i){if(!t.notStore&&t.talkId&&(l.talkId=t.talkId),2!=t.visibility){if(t.notStore&&t.c)return l._getMsg(t,5,t.c,t.f);l.isInRobot&&(t.ff="r");var a=l.getVisEvtHtml(t);2==t.customizeMsgType||3==t.mst?l._getMsg(t,5,'<li class="clearfix custom-event-li" id="msg'+t.tm+'">'+a+"</li>","x"):t.mst&&1!=t.mst?2==t.mst&&l._getMsg(t,5,a,i?"r":"s"):(l._getMsg(t,5,a,"c"),!t.notEnd&&l.publish("__visitorSendMsg","["+lanRes.imageAndHtml+"]"+(t.title||"")),!t.notEnd&&l.publish("__visitorStartSendMsg","["+lanRes.imageAndHtml+"]"+(t.title||"")),t.notStore||t.notEnd||"1"!=t.closeURLPage||(view.hideURLSite&&view.hideURLSite(),view.hideMenus&&view.hideMenus()),l.publish("_addSendMsgNum",t))}}),this.subscribe("receiveURL",function(e,t){var i=t.pushUrlDetail.url,a="";if(view.chat.needHttps&&i.match(/^http:/i)&&(a=" push-blank"),view.pushURLParam){var n=i.split("#");i=n[0]+(n[1]?"#"+n[1]:"")}var s='<a class="push-url clearfix'+a+'" target="info_frame3" href="'+i+'"><div class="push-icon echat bg1"></div><div class="push-content"><div class="push-name">'+l.stringEncode(t.pushUrlDetail.urlName)+' </div><div class="push-url-link">'+t.pushUrlDetail.url+"</div></div></a>";l._getMsg.call(this,t,6,s,"s"),t.notStore||t.notEnd||1==l.queryParams.echatIframeDisable||-1!=i.indexOf("echatIframeDisable=1")||view.handlePushURL&&view.handlePushURL(i,void 0,l.stringEncode(t.pushUrlDetail.urlName))}),this.subscribe("receiveForm",function(e,t){if(t.template){location.origin.match(/^http(s)?/)&&(t.formUrl=t.formUrl.replace(/^http(s)?:\/\/(.*?)\//,location.origin+"/"));var i=view.chat.getCSSRule(".bg0"),a=(view.chat.getCSSRule(".color0"),t.template),n=a.detailList||[],s=t.formUrl+"&visitorId="+t.visitorId+"&talkId="+t.talkId+"&sendId="+t.sendId+"&companyId="+view.chat.companyId+"&isVisitor=1&bgColor="+encodeURIComponent(i.style.backgroundColor||"")+"&dataHost="+encodeURIComponent(l.dataHost)+"&apiServerDomain="+encodeURIComponent(l.apiServerDomain),o=n.slice().splice(0,4),r='<li class="clearfix" style="padding: 5px 0;" id="msg'+t.tm+'"><a title="'+a.name+'" class="push-url clearfix form-link-box" target="'+(1==Number(view.windowType)?"info_frame3":"inner")+'" href="'+encodeURI(s)+'"><div style="text-align: center;font-size: 13px;font-weight: bold;padding: 0 0 10px;border-bottom: 1px solid #f3f3f3;color: #000;">'+a.name+'</div><ul style="line-height: 18px;padding: 5px 10px;color: #999;">'+function(){var e="";for(var t in o)e+="<li>"+o[t].label+"</li>";return e}()+'</ul><div style="text-align: center;padding: 5px;margin: 0 10px;border-radius: 15px;" class="bg0"><span style="">点击填写</span></div></a></li>';if(1==a.openType&&(!t.fromHistory||!1===t.isForward))switch(Number(view.windowType)){case 1:view.handlePushURL(encodeURI(s));break;default:view.showURLLink&&view.showURLLink(a.name,encodeURI(s))}delete t.template.openType,t.content=a.name,l._getMsg.call(this,t,10,r,"x",t.template)}}),this.subscribe("submitForm",function(e,t){if(t.template){location.origin.match(/^http(s)?/)&&(t.formUrl=t.formUrl.replace(/^http(s)?:\/\/(.*?)\//,location.origin+"/"));var i=view.chat.getCSSRule(".bg0"),a=t.template,n=t.formUrl+"&visitorId="+t.visitorId+"&talkId="+t.talkId+"&formInfoId="+t.formInfo.id+"&companyId="+view.chat.companyId+"&isVisitor=1&bgColor="+encodeURIComponent(i.style.backgroundColor||"")+"&dataHost="+encodeURIComponent(l.dataHost)+"&apiServerDomain="+encodeURIComponent(l.apiServerDomain)+"&showResult=1&tm="+(new Date).getTime(),s='<li class="clearfix" style="padding: 5px 0;" id="msg'+t.tm+'"><a target="'+(1==Number(view.windowType)?"info_frame3":"inner")+'" href="'+encodeURI(n)+'" href="" style="width: 220px;margin: 0 auto;padding: 10px;background-color: #fff;border-radius: 6px;font-weight: bold;display:block;text-decoration:none;color:#000;"><span style="background-image: url(/visitor/common/img/success.png);width: 20px;display: inline-block;height: 20px;background-size: 100%;background-repeat: no-repeat;vertical-align: middle;margin-right: 5px;"></span><span>'+a.commitMsg+'</span><span style="float: right;color: #ddd;">></span></a></li>';t.content=a.name,l._getMsg.call(this,t,10,s,"x",a),l.publish("_addSendMsgNum",t)}}),this.subscribe("getMsgImg",function(t,i,a){l.needHttps&&(l.qiniuDomain&&l.qiniuHttpsDomain&&(i.bigImg&&(i.bigImg=i.bigImg.replace(l.qiniuDomain,l.qiniuHttpsDomain)),i.smallImg&&(i.smallImg=i.smallImg.replace(l.qiniuDomain,l.qiniuHttpsDomain)),i.sourceImg&&(i.sourceImg=i.sourceImg.replace(l.qiniuDomain,l.qiniuHttpsDomain))),i.bigImg&&(i.bigImg=i.bigImg.replace(/^http:/,l.needHttps)),i.smallImg&&(i.smallImg=i.smallImg.replace(/^http:/,l.needHttps)),i.sourceImg&&(i.sourceImg=i.sourceImg.replace(/^http:/,l.needHttps))),i.fileName&&"temp.png"!=i.fileName&&"image.png"!=i.fileName||(i.fileName="Echat"+(new Date).format("yyyyMMddhhmmss")+".png"),i.sourceImg=i.sourceImg||i.bigImg;var n=view.showMsgImg&&view.showMsgImg(i)||"<img "+(i.notEnd?"":'onload="javascript:view.scrollToBottom()"')+' id="img'+(i.fileIdentity||i.tm||(new Date).getTime())+'" attname="'+i.fileName+'" bigimg="'+(i.bigImg||i.sourceImg)+'" src="'+i.smallImg+'" source="'+(i.sourceImg||"")+'" sw="'+(i.sourceWidth||"")+'" sh="'+(i.sourceHeight||"")+'" class="msg-img"/>';i.fileIdentity&&_$(i.clientFileId||i.fileIdentity)&&(l.addSendFile(),l.publish("__visitorSendMsg","["+lanRes.image+"]")),l.sendingFileToken&&l.sendingFileToken.end&&l.sendingFileToken.token==i.fileIdentity&&(l.sendingFileToken="",l.publish("_toggleEnableFile",!0)),i.id=i.clientFileId||i.identityKey||i.fileIdentity,l._getMsg.call(this,i,2,n,865==i.mt?"c":a?"r":"s"),setTimeout(function(){e("#"+i.id).attr("id",i.mid)}),view.initImgPlay&&view.initImgPlay(),l.isInRobot||865!=i.mt&&"local"!=i.mt||l.publish("_addSendMsgNum",i)}),this.subscribe("getMsgFile",function(t,i,a){l.needHttps&&i.fileUrl&&(l.qiniuDomain&&l.qiniuHttpsDomain&&(i.fileUrl=i.fileUrl.replace(l.qiniuDomain,l.qiniuHttpsDomain)),i.fileUrl=i.fileUrl.replace(/^http:/,l.needHttps)),!_$("downFrame")&&_$("downFileFrame")&&(_$("downFileFrame").innerHTML='<iframe id="downFile" name="downFile" style="display:none;"></iframe>');var n,s,o,r="downFile",d=i.fileUrl;l.isIOS&&(r="_blank"),(n=view.SDKNative?view.getMsgFile(i):i.c?i.c:"")||(s=i.fileUrl&&i.fileUrl.indexOf("?")>0?"&":"?",o=i.fileUrl+s+"attname="+encodeURIComponent(i.fileName),n=view.SDK||2!=i.fileType||window.ltIE10?'<div class="file-info"><div class="file-name">'+i.fileName+'</div><div class="file-size">'+(parseInt(i.fileSize/1024)+1)+'KB</div></div><div class="file-icon">&nbsp;</div><a class="file-link file-link-a color0" href="'+o+'" target="'+r+'">'+lanRes.download+"</a>":l.isMobile||view.hasNative&&window.__playVideo?'<div class="file-video" identity="'+i.fileIdentity+'" onclick="__playVideo(\''+d+"','"+(i.videoThumbUrl||"")+"','"+o+"','"+(i.fileName||"")+'\')" style="'+(i.videoThumbUrl?"background:url("+i.videoThumbUrl+") no-repeat;background-size:100%;":"")+'"><div class="icon_video"></div><div class="video_logo">VIDEO</div></di>':'<a class="file-video" target="_blank" href="/visitor/pc/video.html?videoUrl='+encodeURIComponent(o)+'" style="'+(i.videoThumbUrl?"background:url("+i.videoThumbUrl+") no-repeat;background-size:100%;":"")+'"><div class="icon_video"></div><div class="video_logo">VIDEO</div></a>');866==i.mt&&(i.fileIdentity||i.identityKey)&&(_$(i.clientFileId)||_$(i.fileIdentity||i.identityKey))&&(l.addSendFile(),l.publish("__visitorSendMsg","["+(2==i.fileType?lanRes.video:lanRes.fileHtml)+"]")),l.sendingFileToken&&l.sendingFileToken.end&&l.sendingFileToken==i.fileIdentity&&(l.sendingFileToken="",l.publish("_toggleEnableFile",!0)),i.id=i.clientFileId||i.identityKey||i.fileIdentity,l._getMsg.call(this,i,3==i.fileType||4==i.fileType?i.fileType:1,n,866==i.mt||"local"==i.mt?"c":a?"r":"s"),setTimeout(function(){e("#"+i.id).attr("id",i.mid)}),l.isInRobot||866!=i.mt&&"local"!=i.mt||l.publish("_addSendMsgNum",i)}),l.subscribe("_toggleEnableFile",function(i,a){if(!l.hasFormData){var n;(n=_$("file_up").contentDocument)||(n=t.frames.file_up.document);var s=n.getElementById("uploadInput");a?(e(".menu-file").removeClass("menu-file-sending").attr("title",lanRes.selectFile),s.setAttribute("disabled",""),s.disabled=!1,s.removeAttribute("disabled"),s.title=lanRes.selectFile,s.setAttribute("title",lanRes.selectFile)):(e(".menu-file").addClass("menu-file-sending").attr("title",l.sendingTitle),s.disabled="disabled",s.setAttribute("disabled","disabled"),s.title=l.sendingTitle,s.setAttribute("title",l.sendingTitle))}}),this.subscribe("getMsg",function(t,i){var a=(i.translation||i.content)+"";if(i.relateId){this.changeStorgeBackMsg(i.relateId);if(_$(i.relateId+"")){e("#"+i.relateId).html("");var n='<div style="padding: 10px 0 20px;text-align: center;"><span style="display: inline-block;padding: 8px 10px;background-color: #bfbfbf;border-radius: 5px;color: #FFF;">'+lanRes.backMsgTip+"</span></div>";e("#"+i.relateId).html(n)}}a&&"undefined"!==a&&(a=this.handleMsgImg(a,i),view.SDKNative&&(a=this.handleMsgVideo(a)),a=a.replace(/&nbsp;([^&\s])/g," $1"),i.staffImg||i.notStore||(i.staffId=l.staffId),l._getMsg.call(this,i,0,a),1!=i.outerMsg&&l.postMessage({type:"staffSendEvt",msg:i.content||i.c}))}),l.robotUnknowTime=0,this.subscribe("getMsgRobot",function(t,a){if("r"==a.f&&a.c)return l._getMsg.call(this,{talkId:a.talkId,tm:a.tm,mt:12001,ff:"r",staffImg:a.staffImg,staffName:a.staffName,content:a.c,notEnd:!0,notStore:!0},0,a.c,"r");var n,s,o,r,d,c,f=a.knowledgeAnswerList||[],u="",m='<ul class="question-list">',h='<div class="ipt-list">';if(a.nonTextMsg)10011==(u=a.nonTextMsg).mt?l.publish("receiveVisEvt",u,!0):641==u.mt?l.publish("getMsgImg",u,!0):642==u.mt&&l.publish("getMsgFile",u,!0);else if(4==a.type){if(a.notStore||a.fromDB||a.history)return;r=(o=a.segWords||[]).length>0;for(var p,g=!1,v=0,b=0;b<f.length;b++){if(n=f[b],s=n.question,g=!1,s==l.lastText&&r){b++,v=1,h='<div class="ipt-list"><a class="ipt-list-li" did="'+n.docId+'" ques="'+escape(n.question)+'"><b class="words-seg">'+s+"</b></a>";break}if(r){0;for(I=0;I<o.length;I++)p=o[I],p=l.escapeRegExp(p),s=s.replace(new RegExp(p,"igm"),function(e,t){g=!0;var i=arguments.length,a=arguments[i-2];if(!(a>0))return d='<b class="words-seg">'+e+"</b>";var n=arguments[i-1].substring(0,a),s=arguments[i-1].substring(a);if(p.match(/^s|sp|spa|span$/)&&n.match(/<$/))return e;if(p.match(/^n|an|pan|span$/)){var o="</span>".replace(p,",").split(",");if(n.match(new RegExp(o[0])&&s.match(o[1])))return e}return/(\<span[^>]*>([^<]+(?!\<\/span\>))?$)|(\<[a-zA-Z]+[^>]*$)/gi.test(n)?e:d='<b class="words-seg">'+e+"</b>"})}!g&&r||(v++,h+='<a class="ipt-list-li" did="'+n.docId+'" ques="'+escape(n.question)+'">'+s+"</a>")}v>0?e("#input_suggest").html(h+"</ul>").removeClass("hide"):(e("#input_suggest").addClass("hide").html(" "),view.resetContainerBaseFoot&&view.resetContainerBaseFoot())}else if(3==a.type)a.f,a.tip=a.tips,204==a.result||205==a.result?(l.showInfoTip(a,void 0,void 0,void 0,a.talkId),a.notStore||(l.robotToHumanKey=a.robotToHumanKey,l.publish("toSetID"),e("#input_suggest").addClass("hide").html(" "),view.resetContainerBaseFoot&&view.resetContainerBaseFoot(),l.handleNewMsgMid(a.mid,{c:a.tips,f:"sys",m:0},!0,a)),delete l.paramChat.staffId,delete l.paramChat.staffName,delete l.paramChat.staffPhoto,delete l.paramChat.talkId):206==a.result||202==a.result?console.log(206==a.result?"禁用留言":"禁用转人工"):207==a.result&&(l.showInfoTip(a,void 0,void 0,void 0,a.talkId),a.notStore||(1===a.companyStatus?e("#robotToStaffWord").html(l.msg649.robotWordsInfo.onlineButtonWords||lanRes.robotToStaff):e("#robotToStaffWord").html(l.msg649.robotWordsInfo.offlineButtonWords||lanRes.robotToStaff),e("#robotToStaff").show(),i(l),view.showRobotToStaff&&view.showRobotToStaff(a),view.handleShowRobotToStaff&&view.handleShowRobotToStaff(),l.handleNewMsgMid(a.mid,{c:a.tips,f:"sys",m:0},!0,a)));else if(5==a.type){(u=(u=a.tips||"").replace(/&nbsp;([^&\s])/g," $1"))&&l._getMsg.call(this,e.extend(a,{ff:"r",staffImg:a.staffImg||l.staffImg,staffName:a.staffName||l.staffName,content:'<div class="msg-item-robot">'+u+"</div>",notEnd:"r"==a.f,notStore:"r"==a.f,talkId:a.talkId}),0,'<div class="msg-item-robot">'+u+"</div>","r");var y,w=e("#q"+a.robotDetailId);a.feedback&&e(w).attr("did","").attr("qid","").addClass("robot-feedback-had").addClass("robot-feedback-had"+a.feedback).attr("feedback",a.feedback),2==a.feedback&&e(".feedback-btn-unsolve",w.results[0]).addClass("feedback-btn-unsolve-sel"),1==a.feedback&&e(".feedback-btn-solve",w.results[0]).addClass("feedback-btn-solve-sel"),a.feedbackSubitem&&(2==(y=e(w).attr("feedback"))?(e(".feedback-sub-solved",w.results[0]).remove(),console.log(e(".feedback-sub-li",w.results[0])),e(".feedback-sub-li",w.results[0]).each(function(){e(".feedback-sub-content",this).text()==a.feedbackSubitem&&(e(this).addClass("feedback-sub-sel2"),e(".feedback-sub-list",w.results[0]).addClass("robot-feedback-sub-had"))})):1==y&&(e(".feedback-sub-unsolved",w.results[0]).remove(),e(".feedback-sub-li",w.results[0]).each(function(){e(".feedback-sub-content",this).text()==a.feedbackSubitem&&(e(this).addClass("feedback-sub-sel1"),e(".feedback-sub-list",w.results[0]).addClass("robot-feedback-sub-had"))})),setTimeout(function(){view.scrollUpdate&&view.scrollUpdate()},100))}else if(6==a.type)(u=(u=a.tips||"").replace(/&nbsp;([^&\s])/g," $1"))&&l._getMsg.call(this,e.extend(a,{ff:"r",staffImg:a.staffImg||l.staffImg,staffName:a.staffName||l.staffName,content:'<div class="msg-item-robot">'+u+"</div>"}),0,'<div class="msg-item-robot">'+u+"</div>","r");else if(7==a.type)u=a.tips||a.content||"",l.showInfoTip(u),a.notStore&&l.handleNewMsgMid(a.mid,{c:u,f:"sys",m:0},!0,a);else if(1==a.type||2==a.type){if((n=f[0])?1==n.answerType&&n.suggestions.length>0?(u+=n.answer||"",c=n.suggestions,m+='<div class="robot-tip">'+(a.tips||"")+"</div>"):1==n.answerType?u+=a.tips||"":2==n.answerType?(u+='<div class="robot-tip">'+(a.tips||"")+"</div>",u+=n.answer||"",c=n.relateKnowledges,m+='<div class="robot-tip margin-top10">'+(a.tipsExt||"")+"</div>"):3==n.answerType?(c=n.suggestions,m+='<div class="robot-tip">'+(a.tips||"")+"</div>"):4==n.answerType?u+=n.answer||"":5==n.answerType?(u+=n.answer||"",c=n.relateKnowledges,m+='<div class="robot-tip">'+(a.tips||"")+"</div>"):6==n.answerType&&(u+=n.answer||"",c=n.relateKnowledges,m+='<div class="robot-tip margin-top10">'+(a.tips||"")+"</div>"):u+=a.tips||"",c&&c.length){for(var I=0;I<c.length;I++)m+='<li class="question-list-li" oid="'+n.docId+'" did="'+c[I].docId+'" ques="'+escape(c[I].question)+'"><span class="list-style-dot">'+(I+1)+'. </span><span class="color-link">'+c[I].question+"</span></li>";m+="</ul>"}else m="";var T,k="";1==n.feedback&&l.robotFeedback&&(!n.searchId&&(n.searchId=""),!n.originQuestion&&(n.originQuestion=""),T=a.relateId&&l.robotFeedbackTemp&&l.robotFeedbackTemp[a.relateId]||{},a.feedback=a.feedback||T.feedbackResult,k='<div id="q'+n.robotDetailId+'" class="robot-feedback'+(a.feedback?" robot-feedback-had robot-feedback-had"+a.feedback+'"':'" did="'+n.docId+'" qid="'+n.queryId+'" rid="'+n.robotDetailId+'" searchId="'+n.searchId+'" originQuestion="'+escape(n.originQuestion)+'"')+">"+l.robotFeedback({feedback:a.feedback,feedbackSubitem:T.feedbackSubitem,answerItem:n})),((u=(u=l.handleMsgImg(u,a)).replace(/&nbsp;([^&\s])/g," $1"))||m)&&l._getMsg.call(this,e.extend(a,{ff:"r",staffImg:a.staffImg||l.staffImg,staffName:a.staffName||l.staffName,answer:u,content:'<div class="msg-item-robot">'+u+m+"</div>"}),0,'<div class="msg-item-robot">'+u+m+"</div>"+k,"r")}}),this.subscribe("getMsgMine",function(e,t){var i=t.content;l.isInRobot&&(t.ff="r"),l.isInRobot||l.publish("_addSendMsgNum",t),l._getMsg.call(this,t,0,i,"c")}),this.resendFile=function(t,i){var a=this,n=t.uploadServiceType,s=a.uploadUtil.getNextUploadType(n);return!1!==s?(a.publish("sendVisitorEvent",{et:123,ssl:a.needHttps?1:void 0,uploadServiceType:s,ft:t.fileType},function(t){!t.successful||t.failure?!1===t.autoResend&&a.handleFileSelect.error():e("#"+i).remove()}),!1):(a.publish("getErr",{reqInfo:i,code:-2}),!0)},this.subscribe("getFileToken",function(i,a){if(view.tempPlusFilePath&&view.tempPlusFilePath.length)return o(a);2==a.fileType&&l.handleFileSelect.back();for(var n,s,r=l.fileUploadInfos["uploadServiceType"+a.uploadServiceType]||a,d={},c=l.needHttps?r.fileUploadHttpsUrl:r.fileUploadUrl,f=a.qiniuKey||a.token||a.aliyunKey&&a.aliyunKey.match(/\/([^\/]+$)/)[1],u=null,m=r.fileUploadParam.split(","),h=0;h<m.length;h++)d[m[h].split("=")[0]]=(u=m[h].match(/\$\{([^\}]+)\}/))?a[u[1]]:m[h].split("=")[1];if(a.fileType=a.fileType||2,1==a.fileType){if(!l.pasteFileSource)return;(_=new FormData).append("file",l.pasteFileSource)}if(a.uploadServiceType==l.uploadUtil.getLastUploadType()&&(c+="?token="+a.token),2!=a.fileType&&3!=a.fileType&&4!=a.fileType)1==a.fileType||(5==a.fileType?(l.fileToken=a,l.publish("_captureImg",null)):6==a.fileType&&(l.fileToken=a,l.publish("_captureImgIE",null)));else{x=t;l.hasFormData||(x=_$("file_up").contentDocument)||(x=t.frames.file_up.document);var p=x.getElementById("uploadInput"),v=p.value||p.getAttribute("value");if(!v)return void console.log("no file to send",v);for(var y,w=(p.files||[{}]).length,I=0;I<w;I++)if(0===b[I+""]||3===b[I+""]){y=I;break}var T=y+1===w;if(p.files){if(!p.files[y]||!p.files[y].size)return void console.log("no file to send",v);(p.files[y]||p.files[y].name)&&(v=p.files[y].name)}if(n=v.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1"),l.hasFormData){try{s=new FormData;for(var k in d)"Content-Disposition"!=k&&"x:filename"!=k||(d[k]=n),s.append(k,d[k]);s.append("file",p.files[y],n);var S=new XMLHttpRequest;S.open("POST",c,!0);var C=!1;S.onerror=S.ontimeout=S.onabort=function(){b[y]=3,!C&&l.resendFile(a,f),C=!0},S.addEventListener("load",function(e){200==S.status&&S.responseText&&(1==S.responseText||S.responseText.match(/\{\s*"errorCode"\s*:\s*1\s*}/))?(b[y]=2,T&&setTimeout(function(){t.forms.namedItem("uploadForm").reset()})):403==S.status||S.responseText&&S.responseText.match(/\{\s*"errorCode"\s*:\s*146\s*}/)||S.responseText&&S.responseText.match(/\{\s*"errorCode"\s*:\s*117\s*}/)?(b[y]=4,l.publish("getErr",{reqInfo:f,code:-2}),setTimeout(function(){t.forms.namedItem("uploadForm").reset()})):(b[y]=3,!C&&l.resendFile(a,f),C=!0)}),b[y]=1,S.send(s),_$(f)||l.showMsg({id:f,f:"c"},'<div class="file-sending">'+lanRes.fileSending+"</div>"),l.sendingFileToken={token:f,end:!0}}catch(e){if(!T)return;l.hasFormData=!1,l.hasInitFile=!1,l.addSendFile(),g=null,console.log("变为iframe上传")}T&&(p=s=null)}else{var x;(x=_$("file_up").contentDocument)||(x=t.frames.file_up.document);var _=x.getElementById("uploadForm");for(var k in d)if("Content-Disposition"!=k&&"x:filename"!=k||(d[k]=n),_[k])_[k].value=d[k];else{var E=x.createElement("input");E.name=k,E.type="hidden",E.value=d[k],_.insertBefore(E,p)}e(_).attr("action",c),_.submit(),l.showMsg({id:f,f:"c"},'<div class="file-sending">'+lanRes.fileSending+"</div>"),setTimeout(function(){l.sendingFileToken={token:f,end:!0},l.publish("_toggleEnableFile",!1)},10)}}}),this.subscribe("niuniuKey",function(e,t){if(t){var i=t.split(","),a=new Date,n=a.getFullYear()+""+(a.getMonth()+1)+a.getDate();a.setDate(a.getDate()+1);var s=a.getFullYear()+""+(a.getMonth()+1)+a.getDate();l["niuniu"+n]=i[0],l["niuniu"+s]=i[1]}});var h=navigator.userAgent.toLowerCase(),p=(h.indexOf("baidubrowser"),h.indexOf("mqqbrowser")>-1&&this.Device.OS,"uc"==this.Browser.browser);l.isMobile||l.isInRobot?this.bindPlainTextEvent():l.changeToIframe(),p&&e("#footer").addClass("footer-absolute");var g;l.resetForm=function(e){var i;if(l.hasFormData)i=t.forms.namedItem("uploadForm").reset();else{var a=_$("file_up").contentDocument||t.frames.file_up.document;i=a.getElementById("uploadForm")}setTimeout(function(){i&&i.reset()},e||10)},l.handleFileSelect=function(){var e,t,i="tempInitSendFile";return{back:function(){--e<1&&l.publish("enableSelectFile",i)},error:function(){--e<1&&l.publish("enableSelectFile",i)},change:function(a){t=e=a,l.publish("disableSelectFile",i)},isSending:function(){return e>0},reset:function(){t=e=0,l.publish("enableSelectFile",i)}}}(),l.subscribe("enableSelectFile",function(t,i){e(".menu-file").removeClass("menu-file-disabled"),e("#"+i).remove()}),l.subscribe("disableSelectFile",function(t,i){l.showMsg({id:i,f:"c"},'<div class="file-sending">'+lanRes.fileSending+"</div>"),e(".menu-file").addClass("menu-file-disabled")}),e("body").on("click",".menu-file-disabled",function(){l.handleFileSelect.isSending?l.showTip(lanRes.fileDisable):l.handleFileSelect.reset()});var v=function(t){return!(t>9)||(l.isMobile?(_$("leave_tip_con").innerHTML=lanRes.visitor176,l.tipTimer&&clearTimeout(l.tipTimer),e("#leave_tip").removeClass("tiphide"),l.tipTimer=setTimeout(function(){e("#leave_tip").addClass("tiphide")},3e3)):l.showDialog({tip:lanRes.visitor177,cancel:!1}),!1)},b={};window.fLoad=function(i){i||(i=_$("file_up").contentDocument)||(i=t.frames.file_up.document);var a=i.getElementById("uploadInput");view.dji&&(a.style.height="62px"),"1"===view.chat.queryParams.multipleFile&&(e(a).attr("multiple","multiple"),e(a).attr("title",lanRes.visitor176)),a.onchange=function(){function t(){if(l.outerChatStatus&&l.outerChatStatus.match(/(waiting|chatting|leaveToService|workorder)/))!function(){if(!l.outerChatStatus||!0===l.companyOff||l.busyCanSend&&"0"!=l.queryParams.autoChat||!0===l.chatting){var t=a.value||a.getAttribute("value");if(!v((a.files||[{}]).length))return!1;if(t){var i,n=t,s=(a.files||[{}]).length;l.handleFileSelect.change(s);for(var o=0;o<s;o++){if(a.files){if(!a.files[o]||!a.files[o].size){console.log("no file to send",t),l.handleFileSelect.error();continue}(a.files[o]||a.files[o].name)&&(t=a.files[o].name)}i=-1!=t.indexOf(".")?t.replace(/.*\./,""):"";var r=t.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1");l.sendingTitle=r+"."+i+lanRes.fileSendWait;var d="";for(var c in l.uploadFileTypeKey)d+="<div>"+c+":"+l.uploadFileTypeKey[c].join("、")+"</div>";i&&-1==(","+l.uploadFileType+",").indexOf(","+i.toLowerCase()+",")?(l.showDialog({tip:'ERROR: 文件格式不支持，请压缩后发送。</br><span class="color0" id="supportFileType">'+lanRes.supportFileType+"</span><div style='display:none;cursor: pointer;' id='supportFiles'>"+d+"</div>",cancel:!1,contentStyle:"text-align: left",callback:function(){function t(t){e("#supportFiles").show()}e("#supportFileType").off("click",t),e("#supportFileType").on("click",t)}}),l.handleFileSelect.error()):l.getFileSize(a,o)>l.uploadFileSize?(l.showDialog({tip:lanRes.fileSizeOut.replace("${maxSize}",l.uploadFileSize/1024/1024+"M"),cancel:!1}),l.handleFileSelect.error()):(b[o+""]=0,a.files&&(n=a.files[o]),g=n,l.publish("sendVisitorEvent",{et:123,ssl:l.needHttps?1:void 0,uploadServiceType:l.uploadUtil.getUploadServiceType(),ft:2},function(e){e.successful&&!e.failure||!1===e.autoResend&&l.handleFileSelect.error()}),view.hideMenus&&view.hideMenus(0,!1))}}else console.log("no file to send",t)}else e("#busyTipLine").removeClass("hide").show()}();else{if(i>15)return;i++,setTimeout(t,80)}}b={};var i=0;t()},a.onclick=function(){view.hideMenus(),l.sendingFileToken}},l.addSendFile(),l.emojitimer=setTimeout(function(){try{l.loadEmoji()}catch(e){}},100),this.subscribe("getErr",function(t,i){var a=i.reqInfo,n=a&&_$(a);switch(i.code){case 16:e(".file-sending",n).html(lanRes.tooLargeUploadFail);break;case 17:e(".file-sending",n).html(lanRes.unsupportFileType);break;case 18:default:e(".file-sending",n).html(lanRes.unkownErrorUpload)}16!=i.code&&17!=i.code&&18!=i.code||l.addSendFile()}),this.subscribe("removeThisHistory",function(){l.lasMid=0,l.isRemoveThisHis=!0});var y=!1;this.subscribe("getHistory",function(t,i){function a(e){return(!d||e-d>6e4)&&(d=e,!0)}function n(e){}if(l.talkId=i.talkId,l.isRemoveThisHis&&(l.isRemoveThisHis=!1,e(".list-msg-his").remove()),!y){y=!0,setTimeout(function(){y=!1},1e3);var s,o,r=i.chatDetailList,d=0;if(l.robotFeedbackTemp={},l.isArray(r)){_$("list_msg");var c=l.getHistoryByTalkId(i.talkId),f=l.lasMid;c&&c.order&&c.order.length&&(f=c[c.order[c.order.length-1]].mid),l.sendMsgNum=0,orderedStaffInfo={},l.hasGetHistory=!0;for(var u=0;u<r.length;u++){if(s=r[u],o=s,s.mid<=f){if(1===view.miniTempCloseWs||l.hasGetHistory)continue;s.notStore=!0,s.notEnd=!0}if(315==s.dataType&&s.data&&(864==(s=JSON.parse(s.data)).mt&&l.isInRobot&&o.feedbackResult?l.robotFeedbackTemp[o.id]={feedbackResult:o.feedbackResult,feedbackSubitem:o.feedbackSubitem}:s.relateId=o.relateId||s.relateId),!(s.mt>1e3&&"10001"!=s.mt&&"10010"!=s.mt&&"10011"!=s.mt&&"12001"!=s.mt||_$("msg"+s.tm)||_$(""+s.mid)||_$(""+s.id)||_$(""+s.tmf)||(864==s.mt||865==s.mt||866==s.mt)&&n(s.mid))){if(s.notEnd=!0,864==s.mt)l.publish("_addSendMsgNum",s);else if("10001"==s.mt||"686"==s.mt){if(orderedStaffInfo=l.updateStaffInfo(void 0,{staffId:s.toStaffId||s.staffId,staffNickName:s.staffNickName||s.toStaffNickName,staffDetailInfo:s.staffDetailInfo||s.toStaffDetailInfo}),"686"==s.mt)continue}else orderedStaffInfo.staffName&&(s=e.extend(s,orderedStaffInfo));if("10001"!=s.mt)if("10011"!=s.mt)if(865!=s.mt&&641!=s.mt)if(647!=s.mt&&"10010"!=s.mt&&605!=s.mt)if(866!=s.mt&&642!=s.mt)if(680!=s.mt)if(640!=s.mt)if(655!=s.mt)if(688!=s.mt)if(959!=s.mt)if(658!=s.mt){if(890==s.mt)1==s.templateInfoList[0].type||3==s.templateInfoList[0].type?(s.content=l.getBookComfirm(s.templateInfoList),s.m=3):(s.content=l.showInfoTip({f:"sys",tip:lanRes.receiveBookForm},void 0,void 0,!0,s.talkId,s.tm,!0),s.m=4);else if("12001"==s.mt){l.publish("getMsgRobot",s);continue}var m={t:a(s.tm)?new Date(s.tm).format("hh:mm"):void 0,tm:s.tm,mt:s.mt,c:s.content,ff:l.isInRobot?"r":void 0,f:864==s.mt?"c":890==s.mt?"x":"s",m:s.m||0,id:"msg"+(s.mid||s.tm),talkId:i.talkId,notEnd:!0,mid:s.mid};l.showMsg(m),delete m.id,3==m.m&&(m.c=s.templateInfoList),delete m.notEnd,l.pushHistory(m)}else l.publish("orderReply",s);else l.publish("submitForm",s);else l.publish("receiveForm",s);else l.publish("getLeaveMsg",s);else s.id=s.mid,l.publish("getMsg",s);else l.publish("receiveURL",s);else l.publish("getMsgFile",s);else{if(8==s.type)continue;l.publish("getSysMsg",s)}else l.publish("getMsgImg",s);else l.publish("receiveVisEvt",s);else l.staffMap[s.toStaffId]&&l.publish("getSysMsg",{talkId:i.talkId,tm:s.tm,mt:"10001",mid:s.mid,notStore:s.notStore,notEnd:s.notEnd,staffId:s.toStaffId,staffName:l.staffMap[s.toStaffId].staffName},s)}}if(setTimeout(function(){view.scrollToBottom(),l.isMobile&&e("#footer").removeClass("hide"),view.hideMenus(),l.wait874List=!1,l.publish("removeLoading")},10),l.isMobile&&"none"!=_$("loading").style.display&&e("#footer").addClass("hide"),view.miniShow){var h=e.store("ECHAT_"+view.chat.companyId+"_"+view.chat.visitorId+"_mid");h&&e.store("ECHAT_"+l.companyId+"_"+window.chatVisitorId+"_mid_read",h)}}else l.wait874List=!1,l.publish("removeLoading")}}),this.subscribe("getSysMsg",function(t,i){if((l.chatting||2!=i.type)&&11!=i.type){var a;if("10001"==i.mt)return a=(i.toStaffNickName||i.staffName||lanRes.serviceStaff)+" "+lanRes.transferStaff,l.showInfoTip(a,"msg"+i.tm,void 0,void 0,i.talkId,i.tm,i.notEnd),i.c="10001",i.f="x",void(i.notStore&&(l.pushHistory(i),l.handleNewMsgMid(i.mid,{m:0,f:"sys",c:a},!0,i)));if("647"!=i.mt||601!=i.exType||i.exType!=(this.preMsg||{}).exType){if(this.preMsg=i,i.notStore||!i.talkId||l.talkId&&1!=i.type&&10!=i.type&&7!=i.type||(l.talkId=i.talkId,!l.hasGetHistory&&l.companyOff),10==i.type)return i.notStore||(l.talkId=i.talkId,l.robotTalkId=i.talkId),void this.publish("_showCommonQue",i);if(a=i.content||i.c){var n=(a=this.handleMsgImg(a,i)).replace(/&nbsp;([^&\s])/g," $1");if(5==i.type||"s"==i.f)return i.staffId&&l.staffMap[i.staffId+""]&&(i=e.extend(i,l.staffMap[i.staffId+""])),void l._getMsg.call(this,i,0,n);if(l.showInfoTip({f:"sys",tip:a},"msg"+i.tm,void 0,void 0,i.talkId,i.tm,i.notEnd),!i.notStore){var s={mid:i.mid,tm:i.tm,f:"sys",mt:i.mt,m:0,c:a};if(s.talkId=i.talkId||l.talkId,l.pushHistory(s),s.c&&l.handleNewMsgMid(i.mid,s,!0,i),0===i.canTriggerWebTitleTip)return;i&&!l.isMobile&&view.setDocumentTitle&&view.setDocumentTitle("s")}}}}}),l.hasWaitingStatus=!1,this.subscribe("getPosMsg",function(t,i){l.companyOff=!1,e("#positionInfo").remove(),l.hasWaitingStatus||(l.paramChat.talkId=i.talkId,l.talkId=i.talkId,l.publish("__chatStatus","waiting"),e.store("ECHAT_"+l.companyId+"_"+window.chatVisitorId+"_chatStatus",1),l.hasWaitingStatus=!0,l.publish("setConfig",l.msg649),l.busyCanSend?(e(".menu-capture").removeClass("hide"),e(".menu-file").removeClass("hide")):(e(".menu-capture").addClass("hide"),e(".menu-file").addClass("hide"))),l.queueTxt=l.msg649.queueTxt||l.msg649.mobileQueueTxt||l.queueTxt,l.queueTxt&&l.showInfoTip({f:"sys",tip:l.queueTxt.replace("${waitcount}",i.position)},"positionInfo","warn",void 0,i.talkId,i.tm),l.publish("__chatQueue",i.position),l.initQcode(),l.postMessage({type:"getPosMsg",msg:i})}),this.subscribe("inviteSatisfy",function(){l.showSatisfy(2),l.publish("__newMsg",{f:"s",m:0,c:"[evaluate]:客服邀请您评价"})}),this.subscribe("staffInfo",function(t,i){l.staffName=l.stringEncode(i.staffNickName||lanRes.serviceStaff);var a=i.staffDetailInfo;a&&"string"==typeof a&&(a=JSON.parse(a)),a&&a.staffHead&&(l.needHttps&&(a.staffHead=a.staffHead.replace(/^http:/,l.needHttps)),l.paramChat.staffPhoto=a.staffHead),l.paramChat.staffPhone=a.staffPhone||"",l.paramChat.staffInfo=a.staffInfo||"",l.staffImg=a.staffHead||l.defaultStaffImg,view.initServiceInfo&&view.initServiceInfo(l,a);l.dataObject.staffInfos[l.staffId]={name:l.staffName,img:l.staffImg},l.saveHistoryStaffInfos(),e(".sa-avatar").html('<img src="'+view.chat.staffImg+'"/>'),a&&l.saveHistoryStaff(l.staffImg,l.staffName),view.startChatRefreshAD&&view.startChatRefreshAD(),view.showStaffInfo&&l.staffInfoEnable&&l.staffInfoEnable.staffInfoChattingEnable&&view.showStaffInfo(),i.staffDetailInfoMsgList&&l.handleStaffMap(i.staffDetailInfoMsgList,i.notStore),l.publish("showChatStaffInfo"),l.publish("__chatStaffInfo",{staffId:l.paramChat.staffId,staffNickName:l.paramChat.staffName||"",staffPhone:l.paramChat.staffPhone,staffHead:l.staffImg,staffInfo:a.staffInfo||"",recordId:(l.isInRobot?"5_":"1_")+l.talkId})}),l.staffInfoRefreshMap={innerAD:{notEnableParam:!1,params:"[]",element:"#inner_frame",hash:!0,srcUrl:void 0,attr:"src",url:""},innerImgUrl:{attr:"href"},rightAD:null,leftAD:null,innerURL:{},merchantLink:null,staffInfo:null,urlList:null},this.subscribe("__chatStatus",function(t,i){i.match(/^waiting|chatting|robot|leave/)&&function(t,i){function a(t){if(t.srcUrl){var i=l.getADURL(!t.notEnableParam,t.params,t.srcUrl,view.chat.paramChat,t.hash),a=i;e(t.element).each(function(n,s){"IFRAME"==s.tagName&&(a=view.chat.addEchatInnerFrameParam(i)),"src"==t.attr?s.src=a:"href"==t.attr?s.href=a:e(s).attr(t.attr,a)}),t.url=a}}var n,s;for(n in l.staffInfoRefreshMap)if(s=l.staffInfoRefreshMap[n])if(l.isArray(s))for(var o=0;o<s.length;o++)a(s[o]);else a(s);var r="media="+(view.windowType||"")+"&staffId="+(l.staffId||"")+"&staffName="+encodeURIComponent(l.staffName||"")+"&companyId="+(l.companyId||"")+"&talkId="+(l.talkId||"")+"&echatTag="+(l.paramChat.echatTag||l.queryParams.echattag||"")+"&visitorId="+(l.visitorId||"")+"&country="+encodeURIComponent(l.paramChat.country||"")+"&province="+encodeURIComponent(l.paramChat.province||"")+"&city="+encodeURIComponent(l.paramChat.city||"")+"&keyword="+encodeURIComponent(l.paramChat.keyword||"");l.echatSourceTag=encodeURIComponent(r)}()}),this.subscribe("updateStaffInfo",this.updateStaffInfo),this.subscribe("chatEnded",function(t,i){l.talkId&&l.dataObject.msgInfos.currentPrevTalkId&&(l.dataObject.msgInfos.currentPrevTalkId=(l.talkType||1)+"_"+l.talkId);var a,n=l.chatting,s=l.isInRobot,o="2"!=view.windowType&&l.queryParams.redirectUrl,r=1==i.changeRoute||1==i.closeTag;if(l.chatting=!1,l.isInRobot=0,l.hasGetHistory=!1,view.miniTempCloseWs=0,l.companyOff=void 0,l.staffImg=void 0,l.hasWaitingStatus=!1,l.endChatEvent(),l.publish("clearSendingMsg","endchat"),this.unSubscribe("_sendMsg"),view.toggleEnded&&view.toggleEnded("end"),s&&l.publish("endRobot"),l.talkId&&3!=l.talkType&&i&&i.tm&&l.updateHistoryComplete(l.talkType+"_"+l.talkId),e(".btn-qcode").addClass("hide"),e(".menu-capture").addClass("hide"),e(".menu-file").addClass("hide"),e("#robotToStaff").addClass("hide").hide(),l.hasEntryOrCode&&l.publish("entryCallback",{success:!0}),11!=i.type&&e(".btn-close").addClass("hide"),l.leaveAndClose&&("2"!=view.windowType&&l.queryParams.redirectUrl&&(location.href=l.queryParams.redirectUrl),e("#container").removeClass("hide"),e("#chat").removeClass("hide"),e("#footer").removeClass("hide"),e("html").removeClass("page-leave"),l.leaveAndClose=!1,l.entryLeaveContent=void 0,l.showInfoTip('<div class="btn-restart" id="restartChat">'+lanRes.toContinueChat+"</div>",void 0,void 0,void 0,i.talkId,i.tm)),"10009"!=i.mt||4!=i.type&&10!=i.type||(l.paramChat.visEvt=l.initVisEvt,delete l.queryParams.autoPop,delete l.queryParams.autoChat),1!=i.changeRoute&&this.publish("_hideCloseBtn",i),e.store("ECHAT_"+l.companyId+"_"+window.chatVisitorId+"_chatStatus",0),i.justConnect)!0===n&&l.talkId&&(l.lastTalkIdForTemp=l.talkId);else{l.lastTalkIdForTemp=void 0,i.content&&l.publish("getSysMsg",i),l.hasLeaveMsg||1==i.changeRoute||i.fromHistory&&(!i.fromHistory||!1!==i.isForward||"605"!=i.mt&&"10009"!=i.mt)||(e("#restartChat").parents("li").remove(),l.showInfoTip({f:"sys",tip:'<div class="btn-restart" id="restartChat">'+lanRes.toContinueChat+"</div>"},void 0,void 0,void 0,i.talkId,i.tm)),l.visitorClose=!i.fromHistory&&(1==i.closeReason||l.visitorClose&&"0"==i.closeReason),l.toggleEvaluateMenu(1);var d=!r&&!0===n&&l.showSatisfy(1);l.postMessage(3),r||i.fromHistory||d||1==l.toLeaveWord&&l.staffChatNeedConnect||o&&"2"!=view.windowType&&l.queryParams.redirectUrl||this.publish("_closeWin",i),i.talkId?l.talkId||(l.talkId=i.talkId):i.talkId=l.talkId,a=l.talkId,i.fromHistory&&!1!==i.isForward||("10009"!=i.mt||4!=i.type&&10!=i.type||(l.talkId="",e("#list_msg").show()),i.talkId&&l.handleSessionMsg(i),view.scrollToBottom()),l.talkId=a,i.fromHistory||11==i.type||(!view.SDK&&l.publish("__chatStatus","end-"+(i.closeReason||"0")+"-"+(d&&!s?"1":"0")),(l.staffChatNeedConnect||!view.SDK&&1==l.toLeaveWord||1==i.toChat)&&setTimeout(function(){l.publish("_triggerChat")},100))}}),this.subscribe("_closeWin",function(){if(!view.SDK&&l.visitorClose&&1!=l.toLeaveWord)if(l.leaveAndClose=!1,view.hasNative&&!view.SDK)l.publish("__visitorHide");else if(!(window.top==self&&window.EchatJsBridge||view.SDK))if(2==view.windowType)!(view.isMsgBoxChat&&view.hasNative)&&l.postMessage("hideMBmini");else if(1==view.windowType)try{window.opener=null,window.open("","_self").close(),window.close()}catch(e){try{window.close()}catch(e){}}}),this.subscribe("entryCallback",function(t,i){if(1==i.success){if(e("#entry").html("").hide(),e("#verify").hide(),e("#mask").hide(),e("body").removeClass("entry"),e("html").removeClass("entry2"),view.resetContainerBaseFoot&&view.resetContainerBaseFoot(),setTimeout(function(){view.scrollToBottom()},500),i.mid&&(delete l.queryParams.autoPop,delete l.queryParams.autoChat),l.hasEntryOrCode=!1,i.mt){l.no103=!1,l.publish("toRegisterChat");var a=l.entryParam;if(a){delete a.et,delete a.captcha;var n=e.store("ECHAT_"+l.companyId+"_ENTRY_HIS");n=n?JSON.parse(n):{},a=e.extend(n,a),e.store("ECHAT_"+l.companyId+"_ENTRY_HIS",JSON.stringify(a)),l.calcInnerADHeight&&l.calcInnerADHeight(),delete l.calcInnerADHeight}}}else l.publish("refreshVerify",{status:1})}),this.subscribe("receiveUnread",function(t,i){!view.SDKNative&&i.data.talkId&&(_$("list_msg").childNodes.length>1&&e("#list_msg").html(""),l.loadHistory("1_"+i.data.talkId)),l.talkId=i.data.talkId,l.unreadMsg?l.unreadMsg.push(i):l.unreadMsg=[i];var a,n,s,o,r=i.data.chatDetailList,d=r.length,c="",f="",u=0,m=i.data.staffDetailInfoList;if(m&&m.length&&(l.handleStaffMap(m,!1),o=l.staffMap[m[m.length-1].staffId]),d){s="downFile",l.isIOS&&(s="_blank");for(var h=0;h<d;h++)if(a=r[h],n="","686"!=r[h].mt)if("10001"!=r[h].mt){if("640"==r[h].mt||"675"==r[h].mt||"647"==r[h].mt)f=r[h].translation||r[h].content;else if("10011"==r[h].mt){if(2==r[h].visibility)continue;2!=r[h].mst&&(r[h].staffId=void 0,r[h].staffNickName=void 0),f='<div class="clearfix custom-event-li" id="msg'+i.tm+'">'+l.getVisEvtHtml(r[h])+"</div>"}else if("641"==r[h].mt)l.needHttps&&(l.qiniuDomain&&l.qiniuHttpsDomain&&(a.bigImg=a.bigImg.replace(l.qiniuDomain,l.qiniuHttpsDomain),a.smallImg=a.smallImg.replace(l.qiniuDomain,l.qiniuHttpsDomain)),a.bigImg=a.bigImg.replace(/^http:/,l.needHttps),a.smallImg=a.smallImg.replace(/^http:/,l.needHttps)),f=view.showMsgImg&&view.showMsgImg(a)||'<img attname="'+a.fileName+'" bigimg="'+(a.bigImg||a.sourceImg||"")+'" src="'+a.smallImg+'" class="msg-img"/>';else if("642"==r[h].mt)n="unread-file",l.needHttps&&(l.qiniuDomain&&l.qiniuHttpsDomain&&(a.fileUrl=a.fileUrl.replace(l.qiniuDomain,l.qiniuHttpsDomain)),a.fileUrl=a.fileUrl.replace(/^http:/,l.needHttps)),f='<div class="file-info"><div class="file-name">'+a.fileName+'</div><a class="file-size file-link" href="'+a.fileUrl+(!a.fileUrl||!a.fileUrl.match(/http[s]?:\/\/[^\/]*(qn|qiniu)[^\/]*\//i)&&a.fileUrl.match(/http[s]?:\/\/[^\/]*(oss)[^\/]*\//i)?"":(-1==a.fileUrl.indexOf("?")?"?":"&")+"attname="+a.fileName)+'" target="'+s+'"><span class="unread-size">'+(parseInt(a.fileSize/1024)+1)+'KB</span><span class="unread-download color0">'+lanRes.download+'</span></a></div><div class="file-icon">&nbsp;</div>';else if("10012"==r[h].mt);else if(680==r[h].mt){var p=r[h].pushUrlDetail.url,g="";if(view.chat.needHttps&&p.match(/^http:/i)&&(g=" push-blank"),view.pushURLParam){var v=p.split("#");p=v[0]+(-1==v[0].indexOf("?")?"?":"&")+view.pushURLParam+(v[1]?"#"+v[1]:"")}f='<a class="push-url clearfix'+g+'" target="info_frame3" href="'+p+'"><div class="push-icon echat bg1"></div><div class="push-content"><div class="push-name">'+l.stringEncode(r[h].pushUrlDetail.urlName)+' </div><div class="push-url-link">'+r[h].pushUrlDetail.url+"</div></div></a>"}u++,f=680==r[h].mt?f:l.filterEmailPhoneLink(f),(f=(l.filterEmo(f)||"").replace(/\n/g,"</br>"))&&(o&&a.staffId&&a.staffId!=o.staffId&&(a.staffId=o.staffId),a.staffId&&l.staffMap[a.staffId]?(a.staffImg=l.staffMap[a.staffId].staffImg||l.defaultStaffImg,a.staffName=l.staffMap[a.staffId].staffName||a.staffNickName,l.needHttps&&a.staffImg&&(a.staffImg=a.staffImg.replace(/^http:/,l.needHttps)),c+='<li class="clearfix list-unread-li '+n+'"><div class="avatar-icon fl staff-icons"><img class="avatar-icon-img" src="'+a.staffImg+'"></div><div class="fl unread-staff-name">'+(a.staffName||lanRes.serviceStaff)+'：</div><div class="fl unread-msg">'+f+"</div></li>"):c+='<li class="clearfix list-unread-li '+(n="list-unread-sys")+'"><div class="avatar-icon fl staff-icons"><img class="avatar-icon-img" src="'+l.defaultStaffImg+'"></div><div class="fl unread-staff-name">'+lanRes.serviceSys+'：</div><div class="fl unread-msg">'+f+"</div></li>")}else o=l.updateStaffInfo(void 0,{staffId:a.toStaffId||a.staffId,staffNickName:a.staffNickName||a.toStaffNickName,staffDetailInfo:a.staffDetailInfo||a.toStaffDetailInfo});else a.staffDetailInfoList&&l.handleStaffMap(a.staffDetailInfoList,!1),a.staffDetailInfo&&(o=l.updateStaffInfo(void 0,a));e("#list_unread").append(c),view.showUnread&&view.showUnread(u)}}),e("#unread_close").on("click",function(){view.removeUnreadMsg&&view.removeUnreadMsg()}),e("#leave_tip").on("click",function(){l.tipTimer&&clearTimeout(l.tipTimer),e(this).addClass("tiphide")}),this.changeDocTitle=function(){if("title"in t)return function(e){t.title=e};var e,i=_$s("title");return i&&i[0]?e=i[0]:(e=t.createElement("title"),_$s("head")[0].appendChild(e)),"textContent"in e?function(e){_$s("title")[0].textContent=e}:"innerText"in e?function(e){_$s("title")[0].innerText=e}:function(){}}()},configToolMenus:function(t){t||(t={});var i=4;"1"!=t.toolEmoji?(e(".menu-emo").addClass("hide-important"),i--):e(".menu-emo").removeClass("hide-important"),"1"!=t.toolFile?(e(".menu-file").addClass("hide-important"),i--):e(".menu-file").removeClass("hide-important"),"1"!=t.toolSatisfaction?(e(".menu-satisfy").addClass("hide-important"),i--):e(".menu-satisfy").removeClass("hide-important"),e(".menu-capture").length>0&&("1"!=t.toolScreenshot?(e(".menu-capture").addClass("hide-important"),i--):e(".menu-capture").removeClass("hide-important")),e(".menu-phone").length>0&&("1"!=t.toolTelephone?(e(".menu-phone").addClass("hide-important"),i--):e(".menu-phone").removeClass("hide-important")),0==i?(e("#menu-tools").addClass("hide-important"),e("#container").addClass("menu-no-tools")):(e("#menu-tools").removeClass("hide-important"),e("#container").removeClass("menu-no-tools"))},plainTextToSendMsg:function(e){var t=this;return charMap={"<":"&lt;",">":"&gt;",'"':"&quot;"},e=e.replace(/\[#([^#]+)#\]/g,function(e,i){return"[#"+(t.lanEmo[i]||i)+"#]"}).replace(/[<">]/g,function(e){return charMap[e]})},processMsg:{processNum:0,sendMsgMap:{},receiveMsgMap:{}},openVisitorSend:function(){var t=this;this.unSubscribe("_sendMsg"),this.unSubscribe("_sendVisEvt"),this.subscribe("_sendMsg",function(i,a){if(!view.handleNetwok||!view.handleNetwok())if(t.isInRobot||!0===t.companyOff||t.busyCanSend||"0"==t.queryParams.autoChat||!0===t.chatting){var n=a||t.getInput(!0);if(n.trim())if(n.match(/^\[#echat::lihong#\]$/))t.loadConsole(7304);else{t.plainText&&(n=t.plainTextToSendMsg(n));var s=(new Date).getTime(),o="msg"+s,r=t.checkHistoryTime(s),l={filterMsg:1==t.filterMsg||3==t.filterMsg,t:r?(new Date).format("hh:mm"):void 0,tm:s,mt:864,f:"c",m:0,c:n,id:o};t.sendToServer(l),a||(t.lastText=null,view.afterSend()),t.publish("_firstSendMsg",{c:n}),t.publish("_addSendMsgNum",l)}}else e("#busyTipLine").removeClass("hide").show()}),this.subscribe("_sendVisEvt",function(i,a){if(!view.handleNetwok||!view.handleNetwok())if(t.isInRobot||!0===t.companyOff||t.busyCanSend||"0"==t.queryParams.autoChat||!0===t.chatting){var n;if("object"==typeof a){if(n={et:126,dedup:0,customizeMsgType:a.customizeMsgType||1,eventId:a.eventId,title:t.replaceHtml(a.title),content:a.content,imageUrl:a.imageUrl,url:a.url,urlForVisitor:a.urlForVisitor,urlForStaff:a.urlForStaff,memo:t.replaceHtml(a.memo),visibility:a.visibility,urlEnableForVisitor:a.urlEnableForVisitor,closeURLPage:a.closeURLPage,question:t.replaceHtml(a.question),visEvt:"object"==typeof a.visEvt?JSON.stringify(a.visEvt):a.visEvt},!a.question&&this.isInRobot&&1==a.customizeMsgType)return}else n={et:126,dedup:0,visEvt:a};var s=(new Date).getTime(),o="msg"+s,r=1==n.customizeMsgType?"c":"x",l="c"===r?t.getVisEvtHtml(n):"",d={t:t.checkHistoryTime(s)?(new Date).format("hh:mm"):void 0,tm:s,mt:10011,et:126,data:n,talkId:t.talkId,talkType:t.talkType,m:5,hide:"c"!==r,f:r,c:l,id:o};t.sendToServer(d,void 0,function(t){e("#"+o).remove()}),"c"==r&&(t.publish("_firstSendMsg",{c:l}),t.publish("_addSendMsgNum",d))}else e("#busyTipLine").removeClass("hide").show()})},postMessage:function(e){if(!this.doNotHasPostMessage&&2==view.windowType&&window.top!=self)try{return window.parent.postMessage(e,this.queryParams.fromhost||"*"),!0}catch(e){this.doNotHasPostMessage=!0,console.log(e)}return!1},getVisitorMessage:function(){},initDialog:function(){var t=this;t.hasInitDialog||(t.hasInitDialog=!0,e("body").on("click",".dialog-close",function(){e(".dialog").remove(),t.publish("_dialogCanel")}).on("click",".img-close",function(){e(".dialog").remove(),t.publish("_dialogCanel")}).on("click",".dialog-cancel",function(){e(".dialog").remove(),t.publish("_dialogCanel")}).on("click",".dialog-ok",function(){e(".dialog").remove(),t.publish("_dialogOk")}))},showDialog:function(t){function i(t){var s=e(".dialog").results,o=e(".dialog-ok").results[0],r=e(".dialog-cancel").results[0],l=e(".dialog-close").results[0];if(0==s.length)e("body").off(n,i);else{var d=t.srcElement||t.target;setTimeout(function(){o==d||e.fn.contains(o,d)?(a.publish("_dialogOk"),e(".dialog").remove()):(r==d||e.fn.contains(r,d)||l==d||e.fn.contains(l,d))&&(a.publish("_dialogCanel"),e(".dialog").remove())},50)}}var a=this,n=a.isMobile&&!a.isPcXcx?"tap":"click";e(".dialog").remove(),this.publish("_dialogCanel"),a.initDialog();var s=t.tip,o='<div class="dialog dialog-hide"><div class="dialog-close"><i class="img-close"></i></div><div class="dialog-title">'+lanRes.tip+'</div><div style="'+t.contentStyle+'" class="dialog-content">'+s+'</div><div class="dialog-btns"><a class="dialog-btn dialog-ok bg0"><div class="bg0 fade-div"></div><span>'+(t.okTip||lanRes.okay)+"</span></a>"+(!1!==t.cancel?'<a class="dialog-btn dialog-cancel bg0 has-fade"><div class="bg0 fade-div"></div><span>'+lanRes.cancel+"</span></a>":"")+"</div></div>";e(_$("index")||"body").append(o),t.callback&&t.callback(),a.unSubscribe(["_dialogOk","_dialogCanel"]),a.subscribe("_dialogOk",function(){e("body").off(n,i),t.ok&&t.ok(),a.unSubscribe(["_dialogOk","_dialogCanel"])}),a.subscribe("_dialogCanel",function(){e("body").off(n,i),t.cancel&&t.cancel(),a.unSubscribe(["_dialogOk","_dialogCanel"])}),setTimeout(function(){e("body").on(n,i),e(".dialog").removeClass("dialog-hide")},10),view.inputBlur&&view.inputBlur(void 0,1)},showAlertDialog:function(t){function i(t){var n=e(".dialog").results,s=e(".dialog-ok").results[0];0==n.length?e("body").off(a.isMobile&&!a.isPcXcx?"tap":"click",i):setTimeout(function(){(s==t.target||e.fn.contains(s,t.target))&&(a.publish("_dialogOk"),e(".dialog").remove())},50)}e(".dialog").remove();var a=this;a.initDialog();var n=t.tip,s='<div class="dialog dialog-hide"><div class="dialog-title">'+lanRes.tip+'</div><div class="dialog-content">'+n+'</div><div class="dialog-btns"><a class="dialog-btn dialog-ok bg0"><div class="bg0 fade-div"></div><span>'+(t.okTip||lanRes.okay)+"</span></a></div></div>";e("body").append(s),e("#mask").show(),setTimeout(function(){e("#mask").show()},100),a.unSubscribe(["_dialogOk"]),a.subscribe("_dialogOk",function(){e("body").off(a.isMobile&&!a.isPcXcx?"tap":"click",i),t.ok&&t.ok(),a.unSubscribe(["_dialogOk"]),e("#mask").hide()}),setTimeout(function(){e("body").on(a.isMobile&&!a.isPcXcx?"tap":"click",i),e(".dialog").removeClass("dialog-hide")},10)},getOrderSettingsByFields:function(e,t,i,a){for(var n,s,o,r={},i=i||"default",l=0;l<t.length;l++){if(n=r[t[l].field]=t[l],s=null,n.settings&&n.settings.length>0)if(1==n.settings.length)n.configs=n.settings[0].configs;else{for(var d=0;d<n.settings.length;d++){if(n.settings[d].lan==i){n.configs=n.settings[d].configs;break}"default"==n.settings[d].lan&&(s=n.settings[d].configs)}!n.configs&&(n.configs=s||n.settings[0].configs)}t[l].field===e&&(o=t[l])}a&&a(r,o,s)},toShowOrderSubmit:function(i){e(window).on("resize",function(){var e=t.activeElement;"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||setTimeout(function(){e.scrollIntoViewIfNeeded()},100)});var a=this,n="",s="",o=[],r=i.jobWindowInfo,l=r.configuration,d=r.fieldSettings;o.push(1!=view.windowType||view.dji?"entry2-mb":"entry2-pc"),!a.isMobile&&a.mini&&o.push("entry2-pc-mini"),o.push("entry2-form"),e("#orderSubmit")&&e("#orderSubmit").remove(),!view.SDKNative&&a.addCSS(a.isMobile&&!view.dji?__uri("/visitor/common/css/entry2.css"):__uri("/visitor/common/css/entry2pc.css"));for(var c='<div id="orderSubmit" class="{{entryClass}} order-form"><header class="ordertitle"><div class="margin-b5" style="font-size: 14px;">{{title}}</div><div class="order-tip">{{description}}</div></header><div class="entry2-wrap entry2-items order-content"><form id="orderForm">{{element}}</form><span class="order-button magr0 bg-c order-upload-button"><form class="order-upload" name="orderUploadForm" id="orderUploadForm" enctype="multipart/form-data" method="post"><input type="file" title="'+lanRes.visitor189+'" name="file" id="orderUpload">'+lanRes.visitor189+'</form></span><div id="orderFileslist" class="order-fileslist"></div><div class="order-tip">'+lanRes.visitor178+'</div></div><footer class="order-footer"><span class="order-submit order-button bg0">{{submit}}</span></footer></div>',f='<div class="entry2-item"><div class="entry2-label {{req}}"><span class="req-span">*</span><span class="entry2-name">{{configDesc}}:</span></div><div class="entry2-typeline {{req}}" lb="{{configDesc}}">{{typeline}}</div></div>',u=0;u<l.length;u++)var m=l[u],h=a.getOrderSettingsByFields(m.configName,r.fieldSettings,m.lan,function(e,t,i){var o=(h=t).type;n=a.getElementByFieldType(e,o,m,""),s+=f.replace("{{typeline}}",n).replace(/\{\{configName\}\}/g,m.configName).replace(/\{\{configDesc\}\}/g,m.configDesc).replace(/\{\{wordDesc\}\}/g,m.wordDesc).replace(/\{\{value\}\}/g,"").replace(/\{\{req\}\}/g,1==m.configRequired?"req":"")});var p=view.SDKNative?"jpg，png，gif，bmp，avi，mov，rmvb，rm，flv，mp4，3gp":"jpg，png，gif，txt，rar，zip，doc，docx，xls，xlsx，bmp，avi，mov，rmvb，rm，flv，mp4，3gp";if(s=c.replace("{{entryClass}}",o.join(" ")).replace("{{element}}",s).replace(/\{\{title\}\}/g,r.title).replace(/\{\{description\}\}/g,r.description).replace(/\{\{cancel\}\}/g,lanRes.cancel).replace(/\$\{uploadFileSize\}/g,a.uploadFileSize/1024/1024).replace(/\$\{filesTip\}/g,p).replace(/\{\{submit\}\}/g,lanRes.submit),1!=view.windowType||view.dji?e("body").append(s):e("#leave").html(s).removeClass("hide"),a.resetOptionField(l,d,"workorder"),a.publish("removeLoading"),this.isMobile&&e("#orderSubmit").off("click").bind("click","img",function(e){setTimeout(function(){view.showImg.call(this,"orderFileslist",e)},500)}),a.isMobile||1!=view.windowType||view.dji)self===window.top&&(e(".btn-close").addClass("hide"),setTimeout(function(){e(".btn-close").addClass("hide")},100)),e("#container").addClass("hide");else{e("#chat").addClass("hide"),e("#orderSubmit footer").remove(),window.opener||(e(".btn-close").addClass("hide"),setTimeout(function(){e(".btn-close").addClass("hide")},100));var g='<div class="order-submit order-button bg0">'+lanRes.submit+"</div>";e(".leave-entry-foot").html(g)}e("html").addClass("page-leave entry2"),e("#footer").addClass("hide"),setTimeout(function(){e("#mask").hide()},100),e("#orderUpload").off("click").bind("click",function(e){e.stopPropagation()}),view.SDKNative?view.bindOrderUpload(".order-upload-button","#orderUpload"):a.orderUploadFile(),a.addOrderSubmitEvent(l,".order-submit")},resetOptionField:function(t,i,a){var n=this.msg649,s=n.entranceInfo||n.smallEntranceInfo||n.mobileEntranceInfo||n.sdkEntranceInfo;orderConfigObj=n&&(this.msg649.jobWindowInfo||s)||{},lanByField={},fieldByKey={},settings=[],configs=[],fieldOverLenArr=[],url="workorder"===a?"/chatapi/jobh/dfd":"/chatapi/bfc/df",sendParams={companyId:this.companyId,requesterVisitorId:this.visitorId,token:orderConfigObj.token,nonce:orderConfigObj.nonce};for(var o=0;o<t.length;o++)lanByField[t[o].configName]=t[o].lan||"default";for(var r=0;r<i.length;r++)i[r].valueOverlength&&(fieldByKey[i[r].field]=i[r],fieldOverLenArr.push(i[r].fieldId));fieldOverLenArr.length>0&&(sendParams.fieldIds=fieldOverLenArr.join(","),e._ajax({url:this.apiServerDomain+url+"?"+this.addMapParams(sendParams),type:"jsonp",jsonpCB:"jsonpCallback",success:function(t){for(var i=0;i<t.length;i++){settings=t[i].settings,e("input[name="+t[i].field+"]").html("<option>请选择</option>");for(var a=0;a<settings.length;a++)if(lanByField[t[i].field]===settings[a].lan){configs=settings[a].configs;for(var n in configs){var s="<option value='{{value}}' inputvalue='{{inputvalue}}'>{{inputvalue}}</option>";s=s.replace(/\{\{value\}\}/g,configs[n].value).replace(/\{\{inputvalue\}\}/g,configs[n].item),e("select[name="+t[i].field+"]").append(s)}}}},error:function(){}}))},orderUploadFile:function(){var i=this,a=t.getElementById("orderUpload"),n=["jpg","png","gif","bmp"],o=["txt","rar","zip","doc","docx","xls","xlsx"],r=["avi","mov","rmvb","rm","flv","mp4","3gp"],l=0;a.onchange=function(){function t(t,a,n){var s,o={smallImg:t||"",bigImg:t||"",sourceImg:t||"",fileName:lanRes.visitor175},r=0;switch(b){case"0":r="orderfile-icon",s='<a class="order-img" target="_blank"></a>';break;case"2":r="ordervideo-icon",s=i.isMobile?'<div class="order-img">':'<a class="order-img" target="_blank"></a>';break;case"4":r="orderimg-icon",s=view.showMsgImg&&view.showMsgImg(o)||'<img id="img'+(new Date).getTime()+'" src="'+o.smallImg+'" class="msg-img"/>'}var c=('<div dataindex="{{dataindex}}" class="{{classType}} load">{{fimg}}'+(2==b?"<i class='ordervideo-text'>VIDEO</i>":"")+'<span class="orderfile-name" title="{{fname}}">{{fname}}</span><i class="orderfile-del"></i><i class="orderfile-progress-num"></i><i class="orderfile-progress"></i></div>').replace(/\{\{classType\}\}/g,r).replace(/\{\{dataindex\}\}/g,n).replace(/\{\{fname\}\}/g,a).replace(/\{\{fimg\}\}/g,s);e(".order-fileslist").append(c),function(e){lastUploadFile=h;var t=i.msg649&&i.msg649.jobWindowInfo||{},a={token:t.token||"",nonce:t.nonce||"",fileType:b,tokenNum:1,companyId:i.companyId,requesterVisitorId:i.visitorId};y=a,d(w[l],e,e)}(n)}function d(t,a,n){var s;switch(t){case 1:s="/chatapi/jobh/gqt";break;case 2:s="/chatapi/jobh/gat";break;default:return y.uploadUrl=i.apiServerDomain+"/chatapi/jobh/fup",y.tm=(new Date).getTime(),e(".order-fileslist > div[dataindex='"+a+"']").attr("dataindex",y.tm),i.orderFileIndexObj[y.tm]=n,void c(y,t)}e._ajax({url:i.apiServerDomain+s+"?"+i.addMapParams(y),type:"jsonp",jsonpCB:"jsonpCallback",success:function(s){if(s.successful){var o=s.result.data[0],r=o.token||o.signature;e(".order-fileslist > div[dataindex='"+a+"']").attr("dataindex",r),i.orderFileIndexObj[r]=n,c(o,t)}else f(a)},error:function(){f(a)}})}function c(t,n){var o=new FormData;1==n?(o.append("key",t.qiniuKey),o.append("token",t.token)):2==n?(o.append("key",t.aliyunKey),o.append("policy",t.policy),o.append("callback",t.callback),o.append("success_action_status",200),o.append("signature",t.signature),o.append("OSSAccessKeyId",t.ossAccessKeyId),o.append("x:filename",h.name),o.append("x:companyid",i.companyId),o.append("x:visitorId",i.visitorId),o.append("x:filetype",b)):(o.append("companyId",t.companyId),o.append("requesterVisitorId",t.requesterVisitorId),o.append("fileType",t.fileType),o.append("tokenNum",t.tokenNum),o.append("nonce",t.nonce),o.append("token",t.token)),o.append("file",a.files[0]);var r=new XMLHttpRequest;r.open("POST",t.uploadUrl,!0),r.onerror=r.ontimeout=function(){f(t.tm||t.token||t.signature)},r.upload.onprogress=function(i){if(i.lengthComputable){var a=parseInt(i.loaded/i.total*100)+"%",n=t.tm||t.token||t.signature;e(".order-fileslist > div[dataindex='"+n+"'] .orderfile-progress-num").html(a),e(".order-fileslist > div[dataindex='"+n+"'] .orderfile-progress").css("width",a)}};var l=i.orderFileIndexObj[t.tm||t.token||t.signature];i.orderSubAttachments[l].xhr=r,r.addEventListener("load",function(n){var o=t.tm||t.token||t.signature,l=i.orderFileIndexObj[o];if(200==r.status&&r.responseText){var d=JSON.parse(r.responseText);d.successful||d.fname?(d=d.successful?d.result.data:d,i.orderSubAttachments[l].type=1,i.orderSubAttachments[l].fileValue={name:d.fname,url:d.sourceUrl,fileType:d.fileType,key:d.key,bucket:d.bucket},delete i.orderSubAttachments[l].xhr,function(t,a){var n=a.sourceUrl&&a.sourceUrl.indexOf("?")>0?"&":"?";downloadUrl=a.sourceUrl+n+"attname="+encodeURIComponent(a.fname),e(".order-fileslist > div[dataindex='"+t+"']").removeClass("load"),e(".order-fileslist > div[dataindex='"+t+"'] .orderfile-progress-num").html(""),0==a.fileType?e(".order-fileslist > div[dataindex='"+t+"'] .order-img").attr("href",a.sourceUrl):2==a.fileType?i.isMobile?e(".order-fileslist > div[dataindex='"+t+"'] .order-img").attr("onclick","view.__playVideo('"+a.sourceUrl+"','','"+downloadUrl+"','"+(a.fname||"")+"','"+(a.key||"")+"')"):e(".order-fileslist > div[dataindex='"+t+"'] .order-img").attr("href","/visitor/pc/video.html?videoUrl="+encodeURIComponent(a.sourceUrl)):4==a.fileType&&(e(".order-fileslist > div[dataindex='"+t+"'] img").attr("attname",a.fname).attr("src",a.sourceUrl).attr("source",a.sourceUrl),view.handleMessage&&e(".order-fileslist > div[dataindex='"+t+"'] img").attr("onclick","javascript:view.handleMessage('"+a.sourceUrl+'\',"orderFileslist")'))}(o,d),a.value=null,e(".order-fileslist > div .orderfile-del").off("click").bind("click",function(t){var a=this,n=e(this).context.parentElement.getAttribute("dataindex"),o=i.orderFileIndexObj[n],r=i.msg649&&i.msg649.jobWindowInfo||{},l={token:r.token||"",nonce:r.nonce||"",key:d.key,bucket:d.bucket,companyId:i.companyId,requesterVisitorId:i.visitorId};i.showDialog({tip:lanRes.visitor191,ok:function(){e._ajax({url:i.apiServerDomain+"/chatapi/jobh/df?"+i.addMapParams(l),type:"jsonp",jsonpCB:"jsonpCallback",success:function(t){e(a).context.parentElement.remove(),s(lanRes.visitor182,"ok"),e(".order-upload-button").css("display","inline-block"),i.orderSubAttachments.splice(o,1),function(){i.orderFileIndexObj={};for(var t=e(".order-fileslist > div").results||[],a=0;a<t.length;a++)t[a].getAttribute("dataindex").length>1&&(i.orderFileIndexObj[t[a].getAttribute("dataindex")]=a)}()}})},cancel:function(){}})})):f(o)}}),r.send(o)}function f(t){w[l+1]?d(w[l+=1],t,i.orderFileIndexObj[t]):(_$("leave_tip_con").innerHTML=lanRes.visitor181,e(".order-fileslist > div[dataindex='"+t+"']").remove(),s())}var u=a.value||a.getAttribute("value");if(i.orderSubAttachments.length>=20)return i.isMobile?s(lanRes.visitor179):i.showDialog({tip:lanRes.visitor180,cancel:!1}),a.value=null,!1;if(!u)return console.log("no file to send",u),!1;for(var m,h=u,p=(a.files||[{}]).length,g=0;g<p;g++){if(function(e){for(var t=!1,a=0;a<i.orderSubAttachments.length;a++){var n=i.orderSubAttachments[a];e.size==n.fileInfo.size&&e.name==n.fileInfo.name&&e.type==n.fileInfo.type&&(s(lanRes.visitor185),t=!0)}return t}(a.files[g]))return p-1===g&&(a.value=null),!1;if(a.files){if(!a.files[g]||!a.files[g].size){console.log("no file to send",u);continue}(a.files[g]||a.files[g].name)&&(u=a.files[g].name)}m=-1!=u.indexOf(".")?u.replace(/.*\./,""):"";var v=u.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1");if(i.sendingTitle=v+"."+m+lanRes.fileSendWait,m&&-1===n.indexOf(m)&&-1===o.indexOf(m)&&-1===r.indexOf(m))i.showDialog({tip:"ERROR: "+lanRes.unsupportFileType+"。</br>"+lanRes.supportFileType+": jpg、png、gif、bmp、txt、rar、zip、doc、docx、xls、xlsx、avi、mov、rmvb、rm、flv、mp4、3gp",cancel:!1});else{if(i.getFileSize(a,g)>i.uploadFileSize)i.showDialog({tip:lanRes.fileSizeOut.replace("${maxSize}",i.uploadFileSize/1024/1024+"M"),cancel:!1}),i.handleFileSelect.error();else{a.files&&(h=a.files[g]);var b=-1!==n.indexOf(m)?"4":-1!==r.indexOf(m)?"2":"0",y={},w=i.fileUploadInfos.array;!function(a){i.orderSubAttachments.push({fileInfo:h}),4==b?function(e,t){if(t&&e&&e.type.indexOf("image/")>-1){var i=new FileReader;i.onload=function(i){t({file:e,base64:i.target.result})},i.readAsDataURL(e)}else t&&t(null)}(h,function(e){e&&t(e.base64,e.file.name,a)}):t("",h.name,a),20===i.orderSubAttachments.length&&e(".order-upload-button").hide()}(i.orderSubAttachments.length),view.hideMenus&&view.hideMenus(0,!1)}}}},a.onclick=function(){view.hideMenus(),i.sendingFileToken}},getElementByFieldType:function(e,t,i,a){function n(e,t){for(var i=0;i<e.length;i++)if(e[i]==t)return!0;return!1}var s="",o={type1:'<input type="text" class="entry2-input {{req}}" maxlength="{{length}}" placeholder="{{wordDesc}}" lb="{{configDesc}}" name="{{configName}}" value="{{value}}"/>',type6b:'<input type="date" class="entry2-input {{req}}" placeholder="{{wordDesc}}" lb="{{configDesc}}" name="{{configName}}" value="{{value}}"/>',type6:'<div class="date-input-box"><input type="text" lb="{{configDesc}}" placeholder="{{wordDesc}}" value="{{value}}" class="entry2-input date-show"/><input type="date" lb="{{configDesc}}" placeholder="{{wordDesc}}" name="{{configName}}" value="{{value}}" class="entry2-input date-input"/><span class="date-select-icon echat-vs color0">&#xe638;</span></div>',type2:'<textarea class="entry2-textarea {{req}}" maxlength="{{length}}" rows="4" placeholder="{{wordDesc}}" lb="{{configDesc}}" name="{{configName}}" autoHeight="true">{{value}}</textarea>',type4:'<div class="entry2-checkbox"><label><input name="{{configName}}" value="{{configs.value}}" inputvalue="{{configs.item}}" lb="{{configDesc}}" type="radio" {{check}} /><span class="entry2-checkicon color0"></span><span>{{configs.item}}</span></label></div>',type5:'<div class="entry2-checkbox"><label><input name="{{configName}}" value="{{configs.value}}" inputvalue="{{configs.item}}" lb="{{configDesc}}" type="checkbox" {{check}} /><span class="entry2-checkicon color0"></span><span>{{configs.item}}</span></label></div>',type3:'<option value="{{configs.value}}" inputvalue="{{configs.item}}" {{check}} >{{configs.item}}</option>',type7:'<option value="{{configs.value}}" inputvalue="{{configs.item}}" {{check}} >{{configs.item}}</option>'};if(s=o["type"+t],6==t&&(window.ltIE10||this.isMobile))s=o.type6b;else if(4==t||5==t||3==t||7==t){if(configs=e[i.configName].configs||[],s=[],a=a?a.split(","):a,3==t||7==t){if(7==t){for(var r=[],l=configs.start;l<=configs.end&&(r.push({item:l,value:l}),150!=r.length);l+=configs.stepSize);configs=r||[]}s.push('<select class="entry2-select {{req}}" name="{{configName}}" lb="{{configDesc}}"><option value="">{{wordDesc}}</option>')}for(var c=0;c<configs.length;c++)s.push(o["type"+t].replace(/\{\{configs.item\}\}/g,configs[c].item).replace("{{configs.value}}",configs[c].value).replace("{{check}}",a&&n(a,configs[c].value)?3==t||7==t?"selected":"checked":""));3!=t&&7!=t||s.push("</select>"),s=s.join("")}else 1!=t&&2!=t||(s=s.replace("{{length}}",(d[i.configName]||d[1==t?"text":"textarea"]).length));return s},toShowEntry:function(i,a){e(window).on("resize",function(){var e=t.activeElement;"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||setTimeout(function(){e.scrollIntoViewIfNeeded()},100)});var n,s,o,l,d,c=this,f="",u="",m=[],h={},p=!1,g=i.fieldSettings||[],v=i.buzFieldSettings||[],b=c.msg600.lan||i.lan||"default",y=decodeURIComponent(e.store("ECHAT_"+c.companyId+"_ENTRY_HIS")||"{}");if(!view.SDKNative&&c.addCSS(c.isMobile&&!view.dji?__uri("/visitor/common/css/entry2.css"):__uri("/visitor/common/css/entry2pc.css")),e("#entry").remove(),view.dji&&1==i.entranceLevel)return!1;if(y=JSON.parse(y),1!=i.entranceLevel&&!0===c.companyOff&&0==i.offlineStartType&&(i.entranceLevel=1,p=!0,g=[{enable:1,field:"gender",fieldId:7106,isSystem:1,label:"性别",lan:"default",settings:[{configs:[{item:lanRes.male,sort:1,value:"1"},{item:lanRes.female,sort:2,value:"2"}],lan:"default"}],type:4,configs:[{item:lanRes.male,sort:1,value:"1"},{item:lanRes.female,sort:2,value:"2"}]},{enable:1,field:"maritalStatus",fieldId:7107,isSystem:1,label:"婚否",lan:"default",settings:[{configs:[{item:lanRes.married,sort:1,value:"2"},{item:lanRes.unmarried,sort:2,value:"1"}],lan:"default"}],type:4,configs:[{item:lanRes.married,sort:1,value:"2"},{item:lanRes.unmarried,sort:2,value:"1"}]},{enable:1,field:"age",fieldId:7109,isSystem:1,label:"年龄",lan:"default",settings:[{configs:{end:127,start:1,stepSize:1},lan:"default"}],type:7,configs:{end:127,start:1,stepSize:1}},{enable:1,field:"birthday",fieldId:7108,isSystem:1,label:"生日",settings:[],type:6}],i.upgradeOfflineVisitorInfoConfiguration=i.offlineVisitorInfoConfiguration,i.upgradeOfflineWelcomeWord=i.offlineWelcomeWord),1==i.entranceLevel){var w='<div class="entry2-item"><div class="entry2-label {{req}}"><span class="req-span">*</span><span class="entry2-name">{{configDesc}}:</span></div><div class="entry2-typeline {{req}}" lb="{{configDesc}}">{{typeline}}</div></div>';l=(o=!0===c.companyOff?i.upgradeOfflineVisitorInfoConfiguration:i.upgradeVisitorInfoConfiguration)&&o.length||0,!0===c.companyOff&&(i.upgradeVisitorInfoSubmitTxt=i.upgradeOfflineVisitorInfoSubmitTxt,i.upgradeWelcomeWord=i.upgradeOfflineWelcomeWord),m.push(1!=view.windowType||view.dji?"entry2-mb":"entry2-pc"),!c.isMobile&&c.mini&&m.push("entry2-pc-mini"),m.push(!0===c.companyOff&&0==i.offlineStartType?"entry2-form":"entry2-half");for(var I=h,T=g.concat(v),k=0;k<T.length;k++)if(R=I[T[k].field]=T[k],R=T[k],s=null,R.settings&&R.settings.length>0)if(1==R.settings.length)R.configs=R.settings[0].configs;else{for(var S=0;S<R.settings.length;S++){if(R.settings[S].lan==b){R.configs=R.settings[S].configs;break}"default"==R.settings[S].lan&&(s=R.settings[S].configs)}!R.configs&&(R.configs=s||R.settings[0].configs)}for(var C=0;C<l;C++)if(0==(n=o[C]).configWebVipVisitor&&c.isVip||0==n.configWebVisitor&&!c.isVip)n.disabled=!0;else{if(!h[n.configName]){if(!p){n.disabled=!0;continue}h[n.configName]={type:1}}var x=h[n.configName].type,_=y[n.configName];f=c.getElementByFieldType(h,x,n,_),u+=w.replace("{{typeline}}",f).replace(/\{\{configName\}\}/g,n.configName).replace(/\{\{configDesc\}\}/g,n.configDesc).replace(/\{\{wordDesc\}\}/g,"").replace(/\{\{value\}\}/g,_||"").replace(/\{\{req\}\}/g,1==n.configRequired?"req":"")}return!0===c.companyOff&&0==i.offlineStartType&&(u+=w.replace(/\{\{req\}\}/g,"req").replace(/\{\{configDesc\}\}/g,lanRes.leaveWordContent).replace("{{typeline}}",'<textarea rows="4" lb="'+lanRes.leaveWordContent+'" autoHeight="true"  class="entry2-textarea leave-entry-text req"></textarea>')),1==i.captChaEnable&&(u+=w.replace(/\{\{req\}\}/g,"req").replace(/\{\{configDesc\}\}/g,lanRes.validateCode).replace("{{typeline}}",'<input type="text" id="verify_input" lb="'+lanRes.validateCode+'" class="entry2-input entry2-input-code req" /><img alt="'+lanRes.validateCode+'" id="verify_img" src="'+c.dataHost+"/chatCaptCha.jpg?captChatToken="+a.captChaToken+'"/><span class="color0 cursor-p" id="verify_change">'+lanRes.nextPic+"</span>"),e(".verify-change").attr("id",""),e(".verify-img").attr("id",""),e(".verify-ok").attr("id",""),e(".verify-input").attr("id","")),u='<div id="entry" class="{{entryClass}}"><form id="entryForm" class="entry2-wrap"><div class="entry2-title bg0">{{upgradeWelcomeWord}}</div><div class="entry2-content"><div class="entry2-items">{{list}}</div>{{btns}}</form></div>'.replace("{{entryClass}}",m.join(" ")).replace("{{list}}",u).replace("{{upgradeWelcomeWord}}",i.upgradeWelcomeWord).replace("{{btns}}",1!=view.windowType||view.dji||!0!==c.companyOff||0!=i.offlineStartType?'<div class="entry2-submit"><div class="entry2-btn-submit bg0">{{upgradeVisitorInfoSubmitTxt}}</div></div></div>':"").replace("{{upgradeVisitorInfoSubmitTxt}}",!0===c.companyOff&&0==i.offlineStartType?lanRes.submit:i.upgradeVisitorInfoSubmitTxt).replace("{{close}}",lanRes.close).replace("{{submit}}",lanRes.submit),!0===c.companyOff&&0==i.offlineStartType?(c.leaveAndClose=!0,view.showLeavePage?view.showLeavePage(i):function(t,a){e(".verify-change").attr("id",""),e(".verify-img").attr("id",""),e(".verify-ok").attr("id",""),e(".verify-input").attr("id",""),1!=view.windowType||view.dji?e("body").append(t):e("#leave").html(t).removeClass("hide"),c.publish("removeLoading"),c.isMobile||1!=view.windowType||view.dji?e("#container").addClass("hide"):(e("#chat").addClass("hide"),e(".btn-close").addClass("hide"),setTimeout(function(){e(".btn-close").addClass("hide")},100)),e("html").addClass("page-leave entry2"),e("#footer").addClass("hide"),setTimeout(function(){e("#mask").hide()},100),view.toLeaveMessage&&view.toLeaveMessage(),c.addEntryEvent({list:o,configData:i,submitSelector:a,crm20:h}),c.resetOptionField(o,v,"entrance")}(u,1!=view.windowType||view.dji||!0!==c.companyOff||0!=i.offlineStartType?".entry2-btn-submit":".leave-enter-btn"),e("textarea[autoHeight]").autoHeight(),!0):(e("body").append(u),e("html").addClass("entry2"),c.resetOptionField(o,v,"entrance"),c.addEntryEvent({list:o,configData:i,submitSelector:".entry2-btn-submit",crm20:h}),e(".entry2-btn-close").on("click",function(e){c.visitorClose=!1,c.publish("_endChat"),c.publish("chatEnded",{}),(c.hasEntryOrCode||"0"==c.queryParams.autoChat)&&(c.publish("entryCallback",{success:!0}),c.publish("_endConnect")),delete c.queryParams.autoPop,delete c.queryParams.autoChat}),c.publish("removeLoading"),e("#mask").show(),e("textarea[autoHeight]").autoHeight(),!0)}l=(o=(!0===c.companyOff?i.offlineVisitorInfoConfiguration:i.visitorInfoConfiguration)||[])&&o.length||0,d=1!=i.captChaEnable&&r(o),c.needHttps&&i.visitorInfoBackImg&&(i.visitorInfoBackImg=i.visitorInfoBackImg.replace(/^http:/,c.needHttps)),i=e.extend({},i),!0===c.companyOff&&(i.welcomeWord=i.offlineWelcomeWord,i.welcomeWordPos=i.offlineWelcomeWordPos,i.entryCanClose=i.offlineEntryCanClose,i.visitorInfoCloseImg=i.offlineVisitorInfoCloseImg,i.visitorInfoClosePos=i.offlineVisitorInfoClosePos,i.visitorInfoFormPos=i.offlineVisitorInfoFormPos,i.visitorInfoBackImg=i.offlineVisitorInfoBackImg,i.visitorInfoLabelColor=i.offlineVisitorInfoLabelColor,i.visitorInfoInputColor=i.offlineVisitorInfoInputColor,i.visitorInfoSubmitPos=i.offlineVisitorInfoSubmitPos,i.visitorInfoSubmitTxt=i.offlineVisitorInfoSubmitTxt,i.buttonBackgroundColor=i.offlineButtonBackgroundColor,i.visitorInfoBackgroundColor=i.offlineVisitorInfoBackgroundColor,i.visitorInfoSubmitImg=i.offlineVisitorInfoSubmitImg),c.needHttps&&(i.visitorInfoCloseImg&&(i.visitorInfoCloseImg=i.visitorInfoCloseImg.replace(/^http:/,c.needHttps)),i.visitorInfoBackImg&&(i.visitorInfoBackImg=i.visitorInfoBackImg.replace(/^http:/,c.needHttps)),i.visitorInfoSubmitImg&&(i.visitorInfoSubmitImg=i.visitorInfoSubmitImg.replace(/^http:/,c.needHttps))),view.staticPx2rem&&(i.welcomeWordPos=i.welcomeWordPos&&view.staticPx2rem(i.welcomeWordPos),i.visitorInfoClosePos=i.visitorInfoClosePos&&view.staticPx2rem(i.visitorInfoClosePos),i.visitorInfoFormPos=i.visitorInfoFormPos&&view.staticPx2rem(i.visitorInfoFormPos),i.visitorInfoSubmitPos=i.visitorInfoSubmitPos&&view.staticPx2rem(i.visitorInfoSubmitPos));for(var E=' <div id="entryWrap" class="'+("1"==d?"book-all-line ":"")+'" >'+(1==i.entryCanClose&&i.visitorInfoCloseImg?'<div id="cancelEntryBtn" style="'+i.visitorInfoClosePos+'"><img src="'+i.visitorInfoCloseImg+'" onload="imgLoadResizeSelf(this)" /></div>':"")+(i.visitorInfoBackImg?'<div><img id="entryWrapImg" class="book-table-img hide" src="'+i.visitorInfoBackImg+'" onload="imgLoadResize(this,-1)" /></div>':"")+'<form id="entryForm" name="entryForm" class="book-items" ><div class="book-form-title" style="'+i.welcomeWordPos+'">'+(i.welcomeWord||"")+'</div> <div class="clearfix book-items-list" style="'+i.visitorInfoFormPos+';">',M=0,N=0,D=0,k=0;k<l;k++){var R,P=1==(R=o[k]).configRequired?" req ":"";if("1"==R.configInline?M=parseInt(M+1.5):M+=.5,"1"==R.configWebVipVisitor&&c.isVip||"1"==R.configWebVisitor&&!c.isVip){"1"==R.configInline?N=parseInt(N+1.5):N+=.5,0;var L=R.configName,_=y[L],x=window.ltIE10?"text":"birthday"==L?"date":"age"==L?"number":"text";E+='<div class="book-half book-item'+P+("1"==R.configInline?" book-one-line":"")+("gender"==L||"maritalStatus"==L?" book-item-opts":"")+'"><label class="book-label" style="color:'+i.visitorInfoLabelColor+'"><span class="req-span color0">*</span><span class="name-span">'+R.configDesc+"</span></label>"+("gender"==L?'<label class="input-radio-lb" style="color:'+i.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+P+'" name="gender" value="1" '+(1==_?'checked="checked"':"")+' lb="'+R.configDesc+'"/><span class="radio-span">'+lanRes.male+'</span></label><label class="input-radio-lb" style="color:'+i.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+P+'" name="gender" value="2" '+(2==_?'checked="checked"':"")+' lb="'+R.configDesc+'" /><span class="radio-span">'+lanRes.female+"</span></label>":"maritalStatus"==L?'<label class="input-radio-lb" style="color:'+i.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+P+'" name="maritalStatus" value="1" '+(1==_?'checked="checked"':"")+' lb="'+R.configDesc+'"/><span class="radio-span">'+lanRes.unmarried+'</span></label><label class="input-radio-lb" style="color:'+i.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+P+'" name="maritalStatus" value="2" '+(2==_?'checked="checked"':"")+' lb="'+R.configDesc+'"/><span class="radio-span">'+lanRes.married+"</span></label>":'<input type="'+x+'" lb="'+R.configDesc+'" class="book-ipt '+P+'" name="'+L+'" value="'+(_||"")+'" style="border-bottom-color:'+i.visitorInfoInputColor+";color:"+i.visitorInfoInputColor+';"/>')+"</div>"}else o[k].disabled=!0,D++}if(1==i.captChaEnable&&(E+='<div class="clearfix"><div class="book-half book-item req" id="verifyInner"><label class="book-label" style="color:'+i.visitorInfoLabelColor+'"><span class="req-span color0">*</span><span class="name-span">'+lanRes.validateCode+'</span></label><input type="text" id="verify_input" class="book-ipt req" lb="'+lanRes.validateCode+'" style="border-color:'+i.visitorInfoInputColor+'"/></div><div class="book-half book-item verify-line"><img alt="'+lanRes.validateCode+'" id="verify_img" src="'+c.dataHost+"/chatCaptCha.jpg?captChatToken="+a.captChaToken+'"/><span class="color0 cursor-p" id="verify_change">'+lanRes.nextPic+"</span></div></div>",e(".verify-change").attr("id",""),e(".verify-img").attr("id",""),e(".verify-ok").attr("id",""),e(".verify-input").attr("id","")),E+="</div>",E+='<div id="submitBtnentry" style="'+i.visitorInfoSubmitPos+'" class="book-btn"> <span class="book-btn-text">'+(i.visitorInfoSubmitTxt||"")+"</span></div>",E+="</form></div>",e("body").append('<div id="entry" class="entry-wrap">'+E+"</div>").show(),1==view.windowType&&(M=parseInt(M+.5),N=parseInt(N+.5),D=M-N),D>0&&setTimeout(function(){e(".book-items-list").css("paddingBottom",view.px2rem?view.px2rem(30*D):30*D+"px")},10),c.publish("removeLoading"),e("#mask").show(),e("body").addClass("entry"),i.visitorInfoSubmitImg&&!view.SDK){c.needHttps&&(i.visitorInfoSubmitImg=i.visitorInfoSubmitImg.replace(/^http:/,c.needHttps));var H=new Image;H.onload=function(){var e=_$("submitBtnentry").style;e.backgroundImage="url('"+i.visitorInfoSubmitImg+"')",e.backgroundSize=(view.px2rem?view.px2rem(this.width):this.width+"px")+" "+(view.px2rem?view.px2rem(this.height):this.height+"px"),e.lineHeight=view.px2rem?view.px2rem(this.height):this.height+"px",e.height=view.px2rem?view.px2rem(this.height):this.height+"px",e.width=view.px2rem?view.px2rem(this.width):this.width+"px",e=null,H=null},H.src=i.visitorInfoSubmitImg}return e("#cancelEntryBtn").on("click",function(e){var t=c.hasEntryOrCode;c.visitorClose=!1,c.publish("_endChat"),c.publish("chatEnded",{}),(t||"0"==c.queryParams.autoChat)&&(c.publish("entryCallback",{success:!0}),c.publish("_endConnect")),delete c.queryParams.autoPop,delete c.queryParams.autoChat}),c.addEntryEvent({list:o,configData:i,submitSelector:"#submitBtnentry"}),setTimeout(function(){var e=_$("entryForm").offsetHeight+(view.px2px?view.px2px(20):20)+_$("entryForm").offsetTop;_$("entry").style.minHeight=e+"px"},100),!0},orderSubAttachments:[],orderFileIndexObj:{},addOrderSubmitEvent:function(t,i){function s(i){if(i.stopPropagation(),d)return!1;for(var s,c,f,u,m=l,h={},p=!0,g=0,v=t.length;g<v;g++)if(s=null,label="",I=t[g],f=I.configName,c=m[f],!t[g].disabled){if(u=a(m,c,f),s=u.val,!(p=n(c,s,f,function(t){c.nodeType?t?e(c).removeClass("error"):e(c).addClass("error"):c[0]&&c[0].nodeType&&e(c[0].parentNode.parentNode).addClass("error")})&&p))return!1;s&&p&&u.label+" "+u.labelVal+"\r\n ","1"!=t[g].configType&&"2"!=t[g].configType||"title"===f||(s=r.escapeHtml(s)),h[f]=s}if(view.handleNetwok&&view.handleNetwok())return!1;var b=r.msg649&&r.msg649.jobWindowInfo||{};h.routeId=r.msg649.routeId,h.token=b.token,h.nonce=b.nonce,h.styleId=r.msg649.styleId,h.jobTemplateId=r.msg649.jobWindowInfo.jobTemplateId,h.requesterLan=r.msg600.lan,h.echatTag=r.paramChat.echatTag||"",h.metaData=r.paramChat.metaData||"",h.myData=r.paramChat.myData||"",h.chatDomain=r.paramChat.referrer||"",h.firstUrl=r.paramChat.firstUrl||"",h.firstUrlTitle=r.paramChat.firstTitle||"",h.recordUrl=r.paramChat.chatPage||"",h.recordUrlTitle=r.paramChat.chatPageTitle||"",h.referrer=r.paramChat.referrer||"",h.robotInfoId=r.workOrder2RobotTalkId||"",h.media=view.SDK?4:1,h=function(e){for(var t in e)""===e[t]&&delete e[t];return e}(h);var y=!0;if(view.SDKNative&&view.orderUploadData.length>0){h.attachments=[],r.orderSubAttachments=[];var w;for(T in view.orderUploadData)(I=view.orderUploadData[T])&&I.index&&I.data?(w={type:1,fileValue:{url:I.data.sourceUrl,name:I.data.fname||"",size:I.data.fsize,fileType:4==I.data.fileType?2:4,key:I.data.key,bucket:I.data.bucket}},h.attachments.push(w)):!I.data&&I.index&&(y=!1);h.attachments=JSON.stringify(h.attachments)}else if(r.orderSubAttachments.length>0){h.attachments=[];for(var I,T=0;T<r.orderSubAttachments.length;T++)(I=r.orderSubAttachments[T]).name=encodeURIComponent(I.name),I.fileValue?h.attachments.push({type:I.type,fileValue:I.fileValue}):y=!1;h.attachments=JSON.stringify(h.attachments)}if(r.paramChat.acdStaffId&&(h.acdStaffId=r.paramChat.acdStaffId),r.paramChat.acdType&&(h.acdType=r.paramChat.acdType),d=!0,y)return o(h,function(e){d=!!e}),!1;r.showDialog({tip:lanRes.visitor190,ok:function(){for(var e=0;e<r.orderSubAttachments.length;e++)r.orderSubAttachments[e].xhr&&r.orderSubAttachments[e].xhr.abort();o(h,function(e){d=!!e})},cancel:function(){d=!1}})}function o(t,i){var a="1"===r.msg649.jobWindowInfo.jobQRCodeEnable,n=r.msg649.jobWindowInfo.commitSuccessHint;t.companyId=r.companyId,t.requesterVisitorId=r.visitorId,e._ajax({url:r.apiServerDomain+"/chatapi/jobh/cmj",type:"post",data:t,contentType:"application/x-www-form-urlencoded; charset=UTF-8",success:function(e){if("string"==typeof e&&e.length>4)try{e=JSON.parse(e)}catch(e){}e.successful?(i&&i(!0),r.overOrderForm(e.result.data,a,n)):(i&&i(!1),r.showDialog({tip:e.errorMsg,cancel:!1}))}})}var r=this,l=_$("orderForm");1!=view.windowType?view.handleShowOrderSubmit&&setTimeout(function(){view.handleShowOrderSubmit()},15):view.toLeaveMessage&&setTimeout(function(){view.toLeaveMessage()},15),e(".entry2-input",l).bind("blur",function(){var e=this.name;n(this,a(l,this,e).val,e,function(e){})}),e("textarea",l).bind("blur",function(){n(this,this.value.replace(/^[\s]+|[\s]+$/gi,""),"textarea",function(e){})}),e("input",l).bind("change",function(){var e=this.name;n(this,a(l,this,e).val,e,function(e){})}),e("select",l).bind("change",function(){n(this,this.value,"select",function(e){})}),e(".date-input",l).bind("change",function(t){var i=e(".date-show",this.parentNode);i&&i.val(this.value)});var d=!1;_$("orderForm").onsubmit=s,e(i).off("click").bind("click",s)},overOrderForm:function(t,i,a){if(t.codeUrl){e("#orderSubmit")&&e("#orderSubmit").remove();var n=i?t.codeUrl:locationBase+"/res/imgs/"+(view.SDK?"order_sdk.png":"order_web.png"),s=i?"order-complete":"order-complete-auto",o=i?'<div class="tip2">'+lanRes.visitor184+"</div>":"";_html='<div id="orderSubmit"><div class="'+s+'"><img src="'+n+'" /><div class="tip1">'+a+"</div>"+o+"</div></div>",1==view.windowType?e("#leave").html(_html).removeClass("hide"):e("body").append(_html),e(".leave-entry-foot")&&e(".leave-entry-foot").remove()}},addEntryEvent:function(t,i){function s(t){if(c)return!1;for(var s,l,f,u,m=_$("entryForm"),h={windowType:view.windowType},p="",g=!0,v=0,b=o.length;v<b;v++)if(w=null,"",s=o[v],f=s.configName,l=m[f],!o[v].disabled){if(u=a(null,l,f),w=u.val,!(g=n(l,w,f,function(t){l.nodeType?t?e(l).removeClass("error"):e(l).addClass("error"):l[0]&&l[0].nodeType&&e(l[0].parentNode.parentNode).addClass("error")})&&g))return!1;w&&g&&(p+=u.label+" "+(u.inputValue||w)+"\r\n "),h[f]=w}if(console.log(p),view.handleNetwok&&view.handleNetwok())return!1;if(h.leaveContent=void 0,d.leaveAndClose){var y=e(".leave-entry-text").results[0];if(n(y,y.value,"content",function(t){y.nodeType&&(t?e(y).removeClass("error"):e(y).addClass("error"))}),!y.value)return!1}if(1==r.captChaEnable){if(e("#verify_change").hasClass("loadin"))return!1;var w;if(!(w=e("#verify_input").val()))return e("#verify_input").addClass("error"),!1;e("#verify_change").addClass("loadin"),h.captcha=w}return h.et=106,"1"==d.queryParams.autoPop&&(h.isAutoPop=1),c=!0,d.entryParam=h,d.entryVisitorMsg=p,d.entryLeaveContent=y&&y.value,d.publish("visitorCommonEvent",h,function(t){t&&t.successful&&i&&i(),1==r.captChaEnable&&e("#verify_change").removeClass("loadin"),c=!1}),!1}var o=t.list,r=t.configData,l=t.submitSelector,d=(t.crm20,this);1==r.captChaEnable&&d.toShowCode(),view.handleShowEntry&&setTimeout(function(){view.handleShowEntry()},15),e("input",_$("entryForm")).bind("blur",function(){var e=this.name;n(this,a(null,this,e).val,e,function(e){})}),e("textarea",_$("entryForm")).bind("blur",function(){n(this,this.value.replace(/^[\s]+|[\s]+$/gi,""),"textarea",function(e){})}),e("select",_$("entryForm")).bind("change",function(){n(this,this.value,"select",function(e){})}),e(".date-input",_$("entryForm")).bind("change",function(t){var i=e(".date-show",this.parentNode);i&&i.val(this.value)});var c=!1;_$("entryForm").onsubmit=s,e(l).off("click").on("click",s)},toShowCode:function(){function t(){if(!e("#verify_change").hasClass("loadin")){e("#verify_change").addClass("loadin");var t={et:122,windowType:view.windowType,content:"refresh code"};"1"==i.queryParams.autoPop&&(t.isAutoPop=1),i.publish("visitorCommonEvent",t)}}var i=this;this.codeShowed&&(e("#verify_change").removeClass("loadin"),e("#verify_input").removeClass("error").val("")),this.codeShowed=!0,e("#verify_img").off("click").bind("click",t),e("#verify_change").off("click").bind("click",t),e("#verify_input").off("click").bind("keydown",function(){e("#verify_input").removeClass("error")}),e("#verify_ok").off("click").bind("click",function(){if(!e("#verify_change").hasClass("loadin")){var t=e("#verify_input").val();if(t){e("#verify_change").addClass("loadin");var a={et:106,captcha:t,windowType:view.windowType};"1"==i.queryParams.autoPop&&(a.isAutoPop=1),i.publish("visitorCommonEvent",a,function(){})}else e("#verify_input").addClass("error")}})},toShowQcode:function(){function t(t){if(e("#qcode_loading").show(),e("#qcode_img").attr("loaded","loaded").hide(),t){var a=(i.dataHost||"")+"/cqr?"+(i.needHttps?"ssl=1&":"")+"chatToken="+t+"&cqrChatPage="+encodeURIComponent(window.location.pathname),n=new Image;n.onload=function(){e("#qcode_loading").hide(),e("#qcode_img").attr({loaded:"loaded",src:a}).show(),setTimeout(function(){e("#qcode_img").removeAttr("loaded"),i.publish("_toGetChatToken")},54e4)},n.onerror=function(t){e("#qcode_img").removeAttr("loaded")},n.src=a}else i.publish("_toGetChatToken")}var i=this;return view.qcodeWechat||(i.subscribe("getChatToken",function(e,i){t(i.chatToken)}),i.subscribe("_toGetChatToken",function(){i.publish("visitorCommonEvent",{et:120,companyId:i.companyId})})),view.toggleQcode&&view.toggleQcode(t),!0},toInitEvaluate:function(t){var i,a,n=this,o=!1,r=t.evaluateInfo||t.smallEvaluateInfo||t.mobileEvaluateInfo||t.sdkEvaluateInfo||n.msg649&&(n.msg649.evaluateInfo||t.smallEvaluateInfo||n.msg649.mobileEvaluateInfo||n.msg649.sdkEvaluateInfo);if(!r)return n.satisfyEnable=!1,void this.toggleEvaluateMenu(1);if(0==r.enable?(n.satisfyEnable=!1,this.toggleEvaluateMenu(6)):(this.toggleEvaluateMenu(5),n.satisfyEnable=!0,1==r.enableVisitorEvaluateLimit&&parseInt(r.allowEvaluateBaseWords)>0&&(n.allowEvaluateBaseWords=parseInt(r.allowEvaluateBaseWords),n.sendMsgNum<n.allowEvaluateBaseWords?this.toggleEvaluateMenu(3):this.toggleEvaluateMenu(4))),!this.hasInitEvaluate){n.hasInitEvaluate=!0,(a=(i=l=1==r.evaluateType)?1==r.bestEnable?5:1==r.betterEnable?4:1==r.commonEnable?3:1==r.worseEnable?2:1==r.worstEnable&&1:5)||(a=5,o=!0),e("#satisfy_ipt").val(a);var d='<div class="sa-title tc"><div class="sa-title-left"></div><div class="sa-title-content"><span langs="evaluateTip">'+lanRes.evaluateTip+'</span><span class="sa-name sa-name5 emcolor">'+n.stringEncode(r.bestDesc)+'</span><span class="sa-name sa-name4 emcolor">'+n.stringEncode(r.betterDesc)+'</span><span class="sa-name sa-name3 emcolor">'+n.stringEncode(r.commonDesc)+'</span><span class="sa-name sa-name2 emcolor">'+n.stringEncode(r.worseDesc)+'</span><span class="sa-name sa-name1 emcolor">'+n.stringEncode(r.worstDesc)+'</span></div><div class="sa-title-right"></div></div>';if(i&&!o?(d+='<ul class="sa-imgs clearfix">',1==r.worstEnable&&(d+='<li class="sa-img sa-img1" v="1"><img class="sa-s-img" v="1" src="'+r.worstSelected.replace(/^http:/,n.needHttps||"http:")+'"/><img class="sa-un-img" v="1" src="'+r.worstUnSelected.replace(/^http:/,n.needHttps||"http:")+'"/></li>'),1==r.worseEnable&&(d+='<li class="sa-img sa-img2" v="2"><img class="sa-s-img" v="2" src="'+r.worseSelected.replace(/^http:/,n.needHttps||"http:")+'"/><img class="sa-un-img" v="2" src="'+r.worseUnSelected.replace(/^http:/,n.needHttps||"http:")+'"/></li>'),1==r.commonEnable&&(d+='<li class="sa-img sa-img3" v="3"><img class="sa-s-img" v="3" src="'+r.commonSelected.replace(/^http:/,n.needHttps||"http:")+'"/><img class="sa-un-img" v="3" src="'+r.commonUnSelected.replace(/^http:/,n.needHttps||"http:")+'"/></li>'),1==r.betterEnable&&(d+='<li class="sa-img sa-img4" v="4"><img class="sa-s-img" v="4" src="'+r.betterSelected.replace(/^http:/,n.needHttps||"http:")+'"/><img class="sa-un-img" v="4" src="'+r.betterUnSelected.replace(/^http:/,n.needHttps||"http:")+'"/></li>'),1==r.bestEnable&&(d+='<li class="sa-img sa-img5 sa-sli5" v="5"><img class="sa-s-img" v="5" src="'+r.bestSelected.replace(/^http:/,n.needHttps||"http:")+'"/><img class="sa-un-img" v="5" src="'+r.bestUnSelected.replace(/^http:/,n.needHttps||"http:")+'"/></li>'),d+="</ul>"):d+='<ul class="sa-stars clearfix"><li class="sa-sli sa-star emcolor" v="1">&#xe64d;</li><li class="sa-sli sa-star emcolor" v="2">&#xe64d;</li><li class="sa-sli sa-star emcolor" v="3">&#xe64d;</li><li class="sa-sli sa-star emcolor" v="4">&#xe64d;</li><li class="sa-sli sa-star emcolor sa-sli5" v="5">&#xe64d;</li></ul>',!i||!o){d+='<div class="sub-tabs clearfix " >',view.SDK&&(d+="<div>");for(var c=["worstConfiguration","worseConfiguration","commonConfiguration","betterConfiguration","bestConfiguration"],f=5;f>0;f--){var u=r[c[f-1]]||[],m=u.length;d+='<ul class="sub-tab sub-tab'+f+'" '+(m>0?"":'style="display:none"')+' id="subEvaluate'+f+'"> ';for(var h=0;h<m;h++){var p=u[h];d+='<li class="sa-cli" dataname="'+p.configName+'">'+n.stringEncode(p.configDesc)+"</li>"}d+="</ul>"}view.SDK&&(d+="</div>"),d+="</div>"}e("#satisfyConfig").html(d).addClass("sa-sel-"+a).attr("default",a),view.handleSatisfy&&view.handleSatisfy(o,i,a),e("#sa_ok").on(n.isMobile&&!n.isPcXcx?"touchend":"click",function(t){if(view.handleNetwok&&view.handleNetwok())return!1;view.SDK&&e.store("ECHAT_inviteSatisfyHandle",e.store("ECHAT_inviteSatisfyId")),n.isMobile&&t.preventDefault();var i=n.stringEncode(e("#sa_advise").val()),a=e("#satisfy_ipt").val(),r="";if("0"!=a&&a){if(!o){var l=e(".sa-cli",_$("subEvaluate"+a)).results||[],d=l.length;if(d>0)for(var c=0;c<d;c++)r+="&"+[e(l[c]).attr("dataname")]+"="+(e(l[c]).hasClass("sub-selected")?1:0)}var f=n.dataHost+"/ces?companyId="+n.companyId+"&talkId="+n.talkId+"&visitorId="+encodeURIComponent(n.visitorId||"")+(view.SDK?"&appId="+encodeURIComponent(n.appId||""):"")+"&nonce="+encodeURIComponent(n.restartParam.nonce||"")+"&reChatTag="+encodeURIComponent(n.restartParam.reChatTag||"")+"&mainItem="+a+"&evaluateType="+n.satisfyType+"&media="+n.Device.media+"&windowType="+view.windowType+"&lan="+(window.lanName||"")+"&comment="+encodeURIComponent(i||"")+r;console.log("url***",f),e.ajax({url:f,type:"jsonp",jsonpCB:"jsonpCallback",success:function(e){if(console.log(e),n.satisfyShowed=n.talkId,1==e)n.evaluateScore=a,s(lanRes.successSubmitEval,"ok"),view.resetSatisfy&&view.resetSatisfy(),!1===n.chatting?(n.publish("_closeWin"),n.publish("__evaluate","1-2",a+"-2")):n.publish("__evaluate","1-1",a+"-1"),i&&n.publish("__evaluateComment",{comment:i,chatting:n.chatting});else{var t=lanRes.unkownErrorSubmitEval;129==e?t=lanRes.evaluateTimeout:130==e?t=lanRes.evaluateRepeat:133==e&&(t=lanRes.evaluateRepeatTime),s(t)}},error:function(){s(lanRes.unkownErrorSubmitEval)}}),e("#satisfy").removeClass("satisfy-show").hide(),e("#mask").off("click",n.hideSatisfy),e("#mask").hide(),_$("sa_advise").blur(),view.hideSatisfy&&view.hideSatisfy()}}),e("#sa_cancel").on(n.isMobile&&!n.isPcXcx?"touchend":"click",function(e){n.hideSatisfy(),n.isMobile&&e.preventDefault()})}},toggleEvaluateMenu:function(t){if(view.decideEvalMenu)return view.decideEvalMenu(t%2);var i=e(".menu-satisfy"),a="hide",n="limit-hide";1==t?i.addClass(a).removeClass("show"):2==t?i.removeClass(a):3==t?i.addClass(n):4==t?i.removeClass(n).removeClass(a):5==t?i.addClass("show").removeClass(a):6==t&&i.hide(),this.hasWaitingStatus&&i.addClass(a).removeClass("show"),view.calcUrlList&&view.calcUrlList()},stringEncode:function(e){var i=t.createElement("div");return i.innerText?i.innerText=e:i.textContent=e,i.innerHTML},staffMap:{},handleStaffMap:function(t,i){var a,n={};if(t&&t.length>0)for(var s=0;s<t.length;s++)t[s].staffHead&&this.needHttps&&(t[s].staffHead=t[s].staffHead.replace(/^http:/,this.needHttps)),n[t[s].staffId+""]={staffId:t[s].staffId,staffName:t[s].staffNickName||lanRes.serviceStaff,staffImg:t[s].staffHead||this.defaultStaffImg},!a&&(a=n[t[s].staffId+""]);this.staffMap=i?e.extend(n,this.staffMap):e.extend(this.staffMap,n)},updateStaffInfo:function(t,i){if(i&&i.staffId){var a={};return a[i.staffId]={staffId:i.staffId,staffName:i.staffNickName||lanRes.serviceStaff,staffImg:i.staffHead||i.staffDetailInfo&&i.staffDetailInfo.staffHead||this.defaultStaffImg},e.extend(this.staffMap,a),a[i.staffId]}},startChat:function(t,i){function a(){function e(e){n.publish("sendVisitorEvent",{et:104,content:e})}var t=n.getInput(!1),i=t;(t=t.replace(/^[\n\r\s]+$/,""))&&n.lastText!=t&&(n.lastText=t,n.plainText&&(i=n.plainTextToSendMsg(t)),1!=n.filterMsg&&3!=n.filterMsg||!i?e(i):n.filterAndSendToServer({},function(t,i,a){a||e(i)},i)),n.typingTimer=setTimeout(a,5e3)}var n=this;n.hasWaitingStatus=!1,n.companyOff=!1,"679"!=i.mt&&"686"!=i.mt&&i.talkId&&!0===this.chatting&&this.staffId!=i.staffId&&this.talkId==i.talkId&&this.publish("getSysMsg",{talkId:i.talkId,tm:i.tm,mt:"10001",staffId:i.staffId,staffName:i.staffNickName},i),i.staffDetailInfo&&e.store("ECHAT_"+window.companyId+"_"+window.chatVisitorId+"_staffHead",i.staffDetailInfo.staffHead||""),e.store("ECHAT_"+n.companyId+"_"+window.chatVisitorId+"_chatStatus",2),this.satisfyShowed!=i.talkId&&(this.satisfyShowed=0),n.talkId&&n.talkId!=i.talkId&&(n.lastTalkIdForTemp=n.talkId),this.chatting=!0,i.talkId&&(this.talkId=i.talkId),"679"!=i.mt&&(this.staffId=i.staffId,this.staffName=i.staffNickName),this.paramChat.talkId=this.talkId,this.paramChat.staffId=this.staffId,this.paramChat.staffName=this.staffName,n.initQcode(),delete n.queryParams.autoPop,delete n.queryParams.autoChat,e("#busyTipLine").addClass("hide").hide(),i.staffDetailInfo&&n.publish("staffInfo",i),n.publish("__chatStatus","chatting"),1==i.startType&&n.publish("__chatStart",i.staffNickName),n.lastTalkIdForTemp&&(n.lastTalkIdForTemp!=n.talkId&&n.handleSessionMsg({talkId:n.lastTalkIdForTemp}),n.lastTalkIdForTemp=void 0),e(".menu-capture").removeClass("hide"),e(".menu-file").removeClass("hide"),this.publish("entryCallback",{success:!0}),this.endChatEvent(),n.lastText=null,n.typingTimer=setTimeout(a,5e3),this.subscribe("getMsgTyping",function(e,t){n.showTyping()}),this.subscribe("staffStatus",function(e,t){if(1!=t.status){n.publish("_staffEndChat",t);var i=new Date;this.showMsg({f:"s",t:n.checkHistoryTime(i.getTime())?i.format("hh:mm"):void 0},lanRes.staffLeaveEnd)}})},getADURL:function(e,t,i,a,n,s){if(!i)return"";if(!e||"0"==e||!t)return i;a=a||this.paramChat;var o="",r="",l="",d=i.split("#"),c=d[1]||"",f=d[0],u=-1==f.indexOf("?")?0:1,m="?";"string"==typeof t&&(t=JSON.parse(t));var h,p,g,v,b,y=["companyId","visitorId","echatTag","lan","country","province","city","searcher","keyword","metaData","formData","myData","referrer","firstUrl","chatPage","chatPageTitle","eventId","osName","talkId","staffId","staffName","staffPhoto","staffPhone","staffInfo"],w=0;if(view.chat.isArray(t)&&t.length){for(h=t.length,g=0;g<y.length&&("staffId"==(v=y[g])&&(r=o,o="",n&&(m="",u=c?1:0)),"staffId"!=v||a.staffId);g++)for(p=0;p<h;p++)if("metaData"!=(b=t[p].paramName)&&"metadata"!=b||(b="metaData"),"formData"!=b&&"formdata"!=b||(b="formData"),b==v){"metaData"==b?(w=1,o+=(0!=u?"&":m)+b+"="+encodeURIComponent(a[b]||""),b="myData",o+=(0!=++u?"&":m)+b+"="+encodeURIComponent(a[b]||""),u++,a[b="info"]&&(o+=(0!=u?"&":m)+b+"="+encodeURIComponent(a[b]||""),u++)):"myData"==b?w||(o+=(0!=u?"&":m)+b+"="+encodeURIComponent(a[b]||""),u++):"staffId"==b?(o+=(0!=u?"&":m)+b+"="+("-1"==encodeURIComponent(a[b]||"")?"":encodeURIComponent(a[b]||"")),u++):(o+=(0!=u?"&":m)+b+"="+encodeURIComponent(a[b]||""),u++);break}y.length==g&&(l=o,o="")}return n?f+r+(c?"#"+c+l:"#"+l):f+r+l+(c?"#"+c:"")},setInnerAD:function(t){function i(){var i=e("#portrait").height();1==r.chatBoxAdImgLinkFixed&&(i+=3==r.chatBoxInnerAdType?0:e(".innerAD").height()),t.height(i)}if(t.data){var a,n,s,o,r=t.data,l=r.chatBoxAdHeight;l=l?parseInt(l):0,e(".innerAD").each(function(){e("#list_msg").contains(this)||e(this).remove()}),e("#innerADWrap").addClass("hide"),2==r.chatBoxInnerAdType?(a=r.chatBoxInnerAdContent)&&(n='<li class="clearfix innerAD innerAD-text"><div>'+a+"</div></li>"):3==r.chatBoxInnerAdType&&l?((a=r.chatBoxInnerAdImg)&&view.chat.needHttps&&(a=a.replace(/^http:/,view.chat.needHttps)),this.lastLoadInnerImgName=o=(new Date).getTime(),window["resetInnerAdHeight"+o]=function(i,a,n){if(n==view.chat.lastLoadInnerImgName){var s=(a>i?i:a)+20;1==r.chatBoxAdImgLinkFixed?(e("#innerADWrap").css("height",s+"px"),t.height(e("#portrait").height()+s)):t.height(e("#portrait").height())}},a&&r.chatBoxInnerAdImgLinkUrl?(s=this.getADURL(r.chatBoxAdPostEnable,r.chatBoxInnerAdPostParamList||"{}",r.chatBoxInnerAdImgLinkUrl,view.chat.paramChat,1!=r.chatBoxInnerAdParamAppendType),n='<li class="clearfix innerAD innerAD-img"><a id="innerADLink" target="'+(1==r.chatBoxInnerAdImgLinkOpenType?view.SDK?"cover":"_blank":"inner")+'" href="'+s+'"><img onload="resetInnerAdHeight'+o+"(this.height,"+l+","+o+')" onerror="resetInnerAdHeight'+o+"(this.height,"+l+","+o+')" style="max-height:'+l+'px" src="'+a+'"/></a></li>',e.extend(this.staffInfoRefreshMap.innerImgUrl,{notEnableParam:1!=r.chatBoxAdPostEnable,srcUrl:r.chatBoxInnerAdImgLinkUrl,url:a,params:r.chatBoxInnerAdPostParamList||"{}",hash:1!=r.chatBoxInnerAdParamAppendType,element:"#innerADLink"})):a&&(n='<li class="clearfix innerAD innerAD-img"><img onload="resetInnerAdHeight'+o+"(this.height,"+l+","+o+')" style="max-height:'+l+'px" src="'+a+'"/></li>')):1==r.chatBoxInnerAdType&&l&&((a=r.chatBoxInnerAdUrl)&&view.chat.needHttps&&(a=a.replace(/^http:/,view.chat.needHttps)),(a=this.getADURL(r.chatBoxAdPostEnable,r.chatBoxInnerAdPostParamList||"{}",r.chatBoxInnerAdUrl,view.chat.paramChat,1!=r.chatBoxInnerAdParamAppendType))&&"0"!=r.chatBoxAdHeight&&(n='<li class="clearfix innerAD innerAD-url"><iframe id="inner_frame" class="ps-child" height="'+r.chatBoxAdHeight+'px" border="0" allowtransparency="true" scrolling="no" frameborder="0" style="width:100%;height:'+r.chatBoxAdHeight+'px" '+(this.msg649&&this.msg649.unreadMsgNumber?'src="'+view.chat.addEchatInnerFrameParam(a):"")+'" ></iframe></li>'),e.extend(this.staffInfoRefreshMap.innerAD,{notEnableParam:1!=r.chatBoxAdPostEnable,srcUrl:r.chatBoxInnerAdUrl,url:a,params:r.chatBoxInnerAdPostParamList||"{}",hash:1!=r.chatBoxInnerAdParamAppendType,element:"#inner_frame"})),n&&(1==r.chatBoxAdImgLinkFixed?e("#innerADWrap").html(n).removeClass("hide"):e("#list_msg").append(n),2==r.chatBoxInnerAdType&&(setTimeout(i,1e3),setTimeout(i,5e3))),i(),this.calcInnerADHeight=i}},sendMsgNum:0,sendToServer:function(t,i,a){function n(t,n,r,l){var d=t.id;t.hide||(delete t.hasResend,t.c=t.localMsg||t.c,s.showMsg(t)),r?s.pushHistory(t):"0"!=s.queryParams.autoChat&&(t.hide||e(".msg-con",_$(d)).append('<div class="msg-error" dataid="'+d+'">&nbsp;</div>'),delete t.id,o=n||(o||t.c||t.content),s.publish("sendVisitorEvent",t.data&&t.data.et?e.extend(t.data,{bridgeMsgId:t.bridgeMsgId,img:i?1:void 0,publishAck:t.publishAck||void 0}):{et:s.isInRobot?130:105,content:o,bridgeMsgId:t.bridgeMsgId,img:i?1:void 0,publishAck:t.publishAck||void 0,tm:view.SDK?(new Date).getTime():void 0},function(i,n){if(i.successful){t.talkId=s.talkId;var r=_$(d)||_$(i.mid)||_$(t.tm);if(i.mid&&(t.mid=i.mid||t.mid,s.lasMid<t.mid&&(s.lasMid=t.mid),t.mid&&d!=t.mid&&(e(r).attr("id",t.mid),t.id=t.mid)),a)try{a(i)}catch(e){}if(!t.hide)if(e(".msg-error",r).remove(),e("img",r).each(function(){e(this).attr("src",e(this).attr("src"))}),t.data&&126==t.data.et){var l=_$(d);l&&((l=l.previousElementSibling)&&l.childNodes[0]&&-1!=(l.childNodes[0].className+"").indexOf("color1")&&e(l).remove(),e("#"+d).remove(),view.scrollUpdate&&view.scrollUpdate())}else s.pushHistory(t);delete s.errorList[d],t=null}else t.c=o,s.errorList[d]=t,t.hide||(t.publishAck=i,e(".msg-error",r).addClass("resend")),n&&n()}))}var s=this,o=i||(t.c||t.content);t.visitorImg=s.visitorImg||s.defaultVisitorImg,s.isInRobot?t.ff="r":t.f=t.f||"c",t.filterMsg&&o&&!t.localMsg?(t.localMsg=t.c,s.filterAndSendToServer(t,n,o)):n(t,i);(o=t.c||t.content)&&s.publish("__visitorSendMsg",o.replace(s.regEmo,"[face]")),o&&s.publish("__visitorStartSendMsg",o.replace(s.regEmo,"[face]")),s.isInRobot&&(e("#input_suggest").addClass("hide").html(" "),view.resetContainerBaseFoot&&view.resetContainerBaseFoot())},filterAndSendToServer:function(e,t,i){var a=this;e.id||(console.log("error :send msg has no id"),e.id=(new Date).getTime()+""),this.processMsg.sendMsgMap[e.id]=function(i,n){n&&(e.localMsg=n),a.processMsg.processNum--,t(e,i,!i)},this.processMsg.processNum++,this.publish("__sendFilter",{msgId:e.id,sendMsg:i})},firstHistoryTime:(new Date).getTime(),checkHistoryTime:function(e){return this.firstHistoryTime,!this.lastHistoryTime||e-this.lastHistoryTime>6e4?(this.lastHistoryTime=e,!0):(e-this.firstHistoryTime<-6e4||e-this.firstHistoryTime>6e4)&&(this.firstHistoryTime=e,!0)},endChatEvent:function(){this.typingTimer&&clearInterval(this.typingTimer);this.unSubscribe(["staffStatus","getMsgTyping","inviteBook","inviteBookOK"])},showTyping:function(){function t(){i.serviceTypingTime>5&&(clearInterval(i.serviceTypingTimer),e("#serviceTypingLine").remove());var t;switch(i.serviceTypingTime%3){case 0:t=a+"&nbsp;.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";break;case 1:t=a+"&nbsp;.&nbsp;.&nbsp;&nbsp;&nbsp;";break;case 2:t=a+"&nbsp;.&nbsp;.&nbsp;.&nbsp;"}i.serviceTypingTime++;var n=_$("serviceTypingLine");n&&e(".msg-item",n).html(t)}var i=this,a=lanRes.staffInput;this.serviceTypingTimer&&clearInterval(this.serviceTypingTimer),e("#serviceTypingLine").remove(),this.serviceTypingTime=0,t(),this.serviceTypingTimer=setInterval(t,500),this.showMsg({f:"s",m:0,notEnd:!0,refresh:!0,id:"serviceTypingLine"},a+"&nbsp;.&nbsp;.&nbsp;.&nbsp;")},regMail:/\b\w{1,30}([\.-]\w{1,30}){0,10}@\w{1,30}([\.-]\w{1,20}){0,10}(\.\w{1,20}){0,10}\b/g,regPhone:/([^\d]|\b)((\d{11})|((\d{7,8})|(\d{4}|\d{3})[\-\s](\d{7,8})|(\d{4}|\d{3})[\-\s](\d{7,8})[\-\s](\d{4}|\d{3}|\d{2}|\d{1})|(\d{7,8})[\-\s](\d{4}|\d{3}|\d{2}|\d{1})))(?=[^\d]|\b)/gi,regLink:/((http|ftp|https):\/\/)(([\w\._\-]+\.[a-zA-Z]{2,6})|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,4})?(\/[\w,\&%_\!\*\(\)\'\;\:\@\=\+\.\/\[-~\-#\?]*)?/gi,filterEmailPhoneLink:function(e){var t=this.isMobile;return"string"!=typeof e||e.match(/(msg\-tel)|(msg\-link)|(msg\-mail)/)?e:(this.regPhone.lastIndex=0,this.regMail.lastIndex=0,this.regLink.lastIndex=0,(e=e.replace(this.regLink,function(e){var i=arguments.length,a=arguments[i-2];if(a>0){var n=arguments[i-1].substring(0,a);if(/(\<(a|img|link|iframe|script)[^>]*>([^<]+(?!\<\/a\>))?$)|(\<[a-zA-Z]+[^>]*$)/gi.test(n))return e}return t?'<a class="msg-link" href="'+e+'" target="visitorSiteIframe">'+e+"</a>":'<a class="msg-link" target="_blank" href="'+e+'">'+e+"</a>"})).indexOf("@")>1&&(e=e.replace(this.regMail,function(e){var t=arguments.length,i=arguments[t-2];if(i>0){var a=arguments[t-1].substring(0,i);if(/(\<(a|img|link|iframe|script)[^>]*>[^<]+(?!\<\/a\>)$)|(\<[a-zA-Z]+[^>]*$)/gi.test(a))return e}return'<a class="msg-mail" target="_blank" href="mailto:'+e+'">'+e+"</a>"})),e=e.replace(this.regPhone,function(e,i){var a=arguments.length,n=arguments[a-2];if(n>0){var s=arguments[a-1].substring(0,n+1);if(/(\<(a|img|link|iframe|script)[^>]*>[^<]+(?!\<\/a\>)$)|(\<[a-zA-Z]+[^>]*$)/gi.test(s))return e}var o=i,r=e.replace(/^[^\d]|\b/,"");return(o||"")+(t?'<a class="msg-tel" href="tel:'+r+'">'+r+"</a>":'<span class="msg-tel">'+r+"</span>")}))},updateMsg:function(t,i,a){var n=_$(t);n&&(e(".msg-item",n).html(i),a&&a.newId&&e(n).attr("id",a.newId))},showLocation:function(e){var t="https://restapi.amap.com/v3/staticmap?location="+(e.locationY||e.y)+","+(e.locationX||e.x)+"&zoom="+(e.scale||15)+"&size=400*200&key=5349312538cf80d1f6c008eb059b732c&markers=mid,,A:"+(e.locationY||e.y)+","+(e.locationX||e.x),i='<div class="msg-map"><a target="'+(view.SDK?"cover":"_blank")+'" href="http://uri.amap.com/marker?position='+(e.locationY||e.y)+","+(e.locationX||e.x)+"&name="+encodeURIComponent(e.label)+'&coordinate=gaode"><div class="msg-map-title"><div>'+e.label+'</div><div class="msg-map-addr">'+(e.address||"")+'</div></div><img onerror="view.imgError&&view.imgError(this)" onload="view.scrollToBottom()" class="view_img" src="'+t+'" draggable="false"/></a></div>',a={data:e,et:127};a.c=i,a.m=7,a.f="c",a.id=e.id,a.talkId=e.talkId,e.fromHistory||902==e.mt?this.showMsg(a):this.sendToServer(a)},showMsg:function(i,a){if(i){var n=i.talkId||this.talkId,s=i.id||i.mid||"msg"+(i.tm||(new Date).getTime()),o="msg"+(i.tm||(new Date).getTime());!i.id&&"s"==i.f&&_$(s)&&e("#"+s).remove(),"x"==i.f&&_$(o)&&_$(o).remove();var r,l=i.t?'<li class="clearfix" ><div class="color1 tc">'+i.t+"</div></li> ":"";if(0==i.m?(i.c&&(i.c=this.filterEmailPhoneLink(i.c)),r=i.c?(this.filterEmo(i.c)+"").replace(/((\r\n)|\n)/g,"</br>"):a):(r=i.c||a,i.m),i.c=r,r){var d=i.visitorImg||this.visitorImg||this.defaultVisitorImg;this.needHttps&&(this.staffImg&&(this.staffImg=this.staffImg.replace(/^http:/,this.needHttps)),d=this.visitorImg||d.replace(/^http:/,this.needHttps)),view.staticPx2rem&&(r=view.staticPx2rem(r));var c={toChat:"robot-staff ",endChat:"end-chat ",toLeaveWord:"to-leave-word "};r=r.replace(/\[\[#(toChat|endChat|toLeaveWord):([^\]]+)\]\]/g,function(e,t,i){return'<span class="link-in-msg '+(c[t]||"")+'">'+i+"</span>"}),1==i.withdraw?l+='<div style="padding: 10px 0 20px;text-align: center;"><span style="display: inline-block;padding: 8px 10px;background-color: #bfbfbf;border-radius: 5px;color: #FFF;">'+r+"</span></div>":"s"==i.f||"r"==i.f?l+='<li class="clearfix '+("r"==i.f?"msg-robot":"")+" mode"+i.m+(i.media?" msg-medias":"")+'" id="'+s+'" >'+(this.showAvatar?'<div class="avatar-icon fl staff-icons"><img onerror="view.imgError&&view.imgError(this)" class="avatar-icon-img" src="'+(i.staffImg||this.staffImg||this.defaultStaffImg)+'"/></div>':"")+'<div class="msg msg-lf fl"><div class="msg-staff-name">'+this.stringEncode(i.staffName||this.staffName||lanRes.serviceStaff)+'</div><div class="msg-con radius4 fl '+("r"==i.f?"bg10":"bg1")+(0!=i.m&&6!=i.m&&3!=i.m?" bgwhite":"")+'">'+(i.media||view.SDK&&(2==i.m||4==i.m||5==i.m||7==i.m)?"":'<i class="msg-angle '+("r"==i.f?view.SDK?"color10":"border-color-angle10":view.SDK?"color11":"border-color-angle1")+'"></i>'+(view.SDK?"":0!=i.m&&6!=i.m&&3!=i.m?'<i class="msg-angle2 bc-angle1-white"></i>':""))+'<div class="msg-item">'+r+"</div></div></div></li>":"c"==i.f?l+='<li class="clearfix mode'+i.m+(i.media?" msg-medias":"")+'" id="'+s+'" >'+(this.showAvatar?'<div class="avatar-icon fr"><img onerror="view.imgError&&view.imgError(this)" class="avatar-icon-img" src="'+d+'"/></div>':"")+'<div class="msg msg-rt fr"><div class="msg-con radius4 fr '+("r"==i.ff?"bg30":"bg3")+(0!=i.m&&5!=i.m&&3!=i.m?" bgwhite":"")+'">'+(i.media||view.SDK&&(2==i.m||4==i.m||5==i.m||7==i.m)?"":'<i class="msg-angle '+("r"==i.ff?view.SDK?"color30":"border-color-angle20":view.SDK?"color3":"border-color-angle2")+'"></i>'+(view.SDK?"":0!=i.m&&5!=i.m&&3!=i.m?'<i class="msg-angle2 bc-angle2-white"></i>':""))+(i.hasResend?'<div class="msg-error resend" dataid="'+i.id+'">&nbsp;</div>':"")+'<div class="msg-item">'+r.replace(/\n/g,"<br/>")+"</div></div></div></li>":l+=r;var f=t.createElement("ul");f.innerHTML=l;for(var u,m=this.getListMsgEl(n,i.tm),h=f.childNodes,p=0;u=h[p++];)if(1==u.nodeType){u=u.cloneNode(!0);var g=((i.id||"msg0")+"").replace("msg",""),v=t.getElementById(g);v&&v.innerHTML?v.innerHTML=u.innerHTML:m.appendChild(u)}if(h=null,f=null,i.notAppend)return l;if("c"==i.f&&this.serviceTypingTimer?e("#list_msg").append(_$("serviceTypingLine")):"serviceTypingLine"!=i.id&&"s"==i.f&&this.serviceTypingTimer&&(clearInterval(this.serviceTypingTimer),e("#serviceTypingLine").remove()),i.notEnd){if(i.refresh)return void(view.chatScroll&&view.chatScroll.refresh())}else 0!=i.m&&1!=i.m&&5!=i.m&&view.scrollToBottom(null,{transitionDuration:100,timeout:"x"==i.f?1e3:1!=view.windowType?510:100}),!view.noScrollBottom&&setTimeout(function(e){view.scrollToBottom(void 0,{notVisitor:"c"!=i.f,refresh:i.refresh})},5)}}},changeStorgeBackMsg:function(e){if(!this.hasStorage)return!1;var t=window.localStorage.getItem(this.historyKey)?JSON.parse(window.localStorage.getItem(this.historyKey)):"",i=t?t.order[t.order.length-1]:"",a=t?t[i]:"";if(!a)return!1;delete t[i];var n;for(var s in a)if(a[s].mid==e){a[s].withdraw=1,a[s].c=lanRes.backMsgTip,a[s].m=0,a[s].mt="640",n=s;break}return t[i]=a,this.updateHistory(t),!!n&&parseInt(n)},updateHistory:function(t){var i=JSON.stringify(t);return this.hasStorage?(e.store(this.historyKey,i),this.isIOS&&2==view.windowType&&this.postMessage({type:"updateLocalHistory",key:this.historyKey,value:i}),i):i},updateHistoryComplete:function(e){if(this.hasStorage){var t=window.localStorage.getItem(this.historyKey);if((t=t&&JSON.parse(t))&&t[e]){if(t[e].complete=1,e.match(/^3_/))for(var i=t.order,a=0;a<i.length;a++)if(i[a]==e){i.splice(a,1),i.push(e);break}return this.updateHistory(t),t}}},initHistoryStaffInfos:function(){if(this.hasStorage){var t=e.store(this.historyKey+"_staff");if(t)try{t=JSON.parse(t);for(var i in t)this.dataObject.staffInfos[i]=t[i]}catch(e){}}},saveHistoryStaffInfos:function(){this.hasStorage&&e.store(this.historyKey+"_staff",JSON.stringify(this.dataObject.staffInfos))},getLocalHistory:function(e){if(this.hasStorage){var t=window.localStorage.getItem(this.historyKey);return t=t&&JSON.parse(t)}},initHistory:function(e){if(this.hasStorage){var t=window.localStorage.getItem(this.historyKey);return(t=t&&JSON.parse(t))||(t={order:[]}),t[e]||(t.order||(t.order=[]),t.order.push(e),t[e]={order:[]},this.dataObject.msgInfos.currentPrevTalkId&&(t[e].recentTalkId=this.dataObject.msgInfos.currentPrevTalkId)),t[e].order||(t[e].order=[]),t}},pushHistory:function(e){if(this.hasStorage&&!view.SDKNative&&e.c){var t=e.talkId||this.talkId,i=e.talkTypeId||(this.talkType||1)+"_"+t;if(t){e.talkTypeId=i;var a=this.initHistory(e.talkTypeId);if(a&&"c"==e.f){var n=a[i]||{},s=n.order;for(var o in s)if(n[s[o]].c==e.c&&n[s[o]].mid&&n[s[o]].mid==e.mid)return;if(s.length>0){var r=s[s.length-1];if(a[i][r].c==e.c&&r.indexOf("c")>-1){var l=a[i][r].tm-e.tm;if(l<200&&l>-200)return}}}"s"!=e.f||e.staffImg||(e.staffImg=this.staffImg,e.staffName=this.staffName),1!==e.m&&2!==e.m||a[i][e.tmf]?a[i][e.tm+e.f]||(a[i][e.tm+e.f]=e,a[i].order.push(e.tm+e.f)):(a[i][e.tmf]=e,a[i].order.push(e.tmf)),this.updateHistory(a)}}},saveHistoryStaff:function(e,t){if(this.hasStorage&&this.talkId){var i=(this.talkType||1)+"_"+this.talkId,a=this.initHistory(i);e&&!a[i].staffImg&&(a[i].staffImg=e||this.defaultStaffImg),e&&!a[i].staffName&&(a[i].staffName=t||lanRes.serviceStaff),this.updateHistory(a)}},checkHistory:function(t){if(this.dataObject.msgInfos.recentTalkId)return!0;if(!this.hasStorage)return e("#pre_his").hide(),!1;if(view.SDKNative)return!0;if(this.hasCheckHistory&&!t)return this.hasPreHis;this.talkId&&(this.hasCheckHistory=!0);var i=window.localStorage.getItem(this.historyKey);if(!i||'""'==i)return e("#pre_his").hide(),!1;i=JSON.parse(i);var a=this.talkType+"_"+this.talkId,n=i.order,s=n.length,o=!1;if(!s)return e("#pre_his").hide(),!1;if(1==s&&n&&n[0]&&n[0]==a)return e("#pre_his").hide(),!1;if(!t)return!0;if(s<2)return!1;for(var r=s-1;r>-1;r--)if(n[r]&&n[r]!=a&&!this.checkListMsgEl(n[r])){o=!0;break}return o},loadHistory:function(e){if(!this.hasStorage||!this.hasPreHis&&!e)return!1;if(!this.loadingPreHis){var t;if(view.SDKNative)this.publish("__loadPreHistory");else if(this.loadingPreHis=!0,(t=window.localStorage.getItem(this.historyKey))&&(t=JSON.parse(t)),this.loadLocalHisByRencent(t,e))if(t){if(!e||t[e]&&t[e].order&&0!=t[e].order.length){var i,a,n=t.order,s=n.length,o=this.talkType+"_"+this.talkId;if(s<2&&!e)return this.hasPreHis=!1,this.loadingPreHis=!1,!1;for(var r=s-1;r>-1&&(!e||n[r]==e);r--)if((e||n[r]&&n[r]!=o)&&(i=t[n[r]],a=this.checkListMsgEl(n[r]),i&&!a))return e&&(a=view.chat.getListMsgEl(e,i.order&&i[i.order[0]]&&i[i.order[0]].tm||(new Date).getTime(),!0)),0==r&&(i.recentTalkId&&t[i.recentTalkId]?this.hasPreHis=!0:this.hasPreHis=!1),this.showHis(i,n[r],!!e),!0;-1==r&&(this.hasPreHis=!1),this.loadingPreHis=!1,this.hasPreHis||this.hidePreHistory()}}else this.loadingPreHis=!1}},loadLocalHisByRencent:function(e,t){var i=(t=t||this.dataObject.msgInfos.recentTalkId)&&e&&e[t];return i&&i.complete?(this.showHis(i,t,!1),this.hasPreHis=this.checkHistory(!0)||i.recentTalkId,!1):t&&this.hasHisHandle?(this.publish("loadPreHistory"),!1):!!e||(this.hidePreHistory(),!1)},hidePreHistory:function(){this.loadingPreHis=!1,this.hasPreHis=!1,e("#pre_his").hide()},showPreHistory:function(){this.loadingPreHis=!1,this.hasPreHis=!0,e("#pre_his").show()},showHis:function(t,i,a){var n,s,o=this,r=0;s="string"==typeof i&&-1!=i.indexOf("_")?i.split("_")[1]:i;var l=this.staffImg,d=this.staffName,c={};view.preHisLoadingId="list_msg_"+i;var f=_$(view.preHisLoadingId);f||(f=o.getListMsgEl(i)),(this.dataObject.msgInfos.recentTalkId||t.recentTalkId)&&(this.dataObject.msgInfos.recentTalkId=t.recentTalkId),a?view.preHisLoadingId=null:(e(f).addClass("fake-hide"),e(".pre-his-icon").addClass("loading-spin")),view.handleHis&&view.handleHis(t);for(var u in t)if("order"!=u&&"staffImg"!=u&&"staffName"!=u&&"config"!=u&&"robotStaffImg"!=u&&"robotStaffName"!=u&&"callDatetime"!=u&&"recentTalkId"!=u&&"complete"!=u){if(n=e.extend({},t[u]),n.talkId=s,n.talkTypeId=i,n.fromHistory=!0,n.notStore=!0,n.notEnd=!0,_$("msg"+n.tm)||_$(""+n.mid)||_$(""+n.id)||_$(""+n.tmf)){if(655!=n.mt)continue}else 864==n.mt||865==n.mt||n.mt;n.t&&-1==(n.t+"").indexOf(" ")&&(n.t=o.getTimeStr(n.tm)),"649"==n.mt?n.robotConfigInfo&&t.robotStaffName?(this.staffImg=t.robotStaffImg,this.staffName=t.robotStaffName):(this.staffImg=t.staffImg,this.staffName=t.staffName):"604"==n.mt?c=!c.staffId&&n.staffDetailInfoMsgList&&n.staffDetailInfoMsgList.length?{staffId:n.staffDetailInfoMsgList[0].staffId,staffName:n.staffDetailInfoMsgList[0].staffNickName||lanRes.serviceStaff,staffImg:n.staffDetailInfoMsgList[0].staffHead||t.staffImg}:{staffId:n.staffId,staffName:n.staffNickName||lanRes.serviceStaff,staffImg:n.staffDetailInfo&&n.staffDetailInfo.staffHead||t.staffImg}:"688"==n.mt?(window.echatFormItem=window.echatFormItem||{},n.template.formInfoId?window.echatFormItem[n.template.formInfoId]=n.template:window.echatFormItem["template"+n.template.id]=n.template):"10001"==n.mt&&o.staffMap?c=o.updateStaffInfo(void 0,{staffId:n.toStaffId,staffNickName:n.toStaffNickName,staffDetailInfo:n.toStaffDetailInfo}):n.staffId&&o.staffMap[n.staffId]?(n.staffName=o.staffMap[n.staffId].staffName||t.staffName,n.staffImg=o.staffMap[n.staffId].staffImg||t.staffImg):!n.staffImg&&c.staffName&&(n=e.extend(n,c)),!a||864!=n.mt&&105!=n.et?!a||640!=n.mt&&641!=n.mt&&642!=n.mt||o.postMessage({type:"staffSendEvt",msg:640==n.mt?n.content||n.c:642==n?"[file]":641==n?"[image]":""}):o.publish("_addSendMsgNum",n),"10001"!=n.mt?"10011"!=n.mt?"10010"!=n.mt?n.mt>1e3&&"r"!=n.f||(865!=n.mt&&641!=n.mt?647!=n.mt?866!=n.mt&&642!=n.mt?"12001"!=n.mt?655!=n.mt?658!=n.mt?127!=n.mt&&902!=n.mt?680!=n.mt||n.c?688!=n.mt?959!=n.mt?605!=n.mt&&10009!=n.mt?(640==n.mt&&view.SDKNative&&(n.c=this.handleMsgImg(n.c||n.content,n),n.c=this.handleMsgVideo(n.c||n.content)),n.notAppend=!0,!n.c&&n.content&&(n.c=n.content),n.c&&this.showMsg(n),delete n.talkId):605==n.mt&&o.publish("getSysMsg",n):o.publish("submitForm",n):o.publish("receiveForm",n):o.publish("receiveURL",n):o.publish("sendLocationInfo",n):o.publish("orderReply",n):o.publish("getLeaveMsg",n):o.publish("getMsgRobot",n):o.publish("getMsgFile",n):o.publish("getSysMsg",n):(r++,a&&(n.notEnd=!1),o.publish("getMsgImg",n),a&&(n.notEnd=!0))):o.publish("getSysMsg",n):o.publish("receiveVisEvt",n):o.publish("getSysMsg",n)}if(this.staffImg=l,this.staffName=d,a)return view.chat.loadingPreHis=!1,void view.scrollToBottom();r=r>6?6:r,setTimeout(function(){e(f).removeClass("fake-hide"),view.scrollToLastPre(view.preHisLoadingId),view.chat.loadingPreHis=!1,view.preHisLoadingId=null,e(".pre-his-icon").removeClass("loading-spin"),o.hasPreHis||o.hidePreHistory()},500*(r||1))},clearHistoryByTalkId:function(e){if(this.hasStorage){var t=window.localStorage.getItem(this.historyKey);if((t=t?JSON.parse(t):"")&&t[e]){delete t[e];for(var i=t.order.length-1;i>=0;i--)t.order[i]==e&&t.order.splice(i,1)}this.updateHistory(t)}},getHistoryByTalkId:function(e){if(this.hasStorage){var t=window.localStorage.getItem(this.historyKey);return(t=t?JSON.parse(t):"")&&t[e]}},getListMsgEl:function(i,a,n){var s=this.checkListMsgEl(i);return s||(this.lastTalkIdForTemp,this.hasLeaveMsg||e(".list-his-hr").removeClass("hide"),s=t.createElement("ul"),s.id="list_msg_"+i,s.className="list-msg list-msg-his",a&&(s.innerHTML='<li class="clearfix list-his-hr color1 hide"><i class="hr-left"></i><span>'+this.getTimeStr(a)+'</span><i class="hr-right"></i></li>'),_$("list_his").insertBefore(s,n?_$("list_msg"):_$("pre_his").nextSibling),s)},checkListMsgEl:function(e){var t,i=_$("list_msg_"+e);return i||(e&&e!=this.talkId?(t="string"==typeof e&&-1!=e.indexOf("_")?e.split("_")[1]:e,i=t&&(_$("list_msg_"+t)||_$("list_msg_1_"+t)||_$("list_msg_2_"+t)||_$("list_msg_3_"+t)||_$("list_msg_4_"+t)||_$("list_msg_5_"+t))):_$("list_msg"))},handleSessionMsg:function(i){i.talkId||(i.talkId=Math.random());var a=i.talkId,n=_$("list_msg_"+a);if(n)return n;(n=t.createElement("ul")).id="list_msg_"+a,n.className="list-msg list-msg-his";for(var s,o=_$("list_msg").childNodes,r=0;s=o[r++];)1==s.nodeType&&(r--,-1!=s.className.indexOf("innerAD")&&s.childNodes&&"IFRAME"==s.childNodes[0].tagName?e(s).remove():n.appendChild(s));return _$("list_his").insertBefore(n,_$("list_msg")),n},getTimeStr:function(e){e=e&&e-0||void 0;var t=new Date,i=new Date(e).format("hh:mm");return e=e||t.getTime(),t.setHours(0,0,0,0),t=t.getTime(),(e>=t?lanRes.today:t-e<=864e5?lanRes.yesterday:t-e<=1728e5?lanRes.beforeYesterday:new Date(e).format("yyyy-MM-dd"))+" "+i},showInfoTip:function(i,a,n,s,o,r,l){var d;if("string"!=typeof i&&(i=(d=i)&&d.tip),d&&void 0===l&&(l=d.notEnd),i){view.staticPx2rem&&i&&(i=view.staticPx2rem(i));var c={toChat:"robot-staff ",endChat:"end-chat ",toLeaveWord:"to-leave-word "};i=(i=i.replace(/&nbsp;([^&\s])/g," $1")).replace(/\[\[#(toChat|endChat|toLeaveWord):([^\]]+)\]\]/g,function(e,t,i){return'<span class="link-in-msg '+(c[t]||"")+'">'+i+"</span>"}),a=a||"msg"+(new Date).getTime(),n=n||"icon";var f='<li class="clearfix '+(this.showAvatar?"msg-info-hasAvatar":"msg-info-noAvatar")+'" id="'+a+'" ><div class="'+(!d&&this.isInRobot||d&&"r"==d.f?"msg-info0":"msg-info")+' radius4"><div class="info-con">'+i+"</div></div></li>";if(s)return f;a&&_$(a)&&e("#"+a).remove();var u=t.createElement("ul");u.innerHTML=f;for(var m,h=this.getListMsgEl(o,r),p=u.childNodes,g=0;m=p[g++];)1==m.nodeType&&(m=m.cloneNode(!0),h.appendChild(m));p=null,u=null,!l&&view.scrollToBottom(null,{transitionDuration:100,timeout:100})}},resetStatisfy:function(){if(e("#sa_advise").val(""),!l)for(var t=e(".sa-sli").results,i=0;i<t.length;i++)e(t[i]).addClass("sa-star").html("&#xe64d;");var a=e("#satisfyConfig").attr("default");e("#satisfyConfig").attr("class","sa-sel-"+a),e(".sub-tab-sel").removeClass("sub-tab-sel"),e(".sub-tab"+a).addClass("sub-tab-sel"),e("#satisfy_ipt").val(a)},showSatisfy:function(t){if(this.allowEvaluateBaseWords>this.sendMsgNum&&1==t)return!1;if(this.notEvaluate)return this.notEvaluate=!1,!1;if(this.satisfyType=t,2==t||3==t||this.satisfyEnable&&!this.satisfyShowed){view.inputBlur&&view.inputBlur(),this.resetStatisfy();var i=this.hideSatisfy,a=setTimeout(function(){clearTimeout(a),e("#mask").off("click",i).on("click",i).show(),e("#satisfy").show()},0);return view.handleShowSatisfy&&view.handleShowSatisfy(),!0}return!1},hideSatisfy:function(){var t=view.chat;e("#satisfy").removeClass("satisfy-show").hide(),e("#mask").hide().off("click",t.hideSatisfy),!1===t.chatting?(t.publish("_closeWin"),t.publish("__evaluate","0-2")):t.publish("__evaluate","0-1"),view.SDK&&e.store("ECHAT_inviteSatisfyHandle",e.store("ECHAT_inviteSatisfyId")),view.SDK&&_$("sa_advise").blur(),view.hideSatisfy&&view.hideSatisfy()},addJS:function(e,i){function a(e){n.onload=n.onerror=n.onreadystatechange=null,s.removeChild(n),n=null,i(e)}var n=t.createElement("script");n.setAttribute("type","text/javascript");var s=_$s("head")[0];"onload"in n?(n.onload=a,n.onerror=function(){a(!0)}):n.onreadystatechange=function(){/loaded|complete/.test(n.readyState)&&a()},n.src=e,s.appendChild(n)},addCSS:function(e){var i=t.createElement("link");i.rel="stylesheet",i.type="text/css",i.href=e,i.media="screen";_$s("head")[0].appendChild(i)},loadEmoji:function(){var t=this;if(!t.emo){if(view.loadEmoji)return view.loadEmoji();this.addCSS(t.isMobile&&view.px2px?__uri("/visitor/mobile/css/emoji.css"):t.isMobile?locationBase+"/res/emoji/emoji_x2.css":locationBase+"/res/emoji/emoji.css"),e.ajax({url:locationBase+"/res/emoji/emoji.json",async:!0,type:"get",contentType:"application/json;charset=UTF-8",success:function(e){t.emo="string"==typeof e?JSON.parse(e):e},error:function(e,t,i){console.log("ajax emoji error")}}),e.ajax({url:locationBase+"/res/emoji/emoji_"+(window.lanName.match(/^zh/i)?"zh":"en")+".json",async:!0,type:"get",contentType:"application/json;charset=UTF-8",success:function(e){t.emoLan="string"==typeof e?JSON.parse(e):e;var i={};for(var a in t.emoLan)i[t.emoLan[a]]=a;t.lanEmo=i},error:function(e,t,i){console.log("ajax emoji error")}}),e.ajax({url:locationBase+"/res/emoji/emojiFace.json",async:!0,type:"get",contentType:"application/json;charset=UTF-8",success:function(i){var a="string"==typeof i?JSON.parse(i):i;view.initEmotion.call(t,a),e("#emotion").on(t.isMobile&&!t.isPcXcx?"tap":"click",".emoji",function(i){var a=e(this).attr("code"),n=t.getInput().length+a.length+4,s=t.inputMaxLength;n>s||(e("#inputLengthTip").html(lanRes.inputLengthTip1+(s-n)+lanRes.inputLengthTip2),!t.isMobile&&t.focusInput(),t.insertImg(a),t.oldBodyEnterText=t.getInput())})},error:function(e,t,i){console.log("ajax emoji error")}})}},filterEmo:function(e){if(!e||"string"!=typeof e)return e;var t=this.emo;return t&&(e=e.replace(this.regFace,function(e){arguments[0];var i=e.charCodeAt(0),a=e.charCodeAt(1),n=(a-56320+(i-55296<<10)+65536).toString(16);return t[n]?'<img class="img-emo" src="'+locationBase+"/res/emoji/32/"+n+'.png" />':t[i+"_"+a]?'<img class="img-emo" src="'+locationBase+"/res/emoji/32/"+i+"_"+a+'.png" />':e})),e=e.replace(this.regEmo,function(e){var i=e.replace(/^\[#([\d\w_]+)#\]/g,"$1");return t&&t[i]||!t?'<img class="img-emo" src="'+locationBase+"/res/emoji/32/"+i+'.png" />':e})},HTMLDecode:function(e){var i=t.createElement("div");null!=i.textContent?i.textContent=e:i.innerText=e;var a=i.innerHTML;return i=null,a},getFileSize:function(e,i){if(""!=e.value){var a=-1;if(e.files&&e.files[i])a=parseInt(e.files[i].size);else try{e.select();var n=t.selection.createRange().text;a=new ActiveXObject("Scripting.FileSystemObject").GetFile(n).size}catch(e){console.log("如果你用的是ie8以下 请将安全级别调低！")}return a}},hasFormData:function(){var e=!0;try{1==view.windowType&&new FileReader,new FormData}catch(t){e=!1}return e}(),hasInitFile:!1,addSendFile:function(){if(!view.SDKNative){if(this.hasInitFile)if(this.hasFormData);else{(i=_$("file_up"))&&(i.src="/visitor/common/upload.html?t="+(new Date).getTime())}else if(this.hasFormData)window.fLoad(t);else{var i=_$("file_up");if(i)return;e("#uploadForm").remove(),e(".menu-file").append('<iframe src="/visitor/common/upload.html" style="filter:alpha(opacity=0.1);opacity: 0.1;position: absolute;top:0;left:0;z-index: 999999999;" allowtransparency="true" id="file_up" frameborder="0" framespacing="0" marginheight="0" marginwidth="0" width="100%" height="100%" scrolling="no"></iframe>')}}},isImgHasPreview:function(t){var i=e(t);if(i.hasClass("msg-img"))return!0;if(i.hasClass("img-emo")||i.hasClass("custom-event-img")||!t.src)return!1;if(i.parents(".msg-info").length||i.parents(".msg-info0").length||i.parents(".msg-item").length){if(i.parents("a").attr("href"))return!1;if(!i.hasClass("info-icon-img")&&!i.parents(".portrait-title").length&&!i.parents(".feedback-btns").length)return!0}},setMerchantLogo:function(t){var i=[],a="",n="",s=t.chatLogoImgEnable,o="",r="";this.staffInfoRefreshMap.merchantLink=null,"1"==s&&(a="1"==t.chatLogoImgType?this.platformLogo:this.companyLogo)&&i.push('<img class="header-logo" src="'+a+'"/>'),"1"==t.companyNameEnable&&(n="1"==t.companyNameType?this.platformName:this.companyName)&&i.push('<span class="header-logo-txt">'+n+"</span>"),"1"==t.subcompanyUrlEnable&&((o=t.subcompanyUrl)&&(r=this.getADURL(!0,t.subcompanyAdPostParamList,o,this.paramChat)),t.subcompanyButtonUrl&&i.push('<a class="merchant-link" href="'+(r||"")+'" target="_blank"><img class="merchant-icon" src="'+t.subcompanyButtonUrl+'"/></a>'),r&&(this.staffInfoRefreshMap.merchantLink={notEnableParam:!1,params:t.subcompanyAdPostParamList,element:".merchant-link",hash:!1,srcUrl:o,attr:"href",url:""})),e("#logobox").html(i.join(""))}},window.imgLoadResizeSelf=function(e){view.px2rem&&(e.style.width=view.px2rem(e.naturalWidth||e.width))},window.imgLoadResize=function(t,i){function a(){var t=1==view.windowType?600:260,a=this.naturalWidth||this.width,o=_$(n);o&&(a>t&&(a=t),o.style.width=view.px2rem?view.px2rem(a):a+"px",-1==i&&(o.style.marginLeft=view.px2rem?view.px2rem(-a/2):-a/2+"px"),e("#"+s).removeClass("hide").css("width",view.px2rem?view.px2rem(a):a+"px"),view.scrollToBottom())}Math.random();var n=-1==i?"entry":"inviteBook"+i,s=-1==i?"entryWrapImg":"inviteBookImg"+i;if(t.naturalWidth)a.call(t);else{var o=new Image;o.onload=a,o.src=t.src}};var f=!1;window.initReady=function(t){window.initReady=null,f=!0;var i=new c;3==view.windowType&&2!=i.media&&(i.media=2),setTimeout(window.initChat,0),"firefox"==i.Browser.browser&&e("body").on("drop",function(e){e.stopPropagation()}),"xcx"==i.queryParams.launchfrom&&(i.media=i.Device.media=2,i.addJS("https://res.wx.qq.com/open/js/jweixin-1.3.2.js")),"522116"!=i.companyId&&"521863"!=i.companyId||(lanRes.chatWith=" ","enus"==window.lanResName?lanRes.tip="Message":"zhcn"==window.lanResName?lanRes.tip="讯息":"zhtw"==window.lanResName&&(lanRes.tip="訊息"))},e(function(){initReady&&initReady()})}(EChatQuery,document);