function InputHandle(){var f=this;this.filterPasteData=function(e,t,i){var a=i?"\r\n":"<br/>";return e&&t?e.replace(/(^[\s\r\n]+)|[\r]|([\s\r\n]+$)/g,"").replace(/[\r\n]+([\r\n\s]+)*/g,a):e&&e.replace(/<(br|hr)\/?>/gi,"\n").replace(/<\/(br|p|div|table|section|footer|article|li|ul|ol)>/gi,"\n").replace(/(<[a-z]+(\s+[^>]*)?>)|(<\/?[a-z]+\/?>)/gi,"").replace(/([\r\n]+)|([\r\n]+[\s]+[\r\n]*)|([\r\n]*[\s]+[\r\n]+)/g,"\n").replace(/[\n]+/g,a)},this.getInput=function(e){if(f.plainText){var t=$("#textInput").val();if(t){if(e){$("#textInput").val("");_$("textInput")}return f.filterPasteData(t,!0,!0)}return t}f.getInputDoc();var i,a=f.getInputDocBody();null!=a.lastElementChild&&"SL_balloon_obj"==a.lastChild.id&&a.removeChild(a.lastChild);var n=i=a.innerHTML;if(500<n.length&&(n=i.replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[#$1#]")),e?(a.innerHTML="",$("#inputPlaceholder").removeClass("hide")):i.length,500<i.length)s=n;else{var s=n.replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[#$1#]");s=f.filterPasteData(s,!1,!0)}return 5e3<s.length&&(s=s.substring(0,5e3)),s},this.setInput=function(e){if(!e)return this.getInput(!0);if(e=e.replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[#$1#]").replace(/<(?!br|\/br)(?:.|\s)*?>/gi,"").replace(/&nbsp;/gi," ").replace(/^((<\/?br\/?>)|[\r\n\s]+)+|((<\/?br\/?>)|[\r\n\s]+)+$/gi,""),f.plainText)$("#textInput").val(e);else{f.getInputDoc();f.getInputDocBody().innerHTML=e}},this.inputScrollToView=function(e){var i=this,a=1;$(e).on("focus",function(e){window.top==window?(function t(){if(15<a)return;setTimeout(function(){var e=window.innerHeight+(i.isIOS?80:20);window.scrollTo(0,e),a++,t()},100)}(),a=1):i.postMessage("inputScroll")}),$(e).on("blur",function(e){a=1,setTimeout(function(){i.postMessage("inputScrollStop")},550)})},this.changeToIframe=function(e,t){if(this.plainText){this.plainText=!1,this.editorType=2;var a=this;$("#textInput").hide();var i=_$("html_input");if(i.style.display="block",!this.hasInitIframeInput){this.hasInitIframeInput=!0;var n=a.getInputDoc();try{n.designMode="on"}catch(e){console.log(e)}n.contentEditable=!0;try{window.isIE6?n.write('<html><head><meta http-equiv="Content-type" content="text/html;charset=utf-8"><style type=\'text/css\'>html,body{width:100%;height:100%;max-height: 100%;overflow: auto;margin:0;padding:0;background-color:transparent;font-family: "Microsoft YaHei", "Helvetica Neue", Helvetica,"微软雅黑", Arial, sans-serif, STHeiti, FangSong;}</style></head><body contenteditable="true"></body></html>'):(n.open(),n.write('<html><head><meta http-equiv="Content-type" content="text/html;charset=utf-8"><style type=\'text/css\'>html,body{width:100%;height:100%;max-height: 100%;overflow: auto;margin:0;padding:0;background-color:transparent;font-family: "Microsoft YaHei", "Helvetica Neue", Helvetica,"微软雅黑", Arial, sans-serif, STHeiti, FangSong;}'+(1==view.windowType?"":" .img-emo{width:20px;height:20px;")+'}</style></head><body contenteditable="true"></body></html>'),n.close())}catch(e){}var s=n.getElementsByTagName("body")[0];s.style.cssText="margin:0;padding:0;word-break:break-all;white-space: pre-wrap;word-wrap: break-word;width:100%;line-height:1.2;overflow:auto;",a.win=i.contentWindow||document.frames.html_input,a.getPos=o,d(a.win,"focus",r),d(a.win,"blur",l),d(s,"focus",r),d(s,"blur",l),d(s,"select",o),d(s,"click",function(e){o(),view.hideMenus()}),d(s,"keydown",function(e){$("#inputPlaceholder").addClass("hide");var t=e||a.win.event;return view.enter(t)}),d(s,"drop",function(e){setTimeout(function(){a.getInput(!1)&&$("#inputPlaceholder").addClass("hide")},100),a.Browser.browser}),d(n,"paste",function(e){setTimeout(function(){a.getInput(!1)?$("#inputPlaceholder").addClass("hide"):$("#inputPlaceholder").removeClass("hide")},100)}),a.isMobile&&a.inputScrollToView(s),view.initHtmlEdit&&view.initHtmlEdit(a.win,n),a.isMobile||a.addPaste(a.win,n),setTimeout(function(){a.getInput(!1)?$("#inputPlaceholder").addClass("hide"):$("#inputPlaceholder").removeClass("hide")},100)}}function o(e){$("#inputPlaceholder").addClass("hide");var t=a.getInputDoc(),i=null;return t.selection?i=t.selection.createRange():a.win.getSelection&&a.win.getSelection().rangeCount&&(i=a.win.getSelection().getRangeAt(0)),i&&(a.win.pos=i)}function r(){o(),view.hideMenus(0)}function l(){o(),a.getInput(!1)||$("#inputPlaceholder").removeClass("hide")}function d(e,t,i){e.addEventListener?e.addEventListener(t,i):e.attachEvent("on"+t,i)}},this.preRange=null,this.changeToPreInput=function(){if(this.plainText){this.editorType=3,this.plainText=!1;var n=this;$("#textInput").hide();var e,s=$("#html_pre_input"),t=s.results[0];s.css("display","block"),n.isMobile&&n.inputScrollToView(n.getInputDocBody()),t.onkeyup=function(){clearTimeout(e),e=setTimeout(function(){i()},300)},t.onkeydown=function(e){$("#inputPlaceholder").addClass("hide");e||window.event;return view.enter(e)},t.ontouchend=function(e){setTimeout(function(){i(e)},50)},t.ontouchstart=function(e){$("#inputPlaceholder").addClass("hide")},t.onfocus=function(){$("#inputPlaceholder").addClass("hide"),i(),view.hideMenus(0)},t.onblur=function(){n.getInput(!1)||$("#inputPlaceholder").removeClass("hide")},t.onclick=function(){i(),view.hideMenus(0),t.focus()},n.getPos=i}function i(e){var t,i=s.results[0];if(window.getSelection){var a=window.getSelection();try{t=a.getRangeAt(0)}catch(e){(t=document.createRange()).selectNodeContents(i),t.collapse(!1),t.select()}}else t=document.selection.createRange();return n.preRange=t}},this.bindPlainTextEvent=function(){this.plainText=!0,this.editorType=1,$("#textInput").show();var e=_$("html_input");$(e).hide();var r=this;function a(e){var t,i=_$("textInput");if(window.getSelection){var a=window.getSelection();try{t=a.getRangeAt(0)}catch(e){(t=document.createRange()).selectNodeContents(i),t.collapse(!0)}}else t=document.selection.createRange();return r.textRange=t}$("#inputPlaceholder").addClass("hide"),r.isMobile,this.hasBindPlainTextEvent||(this.hasBindPlainTextEvent=!0,view.bindPlainTextEvent(),$("#textInput").off("keydown").on("keydown",function(e){e=e||window.event;if(r.handleInputLength&&setTimeout(r.handleInputLength,50),!1!==view.enter(e)){if(8==(e.keyCode||e.which||e.charCode||0)){var t=_$("textInput"),i=t.value;if(t.createTextRange)console.log("手机端IE?");else{var n=t.selectionStart,s=-1,o=0;0<n&&i.replace(/\[#([^#]+)#\]/g,function(e,t,i,a){return i<n&&i+e.length>=n&&(o=(s=i)+e.length),e}),-1!=s&&t.setSelectionRange(s,o)}}a()}}).on("change input",function(){r.handleInputLength&&r.handleInputLength(),a()}).on("paste",function(e){return r.filterPasteText(e,void 0,window,document)}).on("drop",function(e){r.handleInputLength&&setTimeout(function(){r.handleInputLength()})}).on("focus",a),setTimeout(function(){_$("textInput")&&_$("textInput").scrollIntoView()},400),r.textRange=null,r.getPos=a)},this.filterPasteText=function(e,t,i,a){var n=a.getElementById("textInput");if(void 0===t&&(t=i.clipboardData&&clipboardData.setData?i.clipboardData.getData("text"):(e.originalEvent||e).clipboardData.getData("text/plain")||prompt("在这里输入文本")),t){if(t=f.filterPasteData(t,void 0,!0),e.returnValue=!1,e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),t&&f.plainText)if(a.selection){var s=a.selection.createRange();s.text=t}else if("number"==typeof n.selectionStart&&"number"==typeof n.selectionEnd){var o=n.selectionStart,r=n.selectionEnd,l=o,d=n.value;n.value=d.substring(0,o)+t+d.substring(r,d.length),l+=t.length,n.selectionStart=n.selectionEnd=l}else n.value+=t;else if(t&&a.body.createTextRange){if(a.selection)textRange=a.selection.createRange();else if(i.getSelection){var c=(s=i.getSelection()).getRangeAt(0),u=a.createElement("span");u.innerHTML="&#FEFF;",c.deleteContents(),c.insertNode(u),textRange=a.body.createTextRange(),textRange.moveToElementText(u),u.parentNode.removeChild(u)}textRange.text=t,textRange.collapse(!1),textRange.select()}else t&&a.execCommand("insertText",!1,t);return!1}return!0},this.getInputDoc=function(){var e;return 2==this.editorType?(e=_$("html_input").contentDocument)||(e=document.frames.html_input.document):e=document,e},this.getInputDocBody=function(){var e,t,i=this.editorType;return 3==i?(t=_$("html_pre_input")).blur||(t.blur=function(){window.focus()}):t=2==i?((e=_$("html_input").contentDocument)||(e=document.frames.html_input.document),e.body||e.getElementsByTagName("body")[0]):_$("textInput"),t},this.focusInput=function(e){var t,i,a,n=this.editorType;return 3==n?t=_$("html_pre_input"):2==n?(t=_$("html_input").contentWindow||document.frames.html_input,(i=_$("html_input").contentDocument)||(i=document.frames.html_input.document),a=i.body||i.getElementsByTagName("body")[0],e||a.focus()):t=_$("textInput"),e||t.focus(),!e&&a&&a.focus(),t},this.insertImg=function(e){var t=this;if(t.plainText)return view.insertImg?view.insertImg(_$("textInput"),"[#"+t.emoLan[e]+"#]"):(_$("textInput").value+="[#"+t.emoLan[e]+"#]",_$("textInput").scrollTop=_$("textInput").scrollHeight),void(view.textInputChange&&view.textInputChange());var i="/res/emoji/24/"+e+".png",a=this.getInputDoc(),n=this.getInputDocBody(),s=t.win,o=this.editorType,r=s?s.pos:null;if(3==o&&(s=window,r=t.preRange),a.selection&&!/opera/gi.test(view.chat.Browser.browser)){var l='<img class="img-emo" src="'+i+'" border="0" code="'+e+'" unselectable="on"/>';if(r)s.focus(),setTimeout(function(){(r=s.pos||r).move("textedit"),r.pasteHTML(l),r.collapse(!0),r.select(),t.focusInput()},100);else(l=a.createElement("img")).className="img-emo",l.src=i,l.border="0",l.setAttribute("code",e),l.setAttribute("unselectable","on"),a.getElementsByTagName("body")[0].appendChild(l),n.appendChild(l)}else if(window.getSelection){var d;(l=a.createElement("img")).className="img-emo",l.src=i,l.border="0",l.setAttribute("code",e),l.setAttribute("unselectable","on"),r?((d=s.getSelection()).removeAllRanges(),r.deleteContents(),r.insertNode(l),r.setStartAfter(l),r.setEndAfter(l),this.isMobile||(d.removeAllRanges(),d.addRange(r))):n.appendChild(l),setTimeout(function(){n.scrollTop=l.offsetTop,t.focusInput()},100)}$("#inputPlaceholder").addClass("hide")},this.addPaste=function(s,e){var t,o=this;function r(){setTimeout(function(){for(var e=o.getInputDocBody().getElementsByTagName("img"),t=0;t<e.length;t++)e[t].getAttribute("code")||(e[t].parentNode?e[t].parentNode.removeChild(e[t]):e[t].removeNode&&e[t].removeNode(!0))},2)}function i(e){if(r(),!0===o.companyOff||o.busyCanSend&&"0"!=o.queryParams.autoChat||!0===o.chatting)if(e.clipboardData&&e.clipboardData.items){var t=e.clipboardData.items;if(t)for(var i=t.length-1;-1<i;i--)if(-1!==t[i].type.indexOf("image")){var a=t[i].getAsFile(),n=(new Date).getTime()+"."+t[i].type.split("/")[1];l(a,function(e){e&&(e.fileName=n,d(e))});break}}else setTimeout(c,1)}function l(t,i){if(i&&t&&-1<t.type.indexOf("image/")){var e=new FileReader;e.onload=function(e){i({file:t,base64:e.target.result})},e.readAsDataURL(t)}else i&&i(null)}function d(e){$("#pasteImg").attr("src",e.base64),$("#pastePreview").removeClass("hide"),$("#maskVerify").removeClass("hide")}function c(){for(var e,t=o.getInputDocBody().getElementsByTagName("img"),i=0;i<t.length;i++)if(!t[i].getAttribute("code")){e=t[i];break}function a(){for(var e=o.getInputDocBody().getElementsByTagName("img"),t=0;t<e.length;t++)e[t].src.match(/webkit-fake-url:/i)&&e[t].parentNode.removeChild(e[t])}if(e){var n=e.currentSrc||e.src;n.match(/data:image\/[\w]+;base64/i)?d({base64:n}):n.match(/blob/i)?console.log("blob******************src"):n.match(/webkit-fake-url:/)?(console.log("safari等浏览器 粘贴图片无法发送"),s.removeEventListener("paste",a),s.addEventListener("paste",a)):n.match(/^(http[s]?:\/\/[^\/]+|)\/.+/gi)&&(o.getInputDocBody().innerHTML+=lanRes.picture+":"+n),e.parentNode?e.parentNode.removeChild(e):e.removeNode&&e.removeNode(!0)}}o.filterPaste(s,e),this.hasPasteCapture=t=o.hasFormData,!window.ltIE10&&t&&"safari"!=view.chat.Browser.browser||setTimeout(function(){$("#inputPlaceholder").attr("placeholder",lanRes.inputPlaceholder2).html(lanRes.inputPlaceholder2)},500),t?(s.addEventListener?s.addEventListener("paste",i):s.attachEvent("onpaste",i),$("#pasteOK").on("click",function(){view.chat.publish("sendVisitorEvent",{et:123,uploadServiceType:o.uploadUtil.getUploadServiceType(),ssl:o.needHttps?1:void 0,ft:5},function(e){e.successful||(o.showTip(lanRes.networkFileError),$("#pasteError").removeClass("hide"),$("#pastePreview").removeClass("hide"),$("#maskVerify").removeClass("hide"))},{resend:!1}),o.captureFileSource=$("#pasteImg").attr("src").split("64,")[1],$("#pasteError").addClass("hide"),$("#pastePreview").addClass("hide"),$("#maskVerify").addClass("hide")}),$("#pasteCancel").on("click",function(){$("#pastePreview").addClass("hide"),$("#maskVerify").addClass("hide")})):e.addEventListener?e.addEventListener("paste",r):e.attachEvent("onpaste",r)},this.filterPaste=function(i,a){var c,u,f,m=this,h=-1!=navigator.appName.indexOf("Microsoft"),e=document.getElementById("html_input");function p(e){return e.getSelection?e.getSelection():e.document.selection}function g(e,t){e.removeAllRanges(),e.addRange(t)}function v(e){e.preventDefault()}function t(e){if(!m.plainText){var t=void 0;try{if(t=i.clipboardData&&i.clipboardData.getData?i.clipboardData.getData("Text"):e.clipboardData.getData("Text")||e.clipboardData.getData("text/plain"))return console.log("获取到了文本，就去按获取到的文本处理",t),m.filterPasteText(e,t,i,a)}catch(e){t=t&&m.filterPasteData(t)||""}return function(e,t){var i=t,a=_$("html_input"),n=a.contentWindow.document;{if(h){var s=n.selection.createRange();if(i)f=i;else{var o=document.getElementById("ifmTemp");o?o.contentWindow.document.body.innerHTML="":((o=document.createElement("IFRAME")).id="ifmTemp",o.style.width="1px",o.style.height="1px",o.style.position="absolute",o.style.border="none",o.style.left="-10000px",o.src="iframeblankpage.html",document.body.appendChild(o),o.contentWindow.document.designMode="On",o.contentWindow.document.open(),o.contentWindow.document.write("<body></body>"),o.contentWindow.document.close()),a.contentWindow.document.body.innerText,o.contentWindow.focus(),o.contentWindow.document.execCommand("Paste",!1,null),a.contentWindow.focus(),f="string"==typeof o.contentWindow.document.body.textContent?o.contentWindow.document.body.textContent:o.contentWindow.document.body.innerText,f=m.filterPasteData(f)}return s.pasteHTML(f),e&&(e.returnValue=!1,e.preventDefault&&e.preventDefault()),!1}if(i)return a.contentWindow.document.execCommand("inserthtml",!1,i),e&&(e.returnValue=!1,e.preventDefault&&e.preventDefault()),!1;var r=n.createElement("DIV");r.id="htmleditor_tempdiv",r.innerHTML="\ufeff",r.style.left="-10000px",r.style.height="1px",r.style.width="1px",r.style.position="absolute",r.style.overflow="hidden",n.body.appendChild(r),a.contentWindow.document.addEventListener("mousedown",v,!1),a.contentWindow.document.addEventListener("keydown",v,!1),enableKeyDown=!1,c=a.contentWindow,u=p(c).getRangeAt(0);var l=r.firstChild,d=n.createRange();return d.setStart(l,0),d.setEnd(l,1),g(p(c),d),"\ufeff"===("string"==typeof a.contentWindow.document.body.textContent?a.contentWindow.document.body.textContent:a.contentWindow.document.body.innerText)&&0,window.setTimeout(function(){if("\ufeff"===r.innerHTML)return f="",void n.body.removeChild(r);f="string"==typeof r.textContent?r.textContent:r.innerText,u&&g(p(c),u),f=m.filterPasteData(f),r.innerHTML=f,a.contentWindow.document.execCommand("inserthtml",!1,f),n.body.removeChild(r)},1),enableKeyDown=!0,a.contentWindow.document.removeEventListener("mousedown",v,!1),a.contentWindow.document.removeEventListener("keydown",v,!1),!0}}(e,t)}}e&&(h?(e.contentWindow.document.documentElement.attachEvent("onpaste",t),e.contentWindow.document.documentElement.attachEvent("ondrop",m.filterDrop)):(e.contentWindow.document.addEventListener("paste",t,!1),e.contentWindow.document.body.addEventListener("drop",m.filterDrop,!1)))},this.filterDrop=function(e){var t=(e=e||window.event).dataTransfer&&e.dataTransfer.getData("text");if(!t)return e.returnValue=!1,e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),!1;t=f.filterPasteData(t,void 0,f.plainText),f.isInrobot&&(t=t.substring(0,f.maxRobotLength));var i=f.getInputDoc(),a=f.getInputDocBody(),n=f.win,s=f.editorType,o=n?n.pos:null;if(3==s)n=window,o=f.preRange;else if(1==s)return void(o=f.textRange);if(i.selection&&!/opera/gi.test(view.chat.Browser.browser)){if(f.plainText?this.focus():n.focus(),!o)return e.dataTransfer.setData("text"),!0;setTimeout(function(){(o=(3==s?f.preRange:1==s?f.textRange:n.pos)||o).pasteHTML(t),o.collapse(!0),o.select()},1)}else if(window.getSelection){var r;if(o)if(1==s)_$("textInput").focus(),document.execCommand("insertText",!1,t);else{var l=i.createElement("div");l.innerHTML=t,(r=n.getSelection()).removeAllRanges(),o.deleteContents(),o.insertNode(l),o.setStartAfter(l),o.setEndAfter(l),f.isMobile||(r.removeAllRanges(),r.addRange(o))}else a.innerHTML+=t;l&&setTimeout(function(){a.scrollTop=l.offsetTop},100)}return e&&(e.returnValue=!1,e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()),!1}}!function(){var e=function(){function n(e,t,i){var a="0x"+t-65536;return a!=a||i?t:a<0?String.fromCharCode(65536+a):String.fromCharCode(a>>10|55296,1023&a|56320)}function s(){r()}var h,o,p,r,g=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,l=/^[^{]+\{\s*\[native \w/,d=/[\t\r\n\f]/g,t=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,c=/\S+/g,v={find:{},filter:{}},u=window.document,f=window.document,m="echatQuery"+ +new Date,b={},e=[],y=e.slice,w=e.push,I=new RegExp("\\\\([\\da-f]{1,6}"+i+"?|("+i+")|.)","ig"),i="[\\x20\\t\\r\\n\\f]";function T(e){return e._zid||(e._zid=z++)}var k={TAG:function(e){var t=e.replace(I,n).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=new RegExp("(^|"+i+")"+e+"("+i+"|$)");return function(e){return t.test("string"==typeof e.className&&e.className||void 0!==e.getAttribute&&e.getAttribute("class")||"")}}};function C(e){f.createElement;var t=f.createElement("div");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function S(e,t,i){var a=t&&t.ownerDocument;i=i||[];return e?e.nodeType||e==window.document||e==window?(this.context=e,this.results=[e],this.length=1,this):H(e)?void 0!==W?this.readyList.push(e):e():e instanceof S?e:((t?t.ownerDocument||t:u)!==f&&r(t),t=t||f,this.selector=e,this.context=t,this.results=function(e,t,i,a){if(!e)return i;var n,s,o,r,l,d=t?t.nodeType:9;if(r=g.exec(e),11!==d&&(r=g.exec(e)))if(n=r[1]){if(9===d){if(!(o=t.getElementById(n)))return i;if(o.id===n)return i.push(o),i}else if(t.ownerDocument&&(o=t.ownerDocument.getElementById(n))&&p(t,o)&&o.id===n)return i.push(o),i}else{if(n=r[2])return(u=v.find.TAG(n,t))&&w.apply(i,u),i;if((n=r[3])&&b.getElementsByClassName&&t.getElementsByClassName)return w.apply(i,t.getElementsByClassName(n)),i}1!==d&&(a=t,l=e);if(l)try{return w.apply(i,a.querySelectorAll(l)),i}catch(e){}var c,u=v.find.TAG("*",t),f=u.length;{if(s=0,c=r[2]){var m=[];if(i=t.getElementsByTagName(c),o=K,"*"!==c)return i;for(;o=i[s++];)1===o.nodeType&&m.push(o);return m}for(var h=(0,k.CLASS)(r[3]);s!==f&&null!=(o=u[s]);s++)o&&1===o.nodeType&&h(o)&&i.push(o)}return i}(e,t,i,a),void(this.length=this.results.length)):(this.length=0,this.results=this.results||i,this)}b.getElementsByTagName=C(function(e){return e.appendChild(f.createComment("")),!e.getElementsByTagName("*").length}),(r=function(e){var t,i,a=e?e.ownerDocument||e:u;return a===f||9!==a.nodeType||a.documentElement,o=(f=a).documentElement,(i=f.defaultView)&&i.top!==i&&(i.addEventListener?i.addEventListener("unload",s,!1):i.attachEvent&&i.attachEvent("onunload",s)),b.attributes=C(function(e){return e.className="i",!e.getAttribute("className")}),b.getElementsByTagName=C(function(e){return e.appendChild(f.createComment("")),!e.getElementsByTagName("*").length}),b.getElementsByClassName=l.test(a.getElementsByClassName),b.getById=C(function(e){return o.appendChild(e).id=m,!f.getElementsByName||!f.getElementsByName(m).length}),b.getById?(v.find.ID=function(e,t){if(void 0!==t.getElementById){var i=t.getElementById(e);return i?[i]:[]}},v.filter.ID=function(e){var t=e.replace(I,n);return function(e){return e.getAttribute("id")===t}}):(delete v.find.ID,v.filter.ID=function(e){var i=e.replace(I,n);return function(e){var t=void 0!==e.getAttributeNode&&e.getAttributeNode("id");return t&&t.value===i}}),b.qsa=l.test(a.querySelectorAll),v.find.TAG=b.getElementsByTagName?function(e,t){return void 0!==t.getElementsByTagName?t.getElementsByTagName(e):b.qsa?t.querySelectorAll(e):void 0}:function(e,t){for(var i,a=[],n=0,s=u.getElementsByTagName(e);i=s[n++];)1===i.nodeType&&p(t,i)&&a.push(i);return a},v.find.CLASS=b.getElementsByClassName&&function(e,t){if(void 0!==t.getElementsByClassName&&documentIsHTML)return t.getElementsByClassName(e)},t=l.test(o.compareDocumentPosition),p=t||l.test(o.contains)?function(e,t){if(!e||!t)return!1;var i=9===e.nodeType?e.documentElement:e,a=t&&t.parentNode;return e===a||!(!a||1!==a.nodeType||!(i.contains?i.contains(a):e.compareDocumentPosition&&16&e.compareDocumentPosition(a)))}:function(e,t){if(!e)return!1;if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},a})();var x=0,_=/(\=)\?(&|$)|\?\?/i;(h=function(e,t,i){return new S(e,t)}).ajaxJSONP=function(i,a){if(!("type"in i))return h.ajax(i);var n,e=window.document,t=i.jsonpCallback,s=(H(t)?t():t)||"jsonp"+ ++x,o=e.createElement("script"),r=window[s],l={abort:function(e){h(script).triggerHandler("error",e||"abort")}};a&&a.promise(l);e.getElementsByTagName("head")[0];function d(e,t){h(o).remove(),e&&"error"==e.type||!n?i.error&&i.error(null,t||"error",l,i,a):i.success&&i.success(n[0],l,i,a),window[s]=r,n&&H(r)&&r(n[0]),r=n=K}window[s]=function(){n=arguments};var c="$1"+s+"$2";i.url=i.url.replace(_,c);var u="";if(i.data){for(var f in i.data){var m="string"==typeof i.data[f]?i.data[f]:JSON.stringify(i.data[f]);u="&"+f+"="+encodeURIComponent(m)}u&&(u=u.substring(1),u+="&")}return i.url+=(/\?/.test(i.url)?"&":"?")+u+(i.jsonpCB||"jsonp")+"="+s,"onload"in o?(o.onload=d,o.onerror=function(){d({type:"error"})}):o.onreadystatechange=function(){/loaded|complete/.test(o.readyState)&&d()},i.beforeSend&&!1===i.beforeSend(l)?console.log("abort",i):(o.src=i.url,e.getElementsByTagName("head")[0].appendChild(o)),l},h.ajax=function(e){if("jsonp"==e.jsonp||"JSONP"==e.jsonp||"jsonp"==e.type||"JSONP"==e.type)return h.ajaxJSONP(e,e.deferred);var t=function(){var t;try{t=new XMLHttpRequest}catch(e){for(var i=["Msxml3.XMLHTTP","Msxml2.XMLHTTP","Microsoft.XMLHTTP"],a=0,n=i.length;a<n;a++)try{t=new ActiveXObject(i[a]);break}catch(e){continue}}return t}();if(t.onreadystatechange=function(){4==t.readyState&&(200==t.status?e.success&&e.success(t.responseText):e.error(t,t.responseText))},t.open(e.type,e.url,!0),e.header)for(var i in e.header)t.setRequestHeader(i,e.header[i]);e.header&&(e.header["Content-Type"]||e.header["Content-type"]||e.header["content-type"])&&!1===e.contentType||t.setRequestHeader("Content-type",e.contentType||"application/json;charset=UTF-8;"),e.beforeSend&&e.beforeSend(t);var a=e.data,n="";if(a&&"[object object]"==Object.prototype.toString.apply(a).toLowerCase())for(var s in a)n+="&"+s+"="+encodeURIComponent(a[s]);a=window.XMLHttpRequest?a||null:a||K,t.send(n?n.substring(1):a)};var E,a,M,N,R=/^-ms-/,D=/-([\da-z])/gi,L=function(e){return e.replace(R,"ms-").replace(D,function(e,t){return t.toUpperCase()})};(a=f.createElement("div")).innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",M=(M=(N=a.getElementsByTagName("a")[0])&&N.style).cssText="float:left;opacity:.5",E={float:M.cssFloat?"cssFloat":"styleFloat"},N=a=null;function P(e){return"string"==typeof e}var H=function(e){return null!=e&&("function"==typeof e||"[object Function]"===Object.prototype.toString.call(e))},B=function(e){return"[object Array]"===Object.prototype.toString.apply(e)},A={},F=A.toString;function $(e){return"object"==(null==(t=e)?String(t):A[F.call(t)]||"object");var t}function U(e){return null==e?"":(e+"").replace(t,"")}var O=function(e){return $(e)&&!(null!=(t=e)&&t==t.window)&&Object.getPrototypeOf(e)==Object.prototype;var t};function q(e,t,i){for(var a in t)i&&(O(t[a])||B(t[a]))?(O(t[a])&&!O(e[a])&&(e[a]={}),B(t[a])&&!B(e[a])&&(e[a]=[]),q(e[a],t[a],i)):t[a]!==K&&(e[a]=t[a])}h.extend=function(e,t,i){for(var a in t)i&&(O(t[a])||B(t[a]))?(O(t[a])&&!O(e[a])&&(e[a]={}),B(t[a])&&!B(e[a])&&(e[a]=[]),q(e[a],t[a],i)):t[a]!==K&&(e[a]=t[a]);return e},h.cookie=function(e,t,i){if(1<arguments.length&&(!/Object/.test(Object.prototype.toString.call(t))||null===t||t===K)){if(i=h.extend({},i),null!==t&&t!==K||(i.expires=-1),"number"==typeof i.expires){var a=i.expires,n=i.expires=new Date;n.setDate(n.getDate()+a)}return t=String(t),f.cookie=[encodeURIComponent(e),"=",i.raw?t:encodeURIComponent(t),i.expires?"; expires="+i.expires.toUTCString():"","; path="+(i.path||"/"),i.domain?"; domain="+i.domain:"",i.secure?"; secure":""].join("")}for(var s,o=(i=t||{}).raw?function(e){return e}:decodeURIComponent,r=f.cookie.split("; "),l=0;s=r[l]&&r[l].split("=");l++)if(o(s[0])===e)return o(s[1]||"");return null},h.toJSON=JSON.stringify;var V={src:!0,href:!0},j={isFunction:H,isArray:B,isString:P,isObject:$,isPlainObject:O,trim:U,contains:p,readyList:[],find:function(i){var a={};return this.each(function(e,t){S.call(a,i,t,a.results)}),a},match:function(i,e){var t=new S(e),a=null;return t.each(function(e,t){if(t==i||p(t,i))return a=t,!0}),a},parents:function(e){var t,i,a,n,s;if(e&&this.results&&0<this.results.length&&(t=g.exec(e))&&((s=t[1])?i=function(e){return e.id==s}:(s=t[2])?(s=s.toUpperCase(),i=function(e){return e.tagName==s}):(s=t[3])&&(i=function(e){if(e.className){for(var t=e.className.split(" "),i=0;i<t.length;i++)if(t[i]==s)return!0;return!1}}),i))for(a=this.results[0];n=a.parentNode;){if(i(n))return new S(n,this.context,[]);a=n}return new S(null,this.context,[])},html:function(i){return i||""===i?this.each(function(e,t){t.innerHTML=i}):this.results&&this.results[0]?this.results[0].innerHTML:null},text:function(i){return"string"==typeof i?this.each(function(e,t){"string"==typeof t.textContent?t.textContent=i:t.innerText=i}):this.results&&this.results[0]?this.results[0].textContent||this.results[0].innerText:null},append:function(i){if(i){if(P(i)){var e=f.createElement("div");e.innerHTML=i;var a=e.childNodes;this.each(function(e,t){var i;for(e=0;i=a[e++];)1==i.nodeType&&(i=i.cloneNode(!0),t.appendChild(i))})}else this.each(function(e,t){t.appendChild(i)});return this}},insertBefore:function(i,a){if(i){var n;if(P(i)){var e=f.createElement("div");e.innerHTML=i;var s=e.childNodes;this.each(function(e,t){var i;for(e=0;i=s[e++];)1==i.nodeType&&(i=i.cloneNode(!0),(n=a||t.childNodes[0])?t.insertBefore(i,n):t.appendChild(i))})}else this.each(function(e,t){(n=a||t.childNodes[0])?t.insertBefore(i,n):t.appendChild(i)});return this}},show:function(){return this.each(function(e,t){t.style.display="block"}),this},hide:function(){return this.each(function(e,t){t.style.display="none"}),this},removeClass:function(e){for(var t,i,a,n,s=this.results.length,o=0,r=0,l=(e||"").match(c)||[];r<s;r++)if(i=1===(t=this.results[r]).nodeType&&(t.className?(" "+t.className+" ").replace(d," "):"")){for(o=0;a=l[o++];)for(;0<=i.indexOf(" "+a+" ");)i=i.replace(" "+a+" "," ");n=e?U(i):"",t.className!==n&&(t.className=n)}else t.className="";return this},addClass:function(e){for(var t,i,a,n,s=this.results.length,o=0,r=0,l=(e||"").match(c)||[];r<s;r++)if(i=1===(t=this.results[r]).nodeType&&(t.className?(" "+t.className+" ").replace(d," "):"")){for(o=0;a=l[o++];)for(;i.indexOf(" "+a+" ")<0;)i+=a+" ";n=e?U(i):"",t.className!==n&&(t.className=n)}else t.className=e;return this},attr:function(e,t){if(!e)return this;if(void 0===t){if("string"==typeof e)return this.results&&0<this.results.length?this.getAttr(this.results[0],e):"";var i=this.results?this.results.length:0;for(var a in e)for(var n=0;n<i;n++){var s=this.results[n];V[a]?s[a]=e[a]:s.setAttribute(a+"",e[a])}}else for(i=this.results?this.results.length:0,n=0;n<i;n++){(s=this.results[n]).setAttribute(e,t),V[e]?s[e]=t:s.setAttribute(e,t)}return this},css:function(e,t){if(!e)return this;if(void 0===t)if("string"==typeof e)this.css(e,0===t?"0":"inherit");else for(var i=this.results?this.results.length:0,a=0;a<i;a++)for(var n in e){var s=L(n);s=E[s]||s;var o=this.results[a];try{o.style[s]=e[n]}catch(e){console.log(e.message),console.log("css:"+s+":"+n)}}else try{for(i=this.results?this.results.length:0,a=0;a<i;a++){s=L(e);s=E[s]||s,(o=this.results[a]).style[s]=t}}catch(e){return this}return this},remove:function(){for(var e=this.results?this.results.length:0,t=0;t<e;t++){var i=this.results[t];i.parentNode.removeChild(i)}return this.length=0,this.results=[],this},removeAttr:function(i){return this.each(function(e,t){t.setAttribute(i,""),t.removeAttribute(i)})},ready:function(e){for(var t,i=0;this.readyList&&(t=this.readyList[i]);)t.call(window),i++;return this},hasClass:function(e){for(var t=this.results?this.results.length:0,i=[],a=k.CLASS(e),n=0;n<t;n++){var s=this.results[n];a(s)&&i.push(s)}return i.length},max:function(e,t){return t<e?e:t},width:function(){return this.results&&this.results[0]?j.max(this.results[0].offsetWidth,this.results[0].clientWidth):null},height:function(){return this.results&&this.results[0]?j.max(this.results[0].offsetHeight,this.results[0].clientHeight):null},val:function(e){return void 0===e?this.results&&this.results[0]?this.results[0].value:null:(this.results&&this.results[0]&&(this.results[0].value=e+""),this)},getAttr:function(e,t){return e.getAttribute(t)},each:function(e,t){if(B(e))for(var i=0;i<e.length&&!t.call(e[i],i,e[i]);i++);else if(H(e)){t=e,e=this.results||[];for(i=0;i<e.length&&!t.call(e[i],i,e[i]);i++);}else for(var i in e)if(t.call(e[i],i,e[i]))break;return this}},W=function(){var e=function(){W&&(j.ready(),W=K)},t=window.document;function i(){t.removeEventListener("DOMContentLoaded",i,!1),t.removeEventListener("load",i,!1),e()}function a(){"complete"==t.readyState&&(t.detachEvent("onreadystatechange",a),t.detachEvent("onload",n),e())}function n(){t.detachEvent("onreadystatechange",a),t.detachEvent("onload",n),e()}if(t.addEventListener)t.addEventListener("DOMContentLoaded",i,!1),window.addEventListener("load",i,!1);else if(t.attachEvent)t.attachEvent("onreadystatechange",a),window.attachEvent("onload",n);else if(t.lastChild==t.body)return e();0<(t.getElementsByTagName("body")||[]).length&&e()};W(),h.fn=j,h.each=j.each;var K,z=1,J=(y=Array.prototype.slice,{}),Q={},Y="onfocusin"in window,X={focus:"focusin",blur:"focusout"},G={mouseenter:"mouseover",mouseleave:"mouseout"};function T(e){return e._zid||(e._zid=z++)}function Z(e,t,i,a){if((t=ee(t)).ns)var n=(s=t.ns,new RegExp("(?:^| )"+s.replace(" "," .* ?")+"(?: |$)"));var s,o=J[T(e)]||[];for(var r,l=[],d=0;d<o.length;d++)!(r=o[d])||t.e&&r.e!=t.e||t.ns&&!n.test(r.ns)||i&&T(r.fn)!==T(i)||a&&r.sel!=a||l.push(o[d]);return l}function ee(e){var t=(""+e).split(".");return{e:t[0],ns:t.slice(1).sort().join(" ")}}function te(e,t){return e.del&&!Y&&e.e in X||!!t}function ie(e){return G[e]||Y&&X[e]||e}function ae(n,e,s,o,r,l,d){var t=T(n),c=J[t]||(J[t]=[]);h.fn.each(e.split(/\s/),function(e,t){if("ready"==t)return h(f).ready(s);var i=ee(t);i.fn=s,i.sel=r,i.e in G&&(s=function(e){var t=e.relatedTarget;if(!t||t!==this&&!h.contains(this,t))return i.fn.apply(this,arguments)});var a=(i.del=l)||s;i.proxy=function(e){if(!(e=de(e)).isImmediatePropagationStopped()){e.data=o;var t=a.apply(n,e._args==K?[e]:[e].concat(e._args));return!1===t&&(e.preventDefault(),e.stopPropagation()),t}},i.i=c.length,c.push(i),"addEventListener"in n?n.addEventListener(ie(i.e),i.proxy,te(i,d)):n.attachEvent("on"+ie(i.e),i.proxy)})}function ne(i,e,a,n,s){var o=T(i);h.fn.each((e||"").split(/\s/),function(e,t){h.fn.each(Z(i,t,a,n),function(e,t){delete J[o][t.i],"removeEventListener"in i?i.removeEventListener(ie(t.e),t.proxy,te(t,s)):i.detachEvent("on"+ie(t.e),t.proxy)})})}Q.click=Q.mousedown=Q.mouseup=Q.mousemove="MouseEvents",h.event={add:ae,remove:ne},h.proxy=function(e,t){var i=2 in arguments&&y.call(arguments,2);if(H(e)){function a(){return e.apply(t,i?i.concat(y.call(arguments)):arguments)}return a._zid=T(e),a}if(P(t))return i?(i.unshift(e[t],e),h.proxy.apply(null,i)):h.proxy(e[t],e);throw new TypeError("expected function")},h.fn.bind=function(e,t,i){return this.on(e,t,i)},h.fn.unbind=function(e,t){return this.off(e,t)},h.fn.one=function(e,t,i,a){return this.on(e,t,i,a,1)};var se=function(){return!0},oe=function(){return!1},re=/^([A-Z]|returnValue$|layer[XY]$)/,le={preventDefault:"isDefaultPrevented",stopImmediatePropagation:"isImmediatePropagationStopped",stopPropagation:"isPropagationStopped"};function de(a,n){return!n&&a.isDefaultPrevented||(n=n||a,h.each(le,function(e,t){var i=n[e];a[e]=function(){return this[t]=se,i&&i.apply(n,arguments)},a[t]=oe}),(n.defaultPrevented!==K?n.defaultPrevented:"returnValue"in n?!1===n.returnValue:n.getPreventDefault&&n.getPreventDefault())&&(a.isDefaultPrevented=se)),a}function ce(e){var t,i={originalEvent:e};for(t in e)re.test(t)||e[t]===K||(i[t]=e[t]);return de(i,e)}function ue(){}h.fn.delegate=function(e,t,i){return this.on(t,e,i)},h.fn.undelegate=function(e,t,i){return this.off(t,e,i)},h.fn.live=function(e,t){return h(f.getElementsByTagName("body")[0]).delegate(this.selector,e,t),this},h.fn.die=function(e,t){return h(f.getElementsByTagName("body")[0]).undelegate(this.selector,e,t),this},h.fn.on=function(t,s,i,o,a){var r,l,n=this;return t&&!P(t)?(h.each(t,function(e,t){n.on(e,s,i,t,a)}),n):(P(s)||H(o)||!1===o||(o=i,i=s,s=K),o!==K&&!1!==i||(o=i,i=K),!1===o&&(o=oe),n.each(function(e,n){a&&(r=function(e){return ne(n,e.type,o),o.apply(this,arguments)}),s&&(l=function(e){var t,i=(e=e||window.event).target||e.srcElement,a=j.match(i,s);if(a&&a!==n)return t=h.extend(ce(e),{currentTarget:a,liveFired:n}),(r||o).apply(a,[t].concat(y.call(arguments,1)))}),ae(n,t,o,i,s,l||r)}))},h.fn.off=function(e,i,t){var a=this;return e&&!P(e)?(h.each(e,function(e,t){a.off(e,i,t)}),a):(P(i)||H(t)||!1===t||(t=i,i=K),!1===t&&(t=oe),a.each(function(){ne(this,e,t,i)}))},h.fn.trigger=function(e,t){return(e=P(e)||O(e)?h.Event(e):de(e))._args=t,this.each(function(){e.type in X&&"function"==typeof this[e.type]?this[e.type]():"dispatchEvent"in this?this.dispatchEvent(e):h(this).triggerHandler(e,t)})},h.fn.triggerHandler=function(i,a){var n,s;return this.each(function(e,t){(n=ce(P(i)?h.Event(i):i))._args=a,n.target=t,h.each(Z(t,i.type||i),function(e,t){if(s=t.proxy(n),n.isImmediatePropagationStopped())return!1})}),s},h.fn.each("focusin focusout focus blur load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select keydown keypress keyup error".split(" "),function(e,t){h.fn[t]=function(e){return 0 in arguments?this.bind(t,e):this.trigger(t)}}),h.Event=function(e,t){P(e)||(e=(t=e).type);var i=f.createEvent(Q[e]||"Events"),a=!0;if(t)for(var n in t)"bubbles"==n?a=!!t[n]:i[n]=t[n];return i.initEvent(e,a,!0),de(i)},h.fn.autoHeight=function(){this.each(function(){h(this).on("keyup",function(){var e;(e=this).style.height="auto",e.style.height=e.scrollHeight+"px"})})},h.isBoolean=ue,h.isDate=ue,h.isFunction=ue,h.isNaN=ue,h.isNumber=ue,h.isObject=ue,h.isRegExp=ue,h.isString=ue,h.isUndefined=ue;for(var fe=h,me="Array Boolean Date NaN Number Function Object RegExp Undefined".split(" "),he=0;he<me.length;he++){var pe=me[he];fe["is"+pe]=function(t){return function(e){return e!=e?"NaN"===t:RegExp(t).test(Object.prototype.toString.call(e))}}(pe)}return S.prototype=h.fn,h}();window.EChatQuery=e}(),function($){void 0===window.ECHATObjKeyMap&&(window.ECHATObjKeyMap={});var UTIL=function(justBase){this.ECHATConfig={contextPath:"/mychat/visitor"};var _self=this,Ji,Ki,cj;if(this.bot=/spider|bot/i.test(navigator.userAgent),this.subMap={},this.eventMap={},this.setSub=function(e){this.subMap[e]=e},this.removeSub=function(e){delete this.subMap["string"==typeof e?e:e.KEY]},this.publish=function(e){var t=this.subMap;for(var i in t){var a=ECHATObjKeyMap[i];if(a&&a.eventMap&&a.eventMap[e]){var n=a.eventMap[e];if(this.isArray(n))for(var s=0;s<n.length;s++)n[s].apply(a,arguments)}}},this.subscribe=function(e,t){this.eventMap[e]?this.eventMap[e].push(t):this.eventMap[e]=[t]},this.unSubscribeAll=function(){this.eventMap={}},this.unSubscribe=function(e){if(this.isArray(e))for(var t=0;t<e.length;t++)delete this.eventMap[e[t]];else delete this.eventMap[e]},this.isArray=function(e){return"[object Array]"===Object.prototype.toString.apply(e)},this.getQueryString=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),i=location.search.substr(1).match(t);if(null!=i)return decodeURIComponent(i[2])},this.escapeRegExp=(Ji=/[\\^$.*+?()[\]{}|]/g,Ki=new RegExp(Ji.source),function(e){return e&&Ki.test(e)?e.replace(Ji,"\\$&"):e}),this.getQueryParams=function(e){var t={};"string"!=typeof e&&(e=location.search),-1!=e.indexOf("#")&&(e=e.substring(0,e.indexOf("#"))),-1!=e.indexOf("?")&&(e=e.substring(e.indexOf("?")+1));for(var i,a=e.split("&"),n=a.length,s=0;s<n;s++)a[s]&&(i=a[s].split("="))[0]&&i[1]&&(t[i[0]]=decodeURIComponent(i[1]),t[i[0].toLowerCase()]=t[i[0]]);if(t.visEvt)try{var o=JSON.parse(t.visEvt);o&&o.eventId&&(t.eventId=o.eventId,t.eventid=o.eventId)}catch(e){t.visEvt=void 0,delete t.visEvt}return t},this.queryParams=this.getQueryParams(),this.companyId=this.getQueryString("companyid"),this.getBackground=function(e,t){var i=[],a=parseInt(t||100)/100,n=(e||"rgb(255,255,255)").toLocaleLowerCase().trim();if(0==n.indexOf("rgb"))n=n.replace("rgb","rgba").replace(")",","+a+")");else if(0==n.indexOf("#")){n=n.replace("#","").split("");for(var s=0;s<n.length;s++)3==n.length?i.push(parseInt("0x"+n[s]+n[s])):s%2==0&&i.push(parseInt("0x"+n[s]+n[s+1]));i.push(a),n="rgba("+i.join()+")"}return n},this.hasStorage=function(){var e;try{if(!window.localStorage)return!1;if(window.localStorage.setItem("echt_test_storage","ok"),!(e=window.localStorage.getItem("echt_test_storage")))return!1}catch(e){return!1}return e&&window.localStorage.removeItem("echt_test_storage"),!0}(),this.hasCookie=($.cookie("echt_test_cookie","ok"),!!$.cookie("echt_test_cookie")&&($.cookie("echt_test_cookie",null),!0)),$.store=(cj=this.hasStorage,cj?function(e,t,i){return e?1<arguments.length&&(!/Object/.test(Object.prototype.toString.call(t))||null==t)?(i=$.extend({},i),null==t&&(i.expires=-1),t=String(t),i.session?window.sessionStorage.setItem(e,t):window.localStorage.setItem(e,t),t):(i=t||{}).local?window.localStorage.getItem(e):i.session?window.sessionStorage.getItem(e):window.localStorage.getItem(e)||window.sessionStorage.getItem(e)||$.cookie(e):null}:$.cookie),!justBase){this.getDeviceInfo=function(){_self.deviceInfo=F;var b=_self,f=b.indexOf=(gj=Array.prototype.indexOf,"function"==typeof gj&&/\[native code\]/.test(gj.toString())||(gj=function(e){if(null==this)throw new TypeError;var t=Object(this),i=t.length>>>0;if(0==i)return-1;var a=0;if(0<arguments.length&&((a=Number(arguments[1]))!=a?a=0:0!=a&&a!=1/0&&a!=-1/0&&(a=(0<a||-1)*Math.floor(Math.abs(a)))),i<=a)return-1;for(var n=0<=a?a:Math.max(i-Math.abs(a),0);n<i;n++)if(n in t&&t[n]===e)return n;return-1}),function(e,t,i){return gj.call(t,e,i)}),gj,h=b.isFunction=function(e){return"function"==typeof e},i=b.isString=function(e){return"string"==typeof e},q=b.Browser=function(){var x=navigator,y=x.userAgent.toLowerCase(),osVersion=0,z=+(/trident.*rv:? *([0-9]+)/.exec(y)||[])[1]||!1,A=$s(),zz=/edge/.exec(y)||!A&&!!window.StyleMedia||!1,B=8==A,C=7==A,D=6==A,E=window.opera&&"[object Opera]"==Object.prototype.toString.call(window.opera)||/webkit/.test(y)&&(/opr/.test(y)||/opera/.test(y)),F="Google Inc."==navigator.vendor,G="Apple Computer, Inc."==navigator.vendor,H=!A&&(F||G||/webkit|khtml/.test(y)),I=+/\d+/.exec(/firefox\/\d+/i.exec(navigator.userAgent)||""),J=-1<y.indexOf("firefox/2"),K=-1<y.indexOf("firefox/3"),L=-1!=y.indexOf("iphone"),M=-1!=y.indexOf("ipod"),N=-1!=y.indexOf("ipad"),O=L||N||M,Q=-1!=y.indexOf("wp7"),kgBrowser=-1!=y.indexOf("kgbrowser"),meizu=-1!=y.indexOf("mzbrowser"),P=meizu||-1!=y.indexOf("android"),R=O||P||Q||kgBrowser||meizu,S,uc=-1!=y.indexOf("ucbrowser"),liebao=-1!=y.indexOf("lbbroser")||-1<y.indexOf("liebao"),qq=-1!=y.indexOf("qqbrowser"),sogou=-1!=y.indexOf("metasr")||-1!=y.indexOf("sogou"),f360=y.match(/360|qhbrowser|qihoobrowser/i),maxth=-1!=y.indexOf("maxthon"),baidu=-1!=y.indexOf("bidubrowser")||-1!=y.indexOf("baidubrowser")||-1!=y.indexOf("baidu"),weixin=-1!=y.indexOf("micromessenger"),chromeIphone=L&&-1!=y.indexOf("crios"),T=(A?"msie":I&&"firefox")||E&&"opera"||uc&&"uc"||liebao&&"liebao"||qq&&"qq"||zz&&"edge"||sogou&&"sogou"||f360&&"360"||maxth&&"maxth"||baidu&&"baidu"||weixin&&"weixin"||chromeIphone&&"chrome"||G&&"safari"||F&&"chrome"||H&&"chrome",U,V=A&&!W,W="CSS1Compat"==document.compatMode,X=!W,Y=A&&X&&document.documentElement&&!!document.documentElement.style.setExpression,Z=document.documentMode||A,$$=-1!=y.indexOf("windows")||-1!=y.indexOf("win32"),$_=-1!=y.indexOf("macintosh")||-1!=y.indexOf("mac os x")||-1!=window.navigator.platform.indexOf("Mac"),$a="https:"==document.location.protocol,$b=x.language||x.browserLanguage||x.userLanguage||x.systemLanguage,$c={noBoxSizing:Z<=7,ie:{cssBottomRight:D,cssFixed:D||Y,buggyCSS:D||Y}},$d="textContent"in document.createElement("div"),$e=!1;try{window.CustomEvent&&/\[native code\]/.test(window.CustomEvent.toString())&&(new window.CustomEvent("testevent",{bubbles:!1,cancelable:!0,detail:!0}),$e=!0)}catch(e){}switch(T){case"opera":U=+/\d+/.exec(new RegExp("opr[ /]\\d+").exec(y)||"");break;case"msie":case"firefox":case"chrome":U=U||+/\d+/.exec(new RegExp(T+"[ /]\\d+").exec(y)||"");break;case"baidu":U=+/\d+/.exec(new RegExp("bidubrowser[ /]\\d+").exec(y)||"");break;case"maxth":U=+/\d+/.exec(new RegExp("maxthon[ /]\\d+").exec(y)||"");break;case"qq":U=+/\d+/.exec(new RegExp("qqbrowser[ /]\\d+").exec(y)||"");break;case"liebao":U=+/\d+/.exec(new RegExp("lbbroser[ /]\\d+").exec(y)||"");break;case"uc":U=+/\d+/.exec(new RegExp("ucbrowser[ /]\\d+").exec(y)||"");break;case"sogou":U=+/\d+/.exec(new RegExp("metasr[ /]\\d+").exec(y)||"");break;default:U=+/\d+/.exec(/version[ \/]\d+/.exec(y)||"")}function $f(e){return e.replace(/^http:/,$a?"https:":"http:")}function $g(){return window.innerHeight!==a?window.innerHeight:document.documentElement?document.documentElement.offsetHeight:document.getElementsByTagName("body").length?document.getElementsByTagName("body")[0].clientHeight:0}function $h(){return window.innerWidth!==a?window.innerWidth:document.documentElement?document.documentElement.offsetWidth:document.getElementsByTagName("body").length?document.getElementsByTagName("body")[0].clientWidth:0}if(O&&(osVersion=+/\d+/.exec(new RegExp("iphone os \\d+").exec(y)||"")),D){var $i=[];$c.leaksMemory=function(e){p.isFunction(e),$i.push(e)};var $j=function(){for(var e=0;e<$i.length;e++)$i[e]()};$c.leaksMemory.remove=function(e){for(var t=$i.length-1;0<=t;t--)e==$i[t]&&$i.splice(t,1)},window.attachEvent("onunload",$j)}var $k="Shockwave Flash",$l="ShockwaveFlash.ShockwaveFlash",$m="application/x-shockwave-flash",$n="application/x-java-vm";function $o(){var e,t=x.plugins&&x.plugins[$k];if(t)return(e=x.mimeTypes&&x.mimeTypes[$m])&&!e.enabledPlugin?null:t.description;if(window.ActiveXObject)try{return(t=new window.ActiveXObject($l)).AllowScriptAccess="always",t.GetVariable("$version")}catch(e){}}function $p(){var e=x.mimeTypes;return A?!Q&&("javaEnabled"in x&&x.javaEnabled()):(e=e&&e[$n])&&(e=e.enabledPlugin)?e.name:void 0}function $q(){if(!k(S))return S;var e=document.createElement("div"),t=document.createElement("div"),i=e.style,a=t.style;return i.overflow="auto",i.width=i.height="100px",i.position="absolute",i.top="-1000px",a.width="100%",a.height="200px",e.appendChild(t),document.body.appendChild(e),S=e.offsetWidth-e.clientWidth,document.body.removeChild(e),S}function $r(){try{return eval("false")}catch(e){return!0}}function $s(){for(var e=3,t=document.createElement("div"),i=t.getElementsByTagName("i");t.innerHTML="\x3c!--[if gt IE "+ ++e+"]><i></i><![endif]--\x3e",i[0];);return 4<e?e:document.documentMode}var $t={browser:T,version:U,osVersion:osVersion,isStrict:W,isQuirks:X,isOpera:E,isSafari:G,isWebKit:H,isChrome:!E&&F,isAndroid:P,isIPhone:L,isIPod:M,isIPad:N,isIOS:O,isWP7:Q,isMobile:R,isEdge:zz,isNewIE:z,isIE:A,isIE6:D,isIE7:C,isIE8:B,isFF:I,isFF2:J,isFF3:K,isBorderBox:V,isCustomEvents:$e,engineIE:Z,bugs:$c,isWindows:$$,isXP:/windows nt 5.1/.test(y),isMac:$_,isLinux:/Linux/.test(navigator.platform),isSecure:$a,secureURL:$f,hasFlash:$o(),hasJava:$p(),language:$b,getScrollbarSize:$q,getWindowClientHeight:$g,getWindowClientWidth:$h,isTextContent:$d,hasCSP:$r()};return $t.isPC=!$t.isMobile&&($t.isWindows||$t.isMac||$t.isEdge||$t.isLinux),$t}(),x=b.__$$__jx_ui_HTMLElement,y=/google inc\./i,z=/chrome/i,A=/apple computer, inc\./i,B=/crios/i,C=window.navigator.userAgent||"",D=window.navigator.vendor||"",F={checkLandscape:L,getZoomLevel:Y,getOffset:Z},E=G();function G(){var e=C||D||window.opera;return/mobile|kgbrowser|(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino|android|ipad|playbook|silk/i.test(e)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4))}function L(){return window.document.documentElement.clientWidth>window.document.documentElement.clientHeight}function R(){return E&&/(iemobile|windows phone)/i.test(C)}function T(){return E&&y.test(D)&&(!z.test(C)||/samsung/i.test(C))}function Y(){var e=window.document.documentElement.clientWidth,t=1.2<e/window.document.documentElement.clientHeight,i=window.screen.width,a=window.screen.height;t&&i<a&&(i=window.screen.height,a=window.screen.width);var n=window.innerWidth,s=e/i;window.devicePixelRatio&&T()&&640<i?s*=window.devicePixelRatio:R()&&(s*=1.5);var o=e/n/s;return o=(o/1.2).toFixed(2),(i/n).toFixed(2)}function Z(){var e=window,t=e.document.documentElement,i=e.document.body,a=null,n={top:0,left:0};if(h(t.getBoundingClientRect)&&(h(e.getComputedStyle)?"relative"==e.getComputedStyle(i).position?a=i:"relative"==e.getComputedStyle(t).position&&(a=t):i.currentStyle?"relative"==i.currentStyle.position?a=i:"relative"==t.currentStyle.position&&(a=t):"relative"==i.style.position?a=i:"relative"==t.style.position&&(a=t)),a){var s=a.getBoundingClientRect();n.top=s.top+e.pageYOffset-t.clientTop,n.left=s.left+e.pageXOffset-t.clientLeft}return n}_self.Device=F}();var isMobilePage=window.mobilePage||-1!=location.href.split("?")[0].indexOf("/visitor/mobile/")&&!ECHATObjKeyMap.outerId;_self.Browser.isMobile||isMobilePage||!_self.Browser.isPC?_self.Device.media=2:_self.Device.media=1,_self.Device.OS=(this.Browser.isWindows?"Windows":this.Browser.isIPhone&&"iPhone")||this.Browser.isIPad&&"IPAD"||this.Browser.isIPod&&"IPOD"||this.Browser.isMac&&"OSX"||this.Browser.isAndroid&&"Android"||this.Device.isWP&&"Windows Phone"||this.Browser.isLinux&&"Linux"||"others",this.hasTranslate=this.Browser.isMobile,this.setTransform=function(e,t){var i="translate("+e+"px,"+t+"px)";_self.hasTranslate?$(this).css({"-webkit-transform":i,"-o-transfrom":i,"-ms-transform":i,"-moz-transform":i,transform:i}):$(this).css({left:e+"px",top:t+"px"})},this.setScale=function(e){var t=this;(1/_self.deviceInfo.getZoomLevel()).toFixed(2),window.pageXOffset,window.pageYOffset,window.innerWidth,window.innerHeight,t[0].clientWidth,t[0].clientHeight};var _clearSlct="getSelection"in window?function(){window.getSelection().removeAllRanges()}:function(){document.selection.empty()},tm,um;this.pageSlide=function(e,h){$(document).on("mousedown touchstart MSPointerDown pointerdown",e,function(e){e=e||window.event;var i;if(!(i=_isPointerEventType(e,"down"))||_isPrimaryTouch(e)){e=i?e:e.touches&&e.touches[0]||e;var a={x2:void 0,y2:void 0},n=0,s=$(this),o=this.parentNode.clientWidth,r=o/8,l=parseInt(s.attr("x")||this.offsetLeft)||0,d=this.clientWidth,c=-d+o-20;a.x1=e.clientX,a.y1=e.clientY,s.removeClass("transition");function u(e){e.preventDefault()}document.body.addEventListener("touchmove",u,{passive:!1});function f(e){e=i?e:e.touches&&e.touches[0]||e,a.x2=e.clientX,a.y2=e.clientY,n=a.x2-a.x1,a.y2,a.y1;var t=n+l;t=20<t?20:t<c?c:t,_self.setTransform.call(s,t,0),s.attr("x2",t),_clearSlct()}var m=function(e){if(_clearSlct(),s){s.addClass("transition");var t=0;if(r<Math.abs(n)){parseInt(s.attr("x2"));r<=n&&l+o<=0?(_self.setTransform.call(s,l+o,0),s.attr("x",l+o),t=-1):n<=-r&&0<l-o+d?(_self.setTransform.call(s,l-o,0),s.attr("x",l-o),t=1):_self.setTransform.call(s,l,0)}else _self.setTransform.call(s,l,0);var i=h&&h(t);if($(document).off("mousemover mousemove touchmove MSPointerMove pointermove",f).off("mouseup touchend MSPointerUp pointerup",m),s=null,_clearSlct(),!1===i)return e.stopPropagation&&e.stopPropagation,e.preventDefault&&e.preventDefault(),!1;document.body.removeEventListener("touchmove",u)}};$(document).on("mousemover mousemove touchmove MSPointerMove pointermove",f).on("mouseup touchend MSPointerUp pointerup",m)}})},this.getCSSRule=function(e,t,i){if(i=i||window.document,e=e.toLowerCase(),i.styleSheets)for(var a=0;a<i.styleSheets.length;a++){var n=i.styleSheets[a],s=0,o=!1;do{if((o=n.cssRules?n.cssRules[s]:n.rules[s])&&o.selectorText&&o.selectorText.toLowerCase()==e)return"delete"==t?(n.cssRules?n.deleteRule(s):n.removeRule(s),!0):o;s++}while(o)}return!1},this.killCSSRule=function(e){return this.getCSSRule(e,"delete")},this.addCSSRule=function(e){return document.styleSheets&&(this.getCSSRule(e)||(document.styleSheets[0].addRule?document.styleSheets[0].addRule(e,null,0):document.styleSheets[0].insertRule(e+" { }",0))),this.getCSSRule(e)},this.addJS=function(e,t){var i=document.createElement("script");i.setAttribute("type","text/javascript");var a=document.getElementsByTagName("head")[0];function n(e){i.onload=i.onerror=i.onreadystatechange=null,a.removeChild(i),t&&t(e,i.innerHTML),i=null}"onload"in i?(i.onload=n,i.onerror=function(){n(!0)}):i.onreadystatechange=function(){/loaded|complete/.test(i.readyState)&&n()},i.src=e,a.appendChild(i)},this.addCSS=function(e){var t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e,t.media="screen",document.getElementsByTagName("head")[0].appendChild(t)},this.base64encode=function(e){var t,i,a,n,s,o,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(a=e.length,i=0,t="";i<a;){if(n=255&e.charCodeAt(i++),i==a){t+=r.charAt(n>>2),t+=r.charAt((3&n)<<4),t+="==";break}if(s=e.charCodeAt(i++),i==a){t+=r.charAt(n>>2),t+=r.charAt((3&n)<<4|(240&s)>>4),t+=r.charAt((15&s)<<2),t+="=";break}o=e.charCodeAt(i++),t+=r.charAt(n>>2),t+=r.charAt((3&n)<<4|(240&s)>>4),t+=r.charAt((15&s)<<2|(192&o)>>6),t+=r.charAt(63&o)}return t},this.iScrollParam={preventDefault:!1,preventDefaultException:/^(A|PRE|INPUT|TEXTAREA|BUTTON|SELECT|LABEL)$/,tap:!1,click:!1,mouseWheel:!1,fadeScrollbars:!1},this.parseMsgByRule=function(o,e,t){if(e&&o){var i,a,s=this.regFace,r=this.regEmo||new RegExp("\\[#[a-z0-9A-Z]+(_[a-z0-9A-Z]+)?#\\]","g"),l=1,n=e[o.mt||0];return n?n=n.replace(/\$\{([^,]+),?([^,]+)?,?([^,]+)?,?([^,]+)?\}/g,function(e,t,i,n,a){if(l="1"==a?1:0,!i&&!n)return o[t];n=parseInt(n);var s=o[t];return 0<n&&s.replace(/\[#([^#]+)#\]/g,function(e,t,i,a){return i<n&&i+e.length>=n?n+=e.length-1:i<n&&(n+=e.length-1),e}),o[t].substring(i,n)}):(n=o.content)||(n=e[0]),(l||t&&t.notPlainText)&&(n=(i=n)&&i.replace(/<(?:.|\s)*?>/gi,"").substring(0,a||100)),n=s?n&&function(e){if(!e)return e;var n=this.emo;return n&&(e=e.replace(s,function(e){var t=e.charCodeAt(0),i=e.charCodeAt(1),a=(i-56320+(t-55296<<10)+65536).toString(16);return n[a]?'<img class="img-emo" src="/res/emoji/32/'+a+'.png" />':n[t+"_"+i]?'<img class="img-emo" src="/res/emoji/32/'+t+"_"+i+'.png" />':e})),e=e.replace(r,function(e){var t=e.replace(/^\[#([\d\w_]+)#\]/g,"$1");return n&&n[t]||!n?'<img class="img-emo" src="/res/emoji/32/'+t+'.png" />':e})}(n):n&&n.replace(r,"[face]")}},this.lastMsgRule={0:"您有新的消息",604:"您的对话已接通",605:"您的对话已结束",621:"给您发送了一个信息填写邀请",622:"给您发送了一个信息填写邀请",640:"${content,0,30,1}",641:"[图片]",642:"[文件]",647:"${content,0,30,1}",648:"等待接入会话，排队位置:${position}",653:"[图片]",657:"[图文消息]",673:"请您对本次服务进行评价",674:"您有新的消息",675:"您有新的消息",676:"您有新的消息",10011:"[图文消息]",864:"${content,0,30,1}",865:"[图片]",866:"[文件]",680:"[链接]"},this.formatUnreadMsg=function(e){var t=this;if(!e.lastMsgContent)return{unreadMsgCount:e.unreadMsgNumber||e.unreadMsgCount||0};var i=this.lastMsgRule;return function(e){this.needHttps&&e.companyLogo&&(e.companyLogo=e.companyLogo.replace(/^http:/,this.needHttps)),void 0!==e.unreadMsgNumber&&(e.unreadMsgCount=e.unreadMsgNumber),e.lastMsg=JSON.parse(e.lastMsgContent),e.msgContent=t.parseMsgByRule(e.lastMsg,i)}(e),{chatUrl:(this.loaderHost||location.origin)+"/visitor/mobile/chat.html?companyId="+e.companyId+"&platformSign="+encodeURIComponent(e.signature)+"&metaData="+encodeURIComponent(this.queryParams.metaData)+"&myData="+encodeURIComponent(this.queryParams.myData),msgId:e.mid,platformId:e.platformId||void 0,companyId:e.companyId,companyLogo:e.companyLogo,companyName:e.companyName,msgContent:e.msgContent,unreadMsgCount:e.unreadMsgCount}},this.sendMsgboxUnread=(tm={cookieName:"",cookieValue:"",readySendName:"",readySend:{lastMid:"",order:[123],123:{}},queue:[],pageTag:(new Date).getTime(),checkTimer:null,timeoutTimer:null},um=null,{send:ym,queue:tm.queue,init:function(e){var t;!um&&_self.visitorId&&(tm.cookieName="unreadNewMsg_"+_self.visitorId,tm.readySendName="unreadNewMsgMap_"+_self.visitorId,$.cookie(tm.readySendName,""),tm.cookieValue=$.cookie(tm.cookieName),tm.readySend=$.store(tm.readySendName),tm.readySend?tm.readySend=JSON.parse(tm.readySend):(tm.readySend={order:[]},$.store(tm.readySendName,'{ "order": [] }')),tm.cookieValue&&(t=tm.cookieValue.split("_")[0],tm.readySend[t]&&zm(tm.readySend[t])),um=e)}}),$(document).on("drag",function(e){return(e=e||window.event).preventDefault&&e.preventDefault(),!1})}function _isPointerEventType(e,t){return e.type=="pointer"+t||e.type.toLowerCase()=="mspointer"+t||e.type=="mouse"+t}function _isPrimaryTouch(e){return-1<e.type.indexOf("mouse")||("touch"==e.pointerType||e.pointerType==e.MSPOINTER_TYPE_TOUCH)&&e.isPrimary}function wm(){tm.readySend=$.store(tm.readySendName),tm.readySend=tm.readySend?JSON.parse(tm.readySend):{order:[]}}function xm(e,t){wm();var i=tm.readySend.order;if(0===t){if(e.mid&&(tm.readySend.lastMid=e.mid),0<i.length){tm.readySend[e.mid]=void 0,delete tm.readySend[e.mid];for(var a=0;a<i.length;a++)i[a]==e.mid&&i.splice(a,1)}}else if(!tm.readySend[e.mid]&&(tm.readySend[e.mid]=e,tm.readySend.order.unshift(e.mid),10<tm.readySend.order.length)){for(a=10;a<i.length;a++)tm.readySend[i[a]]=void 0,delete tm.readySend[i[a]];tm.readySend.order.length=10}$.store(tm.readySendName,JSON.stringify(tm.readySend))}function ym(e){if(e&&(tm.queue.push(e),xm(e,1)),0!=tm.queue.length){var t=$.cookie(tm.cookieName);t&&(tm.checkTimer||tm.timeoutTimer)?tm.checkTimer||tm.timeoutTimer||(tm.timeoutTimer=setTimeout(function(){tm.timeoutTimer=null,ym()},300)):(!t&&tm.checkTimer&&clearTimeout(tm.checkTimer),!t&&tm.timeoutTimer&&clearTimeout(tm.timeoutTimer),zm(tm.queue.shift()))}}function zm(e){if(e){if(wm(),tm.readySend.lastMid&&tm.readySend.lastMid>=e.mid)return ym();tm.cookieValue=e.mid+"_"+tm.pageTag,$.cookie(tm.cookieName,tm.cookieValue),tm.checkTimer=setTimeout(function(){tm.checkTimer=null,$.cookie(tm.cookieName)==tm.cookieValue&&(um(e),$.cookie(tm.cookieName,""),xm(e,0)),$.cookie(tm.cookieName)?tm.timeoutTimer=setTimeout(function(){tm.timeoutTimer=null,ym()},300):ym()},200)}}};UTIL.prototype.serverAdaptor={fuzzyBrandI18nRes:function(){}},window.SDK||__inline("serverTypeAdaptor.js"),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.toString().replace(/(^\s+)|(\s+$)/g,"")}),Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var i in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),t)new RegExp("("+i+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[i]:("00"+t[i]).substr((""+t[i]).length)));return e},window.UTIL=UTIL,"undefined"==typeof console&&(window.console={log:function(e){}})}(EChatQuery),function(k){var C=new function(e){k.cometd={getStatus:function(){return"sdk"}},UTIL.call(this,!0);var m=this,r=[],l=[],n=!(this.selfMsg=function(e,t){var i=e;switch("0"==i.id&&(i.id=i.mid),i.mt+""){case"10009":return!1!==i.isForward||m.lastTalkId||(m.lastTalkId=view.chat.talkId,m.lastTalkType=view.chat.isInRobot?3:!0===view.chat.chatting?1:2),!1===i.isForward&&4!=i.type&&10!=i.type&&9!=i.type&&view.chat.publish("__chatStatus","exceptionEnd"),i.justConnect=4!=i.type&&10!=i.type,void s(i);case"600":window.chatVisitorId="chatVisitorId"+i.visitorId,window.encryptVID=m.encryptVID=i.encryptVID,m.visitorId=i.visitorId,window.encryptVID=m.companyId=i.companyId,view.chat.initVisitor(),m.publish("setVisitorInfo",i),(i.routeEntranceInfo||i.routeEntranceInfoString)&&(i.routeEntranceInfo=i.routeEntranceInfo||JSON.parse(i.routeEntranceInfoString),m.waitForRouterSelect=!0,m.publish("displayRouterInfo",i)),a(e),m.publish("handshakeOk",e),m.publish("updateVisitorInfo",i);break;case"671":m.publish("setChatParam",i);break;case"672":m.publish("setRestartTag",i);break;case"649":a(e),m.publish("setconfig",i),!0===view.chat.chatting&&!view.chat.isInRobot||m.publish("waitingChat",i);break;case"651":case"682":break;case"652":this.publish("getErr",i);break;case"646":this.publish("getChatToken",i);break;default:t||m.receiveChat(e,!0)}});function s(e){e&&(m.publish("chatEnded",e),n=!1),m.unSubscribe(["sendVisitorEvent","visitorCommonEvent"]),m.unSubscribe("restartChat"),m.subscribe("restartChat",function(){view.chat.publish("__callNative",{functionName:"restartChat"})})}function o(i,a,e,t){var n=t?l:r,s=e?e.item:(new Date).getTime(),o=e||{data:i,cb:a,time:s,sending:!0};return e&&104!=i.et||n.push(o),m.publish("__sendMessage",i,function(e){if(a&&(e.bridgeMsgId=i.bridgeMsgId,a.apply(this,arguments)),e.successful){for(var t=n.length-1;-1<t;t--)if(n[t]&&n[t].time==s){n.splice(t,1);break}d(!1)}else o.sending=!1}),1}function d(e){var t=e?l:r;if(0<t.length)for(var i,a=0;a<t.length&&((i=t[a]).sending||(i.sending=!0,o(i.data,i.cb,i)));a++);}function a(){m.unSubscribe(["sendVisitorEvent","visitorCommonEvent"]),m.subscribe("sendVisitorEvent",function(e,t,i){o(t,i,null,!0)}),m.subscribe("visitorCommonEvent",function(e,t,i){o(t,i,null,!1)})}this.receiveChat=function(e,t){var i,a=e;switch("0"==a.id&&(a.id=a.mid),a.mt+""){case"127":case"902":this.publish("sendLocationInfo",a);break;case"677":case"678":this.publish("startLeave",a);break;case"687":case"691":m.publish("startRobot",a);break;case"686":case"604":m.waitForRouterSelect=!1,i=a,m.publish("startChat",i),d(!0);break;case"605":return!1!==a.isForward||m.lastTalkId||(m.lastTalkId=view.chat.talkId,m.lastTalkType=view.chat.isInRobot?3:!0===view.chat.chatting?1:2),void(a.fromHistory&&!a.fromDB||s(a));case"620":return void this.publish("staffState",a);case"640":this.publish("getMsg",a);break;case"641":a.identityKey&&(a.fileIdentity=a.identityKey),a.clientFileId||(a.clientFileId=a.identityKey),this.publish("getMsgImg",a);break;case"642":a.identityKey&&(a.fileIdentity=a.identityKey),a.clientFileId||(a.clientFileId=a.identityKey),this.publish("getMsgFile",a);break;case"644":this.publish("getMsgTyping",a);break;case"647":this.publish("getSysMsg",a);break;case"648":this.publish("getPosMsg",a);break;case"650":return void this.publish("refreshVerify",a);case"655":a.current=!0,m.publish("getLeaveMsg",a);break;case"864":this.publish("getMsgMine",a);break;case"865":a.identityKey&&(a.fileIdentity=a.identityKey),view.fileMsgs[a.clientFileId]&&(view.fileMsgs[a.clientFileId].sendStatus=4),this.publish("getMsgImg",a);break;case"866":a.identityKey&&(a.fileIdentity=a.identityKey),view.fileMsgs[a.clientFileId]&&(view.fileMsgs[a.clientFileId].sendStatus=4),this.publish("getMsgFile",a);break;case"local":case"local_upload":a.identityKey&&(a.fileIdentity=a.identityKey),a.fileIdentity||(a.fileIdentity=a.clientFileId),2==a.sendStatus||4==a.sendStatus?1==a.fileType?this.publish("getMsgImg",a):this.publish("getMsgFile",a):I.prepareUpload(a);break;case"874":this.publish("getHistory",a);break;case"876":return void this.publish("overLength",a);case"890":this.publish("inviteBook",a);break;case"892":this.publish("inviteBookOK",a);break;case"670":return void m.publish("entryCallback",a);case"673":m.publish("inviteSatisfy",a),k.store("ECHAT_inviteSatisfyId",a.mid);break;case"675":return a.staffName=a.staffName||a.staffNickName,m.publish("getLeaveReply",a),void(n=!1);case"680":m.publish("receiveURL",a);break;case"923":return void m.publish("updateVisitorInfo",{visitorId:a.newVisitorId,photo:a.metaDataInfo.photo});case"928":return;case"12001":this.publish("getMsgRobot",a);break;case"10011":m.publish("receiveVisEvt",a);break;default:return void(t||m.selfMsg(e,!0))}n||(this.publish("removeLoading",a),n=!0),892!=a.mt&&890!=a.mt&&866!=a.mt&&874!=a.mt&&865!=a.mt&&864!=a.mt&&642!=a.mt&&641!=a.mt&&640!=a.mt||a.tm&&(view.chat.lastMsgTM=a.tm)},this.receive=function(){},m.subscribe("restartChat",function(){view.chat.publish("__callNative",{functionName:"restartChat"})}),m.subscribe("_endConnect",function(){s({justConnect:!0})}),m.subscribe("__callNative",function(e,t,i){p(t.functionName,t.value,i)}),m.unSubscribe("__registChatAction"),m.subscribe("__registChatAction",function(e,t){p("registChatAction",t)});var c={},u=0,f=(new Date).getTime()+"";m.subscribe("__sendMessage",function(e,t,i){t.publishAck&&(t.bridgeMsgId=t.publishAck.bridgeMsgId,delete t.publishAck),t.bridgeMsgId?t.isResend=1:t.bridgeMsgId=f+ ++u,p("sendMessage",t),c[t.bridgeMsgId]=i}),m.subscribe("__loadPreHistory",function(e,t,i){p("loadPreHistory",{baseTalkId:m.lastTalkId||"",talkType:m.lastTalkType||""})}),m.subscribe("removeLoading",function(e,t,i){p("removeLoading")});var h=1;function p(e,t,i){if(console.log(e,t,i),e)try{var a={functionName:e,value:t||""};i&&"function"==typeof i&&(a.callback="callback_"+h,window[a.callback]=function(){console.log("callback***"+a.callback,arguments),i.apply(i,arguments),window[a.callback]=null},h++),window.wkWebkit?window.webkit&&window.webkit.messageHandlers.callEchatNativeConnect.postMessage(JSON.stringify(a)):window.EchatJsBridge&&EchatJsBridge.callEchatNativeConnect(JSON.stringify(a))}catch(e){console.log(e)}}function g(e){return"string"==typeof e?JSON.parse(e+""):e}window.callEchatJsConnect=function(e){var t=g(e);"isCometdConnect"!=t.functionName&&"msgFromDB"!=t.functionName&&"msgFromUnRead"!=t.functionName&&console.log(">>>callEchatJsConnect:"+JSON.stringify(e)),t.functionName&&I[t.functionName]&&I[t.functionName](t.value)};var v,b={600:0,103:0,649:0,109:0,encryptVId:0},y=[],w=!1,I={preparedConnect:function(e){var t=g(e);if(window.initVisitorInfo,"0"==t.isConnect){if(w)return;w=!0;t.dataHost;var i="https://"+(t.dataHost||view.chat.json.dataHost).replace(/([^\.]+)\./,"$1api.")+"/getVisitorUnReadMsgCount?sdkAppId="+encodeURIComponent(e.appId)+"&sdkAppSecret="+encodeURIComponent(e.appSecret)+"&encryptVId="+encodeURIComponent(t.encryptVId)+"&visitorId="+encodeURIComponent(t.visitorId||""|m.visitorId)+"&metaData="+(t.metaData?encodeURIComponent(t.metaData):"");k.ajax({url:i,type:"jsonp",jsonpCB:"jsonpCallback",success:function(e){console.log(e),e&&0<e.unreadMsgCount&&(k("#restartChat").parents(".msg-info").remove(),view.chat.publish("restartChat"))},error:function(e){}})}},msgFromServer:function(e){if(e){console.log("msgFromServer",e);var t=g(e);t.bridgeMsgId&&c[t.bridgeMsgId]?(c[t.bridgeMsgId]&&c[t.bridgeMsgId](t),c[t.bridgeMsgId]=void 0):t.mt||t.encryptVId?(t.encryptVId&&(window.encryptVID=m.encryptVID=view.chat.encryptVID=t.encryptVId,t.companyId&&(m.companyId=view.chat.companyId=t.companyId)),t.mt&&"local"==t.mt&&t.fileType&&(1==t.fileType?t.mt="865":t.mt="866"),t.isForward=!1,m.receiveChat(t)):t.et||t.mt}},msgFromDB:function(e){console.log(e);var t=this;void 0===m.lastTalkIdFromNative&&C.publish("__callNative",{functionName:"queryTalkIDs"});var i,a,n,s=g(e),o=[],r=("null"==s.chatDetailList?[]:s.chatDetailList)||[],l=r[r.length-1],d=l&&l.talkId||r[r.length-2]&&r[r.length-2].talkId;if("[object Array]"==Object.prototype.toString.call(r)&&0!=r.length){if(console.log("***msgFromDB***",k.extend([],r)),!m.lastTalkIdFromNative&&10009==l.mt){for(var c=r.length-2;1<c;c--){if(605==r[c].mt&&r[c].talkId!=d){i={talkId:r[c].talkId,chatDetailList:r.splice(0,c+1)};break}if(10009==r[c].mt&&r[c].talkId!=d){for(var u=c-1;1<u;u--)if(655!=r[u].mt&&r[u].talkId){i={talkId:r[u].talkId,chatDetailList:r.splice(0,c+1)};break}if(1!=u)break}}i&&(i.talkType=m.getTalkType(i.chatDetailList).talkType,setTimeout(function(){t.msgFromHistory(i)},1))}m.lastTalkIdFromNative||605!=l.mt&&10009!=l.mt||(l.isForward=!1,i||m.lastTalkId||(a=m.getTalkType(r),m.lastTalkId=a.talkId,m.lastTalkType=a.talkType));for(c=0;c<r.length;c++){if(s=r[c],!n&&(n=s.talkId)&&m.hasPageHandleMsg==n)return;s.isForward="0"!=s.isForward&&s.isForward,s.mt&&644!=s.mt&&10005!=s.mt?(void 0!==b[s.mt]?649==s.mt&&1==b[s.mt]?s.sdkChatBoxInfo&&o.push(s):(o.push(s),b[s.mt]=1):o.push(s),b.encryptVId=s.encryptVId||s.encryptVID||b.encryptVId):s.et&&104!=s.et&&1!=b[s.et]&&123!=s.et?void 0!==b[s.et]?(0==b[s.et]&&o.push(s),b[s.et]=1):o.push(s):"local"==s.mt&&(s.identityKey&&(s.fileIdentity=s.fileIdentity||s.identityKey),o.push(s)),s.id&&(s.id=s.mid||s.tm)}o.length&&m.handleHistoryMsg(o),m.hasPageHandleMsg=n}else m.hasPageHandleMsg=!0},allTalkIdFromHistory:function(e){if(console.log("******allTalkIdFromHistory****",e),m.lastTalkIdFromNative="",e){var t=g(e);"null"==t[0]&&t.shift(),"null"==t[0]||1==t.length&&t[0]==view.chat.talkId?view.chat.hidePreHistory():(m.lastTalkIdFromNative=t[0]&&t[0].talkId||"",view.chat.showPreHistory())}else view.chat.hidePreHistory()},msgFromUnRead:function(e){if("null"!=e&&e){var t=g(e);if("[object Array]"==Object.prototype.toString.call(t)){console.log("*****************msgFromUnRead*handle*****************",t),y={};var i,a,n,s,o,r=t.length,l=!0;console.log(t);for(var d=0;d<r;d++)if(a=(i=t[d].chatDetailList||[]).length,o=t[d].talkId,m.lastTalkId||(m.lastTalkId=v=o,m.lastTalkType=t[d].lastTalkType,m.lastTalkIdLocked=!0),a){if(d==r-1){"605"!=i[a-1].mt&&"10009"!=i[a-1].mt||(m.hasPageHandleMsg?m.hasPageHandleMsg!=t[r-1].talkId&&I.msgFromDB(t[r-1]):I.msgFromDB(t[r-1]));break}y[o]={talkId:o,talkType:t[d].talkType};for(var c=0;c<i.length;c++)n=i[c],y[o],600!=n.mt&&n.mt,3<c&&600==n.mt&&(l=!1),!(l||671!=n.mt&&109!=n.et&&103!=n.et)||3<c&&600==n.mt||(l&&(12001!=n.mt||3!=n.type||204!=n.result&&205!=n.result||(l=!0)),"649"==n.mt?s=n:"600"==n.mt?(n.routeEntranceInfo=void 0,n.routeEntranceInfoString=void 0,s=null):"670"!=n.mt&&679!=n.mt&&604!=n.mt&&648!=n.mt||(s&&(s.sdkEntranceInfo=void 0),s&&(s.captChaToken=void 0)),T(n,y[o],"unread"));view.chat.showHis(y[o],o)}}else console.log("msgFromUnRead value 为Array json 格式，兼容多个会话的未读消息",t)}else console.log("msgFromUnRead length:null")},msgFromHistory:function(e){if("null"!=e&&e){var t=g(e);m.lastTalkId=v=t.talkId,m.lastTalkType=t.talkIdType||t.talkType,m.lastTalkIdLocked=!0,v==m.lastTalkIdFromNative&&view.chat.hidePreHistory();for(var i={},a=t.chatDetailList||[],n=0;n<a.length;n++)T(a[n],i);console.log("%cmsgFromHistory showHis%c%o","color:green","color:green",i),view.chat.showHis(i,v)}else view.chat.hidePreHistory()},prepareUpload:function(e){var t=g(e);_$(t.clientFileId)&&k("#"+t.clientFileId).remove(),content=view.getMsgSendingFile(t),view.chat.showMsg({id:t.clientFileId,f:"c",media:1,m:3==t.fileType||4==t.fileType?t.fileType:1},content)},uploadKey:function(e){I.prepareUpload({clientFileId:e})},uploadStart:function(e){var t=g(e),i=view.getMsgSendingFile(t),a={1:lanRes.image,2:lanRes.fileHtml,4:lanRes.video,3:lanRes.voice};view.chat.publish("__visitorStartSendMsg","["+a[t.fileType]+"]"),i&&view.chat.updateMsg(t.clientFileId,i)},uploadProgress:function(e){var t=g(e);if(!view.fileMsgs[t.clientFileId]||4!=view.fileMsgs[t.clientFileId].sendStatus){var i=view.getMsgSendingFile(t);i&&view.chat.updateMsg(t.clientFileId,i)}},updateLocalMessage:function(e){var t=g(e);view.fileMsgs[t.clientFileId]&&(view.fileMsgs[t.clientFileId]=t)},downloadProgress:function(e){var t=g(e),i=view.fileMsgs[t.clientFileId],a=_$(t.identityKey||t.fileIdentity);i&&(i.loadStatus=t.loadStatus),a&&(barInfo=k(".file-load-bar-info",a).results[0],a=k(".msg-file",a).results[0],barInfo&&(1==t.loadStatus?(barInfo.innerHTML="点击打开",view.fileMsgs[t.clientFileId]=k.extend(view.fileMsgs[t.clientFileId],e)):2==t.loadStatus?(barInfo.innerHTML=t.progress+"%",k(".file-load-progress0",a).css("width",t.progress+"%")):3==t.loadStatus?barInfo.innerHTML="点击下载":4==t.loadStatus&&(barInfo.innerHTML='<span class="red">下载失败</span>点击重新下载')),a.className="msg-file file-load-status"+t.loadStatus)},callbackOpenFile:function(e){0==g(e).status&&alert("文件不存在")}};function T(e,t,i){var a=g(e);if(105==a.et||130==a.et||864==a.mt)a.mt=864,a.tm=a.tm||a.bridgeMsgId,a.f="c",130==a.et&&(a.ff="r"),a.m=0;else if(640==a.mt||641==a.mt||642==a.mt)a.f="s",640==a.mt&&(a.m=0),641==a.mt&&(a.m=2),642==a.mt&&(a.m=1);else if(127==a.et)a.f="c",a.mt=127;else if(12001==a.mt)a.f="r";else{if(104==a.et||644==a.mt||106==a.et||109==a.et)return;10011==a.mt&&(a.f=1==a.mst?"c":2==a.mst?"s":"x")}var n=a.tm||(new Date).getTime();673==a.mt&&"unread"!=i||(t[n]=a,t.order?t.order.push(n):t.order=[n]),649!=a.mt&&604!=a.mt&&600!=a.mt||(t.config?t.config.push(a):t.config=[a])}window.echatPageService=I,m.handleHistoryMsg=function(e){console.log("handleHistoryMsg",e);var t,i,a,n=e.length,s=e[n-1],o=!1,r=!0;if(n){if(600!=s.mt&&649!=s.mt||1!=n)if(605==s.mt)o=!0;else if(10009==s.mt)o=!0;else for(i=null,t=0;t<n;t++)s=e[t],3<t&&600==s.mt&&(r=!1),600==s.mt&&(m.companyId=s.companyId,void 0===a?a=t:e[a]=s),3<t&&600==s.mt||!(r||671!=s.mt&&109!=s.et&&103!=s.et)?(e.splice(t,1),t--,n--):(r&&(12001!=s.mt||3!=s.type||204!=s.result&&205!=s.result||(r=!0)),"649"==s.mt?i=s:"600"==s.mt?(s.routeEntranceInfo=void 0,s.routeEntranceInfoString=void 0,i=null):"670"!=s.mt&&"677"!=s.mt&&"678"!=s.mt&&679!=s.mt&&604!=s.mt||(i&&(i.sdkEntranceInfo=void 0),i&&(i.captChaToken=void 0)));else{if(!s.routeEntranceInfoString)return void 0;if(1==n)return I.msgFromServer(s)}var l,d=k.store("ECHAT_inviteSatisfyId"),c=!0;for(d==k.store("ECHAT_inviteSatisfyHandle")&&(c=!1),t=n-1;-1<t;t--)600==(s=e[t]).mt?(s.routeEntranceInfo||s.routeEntranceInfoString)&&t<n-1&&(s.routeEntranceInfo=null,s.routeEntranceInfoString=null):649==s.mt?o&&(s.sdkEntranceInfo=null,s.captChaToken=null):673==s.mt&&(c?d<s.mid||l?s.del=!0:l=s:s.del=!0);var u=[];for(t=0;t<n;t++)(s=e[t]).del||(s.fromDB=!0,s.fromHistory=!0,670!=s.mt&&(12001==s.mt&&3==s.type&&t<n-2||(105==s.et||130==s.et?s.mt=864:127==s.et&&(s.mt=127),!1===s.isForward&&605!=s.mt&&10009!=s.mt&&u.push[s],"local"==s.mt||"local_upload"==s.mt?view.chat.showMsg({id:s.clientFileId,f:"c",media:1,m:3==s.fileType||4==s.fileType?s.fileType:1},view.getMsgSendingFile(s)):m.selfMsg(s))));if(o&&1<u.length){var f={data:{chatDetailList:u}};m.publish("receiveUnread",f)}}},this.getTalkType=function(e){for(var t,i=e.length-1;0<i;i--){if(t=e[i].talkId||t,604==e[i].mt||648==e[i].mt||647==e[i].mt&&5==e[i].type)return{talkType:1,talkId:t};if(12001==e[i].mt||647==e[i].mt&&10==e[i].type)return{talkType:3,talkId:t};if(647==e[i].mt&&7==e[i].type)return{talkType:2,talkId:t}}for(i=e.length-1;0<i;i--)if(649==e[i].mt&&2==e[i].status)return{talkType:2,talkId:t};return{talkType:2,talkId:t}}};(ECHATObjKeyMap.cometdId=C).setSub("chatId"),C.setSub("cometdId"),window.initChat=function(){k.store("ECHAT_chatStatus");setTimeout(function(){C.publish("__callNative",{functionName:"pageReady",value:{history:{data:[{mt:"649"},{mt:"604"},{mt:"10001"},{mt:"10011"},{mt:"865"},{mt:"641"},{mt:"10010"},{mt:"647"},{mt:"605"},{mt:"866"},{mt:"642"},{mt:"680"},{mt:"640"},{mt:"864"},{mt:"655"},{mt:"12001"},{mt:"673"},{mt:"648"},{mt:"local"},{et:"127"},{et:"105"},{et:"130"}]}}}),window.setVisitorInfo&&C.publish("__callNative",{functionName:"getVisitorId",callback:"setVisitorInfo"}),C.publish("__callNative",{functionName:"getUnReadMessage"})})},window.retryTime=0}(EChatQuery),function($,U){var m;window._$=function(e){return e&&U.getElementById(e)},window._$s=function(e){return U.getElementsByTagName(e)},window.$=$,window.locationBase=window.locationBase||"",window.onerror=function(e){};var O={};function y(e,t){if(e.isMini){var i=$("#content").height();$("#content").css("height",("close"==t?i+40:i-40)+"px")}else e.isMobile&&($("#container").css(view.SDK?"paddingBottom":"bottom",$("#footer").height()+"px"),view.scrollToBottom&&view.scrollToBottom());view.scrollToBottom&&view.scrollToBottom()}function v(e,t,i){var a="",n=(e=e||_$("entryForm"),""),s="";if(i?t=e[i]:t&&(i=t.name),1!=t.nodeType){a=[],s=[];for(var o=0;o<t.length;o++)t[o].checked&&(a.push(t[o].value),s.push($(t[o]).attr("lb")));n=$(t[0]).parents(".entry2-typeline").attr("lb"),a=a.join(","),s=s.join(",")}else if(n=$(t).attr("lb"),a=t.value.replace(/^[\s]+|[\s]+$/gi,""),"SELECT"==t.tagName)for(var r=0;r<t.length;r++)if(t[r].value==a){s=$(t[r]).text();break}return{val:a,ipt:t,label:n,labelVal:s||a}}function b(e,t,i,a){var n,s=!0,o=!1;if(1==e.nodeType?n=O[i]||O[e.type]:1<e.length&&e[0]&&(o=!0,e=e[0]),!t&&(-1<e.className.indexOf("req")||$(e).parents(".req").length)){s=!1;var r="";r="text"==e.type?lanRes.inputPlease.replace("${inputName}",e.getAttribute("lb")):lanRes.inputPleaseJa2.replace("${inputName}",o?$(e).parents(".entry2-typeline").attr("lb"):e.getAttribute("lb")),_$("leave_tip_con").innerHTML=r}else if(t&&n)if(n.length&&t.length>n.length){s=!1;r="";r="age"==i?lanRes.ageOverLengthJa.replace("${age}",e.getAttribute("lb")):e.getAttribute("lb")+lanRes.overLength,_$("leave_tip_con").innerHTML=r}else n.p&&!t.match(n.p)&&(s=!1,_$("leave_tip_con").innerHTML=n.msg||"请正确输入"+e.getAttribute("lb"));return view.chat.tipTimer&&clearTimeout(view.chat.tipTimer),a?(a&&a(s),(s&&e.style?l:h)()):s&&e.style?(e.style.borderColor="#FFFFFF",l()):(e.style.borderColor="#FF0000",h()),s}function h(e,t){view.chat.tipTimer&&clearTimeout(view.chat.tipTimer),e&&(_$("leave_tip_con").innerHTML=e),_$("leave_tip").className="leave-tip leave-tip-"+(t||"warn"),view.chat.tipTimer=setTimeout(function(){$("#leave_tip").addClass("tiphide")},3e3)}function l(){view.chat.tipTimer&&clearTimeout(view.chat.tipTimer),$("#leave_tip").addClass("tiphide")}function q(e){for(var t=!0,i=0;i<e.length&&(t=t&&"1"==e[i].configInline);i++);return t?"1":"0"}String.prototype.analyDomain=function(e){var t=this.toString(),i=[],a=t.indexOf(e);return 0<=a?(i[0]=t.substring(0,a),t.substring(a+1)&&(i[1]=t.substring(a+1))):i[0]=t,i};function i(){UTIL.call(this),InputHandle.call(this),this.talkId="",this.KEY="chatId",(ECHATObjKeyMap[this.KEY]=this).setSub(this.KEY),this.setSub("cometdId"),this.setSub("viewId"),this.errorList={},this.regFace=new RegExp("\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]|[#-®]|[‼-㊙]","g"),this.regEmo=new RegExp("\\[#[a-z0-9A-Z]+(_[a-z0-9A-Z]+)?#\\]","g"),this.unescapeSend=new RegExp("<d>","g"),this.isMobile=2==this.Device.media||view.SDK,this.isIOS=this.Browser.isIOS,this.isMini=!this.isMobile&&2==view.windowType,this.disableSoundTip=1==this.queryParams.disableSoundTip||view.SDKNative,this.plainText=!0,this.editorType=1,this.hasStorage=function(){try{if(!window.localStorage)return!1;if(window.localStorage.setItem("echt_test_storage","ok"),!window.localStorage.getItem("echt_test_storage"))return!1}catch(e){return!1}return!0}(),this.hasStorage&&(this.tempReferrer=this.hasStorage?window.localStorage.getItem("echat_temp_referrer"):"",window.localStorage.setItem("echat_temp_referrer","")),"https:"==location.protocol||window.SDK?this.needHttps="https:":this.needHttps="",this.initVisitor(),this.init(),this.initBridge(),this.postMessage("miniReady"),this.setChatbox=function(e,t){if(t){var i="ECHAT_"+view.chat.companyId+"_"+e,a=JSON.stringify({chatStaffBackColor:t.chatStaffBackColor,chatStaffTxtColor:t.chatStaffTxtColor,chatVisitorBackColor:t.chatVisitorBackColor,chatVisitorTxtColor:t.chatVisitorTxtColor,sysMsgBackground:t.sysMsgBackground,sysMsgFontColor:t.sysMsgFontColor});t&&$.store(i,a,{path:"/",expires:365}),this.isIOS&&2==view.windowType&&this.postMessage({type:"updateLocalChatbox",key:i,value:a})}},this.getChatbox=function(e){var t=$.store("ECHAT_"+view.chat.companyId+"_"+e);return t&&JSON.parse(t)},this.addEchatInnerFrameParam=function(e){if(e){if(-1!=e.indexOf("&echatInnerFrame=1")||-1!=e.indexOf("?echatInnerFrame=1"))return e;var t=e.split("#"),i=t[1]||"",a=t[0],n=-1==a.indexOf("?")?0:1;return a+(n?"&":"?")+"echatInnerFrame=1"+(i?"#":"")+i}},this.addFixedParam=function(e){if(!e||!view.echatSourceTagEnable||e.match(/^(mailto|tel|javascript):/i))return e||"";var t,i=new RegExp("(^|&)echatSourceTag=([^&]*)(&|$)","i"),a=e.analyDomain("?"),n="echatSourceTag="+(this.echatSourceTag||"");return(t=(a[1]||a[0]).analyDomain("#"))[0].match(i)?e:e=1<a.length?a[0]+"?"+t[0]+"&"+n+(1<t.length?"#"+t[1]:""):t[0]+"?"+n+(1<t.length?"#"+t[1]:"")}}i.prototype={replaceHtml:function(e){return e=e&&e.replace(/<img[^>]+code="([^"]+)"[^>]*>/gi,"[face]")},initBridge:function(){var n=this;var a=n.replaceHtml,s=new function(e,t,i){if(e&&i&&"function"==typeof i){var a=window,n=e;return a.addEventListener?(a.addEventListener("message",function(e){i(e,e.data)}),this.send=function(e){if(e&&t&&2==view.windowType&&window.top!=self)try{n.postMessage(e,t||"*")}catch(e){console.log(e)}}):this.send=function(){console.log("不支持 postMessage")},this}}(parent,n.queryParams.fromhost||(n.tempReferrer||U.referrer||"").split("/").slice(0,3).join("/"),function(e,t){n.publish("getCrossMessage",e)});this.subscribe("__chatStatus",function(e,t){n.outerChatStatus=t,s.send({act:100,eventAction:"chatStatus",eventLabel:t||""}),$.store("ECHAT_chatStatus",t);var i=U.getElementsByTagName("body")[0],a=i.className;a=a.replace(/chatstatus-[^\s]+/gi,""),t&&(a+=" chatstatus-"+t),i.className=a}),this.subscribe("__staffStatus",function(e,t){s.send({act:100,eventAction:"staffStatus",eventLabel:t||""})}),this.subscribe("__chatStart",function(e,t){s.send({act:200,eventAction:"Served by Agent",eventLabel:t||""})}),this.subscribe("__chatQueue",function(e,t){s.send({act:100,eventAction:"queuePostion",eventLabel:t||""})}),this.subscribe("__chatStaffInfo",function(e,t){s.send({act:100,eventAction:"chatStaffInfo",eventLabel:JSON.stringify(t)})}),this.subscribe("__newMsg",function(e,t){var i=t.m;"s"==t.f&&t.c&&s.send({act:100,eventAction:"newMsg",eventLabel:0==i?a(t.c):1==i?"[file]":2==i?"[image]":""}),"r"==t.f&&(t.answer||t.c)&&s.send({act:100,eventAction:"newMsg",eventLabel:a(t.answer||t.c)})}),this.subscribe("__newSysMsg",function(e,t){var i=t.m;t.c&&s.send({act:100,eventAction:"newSysMsg",eventLabel:0==i?a(t.c):1==i?"[file]":2==i?"[image]":""})});var o=["","angry","unsatisfied","ok","satisfied","perfect"];this.subscribe("__evaluate",function(e,t){s.send({act:100,eventAction:"visitorEvaluate",eventLabel:t||""});var i=t.split("-");0==i[0]?s.send({act:200,eventAction:"Chat_Evaluate_Cancel",eventLabel:1==i[1]?"chatting":"end"}):s.send({act:200,eventAction:"Chat_Evaluate_"+o[+n.evaluateScore],eventLabel:1==i[1]?"chatting":"end"})}),this.subscribe("__evaluateComment",function(e,t){s.send({act:200,eventAction:"Chat_Comment_submit",eventLabel:t.chatting?"chatting":"end"})}),this.subscribe("__visitorHide",function(e,t){s.send({act:100,eventAction:"visitorHide",eventLabel:t||""})})},initVisitor:function(){O={email:{p:/^[\w\d_\-\.]+@.+[\.].+/gi,msg:lanRes.invildEmail,length:50},phone:{p:/^[0-9\-]{0,20}$/,msg:lanRes.invildPhone,length:20},age:{p:/^[1-9][\d]{0,2}$/gi,msg:lanRes.invildAge,length:3},qq:{p:/^[1-9][\d]+$/gi,msg:lanRes.invildQQ,length:50},date:{p:/^[\d]{4}[-\/][\d]{2}[-\/][\d]{1,2}/gi,msg:lanRes.invildDate,length:50},address:{length:255},name:{length:50},wechat:{length:50},nickName:{length:50},birthday:{length:20},content:{length:1e3},memo:{length:255},textarea:{length:500},text:{length:100},number:{p:/^\-?\d*$/,length:50}},this.dataHost=window.dataHost,$("#inputLengthTip").html(lanRes.inputLengthTip1+" 30 "+lanRes.inputLengthTip2),view.SDK||(window.chatVisitorId&&$.store("ECHAT_"+window.companyId+"_chatVisitorId",chatVisitorId),window.encryptVID&&($.store("ECHAT_"+window.companyId+"_encryptVID",encryptVID),this.encryptVID=encryptVID))},init:function(){view.initViewEvent(this);var k=this;if(k.showTip=h,k.checkIpt=b,k.defaultVisitorImg=locationBase+"/res/imgs/visitor.png",k.defaultStaffImg=locationBase+"/res/imgs/staff.png",this.paramChat={companyId:k.companyId,visitorId:k.visitorId,firstTitle:k.queryParams.firstTitle||"",firstUrl:k.queryParams.firstUrl||"",referrer:k.queryParams.referrer||"",chatPage:k.queryParams.enterUrl||k.tempReferrer||U.referrer||"",chatPageTitle:k.queryParams.enterTitle||"",metaData:k.queryParams.metadata||"",myData:k.queryParams.myData||"",info:k.queryParams.info||"",echatTag:k.queryParams.echattag||"",lan:window.lanName,visEvt:k.queryParams.visEvt||"",eventId:k.queryParams.eventId||"",media:view.windowType||"",staffId:this.staffId||"",staffName:this.staffName||"",talkId:this.talkId||"",multipleFile:k.queryParams.multipleFile||0},window.initVisitorInfo){for(var e in window.initVisitorInfo)this.paramChat[e]=window.initVisitorInfo[e];try{var t="string"==typeof window.initVisitorInfo.visEvt?window.initVisitorInfo.visEvt:JSON.parse(window.initVisitorInfo.visEvt);t&&t.eventId&&(this.paramChat.eventId=t.eventId)}catch(e){}}this.subscribe("setConfig",function(e,t){var i;i=k.isInRobot?view.SDK?t.robotSdkChatBox:k.isMobile?t.robotPhoneChatBox:2==view.windowType?t.robotSmallChatBox:t.robotPCChatBox:(t.chatBoxInfo||t.chatSmallBoxInfo||t.mobileChatBoxInfo||t.sdkChatBoxInfo||(t=k.msg649),view.SDK?t.sdkChatBoxInfo:k.isMobile?t.mobileChatBoxInfo:2==view.windowType?t.chatSmallBoxInfo:t.chatBoxInfo),view.echatSourceTagEnable=t.echatSourceTagEnable?parseInt(t.echatSourceTagEnable||0):0,view.hasSetAD&&(view.hasSetAD=!1,view.canSetAD=1),i&&(i.chatBoxTitle&&(view.pageTitle=i.chatBoxTitle,view.titles&&(view.titles[1]=i.chatBoxTitle),k.changeDocTitle(i.chatBoxTitle),view.setDocumentTitle&&view.setDocumentTitle("c")),k.defaultStaffImg=i.defaultStaffImg||k.defaultStaffImg,k.defaultVisitorImg=i.defaultVisitorImg||k.defaultVisitorImg,k.needHttps&&(k.defaultStaffImg=k.defaultStaffImg.replace(/^http:/,k.needHttps),k.defaultVisitorImg=k.defaultVisitorImg.replace(/^http:/,k.needHttps)),k.busyCanSend="1"!=i.busyNotAllowSendStatus,$("#busyTip").html((i.busyNotAllowTips||"").replace(/(<p>|<\/p>)/gi,"")),$("#busyTipLine").addClass("hide").hide(),view.setConfig(k,t,i),Number(i.toolEmoji)?$(".menu-emo").removeClass("style-tool-hide"):$(".menu-emo").addClass("style-tool-hide"),Number(i.toolFile)?$(".menu-file").removeClass("style-tool-hide"):$(".menu-file").addClass("style-tool-hide"),Number(i.toolSatisfaction)?$(".menu-satisfy").removeClass("style-tool-hide"):$(".menu-satisfy").addClass("style-tool-hide"),Number(i.toolScreenshot)?$(".menu-capture").removeClass("style-tool-hide"):$(".menu-capture").addClass("style-tool-hide"),Number(i.toolTelephone)?$(".menu-phone").removeClass("style-tool-hide"):$(".menu-phone").addClass("style-tool-hide")),k.toolScreenshot=Number(i?i.toolScreenshot:0)||0,k.leaveWordInfo=t.leaveWordInfo||t.mobileLeaveWordInfo||k.leaveWordInfo}),k.subscribe("sendLocationInfo",function(e,t){k.showLocation(t)}),k.leaveMsgMap={},k.subscribe("getLeaveMsg",function(e,t,i){t.realTalkId||(t.realTalkId=t.newsMsgId,t.fromHistory&&!t.current||(t.talkId=k.talkId||t.newsMsgId+"leave"));var a='<li class="clearfix '+(1!=t.read||t.current?"fold":"")+'" talkid="'+t.talkId+'" id="msg'+t.tm+'"><div class="msg-leave" k="'+t.signature+'"><div class="msg-leave-title"><i class="msg-leave-i"></i><span class="msg-leave-t">'+((t.staffNickName?'<span class="color0">'+t.staffNickName+"&nbsp;</span>":lanRes.serviceStaff)+(4==t.chatInfoType?lanRes.staffLeave:lanRes.leaveStaffReply))+'</span></div><div class="msg-leave-con" ><div class="msg-leave-content">'+k.filterEmo(t.brief)+'</div><div class="msg-leave-dot">...</div><div class="msg-leave-link color0">'+lanRes.viewAll+"</div></div></div></li>",n=U.createElement("ul");n.innerHTML='<li class="clearfix" ><div class="color1 tc">'+k.getTimeStr(t.tm)+"</div></li>"+a;for(var s,o=this.getListMsgEl(t.talkId,t.tm,!!t.current),r=n.childNodes,l=0;s=r[l++];)1==s.nodeType&&(s=s.cloneNode(!0),o.appendChild(s));n=r=null,view.scrollToBottom(null,{transitionDuration:100,timeout:100}),t.current&&(t.f=i?"r":"s",t.c=t.brief,delete t.content,delete t.current,k.pushHistory(t),3==t.chatInfoType&&$(o).addClass("new-leave"),o=null),k.leaveMsgMap[t.signature]=t}),k.subscribe("overLength",function(){h(lanRes.overLength)});var a,i,s,o;view.chat.Browser.isAndroid&&navigator.userAgent.indexOf("baiduboxapp");function n(e,i){k.oldBodyEnterText;var a=k.getInput(!1),n=e.currentTarget||e.target||{},s=n.innerHTML||"";if(e.clipboardData){e.clipboardData.getData("text");e.clipboardData.items[0].getAsString(function(e){var t=i-a.length;(a=k.getInput(!1)).length>=i&&(n.innerHTML=s+e.substr(0,t),$("#inputLengthTip").html(lanRes.inputLengthTip1+" 0 "+lanRes.inputLengthTip2))})}else setTimeout(function(){(a=k.getInput(!1)).length>i?n.innerHTML=s:k.oldBodyEnterText=a,$("#inputLengthTip").html(lanRes.inputLengthTip1+"&nbsp;"+(i-k.oldBodyEnterText.length)+"&nbsp;"+lanRes.inputLengthTip2)})}function r(e,t){k.unSubscribe("_showCommonQue");var i=t.content,a=t.commonQuestions&&JSON.parse(t.commonQuestions);if(a&&a.length){t.commonQuesWords?i+='<div class="common-ques-tip">'+t.commonQuesWords+'</div><ul class="common-ques-list">':i+='<ul class="common-ques-list">';for(var n=0;n<a.length;n++)i+='<li class="common-ques-li" did="'+a[n].id+'" ques="'+escape(a[n].question)+'"><span class="list-style-dot">'+(n+1)+'.</span><span class="link-robot-ques">'+a[n].question+"</span></li>";i+="</ul>"}t.notStore||(k.talkId=t.talkId,k.paramChat.talkId=k.talkId,k.paramChat.staffPhone="",k.paramChat.staffInfo="",k.robotTalkId=t.talkId,view.startChatRefreshAD&&view.startChatRefreshAD(),k.publish("__chatStaffInfo",{staffId:k.paramChat.staffId,staffNickName:k.staffName||"",staffHead:k.staffImg,staffInfo:k.robotExtInfo.autograph||"",recordId:(k.isInRobot?"5_":"1_")+k.talkId})),k._getMsg.call(this,$.extend(t,{tm:t.tm,mt:12001,ff:"r",answer:t.content,staffImg:k.staffImg,staffName:k.staffName,content:i}),0,i,"r")}$("#enter_btn").on(k.isMobile?"touchend":"click",function(e){k.publish("_sendMsg");try{3==k.editorType?window.getSelection().empty():2==k.editorType&&k.win.getSelection().empty()}catch(e){}k.isMobile&&"qq"!=k.Browser.browser&&"weixin"!=k.Browser.browser&&"uc"!=k.Browser.browser&&(view.hideMenus(),k.getInputDocBody().blur(),view.inputBlur&&view.inputBlur(e))}),k.loadConsole=function(e){k.loadConsole=void 0,k.addJS(__uri("/visitor/common/lib/vconsole.js"),function(e){var t=window.console;new VConsole;t.log("location.href",location.href),t.log("msg600::",k.msg600),t.log("msg649::",k.msg649),k.subscribe("echatLog",function(e,t,i){window.console.log(t,i)})})},k.visitorCloseFunc=function(e){if(!(k.visitorClose=!0)===k.chatting||"disconnected"==EChatQuery.cometd.getStatus())k.publish("__visitorCloseCallback",{type:"close",memo:"对话已经结束/连接已经断开,可直接销毁"}),k.publish("_closeWin");else{function t(){k.visitorClose=!0,k.publish("_endChat"),k.leaveAndClose?(k.publish("_endConnect"),k.publish("_closeWin")):k.hasEntryOrCode||"0"==k.queryParams.autoChat?(k.publish("entryCallback",{success:!0}),k.publish("_endConnect"),k.publish("chatEnded",{closeReason:1}),k.publish("__visitorCloseCallback",{type:"close",memo:"信息收集/验证码,访客确认关闭"}),k.publish("__chatStatus","end-1-0"),k.publish("_closeWin")):ECHATObjKeyMap.cometdId.waitForRouterSelect?(k.publish("_endConnect"),k.publish("__visitorCloseCallback",{type:"close",memo:"咨询入口选择时,访客确认关闭"}),k.publish("__chatStatus","end-1-0"),k.publish("_closeWin")):k.outerChatStatus&&k.outerChatStatus.match(/waiting|chatting|leaveToService/)?k.publish("__visitorCloseCallback",{type:"wait",memo:"等待H5发送结束指令,Native将根据结束状态决定关闭view"}):(k.publish("__visitorCloseCallback",{type:"close",memo:"根据状态发现对话没有建立,访客确认关闭"}),k.publish("__chatStatus","end-1-0"))}if(1===e)return t();k.showDialog({tip:lanRes.closeTip,ok:t,cancel:function(){k.visitorClose=!1,k.publish("__visitorCloseCallback",{type:"cancel",memo:"访客取消关闭"})}})}},$(".action-close").on("click",k.visitorCloseFunc),$("#pre_his").on("click",function(){k.loadHistory()}),$("#inputPlaceholder").on("mouseover touchstart",function(){$(this).addClass("hide")}),this.subscribe("_endChat",function(e,t){k.publish("sendVisitorEvent",{et:107},function(){}),k.postMessage(3)}),$("#changelang").on("change",function(e){switch(parseInt(this.value)){case 0:lanResName="zhcn";break;case 1:lanResName="enus";break;case 2:lanResName="jp";break;default:lanResName="zhcn"}var t=U.createElement("script"),i=_$("langScript"),a=i.parentNode;t.id="langScript",t.src=supportLang[lanResName],a.replaceChild(t,i)}),$(U).on("click",".resend",function(){if(!view.handleNetwok||!view.handleNetwok()){var e=$(this).attr("dataid"),t=k.errorList[e];if(t.id=e,t.m=t.m||0,t.f=t.f||"c",t.c=t.c||t.content,!1!==k.chatting&&void 0!==k.chatting)if(k.isInRobot&&7==t.m)k.showTip("请进入人工服务后再发送位置消息");else{var i=_$(e);(i=i.previousElementSibling)&&i.childNodes[0]&&-1!=(i.childNodes[0].className+"").indexOf("color1")&&$(i).remove(),$("#"+e).remove(),k.sendToServer(t)}else 7==t.m?k.showTip("请进入人工服务后再发送位置消息"):k.showTip("请继续对话后再发送消息")}}).on("click",".btn-restart",function(){view.handleNetwok&&view.handleNetwok()||("restartChat"==$(this).attr("id")&&setTimeout(function(){k.publish("restartChat")},10),$(".btn-restart").removeAttr("id").removeClass("btn-restart"),$(this).removeAttr("id").removeClass("btn-restart").text(lanRes.chatContinued))}),this.subscribe("displayRouterInfo",function(e,t){var a,n=t.routeEntranceInfo;a="string"==typeof n.entranceDetails?JSON.parse(n.entranceDetails):n.entranceDetails,n.chatBoxTitle?(view.pageTitle=n.chatBoxTitle,k.changeDocTitle(n.chatBoxTitle),k.publish("__setTitle",n.chatBoxTitle)):k.publish("__setTitle",lanRes.onlineService);var i=n.routeStatusList,s={};if(i&&i.length)for(var o=0;o<i.length;o++)s[i[o].routeId]=2!=i[o].routeStatus;for(var r='<div id="routerTitle" class="router-title '+(n.title?"":"router-hide")+'">'+n.title+'</div><div id="routerList" class="router-list"><ul class="clearfix">',l=0,d=n.lines,c=n.chosenColor||"#0da7db",u=0;u<a.length;u++){var f=a[u].routeId;if(f){l++,s[f]||(a[u].icon=a[u].offlineIcon||a[u].icon,a[u].content=a[u].offlineContent||a[u].content);var m=l%d==0;k.needHttps&&a[u].icon&&(a[u].icon=a[u].icon.replace(/^http:/,k.needHttps)),r+='<li class="router-item router-item-content'+(a[u].icon&&!a[u].content?1:a[u].icon&&a[u].content?2:!a[u].icon&&a[u].content?3:a[u].icon||a[u].content?"":3)+'" data="'+f+'" dataindex="'+u+'" '+(m?'style="border-right:none;"':"")+'><div class="router-item-content"><div class="router-item-icon '+(a[u].icon?"":"router-hide")+'">'+(a[u].icon?'<img onload="view.checkImg&&view.checkImg(this)" src="'+a[u].icon+'"/>':"")+"</div>"+(1==view.windowType?'<div class="router-item-text '+(a[u].content?"":"router-hide")+'">'+(a[u].content?'<div class="router-item-text-bg" style="background:'+c+';"></div><div class="router-item-text-tx">'+a[u].content+"</div>":"")+"</div>":"")+'</div><div class="router-item-theme">'+a[u].theme+"</div></li>"}}if(r+="</ul></div>",k.publish("removeLoading"),0==l)ECHATObjKeyMap.cometdId.waitForRouterSelect=!1,$("#router").hide();else{$("#loading").hide(),$("#mask").show();var h,p=150*d;$("#router").addClass("router-line"+d).html(r).css({width:view.px2rem?view.px2rem(p):p+"px",marginLeft:view.px2rem?view.px2rem(-p/2):-p/2+"px"}).show().removeClass("slideUp"),k.isMobile||$(".router-item").on("mouseover touchstart",function(e){$(this).addClass("hover"),$(".router-item-theme",this).css({background:c,color:"#FFF"})}).on("mouseout touchend",function(e){$(this).removeClass("hover"),$(".router-item-theme",this).css({background:"#fff",color:"#323232"})}),$(".router-item").off("click").on("click",function(e){var t=$(this).attr("dataindex"),i=$(this).attr("data");i&&a[t]&&a[t].routeId==i&&(k.routeId=i,k.routeEntranceTheme=a[t].theme,k.paramChat.echatTag=a[t].routeEntranceEchatTag||k.routeEntranceTheme,$("#loading").show(),k.publish("routerSelect"),k.publish("toSetID"),$("#router").hide(),$("#mask").hide(),ECHATObjKeyMap.cometdId.waitForRouterSelect=!1,n=a=null)}),view.handleRouterSelect&&view.handleRouterSelect(l,d)||(h=$("#router").height()||200,$("#router").css({marginTop:-h/2+"px"}))}}),this.subscribe("getLeaveReply",function(e,t){t.content&&k._getMsg(t,0,t.content),928!=t.from&&k.publish("toSetID")}),this.subscribe("getNewUnreadMsgCount",function(e,t){500002!=t.platformId&&500003!=t.platformId&&20!=t.platformId||k.showTip("收到685"+t.lastMsgContent),view.handleNewUnreadMsgCount&&view.handleNewUnreadMsgCount(t),k.sendMsgboxUnread.send(t)}),this.subscribe("updateVisitorInfo",function(e,t){var i,a;k.visitorId!=t.visitorId&&(i="CHAT_HIS_"+window.companyId+"_"+t.visitorId,k.historyKey&&i!=k.historyKey&&(k.historyKey=i,k.hasStorage&&(a=window.localStorage.getItem(i))&&(window.localStorage.removeItem(k.historyKey),window.localStorage.setItem(i,a))),k.visitorId=t.visitorId),t.photo&&k.visitorImg!=t.photo&&($(".avatar-icon-img").each(function(e){-1!=this.parentNode.className.indexOf("fr")&&(this.src=t.photo)}),k.visitorImg=t.photo)}),this.uploadUtil=(s=1,o=[],(i={}).setUploadService=function(e){s=(o=e)[0].uploadServiceType||1},i.getUploadServiceType=function(e){return s=o[0].uploadServiceType},i.getNextUploadType=function(e){var t,i=o.length,a=o[i-1].uploadServiceType;if((e=e||s)==a)return!1;for(var n=0;n<i;n++){if(t)return o[n].uploadServiceType;o[n].uploadServiceType==e&&(t=n+1)}return!1},i.getLastUploadType=function(){return o[o.length-1].uploadServiceType},i),this.subscribe("setVisitorInfo",function(e,i){if(k.msg600=i,k.visitorImg=i.photo,k.visitorId=i.visitorId,k.companyId=i.companyId,k.appId=i.appId,k.appSecrect=i.appSecrect,window.encryptVID=i.encryptVID,k.isVip=1==i.visitorType,k.visitorType=i.visitorType,i.uploadFileSize&&(k.uploadFileSize=i.uploadFileSize||5242880,k.uploadFileType=i.uploadFileType),k.qiniuDomain=i.qiniuBucketDomain,k.qiniuHttpsDomain=i.qiniuBucketHttpsDomain,k.platformName=i.platformName,k.platformLogo=i.platformLogo,k.companyName=i.companyName,k.companyLogo=i.companyLogo,k.companyMobileSite=i.companyMobileSite,k.companyWebSite=i.companyWebSite,k.sendMsgboxUnread.init(function(e){view.__nativeAPI&&view.__nativeAPI("platformNewMsg",k.formatUnreadMsg.call(k,e)),500002!=e.platformId&&500003!=e.platformId||k.showTip("platformNewMsg"+JSON.stringify(e))}),k.publish("initPageStatus",{companyId:k.companyId,companyName:k.companyName}),first600=1,k.apiServerDomain=i.apiServerDomain,i.fileUploadInfos&&(k.uploadUtil.setUploadService(i.fileUploadInfos),k.fileUploadInfos=function(){i.fileUploadInfos=i.fileUploadInfos;for(var e={},t=0;t<i.fileUploadInfos.length;t++)e["uploadServiceType"+i.fileUploadInfos[t].uploadServiceType]=i.fileUploadInfos[t];return e}()),k.historyKey||(k.historyKey="CHAT_HIS_"+window.companyId+"_"+i.visitorId,k.hasPreHis=k.checkHistory(),k.isIOS&&2==view.windowType&&k.postMessage({type:"initLocalHistory",key:k.historyKey})),1==i.limitVisitorInputContentLengthEnable&&!a){var t=k.inputMaxLength=i.visitorInputContentMaxLength;a=!a,$("#inputLengthTip").html(lanRes.inputLengthTip1+t+lanRes.inputLengthTip2),$("#inputLengthTip").show(),setTimeout(function(){var e=k.getInputDoc().getElementsByTagName("body")[0];e.addEventListener?(e.addEventListener("keydown",function(e){n(e,t)}),e.addEventListener("paste",function(e){n(e,t)})):(e.attachEvent("onkeydown",function(e){n(e,t)}),e.attachEvent("onpaste",function(e){n(e,t)}))},200)}}),k.oldBodyEnterText="",this.subscribe("setChatParam",function(e,t){k.paramChat.country=t.country||"",k.paramChat.province=t.province||"",k.paramChat.city=t.city||"",k.paramChat.searcher=t.searcher||"",k.paramChat.keyword=t.keyword||"",k.paramChat.firstUrl=k.paramChat.firstUrl||t.firstUrl,k.paramChat.referrer=k.paramChat.referrer||t.referrer,k.paramChat.companyId=k.companyId,k.paramChat.visitorId=k.visitorId,k.paramChat.osName=k.queryParams.osName,view.canSetAD++,view.setAD&&view.setAD()}),this.subscribe("setRestartTag",function(e,t){k.restartParam={nonce:t.nonce,reChatTag:t.reChatTag},t.talkId&&!k.talkId&&t.notStore&&(k.talkId=t.talkId),$.store("ECHAT_talkId",t.talkId),k.hasPreHis=k.checkHistory(),view.noScrollBottom=!1}),k.isAutoPop="1"==k.queryParams.autoPop,this.subscribe("handshakeOk",function(e,t){k.robotToHumanKey=null,$("#restartChat").text(lanRes.chatContinued),$(".btn-restart").removeAttr("id").removeClass("btn-restart")}),this.subscribe("changeToPlatform",function(e,t){k.platformData=t,k.paramChat.echatTag=t.echatTag}),this.subscribe("toSetID",function(e,t){k.talkId="",k.no103=!1;var i,a=a;if(k.companyOff=a,k.publish("__chatStatus","registerChat"),view.SDKNative)return i={et:109},k.routeId&&(i.routeId=k.routeId,i.routeEntranceTheme=k.routeEntranceTheme,i.echatTag=k.paramChat.echatTag),k.robotToHumanKey&&(i.robotToHumanKey=k.robotToHumanKey),(n=k.data109)?(n.visEvt&&(i.visEvt=n.visEvt),n.routeId&&(i.routeId=n.routeId),n.routeEntranceTheme&&(i.routeEntranceTheme=n.routeEntranceTheme)):k.data109=i,void k.publish("__registChatAction",i);i={et:109,windowType:view.windowType,companyId:k.companyId,page:k.paramChat.chatPage||a,title:k.paramChat.chatPageTitle||a,firstEnterUrl:k.paramChat.firstUrl||a,firstEnterTitle:k.paramChat.firstTitle||a,referrer:k.paramChat.referrer||a,media:k.Device.media,browserName:k.Browser.browser,browserVersion:k.Browser.version,osName:k.queryParams.osName||k.Device.OS.toLowerCase(),screenResolution:window.screen.width+"x"+window.screen.height,echatTag:k.paramChat.echatTag||a,routerId:k.queryParams.routerid||a,departmentId:k.queryParams.departmentid||a,routeEntranceId:k.queryParams.routeentranceid||a,styleId:k.queryParams.styleid||a,multipleFile:k.queryParams.multiplefile||0},view.SDK&&(i.webSdk=1),k.robotToHumanKey&&(i.robotToHumanKey=k.robotToHumanKey),"1"==k.queryParams.autoPop&&k.isAutoPop&&(i.isAutoPop=1),"1"==k.queryParams.acceptInvite&&(i.acceptInvite=1),k.routeId&&(i.routeId=k.routeId,i.routeEntranceTheme=k.routeEntranceTheme);var n,s=k.queryParams.visitorid;if(s&&(i.visitorId=s,i.chatToken=k.queryParams.chattoken,i.tm=k.queryParams.tm,k.chatToken=i.chatToken),k.restartParam&&$.extend(i,k.restartParam),1==k.toLeaveWord&&(i.toLeaveWord=1,k.toLeaveWord=a),k.staffChatNeedConnect=!1,window.isInPlatform&&k.platformData&&(i.companyId=k.platformData.platfromId,i.routeId=k.platformData.routeId,i.echatTag=k.platformData.echatTag,i.toPlatformToken=k.platformData.toPlatformToken),k.paramChat.visEvt){var o=JSON.parse(k.paramChat.visEvt);function r(e){return e?e.replace(/<(?:.|\s)*?>/gi,""):e}i.visEvt={customizeMsgType:2,dedup:1,eventId:o.eventId,title:r(o.title),content:o.content,imageUrl:o.imageUrl,url:o.url,urlForVisitor:o.urlForVisitor,urlForStaff:o.urlForStaff,memo:r(o.memo),visibility:o.visibility,urlEnableForVisitor:o.urlEnableForVisitor,closeURLPage:o.closeURLPage},k.initVisEvt=k.paramChat.visEvt,k.paramChat.visEvt=null,delete k.paramChat.visEvt}(n=k.data109)?(n.visEvt&&(i.visEvt=n.visEvt),n.routeId&&(i.routeId=n.routeId),n.routeEntranceTheme&&(i.routeEntranceTheme=n.routeEntranceTheme)):k.data109=i,k.publish("visitorCommonEvent",i),k.postMessage(2)}),"1"!=k.queryParams.autoPop&&"1"!=k.queryParams.acceptInvite||this.subscribe("_firstSendMsg",function(e,t){"0"==k.queryParams.autoChat&&(delete k.queryParams.autoChat,k.publish("toRegisterChat",t),delete k.queryParams.autoPop,k.isAutoPop=!1),"1"==k.queryParams.acceptInvite&&(k.queryParams.acceptInvite=void 0,delete k.queryParams.acceptInvite),this.unSubscribe("_firstSendMsg")}),this.subscribe("toRegisterChat",function(e,t){if("0"!=k.queryParams.autoChat&&(k.talkId="",!k.no103)){if(k.no103=!0,view.SDKNative)return a={et:103},k.eventId&&(a.eventId=k.eventId),console.log("__registChatAction",new Date),void k.publish("__registChatAction",a);var i=i,a={et:103,windowType:view.windowType,page:k.paramChat.chatPage||i,title:k.paramChat.chatPageTitle||i,firstEnterUrl:k.paramChat.firstUrl||i,firstEnterTitle:k.paramChat.firstTitle||i,referrer:k.paramChat.referrer||i,media:k.Device.media,browserName:k.Browser.browser,browserVersion:k.Browser.version,osName:k.queryParams.osName||k.Device.OS,screenResolution:window.screen.width+"x"+window.screen.height,echatTag:k.paramChat.echatTag||i};t&&t.code&&(a.captcha=t.code),"1"==k.queryParams.acceptInvite&&(a.acceptInvite=1),k.routeId&&(a.routeId=k.routeId,a.routeEntranceTheme=k.routeEntranceTheme),k.eventId&&(a.eventId=k.eventId),"1"==k.queryParams.autoPop&&(a.isAutoPop=1,t&&t.c&&(a.visitorWords=t.c)),k.publish("visitorCommonEvent",a,function(e){!0===e.successful&&k.publish("_pushVisitorEvent")})}}),this.subscribe("removeLoading",function(e,t){k.wait874List||($("#loading").hide(),window.resizeFunc&&window.resizeFunc(),k.hasEntryOrCode||($("#mask").hide(),$("#verify").hide()),$(".btn-close").removeClass("hide"),t&&k.initQcode())}),this.initQcode=function(){(!0!==k.companyOff&&!k.hasLeaveMsg||k.isInRobot)&&(k.isMobile||(k.showQcode?($(".btn-qcode").removeClass("hide"),_$("qcode_img").setAttribute("loaded",""),_$("qcode_img").removeAttribute("loaded")):k.showQcode=k.toShowQcode()))},this.getLeaveConfig=function(e,t){var i=e.offlineBoxInfo||e.offlineSmallBoxInfo||e.mobileOfflineBoxInfo||e.sdkOfflineBoxInfo;return!i&&k.msg649&&(i=k.msg649.offlineBoxInfo||k.msg649.offlineSmallBoxInfo||k.msg649.mobileOfflineBoxInfo||k.msg649.sdkOfflineBoxInfo),i},this.subscribe("toLeavePage",function(e,t,i){var a,n=!(k.companyOff=!0),s=k.getLeaveConfig(t),o=!1;if(k.leaveAndClose){n=!1;var r="msg"+(c=(new Date).getTime()),l={t:k.checkHistoryTime(c)?(new Date).format("hh:mm"):void 0,tm:c,mt:864,f:"c",m:0,hide:!0,c:k.entryVisitorMsg,id:r};k.entryVisitorMsg&&k.sendToServer(l),k.publish("__chatStatus","leaveToService");var d=$.extend({},l);d.c=k.entryLeaveContent,k.sendToServer(d,void 0,function(){k.visitorClose=!0,d.c.trim()&&h(lanRes.leavelSuc.alt,"ok"),k.publish("sendVisitorEvent",{et:107}),setTimeout(function(){k.leaveAndClose=!1,k.entryLeaveContent=void 0},2e3)}),k.entryVisitorMsg=null}else if(s&&1==s.enable){if(i||(n=k.showEntryAndCode(t,!1)),n||k.publish("__chatStatus","leaveToService"),k.leaveAndClose&&$("#staffName").html("<span>"+lanRes.leaveWord+"</span>"),view.hideStaffInfo&&view.hideStaffInfo(),k.entryVisitorMsg){var c;r="msg"+(c=(new Date).getTime()),l={t:k.checkHistoryTime(c)?(new Date).format("hh:mm"):void 0,tm:c,mt:864,f:"c",m:0,hide:!0,c:k.entryVisitorMsg,id:r};k.sendToServer(l),k.entryVisitorMsg=null}view.showURLList&&!view.SDK&&($(".menu-more").hide(),view.hideMenus()),view.handleLeave&&view.handleLeave("leaveToService",t)}else{if(s&&2==s.enable&&s.thirdPartyUrl){function u(){a&&1==s.enableThirdPartyParams&&s.thirdPartyParams&&(a=function(e,t,i){for(var a="",n=e.split("#"),s=n[1]||"",o=n[0],r=-1==o.indexOf("?")?0:1,l=0,d=t.length;l<d;l++){var c=t[l].paramName;"metaData"!=c&&"metadata"!=c||(c="metaData"),i[c]&&(a+=(0!=r?"&":"?")+c+"="+encodeURIComponent(i[c]||""),r++)}return o+a+(s?"#"+s:"")}(a,s.thirdPartyParams,k.paramChat)),$("body").html(""),view.SDK?view.__nativeAPI("jumpToUrl",a):location.href=a}return k.publish("__chatStatus","leaveToUrl"),k.publish("__leaveToUrl",s.thirdPartyUrl),a=s.thirdPartyUrl,void(view.SDKNative&&window.setVisitorInfo?setTimeout(function(){u()},200):u())}if(!s||0==s.enable||s&&2==s.enable&&!s.thirdPartyUrl){o=!0,k.publish("__chatStatus","leaveDisabled"),$("#inputPlaceholder").html(lanRes.disablePlaceholder),$("#footer").addClass("leave-disabled");var f=U.createElement("div");f.className="mask-disabled",$("#footer").append(f),$(U).off(),s&&view.handleLeave&&view.handleLeave("leaveDisabled",t),setTimeout(function(){k.publish("_endConnect"),k.companyOff=!0},200),view.hideStaffInfo&&view.hideStaffInfo(),view.showURLList&&($(".menu-more").hide(),view.hideMenus())}}$(".btn-qcode").addClass("hide"),k.publish("removeLoading"),(n||o)&&$("#mask").show(),view.hideServiceIcon&&view.hideServiceIcon(),k.postMessage("toLeaveMessage")}),this.subscribe("refreshVerify",function(e,t){$("#verify_change").removeClass("loadin"),0==t.status||1==t.status&&$("#verify_input").addClass("error"),k.no103=!1,$("#verify_img").attr("src",k.dataHost+"/chatCaptCha.jpg?captChatToken="+t.captChaToken)}),this.bookformi=0,this.getBookComfirm=function(e){if(!e||!e[0])return e||"";var t;if(!(t=1==view.windowType&&1==e[0].type||1!=view.windowType&&3==e[0].type?e[0]:e[1])||!t.configuration)return"";var i=this.bookformi++,a=t.configuration,n=a.length,s=q(a);k.needHttps&&t.backImg&&(t.backImg=t.backImg.replace(/^http:/,k.needHttps));for(var o=' <div id="inviteBook'+i+'" class="book-table '+(3==t.type?"book-table-sm":"book-table-bg")+("1"==s?" book-all-line":"")+'" >'+(t.backImg?'<div><img onerror="view.imgError&&view.imgError(this)" id="inviteBookImg'+i+'" class="book-table-img hide" src="'+t.backImg+'" onload="imgLoadResize(this,'+i+')" /></div>':"")+'<form id="inviteBookForm'+i+'" class="book-items" onsubmit="return false;"> <div class="clearfix book-items-list" style="'+t.formPos+';">',r=0;r<n;r++){var l=a[r],d=1==l.configRequired?"req":"";o+='<div class="book-half book-item '+("1"==l.configInline?"book-one-line":"")+'"><label class="book-label" style="color:'+t.labelColor+'">'+l.configDesc+"</label>"+("gender"==l.configName?'<input type="text" lb="'+l.configDesc+'" class="book-ipt '+d+'" name="'+l.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"  value="'+(2==l.configValue?lanRes.female:1==l.configValue?lanRes.male:"")+'" readonly="readonly" />':"maritalStatus"==l.configName?'<input type="text" lb="'+l.configDesc+'" class="book-ipt '+d+'" name="'+l.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"  value="'+(2==l.configValue?lanRes.married:1==l.configValue?lanRes.unmarried:"")+'" readonly="readonly" />':'<input type="text" lb="'+l.configDesc+'" class="book-ipt '+d+'" name="'+l.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"  value="'+(l.configValue||"")+'" readonly="readonly" />')+"</div>"}return o+="</div></form></div>",setTimeout(function(){var e=_$("inviteBookForm"+i);if(e){var t=e.offsetHeight+(view.px2px?view.px2px(20):20)+e.offsetTop;_$("inviteBookLi"+i).style.minHeight=t+"px"}},1e3),'<li id="inviteBookLi'+i+'" class="clearfix book-confirm-wrap">'+o+"</li>"},this.showEntryAndCode=function(e,t){var i=!1,a=e.entranceInfo||e.smallEntranceInfo||e.mobileEntranceInfo||e.sdkEntranceInfo,n=a&&1==a.visitorInfoEnable&&(t?1==a.enableOnline:1==a.enableOffline);return k.leaveAndCloseConfig&&!0===k.companyOff&&(a=k.leaveAndCloseConfig,n=!0),n&&k.toShowEntry(a,e)?($("#verify").hide(),i=!0):e.captChaToken?($("#entry").html("").hide(),$(".verify-change").attr("id","verify_change"),$(".verify-img").attr("id","verify_img"),$(".verify-ok").attr("id","verify_ok"),$(".verify-input").attr("id","verify_input"),k.publish("removeLoading"),k.toShowCode(),$("#verify_img").attr("src",k.dataHost+"/chatCaptCha.jpg?captChatToken="+e.captChaToken),$("#verify").show(),$("#mask").show(),i=!0):n&&(k.publish("entryCallback",{success:!0,mt:670}),i=!1),i&&(!0!==k.companyOff?k.publish("__setTitle",lanRes.onlineService):k.publish("__setTitle",lanRes.leaveWord)),k.hasEntryOrCode=i},this.subscribe("initRobot",function(e,t){k.needHttps&&t.robotConfigInfo.robotImg&&(t.robotConfigInfo.robotImg=t.robotConfigInfo.robotImg.replace(/^http:/,k.needHttps)),k.staffImg=t.robotConfigInfo.robotImg,k.staffName=t.robotExtInfo&&t.robotExtInfo.nickName||lanRes.robot,k.robotExtInfo=t.robotExtInfo||{},k.paramChat.staffId="-1",k.paramChat.staffName=k.staffName,k.paramChat.staffPhoto=k.staffImg,view.initRobotInfo&&view.initRobotInfo(t),k.bindPlainTextEvent(),view.setInnerAD(t),k.robotWordsInfo=t.robotWordsInfo,$("#toHumanWords").html(t.robotWordsInfo.toHumanWords||""),$("#textInput").attr("placeholder",t.robotWordsInfo.inputBoxWords||lanRes.inputPlaceholder2);var i=k.isVip?view.SDK?t.sdkVipVisitorRobotConfig:t.webVipVisitorRobotConfig:view.SDK?t.sdkVisitorRobotConfig:t.webVisitorRobotConfig;if($("#robotToStaff").hide(),"1"==i.enableManualSwitch?(!0===k.companyOff?($("#robotToStaffWord").html(lanRes.leaveWord),"1"==i.enableLeaveBtnWhenStaffOffline&&($("#robotToStaff").show(),y(k))):($("#robotToStaffWord").html(lanRes.robotToStaff),"1"==i.enableSwitchBtnWhenStaffOnline&&($("#robotToStaff").show(),y(k))),view.handleShowRobotToStaff&&view.handleShowRobotToStaff()):$("#robotToStaff").remove(),"1"==t.robotWordsInfo.enableFedBack){var s=t.robotWordsInfo;"string"==typeof s.solvedSubitem&&(s.solvedSubitem=JSON.parse(s.solvedSubitem)),"string"==typeof s.unsolvedSubitem&&(s.unsolvedSubitem=JSON.parse(s.unsolvedSubitem)),k.needHttps&&(s.solvedButton&&(s.solvedButton=s.solvedButton.replace(/^http:/,k.needHttps)),s.unsolvedButton&&(s.unsolvedButton=s.unsolvedButton.replace(/^http:/,k.needHttps))),s.solvedSubitem||s.unsolvedSubitem?!view.dji||s.unsolvedWords||s.solvedWords?k.robotFeedback=function(e){var t=(e=e||{}).answerItem,i="",a='<div class="feedback-tip">'+(s.fedBackWords||"")+'</div><div class="feedback-tag"><i class="feed-icon-sel"></i><span>'+lanRes.hasSelected+'</span></div><div class="feedback-btns clearfix"><div class="feedback-btn-solve '+(1==e.feedback?"feedback-btn-solve-sel":"")+(view.dji&&!s.solvedWords?" hide":"")+'" type="1">'+(s.solvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+s.solvedButton+'"/>':"")+"<span>"+(s.solvedWords||"")+'</span></div><div class="feedback-btn-unsolve '+(2==e.feedback?"feedback-btn-unsolve-sel":"")+(view.dji&&!s.unsolvedWords?" hide":"")+'" type="2">'+(s.unsolvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+s.unsolvedButton+'"/>':"")+"<span>"+(s.unsolvedWords||"")+"</span></div></div>";if(t){if(2!=e.feedback&&s.solvedSubitem&&0<s.solvedSubitem.length){i+='<div class="feedback-sub-solved"><div class="robot-tip">'+lanRes.solvedReason+'</div><ul class="feedback-sub-list '+(e.feedbackSubitem?"robot-feedback-sub-had":"")+'" did="'+t.docId+'" qid="'+t.queryId+'" rid="'+t.robotDetailId+'" searchId="'+t.searchId+'" originQuestion="'+escape(t.originQuestion)+'">';for(var n=0;n<s.solvedSubitem.length;n++)i+='<li class="feedback-sub-li sub-solved-li '+(e.feedbackSubitem==s.solvedSubitem[n].content?"feedback-sub-sel1":"")+'"><span class="list-style-dot">'+(n+1)+'.</span><span class="feedback-sub-content" type="1">'+s.solvedSubitem[n].content+"</span></li>";i+="</ul></div>"}if(1!=e.feedback&&s.unsolvedSubitem&&0<s.unsolvedSubitem.length){i+='<div class="feedback-sub-unsolved"><div class="robot-tip">'+lanRes.unsolvedReason+'</div><ul class="feedback-sub-list '+(e.feedbackSubitem?"robot-feedback-sub-had":"")+'" did="'+t.docId+'" qid="'+t.queryId+'" rid="'+t.robotDetailId+'" searchId="'+t.searchId+'" originQuestion="'+escape(t.originQuestion)+'">';for(n=0;n<s.unsolvedSubitem.length;n++)i+='<li class="feedback-sub-li sub-unsolved-li '+(e.feedbackSubitem==s.unsolvedSubitem[n].content?"feedback-sub-sel2":"")+'"><span class="list-style-dot">'+(n+1)+'.</span><span class="feedback-sub-content" type="2">'+s.unsolvedSubitem[n].content+"</span></li>";i+="</ul>"}}return a+i+"</div></div>"}:k.robotFeedback=!1:k.robotFeedback=function(e){return e=e||{},'<div class="feedback-tip">'+(s.fedBackWords||"")+'</div><div class="feedback-tag"><i class="feed-icon-sel"></i><span>'+lanRes.hasSelected+'</span></div><div class="feedback-btns clearfix"><div class="feedback-btn-solve '+(1==e.feedback?"feedback-btn-solve-sel":"")+'" type="1">'+(s.solvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+s.solvedButton+'"/>':"")+"<span>"+(s.solvedWords||"")+'</psan></div><div class="feedback-btn-unsolve '+(2==e.feedback?"feedback-btn-unsolve-sel":"")+'" type="2">'+(s.unsolvedButton?'<img onerror="view.imgError&&view.imgError(this)" src="'+s.unsolvedButton+'"/>':"")+"<span>"+(s.unsolvedWords||"")+"</span></div></div></div></div>"};var a=k.getCSSRule(".feedback-btn-solve");a&&s.solvedBackColor&&(a.style.backgroundColor=s.solvedBackColor),(a=k.getCSSRule(".sub-solved-li"))&&s.solvedBackColor&&(a.style.backgroundColor=s.solvedBackColor),(a=k.getCSSRule(".feedback-btn-solve-sel"))&&s.solvedSelectColor&&(a.style.backgroundColor=s.solvedSelectColor),(a=k.getCSSRule(".feedback-sub-sel1"))&&s.solvedSelectColor&&(a.style.backgroundColor=s.solvedSelectColor),(a=k.getCSSRule(".feedback-btn-unsolve"))&&s.unsolvedBackColor&&(a.style.backgroundColor=s.unsolvedBackColor),(a=k.getCSSRule(".sub-unsolved-li"))&&s.unsolvedBackColor&&(a.style.backgroundColor=s.unsolvedBackColor),(a=k.getCSSRule(".feedback-btn-unsolve-sel"))&&s.unsolvedSelectColor&&(a.style.backgroundColor=s.unsolvedSelectColor),(a=k.getCSSRule(".feedback-sub-sel2"))&&s.unsolvedSelectColor&&(a.style.backgroundColor=s.unsolvedSelectColor)}else k.robotFeedback=!1;k.unSubscribe("_sendQuestion"),k.subscribe("_sendQuestion",function(e,t){k.publish("sendVisitorEvent",{et:130,docId:t.docId,originDocId:t.originDocId,content:t.content}),k._getMsg({mt:130,ff:"r",tm:(new Date).getTime()},0,t.content,"c"),$("#input_suggest").addClass("hide").html(" ")}),k.lastText=null,k.typingTimer&&clearTimeout(k.typingTimer);var n,o=12059==k.companyId?500:1500;if(k.hasInputAssociation){k.typingTimer=setTimeout(function e(){var t=k.getInput(!1);t||$("#input_suggest").addClass("hide").html(" "),!t||k.lastText==t&&n==t||(k.lastText=t,k.publish("sendVisitorEvent",{et:132,content:k.lastText})),k.typingTimer=setTimeout(e,o),n=t},o)}k.openVisitorSend(),$("#toolbar").addClass("robot"),$("body").addClass("robot"),k.publish("onceStartRobot"),k.subscribe("_showCommonQue",r)}),k.maxRobotLength=100,$("#inputLengthTip").html(lanRes.inputLengthTip1+" "+k.maxRobotLength+" "+lanRes.inputLengthTip2),k.handleInputLength=function(){var e;view.chat.isInRobot&&function(e,t){for(var i=0,a=(t=2*t,0),n=0;n<e.length;n++){if(null!=e.charAt(n).match(/[^\x00-\xff]/gi)?(i+=2,a+=1):i+=1,t<=i)return k.setInput(e.substr(0,i-a)),$("#inputLengthTip").html(lanRes.inputLengthTip1+" 0 "+lanRes.inputLengthTip2);var s=t/2-(parseInt(i/2)+i%2);$("#inputLengthTip").html(lanRes.inputLengthTip1+" "+s+" "+lanRes.inputLengthTip2)}}(e=k.getInput(),k.maxRobotLength),(view.chat.isInRobot||view.SDK)&&view.urlList&&(e||k.getInput()?($(".menu-more").hide(),$("#enter_btn").removeClass("hide")):($(".menu-more").show(),$("#enter_btn").addClass("hide")))},this.subscribe("onceStartRobot",function(e,t){k.unSubscribe("onceStartRobot"),view.urlList&&($("#menu_more_robot").show(),$("#enter_btn").addClass("hide")),$("#list_msg").on("click",".common-ques-li",function(e){k.publish("_sendQuestion",{docId:$(this).attr("did"),content:unescape($(this).attr("ques"))})}),$("#robotToStaffWord").on("click",function(){$("#inputLengthTip").html(lanRes.inputLengthTip1+k.inputMaxLength+lanRes.inputLengthTip2),"disconnected"==EChatQuery.cometd.getStatus()||k.isInRobot&&k.publish("sendVisitorEvent",{et:131}),k.getInputDocBody().blur()}),$("#input_suggest").on("click",".ipt-list-li",function(e){view.handleNetwok&&view.handleNetwok()||(k.setInput(unescape($(this).attr("ques"))),k.isInRobot&&(k.publish("_sendQuestion",{docId:$(this).attr("did"),content:unescape($(this).attr("ques"))}),k.getInput(!0)&&view.afterSend()))}),$("#list_msg").on("click",".question-list-li",function(e){k.publish("_sendQuestion",{docId:$(this).attr("did"),originDocId:$(this).attr("oid"),content:unescape($(this).attr("ques"))})}),$("#list_his").on("click",".feedback-btn-unsolve",function(e){var t=this.parentNode.parentNode,i=$(t).attr("did");if(i){view.chat.lastFeedBack=t,k.publish("sendVisitorEvent",{et:133,docId:i,queryId:$(t).attr("qid"),robotDetailId:$(t).attr("rid"),searchId:$(t).attr("searchId"),originQuestion:unescape($(t).attr("originQuestion")),feedBack:$(this).attr("type")}),$(t).attr("did","").addClass("robot-feedback-had robot-feedback-had2"),$(this).addClass("feedback-btn-unsolve-sel");var a=$(this).parents(".msg-robot").attr("id");a&&view.scrollToBottom(a)}}).on("click",".feedback-btn-solve",function(e){var t=this.parentNode.parentNode,i=$(t).attr("did");if(i){view.chat.lastFeedBack=t,k.publish("sendVisitorEvent",{et:133,docId:i,queryId:$(t).attr("qid"),robotDetailId:$(t).attr("rid"),searchId:$(t).attr("searchId"),originQuestion:unescape($(t).attr("originQuestion")),feedBack:$(this).attr("type")}),$(t).attr("did","").addClass("robot-feedback-had robot-feedback-had1"),$(this).addClass("feedback-btn-solve-sel");var a=$(this).parents(".msg-robot").attr("id");a&&view.scrollToBottom(a)}}).on("click",".feedback-sub-content",function(e){var t=this.parentNode.parentNode,i=$(t).attr("did");if(i){var a=$(this).attr("type");k.publish("sendVisitorEvent",{et:133,docId:i,queryId:$(t).attr("qid"),robotDetailId:$(t).attr("rid"),searchId:$(t).attr("searchId"),originQuestion:unescape($(t).attr("originQuestion")),feedBackSubitem:this.innerText||this.textContent||this.innerHTML}),$(t).attr("did","").addClass("robot-feedback-sub-had"),$(this.parentNode).addClass("feedback-sub-sel"+a)}})}),this.subscribe("endRobot",function(e,t){k.data109=null,k.typingTimer&&clearTimeout(k.typingTimer),k.isInRobot=0,$("#toolbar").removeClass("robot"),$("body").removeClass("robot"),$("#robotToStaff").hide(),k.isMobile&&view.hideMenus(),$(".robot-staff").removeClass("robot-staff"),k.unSubscribe("_sendQuestion"),k.robotTalkId&&k.handleSessionMsg({talkId:k.robotTalkId}),k.robotTalkId=null,k.staffName="",k.staffImg=void 0,k.staffId=void 0,delete k.paramChat.staffId,delete k.paramChat.staffName,delete k.paramChat.staffPhoto,delete k.paramChat.talkId,k.isMobile||k.changeToIframe(),$("#textInput").attr("placeholder",lanRes.mbTextareaInput.placeholder)}),$(".leave-bar-btn").on("click",function(){k.publish("restartChat")}),$(".robot-staff-close").on("click",function(){var e=this.parentNode;$(e).addClass("hide").hide(),view.handleShowRobotToStaff&&view.handleShowRobotToStaff(),y(k,"close")}),k.unSubscribe("getCrossMessage"),k.subscribe("getCrossMessage",function(e,t){var i=t.data,a=t.source;if(i)if(k.hasSearchInSameScreen&&"robot"==i.evt)"question"==i.type&&i.content&&k.publish("_sendMsg",i.content);else if("echatjs"==i.evt)if("echatInnerFrame"==i.type&&a)try{a.postMessage({type:"echatInnerFrameCallback",companyId:k.companyId,visitorId:k.visitorId,chatVisitorId:window.chatVisitorId,encryptVID:window.encryptVID,metaData:k.queryParams.metadata||"",inChatPage:!0},i.origin)}catch(e){}else"openChat"==i.type?((k.isMobile||2==view.windowType)&&view.hideURLSite&&view.hideURLSite(),k.publish("_triggerChat",i)):"closeFramePage"==i.type?(view.hideURLSite?view.hideURLSite():view.hideRightUrl&&view.hideRightUrl(i),view.__nativeAPI&&view.__nativeAPI("closeUrlView")):"sendTextMsg"==i.type&&k.publish("_sendMsg",i.content)});var l=k.isMobile?"touchend":"click";$("#chat").on(l,".robot-staff",function(){k.isInRobot&&k.publish("sendVisitorEvent",{et:131})}).on(l,".end-chat",function(){k.visitorCloseFunc()}).on(l,".to-leave-word",function(){k.outerChatStatus&&k.outerChatStatus.match(/waiting|chatting|robot/)&&(k.toLeaveWord=1,k.publish("sendVisitorEvent",{et:107,toLeaveWord:1},function(){}))}),k.subscribe("_triggerChat",function(e,t){if("disconnected"==$.cometd.getStatus()||"sdk"==$.cometd.getStatus()){if("block"==_$("satisfy").style.display){if(t&&"showMiniChat"==t.action)return;$("#satisfy").hide(),$("#mask").hide()}setTimeout(function(){view.chat.publish("restartChat")},15),$("#restartChat").text(lanRes.chatContinued),$(".btn-restart").removeAttr("id").removeClass("btn-restart")}else k.isMobile||"firefox"!=k.Browser.browser&&k.focusInput()}),$("#content").on("click",".msg-leave",function(){var e,t=$(this).attr("k"),i=k.leaveMsgMap[t],a=(view.SDK||k.needHttps?"https:":"http:")+"//"+k.apiServerDomain+"/chatapi/paodm/qd?companyId="+k.companyId+"&visitorId="+i.visitorId+"&chatInfoType="+i.chatInfoType+"&talkId="+i.newsMsgId+"&tm="+i.tm+"&token="+i.signature;if(e=view.SDKNative?window.locationBase+"/visitor/common/record.html?lan="+window.lanResName+"&url="+encodeURIComponent(a):(k.needHttps||"http:")+"//"+location.host+"/visitor/common/record.html?lan="+window.lanResName+"&url="+encodeURIComponent(a),view.handlePushURL?-1==view.handlePushURL(e)&&window.open(e,"_blank"):view.showURLLink&&view.showURLLink(lanRes.leaveMsgTitle,e,{from:5}),$("#msg"+i.tm).hasClass("fold"))if(k.handleNewMsgMid(i.mid,i,!1,i),$("#msg"+i.tm).removeClass("fold"),view.SDKNative)view.__nativeAPI("updateLocalMsg",{mid:i.mid,read:1});else if(k.hasStorage){var n=window.localStorage.getItem(k.historyKey);if(n){var s=(n=JSON.parse(n))[i.talkId];s&&s[i.tm+"s"]&&(s[i.tm+"s"].read=1),k.updateHistory(n)}}}),this.subscribe("startRobot",function(e,t){k.hasSearchInSameScreen=1==k.msg649.enableSearchInTheSameScreen,k.hasInputAssociation=1==k.msg649.enableInputAssociate,k.isInRobot=!0,k.publish("__chatStatus","robot"),k.publish("clearSendingMsg","robot"),k.publish("setConfig",k.msg649),k.publish("initRobot",k.msg649),view.toggleLeaveToChat&&view.toggleLeaveToChat(2),k.queryParams.autoPop&&delete k.queryParams.autoPop,k.queryParams.autoChat&&delete k.queryParams.autoChat,k.isAutoPop=!1}),this.subscribe("startLeave",function(e,t){k.companyOff=!0,k.talkId=t.talkId,k.publish("setConfig",k.msg649),k.publish("toLeavePage",k.msg649,t),k.queryParams.autoPop&&delete k.queryParams.autoPop,k.queryParams.autoChat&&delete k.queryParams.autoChat,k.isAutoPop=!1}),this.subscribe("startChat",function(e,t){k.publish("setConfig",k.msg649),setTimeout(function(){k.toInitEvaluate(k.msg649)},10),this.startChat.apply(k,arguments)}),this.subscribe("continueChat",function(e,t){setTimeout(function(){k.toInitEvaluate(k.msg649)},10),this.startChat.apply(k,arguments)}),this.subscribe("goingEntry",function(e,t){var i;1==t.status?k.showEntryAndCode(t,!0):((i=t.entranceInfo||t.smallEntranceInfo||t.mobileEntranceInfo||t.sdkEntranceInfo)&&1==i.visitorInfoEnable&&1==i.enableOffline||t.captChaToken)&&k.publish("toLeavePage",k.msg649)}),this.hasBoxConfig=function(e){return e.robotConfigInfo||e.robotPCChatBox||e.offlineBoxInfo||e.mobileOfflineBoxInfo||e.sdkOfflineBoxInfo||e.sdkChatBoxInfo||e.mobileChatBoxInfo||e.chatBoxInfo||e.chatSmallBoxInfo||e.offlineSmallBoxInfo},this.subscribe("waitingChat",function(e,t){k.eventId=t.eventId,k.isInRobot&&k.publish("endRobot"),1!=t.canChatNow&&k.publish("setConfig",t);var i=k.getLeaveConfig(t);if(2!=t.status||2==t.chatStatus||!i||!(2==i.enable&&i.thirdPartyUrl||"0"==i.enable)||(k.publish("toLeavePage",t),"0"!=i.enable&&"2"!=i.enable)){if(!1!==k.chatting&&k.talkId&&(k.lastTalkIdForTemp=k.talkId),k.chatting=-1,k.leaveAndClose=!1,k.sendMsgNum=0,view.toggleEnded&&view.toggleEnded("init"),$("#chat").removeClass("hide"),$("#footer").removeClass("hide").removeClass("leave-disabled"),$("#busyTipLine").addClass("hide").hide(),k.isMobile&&$(".menu-phone").addClass("limit-hide"),k.isMobile||$("#portrait").hide(),$("#textInput").attr("placeholder",lanRes.mbTextareaInput.placeholder),$("#leaveDisabled").hide(),view.resetContentHeight&&view.resetContentHeight(),$("#container").removeClass("hide"),$("html").removeClass("page-leave"),k.hasEntryOrCode&&k.publish("entryCallback",{success:!0}),k.sendMsgNum=0,$("#inputPlaceholder").html($("#inputPlaceholder").attr("placeholder")||lanRes[$("#inputPlaceholder").attr("langs")]),k.hasBoxConfig(t)&&(k.msg649=$.extend(k.msg649||{},t),view.SDK&&$.store("ECHAT_"+k.companyId+"_649",JSON.stringify($.extend(JSON.parse($.store("ECHAT_"+k.companyId+"_649")||"{}"),t)))),t.unreadMsgNumber&&parseInt(t.unreadMsgNumber))return k.companyOff=2==t.status,k.hasLeaveMsg=!0,k.publish("removeLoading"),void(view.toggleLeaveToChat&&view.toggleLeaveToChat(1));if(k.hasLeaveMsg=!1,view.toggleLeaveToChat&&view.toggleLeaveToChat(0),$("#inputLengthTip").hide(),k.getInput(!1)?$("#inputPlaceholder").addClass("hide"):$("#inputPlaceholder").removeClass("hide"),k.companyOff=2==t.status,k.hasChatInOtherPage=!1,$.cookie("ECHAT_"+k.companyId+"_"+window.chatVisitorId+"_chatStatus",t.chatStatus,{path:"/"}),2==t.chatStatus?(k.wait874List=!0,k.hasChatInOtherPage=!0):1!=t.canChatNow&&k.publish("goingEntry",t),k.publish("__staffStatus",t.status),$("#router").hide(),ECHATObjKeyMap.cometdId.waitForRouterSelect&&k.publish("routerSelect"),ECHATObjKeyMap.cometdId.waitForRouterSelect=!1,k.isInRobot&&(t.robotPCChatBox||t.robotSmallChatBox||t.robotPhoneChatBox||t.robotSdkChatBox)||!k.isInRobot&&(t.chatBoxInfo||t.chatSmallBoxInfo||t.mobileChatBoxInfo||t.sdkChatBoxInfo)){var a=t.entranceInfo||t.smallEntranceInfo||t.mobileEntranceInfo||t.sdkEntranceInfo;a&&2==t.status&&1==a.visitorInfoEnable&&1==a.enableOffline&&"0"==a.offlineStartType||view.setInnerAD(t)}!0!==k.companyOff&&"0"==k.queryParams.autoChat&&!0!==k.chatting?($(".menu-capture").addClass("hide"),$(".menu-file").addClass("hide")):!0===k.companyOff&&($(".menu-capture").removeClass("hide"),$(".menu-file").removeClass("hide")),k.openVisitorSend(),k.publish("firstInitSound"),1==t.notThroughStatus&&k.publish("removeLoading")}}),this.subscribe("firstInitSound",function(){k.unSubscribe("firstInitSound"),k.isMobile?window.audioInstance||(window.audioInstance=_$s("audio")[0]):window.ltIE10||window.audioInstance&&view.SDKNative||k.addJS("/visitor/common/audiojs/audiojs/audio.min.js",function(){audiojs.events.ready(function(){window.audioInstance=audiojs.create(_$("msgAudio"))})}),k.unSubscribe("_newMsg"),k.subscribe("_newMsg",function(){if(!k.disableSoundTip&&window.audioInstance){var e=window.audioInstance;try{e.play.apply(e)}catch(e){}}})}),this.subscribe("_addSendMsgNum",function(e,t){k.sendMsgNum++,k.allowEvaluateBaseWords<=k.sendMsgNum&&k.toggleEvaluateMenu(4)});var d={};k.handleNewMsgMid=function(e,t,i,a){if(e&&!d[e])return d[e]=1,k.lasMid=k.lasMid||$.store("ECHAT_"+k.companyId+"_"+k.visitorId+"_mid")||0,k.lasMid<e?(t&&i&&(t.mid=e,!1!==a.isForward&&view.SDKNative||(k.publish("_newMsg",t),"sys"==t.f?k.publish("__newSysMsg",t,a||{}):k.publish("__newMsg",t,a||{}))),$.store("ECHAT_"+k.companyId+"_"+k.visitorId+"_mid",e),(!1===view.showChangeTitle||view.miniShow||window.ltIE10)&&($.cookie("ECHAT_"+k.companyId+"_"+window.chatVisitorId+"_mid_read",e,{path:"/"}),1!=view.windowType&&3!=view.windowType||!1!==view.showChangeTitle||$.cookie("ECHAT_"+k.companyId+"_"+window.chatVisitorId+"_mid_read_click",e,{path:"/"})),i):void 0},k._getMsg=function(e,t,i,a){e.tm||(e.tm=(new Date).getTime());var n=new Date(e.tm?+e.tm:void 0),s=e.id||e.bridgeMsgId||e.fileIdentity||"msg"+e.tm,o=k.checkHistoryTime(e.tm),r={t:e.t||(o?n.format("hh:mm"):void 0),tm:e.tm,mt:i&&i.mt||e.mt,f:a||"s",m:t,c:i,hasResend:e.bridgeMsgId&&2==e.sendStatus,notEnd:e.notEnd,id:s};r.hasResend&&(k.errorList[s]=e),r.talkId=e.talkId||k.talkId,e.staffImg&&(r.staffImg=e.staffImg),e.staffName&&(r.staffName=e.staffName||e.staffNickName),e.staffId&&!e.staffName&&k.staffMap[e.staffId]&&(r=$.extend(r,k.staffMap[e.staffId])),"f"!=a&&"r"!=e.ff||(r.ff="r"),r.c&&k.showMsg(r),delete r.id,delete r.hasResend,e.notStore||(1==t?r.tmf=s:2==t&&(r.fileName=e.fileName,r.bigImg=e.bigImg,r.smallImg=e.smallImg,r.sourceImg=e.sourceImg,r.c="img-temp"+s,r.sourceWidth=e.sourceWidth,r.sourceHeight=e.sourceHeight,r.tmf=s),"x"==a&&5!=r.m?r.c=e.content:"r"==a&&(r.c=e.content),(i||e)&&!k.isMobile&&view.setDocumentTitle&&view.setDocumentTitle(a),"c"!=a&&(r.answer=e.answer||void 0,k.handleNewMsgMid(e.mid,r,!0,i)),r.c&&k.pushHistory(r))},this.escapeHtml=function(e){return e&&e.replace(/"/g,"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};this.getVisEvtHtml=function(t){if(t.urlForVisitor){t.urlForVisitor=t.urlForVisitor.replace(/\s/g,"");var e=t.urlForVisitor.match(/^http\(['"]?([^'",]+)['"]?(\,['"]?(blank|inner)['"]?)?\)/i)||t.urlForVisitor.match(/^xcx\(['"]?([^'",]+)['"]?(\,['"]?(navigateTo|redirectTo|switchTab)['"]?)?\)/i);e?(t.url=e[1],t.openType=e[3]):t.url=""}else if(0==t.urlEnableForVisitor&&(t.url=void 0,delete t.url),t.url){var i=t.url.replace(/\s/g,"").match(/^apiUrl\(['"]?(\d+)['"]?(\,['"]?(reload|hash)['"]?)?\)/);i?t.toCrmUrlId=i[1]:(t.url.match(/(^http[s]?:)|(^file:)/i)||(t.url=""),t.toCrmUrlId=!1)}var a="";if(t.imageUrl&&(t.imageUrl=t.imageUrl.replace(/["']/,""),a=t.imageUrl?'<img onerror="view.imgError&&view.imgError(this)" class="custom-event-img" src="'+t.imageUrl+'"/>':"",!t.url||t.toCrmUrlId)){a=a.replace(/<img\b.*?(?:\>|\/>)/gi,function(){var e={smallImg:t.imageUrl,bigImg:t.imageUrl,sourceImg:t.imageUrl,fileName:"预览"};return view.showMsgImg&&view.showMsgImg(e,"custom-event-img")||'<img  onerror="view.imgError&&view.imgError(this)"'+(e.notEnd?"":'onload="javascript:view.scrollToBottom()"')+' id="img'+(e.tm||(new Date).getTime())+'" attname="'+e.fileName+'" bigimg="'+e.bigImg+'" src="'+e.smallImg+'" source="'+(e.sourceImg||"")+'" sw="'+(e.sourceWidth||"")+'" sh="'+(e.sourceHeight||"")+'" class="msg-img custom-event-img"/>'})}return(!t.url||t.toCrmUrlId?'<div class="custom-event '+(k.isInRobot?"bg30":"bg3")+'"><div class="custom-event-wrap">{{imageUrl}}<div class="custom-event-content"><div class="custom-event-title" style="height:auto;margin-bottom:0;" title="{{title1}}">{{title}}</div><div class="custom-event-detail">{{content}}</div></div></div>{{memo}}</div>':'<a class="custom-event '+(k.isInRobot?"bg30":"bg3")+'" {{linkset}}><div class="custom-event-wrap">{{imageUrl}}<div class="custom-event-content"><div class="custom-event-title" style="height:auto;margin-bottom:0;" title="{{title1}}">{{title}}</div><div class="custom-event-detail">{{content}}</div></div></div>{{memo}}</a>').replace(/\{\{linkset\}\}/,!t.url||t.toCrmUrlId?"":' href="'+t.url+("inner"==t.openType?'" target="inner" title="'+(t.title||lanRes.interactWnd)+'" ':"navigateTo"==t.openType||"redirectTo"==t.openType||"switchTab"==t.openType?'" target="'+t.openType+'" ':'" target="_blank" ')).replace(/\{\{title1\}\}/,k.escapeHtml(t.title)||"").replace(/\{\{title\}\}/,t.title||"").replace(/\{\{imageUrl\}\}/,a).replace(/\{\{content\}\}/,t.content||"").replace(/\{\{memo\}\}/,t.memo?'<div class="custom-event-memo">'+t.memo+"</div>":"")},this.subscribe("receiveVisEvt",function(e,t,i){if(!t.notStore&&t.talkId&&(k.talkId=t.talkId),2!=t.visibility){if(t.notStore&&t.c)return k._getMsg(t,5,t.c,t.f);var a=k.getVisEvtHtml(t);2==t.customizeMsgType||3==t.mst?k._getMsg(t,5,'<li class="clearfix custom-event-li" id="msg'+t.tm+'">'+a+"</li>","x"):t.mst&&1!=t.mst?2==t.mst&&k._getMsg(t,5,a,i?"r":"s"):(k._getMsg(t,5,a,"c"),t.notEnd||k.publish("__visitorSendMsg","["+lanRes.imageAndHtml+"]"+(t.title||"")),t.notEnd||k.publish("__visitorStartSendMsg","["+lanRes.imageAndHtml+"]"+(t.title||"")),t.notStore||t.notEnd||"1"!=t.closeURLPage||(view.hideURLSite&&view.hideURLSite(),view.hideMenus&&view.hideMenus()))}}),this.subscribe("receiveURL",function(e,t){var i=t.pushUrlDetail.url,a="";if(view.chat.needHttps&&i.match(/^http:/i)&&(a=" push-blank"),view.pushURLParam){var n=i.split("#");i=n[0]+(-1==n[0].indexOf("?")?"?":"&")+view.pushURLParam+(n[1]?"#"+n[1]:"")}var s='<a class="push-url clearfix'+a+'" target="info_frame3" href="'+i+'"><div class="push-icon echat bg1"></div><div class="push-content"><div class="push-name">'+t.pushUrlDetail.urlName+' </div><div class="push-url-link">'+t.pushUrlDetail.url+"</div></div></a>";k._getMsg.call(this,t,6,s,"s"),1!=k.queryParams.echatIframeDisable&&-1==i.indexOf("echatIframeDisable=1")&&view.handlePushURL&&view.handlePushURL(i,void 0,t.pushUrlDetail.urlName)}),this.subscribe("getMsgImg",function(e,t,i){k.needHttps&&(k.qiniuDomain&&k.qiniuHttpsDomain&&(t.bigImg&&(t.bigImg=t.bigImg.replace(k.qiniuDomain,k.qiniuHttpsDomain)),t.smallImg&&(t.smallImg=t.smallImg.replace(k.qiniuDomain,k.qiniuHttpsDomain)),t.sourceImg&&(t.sourceImg=t.sourceImg.replace(k.qiniuDomain,k.qiniuHttpsDomain))),t.bigImg&&(t.bigImg=t.bigImg.replace(/^http:/,k.needHttps)),t.smallImg&&(t.smallImg=t.smallImg.replace(/^http:/,k.needHttps)),t.sourceImg&&(t.sourceImg=t.sourceImg.replace(/^http:/,k.needHttps))),t.fileName&&"temp.png"!=t.fileName||(t.fileName="Echat"+(new Date).format("yyyyMMddhhmmss")+".png"),t.sourceImg=t.sourceImg||t.bigImg;var a=view.showMsgImg&&view.showMsgImg(t)||"<img "+(t.notEnd?"":'onload="javascript:view.scrollToBottom()"')+' id="img'+(t.fileIdentity||t.tm||(new Date).getTime())+'" attname="'+t.fileName+'" bigimg="'+(t.bigImg||t.sourceImg)+'" src="'+t.smallImg+'" source="'+(t.sourceImg||"")+'" sw="'+(t.sourceWidth||"")+'" sh="'+(t.sourceHeight||"")+'" class="msg-img"/>';t.fileIdentity&&_$(t.clientFileId||t.fileIdentity)&&(k.addSendFile(),k.publish("__visitorSendMsg","["+lanRes.image+"]")),k.sendingFileToken&&k.sendingFileToken.end&&k.sendingFileToken.token==t.fileIdentity&&(k.sendingFileToken="",k.publish("_toggleEnableFile",!0)),t.id=t.clientFileId||t.identityKey||t.fileIdentity,k._getMsg.call(this,t,2,a,865==t.mt?"c":i?"r":"s"),view.initImgPlay&&view.initImgPlay(),k.isInRobot||865!=t.mt&&"local"!=t.mt||k.publish("_addSendMsgNum")}),this.subscribe("getMsgFile",function(e,t,i){k.needHttps&&t.fileUrl&&(k.qiniuDomain&&k.qiniuHttpsDomain&&(t.fileUrl=t.fileUrl.replace(k.qiniuDomain,k.qiniuHttpsDomain)),t.fileUrl=t.fileUrl.replace(/^http:/,k.needHttps)),!_$("downFrame")&&_$("downFileFrame")&&(_$("downFileFrame").innerHTML='<iframe id="downFile" name="downFile" style="display:none;"></iframe>');var a,n,s,o="downFile",r=t.fileUrl;k.isIOS&&(o="_blank"),(a=view.SDKNative?view.getMsgFile(t):t.c?t.c:"")||(n=t.fileUrl&&0<t.fileUrl.indexOf("?")?"&":"?",s=t.fileUrl+n+"attname="+encodeURIComponent(t.fileName),a=view.SDK||2!=t.fileType||window.ltIE10?'<div class="file-info"><div class="file-name">'+t.fileName+'</div><div class="file-size">'+(parseInt(t.fileSize/1024)+1)+'KB</div></div><div class="file-icon">&nbsp;</div><a class="file-link file-link-a color0" href="'+s+'" target="'+o+'">'+lanRes.download+"</a>":k.isMobile?'<div class="file-video" identity="'+t.fileIdentity+'" onclick="__playVideo(\''+r+"','"+(t.videoThumbUrl||"")+"','"+s+"','"+(t.fileName||"")+'\')" style="'+(t.videoThumbUrl?"background:url("+t.videoThumbUrl+") no-repeat;background-size:100%;":"")+'"><div class="icon_video"></div><div class="video_logo">VIDEO</div></di>':'<a class="file-video" target="_blank" href="/visitor/pc/video.html?videoUrl='+encodeURIComponent(r)+'" style="'+(t.videoThumbUrl?"background:url("+t.videoThumbUrl+") no-repeat;background-size:100%;":"")+'"><div class="icon_video"></div><div class="video_logo">VIDEO</div></a>'),866==t.mt&&(t.fileIdentity||t.identityKey)&&(_$(t.clientFileId)||_$(t.fileIdentity||t.identityKey))&&(k.addSendFile(),k.publish("__visitorSendMsg","["+(2==t.fileType?lanRes.video:lanRes.fileHtml)+"]")),k.sendingFileToken&&k.sendingFileToken.end&&k.sendingFileToken==t.fileIdentity&&(k.sendingFileToken="",k.publish("_toggleEnableFile",!0)),t.id=t.clientFileId||t.identityKey||t.fileIdentity,k._getMsg.call(this,t,3==t.fileType||4==t.fileType?t.fileType:1,a,866==t.mt||"local"==t.mt?"c":i?"r":"s"),k.isInRobot||866!=t.mt&&"local"!=t.mt||k.publish("_addSendMsgNum")}),k.subscribe("_toggleEnableFile",function(e,t){if(!k.hasFormData){var i;(i=_$("file_up").contentDocument)||(i=U.frames.file_up.document);var a=i.getElementById("uploadInput");t?($(".menu-file").removeClass("menu-file-sending").attr("title",lanRes.selectFile),a.setAttribute("disabled",""),a.disabled=!1,a.removeAttribute("disabled"),a.title=lanRes.selectFile,a.setAttribute("title",lanRes.selectFile)):($(".menu-file").addClass("menu-file-sending").attr("title",k.sendingTitle),a.disabled="disabled",a.setAttribute("disabled","disabled"),a.title=k.sendingTitle,a.setAttribute("title",k.sendingTitle))}}),this.subscribe("getMsg",function(e,t){var i=(t.translation||t.content)+"";if(t.relateId&&this.changeStorgeBackMsg(t.relateId)){$("#"+t.relateId).html("");var a='<div style="padding: 10px 0 20px;text-align: center;"><span style="display: inline-block;padding: 8px 10px;background-color: #bfbfbf;border-radius: 5px;color: #FFF;">'+lanRes.backMsgTip+"</span></div>";$("#"+t.relateId).html(a)}if(i&&"undefined"!==i){i=(i=i.replace(/<img\b.*?(?:\>|\/>)/gi,function(e){var t=/\bsrc\b\s*=\s*[\'\"]?([^\'\"]*)[\'\"]?/i.exec(e);if(!t)return e;var i={smallImg:t=t[1],bigImg:t,sourceImg:t,fileName:"预览"};return view.showMsgImg&&view.showMsgImg(i)||'<img onerror="view.imgError&&view.imgError(this)" '+(i.notEnd?"":'onload="javascript:view.scrollToBottom()"')+' id="img'+(i.tm||(new Date).getTime())+'" attname="'+i.fileName+'" bigimg="'+(i.bigImg||i.sourceImg||"")+'" src="'+i.smallImg+'" source="'+(i.sourceImg||"")+'" sw="'+(i.sourceWidth||"")+'" sh="'+(i.sourceHeight||"")+'" class="msg-img"/>'})).replace(/&nbsp;([^&\s])/g," $1"),t.staffImg||t.notStore||(t.staffId=k.staffId),k._getMsg.call(this,t,0,i)}}),k.robotUnknowTime=0,this.subscribe("getMsgRobot",function(e,t){if("r"==t.f&&t.c)return k._getMsg.call(this,{talkId:t.talkId,tm:t.tm,mt:12001,ff:"r",staffImg:t.staffImg,staffName:t.staffName,content:t.c,notEnd:!0,notStore:!0},0,t.c,"r");var i,a,n,s,o=t.knowledgeAnswerList||[],r="",l='<ul class="question-list">',d='<div class="ipt-list">';if(t.nonTextMsg)10011==(r=t.nonTextMsg).mt?k.publish("receiveVisEvt",r,!0):641==r.mt?k.publish("getMsgImg",r,!0):642==r.mt&&k.publish("getMsgFile",r,!0);else if(4==t.type){if(t.notStore)return;n=t.segWords;for(var c,u=!1,f=0,m=0;m<o.length;m++){if(a=(i=o[m]).question,u=!1,a==k.lastText){m++,f=1,d='<div class="ipt-list"><a class="ipt-list-li" did="'+i.docId+'" ques="'+escape(i.question)+'"><b class="words-seg">'+a+"</b></a>";break}if(n)for(var h=0;h<n.length;h++)c=n[h],c=k.escapeRegExp(c),a=a.replace(new RegExp(c,"igm"),function(e,t){u=!0;var i=arguments.length,a=arguments[i-2];if(!(0<a))return'<b class="words-seg">'+e+"</b>";var n=arguments[i-1].substring(0,a),s=arguments[i-1].substring(a);if(c.match(/^s|sp|spa|span$/)&&n.match(/<$/))return e;if(c.match(/^n|an|pan|span$/)){var o="</span>".replace(c,",").split(",");if(n.match(new RegExp(o[0])&&s.match(o[1])))return e}return/(\<span[^>]*>([^<]+(?!\<\/span\>))?$)|(\<[a-zA-Z]+[^>]*$)/gi.test(n)?e:'<b class="words-seg">'+e+"</b>"});u&&(f++,d+='<a class="ipt-list-li" did="'+i.docId+'" ques="'+escape(i.question)+'">'+a+"</a>")}0<f?$("#input_suggest").html(d+"</ul>").removeClass("hide"):$("#input_suggest").addClass("hide").html(" ")}else if(3==t.type)t.f,t.tip=t.tips,204==t.result||205==t.result?(k.showInfoTip(t,void 0,void 0,void 0,t.talkId),t.notStore||(k.robotToHumanKey=t.robotToHumanKey,k.publish("toSetID"),$("#input_suggest").addClass("hide").html(" "),k.handleNewMsgMid(t.mid,{c:t.tips,f:"sys",m:0},!0,t)),delete k.paramChat.staffId,delete k.paramChat.staffName,delete k.paramChat.staffPhoto,delete k.paramChat.talkId):206==t.result||202==t.result?console.log(206==t.result?"禁用留言":"禁用转人工"):207==t.result&&(k.showInfoTip(t,void 0,void 0,void 0,t.talkId),t.notStore||($("#robotToStaff").show(),y(k),view.showRobotToStaff&&view.showRobotToStaff(t),view.handleShowRobotToStaff&&view.handleShowRobotToStaff(),k.handleNewMsgMid(t.mid,{c:t.tips,f:"sys",m:0},!0,t)));else if(5==t.type){(r=(r=t.tips||"").replace(/&nbsp;([^&\s])/g," $1"))&&k._getMsg.call(this,$.extend(t,{ff:"r",staffImg:t.staffImg||k.staffImg,staffName:t.staffName||k.staffName,content:'<div class="msg-item-robot"> '+r+"</div>",notEnd:"r"==t.f,notStore:"r"==t.f,talkId:t.talkId}),0,'<div class="msg-item-robot"> '+r+"</div>","r");var p,g=$("#q"+t.robotDetailId);t.feedback&&$(g).attr("did","").attr("qid","").addClass("robot-feedback-had").addClass("robot-feedback-had"+t.feedback).attr("feedback",t.feedback),2==t.feedback&&$(".feedback-btn-unsolve",g.results[0]).addClass("feedback-btn-unsolve-sel"),1==t.feedback&&$(".feedback-btn-solve",g.results[0]).addClass("feedback-btn-solve-sel"),t.feedbackSubitem&&(2==(p=$(g).attr("feedback"))?($(".feedback-sub-solved",g.results[0]).remove(),console.log($(".feedback-sub-li",g.results[0])),$(".feedback-sub-li",g.results[0]).each(function(){$(".feedback-sub-content",this).text()==t.feedbackSubitem&&($(this).addClass("feedback-sub-sel2"),$(".feedback-sub-list",g.results[0]).addClass("robot-feedback-sub-had"))})):1==p&&($(".feedback-sub-unsolved",g.results[0]).remove(),$(".feedback-sub-li",g.results[0]).each(function(){$(".feedback-sub-content",this).text()==t.feedbackSubitem&&($(this).addClass("feedback-sub-sel1"),$(".feedback-sub-list",g.results[0]).addClass("robot-feedback-sub-had"))})),setTimeout(function(){view.scrollUpdate()},100))}else if(6==t.type)(r=(r=t.tips||"").replace(/&nbsp;([^&\s])/g," $1"))&&k._getMsg.call(this,$.extend(t,{ff:"r",staffImg:t.staffImg||k.staffImg,staffName:t.staffName||k.staffName,content:'<div class="msg-item-robot"> '+r+"</div>"}),0,'<div class="msg-item-robot"> '+r+"</div>","r");else if(7==t.type)r=t.tips||t.content||"",k.showInfoTip(r),t.notStore&&k.handleNewMsgMid(t.mid,{c:r,f:"sys",m:0},!0,t);else if(1==t.type||2==t.type){if((i=o[0])?1==i.answerType?r+=t.tips||"":2==i.answerType?(r+='<div class="robot-tip">'+(t.tips||"")+"</div>",r+=i.answer||"",s=i.relateKnowledges,l+='<div class="robot-tip margin-top10">'+(t.tipsExt||"")+"</div>"):3==i.answerType?(s=i.suggestions,l+='<div class="robot-tip">'+(t.tips||"")+"</div>"):4==i.answerType?r+=i.answer||"":5==i.answerType?(r+=i.answer||"",s=i.relateKnowledges,l+='<div class="robot-tip">'+(t.tips||"")+"</div>"):6==i.answerType&&(r+=i.answer||"",s=i.relateKnowledges,l+='<div class="robot-tip margin-top10">'+(t.tips||"")+"</div>"):r+=t.tips||"",s&&s.length){for(h=0;h<s.length;h++)l+='<li class="question-list-li" oid="'+i.docId+'" did="'+s[h].docId+'" ques="'+escape(s[h].question)+'"><span class="list-style-dot">'+(h+1)+'. </span><span class="color-link">'+s[h].question+"</span></li>";l+="</ul>"}else l="";var v,b="";1==i.feedback&&k.robotFeedback&&(i.searchId||(i.searchId=""),i.originQuestion||(i.originQuestion=""),v=t.relateId&&k.robotFeedbackTemp&&k.robotFeedbackTemp[t.relateId]||{},t.feedback=t.feedback||v.feedbackResult,b='<div id="q'+i.robotDetailId+'" class="robot-feedback'+(t.feedback?" robot-feedback-had robot-feedback-had"+t.feedback+'"':'" did="'+i.docId+'" qid="'+i.queryId+'" rid="'+i.robotDetailId+'" searchId="'+i.searchId+'" originQuestion="'+escape(i.originQuestion)+'"')+">"+k.robotFeedback({feedback:t.feedback,feedbackSubitem:v.feedbackSubitem,answerItem:i})),((r=r.replace(/&nbsp;([^&\s])/g," $1"))||l)&&k._getMsg.call(this,$.extend(t,{ff:"r",staffImg:t.staffImg||k.staffImg,staffName:t.staffName||k.staffName,answer:r,content:'<div class="msg-item-robot"> '+r+l+"</div>"}),0,'<div class="msg-item-robot"> '+r+l+"</div>"+b,"r")}}),this.subscribe("getMsgMine",function(e,t){var i=t.content;k.isInRobot&&(t.ff="r"),k.isInRobot||k.publish("_addSendMsgNum"),k._getMsg.call(this,t,0,i,"c")}),this.resendFile=function(e,t){var i=this,a=e.uploadServiceType,n=i.uploadUtil.getNextUploadType(a);return!1!==n?(i.publish("sendVisitorEvent",{et:123,ssl:i.needHttps?1:void 0,uploadServiceType:n,ft:e.fileType},function(e){!e.successful||e.failure?!1===e.autoResend&&i.handleFileSelect.error():$("#"+t).remove()}),!1):(i.publish("getErr",{reqInfo:t,code:-2}),!0)},this.subscribe("getFileToken",function(e,t){2==t.fileType&&k.handleFileSelect.back();for(var i,a,n=k.fileUploadInfos["uploadServiceType"+t.uploadServiceType]||t,s={},o=k.needHttps?n.fileUploadHttpsUrl:n.fileUploadUrl,r=t.qiniuKey||t.token||t.aliyunKey&&t.aliyunKey.match(/\/([^\/]+$)/)[1],l=null,d=n.fileUploadParam.split(","),c=0;c<d.length;c++)s[d[c].split("=")[0]]=(l=d[c].match(/\$\{([^\}]+)\}/))?t[l[1]]:d[c].split("=")[1];if(t.fileType=t.fileType||2,1==t.fileType){if(!k.pasteFileSource)return;(I=new FormData).append("file",k.pasteFileSource)}if(t.uploadServiceType==k.uploadUtil.getLastUploadType()&&(o+="?token="+t.token),2!=t.fileType&&3!=t.fileType&&4!=t.fileType)1==t.fileType||(5==t.fileType?(k.fileToken=t,k.publish("_captureImg",null)):6==t.fileType&&(k.fileToken=t,k.publish("_captureImgIE",null)));else{var u=U;k.hasFormData||(u=_$("file_up").contentDocument)||(u=U.frames.file_up.document);var f=u.getElementById("uploadInput"),m=f.value||f.getAttribute("value");if(!m)return void console.log("no file to send",m);for(var h,p=(f.files||[{}]).length,g=0;g<p;g++)if(0===C[g+""]||3===C[g+""]){h=g;break}var v=h+1===p;if(f.files){if(!f.files[h]||!f.files[h].size)return void console.log("no file to send",m);(f.files[h]||f.files[h].name)&&(m=f.files[h].name)}if(i=m.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1"),k.hasFormData){try{for(var b in a=new FormData,s)"Content-Disposition"!=b&&"x:filename"!=b||(s[b]=i),a.append(b,s[b]);a.append("file",f.files[h],i);var y=new XMLHttpRequest;y.open("POST",o,!0);var w=!1;y.onerror=y.ontimeout=y.onabort=function(){C[h]=3,w||k.resendFile(t,r),w=!0},y.addEventListener("load",function(e){200==y.status&&y.responseText&&(1==y.responseText||y.responseText.match(/\{\s*"errorCode"\s*:\s*1\s*}/))?(C[h]=2,v&&setTimeout(function(){U.forms.namedItem("uploadForm").reset()})):403==y.status||y.responseText&&y.responseText.match(/\{\s*"errorCode"\s*:\s*146\s*}/)||y.responseText&&y.responseText.match(/\{\s*"errorCode"\s*:\s*117\s*}/)?(C[h]=4,k.publish("getErr",{reqInfo:r,code:-2}),setTimeout(function(){U.forms.namedItem("uploadForm").reset()})):(C[h]=3,w||k.resendFile(t,r),w=!0)}),C[h]=1,y.send(a),_$(r)||k.showMsg({id:r,f:"c"},'<div class="file-sending">'+lanRes.fileSending+"</div>"),k.sendingFileToken={token:r,end:!0}}catch(e){if(!v)return;k.hasFormData=!1,k.hasInitFile=!1,k.addSendFile(),console.log("变为iframe上传")}v&&(f=a=null)}else{(u=_$("file_up").contentDocument)||(u=U.frames.file_up.document);var I=u.getElementById("uploadForm");for(var b in s)if("Content-Disposition"!=b&&"x:filename"!=b||(s[b]=i),I[b])I[b].value=s[b];else{var T=u.createElement("input");T.name=b,T.type="hidden",T.value=s[b],I.insertBefore(T,f)}$(I).attr("action",o),I.submit(),k.showMsg({id:r,f:"c"},'<div class="file-sending">'+lanRes.fileSending+"</div>"),setTimeout(function(){k.sendingFileToken={token:r,end:!0},k.publish("_toggleEnableFile",!1)},10)}}}),this.subscribe("niuniuKey",function(e,t){if(t){var i=t.split(","),a=new Date,n=a.getFullYear()+""+(a.getMonth()+1)+a.getDate();a.setDate(a.getDate()+1);var s=a.getFullYear()+""+(a.getMonth()+1)+a.getDate();k["niuniu"+n]=i[0],k["niuniu"+s]=i[1]}});var c,u,f=navigator.userAgent.toLowerCase(),m=(f.indexOf("baidubrowser"),-1<f.indexOf("mqqbrowser")&&this.Device.OS,"uc"==this.Browser.browser);k.isMobile||k.isInRobot?this.bindPlainTextEvent():k.changeToIframe(),m&&$("#footer").addClass("footer-absolute"),k.resetForm=function(e){var t;if(k.hasFormData)t=U.forms.namedItem("uploadForm").reset();else{var i=_$("file_up").contentDocument||U.frames.file_up.document;t=i.getElementById("uploadForm")}setTimeout(function(){t&&t.reset()},e||10)},k.handleFileSelect=(u="tempInitSendFile",{back:function(){--c<1&&k.publish("enableSelectFile",u)},error:function(){--c<1&&k.publish("enableSelectFile",u)},change:function(e){c=e,k.publish("disableSelectFile",u)},isSending:function(){return 0<c},reset:function(){c=0,k.publish("enableSelectFile",u)}}),k.subscribe("enableSelectFile",function(e,t){$(".menu-file").removeClass("menu-file-disabled"),$("#"+t).remove()}),k.subscribe("disableSelectFile",function(e,t){k.showMsg({id:t,f:"c"},'<div class="file-sending">'+lanRes.fileSending+"</div>"),$(".menu-file").addClass("menu-file-disabled")}),$("body").on("click",".menu-file-disabled",function(){k.handleFileSelect.isSending?k.showTip(lanRes.fileDisable):k.handleFileSelect.reset()});var C={};window.fLoad=function(e){(e=e||_$("file_up").contentDocument)||(e=U.frames.file_up.document);var o=e.getElementById("uploadInput");view.dji&&(o.style.height="62px"),"1"===view.chat.queryParams.multipleFile&&($(o).attr("multiple","multiple"),$(o).attr("title","最多选择9个文件")),o.onchange=function(){if(C={},!0===k.companyOff||k.busyCanSend&&"0"!=k.queryParams.autoChat||!0===k.chatting){var e=o.value||o.getAttribute("value");if(9<(o.files||[{}]).length&&(k.isMobile?(_$("leave_tip_con").innerHTML="最多选择9个文件",k.tipTimer&&clearTimeout(k.tipTimer),$("#leave_tip").removeClass("tiphide"),k.tipTimer=setTimeout(function(){$("#leave_tip").addClass("tiphide")},3e3)):k.showDialog({tip:"选择文件超过最大限制,最多选择9个文件！",cancel:!1}),1))return!1;if(e){var t,i=e,a=(o.files||[{}]).length;k.handleFileSelect.change(a);for(var n=0;n<a;n++){if(o.files){if(!o.files[n]||!o.files[n].size){console.log("no file to send",e),k.handleFileSelect.error();continue}(o.files[n]||o.files[n].name)&&(e=o.files[n].name)}t=-1!=e.indexOf(".")?e.replace(/.*\./,""):"";var s=e.replace(/^.+?\\([^\\]+?)(\.[^\.\\]*?)?$/gi,"$1");if(k.sendingTitle=s+"."+t+lanRes.fileSendWait,t&&-1==(","+k.uploadFileType+",").indexOf(","+t.toLowerCase()+","))k.showDialog({tip:"ERROR: "+lanRes.unsupportFileType+"。</br>"+lanRes.supportFileType+": "+k.uploadFileType,cancel:!1}),k.handleFileSelect.error();else k.getFileSize(o,n)>k.uploadFileSize?(k.showDialog({tip:lanRes.fileSizeOut.replace("${maxSize}",k.uploadFileSize/1024/1024+"M"),cancel:!1}),k.handleFileSelect.error()):(C[n+""]=0,o.files&&(i=o.files[n]),k.publish("sendVisitorEvent",{et:123,ssl:k.needHttps?1:void 0,uploadServiceType:k.uploadUtil.getUploadServiceType(),ft:2},function(e){e.successful&&!e.failure||!1===e.autoResend&&k.handleFileSelect.error()}),view.hideMenus&&view.hideMenus(0,!1))}}else console.log("no file to send",e)}else $("#busyTipLine").removeClass("hide").show()},o.onclick=function(){view.hideMenus(),k.sendingFileToken}},k.addSendFile(),k.emojitimer=setTimeout(function(){try{k.loadEmoji()}catch(e){}},100),this.subscribe("getErr",function(e,t){var i=t.reqInfo,a=i&&_$(i);switch(t.code){case 16:$(".file-sending",a).html(lanRes.tooLargeUploadFail);break;case 17:$(".file-sending",a).html(lanRes.unsupportFileType);break;case 18:default:$(".file-sending",a).html(lanRes.unkownErrorUpload)}16!=t.code&&17!=t.code&&18!=t.code||k.addSendFile()});var g=!1;this.subscribe("getHistory",function(e,t){if(k.talkId=t.talkId,k.hasGetHistory=!0,!g){g=!0,setTimeout(function(){g=!1},1e3);var i,a,n,s,o,r=t.chatDetailList,l=0;if(k.robotFeedbackTemp={},k.isArray(r)){k.lastMsgTM||0,s=_$("list_msg"),n=function(e){var t,i=e.length,a=[];if(!i)return a;for(var n=0;n<i;n++)(t=$(e[n]).parents("li").results).length&&a.push(t[0]);return a}($(".msg-error",s).results);for(var d,c=s.childNodes,u=c.length,f=0;f<u;f++)if(1==(d=c[f]).nodeType&&$(c[f]).hasClass("innerAD")){d=d.cloneNode(!0);break}s.innerHTML="",f<u&&s.appendChild(d),k.clearHistoryByTalkId(k.talkId),k.sendMsgNum=0,orderedStaffInfo={};for(var m=0;m<r.length;m++)if(315==(a=i=r[m]).dataType&&i.data&&(864==(i=JSON.parse(i.data)).mt&&k.isInRobot&&a.feedbackResult?k.robotFeedbackTemp[a.id]={feedbackResult:a.feedbackResult,feedbackSubitem:a.feedbackSubitem}:i.relateId=a.relateId||i.relateId),!(1e3<i.mt&&"10001"!=i.mt&&"10010"!=i.mt&&"10011"!=i.mt&&"12001"!=i.mt)){if(0<$("#msg"+i.tm).results.length&&$("#msg"+i.tm).remove(),k.lastMsgTM=i.tm,i.notEnd=!0,864==i.mt)k.publish("_addSendMsgNum");else if("10001"==i.mt||"686"==i.mt){if(orderedStaffInfo=k.updateStaffInfo(void 0,{staffId:i.toStaffId||i.staffId,staffNickName:i.staffNickName||i.toStaffNickName,staffDetailInfo:i.staffDetailInfo||i.toStaffDetailInfo}),"686"==i.mt)continue}else orderedStaffInfo.staffName&&(i=$.extend(i,orderedStaffInfo));if("10001"!=i.mt)if("10011"!=i.mt)if(865!=i.mt&&641!=i.mt)if(647!=i.mt&&"10010"!=i.mt&&605!=i.mt)if(866!=i.mt&&642!=i.mt)if(680!=i.mt)if(640!=i.mt)if(655!=i.mt){if(890==i.mt)1==i.templateInfoList[0].type||3==i.templateInfoList[0].type?(i.content=k.getBookComfirm(i.templateInfoList),i.m=3):(i.content=k.showInfoTip({f:"sys",tip:lanRes.receiveBookForm},void 0,void 0,!0,i.talkId,i.tm,!0),i.m=4);else if("12001"==i.mt){k.publish("getMsgRobot",i);continue}var h={t:(o=i.tm,(!l||6e4<o-l)&&(l=o,1)?new Date(i.tm).format("hh:mm"):void 0),tm:i.tm,mt:i.mt,c:i.content,ff:k.isInRobot?"r":void 0,f:864==i.mt?"c":890==i.mt?"x":"s",m:i.m||0,id:"msg"+i.tm,talkId:t.talkId,notEnd:!0};k.showMsg(h),delete h.id,3==h.m&&(h.c=i.templateInfoList),delete h.notEnd,k.pushHistory(h)}else k.publish("getLeaveMsg",i);else k.publish("getMsg",i);else k.publish("receiveURL",i);else k.publish("getMsgFile",i);else{if(8==i.type)continue;k.publish("getSysMsg",i)}else k.publish("getMsgImg",i);else k.publish("receiveVisEvt",i);else k.staffMap[i.toStaffId]&&k.publish("getSysMsg",{talkId:t.talkId,tm:i.tm,mt:"10001",mid:i.mid,notStore:i.notStore,notEnd:i.notEnd,staffId:i.toStaffId,staffName:k.staffMap[i.toStaffId].staffName},i)}for(m=0;m<n.length;m++)s.appendChild(n[m]),$("img",n[m]).each(function(){$(this).attr("src",$(this).attr("src"))});if(setTimeout(function(){view.scrollToBottom(),k.isMobile&&$("#footer").removeClass("hide"),view.hideMenus(),k.wait874List=!1,k.publish("removeLoading")},10),k.isMobile&&"none"!=_$("loading").style.display&&$("#footer").addClass("hide"),view.miniShow){var p=$.store("ECHAT_"+view.chat.companyId+"_"+view.chat.visitorId+"_mid");p&&$.cookie("ECHAT_"+view.chat.companyId+"_"+window.chatVisitorId+"_mid_read",p)}}else k.wait874List=!1,k.publish("removeLoading")}}),this.subscribe("getSysMsg",function(e,t){if((k.chatting||2!=t.type)&&11!=t.type){var i;if("10001"==t.mt)return i=(t.staffName||lanRes.serviceStaff)+" "+lanRes.transferStaff,k.showInfoTip(i,"msg"+t.tm,void 0,void 0,t.talkId,t.tm,t.notEnd),t.c="10001",t.f="x",void(t.notStore&&(k.pushHistory(t),k.handleNewMsgMid(t.mid,{m:0,f:"sys",c:i},!0,t)));if("647"!=t.mt||601!=t.exType||t.exType!=(this.preMsg||{}).exType){if((this.preMsg=t).notStore||!t.talkId||k.talkId&&1!=t.type&&10!=t.type&&7!=t.type||(k.talkId=t.talkId,k.hasGetHistory||k.companyOff),10==t.type)return t.notStore||(k.talkId=t.talkId,k.robotTalkId=t.talkId),void this.publish("_showCommonQue",t);if(i=t.content||t.c){var a=(i=i.replace(/<img\b.*?(?:\>|\/>)/gi,function(e){var t=/\bsrc\b\s*=\s*[\'\"]?([^\'\"]*)[\'\"]?/i.exec(e);if(!t)return e;var i={smallImg:t=t[1],bigImg:t,sourceImg:t,fileName:"预览"};return view.showMsgImg&&view.showMsgImg(i)||"<img "+(i.notEnd?"":'onload="javascript:view.scrollToBottom()"')+' id="img'+(i.tm||(new Date).getTime())+'" attname="'+i.fileName+'" bigimg="'+(i.bigImg||i.sourceImg||"")+'" src="'+i.smallImg+'" source="'+(i.sourceImg||"")+'" sw="'+(i.sourceWidth||"")+'" sh="'+(i.sourceHeight||"")+'" class="msg-img"/>'})).replace(/&nbsp;([^&\s])/g," $1");if(5==t.type||"s"==t.f)return t.staffId&&k.staffMap[t.staffId+""]&&(t=$.extend(t,k.staffMap[t.staffId+""])),void k._getMsg.call(this,t,0,a);if(k.showInfoTip({f:"sys",tip:i},"msg"+t.tm,void 0,void 0,t.talkId,t.tm,t.notEnd),!t.notStore){var n={tm:t.tm,f:"sys",mt:t.mt,m:0,c:i};n.talkId=t.talkId||k.talkId,k.pushHistory(n),n.c&&k.handleNewMsgMid(t.mid,n,!0,t),t&&!k.isMobile&&view.setDocumentTitle&&view.setDocumentTitle("s")}}}}}),k.hasWaitingStatus=!1,this.subscribe("getPosMsg",function(e,t){k.companyOff=!1,$("#positionInfo").remove(),k.hasWaitingStatus||(k.publish("__chatStatus","waiting"),$.cookie("ECHAT_"+k.companyId+"_"+window.chatVisitorId+"_chatStatus",1,{path:"/"}),k.hasWaitingStatus=!0,k.publish("setConfig",k.msg649),k.busyCanSend?($(".menu-capture").removeClass("hide"),$(".menu-file").removeClass("hide")):($(".menu-capture").addClass("hide"),$(".menu-file").addClass("hide"))),k.queueTxt=k.msg649.queueTxt||k.msg649.mobileQueueTxt||k.queueTxt,k.queueTxt&&k.showInfoTip({f:"sys",tip:k.queueTxt.replace("${waitcount}",t.position)},"positionInfo","warn",void 0,t.talkId,t.tm),k.publish("__chatQueue",t.position),k.initQcode()}),this.subscribe("inviteSatisfy",function(){k.showSatisfy(2)}),this.subscribe("staffInfo",function(e,t){k.staffName=t.staffNickName||lanRes.serviceStaff;var i=t.staffDetailInfo;i&&"string"==typeof i&&(i=JSON.parse(i)),i&&i.staffHead&&(k.needHttps&&(i.staffHead=i.staffHead.replace(/^http:/,k.needHttps)),k.paramChat.staffPhoto=i.staffHead),k.paramChat.staffPhone=i.staffPhone||"",k.paramChat.staffInfo=i.staffInfo||"",k.staffImg=i.staffHead||k.defaultStaffImg,view.initServiceInfo&&view.initServiceInfo(k,i),$(".sa-avatar").html('<img src="'+view.chat.staffImg+'"/>'),i&&k.saveHistoryStaff(k.staffImg,k.staffName),view.startChatRefreshAD&&view.startChatRefreshAD(),view.showStaffInfo&&k.staffInfoEnable&&k.staffInfoEnable.staffInfoChattingEnable&&view.showStaffInfo(),t.staffDetailInfoMsgList&&k.handleStaffMap(t.staffDetailInfoMsgList,t.notStore),k.publish("showChatStaffInfo"),k.publish("__chatStaffInfo",{staffId:k.paramChat.staffId,staffNickName:k.paramChat.staffName||"",staffPhone:k.paramChat.staffPhone,staffHead:k.staffImg,staffInfo:i.staffInfo||"",recordId:(k.isInRobot?"5_":"1_")+k.talkId})}),k.staffInfoRefreshMap={innerAD:{notEnableParam:!1,params:"[]",element:"#inner_frame",hash:!0,srcUrl:void 0,attr:"src",url:""},innerImgUrl:{attr:"href"},rightAD:null,leftAD:null,innerURL:{},merchantLink:null,staffInfo:null,urlList:null},k.subscribe("__chatStaffInfo",function(e,t){var i,a,s;for(i in k.staffInfoRefreshMap)if(a=k.staffInfoRefreshMap[i])if(k.isArray(a))for(var n=0;n<a.length;n++)o(a[n]);else o(a);function o(a){if(a.srcUrl){var n=k.getADURL(!a.notEnableParam,a.params,a.srcUrl,view.chat.paramChat,a.hash);$(a.element).each(function(e,t){var i=n;"IFRAME"==t.tagName&&(i=view.chat.addEchatInnerFrameParam(n)),"src"==a.attr?t.src=i:"href"==a.attr?t.href=i:$(t).attr(a.attr,i)}),a.url=s}}var r="media="+(view.windowType||"")+"&staffId="+(k.staffId||"")+"&staffName="+(k.staffName||"")+"&companyId="+(k.companyId||"")+"&talkId="+(k.talkId||"")+"&echatTag="+(k.queryParams.echattag||"");k.echatSourceTag=encodeURIComponent(r)}),this.subscribe("updateStaffInfo",this.updateStaffInfo),this.subscribe("chatEnded",function(e,t){var i,a=k.chatting,n=k.isInRobot,s="2"!=view.windowType&&k.queryParams.redirectUrl,o=1==t.changeRoute||1==t.closeTag;if(k.chatting=!1,k.isInRobot=0,k.hasGetHistory=!1,k.companyOff=void 0,k.staffImg=void 0,k.hasWaitingStatus=!1,k.endChatEvent(),k.publish("clearSendingMsg","endchat"),this.unSubscribe("_sendMsg"),view.toggleEnded&&view.toggleEnded("end"),$(".btn-close").addClass("hide"),$(".btn-qcode").addClass("hide"),$(".menu-capture").addClass("hide"),$(".menu-file").addClass("hide"),$("#robotToStaff").addClass("hide").hide(),k.hasEntryOrCode&&k.publish("entryCallback",{success:!0}),k.leaveAndClose&&("2"!=view.windowType&&k.queryParams.redirectUrl&&(location.href=k.queryParams.redirectUrl),$("#container").removeClass("hide"),$("#chat").removeClass("hide"),$("#footer").removeClass("hide"),$("html").removeClass("page-leave"),k.leaveAndClose=!1,k.showInfoTip('<div class="btn-restart" id="restartChat">'+lanRes.toContinueChat+"</div>",void 0,void 0,void 0,t.talkId,t.tm)),"10009"!=t.mt||4!=t.type&&10!=t.type||(k.paramChat.visEvt=k.initVisEvt,delete k.queryParams.autoPop,delete k.queryParams.autoChat),1!=t.changeRoute&&this.publish("_hideCloseBtn",t),$.cookie("ECHAT_"+k.companyId+"_"+window.chatVisitorId+"_chatStatus",0,{path:"/"}),t.justConnect)!0===a&&k.talkId&&(k.lastTalkIdForTemp=k.talkId);else{k.lastTalkIdForTemp=void 0,t.content&&k.publish("getSysMsg",t),k.hasLeaveMsg||1==t.changeRoute||t.fromHistory&&(!t.fromHistory||!1!==t.isForward||"605"!=t.mt&&"10009"!=t.mt)||($("#restartChat").parents("li").remove(),k.showInfoTip({f:"sys",tip:'<div class="btn-restart" id="restartChat">'+lanRes.toContinueChat+"</div>"},void 0,void 0,void 0,t.talkId,t.tm)),k.visitorClose=!t.fromHistory&&(1==t.closeReason||k.visitorClose&&"0"==t.closeReason),k.toggleEvaluateMenu(1);var r=!o&&!0===a&&k.showSatisfy(1);k.postMessage(3),o||t.fromHistory||r||1==k.toLeaveWord&&k.staffChatNeedConnect||s&&"2"!=view.windowType&&k.queryParams.redirectUrl||this.publish("_closeWin",t),t.talkId?k.talkId||(k.talkId=t.talkId):t.talkId=k.talkId,i=k.talkId,t.fromHistory&&!1!==t.isForward||("10009"!=t.mt||4!=t.type&&10!=t.type||(k.talkId="",$("#list_msg").show()),t.talkId&&k.handleSessionMsg(t),view.scrollToBottom()),k.talkId=i,t.fromHistory||(view.SDK||k.publish("__chatStatus","end-"+(t.closeReason||"0")+"-"+(r&&!n?"1":"0")),(k.staffChatNeedConnect||!view.SDK&&1==k.toLeaveWord||1==t.toChat)&&setTimeout(function(){k.publish("_triggerChat")},100))}}),this.subscribe("_closeWin",function(){if(!view.SDK&&k.visitorClose&&1!=k.toLeaveWord&&(k.leaveAndClose=!1,!(window.top==self&&window.EchatJsBridge||view.SDK)))if(2==view.windowType)view.isMsgBoxChat&&view.hasNative||k.postMessage("hideMBmini");else if(1==view.windowType)try{window.opener=null,window.open("","_self").close(),window.close()}catch(e){try{window.close()}catch(e){}}}),this.subscribe("entryCallback",function(e,t){if(1==t.success){if($("#entry").html("").hide(),$("#verify").hide(),$("#mask").hide(),$("body").removeClass("entry"),$("html").removeClass("entry2"),t.mid&&(delete k.queryParams.autoPop,delete k.queryParams.autoChat),k.hasEntryOrCode=!1,t.mt){k.no103=!1,k.publish("toRegisterChat");var i=k.entryParam;if(i){delete i.et,delete i.captcha;var a=$.store("ECHAT_"+k.companyId+"_ENTRY_HIS");a=a?JSON.parse(a):{},i=$.extend(a,i),$.store("ECHAT_"+k.companyId+"_ENTRY_HIS",JSON.stringify(i))}}}else k.publish("refreshVerify",{status:1})}),this.subscribe("receiveUnread",function(e,t){!view.SDKNative&&t.data.talkId&&(1<_$("list_msg").childNodes.length&&$("#list_msg").html(""),k.loadHistory(t.data.talkId)),k.talkId=t.data.talkId,k.unreadMsg?k.unreadMsg.push(t):k.unreadMsg=[t];var i,a,n,s,o=t.data.chatDetailList,r=o.length,l="",d="",c=0,u=t.data.staffDetailInfoList;if(u&&u.length&&(k.handleStaffMap(u,!1),s=k.staffMap[u[u.length-1].staffId]),r){n="downFile",k.isIOS&&(n="_blank");for(var f=0;f<r;f++)if(i=o[f],a="","686"!=o[f].mt)if("10001"!=o[f].mt){if("640"==o[f].mt||"675"==o[f].mt||"647"==o[f].mt)d=o[f].content;else if("10011"==o[f].mt){if(2==o[f].visibility)continue;2!=o[f].mst&&(o[f].staffId=void 0,o[f].staffNickName=void 0),d='<div class="clearfix custom-event-li" id="msg'+t.tm+'">'+k.getVisEvtHtml(o[f])+"</div>"}else if("641"==o[f].mt)k.needHttps&&(k.qiniuDomain&&k.qiniuHttpsDomain&&(i.bigImg=i.bigImg.replace(k.qiniuDomain,k.qiniuHttpsDomain),i.smallImg=i.smallImg.replace(k.qiniuDomain,k.qiniuHttpsDomain)),i.bigImg=i.bigImg.replace(/^http:/,k.needHttps),i.smallImg=i.smallImg.replace(/^http:/,k.needHttps)),d=view.showMsgImg&&view.showMsgImg(i)||'<img attname="'+i.fileName+'" bigimg="'+(i.bigImg||i.sourceImg||"")+'" src="'+i.smallImg+'" class="msg-img"/>';else if("642"==o[f].mt)a="unread-file",k.needHttps&&(k.qiniuDomain&&k.qiniuHttpsDomain&&(i.fileUrl=i.fileUrl.replace(k.qiniuDomain,k.qiniuHttpsDomain)),i.fileUrl=i.fileUrl.replace(/^http:/,k.needHttps)),d='<div class="file-info"><div class="file-name">'+i.fileName+'</div><a class="file-size file-link" href="'+i.fileUrl+(!i.fileUrl||!i.fileUrl.match(/http[s]?:\/\/[^\/]*(qn|qiniu)[^\/]*\//i)&&i.fileUrl.match(/http[s]?:\/\/[^\/]*(oss)[^\/]*\//i)?"":(-1==i.fileUrl.indexOf("?")?"?":"&")+"attname="+i.fileName)+'" target="'+n+'"><span class="unread-size">'+(parseInt(i.fileSize/1024)+1)+'KB</span><span class="unread-download color0">'+lanRes.download+'</span></a></div><div class="file-icon">&nbsp;</div>';else if("10012"!=o[f].mt&&680==o[f].mt){var m=o[f].pushUrlDetail.url,h="";if(view.chat.needHttps&&m.match(/^http:/i)&&(h=" push-blank"),view.pushURLParam){var p=m.split("#");m=p[0]+(-1==p[0].indexOf("?")?"?":"&")+view.pushURLParam+(p[1]?"#"+p[1]:"")}d='<a class="push-url clearfix'+h+'" target="info_frame3" href="'+m+'"><div class="push-icon echat bg1"></div><div class="push-content"><div class="push-name">'+o[f].pushUrlDetail.urlName+' </div><div class="push-url-link">'+o[f].pushUrlDetail.url+"</div></div></a>"}c++,d=680==o[f].mt?d:k.filterEmailPhoneLink(d),(d=(k.filterEmo(d)||"").replace(/\n/g,"</br>"))&&(s&&i.staffId&&i.staffId!=s.staffId&&(i.staffId=s.staffId),i.staffId&&k.staffMap[i.staffId]?(i.staffImg=k.staffMap[i.staffId].staffImg||k.defaultStaffImg,i.staffName=k.staffMap[i.staffId].staffName||i.staffNickName,k.needHttps&&i.staffImg&&(i.staffImg=i.staffImg.replace(/^http:/,k.needHttps)),l+='<li class="clearfix list-unread-li '+a+'"><div class="avatar-icon fl staff-icons"><img class="avatar-icon-img" src="'+i.staffImg+'"></div><div class="fl unread-staff-name">'+(i.staffName||lanRes.serviceStaff)+'：</div><div class="fl unread-msg">'+d+"</div></li>"):l+='<li class="clearfix list-unread-li '+(a="list-unread-sys")+'"><div class="avatar-icon fl staff-icons"><img class="avatar-icon-img" src="'+k.defaultStaffImg+'"></div><div class="fl unread-staff-name">'+lanRes.serviceSys+'：</div><div class="fl unread-msg">'+d+"</div></li>")}else s=k.updateStaffInfo(void 0,{staffId:i.toStaffId||i.staffId,staffNickName:i.staffNickName||i.toStaffNickName,staffDetailInfo:i.staffDetailInfo||i.toStaffDetailInfo});else i.staffDetailInfoList&&k.handleStaffMap(i.staffDetailInfoList,!1),i.staffDetailInfo&&(s=k.updateStaffInfo(void 0,i));$("#list_unread").append(l),view.showUnread&&view.showUnread(c)}}),$("#unread_close").on("click",function(){view.removeUnreadMsg&&view.removeUnreadMsg()}),$("#leave_tip").on("click",function(){k.tipTimer&&clearTimeout(k.tipTimer),$(this).addClass("tiphide")}),this.changeDocTitle=function(){if("title"in U)return function(e){U.title=e};var e,t=_$s("title");return t&&t[0]?e=t[0]:(e=U.createElement("title"),_$s("head")[0].appendChild(e)),"textContent"in e?function(e){_$s("title")[0].textContent=e}:"innerText"in e?function(e){_$s("title")[0].innerText=e}:function(){}}()},configToolMenus:function(e){var t=4;"1"!=(e=e||{}).toolEmoji?($(".menu-emo").addClass("hide-important"),t--):$(".menu-emo").removeClass("hide-important"),"1"!=e.toolFile?($(".menu-file").addClass("hide-important"),t--):$(".menu-file").removeClass("hide-important"),"1"!=e.toolSatisfaction?($(".menu-satisfy").addClass("hide-important"),t--):$(".menu-satisfy").removeClass("hide-important"),0<$(".menu-capture").length&&("1"!=e.toolScreenshot?($(".menu-capture").addClass("hide-important"),t--):$(".menu-capture").removeClass("hide-important")),0<$(".menu-phone").length&&("1"!=e.toolTelephone?($(".menu-phone").addClass("hide-important"),t--):$(".menu-phone").removeClass("hide-important")),0==t?($("#menu-tools").addClass("hide-important"),$("#container").addClass("menu-no-tools")):($("#menu-tools").removeClass("hide-important"),$("#container").removeClass("menu-no-tools"))},plainTextToSendMsg:function(e){var i=this;return charMap={"<":"&lt;",">":"&gt;",'"':"&quot;"},e=e.replace(/\[#([^#]+)#\]/g,function(e,t){return"[#"+(i.lanEmo[t]||t)+"#]"}).replace(/[<">]/g,function(e){return charMap[e]})},openVisitorSend:function(){var o=this;this.unSubscribe("_sendMsg"),this.subscribe("_sendMsg",function(e,t){if(!view.handleNetwok||!view.handleNetwok())if(o.isInRobot||!0===o.companyOff||o.busyCanSend||"0"==o.queryParams.autoChat||!0===o.chatting){var i=t||o.getInput(!0);if(i.trim())if(i.match(/^\[#echat::lihong#\]$/))o.loadConsole(7304);else{o.plainText&&(i=o.plainTextToSendMsg(i));var a=(new Date).getTime(),n="msg"+a,s={t:o.checkHistoryTime(a)?(new Date).format("hh:mm"):void 0,tm:a,mt:864,f:"c",m:0,c:i,id:n};o.sendToServer(s),t||(o.lastText=null,view.afterSend()),o.publish("_firstSendMsg",{c:i}),o.publish("_addSendMsgNum")}}else $("#busyTipLine").removeClass("hide").show()})},postMessage:function(e){if(!this.doNotHasPostMessage&&2==view.windowType&&window.top!=self)try{return window.parent.postMessage(e,this.queryParams.fromhost||"*"),!0}catch(e){this.doNotHasPostMessage=!0,console.log(e)}return!1},getVisitorMessage:function(){},initDialog:function(){var e=this;e.hasInitDialog||(e.hasInitDialog=!0,$("body").on("click",".dialog-close",function(){$(".dialog").remove(),e.publish("_dialogCanel")}).on("click",".img-close",function(){$(".dialog").remove(),e.publish("_dialogCanel")}).on("click",".dialog-cancel",function(){$(".dialog").remove(),e.publish("_dialogCanel")}).on("click",".dialog-ok",function(){$(".dialog").remove(),e.publish("_dialogOk")}))},showDialog:function(e){var n=this,s=n.isMobile?"tap":"click";$(".dialog").remove(),this.publish("_dialogCanel"),n.initDialog();var t=e.tip,i='<div class="dialog dialog-hide"><div class="dialog-close"><i class="img-close"></i></div><div class="dialog-title">'+lanRes.tip+'</div><div class="dialog-content">'+t+'</div><div class="dialog-btns"><a class="dialog-btn dialog-ok bg0"><div class="bg0 fade-div"></div><span>'+(e.okTip||lanRes.okay)+"</span></a>"+(!1!==e.cancel?'<a class="dialog-btn dialog-cancel bg0 has-fade"><div class="bg0 fade-div"></div><span>'+lanRes.cancel+"</span></a>":"")+"</div></div>";function o(e){var t=$(".dialog").results,i=$(".dialog-ok").results[0];if(0==t.length)$("body").off(s,o);else{var a=e.srcElement||e.target;setTimeout(function(){i==a||$.fn.contains(i,a)?n.publish("_dialogOk"):n.publish("_dialogCanel"),$(".dialog").remove()},50)}}$(_$("index")||"body").append(i),n.unSubscribe(["_dialogOk","_dialogCanel"]),n.subscribe("_dialogOk",function(){$("body").off(s,o),e.ok&&e.ok(),n.unSubscribe(["_dialogOk","_dialogCanel"])}),n.subscribe("_dialogCanel",function(){$("body").off(s,o),e.cancel&&e.cancel(),n.unSubscribe(["_dialogOk","_dialogCanel"])}),setTimeout(function(){$("body").on(s,o),$(".dialog").removeClass("dialog-hide")},10),view.inputBlur&&view.inputBlur(void 0,1)},showAlertDialog:function(e){$(".dialog").remove();var a=this;a.initDialog();var t=e.tip,i='<div class="dialog dialog-hide"><div class="dialog-title">'+lanRes.tip+'</div><div class="dialog-content">'+t+'</div><div class="dialog-btns"><a class="dialog-btn dialog-ok bg0"><div class="bg0 fade-div"></div><span>'+(e.okTip||lanRes.okay)+"</span></a></div></div>";function n(e){var t=$(".dialog").results,i=$(".dialog-ok").results[0];0==t.length?$("body").off(a.isMobile?"tap":"click",n):setTimeout(function(){i!=e.target&&!$.fn.contains(i,e.target)||(a.publish("_dialogOk"),$(".dialog").remove())},50)}$("body").append(i),$("#mask").show(),setTimeout(function(){$("#mask").show()},100),a.unSubscribe(["_dialogOk"]),a.subscribe("_dialogOk",function(){$("body").off(a.isMobile?"tap":"click",n),e.ok&&e.ok(),a.unSubscribe(["_dialogOk"]),$("#mask").hide()}),setTimeout(function(){$("body").on(a.isMobile?"tap":"click",n),$(".dialog").removeClass("dialog-hide")},10)},toShowEntry:function(t,e){$(window).on("resize",function(){var e=U.activeElement;"INPUT"!==e.tagName&&"TEXTAREA"!==e.tagName||setTimeout(function(){e.scrollIntoViewIfNeeded()},100)});var i,a,n,s,o,r,l,d,c=this,u="entry",f="",m="",h=[],p={},g=!1,v=t.fieldSettings||[],b=c.msg600.lan||t.lan||"default",y=decodeURIComponent($.store("ECHAT_"+c.companyId+"_ENTRY_HIS")||"{}");if(view.SDKNative||c.addCSS(c.isMobile&&!view.dji?__uri("/visitor/common/css/entry2.css"):__uri("/visitor/common/css/entry2pc.css")),$("#entry").remove(),view.dji&&1==t.entranceLevel)return!1;if(y=JSON.parse(y),1!=t.entranceLevel&&!0===c.companyOff&&0==t.offlineStartType&&(g=!0,v=[{enable:t.entranceLevel=1,field:"gender",fieldId:7106,isSystem:1,label:"性别",lan:"default",settings:[{configs:[{item:lanRes.male,sort:1,value:"1"},{item:lanRes.female,sort:2,value:"2"}],lan:"default"}],type:4,configs:[{item:lanRes.male,sort:1,value:"1"},{item:lanRes.female,sort:2,value:"2"}]},{enable:1,field:"maritalStatus",fieldId:7107,isSystem:1,label:"婚否",lan:"default",settings:[{configs:[{item:lanRes.married,sort:1,value:"2"},{item:lanRes.unmarried,sort:2,value:"1"}],lan:"default"}],type:4,configs:[{item:lanRes.married,sort:1,value:"2"},{item:lanRes.unmarried,sort:2,value:"1"}]},{enable:1,field:"age",fieldId:7109,isSystem:1,label:"年龄",lan:"default",settings:[{configs:{end:127,start:1,stepSize:1},lan:"default"}],type:7,configs:{end:127,start:1,stepSize:1}},{enable:1,field:"birthday",fieldId:7108,isSystem:1,label:"生日",settings:[],type:6}],t.upgradeOfflineVisitorInfoConfiguration=t.offlineVisitorInfoConfiguration,t.upgradeOfflineWelcomeWord=t.offlineWelcomeWord),1==t.entranceLevel){var w='<div class="entry2-item"><div class="entry2-label {{req}}"><span class="req-span">*</span><span class="entry2-name">{{configDesc}}:</span></div><div class="entry2-typeline {{req}}" lb="{{configDesc}}">{{typeline}}</div></div>',I={type1:'<input type="text" class="entry2-input {{req}}" maxlength="{{length}}" lb="{{configDesc}}" name="{{configName}}" value="{{value}}"/>',type6b:'<input type="date" class="entry2-input {{req}}" lb="{{configDesc}}" name="{{configName}}" value="{{value}}"/>',type6:'<div class="date-input-box"><input type="text" class="entry2-input date-show"/><input type="date" lb="{{configDesc}}" name="{{configName}}" value="{{value}}" class="entry2-input date-input"/><span class="date-select-icon echat-vs color0">&#xe638;</span></div>',type2:'<textarea class="entry2-textarea {{req}}" maxlength="{{length}}" rows="4" lb="{{configDesc}}" name="{{configName}}" autoHeight="true">{{value}}</textarea>',type4:'<div class="entry2-checkbox"><label><input name="{{configName}}" value="{{configs.value}}" lb="{{configs.item}}" type="radio" {{check}} /><span class="entry2-checkicon color0"></span><span>{{configs.item}}</span></label></div>',type5:'<div class="entry2-checkbox"><label><input name="{{configName}}" value="{{configs.value}}" lb="{{configs.item}}" type="checkbox" {{check}} /><span class="entry2-checkicon color0"></span><span>{{configs.item}}</span></label></div>',type3:'<option value="{{configs.value}}" {{check}} >{{configs.item}}</option>',type7:'<option value="{{configs.value}}" {{check}} >{{configs.item}}</option>'};o=(s=!0===c.companyOff?t.upgradeOfflineVisitorInfoConfiguration:t.upgradeVisitorInfoConfiguration)&&s.length||0,!0===c.companyOff&&(t.upgradeVisitorInfoSubmitTxt=t.upgradeOfflineVisitorInfoSubmitTxt,t.upgradeWelcomeWord=t.upgradeOfflineWelcomeWord),h.push(1!=view.windowType||view.dji?"entry2-mb":"entry2-pc"),!c.isMobile&&c.mini&&h.push("entry2-pc-mini"),h.push(!0===c.companyOff&&0==t.offlineStartType?"entry2-form":"entry2-half");for(var T=0;T<v.length;T++)if(a=null,(H=p[v[T].field]=v[T]).settings&&0<H.settings.length)if(1==H.settings.length)H.configs=H.settings[0].configs;else{for(var k=0;k<H.settings.length;k++){if(H.settings[k].lan==b){H.configs=H.settings[k].configs;break}"default"==H.settings[k].lan&&(a=H.settings[k].configs)}H.configs||(H.configs=a||H.settings[0].configs)}function C(e,t){for(var i=0;i<e.length;i++)if(e[i]==t)return 1}for(var S=0;S<o;S++)if(0==(i=s[S]).configWebVipVisitor&&c.isVip||0==i.configWebVisitor&&!c.isVip)i.disabled=!0;else{if(!p[i.configName]){if(!g){i.disabled=!0;continue}p[i.configName]={type:1}}var x=p[i.configName].type,_=y[i.configName];if(f=I["type"+x],6==x&&(window.ltIE10||c.isMobile))f=I.type6b;else if(4==x||5==x||3==x||7==x){if(n=p[i.configName].configs,f=[],_=_?_.split(","):_,3==x||7==x){if(7==x){for(var E=[],M=n.start;M<=n.end&&(E.push({item:M,value:M}),150!=E.length);M+=n.stepSize);n=E}f.push('<select class="entry2-select {{req}}" name="{{configName}}" lb="{{configDesc}}"><option value=""></option>')}for(var N=0;N<n.length;N++)f.push(I["type"+x].replace(/\{\{configs.item\}\}/g,n[N].item).replace("{{configs.value}}",n[N].value).replace("{{check}}",_&&C(_,n[N].value)?3==x||7==x?"selected":"checked":""));3!=x&&7!=x||f.push("</select>"),f=f.join("")}else 1!=x&&2!=x||(f=f.replace("{{length}}",(O[i.configName]||O[1==x?"text":"textarea"]).length));m+=w.replace("{{typeline}}",f).replace(/\{\{configName\}\}/g,i.configName).replace(/\{\{configDesc\}\}/g,i.configDesc).replace(/\{\{value\}\}/g,_||"").replace(/\{\{req\}\}/g,1==i.configRequired?"req":"")}return(!0===c.companyOff&&0==t.offlineStartType&&(m+=w.replace(/\{\{req\}\}/g,"req").replace(/\{\{configDesc\}\}/g,lanRes.leaveWordContent).replace("{{typeline}}",'<textarea rows="4" lb="'+lanRes.leaveWordContent+'" autoHeight="true"  class="entry2-textarea leave-entry-text req"></textarea>')),1==t.captChaEnable&&(m+=w.replace(/\{\{req\}\}/g,"req").replace(/\{\{configDesc\}\}/g,lanRes.validateCode).replace("{{typeline}}",'<input type="text" id="verify_input" lb="'+lanRes.validateCode+'" class="entry2-input entry2-input-code req" /><img alt="'+lanRes.validateCode+'" id="verify_img" src="'+c.dataHost+"/chatCaptCha.jpg?captChatToken="+e.captChaToken+'"/><span class="color0 cursor-p" id="verify_change">'+lanRes.nextPic+"</span>"),$(".verify-change").attr("id",""),$(".verify-img").attr("id",""),$(".verify-ok").attr("id",""),$(".verify-input").attr("id","")),m='<div id="entry" class="{{entryClass}}"><form id="entryForm" class="entry2-wrap"><div class="entry2-title bg0">{{upgradeWelcomeWord}}</div><div class="entry2-content"><div class="entry2-items">{{list}}</div>{{btns}}</form></div>'.replace("{{entryClass}}",h.join(" ")).replace("{{list}}",m).replace("{{upgradeWelcomeWord}}",t.upgradeWelcomeWord).replace("{{btns}}",1!=view.windowType||view.dji||!0!==c.companyOff||0!=t.offlineStartType?'<div class="entry2-submit"><div class="entry2-btn-submit bg0">{{upgradeVisitorInfoSubmitTxt}}</div></div></div>':"").replace("{{upgradeVisitorInfoSubmitTxt}}",!0===c.companyOff&&0==t.offlineStartType?lanRes.submit:t.upgradeVisitorInfoSubmitTxt).replace("{{close}}",lanRes.close).replace("{{submit}}",lanRes.submit),!0===c.companyOff&&0==t.offlineStartType)?(c.leaveAndClose=!0,view.showLeavePage?view.showLeavePage(t):(l=m,d=1!=view.windowType||view.dji||!0!==c.companyOff||0!=t.offlineStartType?".entry2-btn-submit":".leave-enter-btn",$(".verify-change").attr("id",""),$(".verify-img").attr("id",""),$(".verify-ok").attr("id",""),$(".verify-input").attr("id",""),1!=view.windowType||view.dji?$("body").append(l):$("#leave").html(l).removeClass("hide"),c.publish("removeLoading"),c.isMobile||1!=view.windowType||view.dji?$("#container").addClass("hide"):($("#chat").addClass("hide"),$(".btn-close").addClass("hide"),setTimeout(function(){$(".btn-close").addClass("hide")},100)),$("html").addClass("page-leave entry2"),$("#footer").addClass("hide"),setTimeout(function(){$("#mask").hide()},100),view.toLeaveMessage&&view.toLeaveMessage(),c.addEntryEvent({list:s,configData:t,submitSelector:d,crm20:p})),$("textarea[autoHeight]").autoHeight(),!0):($("body").append(m),$("html").addClass("entry2"),c.addEntryEvent({list:s,configData:t,submitSelector:".entry2-btn-submit",crm20:p}),$(".entry2-btn-close").on("click",function(e){c.visitorClose=!1,c.publish("_endChat"),c.publish("chatEnded",{}),!c.hasEntryOrCode&&"0"!=c.queryParams.autoChat||(c.publish("entryCallback",{success:!0}),c.publish("_endConnect")),delete c.queryParams.autoPop,delete c.queryParams.autoChat}),c.publish("removeLoading"),$("#mask").show(),$("textarea[autoHeight]").autoHeight(),!0)}o=(s=(!0===c.companyOff?t.offlineVisitorInfoConfiguration:t.visitorInfoConfiguration)||[])&&s.length||0,r=1!=t.captChaEnable&&q(s),c.needHttps&&t.visitorInfoBackImg&&(t.visitorInfoBackImg=t.visitorInfoBackImg.replace(/^http:/,c.needHttps)),t=$.extend({},t),!0===c.companyOff&&(t.welcomeWord=t.offlineWelcomeWord,t.welcomeWordPos=t.offlineWelcomeWordPos,t.entryCanClose=t.offlineEntryCanClose,t.visitorInfoCloseImg=t.offlineVisitorInfoCloseImg,t.visitorInfoClosePos=t.offlineVisitorInfoClosePos,t.visitorInfoFormPos=t.offlineVisitorInfoFormPos,t.visitorInfoBackImg=t.offlineVisitorInfoBackImg,t.visitorInfoLabelColor=t.offlineVisitorInfoLabelColor,t.visitorInfoInputColor=t.offlineVisitorInfoInputColor,t.visitorInfoSubmitPos=t.offlineVisitorInfoSubmitPos,t.visitorInfoSubmitTxt=t.offlineVisitorInfoSubmitTxt,t.buttonBackgroundColor=t.offlineButtonBackgroundColor,t.visitorInfoBackgroundColor=t.offlineVisitorInfoBackgroundColor,t.visitorInfoSubmitImg=t.offlineVisitorInfoSubmitImg),c.needHttps&&(t.visitorInfoCloseImg&&(t.visitorInfoCloseImg=t.visitorInfoCloseImg.replace(/^http:/,c.needHttps)),t.visitorInfoBackImg&&(t.visitorInfoBackImg=t.visitorInfoBackImg.replace(/^http:/,c.needHttps)),t.visitorInfoSubmitImg&&(t.visitorInfoSubmitImg=t.visitorInfoSubmitImg.replace(/^http:/,c.needHttps))),view.staticPx2rem&&(t.welcomeWordPos=t.welcomeWordPos&&view.staticPx2rem(t.welcomeWordPos),t.visitorInfoClosePos=t.visitorInfoClosePos&&view.staticPx2rem(t.visitorInfoClosePos),t.visitorInfoFormPos=t.visitorInfoFormPos&&view.staticPx2rem(t.visitorInfoFormPos),t.visitorInfoSubmitPos=t.visitorInfoSubmitPos&&view.staticPx2rem(t.visitorInfoSubmitPos));var R=' <div id="entryWrap" class="'+("1"==r?"book-all-line ":"")+'" >'+(1==t.entryCanClose&&t.visitorInfoCloseImg?'<div id="cancelEntryBtn" style="'+t.visitorInfoClosePos+'"><img src="'+t.visitorInfoCloseImg+'" onload="imgLoadResizeSelf(this)" /></div>':"")+(t.visitorInfoBackImg?'<div><img id="entryWrapImg" class="book-table-img hide" src="'+t.visitorInfoBackImg+'" onload="imgLoadResize(this,-1)" /></div>':"")+'<form id="entryForm" name="entryForm" class="book-items" ><div class="book-form-title" style="'+t.welcomeWordPos+'">'+(t.welcomeWord||"")+'</div> <div class="clearfix book-items-list" style="'+t.visitorInfoFormPos+';">',D=0,L=0,P=0;for(T=0;T<o;T++){var H,B=1==(H=s[T]).configRequired?" req ":"";if("1"==H.configInline?D=parseInt(D+1.5):D+=.5,"1"==H.configWebVipVisitor&&c.isVip||"1"==H.configWebVisitor&&!c.isVip){"1"==H.configInline?L=parseInt(L+1.5):L+=.5,0;var A=H.configName;_=y[A],x=window.ltIE10?"text":"birthday"==A?"date":"age"==A?"number":"text";R+='<div class="book-half book-item'+B+("1"==H.configInline?" book-one-line":"")+("gender"==A||"maritalStatus"==A?" book-item-opts":"")+'"><label class="book-label" style="color:'+t.visitorInfoLabelColor+'"><span class="req-span color0">*</span><span class="name-span">'+H.configDesc+"</span></label>"+("gender"==A?'<label class="input-radio-lb" style="color:'+t.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+B+'" name="gender" value="1" '+(1==_?'checked="checked"':"")+' lb="'+H.configDesc+'"/><span class="radio-span">'+lanRes.male+'</span></label><label class="input-radio-lb" style="color:'+t.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+B+'" name="gender" value="2" '+(2==_?'checked="checked"':"")+' lb="'+H.configDesc+'" /><span class="radio-span">'+lanRes.female+"</span></label>":"maritalStatus"==A?'<label class="input-radio-lb" style="color:'+t.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+B+'" name="maritalStatus" value="1" '+(1==_?'checked="checked"':"")+' lb="'+H.configDesc+'"/><span class="radio-span">'+lanRes.unmarried+'</span></label><label class="input-radio-lb" style="color:'+t.visitorInfoLabelColor+'"><input type="radio" class="book-radio '+B+'" name="maritalStatus" value="2" '+(2==_?'checked="checked"':"")+' lb="'+H.configDesc+'"/><span class="radio-span">'+lanRes.married+"</span></label>":'<input type="'+x+'" lb="'+H.configDesc+'" class="book-ipt '+B+'" name="'+A+'" value="'+(_||"")+'" style="border-bottom-color:'+t.visitorInfoInputColor+";color:"+t.visitorInfoInputColor+';"/>')+"</div>"}else s[T].disabled=!0,P++}if(1==t.captChaEnable&&(R+='<div class="clearfix"><div class="book-half book-item req" id="verifyInner"><label class="book-label" style="color:'+t.visitorInfoLabelColor+'"><span class="req-span color0">*</span><span class="name-span">'+lanRes.validateCode+'</span></label><input type="text" id="verify_input" class="book-ipt req" lb="'+lanRes.validateCode+'" style="border-color:'+t.visitorInfoInputColor+'"/></div><div class="book-half book-item verify-line"><img alt="'+lanRes.validateCode+'" id="verify_img" src="'+c.dataHost+"/chatCaptCha.jpg?captChatToken="+e.captChaToken+'"/><span class="color0 cursor-p" id="verify_change">'+lanRes.nextPic+"</span></div></div>",$(".verify-change").attr("id",""),$(".verify-img").attr("id",""),$(".verify-ok").attr("id",""),$(".verify-input").attr("id","")),R+="</div>",R+='<div id="submitBtnentry" style="'+t.visitorInfoSubmitPos+'" class="book-btn"> <span class="book-btn-text">'+(t.visitorInfoSubmitTxt||"")+"</span></div>",R+="</form></div>",$("body").append('<div id="entry" class="entry-wrap">'+R+"</div>").show(),1==view.windowType&&(D=parseInt(D+.5),L=parseInt(L+.5),P=D-L),0<P&&setTimeout(function(){$(".book-items-list").css("paddingBottom",view.px2rem?view.px2rem(30*P):30*P+"px")},10),c.publish("removeLoading"),$("#mask").show(),$("body").addClass("entry"),t.visitorInfoSubmitImg&&!view.SDK){c.needHttps&&(t.visitorInfoSubmitImg=t.visitorInfoSubmitImg.replace(/^http:/,c.needHttps));var F=new Image;F.onload=function(){var e=_$("submitBtn"+u).style;e.backgroundImage="url('"+t.visitorInfoSubmitImg+"')",e.backgroundSize=(view.px2rem?view.px2rem(this.width):this.width+"px")+" "+(view.px2rem?view.px2rem(this.height):this.height+"px"),e.lineHeight=view.px2rem?view.px2rem(this.height):this.height+"px",e.height=view.px2rem?view.px2rem(this.height):this.height+"px",e.width=view.px2rem?view.px2rem(this.width):this.width+"px",F=e=null},F.src=t.visitorInfoSubmitImg}return $("#cancelEntryBtn").on("click",function(e){c.visitorClose=!1,c.publish("_endChat"),c.publish("chatEnded",{}),!c.hasEntryOrCode&&"0"!=c.queryParams.autoChat||(c.publish("entryCallback",{success:!0}),c.publish("_endConnect")),delete c.queryParams.autoPop,delete c.queryParams.autoChat}),c.addEntryEvent({list:s,configData:t,submitSelector:"#submitBtn"+u}),setTimeout(function(){var e=_$("entryForm").offsetHeight+(view.px2px?view.px2px(20):20)+_$("entryForm").offsetTop;_$("entry").style.minHeight=e+"px"},100),!0},addEntryEvent:function(e,f){var m=e.list,h=e.configData,t=e.submitSelector,p=(e.crm20,this);1==h.captChaEnable&&p.toShowCode(),view.handleShowEntry&&setTimeout(function(){view.handleShowEntry()},15),$("input",_$("entryForm")).bind("blur",function(){var e=this.name;b(this,v(null,this,e).val,e,function(e){})}),$("textarea",_$("entryForm")).bind("blur",function(){var e=this.value.replace(/^[\s]+|[\s]+$/gi,"");b(this,e,"textarea",function(e){})}),$("select",_$("entryForm")).bind("change",function(){b(this,this.value,"select",function(e){})}),$(".date-input",_$("entryForm")).bind("change",function(e){var t=$(".date-show",this.parentNode);t&&t.val(this.value)});var g=!1;function i(e){if(g)return!1;for(var t,i,a,n=_$("entryForm"),s={windowType:view.windowType},o="",r=!0,l=0,d=m.length;l<d;l++)if(u=null,i=m[l].configName,t=n[i],!m[l].disabled){if(u=(a=v(null,t,i)).val,!(r=b(t,u,i,function(e){t.nodeType?e?$(t).removeClass("error"):$(t).addClass("error"):t[0]&&t[0].nodeType&&$(t[0].parentNode.parentNode).addClass("error")})&&r))return!1;u&&r&&(o+=a.label+" "+a.labelVal+"\r\n "),s[i]=u}if(console.log(o),view.handleNetwok&&view.handleNetwok())return!1;if(s.leaveContent=void 0,p.leaveAndClose){var c=$(".leave-entry-text").results[0];if(b(c,c.value,"content",function(e){c.nodeType&&(e?$(c).removeClass("error"):$(c).addClass("error"))}),!c.value)return!1}if(1==h.captChaEnable){if($("#verify_change").hasClass("loadin"))return!1;var u;if(!(u=$("#verify_input").val()))return $("#verify_input").addClass("error"),!1;$("#verify_change").addClass("loadin"),s.captcha=u}return s.et=106,"1"==p.queryParams.autoPop&&(s.isAutoPop=1),g=!0,p.entryParam=s,p.entryVisitorMsg=o,p.entryLeaveContent=c&&c.value,p.publish("visitorCommonEvent",s,function(e){e&&e.successful&&f&&f(),1==h.captChaEnable&&$("#verify_change").removeClass("loadin"),g=!1}),!1}_$("entryForm").onsubmit=i,$(t).off("click").on("click",i)},toShowCode:function(){var i=this;function e(){if(!$("#verify_change").hasClass("loadin")){$("#verify_change").addClass("loadin");var e={et:122,windowType:view.windowType,content:"refresh code"};"1"==i.queryParams.autoPop&&(e.isAutoPop=1),i.publish("visitorCommonEvent",e)}}this.codeShowed&&($("#verify_change").removeClass("loadin"),$("#verify_input").removeClass("error").val("")),this.codeShowed=!0,$("#verify_img").off("click").bind("click",e),$("#verify_change").off("click").bind("click",e),$("#verify_input").off("click").bind("keydown",function(){$("#verify_input").removeClass("error")}),$("#verify_ok").off("click").bind("click",function(){if(!$("#verify_change").hasClass("loadin")){var e=$("#verify_input").val();if(e){$("#verify_change").addClass("loadin");var t={et:106,captcha:e,windowType:view.windowType};"1"==i.queryParams.autoPop&&(t.isAutoPop=1),i.publish("visitorCommonEvent",t,function(){})}else $("#verify_input").addClass("error")}})},toShowQcode:function(){var a=this;function i(e){if($("#qcode_loading").show(),$("#qcode_img").attr("loaded","loaded").hide(),e){var t=(a.dataHost||"")+"/cqr?"+(a.needHttps?"ssl=1&":"")+"chatToken="+e,i=new Image;i.onload=function(){$("#qcode_loading").hide(),$("#qcode_img").attr({loaded:"loaded",src:t}).show(),setTimeout(function(){$("#qcode_img").removeAttr("loaded"),a.publish("_toGetChatToken")},54e4)},i.onerror=function(e){$("#qcode_img").removeAttr("loaded")},i.src=t}else a.publish("_toGetChatToken")}return view.qcodeWechat||(a.subscribe("getChatToken",function(e,t){i(t.chatToken)}),a.subscribe("_toGetChatToken",function(){a.publish("visitorCommonEvent",{et:120,companyId:a.companyId})})),view.toggleQcode&&view.toggleQcode(i),!0},toInitEvaluate:function(e){var t,i,l=this,d=!1,a=e.evaluateInfo||e.smallEvaluateInfo||e.mobileEvaluateInfo||e.sdkEvaluateInfo||l.msg649&&(l.msg649.evaluateInfo||e.smallEvaluateInfo||l.msg649.mobileEvaluateInfo||l.msg649.sdkEvaluateInfo);if(!a)return l.satisfyEnable=!1,void this.toggleEvaluateMenu(1);if(0==a.enable?(l.satisfyEnable=!1,this.toggleEvaluateMenu(6)):(this.toggleEvaluateMenu(5),l.satisfyEnable=!0,1==a.enableVisitorEvaluateLimit&&0<parseInt(a.allowEvaluateBaseWords)&&(l.allowEvaluateBaseWords=parseInt(a.allowEvaluateBaseWords),l.sendMsgNum<l.allowEvaluateBaseWords?this.toggleEvaluateMenu(3):this.toggleEvaluateMenu(4))),!this.hasInitEvaluate){l.hasInitEvaluate=!0,(i=(t=m=1==a.evaluateType)?1==a.bestEnable?5:1==a.betterEnable?4:1==a.commonEnable?3:1==a.worseEnable?2:1==a.worstEnable&&1:5)||(i=5,d=!0),$("#satisfy_ipt").val(i);var n='<div class="sa-title tc"><div class="sa-title-left"></div><div class="sa-title-content"><span langs="evaluateTip">'+lanRes.evaluateTip+'</span><span class="sa-name sa-name5 emcolor">'+a.bestDesc+'</span><span class="sa-name sa-name4 emcolor">'+a.betterDesc+'</span><span class="sa-name sa-name3 emcolor">'+a.commonDesc+'</span><span class="sa-name sa-name2 emcolor">'+a.worseDesc+'</span><span class="sa-name sa-name1 emcolor">'+a.worstDesc+'</span></div><div class="sa-title-right"></div></div>';if(t&&!d?(n+='<ul class="sa-imgs clearfix">',1==a.worstEnable&&(n+='<li class="sa-img sa-img1" v="1"><img class="sa-s-img" v="1" src="'+a.worstSelected.replace(/^http:/,l.needHttps||"http:")+'"/><img class="sa-un-img" v="1" src="'+a.worstUnSelected.replace(/^http:/,l.needHttps||"http:")+'"/></li>'),1==a.worseEnable&&(n+='<li class="sa-img sa-img2" v="2"><img class="sa-s-img" v="2" src="'+a.worseSelected.replace(/^http:/,l.needHttps||"http:")+'"/><img class="sa-un-img" v="2" src="'+a.worseUnSelected.replace(/^http:/,l.needHttps||"http:")+'"/></li>'),1==a.commonEnable&&(n+='<li class="sa-img sa-img3" v="3"><img class="sa-s-img" v="3" src="'+a.commonSelected.replace(/^http:/,l.needHttps||"http:")+'"/><img class="sa-un-img" v="3" src="'+a.commonUnSelected.replace(/^http:/,l.needHttps||"http:")+'"/></li>'),1==a.betterEnable&&(n+='<li class="sa-img sa-img4" v="4"><img class="sa-s-img" v="4" src="'+a.betterSelected.replace(/^http:/,l.needHttps||"http:")+'"/><img class="sa-un-img" v="4" src="'+a.betterUnSelected.replace(/^http:/,l.needHttps||"http:")+'"/></li>'),1==a.bestEnable&&(n+='<li class="sa-img sa-img5 sa-sli5" v="5"><img class="sa-s-img" v="5" src="'+a.bestSelected.replace(/^http:/,l.needHttps||"http:")+'"/><img class="sa-un-img" v="5" src="'+a.bestUnSelected.replace(/^http:/,l.needHttps||"http:")+'"/></li>'),n+="</ul>"):n+='<ul class="sa-stars clearfix"><li class="sa-sli sa-star emcolor" v="1">&#xe64d;</li><li class="sa-sli sa-star emcolor" v="2">&#xe64d;</li><li class="sa-sli sa-star emcolor" v="3">&#xe64d;</li><li class="sa-sli sa-star emcolor" v="4">&#xe64d;</li><li class="sa-sli sa-star emcolor sa-sli5" v="5">&#xe64d;</li></ul>',!t||!d){n+='<div class="sub-tabs clearfix " >',view.SDK&&(n+="<div>");for(var s=["worstConfiguration","worseConfiguration","commonConfiguration","betterConfiguration","bestConfiguration"],o=5;0<o;o--){var r=a[s[o-1]]||[],c=r.length;n+='<ul class="sub-tab sub-tab'+o+'" '+(0<c?"":'style="display:none"')+' id="subEvaluate'+o+'"> ';for(var u=0;u<c;u++){var f=r[u];n+='<li class="sa-cli" dataname="'+f.configName+'">'+f.configDesc+"</li>"}n+="</ul>"}view.SDK&&(n+="</div>"),n+="</div>"}$("#satisfyConfig").html(n).addClass("sa-sel-"+i).attr("default",i),view.handleSatisfy&&view.handleSatisfy(d,t,i),$("#sa_ok").on(l.isMobile?"touchend":"click",function(e){if(view.handleNetwok&&view.handleNetwok())return!1;$.store("ECHAT_inviteSatisfyHandle",$.store("ECHAT_inviteSatisfyId")),l.isMobile&&e.preventDefault();var i=$("#sa_advise").val(),a=$("#satisfy_ipt").val(),t="";if("0"!=a&&a){if(!d){var n=$(".sa-cli",_$("subEvaluate"+a)).results||[],s=n.length;if(0<s)for(var o=0;o<s;o++)t+="&"+[$(n[o]).attr("dataname")]+"="+($(n[o]).hasClass("sub-selected")?1:0)}var r=l.dataHost+"/ces?companyId="+l.companyId+"&talkId="+l.talkId+"&visitorId="+encodeURIComponent(l.visitorId||"")+(view.SDK?"&appId="+encodeURIComponent(l.appId||""):"")+"&nonce="+encodeURIComponent(l.restartParam.nonce||"")+"&reChatTag="+encodeURIComponent(l.restartParam.reChatTag||"")+"&mainItem="+a+"&evaluateType="+l.satisfyType+"&media="+l.Device.media+"&windowType="+view.windowType+"&lan="+(window.lanName||"")+"&comment="+encodeURIComponent(i||"")+t;console.log("url***",r),$.ajax({url:r,type:"jsonp",jsonpCB:"jsonpCallback",success:function(e){if(console.log(e),l.satisfyShowed=l.talkId,1==e)l.evaluateScore=a,h(lanRes.successSubmitEval,"ok"),view.resetSatisfy&&view.resetSatisfy(),!1===l.chatting?(l.publish("_closeWin"),l.publish("__evaluate","1-2")):l.publish("__evaluate","1-1"),i&&l.publish("__evaluateComment",{comment:i,chatting:l.chatting});else{var t=lanRes.unkownErrorSubmitEval;129==e?t=lanRes.evaluateTimeout:130==e?t=lanRes.evaluateRepeat:133==e&&(t=lanRes.evaluateRepeatTime),h(t)}},error:function(){h(lanRes.unkownErrorSubmitEval)}}),$("#satisfy").removeClass("satisfy-show").hide(),$("#mask").off("click",l.hideSatisfy),$("#mask").hide(),_$("sa_advise").blur(),view.hideSatisfy&&view.hideSatisfy()}}),$("#sa_cancel").on(l.isMobile?"touchend":"click",function(e){l.hideSatisfy(),l.isMobile&&e.preventDefault()})}},toggleEvaluateMenu:function(e){if(view.decideEvalMenu)return view.decideEvalMenu(e%2);var t=$(".menu-satisfy"),i="show",a="hide",n="limit-hide";1==e?t.addClass(a).removeClass(i):2==e?t.removeClass(a):3==e?t.addClass(n):4==e?t.removeClass(n).removeClass(a):5==e?t.addClass(i).removeClass(a):6==e&&t.hide(),this.hasWaitingStatus&&t.addClass(a).removeClass(i),view.calcUrlList&&view.calcUrlList()},staffMap:{},handleStaffMap:function(e,t){var i,a=this,n={};if(e&&0<e.length)for(var s=0;s<e.length;s++)e[s].staffHead&&a.needHttps&&(e[s].staffHead=e[s].staffHead.replace(/^http:/,a.needHttps)),n[e[s].staffId+""]={staffId:e[s].staffId,staffName:e[s].staffNickName||lanRes.serviceStaff,staffImg:e[s].staffHead||a.defaultStaffImg},i=i||n[e[s].staffId+""];a.staffMap=t?$.extend(n,a.staffMap):$.extend(a.staffMap,n)},updateStaffInfo:function(e,t){if(t&&t.staffId){var i={};return i[t.staffId]={staffId:t.staffId,staffName:t.staffNickName||lanRes.serviceStaff,staffImg:t.staffHead||t.staffDetailInfo&&t.staffDetailInfo.staffHead||this.defaultStaffImg},$.extend(this.staffMap,i),i[t.staffId]}},startChat:function(e,t){var g=this;g.hasWaitingStatus=!1,g.companyOff=!1,"679"!=t.mt&&"686"!=t.mt&&t.talkId&&!0===this.chatting&&this.staffId!=t.staffId&&this.talkId==t.talkId&&this.publish("getSysMsg",{talkId:t.talkId,tm:t.tm,mt:"10001",staffId:t.staffId,staffName:t.staffNickName},t),t.staffDetailInfo&&$.cookie("ECHAT_"+window.companyId+"_"+window.chatVisitorId+"_staffHead",t.staffDetailInfo.staffHead||"",{path:"/"}),$.cookie("ECHAT_"+g.companyId+"_"+window.chatVisitorId+"_chatStatus",2,{path:"/"}),this.satisfyShowed!=t.talkId&&(this.satisfyShowed=0),g.talkId&&g.talkId!=t.talkId&&(g.lastTalkIdForTemp=g.talkId),this.chatting=!0,t.talkId&&(this.talkId=t.talkId),"679"!=t.mt&&(this.staffId=t.staffId,this.staffName=t.staffNickName),this.paramChat.talkId=this.talkId,this.paramChat.staffId=this.staffId,this.paramChat.staffName=this.staffName,g.publish("__chatStatus","chatting"),g.initQcode(),delete g.queryParams.autoPop,delete g.queryParams.autoChat,$("#busyTipLine").addClass("hide").hide(),1==t.startType&&g.publish("__chatStart",t.staffNickName),g.lastTalkIdForTemp&&(g.lastTalkIdForTemp!=g.talkId&&g.handleSessionMsg({talkId:g.lastTalkIdForTemp}),g.lastTalkIdForTemp=void 0),t.staffDetailInfo&&g.publish("staffInfo",t),$(".menu-capture").removeClass("hide"),$(".menu-file").removeClass("hide"),this.publish("entryCallback",{success:!0}),this.endChatEvent(),g.lastText=null,g.typingTimer=setTimeout(function e(){var t=g.getInput(!1),i=t;(t=t.replace(/^[\n\r\s]+$/,""))&&g.lastText!=t&&(g.lastText=t,g.plainText&&(i=g.plainTextToSendMsg(t)),g.publish("sendVisitorEvent",{et:104,content:i})),g.typingTimer=setTimeout(e,2e3)},2e3),this.subscribe("getMsgTyping",function(e,t){g.showTyping()}),this.subscribe("staffStatus",function(e,t){if(1!=t.status){g.publish("_staffEndChat",t);var i=new Date;this.showMsg({f:"s",t:g.checkHistoryTime(i.getTime())?i.format("hh:mm"):void 0},lanRes.staffLeaveEnd)}}),this.subscribe("inviteBook",function(e,t){var i,a=t.templateInfoList;0==(i=1==view.windowType&&(0==a[0].type||1==a[0].type)||1!=view.windowType&&(2==a[0].type||3==a[0].type)?a[0]:a[1]).type||2==i.type?g._getMsg({mt:t.mt,tm:t.tm,notEnd:t.notEnd,content:g.showInfoTip({f:"sys",tip:"客服给您发送了一个预约表。"},void 0,void 0,!0,t.talkId,t.tm,t.notEnd)},4,function(t,e,i){var d=t.groupId,c=g.bookformi++,u=t.configuration,f=u.length,a=1!=t.captChaEnable&&q(u);g.needHttps&&t.backImg&&(t.backImg=t.backImg.replace(/^http:/,g.needHttps));for(var n=' <div id="inviteBook'+c+'" class="book-table '+("1"==a?"book-all-line":"")+'" >'+(t.backImg?'<div><img id="inviteBookImg'+c+'" class="book-table-img hide" src="'+t.backImg+'" onload="imgLoadResize(this,'+c+')"/></div>':"")+'<form id="inviteBookForm'+c+'" class="book-items"> <div class="clearfix book-items-list" style="'+t.formPos+';">',s=0;s<f;s++){var o=u[s],r=1==o.configRequired?"req":"",l=window.ltIE10?"text":"birthday"==o.configName?"date":"age"==o.configName?"number":"text";n+='<div class="book-half book-item '+("1"==o.configInline?"book-one-line":"")+'"><label class="book-label" style="color:'+t.labelColor+'">'+o.configDesc+"</label>"+("gender"==o.configName?'&nbsp;&nbsp;<input type="radio" class="book-radio '+r+'" name="gender" value="1" lb="'+o.configDesc+'"/><span style="color:'+t.inputColor+';">'+lanRes.male+'</span> <input type="radio" class="book-radio '+r+'" name="gender" value="2" /><span style="color:'+t.inputColor+';">'+lanRes.female+"</span>":"maritalStatus"==o.configName?'&nbsp;&nbsp;<input type="radio" class="book-radio '+r+'" name="maritalStatus" value="1" lb="'+o.configDesc+'"/><span  style="color:'+t.inputColor+';">'+lanRes.unmarried+'</span><input type="radio" class="book-radio '+r+'" name="maritalStatus" value="2" /><span  style="color:'+t.inputColor+';">'+lanRes.married+"</span>":'<input type="'+l+'" lb="'+o.configDesc+'" class="book-ipt '+r+'" name="'+o.configName+'" style="border-bottom-color:'+t.inputColor+";color:"+t.inputColor+';"/>')+"</div>"}if(n+="</div>",n+='<div id="submitBtn'+c+'" style="'+t.submitPos+'" class="book-btn"> <span class="book-btn-text">'+(t.submitTxt||"")+"</span></div>",n+="</form></div>",$(g.getListMsgEl(e,i)).append('<li id="inviteBookLi'+c+'" class="clearfix book-wrap">'+n+"</li>"),t.submitImg){var m=new Image;g.needHttps&&(t.submitImg=t.submitImg.replace(/^http:/,g.needHttps)),m.onload=function(){var e=_$("submitBtn"+c).style;e.backgroundImage="url('"+t.submitImg+"')",e.lineHeight=view.px2rem?view.px2rem(this.height):this.height+"px",e.height=view.px2rem?view.px2rem(this.height):this.height+"px",e.width=view.px2rem?view.px2rem(this.width):this.width+"px",t=m=e=null},t.submitImg&&(m.src=t.submitImg)}$("input",_$("inviteBook"+c)).bind("blur",function(){var e=this.name,t=this.value.replace(/^[\s]+|[\s]+$/gi,"");b(this,t,e,function(e){})});var h=0;function p(e){if(h)return!1;for(var t,i=_$("inviteBookForm"+c),a="companyId="+g.companyId+"&visitorId="+g.visitorId+"&groupId="+d+"&p="+encodeURIComponent(g.encryptVID),n=!0,s=0;s<f;s++){t=null;var o=u[s].configName,r=i[o];if(!r.value&&1<r.length&&r[0])for(var l=0;l<r.length;l++)r[l].checked&&(t=r[l].value);if(!(n=b(r,t=(t=t||r.value).replace(/^[\s]+|[\s]+$/gi,""),o,function(e){})&&n))return!1;a+="&"+o+"="+t}return n&&(h=1,$.ajax({url:g.dataHost+"/cvi?"+a,type:"jsonp",jsonpCB:"jsonpCallback",success:function(e){h=0,1==e?$(".book-wrap").remove():g.showInfoTip(lanRes.unkownErrorSubmit,void 0,"warn")},error:function(){h=0,g.showInfoTip(lanRes.unkownErrorSubmit,void 0,"warn")}})),!1}$("#submitBtn"+c).bind(g.isMobile?"tap":"click",p),_$("inviteBookForm"+c).onsubmit=p,g.isMobile,setTimeout(function(){var e=_$("inviteBookForm"+c).offsetHeight+(view.px2px?view.px2px(20):20)+_$("inviteBookForm"+c).offsetTop;_$("inviteBookLi"+c).style.minHeight=e+"px",view.scrollToBottom()},100)}(i,t.talkId,t.tm),"x"):g._getMsg({mt:t.mt,tm:t.tm,content:a},3,g.getBookComfirm(a),"x")}),this.subscribe("inviteBookOK",function(e,t){if(console.log("不应发送892 inviteBookOK "),1==t.success){if($("#entry").hide(),$("#verify").hide(),$("#mask").hide(),g.hasEntryOrCode=!1,t.mt){var i=g.entryParam;if(i){delete i.et,delete i.captcha;var a=$.store("ECHAT_"+g.companyId+"_ENTRY_HIS");a=a?JSON.parse(a):{},i=$.extend(a,i),$.store("ECHAT_"+g.companyId+"_ENTRY_HIS",JSON.stringify(i))}}}else g.publish("refreshVerify",{status:1});$(".book-wrap").remove(),g.showInfoTip({f:"sys",tip:lanRes.submitInfoSucc})})},getADURL:function(e,t,i,a,n,s){if(!i)return"";if(!e||"0"==e||!t)return i;a=a||this.paramChat;var o="",r="",l="",d=i.split("#"),c=d[1]||"",u=d[0],f=-1==u.indexOf("?")?0:1,m="?";"string"==typeof t&&(t=JSON.parse(t));var h,p,g,v,b,y=["companyId","visitorId","echatTag","lan","country","province","city","searcher","keyword","metaData","referrer","firstUrl","chatPage","chatPageTitle","eventId","osName","staffId","staffName","staffPhoto","talkId","staffPhone","staffInfo"];if(view.chat.isArray(t)&&t.length){for(h=t.length,g=0;g<y.length&&("staffId"==(v=y[g])&&(r=o,o="",n&&(m="",f=c?1:0)),"staffId"!=v||a.staffId);g++)for(p=0;p<h;p++)if("metaData"!=(b=t[p].paramName)&&"metadata"!=b||(b="metaData"),b==v){"metaData"==b?(o+=(0!=f?"&":m)+b+"="+encodeURIComponent(a[b]||""),o+=(0!=++f?"&":m)+(b="myData")+"="+encodeURIComponent(a[b]||""),f++,a[b="info"]&&(o+=(0!=f?"&":m)+b+"="+encodeURIComponent(a[b]||""),f++)):(o+="staffId"==b?(0!=f?"&":m)+b+"="+("-1"==encodeURIComponent(a[b]||"")?"":encodeURIComponent(a[b]||"")):(0!=f?"&":m)+b+"="+encodeURIComponent(a[b]||""),f++);break}y.length==g&&(l=o,o="")}return n?u+r+(c?"#"+c+l:"#"+l):u+r+l+(c?"#"+c:"")},setInnerAD:function(n){if(n.data){var e,t,i,a,s=n.data,o=this,r=s.chatBoxAdHeight;r=r?parseInt(r):0,$(".innerAD").each(function(){$("#list_msg").contains(this)||$(this).remove()}),$("#innerADWrap").addClass("hide"),2==s.chatBoxInnerAdType?(e=s.chatBoxInnerAdContent)&&(t='<li class="clearfix innerAD innerAD-text"><div>'+e+"</div></li>"):3==s.chatBoxInnerAdType&&r?((e=s.chatBoxInnerAdImg)&&view.chat.needHttps&&(e=e.replace(/^http:/,view.chat.needHttps)),o.lastLoadInnerImgName=a=(new Date).getTime(),window["resetInnerAdHeight"+a]=function(e,t,i){if(i==view.chat.lastLoadInnerImgName){var a=(e<t?e:t)+20;1==s.chatBoxAdImgLinkFixed?($("#innerADWrap").css("height",a+"px"),n.height($("#portrait").height()+a)):n.height($("#portrait").height())}},e&&s.chatBoxInnerAdImgLinkUrl?(i=o.getADURL(s.chatBoxAdPostEnable,s.chatBoxInnerAdPostParamList||"{}",s.chatBoxInnerAdImgLinkUrl,view.chat.paramChat,1!=s.chatBoxInnerAdParamAppendType),t='<li class="clearfix innerAD innerAD-img"><a id="innerADLink" target="'+(1==s.chatBoxInnerAdImgLinkOpenType?view.SDK?"cover":"_blank":"inner")+'" href="'+i+'"><img onload="resetInnerAdHeight'+a+"(this.height,"+r+","+a+')" onerror="resetInnerAdHeight'+a+"(this.height,"+r+","+a+')" style="max-height:'+r+'px" src="'+e+'"/></a></li>',$.extend(o.staffInfoRefreshMap.innerImgUrl,{notEnableParam:1!=s.chatBoxAdPostEnable,srcUrl:s.chatBoxInnerAdImgLinkUrl,url:e,params:s.chatBoxInnerAdPostParamList||"{}",hash:1!=s.chatBoxInnerAdParamAppendType,element:"#innerADLink"})):e&&(t='<li class="clearfix innerAD innerAD-img"><img onload="resetInnerAdHeight'+a+"(this.height,"+r+","+a+')" style="max-height:'+r+'px" src="'+e+'"/></li>')):1==s.chatBoxInnerAdType&&r&&((e=s.chatBoxInnerAdUrl)&&view.chat.needHttps&&(e=e.replace(/^http:/,view.chat.needHttps)),(e=o.getADURL(s.chatBoxAdPostEnable,s.chatBoxInnerAdPostParamList||"{}",s.chatBoxInnerAdUrl,view.chat.paramChat,1!=s.chatBoxInnerAdParamAppendType))&&"0"!=s.chatBoxAdHeight&&(t='<li class="clearfix innerAD innerAD-url"><iframe id="inner_frame" class="ps-child" height="'+s.chatBoxAdHeight+'px" border="0" allowtransparency="true" scrolling="no" frameborder="0" style="width:100%;height:'+s.chatBoxAdHeight+'px" src="'+view.chat.addEchatInnerFrameParam(e)+'" ></iframe></li>'),$.extend(o.staffInfoRefreshMap.innerAD,{notEnableParam:1!=s.chatBoxAdPostEnable,srcUrl:s.chatBoxInnerAdUrl,url:e,params:s.chatBoxInnerAdPostParamList||"{}",hash:1!=s.chatBoxInnerAdParamAppendType,element:"#inner_frame"})),t&&(1==s.chatBoxAdImgLinkFixed?$("#innerADWrap").html(t).removeClass("hide"):$("#list_msg").append(t),2==s.chatBoxInnerAdType&&(setTimeout(l,1e3),setTimeout(l,5e3))),l()}function l(){var e=$("#portrait").height();1==s.chatBoxAdImgLinkFixed&&(e+=3==s.chatBoxInnerAdType?0:$(".innerAD").height()),n.height(e)}},sendMsgNum:0,sendToServer:function(t,e,i){var a=this,n=e||(t.c||t.content);t.visitorImg=a.visitorImg||a.defaultVisitorImg,a.isInRobot?t.ff="r":t.f=t.f||"c",t.hide||(delete t.hasResend,a.showMsg(t));var s=t.id;delete t.id,"0"!=a.queryParams.autoChat&&(t.hide||$(".msg-con",_$(s)).append('<div class="msg-error">&nbsp;</div>'),this.publish("sendVisitorEvent",t.data&&t.data.et?$.extend(t.data,{bridgeMsgId:t.bridgeMsgId,img:e?1:void 0,publishAck:t.publishAck||void 0}):{et:a.isInRobot?130:105,content:n,bridgeMsgId:t.bridgeMsgId,img:e?1:void 0,publishAck:t.publishAck||void 0},function(e){e.successful?(t.talkId=a.talkId,t.hide||($(".msg-error",_$(s)).remove(),$("img",_$(s)).each(function(){$(this).attr("src",$(this).attr("src"))}),a.pushHistory(t)),delete a.errorList[s],i&&i(),t=null):(t.c=n,(a.errorList[s]=t).hide||(t.publishAck=e,$(".msg-error",_$(s)).addClass("resend").attr("dataid",s)))})),n&&a.publish("__visitorSendMsg",n.replace(a.regEmo,"[face]")),n&&a.publish("__visitorStartSendMsg",n.replace(a.regEmo,"[face]")),a.isInRobot&&$("#input_suggest").addClass("hide").html(" "),a.lastMsgTM=t.tm||(new Date).getTime()},checkHistoryTime:function(e){return(!this.lastHistoryTime||6e4<e-this.lastHistoryTime)&&(this.lastHistoryTime=e,!0)},endChatEvent:function(){this.typingTimer&&clearInterval(this.typingTimer);this.unSubscribe(["staffStatus","getMsgTyping","inviteBook","inviteBookOK"])},showTyping:function(){var i=this,a=lanRes.staffInput;function e(){var e;switch(5<i.serviceTypingTime&&(clearInterval(i.serviceTypingTimer),$("#serviceTypingLine").remove()),i.serviceTypingTime%3){case 0:e=a+"&nbsp;.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";break;case 1:e=a+"&nbsp;.&nbsp;.&nbsp;&nbsp;&nbsp;";break;case 2:e=a+"&nbsp;.&nbsp;.&nbsp;.&nbsp;"}i.serviceTypingTime++;var t=_$("serviceTypingLine");t&&$(".msg-item",t).html(e)}this.serviceTypingTimer&&clearInterval(this.serviceTypingTimer),$("#serviceTypingLine").remove(),this.serviceTypingTime=0,e(),this.serviceTypingTimer=setInterval(e,500),this.showMsg({f:"s",m:0,notEnd:!1,id:"serviceTypingLine"},a+"&nbsp;.&nbsp;.&nbsp;.&nbsp;")},regMail:/\b\w{1,30}([\.-]\w{1,30}){0,10}@\w{1,30}([\.-]\w{1,20}){0,10}(\.\w{1,20}){0,10}\b/g,regPhone:/([^\d]|\b)((\d{11})|((\d{7,8})|(\d{4}|\d{3})[\-\s](\d{7,8})|(\d{4}|\d{3})[\-\s](\d{7,8})[\-\s](\d{4}|\d{3}|\d{2}|\d{1})|(\d{7,8})[\-\s](\d{4}|\d{3}|\d{2}|\d{1})))(?=[^\d]|\b)/gi,regLink:/((http|ftp|https):\/\/)(([\w\._\-]+\.[a-zA-Z]{2,6})|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,4})?(\/[\w,\&%_\!\*\(\)\'\;\:\@\=\+\.\/\[-~\-#\?]*)?/gi,filterEmailPhoneLink:function(e){var r=this.isMobile;return"string"!=typeof e||e.match(/(msg\-tel)|(msg\-link)|(msg\-mail)/)?e:(this.regPhone.lastIndex=0,this.regMail.lastIndex=0,this.regLink.lastIndex=0,1<(e=e.replace(this.regLink,function(e){var t=arguments.length,i=arguments[t-2];if(0<i){var a=arguments[t-1].substring(0,i);if(/(\<(a|img|link|iframe|script)[^>]*>([^<]+(?!\<\/a\>))?$)|(\<[a-zA-Z]+[^>]*$)/gi.test(a))return e}return r?'<a class="msg-link" href="'+e+'" target="visitorSiteIframe">'+e+"</a>":'<a class="msg-link" target="_blank" href="'+e+'">'+e+"</a>"})).indexOf("@")&&(e=e.replace(this.regMail,function(e){var t=arguments.length,i=arguments[t-2];if(0<i){var a=arguments[t-1].substring(0,i);if(/(\<(a|img|link|iframe|script)[^>]*>[^<]+(?!\<\/a\>)$)|(\<[a-zA-Z]+[^>]*$)/gi.test(a))return e}return'<a class="msg-mail" target="_blank" href="mailto:'+e+'">'+e+"</a>"})),e=e.replace(this.regPhone,function(e,t){var i=arguments.length,a=arguments[i-2];if(0<a){var n=arguments[i-1].substring(0,a);if(/(\<(a|img|link|iframe|script)[^>]*>[^<]+(?!\<\/a\>)$)|(\<[a-zA-Z]+[^>]*$)/gi.test(n))return e}var s=t,o=e.replace(/^[^\d]|\b/,"");return(s||"")+(r?'<a class="msg-tel" href="tel:'+o+'">'+o+"</a>":'<span class="msg-tel">'+o+"</span>")}))},updateMsg:function(e,t,i){var a=_$(e);a&&($(".msg-item",a).html(t),i&&i.newId&&$(a).attr("id",i.newId))},showLocation:function(e){var t="https://restapi.amap.com/v3/staticmap?location="+(e.locationY||e.y)+","+(e.locationX||e.x)+"&zoom="+(e.scale||15)+"&size=400*200&key=5349312538cf80d1f6c008eb059b732c&markers=mid,,A:"+(e.locationY||e.y)+","+(e.locationX||e.x),i='<div class="msg-map"><a target="'+(view.SDK?"cover":"_blank")+'" href="http://uri.amap.com/marker?position='+(e.locationY||e.y)+","+(e.locationX||e.x)+"&name="+encodeURIComponent(e.label)+'&coordinate=gaode"><div class="msg-map-title"><div>'+e.label+'</div><div class="msg-map-addr">'+(e.address||"")+'</div></div><img onerror="view.imgError&&view.imgError(this)" onload="view.scrollToBottom()" class="view_img" src="'+t+'" draggable="false"/></a></div>',a={data:e,et:127};a.c=i,a.m=7,a.f="c",a.id=e.id,a.talkId=e.talkId,e.fromHistory||902==e.mt?this.showMsg(a):this.sendToServer(a)},showMsg:function(t,e){if(t){var i=this,a=t.talkId||i.talkId,n=t.id||"msg"+(t.tm||(new Date).getTime());!t.id&&"s"==t.f&&_$(n)&&$("#"+n).remove();var s,o=t.t?'<li class="clearfix" ><div class="color1 tc">'+t.t+"</div></li> ":"";if(0==t.m?(t.c&&(t.c=i.filterEmailPhoneLink(t.c)),s=t.c?(i.filterEmo(t.c)+"").replace(/((\r\n)|\n)/g,"</br>"):e):(s=t.c||e,t.m),t.c=s){var r=t.visitorImg||i.visitorImg||i.defaultVisitorImg;i.needHttps&&(i.staffImg&&(i.staffImg=i.staffImg.replace(/^http:/,i.needHttps)),r=i.visitorImg||r.replace(/^http:/,i.needHttps)),view.staticPx2rem&&(s=view.staticPx2rem(s));var l={toChat:"robot-staff ",endChat:"end-chat ",toLeaveWord:"to-leave-word "};s=s.replace(/\[\[#(toChat|endChat|toLeaveWord):([^\]]+)\]\]/g,function(e,t,i){return'<span class="link-in-msg '+(l[t]||"")+'">'+i+"</span>"}),1==t.withdraw?o+='<div style="padding: 10px 0 20px;text-align: center;"><span style="display: inline-block;padding: 8px 10px;background-color: #bfbfbf;border-radius: 5px;color: #FFF;">'+s+"</span></div>":"s"==t.f||"r"==t.f?o+='<li class="clearfix '+("r"==t.f?"msg-robot":"")+" mode"+t.m+(t.media?" msg-medias":"")+'" id="'+n+'" >'+(i.showAvatar?'<div class="avatar-icon fl staff-icons"><img onerror="view.imgError&&view.imgError(this)" class="avatar-icon-img" src="'+(t.staffImg||i.staffImg||i.defaultStaffImg)+'"/></div>':"")+'<div class="msg msg-lf fl"><div class="msg-staff-name">'+(t.staffName||i.staffName||lanRes.serviceStaff)+'</div><div class="msg-con radius4 fl '+("r"==t.f?"bg10":"bg1")+(0!=t.m&&6!=t.m&&3!=t.m?" bgwhite":"")+'">'+(t.media?"":'<i class="msg-angle '+("r"==t.f?view.SDK?"color10":"border-color-angle10":view.SDK?"color11":"border-color-angle1")+'"></i>'+(view.SDK?"":0!=t.m&&6!=t.m&&3!=t.m?'<i class="msg-angle2 bc-angle1-white"></i>':""))+'<div class="msg-item">'+s+"</div></div></div></li>":"c"==t.f?o+='<li class="clearfix mode'+t.m+(t.media?" msg-medias":"")+'" id="'+n+'" >'+(i.showAvatar?'<div class="avatar-icon fr"><img onerror="view.imgError&&view.imgError(this)" class="avatar-icon-img" src="'+r+'"/></div>':"")+'<div class="msg msg-rt fr"><div class="msg-con radius4 fr '+("r"==t.ff?"bg30":"bg3")+(0!=t.m&&5!=t.m&&3!=t.m?" bgwhite":"")+'">'+(t.media?"":'<i class="msg-angle '+("r"==t.ff?view.SDK?"color30":"border-color-angle20":view.SDK?"color3":"border-color-angle2")+'"></i>'+(view.SDK?"":0!=t.m&&5!=t.m&&3!=t.m?'<i class="msg-angle2 bc-angle2-white"></i>':""))+(t.hasResend?'<div class="msg-error resend" dataid="'+t.id+'">&nbsp;</div>':"")+'<div class="msg-item">'+s.replace(/\n/g,"<br/>")+"</div></div></div></li>":o+=s;var d=U.createElement("ul");d.innerHTML=o;for(var c,u=i.getListMsgEl(a,t.tm),f=d.childNodes,m=0;c=f[m++];)if(1==c.nodeType){c=c.cloneNode(!0);var h=((t.id||"msg0")+"").replace("msg",""),p=U.getElementById(h);p&&p.innerHTML?p.innerHTML=c.innerHTML:u.appendChild(c)}if(d=f=null,t.notAppend)return o;"c"==t.f&&this.serviceTypingTimer?$("#list_msg").append(_$("serviceTypingLine")):"serviceTypingLine"!=t.id&&"s"==t.f&&this.serviceTypingTimer&&(clearInterval(this.serviceTypingTimer),$("#serviceTypingLine").remove()),t.notEnd||(0!=t.m&&1!=t.m&&5!=t.m&&view.scrollToBottom(null,{transitionDuration:100,timeout:"x"==t.f?1e3:1!=view.windowType?510:100}),view.noScrollBottom||setTimeout(function(e){view.scrollToBottom(void 0,{notVisitor:"c"!=t.f})},5))}}},changeStorgeBackMsg:function(e){var t,i=window.localStorage.getItem(this.historyKey)?JSON.parse(window.localStorage.getItem(this.historyKey)):"",a=i?i.order[i.order.length-1]:"",n=i?i[a]:"";if(!n)return!1;for(var s in delete i[a],n)if(n[s].mid==e){n[s].withdraw=1,n[s].c=lanRes.backMsgTip,n[s].m=0,n[s].mt="640",t=s;break}return i[a]=n,this.updateHistory(i),!!t&&parseInt(t)},updateHistory:function(e){var t=JSON.stringify(e);return window.localStorage.setItem(this.historyKey,t),this.isIOS&&2==view.windowType&&this.postMessage({type:"updateLocalHistory",key:this.historyKey,value:t}),t},initHistory:function(e){if(this.hasStorage){var t=window.localStorage.getItem(this.historyKey);return(t=(t=t&&JSON.parse(t))||{order:[]})[e]||(t.order||(t.order=[]),t.order.push(e),t[e]={order:[]}),t[e].order||(t[e].order=[]),t}},pushHistory:function(e){if(this.hasStorage&&!view.SDKNative&&e.c){var t=e.talkId||this.talkId;if(t){e.talkId=t;var i=this.initHistory(t);if(i&&"c"==e.f){var a=i[t].order;if(0<a.length){var n=a[a.length-1];if(i[t][n].c==e.c&&-1<n.indexOf("c")){var s=i[t][n].tm-e.tm;if(s<200&&-200<s)return}}}"s"!=e.f||e.staffImg||(e.staffImg=this.staffImg,e.staffName=this.staffName),1!==e.m&&2!==e.m||i[t][e.tmf]?i[t][e.tm+e.f]||(i[t][e.tm+e.f]=e,i[t].order.push(e.tm+e.f)):(i[t][e.tmf]=e,i[t].order.push(e.tmf)),this.updateHistory(i)}}},saveHistoryStaff:function(e,t){if(this.hasStorage&&this.talkId){var i=this.initHistory(this.talkId);e&&!i[this.talkId].staffImg&&(i[this.talkId].staffImg=e||this.defaultStaffImg),e&&!i[this.talkId].staffName&&(i[this.talkId].staffName=t||lanRes.serviceStaff),this.updateHistory(i)}},checkHistory:function(){if(!this.hasStorage)return $("#pre_his").hide(),!1;if(view.SDKNative)return!0;if(this.hasCheckHistory)return this.hasPreHis;this.talkId&&(this.hasCheckHistory=!0);var e=window.localStorage.getItem(this.historyKey);if(!e||'""'==e)return $("#pre_his").hide(),!1;var t=(e=JSON.parse(e)).order,i=t.length;return i&&(1!=i||!t||!t[0]||t[0]!=this.talkId)||($("#pre_his").hide(),!1)},loadHistory:function(e){if(!this.hasStorage||!this.hasPreHis&&!e)return!1;if(!this.loadingPreHis){var t;if(view.SDKNative)this.publish("__loadPreHistory");else if(this.loadingPreHis=!0,t=(t=window.localStorage.getItem(this.historyKey))&&JSON.parse(t)){if(e&&(!t[e]||!t[e].order||0==t[e].order.length))return;var i=new Date,a=((new Date).getTime(),t.order),n=a.length;if(i.setHours(0,0,0,0),i=i.getTime(),n<2&&!e)return this.hasPreHis=!1,this.loadingPreHis=!1;for(var s=n-1;-1<s&&(!e||a[s]==e);s--)if(a[s]&&a[s]!=this.talkId){0==s&&(this.hasPreHis=!1,$("#pre_his").hide());var o=t[a[s]],r=_$("list_msg_"+a[s]);if(o&&!r){e&&(r=view.chat.getListMsgEl(e,o.order&&o[o.order[0]]&&o[o.order[0]].tm||(new Date).getTime(),!0)),console.log(o),this.showHis(o,a[s]);break}if($(r).hasClass("new-leave"))continue}}}},hidePreHistory:function(){this.loadingPreHis=!1,this.hasPreHis=!1,$("#pre_his").hide()},showPreHistory:function(){this.loadingPreHis=!1,this.hasPreHis=!0,$("#pre_his").show()},showHis:function(e,t){var i,a=this,n=this.staffImg,s=this.staffName,o={};for(var r in view.handleHis&&view.handleHis(e,t),view.preHisLoadingId="list_msg_"+t,e)"order"!=r&&"staffImg"!=r&&"staffName"!=r&&"config"!=r&&((i=$.extend({},e[r])).talkId=t,i.fromHistory=!0,i.notStore=!0,i.notEnd=!0,i.t&&-1==(i.t+"").indexOf(" ")&&(i.t=a.getTimeStr(i.tm)),"649"==i.mt?i.robotConfigInfo&&e.robotStaffName?(this.staffImg=e.robotStaffImg,this.staffName=e.robotStaffName):(this.staffImg=e.staffImg,this.staffName=e.staffName):"604"==i.mt?o=!o.staffId&&i.staffDetailInfoMsgList&&i.staffDetailInfoMsgList.length?{staffId:i.staffDetailInfoMsgList[0].staffId,staffName:i.staffDetailInfoMsgList[0].staffNickName||lanRes.serviceStaff,staffImg:i.staffDetailInfoMsgList[0].staffHead||e.staffImg}:{staffId:i.staffId,staffName:i.staffNickName||lanRes.serviceStaff,staffImg:i.staffDetailInfo&&i.staffDetailInfo.staffHead||e.staffImg}:"10001"==i.mt&&a.staffMap?o=a.updateStaffInfo(void 0,{staffId:i.toStaffId,staffNickName:i.toStaffNickName,staffDetailInfo:i.toStaffDetailInfo}):i.staffId&&a.staffMap[i.staffId]?(i.staffName=a.staffMap[i.staffId].staffName||e.staffName,i.staffImg=a.staffMap[i.staffId].staffImg||e.staffImg):!i.staffImg&&o.staffName&&(i=$.extend(i,o)),"10001"!=i.mt?"10011"!=i.mt?"10010"!=i.mt?1e3<i.mt&&"r"!=i.f||(865!=i.mt&&641!=i.mt?647!=i.mt?866!=i.mt&&642!=i.mt?"12001"!=i.mt?655!=i.mt?127!=i.mt&&902!=i.mt?680!=i.mt?605!=i.mt&&10009!=i.mt?(i.notAppend=!0,3==i.m&&i.c&&(i.c=this.getBookComfirm(i.c)),!i.c&&i.content&&(i.c=i.content),i.c&&this.showMsg(i),delete i.talkId):605==i.mt&&a.publish("getSysMsg",i):a.publish("receiveURL",i):a.publish("sendLocationInfo",i):a.publish("getLeaveMsg",i):a.publish("getMsgRobot",i):a.publish("getMsgFile",i):a.publish("getSysMsg",i):a.publish("getMsgImg",i)):a.publish("getSysMsg",i):a.publish("receiveVisEvt",i):a.publish("getSysMsg",i));this.staffImg=n,this.staffName=s,view.scrollToLastPre(view.preHisLoadingId),setTimeout(function(){view.scrollToLastPre(view.preHisLoadingId),view.preHisLoadingId=null},500),this.loadingPreHis=!1},clearHistoryByTalkId:function(e){var t=window.localStorage.getItem(this.historyKey);if((t=t?JSON.parse(t):"")&&t[e]){delete t[e];for(var i=t.order.length-1;0<=i;i--)t.order[i]==e&&t.order.splice(i,1)}this.updateHistory(t)},getListMsgEl:function(e,t,i){var a=_$("list_msg_"+e);return a||(e!=this.talkId&&e?(this.hasLeaveMsg||$(".list-his-hr").removeClass("hide"),(a=U.createElement("ul")).id="list_msg_"+e,a.className="list-msg list-msg-his",t&&(a.innerHTML='<li class="clearfix list-his-hr color1 hide"><i class="hr-left"></i><span>'+this.getTimeStr(t)+'</span><i class="hr-right"></i></li>'),_$("list_his").insertBefore(a,i?_$("list_msg"):_$("pre_his").nextSibling),a):_$("list_msg"))},handleSessionMsg:function(e){e.talkId||(e.talkId=Math.random());var t=e.talkId,i=_$("list_msg_"+t);if(i)return i;(i=U.createElement("ul")).id="list_msg_"+t,i.className="list-msg list-msg-his";for(var a,n=_$("list_msg").childNodes,s=0;a=n[s++];)1==a.nodeType&&(s--,-1!=a.className.indexOf("innerAD")&&a.childNodes&&"IFRAME"==a.childNodes[0].tagName?$(a).remove():i.appendChild(a));return _$("list_his").insertBefore(i,_$("list_msg")),i},getTimeStr:function(e){e=e&&+e||void 0;var t=new Date,i=new Date(e).format("hh:mm");return e=e||t.getTime(),t.setHours(0,0,0,0),((t=t.getTime())<=e?lanRes.today:t-e<=864e5?lanRes.yesterday:t-e<=1728e5?lanRes.beforeYesterday:new Date(e).format("yyyy-MM-dd"))+" "+i},showSysTip:function(e,t,i,a,n){i=i||"msg"+t,view.staticPx2rem&&e&&(e=view.staticPx2rem(e));var s='<li class="clearfix" id="'+i+'" ><div class="color1 tc">'+new Date(t).format("hh:mm")+'</div></li><li class="clearfix tc" id="'+i+'" ><div class="msg-sys radius4 tc">'+e+"</div></li>",o=U.createElement("ul");o.innerHTML=s;for(var r,l=this.getListMsgEl(n,t),d=o.childNodes,c=0;r=d[c++];)1==r.nodeType&&(r=r.cloneNode(!0),l.appendChild(r));o=d=null,a||view.scrollToBottom(null,{transitionDuration:100,timeout:100})},showInfoTip:function(e,t,i,a,n,s,o){var r;if("string"!=typeof e&&(e=(r=e)&&r.tip),e){view.staticPx2rem&&e&&(e=view.staticPx2rem(e)),e=e.replace(/&nbsp;([^&\s])/g," $1");var l={toChat:"robot-staff ",endChat:"end-chat ",toLeaveWord:"to-leave-word "};e=e.replace(/\[\[#(toChat|endChat|toLeaveWord):([^\]]+)\]\]/g,function(e,t,i){return'<span class="link-in-msg '+(l[t]||"")+'">'+i+"</span>"}),t=t||"msg"+(new Date).getTime(),0;var d='<li class="clearfix '+(this.showAvatar?"msg-info-hasAvatar":"msg-info-noAvatar")+'" id="'+t+'" ><div class="'+(!r&&this.isInRobot||r&&"r"==r.f?"msg-info0":"msg-info")+' radius4"><div class="info-con">'+e+"</div></div></li>";if(a)return d;t&&_$(t)&&$("#"+t).remove();var c=U.createElement("ul");c.innerHTML=d;for(var u,f=this.getListMsgEl(n,s),m=c.childNodes,h=0;u=m[h++];)1==u.nodeType&&(u=u.cloneNode(!0),f.appendChild(u));c=m=null,o||view.scrollToBottom(null,{transitionDuration:100,timeout:100})}},resetStatisfy:function(){if($("#sa_advise").val(""),!m)for(var e=$(".sa-sli").results,t=0;t<e.length;t++)$(e[t]).addClass("sa-star").html("&#xe64d;");var i=$("#satisfyConfig").attr("default");$("#satisfyConfig").attr("class","sa-sel-"+i),$(".sub-tab-sel").removeClass("sub-tab-sel"),$(".sub-tab"+i).addClass("sub-tab-sel"),$("#satisfy_ipt").val(i)},showSatisfy:function(e){if(this.allowEvaluateBaseWords>this.sendMsgNum&&1==e)return!1;if(2==(this.satisfyType=e)||3==e||this.satisfyEnable&&!this.satisfyShowed){view.inputBlur&&view.inputBlur(),this.resetStatisfy();var t=this.hideSatisfy,i=setTimeout(function(){clearTimeout(i),$("#mask").off("click",t).on("click",t).show(),$("#satisfy").show()},0);return view.handleShowSatisfy&&view.handleShowSatisfy(),!0}return!1},hideSatisfy:function(){var e=view.chat;$("#satisfy").removeClass("satisfy-show").hide(),$("#mask").hide().off("click",e.hideSatisfy),!1===e.chatting?(e.publish("_closeWin"),e.publish("__evaluate","0-2")):e.publish("__evaluate","0-1"),$.store("ECHAT_inviteSatisfyHandle",$.store("ECHAT_inviteSatisfyId")),view.SDK&&_$("sa_advise").blur(),view.hideSatisfy&&view.hideSatisfy()},addJS:function(e,t){var i=U.createElement("script");i.setAttribute("type","text/javascript");var a=_$s("head")[0];function n(e){i.onload=i.onerror=i.onreadystatechange=null,a.removeChild(i),i=null,t(e)}"onload"in i?(i.onload=n,i.onerror=function(){n(!0)}):i.onreadystatechange=function(){/loaded|complete/.test(i.readyState)&&n()},i.src=e,a.appendChild(i)},addCSS:function(e){var t=U.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e,t.media="screen",_$s("head")[0].appendChild(t)},loadEmoji:function(){var n=this;if(!n.emo){if(view.loadEmoji)return view.loadEmoji();this.addCSS(n.isMobile&&view.px2px?__uri("/visitor/mobile/css/emoji.css"):n.isMobile?locationBase+"/res/emoji/emoji_x2.css":locationBase+"/res/emoji/emoji.css"),$.ajax({url:locationBase+"/res/emoji/emoji.json",async:!0,type:"get",contentType:"application/json;charset=UTF-8",data:void 0,beforeSend:function(e){},success:function(e){n.emo=JSON.parse(e)},error:function(e,t,i){console.log("ajax emoji error")}}),$.ajax({url:locationBase+"/res/emoji/emoji_"+(window.lanName.match(/^zh/i)?"zh":"en")+".json",async:!0,type:"get",contentType:"application/json;charset=UTF-8",data:void 0,beforeSend:function(e){},success:function(e){n.emoLan=JSON.parse(e);var t={};for(var i in n.emoLan)t[n.emoLan[i]]=i;n.lanEmo=t},error:function(e,t,i){console.log("ajax emoji error")}}),$.ajax({url:locationBase+"/res/emoji/emojiFace.json",async:!0,type:"get",contentType:"application/json;charset=UTF-8",data:void 0,beforeSend:function(e){},success:function(e){var t=JSON.parse(e);view.initEmotion.call(n,t),$("#emotion").on(n.isMobile?"tap":"click",".emoji",function(e){var t=$(this).attr("code"),i=n.getInput().length+t.length+4,a=n.inputMaxLength;a<i||($("#inputLengthTip").html(lanRes.inputLengthTip1+(a-i)+lanRes.inputLengthTip2),n.isMobile||n.focusInput(),n.insertImg(t),n.oldBodyEnterText=n.getInput())})},error:function(e,t,i){console.log("ajax emoji error")}})}},filterEmo:function(e){if(!e||"string"!=typeof e)return e;var n=this.emo;return n&&(e=e.replace(this.regFace,function(e){var t=e.charCodeAt(0),i=e.charCodeAt(1),a=(i-56320+(t-55296<<10)+65536).toString(16);return n[a]?'<img class="img-emo" src="'+locationBase+"/res/emoji/32/"+a+'.png" />':n[t+"_"+i]?'<img class="img-emo" src="'+locationBase+"/res/emoji/32/"+t+"_"+i+'.png" />':e})),e=e.replace(this.regEmo,function(e){var t=e.replace(/^\[#([\d\w_]+)#\]/g,"$1");return n&&n[t]||!n?'<img class="img-emo" src="'+locationBase+"/res/emoji/32/"+t+'.png" />':e})},getFileSize:function(e,t){if(""!=e.value){var i=-1;if(e.files&&e.files[t])i=parseInt(e.files[t].size);else try{e.select();var a=U.selection.createRange().text;i=new ActiveXObject("Scripting.FileSystemObject").GetFile(a).size}catch(e){console.log("如果你用的是ie8以下 请将安全级别调低！")}return i}},hasFormData:function(){var t=!0;try{1==view.windowType&&new FileReader,new FormData}catch(e){t=!1}return t}(),hasInitFile:!1,addSendFile:function(){if(!view.SDKNative){if(this.hasInitFile){if(!this.hasFormData)(e=_$("file_up"))&&(e.src="/visitor/common/upload.html?t="+(new Date).getTime())}else if(this.hasFormData)window.fLoad(U);else{var e;if(e=_$("file_up"))return;$("#uploadForm").remove(),$(".menu-file").append('<iframe src="/visitor/common/upload.html" style="filter:alpha(opacity=0.1);opacity: 0.1;position: absolute;top:0;left:0;z-index: 999999999;" allowtransparency="true" id="file_up" frameborder="0" framespacing="0" marginheight="0" marginwidth="0" width="100%" height="100%" scrolling="no"></iframe>')}}},isImgHasPreview:function(e){var t=$(e);if(t.hasClass("msg-img"))return!0;if(t.hasClass("img-emo")||t.hasClass("custom-event-img"))return!1;if(t.parents(".msg-info").length||t.parents(".msg-info0").length||t.parents(".msg-item").length){if(t.parents("a").attr("href"))return!1;if(!t.hasClass("info-icon-img")&&!t.parents(".portrait-title").length&&!t.parents(".feedback-btns").length)return!0}},setMerchantLogo:function(e){var t=[],i=this,a="",n="",s=e.chatLogoImgEnable,o="",r="";i.staffInfoRefreshMap.merchantLink=null,"1"==s&&(a="1"==e.chatLogoImgType?i.platformLogo:i.companyLogo)&&t.push('<img class="header-logo" src="'+a+'"/>'),"1"==e.companyNameEnable&&(n="1"==e.companyNameType?i.platformName:i.companyName)&&t.push('<span class="header-logo-txt">'+n+"</span>"),"1"==e.subcompanyUrlEnable&&((o=e.subcompanyUrl)&&(r=i.getADURL(!0,e.subcompanyAdPostParamList,o,i.paramChat)),e.subcompanyButtonUrl&&t.push('<a class="merchant-link" href="'+(r||"")+'" target="_blank"><img class="merchant-icon" src="'+e.subcompanyButtonUrl+'"/></a>'),r&&(i.staffInfoRefreshMap.merchantLink={notEnableParam:!1,params:e.subcompanyAdPostParamList,element:".merchant-link",hash:!1,srcUrl:o,attr:"href",url:""})),$("#logobox").html(t.join(""))}},window.imgLoadResizeSelf=function(e){view.px2rem&&(e.style.width=view.px2rem(e.naturalWidth||e.width))};window.imgLoadResize=function(e,a){Math.random();var n=-1==a?"entry":"inviteBook"+a,s=-1==a?"entryWrapImg":"inviteBookImg"+a;function t(){var e=1==view.windowType?600:260,t=this.naturalWidth||this.width,i=_$(n);i&&(e<t&&(t=e),i.style.width=view.px2rem?view.px2rem(t):t+"px",-1==a&&(i.style.marginLeft=view.px2rem?view.px2rem(-t/2):-t/2+"px"),$("#"+s).removeClass("hide").css("width",view.px2rem?view.px2rem(t):t+"px"),view.scrollToBottom())}if(e.naturalWidth)t.call(e);else{var i=new Image;i.onload=t,i.src=e.src}};$(function(e){0;var t=new i;setTimeout(window.initChat,0),"firefox"==t.Browser.browser&&$("body").on("drop",function(e){e.stopPropagation()}),"xcx"==t.queryParams.launchfrom&&t.addJS("https://res.wx.qq.com/open/js/jweixin-1.3.2.js")})}(EChatQuery,document),function(r){var l,d,c,u,f,m={};function h(){u=null,m.last&&(m.el.trigger("longTap"),m={})}function p(){u&&clearTimeout(u),u=null}function g(){l&&clearTimeout(l),d&&clearTimeout(d),c&&clearTimeout(c),u&&clearTimeout(u),l=d=c=u=null,m={}}function v(e){return("touch"==e.pointerType||e.pointerType==e.MSPOINTER_TYPE_TOUCH)&&e.isPrimary}function b(e,t){return e.type=="pointer"+t||e.type.toLowerCase()=="mspointer"+t}r(function(){var t,i,a,n,s=0,o=0;"MSGesture"in window&&((f=new MSGesture).target=document.body),r(document).bind("MSGestureEnd",function(e){var t=1<e.velocityX?"Right":e.velocityX<-1?"Left":1<e.velocityY?"Down":e.velocityY<-1?"Up":null;m.el&&t&&(m.el.trigger("swipe"),m.el.trigger("swipe"+t))}).on("touchstart",function(e){(n=b(e,"down"))&&!v(e)||(a=n?e:e.touches[0],e.touches&&1===e.touches.length&&m.x2&&(m.x2=void 0,m.y2=void 0),t=Date.now(),i=t-(m.last||t),m.el=r("tagName"in a.target?a.target:a.target.parentNode),l&&clearTimeout(l),m.x1=a.pageX,m.y1=a.pageY,0<i&&i<=250&&(m.isDoubleTap=!0),m.last=t,u=setTimeout(h,750),f&&n&&f.addPointer(e.pointerId))}).on("touchmove",function(e){(n=b(e,"move"))&&!v(e)||(a=n?e:e.touches[0],p(),m.x2=a.pageX,m.y2=a.pageY,s+=Math.abs(m.x1-m.x2),o+=Math.abs(m.y1-m.y2))}).on("touchend",function(e){(n=b(e,"up"))&&!v(e)||(p(),m.x2&&30<Math.abs(m.x1-m.x2)||m.y2&&30<Math.abs(m.y1-m.y2)?m.el&&(c=setTimeout(function(){var e,t,i,a;m.el&&(m.el.trigger("swipe"),m.el.trigger("swipe"+(e=m.x1,t=m.x2,i=m.y1,a=m.y2,Math.abs(e-t)>=Math.abs(i-a)?0<e-t?"Left":"Right":0<i-a?"Up":"Down")),m={})},0)):"last"in m&&(s<30&&o<30?d=setTimeout(function(){var e=r.Event("tap");m.el&&(e.cancelTouch=g,m.el&&m.el.trigger(e),m.isDoubleTap?(m.el&&m.el.trigger("doubleTap"),m={}):l=setTimeout(function(){l=null,m.el&&m.el.trigger("singleTap"),m={}},250))},0):m={}),s=o=0)}).on("touchcancel MSPointerCancel pointercancel",g),r(window).on("scroll",g)}),["swipe","swipeLeft","swipeRight","swipeUp","swipeDown","doubleTap","tap","singleTap","longTap"].forEach(function(t){r.fn[t]=function(e){return this.on(t,e)}})}(window.EChatQuery);